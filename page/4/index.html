
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 4 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-20T09:46:57.000Z"><a href="/2014/11/20/elixir-distributed-tasks-and-configuration/">2014-11-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/20/elixir-distributed-tasks-and-configuration/">分布式任务和配置</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>启动节点A, 并定义一个模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@c87c9967219c:~# iex --sname A&#10;iex(foo@c87c9967219c)1&#62; defmodule Hell do&#10;...(foo@c87c9967219c)1&#62;   def world, do: IO.puts &#34;hello world&#34;&#10;...(foo@c87c9967219c)1&#62; end</span><br></pre></td></tr></table></figure>
<p>启动节点C,并在节点C上Spawn一个在节点A上运行的进程, 并放回消息到C节点的终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@c87c9967219c:~# iex --sname C&#10;iex(bar@c87c9967219c)1&#62; Node.spawn_link :&#34;foo@c87c9967219c&#34;, fn -&#62; Hello.world end&#10;hello world&#10;#PID&#60;9010.79.0&#62;</span><br></pre></td></tr></table></figure>
<p>在节点C上定义要执行的代码, 并在A上运行, 然后把运行结果返回给C</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; Node.spawn_link :&#34;A@c87c9967219c&#34;, fn -&#62; Hello.world end</span><br></pre></td></tr></table></figure>
<p>收发消息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(B@c87c9967219c)1&#62; pid = Node.spawn_link :&#34;A@c87c9967219c&#34;, fn -&#62;&#10;...(B@c87c9967219c)1&#62;   receive do&#10;...(B@c87c9967219c)1&#62;     &#123;:ping, client&#125; -&#62;&#10;...(B@c87c9967219c)1&#62;       send client, :pong&#10;...(B@c87c9967219c)1&#62;   end&#10;...(B@c87c9967219c)1&#62; end&#10;#PID&#60;8005.65.0&#62;&#10;iex(B@c87c9967219c)2&#62; send pid, &#123;:ping, self&#125;&#10;&#123;:ping, #PID&#60;0.60.0&#62;&#125;&#10;iex(B@c87c9967219c)3&#62; flush&#10;:pong&#10;:ok</span><br></pre></td></tr></table></figure>
<p>每次我们想要执行分布式计算的时候, 我们可以通过<code>Node.spawn_link/2</code>在其他节点上<code>spawn</code>一个进程, 但是我们应该避免在 supervision 树的外部去spawn子进程.</p>
<p>对于<code>Node.spawn_link2</code>, 有更好的替代</p>
<ul>
<li><p>可以使用<code>:rpc</code>模块执行远程节点上的函数, 比如:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#22312;A@c87c9967219c&#33410;&#28857;&#19978;, &#25191;&#34892;Hello&#27169;&#22359;&#30340;:world&#20989;&#25968;, &#27809;&#26377;&#21442;&#25968;&#10;:rpc.call(:&#34;A@c87c9967219c&#34;, Hello, :world, [])</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过<a href="http://elixir-lang.org/docs/master/elixir/GenServer.html#call/3" target="_blank" rel="external">GenServer API</a>请求运行在其他节点上的服务器, 比如:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GenServer.call(&#123;name, node&#125;, arg)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用任务,任务可以在本地或远程节点上Spawn进程</p>
</li>
</ul>
<h2 id="参考资料">参考资料</h2><ol>
<li>Distributed tasks and configuration<br><a href="http://elixir-lang.org/getting_started/mix_otp/10.html" target="_blank" rel="external">http://elixir-lang.org/getting_started/mix_otp/10.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-19T17:28:22.000Z"><a href="/2014/11/20/elixir-connect-nodes-on-the-same-lan/">2014-11-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/20/elixir-connect-nodes-on-the-same-lan/">连接同一个局域网的Elixir节点</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#本机两个终端连接两个节点"><span class="toc-number">1.</span> <span class="toc-text">本机两个终端连接两个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在同一个局域网中连接两个节点"><span class="toc-number">2.</span> <span class="toc-text">在同一个局域网中连接两个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <h2 id="本机两个终端连接两个节点">本机两个终端连接两个节点</h2><p>要点: 使用 <code>--sname</code> 启动选项</p>
<p>终端A:</p>
<pre><code>iex <span class="comment">--sname A</span>
</code></pre><p>终端C:</p>
<pre><code>iex <span class="comment">--sname C</span>
</code></pre><p>在终端A中运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(A@localhost)1&#62; Node.connect :&#39;C@localhost&#39; %% &#36830;&#25509;C&#33410;&#28857;&#10;true&#10;iex(A@localhost)2&#62; node %% &#26174;&#31034;&#24403;&#21069;&#33410;&#28857;&#21517;&#31216;&#10;:&#34;A@localhost&#34;&#10;iex(A@localhost)3&#62; Node.list %% &#21015;&#20986;&#36830;&#25509;&#21040;&#24403;&#21069;&#33410;&#28857;&#30340;&#20854;&#20182;&#33410;&#28857;&#10;[:&#34;C@localhost&#34;]&#10;iex(A@localhost)4&#62; [node | Node.list] %% &#21015;&#20986;&#24403;&#21069;&#33410;&#28857;&#21644;&#36830;&#25509;&#33410;&#28857;&#10;[:&#34;A@localhost&#34;, :&#34;C@localhost&#34;]&#10;iex(A@localhost)5&#62;</span><br></pre></td></tr></table></figure>
<h2 id="在同一个局域网中连接两个节点">在同一个局域网中连接两个节点</h2><p>要点: 使用 <code>--name</code> 启动选项</p>
<p>启动<code>A</code>(192.168.8.100)节点</p>
<pre><code>iex --name A@<span class="number">192.168</span><span class="number">.8</span><span class="number">.100</span>
</code></pre><p>启动<code>C</code>(192.168.8.200)节点</p>
<pre><code>iex --name C@<span class="number">192.168</span><span class="number">.8</span><span class="number">.200</span>
</code></pre><p>从<code>192.168.8.100</code>连接到<code>192.168.8.200</code>, 在<code>192.168.8.100</code>(A)的终端执行:</p>
<pre><code><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">1</span>&gt; Node<span class="class">.connect</span> :<span class="string">'C@192.168.8.200'</span>
</code></pre><p>验证连接的节点</p>
<pre><code>iex(A@<span class="number">192.168</span><span class="number">.8</span><span class="number">.100</span>)<span class="number">2</span>&gt; Node.<span class="built_in">list</span>
</code></pre><p>连接到多个节点原理相同, 如果增加D(192.168.8.201),E(192.168.8.202),F(192.168.8.203)节点到集群中, 在A节点上(192.168.8.100)依次再执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(A@192.168.8.100)1&#62; Node.connect :&#39;D@192.168.8.201&#39;&#10;iex(A@192.168.8.100)2&#62; Node.connect :&#39;E@192.168.8.202&#39;&#10;iex(A@192.168.8.100)3&#62; Node.connect :&#39;F@192.168.8.203&#39;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>Connecting Elixir Nodes on the Same LAN<br><a href="http://benjamintanweihao.github.io/blog/2014/05/25/connecting-elixir-nodes-on-the-same-lan/" target="_blank" rel="external">http://benjamintanweihao.github.io/blog/2014/05/25/connecting-elixir-nodes-on-the-same-lan/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-19T02:49:04.000Z"><a href="/2014/11/19/elixir-bit-syntax-and-id3/">2014-11-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/19/elixir-bit-syntax-and-id3/">从ID3中解析Mp3元数据</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>TODO:: 判断MP3文件是否包含<code>TAG</code>标签</p>
<h2 id="MP3和ID3">MP3和ID3</h2><p>ID3是一种在MP3中使用的描述MP3音频文件的元数据结构, 如下图所示:</p>
<p><img src="/assets/images/vlc_metadata.png" alt="ID3元数据"></p>
<h2 id="ID3v1_字段结构">ID3v1 字段结构</h2><p><img src="/assets/images/id3v1_blocks.gif" alt="字段结构"></p>
<p><img src="/assets/images/id3v1.png" alt="ID3v1 布局"></p>
<h2 id="读取Mp3文件">读取Mp3文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Mp3 do&#10;  def get(filename) do&#10;    case File.read(filename) do&#10;        &#123;:ok, binary&#125; -&#62;&#10;            binary&#10;        _ -&#62;&#10;        IO.puts &#34;Can&#39;t not open #&#123;filename&#125;&#34;&#10;    end&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="提取ID3v1_标记">提取ID3v1 标记</h2><p>ID3标记是MP3文件的最后128字节, 因此我们可以计算出ID3 Tag的起始偏移量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mp3_byte_size = (byte_size(binary) - 128)</span><br></pre></td></tr></table></figure>
<p>然后通过Bit Syntax类匹配出我们需要的ID3 Tag部分的Bit字符串.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;&#60; _ :: binary-size(mp3_byte_size), id3_tag :: binary &#62;&#62; = binary</span><br></pre></td></tr></table></figure>
<h2 id="完整代码">完整代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Mp3 do&#10;  def parse(filename) do&#10;    case File.read(filename) do&#10;      &#123;:ok, binary&#125; -&#62;&#10;        IO.puts byte_size(binary)&#10;        # &#33719;&#21462;Mp3&#38899;&#39057;&#25968;&#25454;&#30340;&#22823;&#23567;,&#29992;&#20110;&#35745;&#31639;ID3&#30340;&#36215;&#22987;&#20559;&#31227;&#37327;&#10;        mp3_byte_size = (byte_size(binary) - 128) * 8&#10;        # &#25226;&#25105;&#20204;&#38656;&#35201;&#30340;&#37096;&#20998;&#35299;&#26512;&#20986;&#26469;&#10;        &#60;&#60; _ :: size(mp3_byte_size), id3_tag :: binary &#62;&#62; = binary&#10;        case id3_tag do&#10;          &#60;&#60;&#34;TAG&#34;,tags::binary&#62;&#62; -&#62;&#10;            # &#20174;id3_tag&#20013;&#21305;&#37197;&#20986;&#26631;&#39064;,&#33402;&#26415;&#23478;&#21517;&#31216;,&#19987;&#36753;&#21517;&#31216;,&#21457;&#34892;&#24180;&#20221;, &#35780;&#35770;, &#31561;&#10;            &#60;&#60; tag     :: binary-size(3),&#10;               title   :: binary-size(30),&#10;               artist  :: binary-size(30),&#10;               album   :: binary-size(30),&#10;               year    :: binary-size(4),&#10;               comment :: binary-size(30),&#10;               genre   :: binary-size(1)&#10;            &#62;&#62;  = id3_tag&#10;            # &#36755;&#20986;&#10;            IO.puts tags&#10;            IO.puts &#34;TAG: #&#123;tag&#125;&#34;&#10;            IO.puts &#34;&#26631;&#39064;&#21517;: #&#123;title&#125;&#34;&#10;            IO.puts &#34;&#33402;&#26415;&#23478;: #&#123;artist&#125;&#34;&#10;            IO.puts &#34;&#19987;&#36753;&#21517;: #&#123;album&#125;&#34;&#10;            IO.puts &#34;&#24180;&#20221;: #&#123;year&#125;&#34;&#10;            IO.puts &#34;&#35780;&#35770;: #&#123;comment&#125;&#34;&#10;            IO.puts &#34;&#27969;&#27966;: #&#123;genre&#125;&#34;&#10;          _ -&#62;&#10;            :NO_TAG_INFORMATION&#10;        end&#10;      _ -&#62;&#10;        IO.puts &#34;Can&#39;t not open #&#123;filename&#125;&#34;&#10;    end&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>本文原文<br><a href="http://benjamintanweihao.github.io/blog/2014/06/10/elixir-bit-syntax-and-id3/" target="_blank" rel="external">http://benjamintanweihao.github.io/blog/2014/06/10/elixir-bit-syntax-and-id3/</a></li>
<li>ID3v1 结构说明<br><a href="http://id3.org/ID3v1" target="_blank" rel="external">http://id3.org/ID3v1</a></li>
<li>Erlang 比特语法和ID3<br><a href="http://www.citizen428.net/blog/2010/09/04/erlang-bit-syntax-and-id3" target="_blank" rel="external">http://www.citizen428.net/blog/2010/09/04/erlang-bit-syntax-and-id3</a></li>
<li>Erlang 比特语法<br><a href="http://www.erlang.org/doc/programming_examples/bit_syntax.html" target="_blank" rel="external">http://www.erlang.org/doc/programming_examples/bit_syntax.html</a></li>
<li>Erlang Programming - Francesco Cesarini and Simon Thompson 电子版PDF, 206页</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-14T10:15:11.000Z"><a href="/2014/11/14/erlang-design-your-own-behaviour/">2014-11-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/14/erlang-design-your-own-behaviour/">自定义行为</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(some_behaviour)</span></span>.</span><br><span class="line"><span class="pp">-callback init<span class="params">(<span class="variable">Args</span> :: <span class="function_name">list</span>(<span class="function_name">term</span>()))</span> -&gt; 'ok'|tuple<span class="params">('error', <span class="variable">Reason</span> :: <span class="function_name">string</span>())</span></span>.</span><br><span class="line"><span class="pp">-callback handle<span class="params">(<span class="variable">Event</span> :: <span class="function_name">atom</span>())</span> -&gt; NextEvent :: atom<span class="params">()</span></span>.</span><br><span class="line"><span class="pp">-callback sync<span class="params">(<span class="variable">Node</span> :: <span class="function_name">node</span>(), <span class="variable">Timeout</span> :: <span class="function_name">non_neg_integer</span>())</span> -&gt; 'ok'|tuple<span class="params">('error', <span class="variable">Reason</span> :: <span class="function_name">string</span>())</span></span>.</span><br></pre></td></tr></table></figure>
<p>该行为要求在回调模块中定义 <code>init/1</code>, <code>handle/1</code> 和 <code>sync/2</code>三个函数, 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-module(usage).&#10;-behaviour(some_behaviour).&#10;-export([init/1, handle/1, sync/2, foo/0]).&#10;init(Config) -&#62;&#10;    Config.&#10;sync(_Entry, Config) -&#62;&#10;    Config.&#10;handle(Message) -&#62;&#10;    Message.&#10;foo() -&#62;&#10;    foo_atom_returned.</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-13T08:55:44.000Z"><a href="/2014/11/13/erlang-resource-pool/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/erlang-resource-pool/">资源池</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计"><span class="toc-number">2.</span> <span class="toc-text">设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#操作"><span class="toc-number">3.</span> <span class="toc-text">操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#borrow"><span class="toc-number">3.1.</span> <span class="toc-text">borrow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return"><span class="toc-number">3.2.</span> <span class="toc-text">return</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add"><span class="toc-number">3.3.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invalidate"><span class="toc-number">3.4.</span> <span class="toc-text">invalidate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#典型用例"><span class="toc-number">3.5.</span> <span class="toc-text">典型用例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大小限制"><span class="toc-number">4.</span> <span class="toc-text">大小限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#max_active"><span class="toc-number">4.1.</span> <span class="toc-text">max_active</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max_idle"><span class="toc-number">4.2.</span> <span class="toc-text">max_idle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#min_idle"><span class="toc-number">4.3.</span> <span class="toc-text">min_idle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行为选项"><span class="toc-number">5.</span> <span class="toc-text">行为选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#资源池耗尽时的borrow行为"><span class="toc-number">5.1.</span> <span class="toc-text">资源池耗尽时的borrow行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源检查"><span class="toc-number">5.2.</span> <span class="toc-text">资源检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源在Idle列表中的顺序"><span class="toc-number">5.3.</span> <span class="toc-text">资源在Idle列表中的顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计时"><span class="toc-number">5.4.</span> <span class="toc-text">计时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源池实例的维护"><span class="toc-number">6.</span> <span class="toc-text">资源池实例的维护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#new"><span class="toc-number">6.1.</span> <span class="toc-text">new</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clear"><span class="toc-number">6.2.</span> <span class="toc-text">clear</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#close"><span class="toc-number">6.3.</span> <span class="toc-text">close</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源池统计"><span class="toc-number">6.4.</span> <span class="toc-text">资源池统计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源工厂"><span class="toc-number">7.</span> <span class="toc-text">资源工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">8.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL_Driver连接池"><span class="toc-number">8.1.</span> <span class="toc-text">MySQL Driver连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rabbit_MQ_连接通道池"><span class="toc-number">8.2.</span> <span class="toc-text">Rabbit MQ 连接通道池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>资源池是解决并发问题的一种常见模式</p>
<p>Versions:</p>
<ul>
<li><code>2014-11-13</code> <code>Version 0.1</code></li>
</ul>
<h2 id="简介">简介</h2><p>软件资源的创建需要消耗大量的时间和内存, 如果能重用, 将极大地改善应用程序的性能. 资源池是一个在不同的平台和语言中广泛的使用的方法.本文所述<a href="http://sourceforge.net/projects/erlpool/" target="_blank" rel="external">Erlang资源池</a>的设计灵感来源于Apache的Common Pool库. API和主要的功能是从其借用的, 但内部实现完全不同, 并使用了Erlang OTP设计原则, 以及Erlang并发模型.</p>
<h2 id="设计">设计</h2><p>资源池由两个列表组成: <code>Active</code>(活动列表)和<code>Idle</code>(空闲列表). <code>Active</code>列表包含活跃的资源. <code>Idle</code>列表包含不活跃的资源</p>
<pre><code>图-1: 资源池为空的状态,活动列表和空闲列表都为空

+-Pool-----------{0,0}-+
|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|
+----------------------+
</code></pre><h2 id="操作">操作</h2><h3 id="borrow">borrow</h3><p>要从资源池中获得一个资源,需要调用函数<code>borrow</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">Resource</span> = resource_pool:borrow(test_pool)</span><br></pre></td></tr></table></figure>
<p>如果资源池的<code>Idle</code>列表为空(在没有资源可用的情况下),资源池会直接在<code>Active</code>列表中创建一个资源并授予调用进程.</p>
<pre><code>图-2: 创建一个新的资源,并把该资源放到 Active 资源列表

+-Pool-----------{1,0}-+          +-Pool-----------{2,0}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><p>如果在资源池的<code>Idle</code>列表中存在可用的资源. 将从<code>Idle</code>列表中取出一个资源,并转移到<code>Active</code>列表,然后授予调用者进程.</p>
<pre><code>图-3: 从空闲资源列表中得到一个资源,并把它转移到活动列表

+-Pool-----------{1,2}-+          +-Pool-----------{2,1}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><h3 id="return">return</h3><p>一旦进程完成了对资源的使用,它必须把资源返回到资源池中</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:return(test_pool,<span class="variable">Resource</span>)</span><br></pre></td></tr></table></figure>
<p>换句话说,就是该资源从<code>Active</code>列表移动到<code>Idle</code>列表(图-4). 以让其他进程能够从资源池中获取可用的资源.</p>
<pre><code>图-4 进程把资源返还给资源池

+-Pool-----------{2,1}-+          +-Pool-----------{1,2}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><h3 id="add">add</h3><p>有时候我们需要添加新的资源</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:add(test_pool)</span><br></pre></td></tr></table></figure>
<p>函数<code>add</code>创建一个新的资源,并添加到<code>Idle</code>列表中</p>
<pre><code>+-Pool-----------{2,1}-+          +-Pool-----------{2,2}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.4&gt; </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><h3 id="invalidate">invalidate</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:invalidate(test_pool,<span class="variable">Resource</span>)</span><br></pre></td></tr></table></figure>
<p><code>invalidate</code> 函数把一个失败的资源标记为不可用,资源池然后会销毁这个资源.</p>
<pre><code>+-Pool-----------{2,1}-+          +-Pool-----------{1,1}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><h3 id="典型用例">典型用例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> resource_pool:borrow(test_pool) <span class="keyword">of</span></span><br><span class="line">  <span class="tuple">&#123;error, <span class="variable">E</span>&#125;</span> -&gt; io:format(<span class="string">"Error while borrow from pool, reason: ~p"</span>, [<span class="variable">E</span>]);</span><br><span class="line">  <span class="variable">Resource</span> -&gt;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">      resource:operation(<span class="variable">Resource</span>),</span><br><span class="line">      resource_pool:return(test_pool, <span class="variable">Resource</span>)</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">      <span class="variable">_</span>:<span class="variable">_</span> -&gt; resource_pool:invalidate(test_pool, <span class="variable">Resource</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="大小限制">大小限制</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,resource_factory,resource_metadata,options</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_active,&#10;max_idle,&#10;min_idle</span><br></pre></td></tr></table></figure>
<pre><code>            +-Pool-----------{0,0}-+
            |<span class="string">                      </span>|
            |<span class="string"> Active--+  Idle----+ </span>|
            |<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">_______</span>|<span class="string">_</span>|<span class="string">__ max_idle
max_active__</span>|<span class="string">_</span>|<span class="string">_______</span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
            |<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
            |<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">_______</span>|<span class="string">_</span>|<span class="string">__ min_idle
            </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
            |<span class="string"> +-------+  +-------+ </span>|
            +----------------------+
</code></pre><h3 id="max_active">max_active</h3><p><code>Active</code>列表默认最大值为8. 如果达到限制<code>borrow</code>操作将会阻塞或失败.  值 -1 (或任何负值) 表示<code>Active</code>列表没有大小限制.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> =</span><br><span class="line">    resource_pool:new(test_pool,resource_factory,[],[<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>])</span><br></pre></td></tr></table></figure>
<h3 id="max_idle">max_idle</h3><p><code>Idle</code>列表的最大大小,默认和<code>max_active</code>相同. 如果达到限制,后续<code>return</code>的资源会被销毁,值 -1 (或任何负值) 表示<code>Idle</code>列表没有大小限制.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                          <span class="comment">%% 资源池实例标识</span></span><br><span class="line">    resource_factory,                   <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                 <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;max_idle,<span class="number">10</span>&#125;</span>]     <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="min_idle">min_idle</h3><p><code>Idle</code>列表默认的最小大小为0.</p>
<p>If it reaches the limit then following borrow operation will successfully supplies a resource to invoker and then pool will additionally create new resource in Idle container to provide min_idle condition.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                                      <span class="comment">%% 资源池标识</span></span><br><span class="line">    resource_factory,                               <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                             <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;max_idle,<span class="number">10</span>&#125;</span>,<span class="tuple">&#123;min_idle,<span class="number">3</span>&#125;</span>]    <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>关于空闲资源的最大和最小值应该根据实际需求控制在一个合理的区间. 太小会导致频繁的创建资源,太大又会消耗过多的内存.</p>
<h2 id="行为选项">行为选项</h2><h3 id="资源池耗尽时的borrow行为">资源池耗尽时的borrow行为</h3><ul>
<li><p><code>{when_exhausted_action,fail}</code><br>在耗尽的资源池上调用<code>borrow</code>将返回<code>{error,pool_exhausted}</code></p>
</li>
<li><p><code>{when_exhausted_action,block}</code><br>在耗尽的资源池上调用<code>borrow</code>将阻塞,知道有空闲的资源可用,等待的最大时间可以通过选项<code>max_wait</code>控制</p>
</li>
<li><p><code>{when_exhausted_action,grow}</code><br>在耗尽的资源池上调用<code>borrow</code>将创建新资源,并增大<code>Active</code>列表的大小,此时<code>max_Idle</code>选项被忽略.</p>
</li>
</ul>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                                     <span class="comment">%% 资源池实例标识</span></span><br><span class="line">    resource_factory,                              <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                            <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;when_exhausted_action,fail&#125;</span>] <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="资源检查">资源检查</h3><p>Resource pool can check status of managed resources. Options <code>test_on_borrow</code> and <code>test_on_return</code> control how pool tests resources: before providing resource to invoker <code>{test_on_borrow, true}</code> and after a resource was returned to pool <code>{test_on_return, true}</code>. If pool finds that the resource is not alive during test then the resource will be destroyed.</p>
<h3 id="资源在Idle列表中的顺序">资源在Idle列表中的顺序</h3><p>Option <code>fifo</code> (first-input-first-output) controls order of extracting a resources from <code>Idle</code> list. Diagrams below illustrate this. Suppose we fill out <code>Idle</code> list in order: <r.1> was first, <r.2> is next, then <r.3>. Resource <r.4> is active in given moment. If <code>{fifo, true}</code> is set the <code>borrow</code> operation leads to situation below: resource <r.1> was came first and it becames active now (first input).</r.1></r.4></r.3></r.2></r.1></p>
<pre><code>+-Pool-----------{1,2}-+          +-Pool-----------{2,1}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.4&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.4&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><p>If <code>{fifo, false}</code> is set it means that order will be last-input-first-output. <code>borrow</code> operation makes active resource <r.3> (last input).</r.3></p>
<pre><code>+-Pool-----------{1,2}-+          +-Pool-----------{2,1}-+
|<span class="string">                      </span>|<span class="string">          </span>|<span class="string">                      </span>|
|<span class="string"> Active--+  Idle----+ </span>|<span class="string">          </span>|<span class="string"> Active--+  Idle----+ </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string">       </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string">       </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|<span class="string">    =&gt;    </span>|<span class="string"> </span>|<span class="string"> &lt;R.3&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.2&gt; </span>|<span class="string"> </span>|
|<span class="string"> </span>|<span class="string"> &lt;R.4&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string"> </span>|<span class="string">          </span>|<span class="string"> </span>|<span class="string"> &lt;R.4&gt; </span>|<span class="string">  </span>|<span class="string"> &lt;R.1&gt; </span>|<span class="string"> </span>|
|<span class="string"> +-------+  +-------+ </span>|<span class="string">          </span>|<span class="string"> +-------+  +-------+ </span>|
+----------------------+          +----------------------+
</code></pre><p>Default value for <code>fifo</code> is <code>false</code>.</p>
<h3 id="计时">计时</h3><p><code>max_wait</code>选项定义了一个时间, 当在资源池耗尽时调用<code>borrow</code>函数,并且 <code>when_exhausted_action</code> 设置为<code>block</code>时所等待的最大时间.</p>
<p><code>max_idle_time</code> ,用来配置资源的最大空闲时间. 如果一个资源空闲的超过这个时间, 就会被销毁. 但至少要在资源池中保留<code>min_idle</code>个资源. 如果<code>max_idle_time</code>设置为<code>infinity</code>, 不会销毁任何空闲的资源.</p>
<h2 id="资源池实例的维护">资源池实例的维护</h2><p><code>pool_name</code>是一个原子, 多个进程可以使用该名字来访问资源池. <code>resource_factory</code>是一个负责创建和维护资源的模块名称. <code>resource_metadata</code>是一个包含资源初始化信息的对象. 该对象作为参数传递给<code>resource_factory</code>的每个函数来帮助维护一个资源.</p>
<h3 id="new">new</h3><p>创建资源池</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok, <span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    pool_name,          <span class="comment">%% 资源池名称</span></span><br><span class="line">    resource_factory,   <span class="comment">%% 资源工厂</span></span><br><span class="line">    resource_metadata   <span class="comment">%% 资源元数据</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="clear">clear</h3><p>清空资源池</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:clear(pool_name)</span><br></pre></td></tr></table></figure>
<h3 id="close">close</h3><p>关闭资源池, 该函数终止资源池进程, 并销毁池中的所有资源</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok = resource_pool:close(pool_name)</span><br></pre></td></tr></table></figure>
<h3 id="资源池统计">资源池统计</h3><p>get_num_active,get_num_idle,get_number</p>
<h2 id="资源工厂">资源工厂</h2><h2 id="示例">示例</h2><h3 id="MySQL_Driver连接池">MySQL Driver连接池</h3><p><a href="http://sourceforge.net/projects/erlmysql/" target="_blank" rel="external">http://sourceforge.net/projects/erlmysql/</a></p>
<h3 id="Rabbit_MQ_连接通道池">Rabbit MQ 连接通道池</h3><p><a href="http://sourceforge.net/projects/erlpool/files/1.0.x/erl.resource.pool.example.zip/download" target="_blank" rel="external">http://sourceforge.net/projects/erlpool/files/1.0.x/erl.resource.pool.example.zip/download</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://erlangcentral.org/wiki/index.php?title=Resource_Pool" target="_blank" rel="external">https://erlangcentral.org/wiki/index.php?title=Resource_Pool</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:43:21.000Z"><a href="/2014/11/13/elixir-deploy-phoenix-application-to-a-ubuntu-server/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-deploy-phoenix-application-to-a-ubuntu-server/">部署Phoenix应用程序到Ubuntu服务器</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="安装部署工具">安装部署工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y capistrano</span><br></pre></td></tr></table></figure>
<h2 id="部署">部署</h2><h2 id="步骤1:_安装_capistrano_和_capify">步骤1: 安装 capistrano 和 capify</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install capistrano --version=2.15.5&#10;capify .&#10;mkdir config/deploy</span><br></pre></td></tr></table></figure>
<h2 id="步骤2:_添加_exrm_依赖">步骤2: 添加 exrm 依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defp deps do&#10;  [&#10;    ...&#10;    &#123;:exrm, &#34;~&#62; 0.14.11&#34;&#125;&#10;  ]&#10;end</span><br></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix deps.get</span><br></pre></td></tr></table></figure>
<h2 id="步骤3:_改变应用程序的启动方式">步骤3: 改变应用程序的启动方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore do&#10;  use Application&#10;  # See http://elixir-lang.org/docs/stable/elixir/Application.html&#10;  # for more information on OTP Applications&#10;  def start(_type, _args) do&#10;    import Supervisor.Spec, warn: false&#10;    children = [&#10;      # Define workers and child supervisors to be supervised&#10;      # worker(BookStore.Worker, [arg1, arg2, arg3])&#10;      worker(BookStore.Repo, [])&#10;    ]&#10;    BookStore.Router.start&#10;    # See http://elixir-lang.org/docs/stable/elixir/Supervisor.html&#10;    # for other strategies and supported options&#10;    opts = [strategy: :one_for_one, name: BookStore.Supervisor]&#10;    Supervisor.start_link(children, opts)&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>第12行, 添加了<code>BookStore.Router.start</code></p>
<p>在开发模式中,应用程序不再能够以正常的方式启动. <code>mix phoenix.start</code>会立即崩溃, 并显示如下错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Running MyAwesomeApp.Router with Cowboy on port 4000&#10;** (CaseClauseError) no case clause matching: &#123;:error, &#123;:already_started, #PID&#60;0.149.0&#62;&#125;&#125;&#10;    (phoenix) lib/phoenix/router.ex:78: Phoenix.Router.start_adapter/2&#10;    (phoenix) lib/mix/tasks/phoenix/start.ex:12: Mix.Tasks.Phoenix.Start.run/1&#10;    (mix) lib/mix/cli.ex:55: Mix.CLI.run_task/2&#10;    (elixir) src/elixir_lexical.erl:17: :elixir_lexical.run/3&#10;    (elixir) lib/code.ex:316: Code.require_file/2</span><br></pre></td></tr></table></figure>
<p>在开发模式中, 你需要使用下面的方式启动服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex -S mix phoenix.start</span><br></pre></td></tr></table></figure>
<h2 id="步骤4:_把代码Push到Git仓库">步骤4: 把代码Push到Git仓库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init&#10;git remote add origin git@github.com:developerworks/book_store.git</span><br></pre></td></tr></table></figure>
<p>提交代码到远程仓库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add . &#38;&#38; git commit -am &#34;initial commit&#34;&#10;git push origin master</span><br></pre></td></tr></table></figure>
<h2 id="步骤5:_在Ubuntu服务器上安装Erlang和Elixir">步骤5: 在Ubuntu服务器上安装Erlang和Elixir</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb&#10;$ sudo dpkg -i erlang-solutions_1.0_all.deb&#10;$ sudo apt-get update&#10;$ sudo apt-get install erlang</span><br></pre></td></tr></table></figure>
<p>由于Phoenix依赖Elixir 1.0.1, 需要手动安装合适的Elixir版本.</p>
<p>下载,解压,编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root&#10;wget https://github.com/elixir-lang/elixir/archive/v1.0.2.zip&#10;unzip v1.0.2.zip&#10;cd elixir-1.0.2&#10;make</span><br></pre></td></tr></table></figure>
<p>把程序路径添加到PATH中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;export PATH=/root/elixir-1.0.2/bin:$PATH&#39; &#62;&#62; ~/.profile&#10;source ~/.profile</span><br></pre></td></tr></table></figure>
<p>检查版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># elixir --version&#10;Elixir 1.0.2</span><br></pre></td></tr></table></figure>
<h2 id="步骤6:_调整Locale">步骤6: 调整Locale</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LANGUAGE=en_US.UTF-8&#10;export LANG=en_US.UTF-8&#10;export LC_ALL=en_US.UTF-8&#10;locale-gen en_US.UTF-8&#10;sudo apt-get install locales&#10;sudo dpkg-reconfigure locales</span><br></pre></td></tr></table></figure>
<p>在<code>~/.profile</code>中添加下面的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LANGUAGE=en_US.UTF-8&#10;export LANG=en_US.UTF-8&#10;export LC_ALL=en_US.UTF-8</span><br></pre></td></tr></table></figure>
<p>在<code>/etc/environment</code>添加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LC_ALL=en_US.UTF-8&#10;LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>
<h2 id="步骤6:_编辑config/deploy-rb">步骤6: 编辑config/deploy.rb</h2><p>粘贴下面的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &#39;capistrano/ext/multistage&#39;&#10;set :stages, [&#34;staging&#34;, &#34;production&#34;]&#10;set :default_stage, &#34;production&#34;&#10;set :keep_releases, 5&#10;set :application, &#34;My Awesome App&#34;&#10;set :repository,  &#34;git@github.com:learnelixir/my-awesome-app.git&#34;&#10;set :scm, :git&#10;set :branch, :master&#10;set :use_sudo, false&#10;set :normalize_asset_timestamps, false&#10;set :deploy_via, :remote_cache&#10;after &#34;deploy:update&#34;, &#34;deploy:cleanup&#34;&#10;after &#34;deploy:update&#34;, &#34;deploy:build&#34;, &#34;deploy:cleanup&#34;&#10;namespace :assets do&#10;  task :precompile, roles: :web do&#10;    # do nothing&#10;  end&#10;end&#10;def is_application_running?(current_path)&#10;  pid = capture(%Q&#123;ps ax -o pid= -o command=|&#10;      grep &#34;/home/app/www/book_store/current/rel/book_store/.*/[b]eam&#34;|awk &#39;&#123;print $1&#125;&#39;&#125;)&#10;  return pid != &#34;&#34;&#10;end&#10;namespace :deploy do&#10;  task :is_running, roles: :web do&#10;    is_running = is_application_running?(current_path)&#10;    if is_running&#10;      puts &#34;Application is running&#34;&#10;    else&#10;      puts &#34;Application is NOT running&#34;&#10;    end&#10;  end&#10;  task :build, roles: :web do&#10;    run &#34;cd #&#123;current_path&#125; &#38;&#38; mix deps.get &#38;&#38; MIX_ENV=#&#123;mix_env&#125; mix release&#34;&#10;  end&#10;  task :restart, roles: :web do&#10;    if is_application_running?(current_path)&#10;      run &#34;cd #&#123;current_path&#125;/rel/book_store/bin &#38;&#38; ./book_store stop&#34;&#10;    end&#10;    run &#34;cd #&#123;current_path&#125;/rel/book_store/bin &#38;&#38; ./book_store start&#34;&#10;  end&#10;  task :start, roles: :web do&#10;    run &#34;cd #&#123;current_path&#125;/rel/book_store/bin &#38;&#38; ./book_store start&#34;&#10;  end&#10;  task :stop, roles: :web do&#10;    run &#34;cd #&#123;current_path&#125;/rel/book_store/bin &#38;&#38; ./book_store stop&#34;&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="步骤7:_创建production-rb">步骤7: 创建<code>production.rb</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim config/deploy/production.rb</span><br></pre></td></tr></table></figure>
<p>内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &#34;xx.xx.xx.xx&#34;, :app, :web, :db, :primary =&#62; true&#10;set :user, &#39;&#60;user&#62;&#39;&#10;set :branch, :master&#10;set :mix_env, :prod&#10;set :deploy_to, &#34;/home/&#60;user&#62;/www/book_store&#34;&#10;set :default_environment, &#123;&#10;  &#39;PATH&#39; =&#62; &#34;$PATH:/home/app/src/elixir/bin&#34; # --&#62; replace by path to your elixir bin folder&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>xx.xx.xx.xx</code>为服务器IP地址,  <code>&lt;user&gt;</code>为用户目录, 可以用同样的方法创建<code>staging.rb</code>文件用于<code>staging</code>环境.</p>
<h2 id="步骤8:_运行setup和deploy">步骤8: 运行setup和deploy</h2><p>为部署初始化目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cap deploy:setup</span><br></pre></td></tr></table></figure>
<p>执行实际部署, 如果是第一次部署, 需要下载和安装依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cap deploy</span><br></pre></td></tr></table></figure>
<h2 id="步骤9:_把Nginx作为反向代理">步骤9: 把Nginx作为反向代理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Phoenix&#26381;&#21153;&#22120;&#22320;&#22336;&#21644;&#30701;&#35044;&#10;upstream book_store &#123;&#10;  server 127.0.0.1:4000;&#10;&#125;&#10;server &#123;&#10;  listen 0.0.0.0:80;&#10;  server_name localhost;&#10;  try_files $uri/index.html $uri @book_store;&#10;  location @book_store &#123;&#10;    proxy_set_header Host $http_host;&#10;    if (!-f $request_filename) &#123;&#10;      proxy_pass http://book_store;&#10;      break;&#10;    &#125;&#10;  &#125;&#10;  error_page 500 502 503 504 /500.html;&#10;  access_log  /var/log/nginx/book_store.log;&#10;  error_log  /var/log/nginx/book_store.log;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>Phoenix的运行端口可以在配置文件<code>config/prod.exs</code>中修改</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:25:18.000Z"><a href="/2014/11/13/elixir-using-model-in-phoenix-console/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-using-model-in-phoenix-console/">在Phoenix控制台中使用模型</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="启动Phoenix控制台">启动Phoenix控制台</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex -S mix</span><br></pre></td></tr></table></figure>
<h2 id="查询">查询</h2><p>查询Id为1的图书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(16)&#62; BookStore.Repo.get(BookStore.Books, 1)&#10;%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;,&#10; id: 1, publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir&#34;&#125;</span><br></pre></td></tr></table></figure>
<p>查询所有图书, 返回的是一个数组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(17)&#62; BookStore.Repo.all(BookStore.Books)&#10;[%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10;  description: &#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;,&#10;  id: 1, publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir&#34;&#125;]</span><br></pre></td></tr></table></figure>
<p>定义别名:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias BookStore.Repo, as: Repo&#10;alias BookStore.Books, as: Books</span><br></pre></td></tr></table></figure>
<p>如果没有<code>as:</code>部分, alias将使用模型名称的最后一部分作为别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias BookStore.Repo&#10;alias BookStore.Books</span><br></pre></td></tr></table></figure>
<p>使用别名查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; Repo.all(Books)&#10;[%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;,&#10;  id: 1, publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir&#34;&#125;]&#10;iex&#62; Repo.get(Books, 1)&#10;%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;,&#10;  id: 1, publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir&#34;&#125;</span><br></pre></td></tr></table></figure>
<p>赋值给一个变量和访问模型字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(10)&#62; book = Repo.get(Books, 1)&#10;%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;,&#10; id: 1, publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir&#34;&#125;&#10;iex(11)&#62; book.author&#10;&#34;Dave Thomas&#34;&#10;iex(12)&#62; book.description&#10;&#34;Programming Elixir: Functional |&#62; Concurrent |&#62; Pragmatic |&#62; Fun&#34;&#10;iex(13)&#62; book.id&#10;1&#10;iex(14)&#62; book.publisher&#10;&#34;The Pragmatic Bookshelf&#34;&#10;iex(15)&#62; book.title&#10;&#34;Programming Elixir&#34;</span><br></pre></td></tr></table></figure>
<h2 id="更新">更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62;  book = %&#123;book | description: &#34;Programming Elixir: a lot more fun&#34;, \&#10;                      title: &#34;Programming Elixir with fun&#34;&#125;&#10;%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: a lot more fun&#34;, id: 1,&#10;  publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir with fun&#34;&#125;&#10;iex&#62; Repo.update(book)&#10;:ok&#10;iex&#62; Repo.get(Books, 1)&#10;%BookStore.Books&#123;author: &#34;Dave Thomas&#34;,&#10; description: &#34;Programming Elixir: a lot more fun&#34;, id: 1,&#10;  publisher: &#34;The Pragmatic Bookshelf&#34;, title: &#34;Programming Elixir with fun&#34;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="插入">插入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; Repo.insert(%Books&#123;author: &#34;Simon St. Laurent, J. David Eisenberg&#34;, \&#10;                        description: &#34;Elixir is an excellent language if you want to \&#10;                                      learn about functional programming, and with this hands-on \&#10;                                      introduction&#34;,&#10;                        publisher: &#34;O&#39;Reilly&#34;, title: &#34;Introducing Elixir&#34;&#125;)&#10;%BookStore.Books&#123;author: &#34;Simon St. Laurent, J. David Eisenberg&#34;,&#10;                 description: &#34;Elixir is an excellent language if you want to learn about \&#10;                               functional programming, and with this hands-on introduction&#34;, \&#10;                 id: 18, publisher: &#34;O&#39;Reilly&#34;, title: &#34;Introducing Elixir&#34;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="删除">删除</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; introducing_elixir_book = Repo.get(Books, 2)&#10;%BookStore.Books&#123;author: &#34;Simon St. Laurent, J. David Eisenberg&#34;,&#10; description: &#34;Elixir is an excellent language if you want to learn \&#10;               about functional programming, and with this hands-on introduction&#34;,&#10;  id: 2, publisher: &#34;O&#39;Reilly&#34;, title: &#34;Introducing Elixir&#34;&#125;&#10;iex&#62; Repo.delete(introducing_elixir_book)&#10;:ok</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://learnelixir.com/blog/2014/10/08/playing-with-model-in-elixir-phoenix-console/" target="_blank" rel="external">http://learnelixir.com/blog/2014/10/08/playing-with-model-in-elixir-phoenix-console/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:10:12.000Z"><a href="/2014/11/13/elixir-encoding/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-encoding/">编码问题</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><code>iex</code>进入Elixir Shell时出现提示</p>
<p><img src="/assets/images/CE4492B6-CDE2-4497-BBDD-B70D557E6DE7.png" alt="Elixir默认编码问题"></p>
<p>临时有效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>
<p>永久有效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-locale LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T17:19:52.000Z"><a href="/2014/11/13/elixir-book-listing-app-with-phoenix-postgresql-and-ecto/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-book-listing-app-with-phoenix-postgresql-and-ecto/">用Phoenix,Postgresql和Ecto创建一个书单应用</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#修订"><span class="toc-number">1.</span> <span class="toc-text">修订</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Phoenix"><span class="toc-number">2.</span> <span class="toc-text">安装Phoenix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建书单项目"><span class="toc-number">3.</span> <span class="toc-text">创建书单项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加依赖库"><span class="toc-number">4.</span> <span class="toc-text">添加依赖库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个仓库(Repo)"><span class="toc-number">5.</span> <span class="toc-text">创建一个仓库(Repo)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建模型"><span class="toc-number">6.</span> <span class="toc-text">创建模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建数据库移植脚本"><span class="toc-number">7.</span> <span class="toc-text">创建数据库移植脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建查询"><span class="toc-number">8.</span> <span class="toc-text">创建查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置路由"><span class="toc-number">9.</span> <span class="toc-text">配置路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建控制器"><span class="toc-number">10.</span> <span class="toc-text">创建控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建书单视图"><span class="toc-number">11.</span> <span class="toc-text">创建书单视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">12.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>本文通过一个书单应用简要介绍使用Phoenix框架创建一个Web应用程序的基本步骤. 从这些基本步骤我们来逐步学习如何使用phoenix框架开发一个Web应用程序的基本过程.</p>
<h2 id="修订">修订</h2><ul>
<li>2014-12-17<ul>
<li>Phoenix 从0.8.0开始 phoenix任务<code>phoenix.start</code>重命名为<code>phoenix.server</code></li>
<li>修改项目文件<code>mix.exs</code>的依赖版本号,更新依赖库<ul>
<li>ecto          0.2.0 -&gt; 0.2.8</li>
<li>postgrex      0.5.0 -&gt; 0.6.0</li>
<li>phoenix       0.5.0 -&gt; master</li>
</ul>
</li>
<li>增加命令注释说明</li>
</ul>
</li>
</ul>
<h2 id="安装Phoenix">安装Phoenix</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/phoenixframework/phoenix.git&#10;cd phoenix&#10;mix do deps.get, compile</span><br></pre></td></tr></table></figure>
<h2 id="创建书单项目">创建书单项目</h2><p>在<code>phoenix</code>源代码目录中运行如下命令创建一个<code>phoenix</code>项目目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phoenix.new book_store ../book_store&#10;=== =========== ========== =============&#10;|         |            |              |&#10;&#21629;&#20196;     &#20219;&#21153;        &#39033;&#30446;&#21517;&#31216;    &#26032;&#21019;&#24314;&#30340;&#39033;&#30446;&#20445;&#23384;&#20301;&#32622;</span><br></pre></td></tr></table></figure>
<p>目录<code>../book_store</code>不必事先存在, <code>phoenix</code>会自动创建.</p>
<h2 id="添加依赖库">添加依赖库</h2><p>编辑<code>mix.exs</code>文件, 修改后如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Mixfile do&#10;  use Mix.Project&#10;  def project do&#10;    [app: :book_store,&#10;     version: &#34;0.0.1&#34;,&#10;     elixir: &#34;~&#62; 1.0&#34;,&#10;     elixirc_paths: [&#34;lib&#34;, &#34;web&#34;],&#10;     compilers: [:phoenix] ++ Mix.compilers,&#10;     deps: deps]&#10;  end&#10;  # Configuration for the OTP application&#10;  #&#10;  # Type `mix help compile.app` for more information&#10;  def application do&#10;    [mod: &#123;BookStore, []&#125;,&#10;     applications: [:phoenix, :cowboy, :logger, :postgrex, :ecto]]&#10;  end&#10;  # Specifies your project dependencies&#10;  #&#10;  # Type `mix help deps` for examples and options&#10;  defp deps do&#10;    [ &#123;:phoenix, github: &#34;phoenixframework/phoenix&#34;&#125;,&#10;      &#123;:cowboy, &#34;~&#62; 1.0&#34;&#125;,&#10;      &#123;:postgrex, &#34;~&#62; 0.6.0&#34;&#125;,&#10;      &#123;:ecto, &#34;~&#62; 0.2.8&#34;&#125; ]&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>和修改之前的<code>mix.exs</code>文件相比有两个变更处:</p>
<ul>
<li>在<code>application</code>函数中增加了两个依赖的应用程序 <code>:postgres</code> 和 <code>:ecto</code> (16行)</li>
<li>在<code>deps</code>函数增加两个依赖库<code>{:postgrex, &quot;~&gt; 0.6.0&quot;}</code>和<code>{:ecto, &quot;~&gt; 0.2.8&quot;}</code>(24,25行)</li>
</ul>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix do deps.get, compile</span><br></pre></td></tr></table></figure>
<h2 id="创建一个仓库(Repo)">创建一个仓库(Repo)</h2><p>创建文件<code>web/models/repo.ex</code>,内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Repo do&#10;  use Ecto.Repo, adapter: Ecto.Adapters.Postgres&#10;  def conf do&#10;    parse_url &#34;ecto://postgres:postgres@localhost/book_store&#34;&#10;  end&#10;  def priv do&#10;    app_dir(:book_store, &#34;priv/repo&#34;)&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>创建数据库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createdb book_store -U postgres --encoding=&#39;utf-8&#39; --locale=en_US.UTF-8 --template=template0</span><br></pre></td></tr></table></figure>
<p>修改<code>lib/book_store.ex</code>为, 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore do&#10;  use Application&#10;  # See http://elixir-lang.org/docs/stable/elixir/Application.html&#10;  # for more information on OTP Applications&#10;  def start(_type, _args) do&#10;    import Supervisor.Spec, warn: false&#10;    children = [&#10;      # Define workers and child supervisors to be supervised&#10;      worker(BookStore.Repo, [])&#10;    ]&#10;    opts = [strategy: :one_for_one, name: BookStore.Supervisor]&#10;    Supervisor.start_link(children, opts)&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix compile</span><br></pre></td></tr></table></figure>
<h2 id="创建模型">创建模型</h2><p>创建文件<code>web/models/books.ex</code>, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Books do&#10;  use Ecto.Model&#10;  schema &#34;books&#34; do&#10;    field :title, :string&#10;    field :description, :string&#10;    field :author, :string&#10;    field :publisher, :string&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="创建数据库移植脚本">创建数据库移植脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix ecto.gen.migration Bookstore.Repo create_book&#10;Compiled web/models/books.ex&#10;Generated bookstore.app&#10;* creating priv/repo/migrations&#10;* creating priv/repo/migrations/20141112170140_create_book.exs</span><br></pre></td></tr></table></figure>
<p>编辑生成的<code>priv/repo/migrations/20141112170140_create_book.exs</code>脚本, 内容如下:</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span></span>.<span class="constant">Repo.Migrations.CreateBook </span><span class="keyword">do</span>
  <span class="keyword">use</span> <span class="constant">Ecto.Migration</span>

  <span class="function"><span class="keyword">def</span> <span class="title">up</span></span> <span class="keyword">do</span>
    [<span class="string">"CREATE TABLE books(\
        id serial primary key, \
        title varchar(125), \
        description text, \
        author varchar(255), \
        publisher varchar(255))"</span>,\

     <span class="string">"INSERT INTO books(title, description, author, publisher) \
             VALUES ( \
                'Programming Elixir', \
                'Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun', \
                'Dave Thomas', \
                'The Pragmatic Bookshelf')"</span>
    ]
  <span class="keyword">end</span>
  <span class="function"><span class="keyword">def</span> <span class="title">down</span></span> <span class="keyword">do</span>
    <span class="string">"DROP TABLE books"</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>运行移植脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix ecto.migrate BookStore.Repo</span><br></pre></td></tr></table></figure>
<h2 id="创建查询">创建查询</h2><p>创建文件<code>web/models/queries.ex</code>, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Queries do&#10;  import Ecto.Query&#10;  def books_query do&#10;    query = from book in BookStore.Books,&#10;            select: book&#10;    BookStore.Repo.all(query)&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="配置路由">配置路由</h2><p>打开文件<code>web/router.ex</code>, 修改为如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Router do&#10;  use Phoenix.Router&#10;  scope &#34;/&#34; do&#10;    # Use the default browser stack.&#10;    pipe_through :browser&#10;    #get &#34;/&#34;, BookStore.PageController, :index, as: :pages&#10;    get &#34;/&#34;, BookStore.BookController, :index, as: :books&#10;  end&#10;  # Other scopes may use custom stacks.&#10;  # scope &#34;/api&#34; do&#10;  #   pipe_through :api&#10;  # end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="创建控制器">创建控制器</h2><p>创建文件<code>web/controllers/book_controller.ex</code>, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.BookController do&#10;  use Phoenix.Controller&#10;  plug :action&#10;  def index(conn, _params) do&#10;    books = BookStore.Queries.books_query&#10;    render conn, &#34;index&#34;, books: books&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="创建书单视图">创建书单视图</h2><p>创建文件<code>web/views/book_view.ex</code>, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.BookView do&#10;  use BookStore.Views&#10;end</span><br></pre></td></tr></table></figure>
<p>创建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir web/templates/book</span><br></pre></td></tr></table></figure>
<p>并添加文件<code>web/templates/book/index.html.eex</code>, 内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;h1&#62;&#25105;&#30340;&#22270;&#20070;&#60;/h1&#62;&#10;&#60;table class=&#39;table table-bodered table-striped&#39;&#62;&#10;  &#60;thead&#62;&#10;    &#60;tr&#62;&#10;      &#60;th&#62;#&#60;/th&#62;&#10;      &#60;th&#62;&#26631;&#39064;&#60;/th&#62;&#10;      &#60;th&#62;&#25551;&#36848;&#60;/th&#62;&#10;      &#60;th&#62;&#20316;&#32773;&#60;/th&#62;&#10;      &#60;th&#62;&#20986;&#29256;&#31038;&#60;/th&#62;&#10;    &#60;/tr&#62;&#10;  &#60;/thead&#62;&#10;  &#60;tbody&#62;&#10;    &#60;%= for book &#60;- @books do %&#62;&#10;      &#60;tr&#62;&#10;        &#60;td&#62;&#60;%= book.id %&#62;&#60;/td&#62;&#10;        &#60;td&#62;&#60;%= book.title %&#62;&#60;/td&#62;&#10;        &#60;td&#62;&#60;%= book.description %&#62;&#60;/td&#62;&#10;        &#60;td&#62;&#60;%= book.author %&#62;&#60;/td&#62;&#10;        &#60;td&#62;&#60;%= book.publisher %&#62;&#60;/td&#62;&#10;      &#60;/tr&#62;&#10;    &#60;% end %&#62;&#10;  &#60;/tbody&#62;&#10;&#60;/table&#62;</span><br></pre></td></tr></table></figure>
<p>启动应用,并刷新页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phoenix.start</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/FF5CA944-C022-42A0-8F33-7FF6F01EBD38.png" alt="我的书单应用"></p>
<p>完成!</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Book Listing App With Elixir, Phoenix, Postgres and Ecto<br><a href="http://learnelixir.com/blog/2014/10/05/build-web-app-with-elixir/" target="_blank" rel="external">http://learnelixir.com/blog/2014/10/05/build-web-app-with-elixir/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T02:46:12.000Z"><a href="/2014/11/12/postgresql-install-configuration/">2014-11-12</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/12/postgresql-install-configuration/">PostgreSQL Ubuntu上的安装和配置</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-number">2.</span> <span class="toc-text">配置</span></a></li></ol>
        </div>
        


        <h2 id="安装">安装</h2><p>执行如下命令安装PostgreSQL Server</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y postgresql</span><br></pre></td></tr></table></figure></span>
</code></pre><h2 id="配置">配置</h2><ul>
<li><p>让其他计算机可以连接到Postgresql Server</p>
<p>  编辑文件 <code>vi /etc/postgresql/9.3/main/postgresql.conf</code>, 定位到<code>#listen_addresses = &#39;localhost&#39;</code>, 去掉注释,并修改为:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses = &#39;*&#39;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务器</p>
<pre><code><span class="regexp">/etc/i</span>nit.d<span class="regexp">/postgresql restart</span>
</code></pre></li>
<li><p>登录服务器并修改密码</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#30331;&#24405;&#10;sudo -u postgres psql template1&#10;# &#20462;&#25913;&#23494;&#30721;&#10;ALTER USER postgres with encrypted password &#39;postgres&#39;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改登录认证</p>
<p>  编辑<code>vi /etc/postgresql/9.3/main/pg_hba.conf</code>, 添加如下行:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local   all         postgres                          md5</span><br></pre></td></tr></table></figure>
<p>  再次重启:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装命令行客户端和登录验证</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install postgresql-client&#10;psql -h localhost -U postgres -W</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-10T14:39:17.000Z"><a href="/2014/11/10/elixir-quote-and-unquote/">2014-11-10</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/10/elixir-quote-and-unquote/">元编程Quote和Unquote</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="概念介绍">概念介绍</h2><ul>
<li>Elixir中的AST是什么?<ul>
<li>是一个Elixir Term</li>
<li>是深度嵌套的一种表示Elixir代码结构的方法</li>
</ul>
</li>
<li><p>如何理解?</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(1)&#62; quoted = quote do 1 + 2 end&#10;&#123;:+, [context: Elixir, import: Kernel], [1, 2]&#125;</span><br></pre></td></tr></table></figure>
<p>  quote用于把一个Elixir表达式转换为Elixir的AST片段</p>
</li>
<li>抽象语法树片段(AST Fragment)</li>
</ul>
<p>才接触Quote和Unquote的时候会让人迷惑. 当你很好的理解了它后, 却是非常好用的.</p>
<!--
一个典型的应用场景就是自动化的生成代码, 用于处理系统中高度重复性的工作
- 数据库模型对象的生成
依据数据库的定义可以自动化的生成模型对象
-->
<h2 id="Quote">Quote</h2><p>Quote是一个Elixir函数,用于把一个Elixir表达式转换为AST(抽象语法树). AST是一种编译器的内部表示,用于对表达式进行求值, 比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; quote do: 1 + 2&#10;&#123;:+, [context: Elixir, import: Kernel], [1, 2]&#125;</span><br></pre></td></tr></table></figure>
<p>表达式<code>1 + 2</code>在Elixir编译器中被表示为一个有三个元素的元组:</p>
<ul>
<li>操作符 (<code>:+</code>)</li>
<li>关键字列表元数据(<code>[context: Elixir, import: Kernel]</code>)</li>
<li>参数列表 (<code>[1, 2]</code>)</li>
</ul>
<p>如果不考虑关键字列表元数据, 其可以表示为一棵抽象语法树, 以操作符为根节点, 2个参数为树叶</p>
<p><img src="/assets/images/ast1.png" alt="表达式1 + 2的抽象语法树"></p>
<p>再如, 一个稍微复杂一点的表达式<code>1 + 2 * 3</code>, 将生成一个更加复杂的抽象语法树</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; quote do: 1 + 2 * 3&#10;&#123;:+, [context: Elixir, import: Kernel],[1, &#123;:*, [context: Elixir, import: Kernel], [2, 3]&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/ast2.png" alt="表达式1 + 2 * 3的抽象语法树"></p>
<p>当对表达式求值的时候, Elixir编译器将会从最左边的叶子节点开始遍历. 例如,该AST会求值为: <code>1 + (2 * 3)</code></p>
<p>为了对Quote表达式求值, 需要使用<code>Code.eval_quoted</code>函数, 例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; Code.eval_quoted(quote do: 1 + 2 * 3)&#10;&#123;7, []&#125;</span><br></pre></td></tr></table></figure>
<p><code>Code.eval_quoted</code>函数调用返回一个最终求得的值和一个从求值表达式产生的所有变量列表. 上述求得的值为7, 因为没有变量绑定, 所以返回一个空的列表.</p>
<p>Quote还可以用于函数调用, 比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; quote do: sum(1, 2, 3)&#10;&#123;:sum, [], [1, 2, 3]&#125;</span><br></pre></td></tr></table></figure>
<p>Quote function is like a function which is used to put an expression between a quote so that it can be used later on.</p>
<p>Next let’s try to define some variables and use those in quote body:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; a = 1&#10;1&#10;iex&#62; b = 2&#10;2&#10;iex&#62; Code.eval_quoted(quote do: a + b)&#10;** (CompileError) nofile:1: undefined function a/0</span><br></pre></td></tr></table></figure>
<p>The <code>eval_quoted</code> function call will give you an error on undefined function a. This happens because when<br><code>Code.eval_quoted</code> is called, it does not know any <code>a</code> value, because the a here is not the same variable<br>that we defined outside ealier. In order to refer a variable defined outside quote, unquote function needs to be used</p>
<h2 id="Unquote">Unquote</h2><p>So here, how it should be written if a variable is referred to outside of the scope of quote:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; a = 1&#10;1&#10;iex&#62; b = 2&#10;b&#10;iex&#62; quote do: unquote(a) + unquote(b)&#10;&#123;:+, [context: Elixir, import: Kernel], [1, 2]&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, the value of a and b are now evaluated correctly before Elixir construct the abstract syntax tree and<br>these values are actually computed at compiled time and not runtime. Now, let say, we define a function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; a = 1&#10;1&#10;iex&#62; b = 2&#10;b&#10;iex&#62; fun = fn -&#62; quote do&#10;   unquote(a) + unquote(b)&#10;  end&#10;end&#10;&#123;:+, [context: Elixir, import: Kernel], [1, 2]&#125;</span><br></pre></td></tr></table></figure>
<p>Now we try to change a value and call the function again to see if the presentation will change with the new a value:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; a = 10&#10;10&#10;iex&#62; fun.call()&#10;&#123;:+, [context: Elixir, import: Kernel], [1, 2]&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, although a’s value is change but the funtioncal representing <code>a + b</code> is still reflecting the original<br>value of a and b. The way that we use quote and unquote in Elixir can be very creative and dynamic, for instance, we<br>can define like following to play with the real function definition at runtime.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; num1 = 5&#10;iex&#62; num2 = 2&#10;iex&#62; perform = fn fun -&#62; Code.eval_quoted(quote do: unquote(fun)(unquote(num1), unquote(num2))) end&#10;iex&#62; perform.(:rem) # calculate remaining of 5 and 2&#10;&#123;1, []&#125;&#10;iex&#62; perform.(:div) # calculate division result of 5 and 2&#10;&#123;2, []&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-10T11:56:02.000Z"><a href="/2014/11/10/elixir-anonymous-function/">2014-11-10</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/10/elixir-anonymous-function/">匿名函数</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="快速定义">快速定义</h2><p>进入Elixir Shell输入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(1)&#62; sum = fn a, b -&#62; a + b end&#10;#Function&#60;12.90072148/2 in :erl_eval.expr/5&#62;</span><br></pre></td></tr></table></figure>
<p>匿名函数的定义以关键字<code>fn</code>开始, 然后紧跟参数列表, 再接符号<code>-&gt;</code>, 其后为函数体, 并以关键字<code>end</code>结束匿名函数的定义</p>
<p>要调用匿名函数,需要使用<code>dot</code>(点)语法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(2)&#62; sum.(1,2)&#10;3</span><br></pre></td></tr></table></figure>
<h2 id="匿名函数作为参数">匿名函数作为参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyList do&#10;    def filter([], _func) do&#10;        []&#10;    end&#10;    def filter([head|tail], func) do&#10;        if func.(head) do&#10;            [head | filter(tail, func)]&#10;        else&#10;            filter(tail, func)&#10;        end&#10;    end&#10;end&#10;## &#22855;&#25968;&#10;MyList.filter([1,2,3,4,5,6], fn num -&#62; rem(num,2) == 1 end)</span><br></pre></td></tr></table></figure>
<p>控制台输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(5)&#62; MyList.filter([1,2,3,4,5,6], fn num -&#62; rem(num,2) == 1 end)&#10;[1, 3, 5]</span><br></pre></td></tr></table></figure>
<h2 id="匿名函数简写">匿名函数简写</h2><p>我们可以把匿名函数<code>fn n -&gt; rem(n, 2) == 1 end</code>简写为<code>&amp;(rem(&amp;1, 2) == 1)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum = fn a, b -&#62; a + b end&#10;# &#31561;&#21516;&#20110;&#10;sum = &#38;(&#38;1 + &#38;2)</span><br></pre></td></tr></table></figure>
<p>其中第一个<code>&amp;</code>表示匿名函数本身<code>&amp;1</code>表示匿名函数的第一个参数, <code>&amp;2</code>表示匿名函数的第二个参数, 以此类推. 小括号内为函数体表达式.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-07T03:36:45.000Z"><a href="/2014/11/07/ejabberd-muc/">2014-11-07</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/07/ejabberd-muc/">Ejabberd 多人聊天协议分析-配置房间</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取配置信息"><span class="toc-number">2.</span> <span class="toc-text">获取配置信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置聊天室表单IQ-result"><span class="toc-number">3.</span> <span class="toc-text">配置聊天室表单IQ-result</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#提交房间配置表单_IQ-set"><span class="toc-number">4.</span> <span class="toc-text">提交房间配置表单 IQ-set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取服务器上的聊天室列表"><span class="toc-number">5.</span> <span class="toc-text">获取服务器上的聊天室列表</span></a></li></ol>
        </div>
        


        <h2 id="概述">概述</h2><p>MUC(Multiple User Chat), 即多人聊天, 多个用户可以在一个房间(群)里面相互交流. 一个成员发送的信息能够被所有群中的成员看到. XMPP的MUC和QQ群在功能上很多都是相似的. 可以对比两者的区别来学习和理解XMPP的多人聊天扩展.</p>
<p>群里面又各种角色, 不同的角色拥有不同的权限, 例如:</p>
<ul>
<li>群的创建者具有所有权限</li>
<li>群成员只能聊天</li>
<li>管理员可以踢人, 邀请等管理任务.</li>
</ul>
<h2 id="获取配置信息">获取配置信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;get&#39; xml:lang=&#39;zh&#39; to=&#39;xmpp@conference.xmpp.hezhiqiang.info&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;query xmlns=&#39;http://jabber.org/protocol/muc#owner&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<h2 id="配置聊天室表单IQ-result">配置聊天室表单IQ-result</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq from=&#34;xmpp@conference.xmpp.hezhiqiang.info&#34;&#10;    to=&#34;root@xmpp.hezhiqiang.info/37262574821415332900124309&#34;&#10;    type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;&#10;  &#60;query xmlns=&#34;http://jabber.org/protocol/muc#owner&#34;&#62;&#10;    &#60;instructions&#62;&#24744;&#38656;&#35201;&#19968;&#20010;&#20860;&#23481; x:data &#30340;&#23458;&#25143;&#31471;&#26469;&#37197;&#32622;&#25151;&#38388;&#60;/instructions&#62;&#10;    &#60;x xmlns=&#34;jabber:x:data&#34; type=&#34;form&#34;&#62;&#10;      &#60;title&#62;&#25151;&#38388; xmpp@conference.xmpp.hezhiqiang.info &#30340;&#37197;&#32622; &#60;/title&#62;&#10;      &#60;field type=&#34;hidden&#34; var=&#34;FORM_TYPE&#34;&#62;&#10;        &#60;value&#62;http://jabber.org/protocol/muc#roomconfig&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;text-single&#34; label=&#34;&#25151;&#38388;&#26631;&#39064;&#34; var=&#34;muc#roomconfig_roomname&#34;&#62;&#10;        &#60;value&#62;&#32676;&#26631;&#39064;&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;text-single&#34; label=&#34;&#25151;&#38388;&#25551;&#36848;&#34; var=&#34;muc#roomconfig_roomdesc&#34;&#62;&#10;        &#60;value&#62;&#32676;&#25551;&#36848;&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#27704;&#20037;&#20445;&#23384;&#35813;&#25151;&#38388;&#34; var=&#34;muc#roomconfig_persistentroom&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20351;&#25151;&#38388;&#21487;&#34987;&#20844;&#24320;&#25628;&#32034;&#34; var=&#34;muc#roomconfig_publicroom&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20844;&#24320;&#21442;&#19982;&#20154;&#21015;&#34920;&#34; var=&#34;public_list&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#36827;&#20837;&#27492;&#25151;&#38388;&#38656;&#35201;&#23494;&#30721;&#34; var=&#34;muc#roomconfig_passwordprotectedroom&#34;&#62;&#10;        &#60;value&#62;0&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;text-private&#34; label=&#34;&#23494;&#30721;&#34; var=&#34;muc#roomconfig_roomsecret&#34;&#62;&#10;        &#60;value/&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;list-single&#34; label=&#34;&#20801;&#35768;&#30340;&#19982;&#20250;&#20154;&#26368;&#22823;&#25968;&#34; var=&#34;muc#roomconfig_maxusers&#34;&#62;&#10;        &#60;value&#62;200&#60;/value&#62;&#10;        &#60;option label=&#34;5&#34;&#62;&#10;          &#60;value&#62;5&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;10&#34;&#62;&#10;          &#60;value&#62;10&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;20&#34;&#62;&#10;          &#60;value&#62;20&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;30&#34;&#62;&#10;          &#60;value&#62;30&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;50&#34;&#62;&#10;          &#60;value&#62;50&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;100&#34;&#62;&#10;          &#60;value&#62;100&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;200&#34;&#62;&#10;          &#60;value&#62;200&#60;/value&#62;&#10;        &#60;/option&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;list-single&#34; label=&#34;&#23558;&#30495;&#23454; Jabber ID &#26174;&#31034;&#32473;&#34; var=&#34;muc#roomconfig_whois&#34;&#62;&#10;        &#60;value&#62;moderators&#60;/value&#62;&#10;        &#60;option label=&#34;&#20165;&#20027;&#25345;&#20154;&#34;&#62;&#10;          &#60;value&#62;moderators&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;&#20219;&#20309;&#20154;&#34;&#62;&#10;          &#60;value&#62;anyone&#60;/value&#62;&#10;        &#60;/option&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#35774;&#32622;&#25151;&#38388;&#21482;&#25509;&#25910;&#20250;&#21592;&#34; var=&#34;muc#roomconfig_membersonly&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#35774;&#32622;&#25151;&#38388;&#21482;&#25509;&#25910;&#20027;&#25345;&#20154;&#34; var=&#34;muc#roomconfig_moderatedroom&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#29992;&#25143;&#40664;&#35748;&#34987;&#35270;&#20026;&#21442;&#19982;&#20154;&#34; var=&#34;members_by_default&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#29992;&#25143;&#26356;&#25913;&#20027;&#39064;&#34; var=&#34;muc#roomconfig_changesubject&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#29992;&#25143;&#21457;&#36865;&#31169;&#32842;&#28040;&#24687;&#34; var=&#34;allow_private_messages&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;list-single&#34; label=&#34;&#20801;&#35768;&#35775;&#23458;&#21457;&#36865;&#31169;&#32842;&#28040;&#24687;&#33267;&#34; var=&#34;allow_private_messages_from_visitors&#34;&#62;&#10;        &#60;value&#62;anyone&#60;/value&#62;&#10;        &#60;option label=&#34;&#27809;&#26377;&#20154;&#34;&#62;&#10;          &#60;value&#62;nobody&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;&#20165;&#20027;&#25345;&#20154;&#34;&#62;&#10;          &#60;value&#62;moderators&#60;/value&#62;&#10;        &#60;/option&#62;&#10;        &#60;option label=&#34;&#20219;&#20309;&#20154;&#34;&#62;&#10;          &#60;value&#62;anyone&#60;/value&#62;&#10;        &#60;/option&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#29992;&#25143;&#26597;&#35810;&#20854;&#23427;&#29992;&#25143;&#34; var=&#34;allow_query_users&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#29992;&#25143;&#21457;&#36865;&#36992;&#35831;&#34; var=&#34;muc#roomconfig_allowinvites&#34;&#62;&#10;        &#60;value&#62;0&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34;&#10;        label=&#34;&#26356;&#26032;&#22312;&#32447;&#29366;&#24577;&#26102;&#20801;&#35768;&#29992;&#25143;&#21457;&#36865;&#29366;&#24577;&#25991;&#26412;&#34; var=&#34;muc#roomconfig_allowvisitorstatus&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#29992;&#25143;&#26356;&#25913;&#26165;&#31216;&#34; var=&#34;muc#roomconfig_allowvisitornickchange&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#20801;&#35768;&#35775;&#23458;&#21457;&#36865;&#22768;&#38899;&#35831;&#27714;&#34; var=&#34;muc#roomconfig_allowvoicerequests&#34;&#62;&#10;        &#60;value&#62;1&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;field type=&#34;text-single&#34;&#10;        label=&#34;&#22768;&#38899;&#35831;&#27714;&#30340;&#26368;&#23567;&#38388;&#38548;(&#20197;&#31186;&#20026;&#21333;&#20301;)&#34; var=&#34;muc#roomconfig_voicerequestmininterval&#34;&#62;&#10;        &#60;value&#62;1800&#60;/value&#62;&#10;      &#60;/field&#62;&#10;      &#60;!-- &#39564;&#35777;&#30721;&#30333;&#21517;&#21333;: &#35813;&#21517;&#21333;&#20013;&#30340;Jid&#21487;&#20197;&#32469;&#36807;&#39564;&#35777;&#30721;&#39564;&#35777;--&#62;&#10;      &#60;field type=&#34;jid-multi&#34;&#10;        label=&#34;&#20174;&#39564;&#35777;&#30721;&#25361;&#25112;&#20013;&#25490;&#38500; Jabber ID&#34; var=&#34;muc#roomconfig_captcha_whitelist&#34;/&#62;&#10;      &#60;field type=&#34;boolean&#34; label=&#34;&#21551;&#29992;&#26381;&#21153;&#22120;&#31471;&#32842;&#22825;&#35760;&#24405;&#34; var=&#34;muc#roomconfig_enablelogging&#34;&#62;&#10;        &#60;value&#62;0&#60;/value&#62;&#10;      &#60;/field&#62;&#10;    &#60;/x&#62;&#10;  &#60;/query&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<h2 id="提交房间配置表单_IQ-set">提交房间配置表单 IQ-set</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- &#25552;&#20132;&#25151;&#38388;&#37197;&#32622;&#34920;&#21333; --&#62;&#10;&#60;iq type=&#39;set&#39; id=&#39;purple6b0f6f1d&#39; to=&#39;xmpp@conference.xmpp.hezhiqiang.info&#39;&#62;&#10;    &#60;query xmlns=&#39;http://jabber.org/protocol/muc#owner&#39;&#62;&#10;        &#60;x xmlns=&#39;jabber:x:data&#39; type=&#39;submit&#39;&#62;&#10;            &#60;field var=&#39;FORM_TYPE&#39;&#62;&#10;                &#60;value&#62;http://jabber.org/protocol/muc#roomconfig&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_roomname&#39;&#62;&#10;                &#60;value&#62;&#32676;&#26631;&#39064;&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_roomdesc&#39;&#62;&#10;                &#60;value&#62;&#32676;&#25551;&#36848;&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_persistentroom&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_publicroom&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;public_list&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_passwordprotectedroom&#39;&#62;&#10;                &#60;value&#62;0&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_roomsecret&#39;&#62;&#10;                &#60;value/&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_maxusers&#39;&#62;&#10;                &#60;value&#62;200&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_whois&#39;&#62;&#10;                &#60;value&#62;moderators&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_membersonly&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_moderatedroom&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;members_by_default&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_changesubject&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;!-- &#20801;&#35768;&#31169;&#26377;&#28040;&#24687;--&#62;&#10;            &#60;field var=&#39;allow_private_messages&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;allow_private_messages_from_visitors&#39;&#62;&#10;                &#60;value&#62;anyone&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;!-- &#20801;&#35768;&#26597;&#35810;&#29992;&#25143; --&#62;&#10;            &#60;field var=&#39;allow_query_users&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;!-- &#26159;&#21542;&#20801;&#35768;&#36992;&#35831; --&#62;&#10;            &#60;field var=&#39;muc#roomconfig_allowinvites&#39;&#62;&#10;                &#60;value&#62;0&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_allowvisitorstatus&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_allowvisitornickchange&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_allowvoicerequests&#39;&#62;&#10;                &#60;value&#62;1&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_voicerequestmininterval&#39;&#62;&#10;                &#60;value&#62;1800&#60;/value&#62;&#10;            &#60;/field&#62;&#10;            &#60;field var=&#39;muc#roomconfig_captcha_whitelist&#39;/&#62;&#10;            &#60;field var=&#39;muc#roomconfig_enablelogging&#39;&#62;&#10;                &#60;value&#62;0&#60;/value&#62;&#10;            &#60;/field&#62;&#10;        &#60;/x&#62;&#10;    &#60;/query&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<h2 id="获取服务器上的聊天室列表">获取服务器上的聊天室列表</h2><p>IQ-get</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;get&#39; to=&#39;conference.xmpp.hezhiqiang.info&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;query xmlns=&#39;http://jabber.org/protocol/disco#items&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>IQ-result</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq from=&#34;conference.xmpp.hezhiqiang.info&#34;&#10;    to=&#34;root@xmpp.hezhiqiang.info/36782688381415333849585695&#34;&#10;    type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; version=&#34;1.0&#34;&#62;&#10;  &#60;query xmlns=&#34;http://jabber.org/protocol/disco#items&#34;&#62;&#10;    &#60;item jid=&#34;test@conference.xmpp.hezhiqiang.info&#34; name=&#34;&#32842;&#22825;&#23460;&#26631;&#39064; (0)&#34;/&#62;&#10;    &#60;item jid=&#34;xmpp@conference.xmpp.hezhiqiang.info&#34; name=&#34;&#32676;&#26631;&#39064; (0)&#34;/&#62;&#10;  &#60;/query&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>TODO::需要扩展支持分页显示</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T08:39:53.000Z"><a href="/2014/11/05/elixir-iot-1/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-iot-1/">译文 | Elixir 物联网-1</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule IoT do&#10;    defp do_listen(list_socket) do&#10;        # &#25509;&#21463;&#36830;&#25509;&#10;        &#123;:ok, socket&#125; = :ssl.transport_accept(listen_socket)&#10;        :ok = :ssl.accept_socket(socket)&#10;        endpoint = TcpSupervisor.start_endpoint(socket)&#10;        :ssl.controlling_process(socket,endpoint)&#10;        # &#24322;&#27493;&#22788;&#29702;&#10;        :gen_server.cast(endpoint, &#123;:start&#125;)&#10;        # &#37325;&#26032;&#36827;&#20837;Accept&#10;        do_listen(listen_socket)&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
<p>多个Acceptor处理每秒1000连接:</p>
<p>Tcp监听器Supervisor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Owsla.TcpListenerSupervisor do&#10;    use Supervisor.Behaviour&#10;    def start_link(port, acceptor_count, backlog) do&#10;        :supervisor.start_link(&#123; :local, :listener_sup&#125;, __MODULE__, [port, acceptor_count, backlog])&#10;    end&#10;    def init([port, acceptor_count, backlog]) do&#10;        :ssl.start()&#10;        &#123;:ok, listen_socket&#125; = create_listen_socket(port, backlog)&#10;        spawn(fn -&#62;&#10;            Enum.each(1..acceptor_count,&#10;                fn (_) -&#62; start_listener() end&#10;                )&#10;            end)&#10;            tree = [ worker(Owsla.TcpAcceptor, [listen_socket], restart: :permanent) ]&#10;            supervise(tree, strategy: :simple_one_for_one)&#10;    end&#10;    def create_listen_socket(port, backlog) do&#10;         tcp_options = [&#10;            :binary,&#10;            &#123;:packet, :line&#125;,&#10;            &#123;:reuseaddr, true&#125;,&#10;            &#123;:active, false&#125;,&#10;            &#123;:backlog, backlog&#125;&#10;            ]&#10;        :gen_tcp.listen(port, tcp_options)&#10;    end&#10;    def start_listener() do&#10;        :supervisor.start_child(:listener_sup, [])&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Owsla.TcpAcceptor do&#10;    use GenServer.Behaviour&#10;&#10;    @ssl_options&#10;        [&#123;:certfile, &#34;deviceserver.crt&#34;&#125;, &#123;:keyfile, &#34;deviceserver.key&#34;&#125;,&#10;        &#123;:ciphers, [&#10;            &#123;:dhe_rsa,:aes_256_cbc,:sha256&#125;,&#10;            &#123;:dhe_dss,:aes_256_cbc,:sha256&#125;,&#10;            &#123;:rsa,:aes_256_cbc,:sha256&#125;,&#10;            &#123;:dhe_rsa,:aes_128_cbc,:sha256&#125;,&#10;            &#123;:dhe_dss,:aes_128_cbc,:sha256&#125;,&#10;            &#123;:rsa,:aes_128_cbc,:sha256&#125;,&#10;            &#123;:dhe_rsa,:aes_256_cbc,:sha&#125;,&#10;            &#123;:dhe_dss,:aes_256_cbc,:sha&#125;,&#10;            &#123;:rsa,:aes_256_cbc,:sha&#125;,&#10;            &#123;:dhe_rsa,:&#39;3des_ede_cbc&#39;,:sha&#125;,&#10;            &#123;:dhe_dss,:&#39;3des_ede_cbc&#39;,:sha&#125;,&#10;            &#123;:rsa,:&#39;3des_ede_cbc&#39;,:sha&#125;,&#10;            &#123;:dhe_rsa,:aes_128_cbc,:sha&#125;,&#10;            &#123;:dhe_dss,:aes_128_cbc,:sha&#125;,&#10;            &#123;:rsa,:aes_128_cbc,:sha&#125;,&#10;            &#123;:rsa,:rc4_128,:sha&#125;,&#10;            &#123;:rsa,:rc4_128,:md5&#125;,&#10;            &#123;:dhe_rsa,:des_cbc,:sha&#125;,&#10;            &#123;:rsa,:des_cbc,:sha&#125;&#10;        ]&#125;]&#10;&#10;    def start_link(listen_socket) do&#10;        :gen_server.start_link(__MODULE__, listen_socket, [])&#10;    end&#10;    def init(listen_socket) do&#10;        :gen_server.cast self, &#123;:listen&#125;&#10;        &#123;:ok, listen_socket&#125;&#10;    end&#10;&#10;    def handle_cast( &#123;:listen&#125;, listen_socket) do&#10;        do_listen(listen_socket)&#10;    end&#10;&#10;    defp do_listen(listen_socket) do&#10;        case :gen_tcp.accept(listen_socket) do&#10;       &#123;:ok, socket&#125; -&#62;&#10;                case :ssl.ssl_accept(socket, @ssl_options) do&#10;               &#123;:ok, ssl_socket&#125; -&#62;&#10;                        endpoint = Owsla.TcpSupervisor.start_endpoint(ssl_socket)&#10;                        :ssl.controlling_process(ssl_socket, endpoint)&#10;                        :gen_server.cast endpoint, &#123;:start&#125;&#10;                        do_listen(listen_socket)&#10;               &#123;:error, :closed&#125; -&#62;&#10;                        do_listen(listen_socket)&#10;                end&#10;       &#123;:error, :closed&#125; -&#62; do_listen(listen_socket)&#10;       &#123;:error, _&#125; -&#62; &#123; :stop, :error, [] &#125;&#10;        end&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T05:47:41.000Z"><a href="/2014/11/05/elixir-i18n-linguist/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-i18n-linguist/">使用linguist处理国际化字符串</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>使用Mix创建一个项目:</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix new i18n_example&#10;cd i18n_example</span><br></pre></td></tr></table></figure></span>
</code></pre><p>编辑<code>mix.exs</code>项目文件, 添加linguist依赖</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defp deps do&#10;    [&#123;:linguist,  github: &#34;chrismccord/linguist&#34;&#125;]&#10;end</span><br></pre></td></tr></table></figure></span>
</code></pre><p>获取依赖</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix deps.get</span><br></pre></td></tr></table></figure></span>
</code></pre><p>增加国际化字符串文件</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># locales/zh.exs&#10;[&#10;  flash: [&#10;    notice: [&#10;      hello: &#34;&#20320;&#22909; %&#123;first&#125; %&#123;last&#125;&#34;&#10;    ]&#10;  ]&#10;]&#10;# locales/fr.exs&#10;[&#10;  flash: [&#10;    notice: [&#10;      hello: &#34;salut %&#123;first&#125; %&#123;last&#125;&#34;&#10;    ]&#10;  ]&#10;]</span><br></pre></td></tr></table></figure></span>
</code></pre><p>实现模块</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule I18n do&#10;    use Linguist.Vocabulary&#10;    # &#40664;&#35748;&#33521;&#25991;, &#27880;&#24847;,&#36825;&#37324;&#30340;locale&#26159;&#19968;&#20010;&#23439;,&#32780;&#19981;&#26159;&#19968;&#20010;&#20989;&#25968;&#10;    locale &#34;en&#34;, [&#10;        flash: [&#10;            notice: [&#10;                hello: &#34;hello %&#123;first&#125; %&#123;last&#125;&#34;,&#10;                bye: &#34;bye now, %&#123;name&#125;!&#34;&#10;            ]&#10;        ],&#10;        users: [&#10;            title: &#34;Users&#34;,&#10;            profiles: [&#10;                title: &#34;Profiles&#34;&#10;            ]&#10;        ]&#10;    ]&#10;    # locale&#23439;&#36824;&#21487;&#20197;&#30452;&#25509;&#35835;&#21462;&#25991;&#20214;&#10;    locale &#34;fr&#34;, Path.join([Path.dirname(__DIR__), &#34;locales&#34;,&#34;fr.exs&#34;])&#10;    locale &#34;zh&#34;, Path.join([Path.dirname(__DIR__), &#34;locales&#34;,&#34;zh.exs&#34;])&#10;end</span><br></pre></td></tr></table></figure></span>
</code></pre><p>测试</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iex -S mix&#10;iex(1)&#62; I18n.t!(&#34;en&#34;, &#34;flash.notice.hello&#34;, first: &#34;chris&#34;, last: &#34;mccord&#34;)&#10;&#34;hello chris mccord&#34;&#10;iex(2)&#62; I18n.t!(&#34;zh&#34;, &#34;flash.notice.hello&#34;, first: &#34;chris&#34;, last: &#34;mccord&#34;)&#10;&#34;&#20320;&#22909; chris mccord&#34;</span><br></pre></td></tr></table></figure></span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T01:56:51.000Z"><a href="/2014/11/05/elixir-introduce-mix/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-introduce-mix/">简介</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bootstrapping"><span class="toc-number">1.</span> <span class="toc-text">Bootstrapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mix-exs"><span class="toc-number">1.1.</span> <span class="toc-text">mix.exs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lib/my_project-ex"><span class="toc-number">1.2.</span> <span class="toc-text">lib/my_project.ex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test/my_project_test-exs"><span class="toc-number">1.3.</span> <span class="toc-text">test/my_project_test.exs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test/test_helper-exs"><span class="toc-number">1.4.</span> <span class="toc-text">test/test_helper.exs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#探索"><span class="toc-number">2.</span> <span class="toc-text">探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">3.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#依赖"><span class="toc-number">4.</span> <span class="toc-text">依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源代码管理(scm)"><span class="toc-number">4.1.</span> <span class="toc-text">源代码管理(scm)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译依赖"><span class="toc-number">4.2.</span> <span class="toc-text">编译依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重复性"><span class="toc-number">4.3.</span> <span class="toc-text">重复性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖任务"><span class="toc-number">4.4.</span> <span class="toc-text">依赖任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖的依赖"><span class="toc-number">4.5.</span> <span class="toc-text">依赖的依赖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#伞形项目"><span class="toc-number">5.</span> <span class="toc-text">伞形项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-number">6.</span> <span class="toc-text">环境</span></a></li></ol>
        </div>
        


        <p>Elixir自带了几个应用使得编写和部署Elixir项目更加容易,其中Mix是关键.</p>
<p>Mix是一个提供了用于创建,编译,测试(很快就会有发布功能)的编译工具.Mix的灵感来自于Clojure的编译工具<a href="https://github.com/technomancy/leiningen" target="_blank" rel="external">Leiningen</a>,并且作者本人就是它的其中一个开发者.</p>
<p>在这一章,我们将学习如何用mix来创建项目,安装依赖.在之后的部分,我们将雪鞋如何创建OTP应用,和定制mix的任务.</p>
<h2 id="Bootstrapping">Bootstrapping</h2><p>要开始你的第一个项目,你只需要输入<code>mix new</code> 并把项目的路径作为参数.现在,我们将在当前目录创建一个被称为<code>my_project</code>的项目:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix new my_project --bare</span><br></pre></td></tr></table></figure>
<p>Mix将创建一个名为<code>my_project</code>的目录,包含一下这些内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.gitignore&#10;README.md&#10;mix.exs&#10;lib/my_project.ex&#10;test/test_helper.exs&#10;test/my_project_test.exs</span><br></pre></td></tr></table></figure>
<p>让我们来简单地看一下其中的一些.</p>
<ul>
<li><p>注意:Mix是一个Elixir的可执行文件.这意味着为了能够运行<code>mix</code>,elixir的可执行文件许需要在你的<code>PATH</code>里面.如果不是,你可以直接把脚本作为参数传递给elixir来执行:</p>
<p>  <code>$ bin/elixir bin/mix new ./my_project</code></p>
</li>
<li><p>注意你也能通过<code>-S</code>选项来让Elixir运行任何PATH里的脚本:</p>
<p>  <code>$ bin/elixir -S mix new ./my_project</code></p>
</li>
</ul>
<p>当用了<code>-S</code>, elixir会遍历PATH,寻找并运行那个脚本</p>
<h3 id="mix-exs">mix.exs</h3><p>这是包含了你项目配置的文件.它看起来是这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyProject.Mixfile do&#10;  use Mix.Project&#10;&#10;  def project do&#10;    [app: :my_project,&#10;     version: &#34;0.0.1&#34;,&#10;     deps: deps]&#10;  end&#10;&#10;  # Configuration for the OTP application&#10;  def application do&#10;    []&#10;  end&#10;&#10;  # Returns the list of dependencies in the format:&#10;  # &#123;:foobar, git: &#34;https://github.com/elixir-lang/foobar.git&#34;, tag: &#34;0.1&#34;&#125;&#10;  #&#10;  # To specify particular versions, regardless of the tag, do:&#10;  # &#123;:barbat, &#34;~&#62; 0.1&#34;, github: &#34;elixir-lang/barbat&#34;&#125;&#10;  defp deps do&#10;    []&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>我们的<code>mix.exs</code>定义了两个函数:</p>
<p><code>project</code>, 用来返回项目的配置比如项目名称和版本,和<code>application</code>,用来产生一个被Erlang运行时管理的Erlang应用.在这一章,我们将谈一谈函数<code>project</code>.我们将在下一章详谈<code>application</code>函数.</p>
<h3 id="lib/my_project-ex">lib/my_project.ex</h3><p>这个文件包含了一个简单的模块,它定义了我们代码的基本结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyProject do&#10;end</span><br></pre></td></tr></table></figure>
<h3 id="test/my_project_test-exs">test/my_project_test.exs</h3><p>这个文件包含了项目的一个测试用例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyProjectTest do&#10;  use ExUnit.Case&#10;&#10;  test &#34;the truth&#34; do&#10;    assert true&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>有几点请注意:</p>
<ul>
<li>注意这个文件是一个Elixir的脚本文件(<code>.exs</code>).作为一个约定,我们不需要在运行之前编译测试.</li>
<li>我们定义了一个测试模块<code>MyProjectTest</code>,用<code>MyProjectTest</code>来注入默认的行为,并定义了一个简单测试.你可以在<a href="http://elixir-lang.readthedocs.org/getting_started/ex_unit/1.html" target="_blank" rel="external">ExUnit</a>那一章学习到有关测试框架的更多内容.</li>
</ul>
<h3 id="test/test_helper-exs">test/test_helper.exs</h3><p>我们将查看的最后一个文件是<code>test_helper.exs</code>,它的任务是启动测试框架:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExUnit.start</span><br></pre></td></tr></table></figure>
<h2 id="探索">探索</h2><p>现在我们已经创建了新项目,接下去做什么？要了解还有其他什么命令可以使用的话,运行<code>help</code>任务:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix help</span><br></pre></td></tr></table></figure>
<p>它将会打印出所有可用的任务,运行<code>mix help TASK</code>可获取更多的信息.</p>
<p>运行其中一些命令试试,比如<code>mix compile</code>和<code>mix test</code>,在你的项目里运行看看会发生什么.</p>
<h2 id="编译">编译</h2><p>Mix可以为我们编译项目.默认的设置是用<code>lib/</code>放源代码,<code>ebin/</code>放编译后的beam文件.你无需提供任何的编译相关的设置,但如果你决定这么做,有一些选项可以用.例如,如果你打算把你的编译后的beam文件放在<code>ebin</code>之外的文件夹里,只需要在<code>mix.exs</code>里设置<code>:compile_path</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def project do&#10;  [compile_path: &#34;ebin&#34;]&#10;end</span><br></pre></td></tr></table></figure>
<p>总的来说,Mix会尽力表现的聪明一些,只在必须的时候编译.</p>
<p>注意在你第一次编译之后,Mix会在你的<code>ebin</code>文件夹里产生了一个<code>my_project.app</code>文件.这个文件里定义的Erlang应用是用到了你的项目中的<code>application</code>函数里的内容.</p>
<p>这个<code>.app</code>文件存储在和应用有关的信息,它的依赖,它所依赖的模块㩐等.每次你用mix运行命令的时候,这个应用会自动被启动,我们将在下一章学习如何配置它.</p>
<h2 id="依赖">依赖</h2><p>Mix也能用来管理依赖.依赖应被列在项目配置中,例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def project do&#10;  [app: :my_project,&#10;   version: &#34;0.0.1&#34;,&#10;   deps: deps]&#10;end&#10;&#10;defp deps do&#10;  [&#123;:some_project, &#34;&#62;= 0.3.0&#34;&#125;,&#10;   &#123;:another_project, git: &#34;https://example.com/another/repo.git&#34;, tag: &#34;v1.0.2&#34;&#125;]&#10;end</span><br></pre></td></tr></table></figure>
<p><strong>注意:</strong> 虽然并非必须,常见的做法是把依赖分散到它们自己的函数里.</p>
<p>某个依赖有一个原子来表示,跟着是一个需求和一些选项.在默认情况下,Mix使用<a href="https://hex.pm/" target="_blank" rel="external">hex.pm</a>来获取依赖,但它也能从git库或直接从文件系统来获取.</p>
<p>当我们使用Hex, 你必须在需求里指定所接受的依赖的版本.它支持一些基本的操作符,例如<code>&gt;=</code>,<code>&lt;=</code>,<code>&gt;</code>,<code>==</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Only version 2.0.0&#10;&#34;== 2.0.0&#34;&#10;&#10;# Anything later than 2.0.0&#10;&#34;&#62; 2.0.0&#34;</span><br></pre></td></tr></table></figure>
<p>需求也支持用<code>and</code>和<code>or</code>表达复杂的情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 2.0.0 and later until 2.1.0&#10;&#34;&#62;= 2.0.0 and &#60; 2.1.0&#34;</span><br></pre></td></tr></table></figure>
<p>类似上面的例子非常地常见,所以它也能用简单的方式表达:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#34;~&#62; 2.0.0&#34;</span><br></pre></td></tr></table></figure>
<p>注意为git库设置版本需求不会影响到取出的分支和标签,所以类似下面这样的定义是合法的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; :some_project, &#34;~&#62; 0.5.0&#34;, github: &#34;some_project/other&#34;, tag: &#34;0.3.0&#34; &#125;</span><br></pre></td></tr></table></figure>
<p>但它会导致一个依赖永远无法满足,因为被取出的标签总不能和需求的版本匹配.</p>
<h3 id="源代码管理(scm)">源代码管理(scm)</h3><p>Mix的设计就考虑到了支持多种的SCM工具,Hex包是默认,但<code>:git</code>和<code>:path</code>是可选项.常见的一些选项是:</p>
<ul>
<li><code>:git</code>        - 依赖是一个git版本库,Mix可以来获取和升级.</li>
<li><code>:path</code>       - 依赖是文件系统中的一个路径</li>
<li><code>:compile</code>    - 如何编译依赖</li>
<li><code>:app</code>        - 依赖所定义的应用的路径</li>
<li><code>:env</code>        - 依赖所用的环境(详情在后),默认是<code>:prod</code>;</li>
</ul>
<p>每个SCM可以支持自定义选项,比如<code>:git</code>,支持下面的选项:</p>
<ul>
<li><code>:ref</code>        - 用来检出git仓库的一个可选的引用(一次提交);</li>
<li><code>:tag</code>        - 用来检出git仓库的一个可选的tag</li>
<li><code>:branch</code>     - 用来检出git仓库的一个可选的分支</li>
<li><code>:submodules</code> - 当为<code>true</code>,在依赖中递归地初始化子模块;</li>
</ul>
<h3 id="编译依赖">编译依赖</h3><p>为了编译依赖,Mix会选择最适合的方式.依赖所包含的文件不同,编译的方式也不一样:</p>
<ul>
<li><code>mix.exs</code><ul>
<li>直接用Mix的<code>compile</code>任务编译依赖;</li>
</ul>
</li>
<li><code>rebar.config</code>或<code>rebar.config.script</code><ul>
<li>用<code>rebar compile deps_dir=DEPS</code>编译,<code>DEPS</code>是项目依赖的安装目录;</li>
</ul>
</li>
<li><code>Makefile</code><ul>
<li>简单地调用<code>make</code>;</li>
</ul>
</li>
</ul>
<p>如果编译的代码里没有包含以上的任何,你可以在``选项里直接指定一个命令:</p>
<pre><code><span class="collection">{<span class="attribute">:some_dep</span>, git: <span class="string">"..."</span>, compile: <span class="string">"./configure &amp;&amp; make"</span>}</span>
</code></pre><p>如果<code>:compile</code>被设为<code>false</code>, 不做任何事情.</p>
<h3 id="重复性">重复性</h3><p>任何一个依赖管理工具的重要特性是可重复性.因此当你初次获取依赖,Mix将创建一个文件``,用来包含每个依赖所取出的索引.</p>
<p>当另一个开发者得到这个项目的拷贝,Mix将取出相同的那个索引,保证其他的开发者能“重复”同样的设置.</p>
<p>运行<code>deps.update</code>能自动升级锁,用<code>deps.unlock</code>任务来移除锁.</p>
<h3 id="依赖任务">依赖任务</h3><p>Elixir自带了许多用来管理项目依赖的任务:</p>
<ul>
<li><code>mix deps</code> - 列出所有的依赖和它的情况;</li>
<li><code>mix deps.get</code> - 获取所有可得的依赖</li>
<li><code>mix deps.compile</code> - 编译依赖</li>
<li><code>mix deps.update</code> - 更新依赖;</li>
<li><code>mix deps.clean</code> - 删除依赖文件;</li>
<li><code>mix deps.unlock</code> - 解锁依赖</li>
</ul>
<p>用<code>mix help</code>来获取更多信息.</p>
<h3 id="依赖的依赖">依赖的依赖</h3><p>如果你的依赖是一个Mix或rebar的项目,Mix知道如何应付:它将自动获取和处理你的依赖的所有的依赖.然而,如果你的项目中有两个依赖共享了同一个依赖,但它们的SCM信息又无法互相匹配的话,Mix将标明这个依赖是分裂的,并发出警告.要解决而这个问题,你可以在你项目中声明选项<code>override: true</code>, Mix将根据这个信息来获取依赖.</p>
<h2 id="伞形项目">伞形项目</h2><p>你是否想过,如果能将几个Mix项目打包在一起,只需一个命令就可以运行各自的Mix任务, 该有多方便？.这种将项目打包在一起使用的情况被称为伞形项目.一个伞形项目可以用下面的命令来创建:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix new project --umbrella</span><br></pre></td></tr></table></figure>
<p>这将会创建一个包含以下内容的``文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Project.Mixfile do&#10;  use Mix.Project&#10;&#10;  def project do&#10;    [apps_path: &#34;apps&#34;]&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p><code>apps_path</code>选项指定了子项目所在的文件夹.在伞形项目中运行的Mix任务,会对<code>apps_path</code>文件夹中的每一个子项目起作用.例如<code>mix compile</code>和<code>mix test</code>将编译或测试文件夹下的每一个项目.值得注意的是,伞形项目既不是一个普通的Mix项目,也不是一个OTP应用,也不能修改其中的源码.</p>
<p>如果在子项目之间有互相依赖的存在,需要指定它们的顺序,这样Mix才能正确编译.如果项目A依赖于项目B,这个依赖关系必须在项目A的<code>mix.exs</code>文件里指定.修改文件<code>mix.exs</code>来指定这个依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule A.Mixfile do&#10;  use Mix.Project&#10;&#10;  def project do&#10;    [app: :a,&#10;     deps_path: &#34;../../deps&#34;,&#10;     lockfile: &#34;../../mix.lock&#34;,&#10;     deps: deps]&#10;  end&#10;&#10;  defp deps do&#10;    [&#123; :b, in_umbrella: true &#125;]&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>注意上面的子项目中<code>deps_path</code>和<code>lockfile</code>选项.如果在你的伞形项目的所有子项中都有它们,它们将共享依赖.apps文件夹中的<code>mix new</code>将自动用这些预设的选型创建一个项目.</p>
<h2 id="环境">环境</h2><p>Mix有环境的概念,能让一个开发者去基于一个外部的设定来定制编译和其他的选项.默认下,Mix能理解项目三类环境:</p>
<ul>
<li><code>dev</code> - mix任务的默认环境;</li>
<li><code>test</code> - 用于<code>mix test</code>;</li>
<li><code>prod</code> - 在这个环境下,依赖将被载入和编译;</li>
</ul>
<p>在默认情况下,这些环境的行为没有不同,我们之前看到的所有配置都将会影响到这三个环境.针对某个环境的定制,可以通过访问<code>Mix.env</code>来实现:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def project do&#10;  [deps_path: deps_path(Mix.env)]&#10;end&#10;&#10;defp deps_path(:prod), do: &#34;prod_deps&#34;&#10;defp deps_path(_), do: &#34;deps&#34;</span><br></pre></td></tr></table></figure>
<p>Mix默认为<code>dev</code>环境(除了测试).可以通过修改环境变量<code>MIX_ENV</code>来改变环境.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ MIX_ENV=prod mix compile</span><br></pre></td></tr></table></figure>
<p>在下一章,我们将学习如何用Mix编写OTP应用和如何创建你自己的任务.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T12:23:30.000Z"><a href="/2014/11/04/elixir-umbrella-project/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-umbrella-project/">伞形项目</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>关于伞形项目, 什么是伞形项目, 定义在<a href="https://github.com/elixir-lang-china/elixir_guide_cn/blob/master/mix/Chapter1.md#15-%E4%BC%9E%E5%BD%A2%E9%A1%B9%E7%9B%AE" target="_blank" rel="external">这里</a></p>
<p>创建一个伞形项目</p>
<pre><code><span class="comment"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@0b85dcd174f2:~/ejabberd/elixir# mix new umbrella_project --umbrella&#10;* creating .gitignore&#10;* creating README.md&#10;* creating mix.exs&#10;* creating apps&#10;* creating config&#10;* creating config/config.exs&#10;Your umbrella project was created successfully.&#10;Inside your project, you will find an apps/ directory&#10;where you can create and host many apps:&#10;    cd umbrella_project&#10;    cd apps&#10;    mix new my_app&#10;Commands like `mix compile` and `mix test` when executed&#10;in the umbrella project root will automatically run&#10;for each application in the apps/ directory.</span><br></pre></td></tr></table></figure></span>
</code></pre><blockquote>
<p>在伞形项目中运行的Mix任务,会对文件夹中的每一个子项目起作用.</p>
</blockquote>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T12:17:48.000Z"><a href="/2014/11/04/elixir-building-otp-apps-with-mix/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-building-otp-apps-with-mix/">Elixir 使用Mix构建OTP应用(译)</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2_用Mix编写OPT应用"><span class="toc-number">1.</span> <span class="toc-text">2 用Mix编写OPT应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1_Stacker服务器"><span class="toc-number">2.</span> <span class="toc-text">2.1 Stacker服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1-1_深入学习回调函数"><span class="toc-number">3.</span> <span class="toc-text">2.1.1 深入学习回调函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1-2_干掉一个服务器"><span class="toc-number">4.</span> <span class="toc-text">2.1.2 干掉一个服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-2_监控服务器"><span class="toc-number">5.</span> <span class="toc-text">2.2 监控服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-3_谁来监控监工？"><span class="toc-number">6.</span> <span class="toc-text">2.3 谁来监控监工？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-4_启动应用"><span class="toc-number">7.</span> <span class="toc-text">2.4 启动应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-5_配置应用"><span class="toc-number">8.</span> <span class="toc-text">2.5 配置应用</span></a></li></ol>
        </div>
        


        <h1 id="2_用Mix编写OPT应用">2 用Mix编写OPT应用</h1><p>在Elixir里，我们如何保存状态？</p>
<p>我们的软件需要在运行时系统里保存状态，配置，数据。在之前的<a href="http://elixir-lang.org/getting_started/2.html#receive" target="_blank" rel="external">章节</a>里我们已学会了如何用进程/Actor保持状态，在一个循环中如何接受以及回复消息，但这种方式似乎不够可靠。如果我们的进程被一个错误退出了怎么办？难道我们真的需要仅仅为一个配置而去创建一个新的进程？</p>
<p>在这一章，我们将用OTP的方式来回答这些问题。在实践中，我们不必使用Mix来编写这样的应用，然而借此机会正好让我们了解一些Mix提供的一些方便之处。</p>
<h1 id="2-1_Stacker服务器">2.1 Stacker服务器</h1><p>我们的应用将会是一个运行我们推进/推出的简单堆栈。我们管它叫stacker：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix new stacker --bare</span><br></pre></td></tr></table></figure>
<p>我们的应用将包含一个堆栈，允许同一时间被许多的进程访问。为此，我们将创建一个服务器来负责管理这个堆栈。客户端随时可以向服务器发送消息来从服务器推进或取出某物。</p>
<p>因为在Erlang和Elixir里，创建这样的一个服务器是常见的一个范式，在OTP里有一个被称为<strong>GenServer</strong>的行为封装了这些常见的服务器功能。让我们创建一个文件<code>lib/stacker/server.ex</code>， 这就是我们的第一个服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Stacker.Server do&#10;  use GenServer.Behaviour&#10;&#10;  def init(stack) do&#10;    &#123; :ok, stack &#125;&#10;  end&#10;&#10;  def handle_call(:pop, _from, [h|stack]) do&#10;    &#123; :reply, h, stack &#125;&#10;  end&#10;&#10;  def handle_cast(&#123; :push, new &#125;, stack) do&#10;    &#123; :noreply, [new|stack] &#125;&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>我们的服务器定义了三个函数： <code>init/1</code>，<code>handle_call/3</code>和<code>handle_cast/2</code>。我们不会直接调用这些函数，它们是当我们请求服务器的时候由OTP来使用的函数。我们很快会了解详情，现在我们无需关心更多。为此，在你的命令行里运行<code>iex -S mix</code>来开始用mix来启动iex，输入下面的指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Let&#39;s start the server using Erlang&#39;s :gen_server module.&#10;# It expects 3 arguments: the server module, the initial&#10;# stack and some options (if desired):&#10;iex&#62; &#123; :ok, pid &#125; = :gen_server.start_link(Stacker.Server, [], [])&#10;&#123;:ok,&#60;...&#62;&#125;&#10;&#10;# Now let&#39;s push something onto the stack&#10;iex&#62; :gen_server.cast(pid, &#123; :push, 13 &#125;)&#10;:ok&#10;&#10;# Now let&#39;s get it out from the stack&#10;# Notice we are using *call* instead of *cast*&#10;iex&#62; :gen_server.call(pid, :pop)&#10;13</span><br></pre></td></tr></table></figure>
<p>非常好，我们的服务器工作正常！然而在幕后其实发生了很多的事情，然我们来一一探究。</p>
<p>首先，我们用OTP中的<a href="http://www.erlang.org/doc/man/gen_server.html" target="_blank" rel="external"><code>:gen_server</code></a>模块启动服务器。注意我们使用了<code>start_link</code>， 它启动了服务器并且把当前的进程与之相连。在这种情况下，如果服务器死了，它将会向我们的当前进程发送一个退出消息，使它也退出。我们将在后面看到这个行为。函数<code>start_link</code>返回的是新创建的进程的识别符（<code>pid</code>）。</p>
<p>之后，我们向服务器发送了一个<strong>cast</strong>消息。消息的内容是<code>{ :push, 13 }</code>，与我们之前定义在<code>Stacker.Server</code>中的回调函数<code>handle_cast/2</code>里的一致。无论何时我们发送一个<code>cast</code>消息，函数<code>handle_cast/2</code>会被调用来处理这个消息。</p>
<p>接着，我们最终用发送<code>call</code>消息地方时，看到了堆栈里的情况，它触发了回调<code>handle_call/3</code>。那么，<code>cast</code>和<code>call</code>到底有什么不同呢？</p>
<p><code>cast</code>消息是异步的：我们向服务器发送一个消息，然而并不期待回复。这也是为什么我们的<code>handle_cast/2</code>回调返回的是<code>{ :noreply, [new|stack] }</code>的缘故。这个元组中的第一个元素表明了无需回复，而第二个元素是包含了新物件的经过升级的堆栈。</p>
<p>相反，<code>call</code>消息是同步的。当我们发送一个<code>call</code>消息，客户端期待一个回复。在这个例子中，回调<code>handle_call/3</code>返回了<code>{ :reply, h, stack }</code>，其中第二个元素就是用来返回的内容，而第三个是我们不包含头的堆栈。因为<code>call</code>能够向客户端返还消息，所以它的也多了一个有关客户端情况的参数（<code>_from</code>）。</p>
<h1 id="2-1-1_深入学习回调函数">2.1.1 深入学习回调函数</h1><p>在GenServer的例子中，类似<code>handle_call</code>或<code>handle_cast</code>的函数可能返回8种不同的数值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; :reply, reply, new_state &#125;&#10;&#123; :reply, reply, new_state, timeout &#125;&#10;&#123; :reply, reply, new_state, :hibernate &#125;&#10;&#123; :noreply, new_state &#125;&#10;&#123; :noreply, new_state, timeout &#125;&#10;&#123; :noreply, new_state, :hibernate &#125;&#10;&#123; :stop, reason, new_state &#125;&#10;&#123; :stop, reason, reply, new_state &#125;</span><br></pre></td></tr></table></figure>
<p>一个GenServer的实现必须实现6种不同的回调函数。模块<code>GenServer.Behaviour</code>自动定义了这些函数，但又允许我们根据需要来修改。下面是这些函数的列表：</p>
<ul>
<li><code>init(args)</code> - 当服务器启动时调用</li>
<li><code>handle_call(msg, from, state)</code> - 被调用来处理<code>call</code>消息</li>
<li><code>handle_cast(msg, state)</code> - 被调用来处理<code>cast</code>消息</li>
<li><code>handle_info(msg, state)</code> - 被调用来处理进程所收到的其他消息</li>
<li><code>terminate(reason, state)</code> - 在服务器当机之前被调用，对清理很有用</li>
<li><code>code_change(old_vsn, state, extra)</code> - 在应用代码热升级的时候被调用</li>
</ul>
<h1 id="2-1-2_干掉一个服务器">2.1.2 干掉一个服务器</h1><p>Of what use is a server if we cannot crash it?</p>
<p>实际上要使一个服务器当机并不难。我们的回调<code>handle_call/3</code>只有当堆栈不是空的时候才工作正常（想起来了吗，<code>[h|t]</code>不能匹配空列表）。让我们在堆栈为空的情况下发送一个消息看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Start another server, but with an initial :hello item&#10;iex&#62; &#123; :ok, pid &#125; = :gen_server.start_link(Stacker.Server, [:hello], [])&#10;&#123;:ok,&#60;...&#62;&#125;&#10;&#10;# Let&#39;s get our initial item:&#10;iex&#62; :gen_server.call(pid, :pop)&#10;:hello&#10;&#10;# And now let&#39;s call pop again&#10;iex&#62; :gen_server.call(pid, :pop)&#10;&#10;=ERROR REPORT==== 6-Dec-2012::19:15:33 ===&#10;...&#10;** (exit)&#10;...</span><br></pre></td></tr></table></figure>
<p>你可以看到，这里有两个错误报告。第一个因为当机由服务器产生。因为服务器是同我们的进程相连的，它也发送了一个退出的消息，<code>IEx as ** (exit) ....</code></p>
<p>因为我们的服务器总会崩溃，我们需要监控它们，这也是下面的内容。<code>GenServer.Behaviour</code>不仅仅包含我们已经学到的这些。请查看<a href="http://elixir-lang.org/docs/stable/GenServer.Behaviour.html" target="_blank" rel="external"><code>GenServer.Behaviour</code></a>的文档来发现更多。</p>
<h1 id="2-2_监控服务器">2.2 监控服务器</h1><p>当在Eralng和Elixir里编写应用，一个常用到的哲学是fail first。也许是因为资源不可得，也许是服务之间的超时，或许是其他的什么原因。这也是为什么有能力对这些崩溃作出反应并回复过来，是非常重要的。把这些牢记在心，我们为我们的服务器编写一个supervisor。</p>
<p>用下面的内容创建一个文件，<code>lib/stacker/supervisor.ex</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Stacker.Supervisor do&#10;  use Supervisor.Behaviour&#10;&#10;  # A convenience to start the supervisor&#10;  def start_link(stack) do&#10;    :supervisor.start_link(__MODULE__, stack)&#10;  end&#10;&#10;  # The callback invoked when the supervisor starts&#10;  def init(stack) do&#10;    children = [ worker(Stacker.Server, [stack]) ]&#10;    supervise children, strategy: :one_for_one&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>在监控中，唯一需要实现的回调函数是<code>init(args)</code>。这个回调必须返回监工的规格，在上面的例子中实际调用了帮助函数<code>supervise/2</code>。</p>
<p>我们的监工非常简单：它必须监控我们的工人<code>Stacker.Server</code>， 工人的启动需要一个参数，在这是默认的堆栈。完成定义的工人被用<code>:one_for_one</code>的策略监控，这意味着每一次工人死亡之后都会被重启。</p>
<p>由于我们的工人由<code>Stacker.Server</code>模块指定，并且需要传递<code>stack</code>作为参数，在默认下，监工将调用函数<code>Stacker.Server.start_link(stack)</code>来启动工人，所以让我们来实现它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Stacker.Server do&#10;  use GenServer.Behaviour&#10;&#10;  def start_link(stack) do&#10;    :gen_server.start_link(&#123; :local, :stacker &#125;, __MODULE__, stack, [])&#10;  end&#10;&#10;  def init(stack) do&#10;    &#123; :ok, stack &#125;&#10;  end&#10;&#10;  def handle_call(:pop, _from, [h|stack]) do&#10;    &#123; :reply, h, stack &#125;&#10;  end&#10;&#10;  def handle_cast(&#123; :push, new &#125;, stack) do&#10;    &#123; :noreply, [new|stack] &#125;&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>函数<code>start_link</code>同我们之前启动服务器的方式很相似，除了在这里我们需要多传递一个参数<code>{ :local, :stacker }</code>。这个参数在本地节点上注册我们的服务器，运行用一个名字（在这里，是<code>:stacker</code>）来调用它，而无需直接使用<code>pid</code>。</p>
<p>不借助监工，让我们运行<code>iex -S mix</code>来再一次打开控制台，这也会再一次编译我们的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Now we will start the supervisor with a&#10;# default stack containing :hello&#10;iex&#62; Stacker.Supervisor.start_link([:hello])&#10;&#123;:ok,&#60;...&#62;&#125;&#10;&#10;# And we will access the server by name since&#10;# we registered it&#10;iex&#62; :gen_server.call(:stacker, :pop)&#10;:hello</span><br></pre></td></tr></table></figure>
<p>注意监工自动为我们启动了服务器，现在我们可以用名字<code>:stacker</code>向服务器发送消息了。如果我们使得服务器当机，会发送甚什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :gen_server.call(:stacker, :pop)&#10;&#10;=ERROR REPORT==== 6-Dec-2012::19:15:33 ===&#10;...&#10;** (exit)&#10;...&#10;&#10;iex&#62; :gen_server.call(:stacker, :pop)&#10;:hello</span><br></pre></td></tr></table></figure>
<p>它和前面一样当机了，当监工立刻用默认的堆栈重启了它，使得我们可以再一次接受到<code>:hello</code>。太棒了！</p>
<p>默认下，监工运行一个工人在5秒内最多当机5次。如果工人当机的频率超过了这个限制，监工就会放弃它，不在重启。让我们尝试接连发送一个未知的消息看看（要快！）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :gen_server.call(:stacker, :unknown)&#10;... 5 times ...&#10;&#10;iex&#62; :gen_server.call(:stacker, :unknown)&#10;** (exit) &#123;:noproc,&#123;:gen_server,:call,[:stacker,:unknown]&#125;&#125;&#10;    gen_server.erl:180: :gen_server.call/2</span><br></pre></td></tr></table></figure>
<p>第六个消息不在产生错误报告，因为我们的服务器不在自动重启了。Elixir返回<code>:noproc</code>（<code>no process</code>的简写形式），意味着那里已经没有一个被称为<code>:stacker</code>的进程了。重启的次数和时间间隔，可以通过向函数<code>supervise</code>传递参数进行修改。除了上面例子中的<code>:one_for_one</code>， 监工也能选用不同的重启策略。如果向知道还有那些支持的策略，检查<code>Supervisor.Behaviour</code>的<a href="http://elixir-lang.org/docs/stable/Supervisor.Behaviour.html" target="_blank" rel="external">文档</a>。</p>
<h1 id="2-3_谁来监控监工？">2.3 谁来监控监工？</h1><p>我们已经编写了我们的监工，但有一个问题：谁来监控监工？为了回答这个问题，OTP有一个概念，应用（application）。应用可以被作为一个整体启动或关闭，当这些发生的时候，它们通常和一个监工相连。</p>
<p>在之前的章节中，我们已经看到了Mix如何用文件<code>mix.exs</code>中的<code>application</code>函数中包含的信息来自动地产生一个<code>.app</code>文件，每次编译我们的项目。</p>
<p>这个<code>.app</code>文件被称为应用规格，它必须包含我们的应用的依赖，它定义的模块，注册名和其他的许多。其中的一些信息由Mix来自动完成，但另外的一些数据需要手动添加。</p>
<p>在我们的例子里面，我们的应用有一个监工，而且它用名字<code>:stacker</code>注册了监工。也就是说，为了避免冲突，我们需要在应用规格里加入所有的注册名。如果两个应用注册了同一个名字，我们能更快地找到冲突。所以，让我们打开文件<code>`，用下面的内容编辑</code>application`函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def application do&#10;  [ registered: [:stacker],&#10;    mod: &#123; Stacker, [:hello] &#125; ]&#10;end</span><br></pre></td></tr></table></figure>
<p>在<code>:registered</code>键中我们指定了我们的应用注册的所有名字。而<code>:mod</code>键的用途是，一旦应用启动，它必须去调用应用模块回调函数（appliation module callback）。在我们的例子里面，应用模块回调函数是<code>Stack</code>模块，而且它将会接受到默认的参数，堆栈<code>[:hello]</code>。这个回调函数必须返回同应用相关的监工的<code>pid</code>。</p>
<p>有了这些在心里，让我们打开文件<code>lib/stacker.ex</code>，添加以下的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Stacker do&#10;  use Application.Behaviour&#10;&#10;  def start(_type, stack) do&#10;    Stacker.Supervisor.start_link(stack)&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p><code>Application.Behaviour</code>期待两个回调，<code>start(type, args)</code>和<code>stop(state)</code>。我们需要来实现<code>start(type, args)</code>， 而<code>stop(state)</code>可以先放在一边不管。</p>
<p>在添加了上面的应用行为之后，你只需要在一次启动<code>iex -S mix</code>。我们的文件将被再一次重编译，监工（包括我们的服务器）会自动启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :gen_server.call(:stacker, :pop)&#10;:hello</span><br></pre></td></tr></table></figure>
<p>太棒了，它能性！也许你已经注意到了，应用回调函数<code>start/2</code>接受了一个类型参数，虽然我们忽略了它。这个类型控制当我们的监工，自然也包括应用，崩溃的时候，虚拟机应该如何应对。你可以通过阅读<code>Application.Behaviour</code>的<a href="http://elixir-lang.org/docs/stable/Application.Behaviour.html" target="_blank" rel="external">文档</a>学到更多。</p>
<p>最后，注意<code>mix new</code>支持一个<code>--sup</code>选项，它告诉Mix产生一个包含应用模块回调的监工，自动地完成了一些上面的工作。你一定要试试！</p>
<h1 id="2-4_启动应用">2.4 启动应用</h1><p>在任何时候，我们都不必自己去启动我们定义的应用。那是因为默认下Mix会启动所有的应用，包括所依赖的应用。我们能通过调用OTP提供的<a href="http://www.erlang.org/doc/man/application.html" target="_blank" rel="external"><code>:application</code>模块</a>中的函数来手动地启动应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :application.start(:stacker)&#10;&#123; :error, &#123; :already_started, :stacker &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>在上面的例子中，因为应用已经事先启动了，它返回了一个错误信息。</p>
<p>Mix不仅启动你的应用，而且包括所有的你的应用的依赖。请注意你的项目的依赖（我们在前面几章中讨论过的，定义在键<code>deps</code>里的）和应用依赖是不同的。</p>
<p>项目依赖也许会包含你的测试框架或者一个编译时的依赖。应用依赖是运行时你的应用依赖的一切。一个应用依赖需要明确地被加入<code>appliation</code>函数里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def application do&#10;  [ registered: [:stacker],&#10;    applications: [:some_dep],&#10;    mod: &#123; Stacker, [:hello] &#125; ]&#10;end</span><br></pre></td></tr></table></figure>
<p>当在Mix里运行任务，它将确保应用以及应用的依赖都会被启动。</p>
<h1 id="2-5_配置应用">2.5 配置应用</h1><p>除了我们已经看到的键<code>:registered</code>，<code>:applications</code>和<code>:mod</code>，应用也支持被读取和设置的配置数值。</p>
<p>在命令行里，尝试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :application.get_env(:stacker, :foo)&#10;:undefined&#10;iex&#62; :application.set_env(:stacker, :foo, :bar)&#10;:ok&#10;iex&#62; :application.get_env(:stacker, :foo)&#10;&#123; :ok, :bar &#125;</span><br></pre></td></tr></table></figure>
<p>这个机制非常有用，它无需创建一整个监工链就能为你的应用提供配置数值。应用的默认的配置数值可以通过如下的方式在文件<code>mix.exs</code>中定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def application do&#10;  [ registered: [:stacker],&#10;    mod: &#123; Stacker, [:hello] &#125;,&#10;    env: [foo: :bar] ]&#10;end</span><br></pre></td></tr></table></figure>
<p>现在，从控制台里退出，然后用<code>iex -S mix</code>重启它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :application.get_env(:stacker, :foo)&#10;&#123; :ok, :bar &#125;</span><br></pre></td></tr></table></figure>
<p>例如，IEx和ExUnit是两个Elixir包含的应用，它们的<code>mix.exs</code>文件就是使用了这样的配置，文件<a href="https://github.com/elixir-lang/elixir/blob/master/lib/iex/mix.exs" target="_blank" rel="external">IEx</a>和<a href="https://github.com/elixir-lang/elixir/blob/master/lib/ex_unit/mix.exs" target="_blank" rel="external">ExUnit</a>。这样的应用于是提供了提供了<a href="https://github.com/elixir-lang/elixir/blob/d2bfd10299dc0e2df573589f1d33565177d63a7d/lib/ex_unit/lib/ex_unit.ex#L125-L155" target="_blank" rel="external">对读写这些数值的封装</a>。</p>
<p>到这里，我们结束了这一章。我们已经学习了如何创建服务器，监控它们，把它们和我们的应用整合和提供简单的配置选项。在下一章，我们将学习如何创建一个Mix中的定制任务。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T08:34:35.000Z"><a href="/2014/11/04/elixir-create-custom-mix-tasks/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-create-custom-mix-tasks/">创建自定义Mix任务(译)</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#常见API"><span class="toc-number">1.</span> <span class="toc-text">常见API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespaced_Tasks"><span class="toc-number">2.</span> <span class="toc-text">Namespaced Tasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选项解析"><span class="toc-number">3.</span> <span class="toc-text">选项解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分享任务"><span class="toc-number">4.</span> <span class="toc-text">分享任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作为依赖"><span class="toc-number">4.1.</span> <span class="toc-text">作为依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#把任务打包"><span class="toc-number">4.2.</span> <span class="toc-text">把任务打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIX_PATH"><span class="toc-number">4.3.</span> <span class="toc-text">MIX_PATH</span></a></li></ol></li></ol>
        </div>
        


        <p>原文: <a href="http://elixir-lang.readthedocs.org/en/latest/mix/3/" target="_blank" rel="external">http://elixir-lang.readthedocs.org/en/latest/mix/3/</a></p>
<p>在Mix中,一个任务实际上是一个具有名称空间<code>Mix.Tasks</code>并实现了<code>run/1</code>函数的模块.例如,<code>compile</code>任务是一个名称为<code>Mix.Tasks.Compile</code>的模块.</p>
<p>创建一个简单的任务:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Mix.Tasks.Hello do&#10;    use Mix.Task&#10;    @shortdoc &#34;&#36825;&#26159;&#19968;&#20010;&#30701;&#25991;&#26723;, &#30475;&#34;&#10;    @moduledoc &#34;&#34;&#34;&#10;    &#19968;&#20010;&#27979;&#35797;&#20219;&#21153;&#10;    &#34;&#34;&#34;&#10;    def run(_) do&#10;        IO.puts &#34;&#20320;&#22909;,&#19990;&#30028;!&#34;&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
<p>保存文<code>hello.ex</code>, 并编译:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elixirc hello.ex&#10;$ mix hello&#10;&#20320;&#22909;,&#19990;&#30028;</span><br></pre></td></tr></table></figure>
<p>上述模块定义了一个名称为<code>hello</code>的任务. 函数<code>run/1</code>接受一个二进制字符串参数, 该参数是从命令行传递给此任务的.</p>
<p>当调用命令<code>mix hello</code>时, 该任务被执行, 并输出<code>你好,世界</code>. Mix使用其第一个参数(<code>hello</code>)查找任务模块并执行<code>run</code>函数.</p>
<p>为什么有一个<code>@moduledoc</code>和<code>@shortdoc</code>. 这两个文档标记是被<code>help</code>任务使用来显示任务的说明文档. <code>@shortdoc</code>用在执行<code>mix help</code>的时候显示任务的简短描述, <code>@moduledoc</code>用于执行<code>mix help hello</code>是显示<code>hello</code>任务的详细描述.</p>
<p>除了这两个文档标签外, 还有一个<code>@hidden</code>标签, 当其设置为<code>true</code>时,该任务不显示在<code>mix help</code>的输出中, 任何没有<code>@shortdoc</code>标签的任务也不会显示.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule ModuleName do&#10;    @hidden true&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="常见API">常见API</h2><p>当编写任务时, 需要访问一些常见的Mix功能, 如下:</p>
<ul>
<li><code>Mix.Project.config</code> 返回项目配置(<code>mix.exs</code>的<code>project</code>函数), 如果当前目录不存在<code>mix.exs</code>文件, 该函数返回一个空的配置. </li>
<li><code>Mix.Project.get!</code> 访问当前项目的模块, 需要访问项目中的特殊函数是非常有用. 如果项目未定义,将抛出异常.</li>
<li><code>Mix.shell</code> </li>
<li><code>Mix.Task.run(task,args)</code> 从其他Mix任务中调用另一个任务; 如果该任务已经被调用, 不做任何操作.</li>
</ul>
<h2 id="Namespaced_Tasks">Namespaced Tasks</h2><p>简单的任务可用于完成复杂的事情. 任务实际上也是Elixir代码,任何Elixir可以做的事情都可以放到任务中去做. 可以像分发其他库一样分发任务, 让任务可以在其他项目中重用.</p>
<p>要在多个项目中重用任务, 为了避免名称冲突, Mix任务支持名称空间.</p>
<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Mix.Tasks.Mytasks do&#10;    @shortdoc &#34;&#20219;&#21153;&#38598;&#21512;&#27169;&#22359;&#34;&#10;    @moduledoc &#34;&#34;&#34;&#10;    &#29992;&#20110;&#26500;&#24314;&#21644;&#37096;&#32626;&#30340;&#20219;&#21153;&#38598;&#21512;&#10;    &#34;&#34;&#34;&#10;    defmodule Build do&#10;        use Mix.Task&#10;        @shortdoc &#34;&#26500;&#24314;&#20219;&#21153;&#34;&#10;        @moduledoc &#34;&#34;&#34;&#10;        &#26500;&#24314;&#19968;&#20010;&#36719;&#20214;&#32452;&#20214;&#27169;&#22359;&#10;        &#34;&#34;&#34;&#10;        def run(_) do&#10;            IO.puts &#34;&#36816;&#34892;&#23376;&#20219;&#21153;Build&#34;&#10;        end&#10;    end&#10;    defmodule Deploy do&#10;        use Mix.Task&#10;&#10;        @shortdoc &#34;&#37096;&#32626;&#19968;&#20010;&#36719;&#20214;&#32452;&#20214;&#34;&#10;        @moduledoc &#34;&#34;&#34;&#10;        &#25226;&#19968;&#20010;&#36719;&#20214;&#32452;&#20214;&#37096;&#32626;&#21040;&#26381;&#21153;&#22120;&#10;        &#34;&#34;&#34;&#10;        def run(_) do&#10;            IO.puts &#34;&#36816;&#34892;&#23376;&#20219;&#21153;Deploy&#34;&#10;        end&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
<p>任务模块写好了后, 可以像这样调用任务: <code>mix mytasks.build</code>, <code>mix mytasks.deploy</code>, 这功能很酷对吧?</p>
<p><img src="/assets/images/BAE289A3-2D50-430A-B85A-1BC3C55896F9.png" alt="任务帮助"></p>
<h2 id="选项解析">选项解析</h2><pre><code><span class="name">OptionParser</span>.<span class="atom">parse</span>([<span class="string">"--debug"</span>])
#=&gt; { [<span class="atom">debug</span>: <span class="atom">true</span>], [] }

<span class="name">OptionParser</span>.<span class="atom">parse</span>([<span class="string">"--source"</span>, <span class="string">"lib"</span>])
#=&gt; { [<span class="atom">source</span>: <span class="string">"lib"</span>], [] }

<span class="name">OptionParser</span>.<span class="atom">parse</span>([<span class="string">"--source"</span>, <span class="string">"lib"</span>, <span class="string">"test/enum_test.exs"</span>, <span class="string">"--verbose"</span>])
#=&gt; { [<span class="atom">source</span>: <span class="string">"lib"</span>, <span class="atom">verbose</span>: <span class="atom">true</span>], [<span class="string">"test/enum_test.exs"</span>] }
</code></pre><h2 id="分享任务">分享任务</h2><p>创建了任务后,如果需要在团队内分享给其他人, 或在其他项目中重用, 这章描述了几种不同的分享法师</p>
<h3 id="作为依赖">作为依赖</h3><p>假设创建了一个<code>my_tasks</code>项目, 其提供了众多有用的功能, 把该项目添加为其他项目的依赖, 所有在<code>my_tasks</code>项目中的任务可以被其他引用了<code>my_tasks</code>的项目使用.</p>
<h3 id="把任务打包">把任务打包</h3><p>Mix允许你安装和卸载本地归档包. 要为当前项目生成一个归档包, 运行:</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/elixir/commandlinetools</span><span class="comment"># mix do archive.build</span>
<span class="constant">Generated</span> archive commandlinetools-<span class="number">0.0</span>.<span class="number">1</span>.ez <span class="keyword">with</span> <span class="constant">MIX_ENV</span>=dev
</code></pre><p><img src="/assets/images/71D4F33D-A3F1-4A14-A1A1-AFAE607AFFC2.png" alt="把任务打包"></p>
<p>打包的任务可以通过文件系统路径或URL安装:</p>
<pre><code>mix archive<span class="class">.install</span> http:<span class="comment">//localhost/commandlinetools-0.0.1.ez</span>
</code></pre><p><code>mix archive</code>命令的的详细说明可通过 <code>mix help archive</code> 查看</p>
<h3 id="MIX_PATH">MIX_PATH</h3><p>最有一个中方法是使用<code>MIX_PATH</code>. 设置了<code>MIX_PATH</code>环境变量之后, 所有在其中的任务对Mix都可用, 比如:</p>
<pre><code>$ <span class="preprocessor">export</span> MIX_PATH=<span class="string">"/elixir/ebin"</span>
</code></pre><p>这种方式可以单独维护需要在多个项目中使用的任务. </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-02T06:59:55.000Z"><a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/">2014-11-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/">使用Mix创建命令行工具</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="注意">注意</h2><p>网上的很多文档中的说明都使用了<code>mix escriptize</code>命令用于生成命令行工具, 在最新的Elixir版本中被改为<code>mix escript.build</code>, 请注意!</p>
<h2 id="用Mix创建一个项目骨架">用Mix创建一个项目骨架</h2><p><code>mix</code>是一个Elixir自身支持的项目管理工具, 支持的功能有:</p>
<ul>
<li>创建基本项目目录结构</li>
<li>管理依赖</li>
<li>编译</li>
<li>发布</li>
</ul>
<p>下面我们使用mix来创建一个命令行工具的项目目录</p>
<pre><code>mix <span class="keyword">new</span> commandlinetools
<span class="keyword">cd</span> commandlinetools
</code></pre><p>项目创建好以后, 编辑项目目录下的<code>mix.exs</code>项目描述文件, 在<code>project</code>函数内添加<code>escript</code>配置,并添加<code>escript</code>函数,如下:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">project</span></span> <span class="keyword">do</span>
  [<span class="symbol">app:</span> <span class="symbol">:commandlinetools</span>,
   <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,
   <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,
   <span class="symbol">deps:</span> deps,
   <span class="symbol">escript:</span> escript
   ]
<span class="keyword">end</span>
<span class="function"><span class="keyword">def</span> <span class="title">escript</span></span> <span class="keyword">do</span>
  [<span class="symbol">main_module:</span> <span class="constant">Commandlinetools]</span>
<span class="keyword">end</span>
</code></pre><p><code>main_module</code> 选项指定了命令行工具的入口模块, 该模块必须实现一个<code>main/1</code>函数, 打开<code>lib/commandlinetools.ex</code>, 实现<code>main/1</code>函数</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">Commandlinetools</span></span> <span class="keyword">do</span>
    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args) <span class="keyword">do</span>
        <span class="constant">IO.</span>puts(<span class="string">"命令行工具main函数实现"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>编译,生成可执行程序</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/ejabberd/elixir/commandlinetools</span><span class="comment"># mix escript.build</span>
<span class="class"><span class="keyword">lib</span>/<span class="title">commandlinetools</span>.<span class="title">ex</span>:2: <span class="title">warning</span>: <span class="title">variable</span> <span class="title">args</span> <span class="title">is</span> <span class="title">unused</span></span>
<span class="constant">Compiled</span> <span class="class"><span class="keyword">lib</span>/<span class="title">commandlinetools</span>.<span class="title">ex</span></span>
<span class="constant">Generated</span> commandlinetools.app
<span class="constant">Consolidated</span> <span class="constant">List</span>.<span class="constant">Chars</span>
<span class="constant">Consolidated</span> <span class="constant">Range</span>.<span class="constant">Iterator</span>
<span class="constant">Consolidated</span> <span class="constant">String</span>.<span class="constant">Chars</span>
<span class="constant">Consolidated</span> <span class="constant">Enumerable</span>
<span class="constant">Consolidated</span> <span class="constant">Access</span>
<span class="constant">Consolidated</span> <span class="constant">Inspect</span>
<span class="constant">Consolidated</span> <span class="constant">Collectable</span>
<span class="constant">Consolidated</span> protocols written to _build/dev/consolidated
<span class="constant">Generated</span> escript commandlinetools <span class="keyword">with</span> <span class="constant">MIX_ENV</span>=dev
</code></pre><p>运行</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/ejabberd/elixir/commandlinetools</span><span class="comment"># ./commandlinetools</span>
命令行工具main函数实现
</code></pre>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/3/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/5/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/11/02/elixir-failover-and-takeover/">故障转移和接管</a>
      </li>
    
      <li>
        <a href="/2015/09/17/ejabberd-with-elixir-mix/">用Elixir Mix构建Ejabberd发行包</a>
      </li>
    
      <li>
        <a href="/2015/06/05/uftp/">UFTP - 基于UDP的加密文件多播传输协议</a>
      </li>
    
      <li>
        <a href="/2015/06/04/html5-web-cryptography-api-hashing/">Web加密API - 散列(Hashing)</a>
      </li>
    
      <li>
        <a href="/2015/06/04/the-3-modes-of-http-protocol/">HTTP协议的三种模式</a>
      </li>
    
      <li>
        <a href="/2015/05/21/ejabberd-with-elixir-packet-filters/">Ejabberd 用Elixir开发一个包过滤模块</a>
      </li>
    
      <li>
        <a href="/2015/05/18/chrome-dev-get-started/">Chrome 开发入门</a>
      </li>
    
      <li>
        <a href="/2015/05/18/html5-web-cryptography-api-tutorial/">Web加密API指南</a>
      </li>
    
      <li>
        <a href="/2015/05/17/html5-battery-status/">HTML5获取电池状态</a>
      </li>
    
      <li>
        <a href="/2015/05/10/ejabberd-mam-module-how-to-use/">如何使用Ejabberd消息归档模块</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Chrome/">Chrome</a><small>1</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>36</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTML5/">HTML5</a><small>3</small></li>
  
    <li><a href="/categories/HTTP/">HTTP</a><small>1</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>4</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Thrift/">Thrift</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>7</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/API/" style="font-size: 11.11px;">API</a> <a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a> <a href="/tags/Battery-Status/" style="font-size: 10px;">Battery Status</a> <a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a> <a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a> <a href="/tags/CURL/" style="font-size: 10px;">CURL</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a> <a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a> <a href="/tags/ETS/" style="font-size: 10px;">ETS</a> <a href="/tags/Ecto/" style="font-size: 11.11px;">Ecto</a> <a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a> <a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a> <a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a> <a href="/tags/H2O/" style="font-size: 10px;">H2O</a> <a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a> <a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a> <a href="/tags/Howto/" style="font-size: 10px;">Howto</a> <a href="/tags/Http-modes/" style="font-size: 10px;">Http modes</a> <a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a> <a href="/tags/I18n/" style="font-size: 10px;">I18n</a> <a href="/tags/IAB/" style="font-size: 10px;">IAB</a> <a href="/tags/ID3/" style="font-size: 10px;">ID3</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/IOT/" style="font-size: 10px;">IOT</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/Loopback/" style="font-size: 12.22px;">Loopback</a> <a href="/tags/MUC/" style="font-size: 10px;">MUC</a> <a href="/tags/Macro/" style="font-size: 12.22px;">Macro</a> <a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a> <a href="/tags/Mix/" style="font-size: 14.44px;">Mix</a> <a href="/tags/Modules/" style="font-size: 10px;">Modules</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a> <a href="/tags/OTP/" style="font-size: 12.22px;">OTP</a> <a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/PM2/" style="font-size: 10px;">PM2</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Phoenix/" style="font-size: 12.22px;">Phoenix</a> <a href="/tags/Pool/" style="font-size: 10px;">Pool</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/RESTFUL/" style="font-size: 11.11px;">RESTFUL</a> <a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a> <a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a> <a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a> <a href="/tags/Regex/" style="font-size: 10px;">Regex</a> <a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a> <a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a> <a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a> <a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a> <a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a> <a href="/tags/Task/" style="font-size: 10px;">Task</a> <a href="/tags/Thrift/" style="font-size: 11.11px;">Thrift</a> <a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a> <a href="/tags/UBF/" style="font-size: 10px;">UBF</a> <a href="/tags/UFTP/" style="font-size: 10px;">UFTP</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a> <a href="/tags/VAST/" style="font-size: 10px;">VAST</a> <a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a> <a href="/tags/Web-Cryptography-API/" style="font-size: 11.11px;">Web Cryptography API</a> <a href="/tags/XEP/" style="font-size: 16.67px;">XEP</a> <a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XMPP/" style="font-size: 17.78px;">XMPP</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/angular/" style="font-size: 16.67px;">angular</a> <a href="/tags/application/" style="font-size: 10px;">application</a> <a href="/tags/blockies/" style="font-size: 10px;">blockies</a> <a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a> <a href="/tags/bosh/" style="font-size: 12.22px;">bosh</a> <a href="/tags/ci/" style="font-size: 10px;">ci</a> <a href="/tags/container/" style="font-size: 11.11px;">container</a> <a href="/tags/data-management/" style="font-size: 10px;">data management</a> <a href="/tags/data-volume/" style="font-size: 10px;">data volume</a> <a href="/tags/debugging/" style="font-size: 10px;">debugging</a> <a href="/tags/devtools/" style="font-size: 10px;">devtools</a> <a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a> <a href="/tags/doc/" style="font-size: 10px;">doc</a> <a href="/tags/docker/" style="font-size: 15.56px;">docker</a> <a href="/tags/ejabberd/" style="font-size: 18.89px;">ejabberd</a> <a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a> <a href="/tags/emysql/" style="font-size: 11.11px;">emysql</a> <a href="/tags/encoding/" style="font-size: 10px;">encoding</a> <a href="/tags/erlang/" style="font-size: 12.22px;">erlang</a> <a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a> <a href="/tags/faq/" style="font-size: 10px;">faq</a> <a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a> <a href="/tags/gerrit/" style="font-size: 11.11px;">gerrit</a> <a href="/tags/gettext/" style="font-size: 10px;">gettext</a> <a href="/tags/git/" style="font-size: 12.22px;">git</a> <a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hero/" style="font-size: 10px;">hero</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/html5/" style="font-size: 10px;">html5</a> <a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a> <a href="/tags/iq/" style="font-size: 10px;">iq</a> <a href="/tags/jabber/" style="font-size: 10px;">jabber</a> <a href="/tags/javascript/" style="font-size: 11.11px;">javascript</a> <a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a> <a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a> <a href="/tags/library/" style="font-size: 10px;">library</a> <a href="/tags/linking/" style="font-size: 10px;">linking</a> <a href="/tags/lists/" style="font-size: 10px;">lists</a> <a href="/tags/load-balance/" style="font-size: 10px;">load balance</a> <a href="/tags/log4er/" style="font-size: 10px;">log4er</a> <a href="/tags/manage-images/" style="font-size: 10px;">manage images</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/muc/" style="font-size: 10px;">muc</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a> <a href="/tags/node-webkit/" style="font-size: 13.33px;">node-webkit</a> <a href="/tags/node-js/" style="font-size: 12.22px;">node.js</a> <a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a> <a href="/tags/notification/" style="font-size: 10px;">notification</a> <a href="/tags/npm/" style="font-size: 11.11px;">npm</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a> <a href="/tags/polymer/" style="font-size: 10px;">polymer</a> <a href="/tags/port/" style="font-size: 10px;">port</a> <a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a> <a href="/tags/rebar/" style="font-size: 10px;">rebar</a> <a href="/tags/record/" style="font-size: 10px;">record</a> <a href="/tags/recursion/" style="font-size: 10px;">recursion</a> <a href="/tags/regexp/" style="font-size: 10px;">regexp</a> <a href="/tags/relx/" style="font-size: 10px;">relx</a> <a href="/tags/screen/" style="font-size: 10px;">screen</a> <a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/stanza/" style="font-size: 10px;">stanza</a> <a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a> <a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a> <a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a> <a href="/tags/swagger/" style="font-size: 12.22px;">swagger</a> <a href="/tags/testing/" style="font-size: 10px;">testing</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/tsung/" style="font-size: 10px;">tsung</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a> <a href="/tags/varnish/" style="font-size: 10px;">varnish</a> <a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a> <a href="/tags/vt/" style="font-size: 10px;">vt</a> <a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a> <a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a> <a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a> <a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




