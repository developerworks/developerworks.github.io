
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 4 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-07T03:36:45.000Z"><a href="/2014/11/07/ejabberd-muc/">2014-11-07</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/07/ejabberd-muc/">Ejabberd 多人聊天协议分析-配置房间</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取配置信息"><span class="toc-number">2.</span> <span class="toc-text">获取配置信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置聊天室表单IQ-result"><span class="toc-number">3.</span> <span class="toc-text">配置聊天室表单IQ-result</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#提交房间配置表单_IQ-set"><span class="toc-number">4.</span> <span class="toc-text">提交房间配置表单 IQ-set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取服务器上的聊天室列表"><span class="toc-number">5.</span> <span class="toc-text">获取服务器上的聊天室列表</span></a></li></ol>
        </div>
        


        <h2 id="概述">概述</h2><p>MUC(Multiple User Chat), 即多人聊天, 多个用户可以在一个房间(群)里面相互交流. 一个成员发送的信息能够被所有群中的成员看到. XMPP的MUC和QQ群在功能上很多都是相似的. 可以对比两者的区别来学习和理解XMPP的多人聊天扩展.</p>
<p>群里面又各种角色, 不同的角色拥有不同的权限, 例如:</p>
<ul>
<li>群的创建者具有所有权限</li>
<li>群成员只能聊天</li>
<li>管理员可以踢人, 邀请等管理任务.</li>
</ul>
<h2 id="获取配置信息">获取配置信息</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="class"><span class="keyword">type</span>=</span><span class="symbol">'ge</span>t' xml:lang=<span class="symbol">'z</span>h' to=<span class="symbol">'xmpp</span><span class="annotation">@conference</span>.xmpp.hezhiqiang.info' xmlns=<span class="symbol">'jabber</span>:client'&gt;</span><br><span class="line">  &lt;query xmlns=<span class="symbol">'http</span>:<span class="comment">//jabber.org/protocol/muc#owner'/&gt;</span></span><br><span class="line">&lt;/iq&gt;</span><br></pre></td></tr></table></figure>
<h2 id="配置聊天室表单IQ-result">配置聊天室表单IQ-result</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">from</span>=<span class="value">"xmpp@conference.xmpp.hezhiqiang.info"</span></span><br><span class="line">    <span class="attribute">to</span>=<span class="value">"root@xmpp.hezhiqiang.info/37262574821415332900124309"</span></span><br><span class="line">    <span class="attribute">type</span>=<span class="value">"result"</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">"jabber:client"</span></span><br><span class="line">    <span class="attribute">xmlns:stream</span>=<span class="value">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">query</span> <span class="attribute">xmlns</span>=<span class="value">"http://jabber.org/protocol/muc#owner"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">instructions</span>&gt;</span>您需要一个兼容 x:data 的客户端来配置房间<span class="tag">&lt;/<span class="title">instructions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">x</span> <span class="attribute">xmlns</span>=<span class="value">"jabber:x:data"</span> <span class="attribute">type</span>=<span class="value">"form"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">title</span>&gt;</span>房间 xmpp@conference.xmpp.hezhiqiang.info 的配置 <span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"hidden"</span> <span class="attribute">var</span>=<span class="value">"FORM_TYPE"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>http://jabber.org/protocol/muc#roomconfig<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"text-single"</span> <span class="attribute">label</span>=<span class="value">"房间标题"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_roomname"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>群标题<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"text-single"</span> <span class="attribute">label</span>=<span class="value">"房间描述"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_roomdesc"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>群描述<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"永久保存该房间"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_persistentroom"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"使房间可被公开搜索"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_publicroom"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"公开参与人列表"</span> <span class="attribute">var</span>=<span class="value">"public_list"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"进入此房间需要密码"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_passwordprotectedroom"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"text-private"</span> <span class="attribute">label</span>=<span class="value">"密码"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_roomsecret"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"list-single"</span> <span class="attribute">label</span>=<span class="value">"允许的与会人最大数"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_maxusers"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>200<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"5"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>5<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"10"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>10<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"20"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>20<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"30"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>30<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"50"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>50<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"100"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>100<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"200"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>200<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"list-single"</span> <span class="attribute">label</span>=<span class="value">"将真实 Jabber ID 显示给"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_whois"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>moderators<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"仅主持人"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>moderators<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"任何人"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>anyone<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"设置房间只接收会员"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_membersonly"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"设置房间只接收主持人"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_moderatedroom"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"用户默认被视为参与人"</span> <span class="attribute">var</span>=<span class="value">"members_by_default"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许用户更改主题"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_changesubject"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许用户发送私聊消息"</span> <span class="attribute">var</span>=<span class="value">"allow_private_messages"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"list-single"</span> <span class="attribute">label</span>=<span class="value">"允许访客发送私聊消息至"</span> <span class="attribute">var</span>=<span class="value">"allow_private_messages_from_visitors"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>anyone<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"没有人"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>nobody<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"仅主持人"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>moderators<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">option</span> <span class="attribute">label</span>=<span class="value">"任何人"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">value</span>&gt;</span>anyone<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许用户查询其它用户"</span> <span class="attribute">var</span>=<span class="value">"allow_query_users"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许用户发送邀请"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_allowinvites"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span></span><br><span class="line">        <span class="attribute">label</span>=<span class="value">"更新在线状态时允许用户发送状态文本"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_allowvisitorstatus"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许用户更改昵称"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_allowvisitornickchange"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"允许访客发送声音请求"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_allowvoicerequests"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"text-single"</span></span><br><span class="line">        <span class="attribute">label</span>=<span class="value">"声音请求的最小间隔(以秒为单位)"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_voicerequestmininterval"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>1800<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 验证码白名单: 该名单中的Jid可以绕过验证码验证--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"jid-multi"</span></span><br><span class="line">        <span class="attribute">label</span>=<span class="value">"从验证码挑战中排除 Jabber ID"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_captcha_whitelist"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">field</span> <span class="attribute">type</span>=<span class="value">"boolean"</span> <span class="attribute">label</span>=<span class="value">"启用服务器端聊天记录"</span> <span class="attribute">var</span>=<span class="value">"muc#roomconfig_enablelogging"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">x</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">query</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="提交房间配置表单_IQ-set">提交房间配置表单 IQ-set</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 提交房间配置表单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'set'</span> <span class="attribute">id</span>=<span class="value">'purple6b0f6f1d'</span> <span class="attribute">to</span>=<span class="value">'xmpp@conference.xmpp.hezhiqiang.info'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">query</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/muc#owner'</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">x</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:x:data'</span> <span class="attribute">type</span>=<span class="value">'submit'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'FORM_TYPE'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>http://jabber.org/protocol/muc#roomconfig<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_roomname'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>群标题<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_roomdesc'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>群描述<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_persistentroom'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_publicroom'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'public_list'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_passwordprotectedroom'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_roomsecret'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_maxusers'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>200<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_whois'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>moderators<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_membersonly'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_moderatedroom'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'members_by_default'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_changesubject'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 允许私有消息--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'allow_private_messages'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'allow_private_messages_from_visitors'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>anyone<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 允许查询用户 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'allow_query_users'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否允许邀请 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_allowinvites'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_allowvisitorstatus'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_allowvisitornickchange'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_allowvoicerequests'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_voicerequestmininterval'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>1800<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_captcha_whitelist'</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">field</span> <span class="attribute">var</span>=<span class="value">'muc#roomconfig_enablelogging'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>0<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">x</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">query</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="获取服务器上的聊天室列表">获取服务器上的聊天室列表</h2><p>IQ-get</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'get'</span> <span class="attribute">to</span>=<span class="value">'conference.xmpp.hezhiqiang.info'</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">query</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/disco#items'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>IQ-result</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="variable">from=</span><span class="string">"conference.xmpp.hezhiqiang.info"</span></span><br><span class="line">    <span class="variable">to=</span><span class="string">"root@xmpp.hezhiqiang.info/36782688381415333849585695"</span></span><br><span class="line">    <span class="variable">type=</span><span class="string">"result"</span></span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>&gt;</span><br><span class="line">  &lt;query <span class="variable">xmlns=</span><span class="string">"http://jabber.org/protocol/disco#items"</span>&gt;</span><br><span class="line">    &lt;item <span class="variable">jid=</span><span class="string">"test@conference.xmpp.hezhiqiang.info"</span> <span class="variable">name=</span><span class="string">"聊天室标题 (0)"</span>/&gt;</span><br><span class="line">    &lt;item <span class="variable">jid=</span><span class="string">"xmpp@conference.xmpp.hezhiqiang.info"</span> <span class="variable">name=</span><span class="string">"群标题 (0)"</span>/&gt;</span><br><span class="line">  &lt;/query&gt;</span><br><span class="line">&lt;/iq&gt;</span><br></pre></td></tr></table></figure>
<p>TODO::需要扩展支持分页显示</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T08:39:53.000Z"><a href="/2014/11/05/elixir-iot-1/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-iot-1/">译文 | Elixir 物联网-1</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">IoT</span> </span><span class="keyword">do</span></span><br><span class="line">    defp do_listen(list_socket) <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 接受连接</span></span><br><span class="line">        &#123;<span class="symbol">:ok</span>, socket&#125; = <span class="symbol">:ssl</span>.transport_accept(listen_socket)</span><br><span class="line">        <span class="symbol">:ok</span> = <span class="symbol">:ssl</span>.accept_socket(socket)</span><br><span class="line">        endpoint = <span class="constant">TcpSupervisor.</span>start_endpoint(socket)</span><br><span class="line">        <span class="symbol">:ssl</span>.controlling_process(socket,endpoint)</span><br><span class="line">        <span class="comment"># 异步处理</span></span><br><span class="line">        <span class="symbol">:gen_server</span>.cast(endpoint, &#123;<span class="symbol">:start</span>&#125;)</span><br><span class="line">        <span class="comment"># 重新进入Accept</span></span><br><span class="line">        do_listen(listen_socket)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>多个Acceptor处理每秒1000连接:</p>
<p>Tcp监听器Supervisor</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Owsla</span>.<span class="constant">TcpListenerSupervisor </span></span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> <span class="constant">Supervisor.Behaviour</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_link</span>(port, acceptor_count, backlog) </span><span class="keyword">do</span></span><br><span class="line">        <span class="symbol">:supervisor</span>.start_link(&#123; <span class="symbol">:local</span>, <span class="symbol">:listener_sup</span>&#125;, <span class="constant">__MODULE__,</span> [port, acceptor_count, backlog])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span>([port, acceptor_count, backlog]) </span><span class="keyword">do</span></span><br><span class="line">        <span class="symbol">:ssl</span>.start()</span><br><span class="line">        &#123;<span class="symbol">:ok</span>, listen_socket&#125; = create_listen_socket(port, backlog)</span><br><span class="line">        spawn(<span class="keyword">fn</span> -&gt;</span><br><span class="line">            <span class="constant">Enum.</span>each(<span class="number">1</span>..acceptor_count,</span><br><span class="line">                <span class="keyword">fn</span> (<span class="constant">_)</span> -&gt; start_listener() <span class="keyword">end</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">end</span>)</span><br><span class="line">            tree = [ worker(<span class="constant">Owsla.TcpAcceptor,</span> [listen_socket], <span class="symbol">restart:</span> <span class="symbol">:permanent</span>) ]</span><br><span class="line">            supervise(tree, <span class="symbol">strategy:</span> <span class="symbol">:simple_one_for_one</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_listen_socket</span>(port, backlog) </span><span class="keyword">do</span></span><br><span class="line">         tcp_options = [</span><br><span class="line">            <span class="symbol">:binary</span>,</span><br><span class="line">            &#123;<span class="symbol">:packet</span>, <span class="symbol">:line</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:reuseaddr</span>, <span class="keyword">true</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:active</span>, <span class="keyword">false</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:backlog</span>, backlog&#125;</span><br><span class="line">            ]</span><br><span class="line">        <span class="symbol">:gen_tcp</span>.listen(port, tcp_options)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_listener</span>() </span><span class="keyword">do</span></span><br><span class="line">        <span class="symbol">:supervisor</span>.start_child(<span class="symbol">:listener_sup</span>, [])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Owsla</span>.<span class="constant">TcpAcceptor </span></span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> <span class="constant">GenServer.Behaviour</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">@ssl_options</span></span><br><span class="line">        [&#123;<span class="symbol">:certfile</span>, <span class="string">"deviceserver.crt"</span>&#125;, &#123;<span class="symbol">:keyfile</span>, <span class="string">"deviceserver.key"</span>&#125;,</span><br><span class="line">        &#123;<span class="symbol">:ciphers</span>, [</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_dss</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_dss</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha256</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_dss</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:aes_256_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:<span class="string">'3des_ede_cbc'</span></span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_dss</span>,<span class="symbol">:<span class="string">'3des_ede_cbc'</span></span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:<span class="string">'3des_ede_cbc'</span></span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_dss</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:aes_128_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:rc4_128</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:rc4_128</span>,<span class="symbol">:md5</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:dhe_rsa</span>,<span class="symbol">:des_cbc</span>,<span class="symbol">:sha</span>&#125;,</span><br><span class="line">            &#123;<span class="symbol">:rsa</span>,<span class="symbol">:des_cbc</span>,<span class="symbol">:sha</span>&#125;</span><br><span class="line">        ]&#125;]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_link</span>(listen_socket) </span><span class="keyword">do</span></span><br><span class="line">        <span class="symbol">:gen_server</span>.start_link(<span class="constant">__MODULE__,</span> listen_socket, [])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span>(listen_socket) </span><span class="keyword">do</span></span><br><span class="line">        <span class="symbol">:gen_server</span>.cast <span class="keyword">self</span>, &#123;<span class="symbol">:listen</span>&#125;</span><br><span class="line">        &#123;<span class="symbol">:ok</span>, listen_socket&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_cast</span>( &#123;<span class="symbol">:listen</span>&#125;, listen_socket) </span><span class="keyword">do</span></span><br><span class="line">        do_listen(listen_socket)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    defp do_listen(listen_socket) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="symbol">:gen_tcp</span>.accept(listen_socket) <span class="keyword">do</span></span><br><span class="line">       &#123;<span class="symbol">:ok</span>, socket&#125; -&gt;</span><br><span class="line">                <span class="keyword">case</span> <span class="symbol">:ssl</span>.ssl_accept(socket, <span class="variable">@ssl_options</span>) <span class="keyword">do</span></span><br><span class="line">               &#123;<span class="symbol">:ok</span>, ssl_socket&#125; -&gt;</span><br><span class="line">                        endpoint = <span class="constant">Owsla.TcpSupervisor.</span>start_endpoint(ssl_socket)</span><br><span class="line">                        <span class="symbol">:ssl</span>.controlling_process(ssl_socket, endpoint)</span><br><span class="line">                        <span class="symbol">:gen_server</span>.cast endpoint, &#123;<span class="symbol">:start</span>&#125;</span><br><span class="line">                        do_listen(listen_socket)</span><br><span class="line">               &#123;<span class="symbol">:error</span>, <span class="symbol">:closed</span>&#125; -&gt;</span><br><span class="line">                        do_listen(listen_socket)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">       &#123;<span class="symbol">:error</span>, <span class="symbol">:closed</span>&#125; -&gt; do_listen(listen_socket)</span><br><span class="line">       &#123;<span class="symbol">:error</span>, <span class="constant">_&#125;</span> -&gt; &#123; <span class="symbol">:stop</span>, <span class="symbol">:error</span>, [] &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T05:47:41.000Z"><a href="/2014/11/05/elixir-i18n-linguist/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-i18n-linguist/">使用linguist处理国际化字符串</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>使用Mix创建一个项目:</p>
<pre><code><span class="comment"><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mix <span class="keyword">new</span> i18n_example</span><br><span class="line"><span class="keyword">cd</span> i18n_example</span><br></pre></td></tr></table></figure></span>
</code></pre><p>编辑<code>mix.exs</code>项目文件, 添加linguist依赖</p>
<pre><code><span class="comment"><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defp deps <span class="keyword">do</span></span><br><span class="line">    [&#123;<span class="symbol">:linguist</span>,  <span class="symbol">github:</span> <span class="string">"chrismccord/linguist"</span>&#125;]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></span>
</code></pre><p>获取依赖</p>
<pre><code><span class="comment"><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix deps.<span class="keyword">get</span></span><br></pre></td></tr></table></figure></span>
</code></pre><p>增加国际化字符串文件</p>
<pre><code><span class="comment"><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># locales/zh.exs</span></span><br><span class="line">[</span><br><span class="line">  flash: [</span><br><span class="line">    notice: [</span><br><span class="line">      hello: <span class="string">"你好 <span class="variable">%&#123;first&#125;</span> <span class="variable">%&#123;last&#125;</span>"</span></span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">]</span><br><span class="line"><span class="comment"># locales/fr.exs</span></span><br><span class="line">[</span><br><span class="line">  flash: [</span><br><span class="line">    notice: [</span><br><span class="line">      hello: <span class="string">"salut <span class="variable">%&#123;first&#125;</span> <span class="variable">%&#123;last&#125;</span>"</span></span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure></span>
</code></pre><p>实现模块</p>
<pre><code><span class="comment"><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">defmodule I18n <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> Linguist.Vocabulary</span><br><span class="line">    <span class="comment"># 默认英文, 注意,这里的locale是一个宏,而不是一个函数</span></span><br><span class="line">    locale <span class="string">"en"</span>, [</span><br><span class="line">        flash: [</span><br><span class="line">            notice: [</span><br><span class="line">                hello: <span class="string">"hello <span class="variable">%&#123;first&#125;</span> <span class="variable">%&#123;last&#125;</span>"</span>,</span><br><span class="line">                bye: <span class="string">"bye now, <span class="variable">%&#123;name&#125;</span>!"</span></span><br><span class="line">            ]</span><br><span class="line">        ],</span><br><span class="line">        users: [</span><br><span class="line">            title: <span class="string">"Users"</span>,</span><br><span class="line">            profiles: [</span><br><span class="line">                title: <span class="string">"Profiles"</span></span><br><span class="line">            ]</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># locale宏还可以直接读取文件</span></span><br><span class="line">    locale <span class="string">"fr"</span>, Path.<span class="keyword">join</span>([Path.dirname(__DIR_<span class="number">_</span>), <span class="string">"locales"</span>,<span class="string">"fr.exs"</span>])</span><br><span class="line">    locale <span class="string">"zh"</span>, Path.<span class="keyword">join</span>([Path.dirname(__DIR_<span class="number">_</span>), <span class="string">"locales"</span>,<span class="string">"zh.exs"</span>])</span><br><span class="line">end</span><br></pre></td></tr></table></figure></span>
</code></pre><p>测试</p>
<pre><code><span class="comment"><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iex -S mix</span><br><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">1</span>)</span></span>&gt; I18n.t!(<span class="string">"en"</span>, <span class="string">"flash.notice.hello"</span>, first: <span class="string">"chris"</span>, last: <span class="string">"mccord"</span>)</span><br><span class="line"><span class="string">"hello chris mccord"</span></span><br><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">2</span>)</span></span>&gt; I18n.t!(<span class="string">"zh"</span>, <span class="string">"flash.notice.hello"</span>, first: <span class="string">"chris"</span>, last: <span class="string">"mccord"</span>)</span><br><span class="line"><span class="string">"你好 chris mccord"</span></span><br></pre></td></tr></table></figure></span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-05T01:56:51.000Z"><a href="/2014/11/05/elixir-introduce-mix/">2014-11-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/05/elixir-introduce-mix/">简介</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bootstrapping"><span class="toc-number">1.</span> <span class="toc-text">Bootstrapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mix-exs"><span class="toc-number">1.1.</span> <span class="toc-text">mix.exs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lib/my_project-ex"><span class="toc-number">1.2.</span> <span class="toc-text">lib/my_project.ex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test/my_project_test-exs"><span class="toc-number">1.3.</span> <span class="toc-text">test/my_project_test.exs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test/test_helper-exs"><span class="toc-number">1.4.</span> <span class="toc-text">test/test_helper.exs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#探索"><span class="toc-number">2.</span> <span class="toc-text">探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">3.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#依赖"><span class="toc-number">4.</span> <span class="toc-text">依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源代码管理(scm)"><span class="toc-number">4.1.</span> <span class="toc-text">源代码管理(scm)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译依赖"><span class="toc-number">4.2.</span> <span class="toc-text">编译依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重复性"><span class="toc-number">4.3.</span> <span class="toc-text">重复性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖任务"><span class="toc-number">4.4.</span> <span class="toc-text">依赖任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖的依赖"><span class="toc-number">4.5.</span> <span class="toc-text">依赖的依赖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#伞形项目"><span class="toc-number">5.</span> <span class="toc-text">伞形项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-number">6.</span> <span class="toc-text">环境</span></a></li></ol>
        </div>
        


        <p>Elixir自带了几个应用使得编写和部署Elixir项目更加容易,其中Mix是关键.</p>
<p>Mix是一个提供了用于创建,编译,测试(很快就会有发布功能)的编译工具.Mix的灵感来自于Clojure的编译工具<a href="https://github.com/technomancy/leiningen" target="_blank" rel="external">Leiningen</a>,并且作者本人就是它的其中一个开发者.</p>
<p>在这一章,我们将学习如何用mix来创建项目,安装依赖.在之后的部分,我们将雪鞋如何创建OTP应用,和定制mix的任务.</p>
<h2 id="Bootstrapping">Bootstrapping</h2><p>要开始你的第一个项目,你只需要输入<code>mix new</code> 并把项目的路径作为参数.现在,我们将在当前目录创建一个被称为<code>my_project</code>的项目:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix <span class="built_in">new</span> my_project <span class="comment">--bare</span></span><br></pre></td></tr></table></figure>
<p>Mix将创建一个名为<code>my_project</code>的目录,包含一下这些内容:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.gitignore</span></span><br><span class="line">README<span class="class">.md</span></span><br><span class="line">mix<span class="class">.exs</span></span><br><span class="line">lib/my_project<span class="class">.ex</span></span><br><span class="line">test/test_helper<span class="class">.exs</span></span><br><span class="line">test/my_project_test.exs</span><br></pre></td></tr></table></figure>
<p>让我们来简单地看一下其中的一些.</p>
<ul>
<li><p>注意:Mix是一个Elixir的可执行文件.这意味着为了能够运行<code>mix</code>,elixir的可执行文件许需要在你的<code>PATH</code>里面.如果不是,你可以直接把脚本作为参数传递给elixir来执行:</p>
<p>  <code>$ bin/elixir bin/mix new ./my_project</code></p>
</li>
<li><p>注意你也能通过<code>-S</code>选项来让Elixir运行任何PATH里的脚本:</p>
<p>  <code>$ bin/elixir -S mix new ./my_project</code></p>
</li>
</ul>
<p>当用了<code>-S</code>, elixir会遍历PATH,寻找并运行那个脚本</p>
<h3 id="mix-exs">mix.exs</h3><p>这是包含了你项目配置的文件.它看起来是这样的:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">MyProject</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:my_project</span>,</span><br><span class="line">     <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Configuration for the OTP application</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">    []</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Returns the list of dependencies in the format:</span></span><br><span class="line">  <span class="comment"># &#123;:foobar, git: "https://github.com/elixir-lang/foobar.git", tag: "0.1"&#125;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># To specify particular versions, regardless of the tag, do:</span></span><br><span class="line">  <span class="comment"># &#123;:barbat, "~&gt; 0.1", github: "elixir-lang/barbat"&#125;</span></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    []</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们的<code>mix.exs</code>定义了两个函数:</p>
<p><code>project</code>, 用来返回项目的配置比如项目名称和版本,和<code>application</code>,用来产生一个被Erlang运行时管理的Erlang应用.在这一章,我们将谈一谈函数<code>project</code>.我们将在下一章详谈<code>application</code>函数.</p>
<h3 id="lib/my_project-ex">lib/my_project.ex</h3><p>这个文件包含了一个简单的模块,它定义了我们代码的基本结构:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">MyProject</span> </span><span class="keyword">do</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="test/my_project_test-exs">test/my_project_test.exs</h3><p>这个文件包含了项目的一个测试用例:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">MyProjectTest</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">ExUnit.Case</span></span><br><span class="line"></span><br><span class="line">  test <span class="string">"the truth"</span> <span class="keyword">do</span></span><br><span class="line">    assert <span class="keyword">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>有几点请注意:</p>
<ul>
<li>注意这个文件是一个Elixir的脚本文件(<code>.exs</code>).作为一个约定,我们不需要在运行之前编译测试.</li>
<li>我们定义了一个测试模块<code>MyProjectTest</code>,用<code>MyProjectTest</code>来注入默认的行为,并定义了一个简单测试.你可以在<a href="http://elixir-lang.readthedocs.org/getting_started/ex_unit/1.html" target="_blank" rel="external">ExUnit</a>那一章学习到有关测试框架的更多内容.</li>
</ul>
<h3 id="test/test_helper-exs">test/test_helper.exs</h3><p>我们将查看的最后一个文件是<code>test_helper.exs</code>,它的任务是启动测试框架:</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExUnit.<span class="built_in">start</span></span><br></pre></td></tr></table></figure>
<h2 id="探索">探索</h2><p>现在我们已经创建了新项目,接下去做什么？要了解还有其他什么命令可以使用的话,运行<code>help</code>任务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p>它将会打印出所有可用的任务,运行<code>mix help TASK</code>可获取更多的信息.</p>
<p>运行其中一些命令试试,比如<code>mix compile</code>和<code>mix test</code>,在你的项目里运行看看会发生什么.</p>
<h2 id="编译">编译</h2><p>Mix可以为我们编译项目.默认的设置是用<code>lib/</code>放源代码,<code>ebin/</code>放编译后的beam文件.你无需提供任何的编译相关的设置,但如果你决定这么做,有一些选项可以用.例如,如果你打算把你的编译后的beam文件放在<code>ebin</code>之外的文件夹里,只需要在<code>mix.exs</code>里设置<code>:compile_path</code>:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">  [<span class="symbol">compile_path:</span> <span class="string">"ebin"</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>总的来说,Mix会尽力表现的聪明一些,只在必须的时候编译.</p>
<p>注意在你第一次编译之后,Mix会在你的<code>ebin</code>文件夹里产生了一个<code>my_project.app</code>文件.这个文件里定义的Erlang应用是用到了你的项目中的<code>application</code>函数里的内容.</p>
<p>这个<code>.app</code>文件存储在和应用有关的信息,它的依赖,它所依赖的模块㩐等.每次你用mix运行命令的时候,这个应用会自动被启动,我们将在下一章学习如何配置它.</p>
<h2 id="依赖">依赖</h2><p>Mix也能用来管理依赖.依赖应被列在项目配置中,例如:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">  [<span class="symbol">app:</span> <span class="symbol">:my_project</span>,</span><br><span class="line">   <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">   <span class="symbol">deps:</span> deps]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">defp deps <span class="keyword">do</span></span><br><span class="line">  [&#123;<span class="symbol">:some_project</span>, <span class="string">"&gt;= 0.3.0"</span>&#125;,</span><br><span class="line">   &#123;<span class="symbol">:another_project</span>, <span class="symbol">git:</span> <span class="string">"https://example.com/another/repo.git"</span>, <span class="symbol">tag:</span> <span class="string">"v1.0.2"</span>&#125;]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>注意:</strong> 虽然并非必须,常见的做法是把依赖分散到它们自己的函数里.</p>
<p>某个依赖有一个原子来表示,跟着是一个需求和一些选项.在默认情况下,Mix使用<a href="https://hex.pm/" target="_blank" rel="external">hex.pm</a>来获取依赖,但它也能从git库或直接从文件系统来获取.</p>
<p>当我们使用Hex, 你必须在需求里指定所接受的依赖的版本.它支持一些基本的操作符,例如<code>&gt;=</code>,<code>&lt;=</code>,<code>&gt;</code>,<code>==</code>:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># Only version 2.0.0</span></span><br><span class="line"><span class="string">"== 2.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Anything later than 2.0.0</span></span><br><span class="line"><span class="string">"&gt; 2.0.0"</span></span><br></pre></td></tr></table></figure>
<p>需求也支持用<code>and</code>和<code>or</code>表达复杂的情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">2.0</span><span class="number">.0</span> <span class="keyword">and</span> later <span class="keyword">until</span> <span class="number">2.1</span><span class="number">.0</span></span><br><span class="line"><span class="string">"&gt;= 2.0.0 and &lt; 2.1.0"</span></span><br></pre></td></tr></table></figure>
<p>类似上面的例子非常地常见,所以它也能用简单的方式表达:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"~&gt; 2.0.0"</span></span><br></pre></td></tr></table></figure>
<p>注意为git库设置版本需求不会影响到取出的分支和标签,所以类似下面这样的定义是合法的:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123; <span class="attribute">:some_project</span>, <span class="string">"~&gt; 0.5.0"</span>, github: <span class="string">"some_project/other"</span>, tag: <span class="string">"0.3.0"</span> &#125;</span></span><br></pre></td></tr></table></figure>
<p>但它会导致一个依赖永远无法满足,因为被取出的标签总不能和需求的版本匹配.</p>
<h3 id="源代码管理(scm)">源代码管理(scm)</h3><p>Mix的设计就考虑到了支持多种的SCM工具,Hex包是默认,但<code>:git</code>和<code>:path</code>是可选项.常见的一些选项是:</p>
<ul>
<li><code>:git</code>        - 依赖是一个git版本库,Mix可以来获取和升级.</li>
<li><code>:path</code>       - 依赖是文件系统中的一个路径</li>
<li><code>:compile</code>    - 如何编译依赖</li>
<li><code>:app</code>        - 依赖所定义的应用的路径</li>
<li><code>:env</code>        - 依赖所用的环境(详情在后),默认是<code>:prod</code>;</li>
</ul>
<p>每个SCM可以支持自定义选项,比如<code>:git</code>,支持下面的选项:</p>
<ul>
<li><code>:ref</code>        - 用来检出git仓库的一个可选的引用(一次提交);</li>
<li><code>:tag</code>        - 用来检出git仓库的一个可选的tag</li>
<li><code>:branch</code>     - 用来检出git仓库的一个可选的分支</li>
<li><code>:submodules</code> - 当为<code>true</code>,在依赖中递归地初始化子模块;</li>
</ul>
<h3 id="编译依赖">编译依赖</h3><p>为了编译依赖,Mix会选择最适合的方式.依赖所包含的文件不同,编译的方式也不一样:</p>
<ul>
<li><code>mix.exs</code><ul>
<li>直接用Mix的<code>compile</code>任务编译依赖;</li>
</ul>
</li>
<li><code>rebar.config</code>或<code>rebar.config.script</code><ul>
<li>用<code>rebar compile deps_dir=DEPS</code>编译,<code>DEPS</code>是项目依赖的安装目录;</li>
</ul>
</li>
<li><code>Makefile</code><ul>
<li>简单地调用<code>make</code>;</li>
</ul>
</li>
</ul>
<p>如果编译的代码里没有包含以上的任何,你可以在``选项里直接指定一个命令:</p>
<pre><code><span class="collection">{<span class="attribute">:some_dep</span>, git: <span class="string">"..."</span>, compile: <span class="string">"./configure &amp;&amp; make"</span>}</span>
</code></pre><p>如果<code>:compile</code>被设为<code>false</code>, 不做任何事情.</p>
<h3 id="重复性">重复性</h3><p>任何一个依赖管理工具的重要特性是可重复性.因此当你初次获取依赖,Mix将创建一个文件``,用来包含每个依赖所取出的索引.</p>
<p>当另一个开发者得到这个项目的拷贝,Mix将取出相同的那个索引,保证其他的开发者能“重复”同样的设置.</p>
<p>运行<code>deps.update</code>能自动升级锁,用<code>deps.unlock</code>任务来移除锁.</p>
<h3 id="依赖任务">依赖任务</h3><p>Elixir自带了许多用来管理项目依赖的任务:</p>
<ul>
<li><code>mix deps</code> - 列出所有的依赖和它的情况;</li>
<li><code>mix deps.get</code> - 获取所有可得的依赖</li>
<li><code>mix deps.compile</code> - 编译依赖</li>
<li><code>mix deps.update</code> - 更新依赖;</li>
<li><code>mix deps.clean</code> - 删除依赖文件;</li>
<li><code>mix deps.unlock</code> - 解锁依赖</li>
</ul>
<p>用<code>mix help</code>来获取更多信息.</p>
<h3 id="依赖的依赖">依赖的依赖</h3><p>如果你的依赖是一个Mix或rebar的项目,Mix知道如何应付:它将自动获取和处理你的依赖的所有的依赖.然而,如果你的项目中有两个依赖共享了同一个依赖,但它们的SCM信息又无法互相匹配的话,Mix将标明这个依赖是分裂的,并发出警告.要解决而这个问题,你可以在你项目中声明选项<code>override: true</code>, Mix将根据这个信息来获取依赖.</p>
<h2 id="伞形项目">伞形项目</h2><p>你是否想过,如果能将几个Mix项目打包在一起,只需一个命令就可以运行各自的Mix任务, 该有多方便？.这种将项目打包在一起使用的情况被称为伞形项目.一个伞形项目可以用下面的命令来创建:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix <span class="keyword">new</span> <span class="keyword">project</span> --umbrella</span><br></pre></td></tr></table></figure>
<p>这将会创建一个包含以下内容的``文件:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Project</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">apps_path:</span> <span class="string">"apps"</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>apps_path</code>选项指定了子项目所在的文件夹.在伞形项目中运行的Mix任务,会对<code>apps_path</code>文件夹中的每一个子项目起作用.例如<code>mix compile</code>和<code>mix test</code>将编译或测试文件夹下的每一个项目.值得注意的是,伞形项目既不是一个普通的Mix项目,也不是一个OTP应用,也不能修改其中的源码.</p>
<p>如果在子项目之间有互相依赖的存在,需要指定它们的顺序,这样Mix才能正确编译.如果项目A依赖于项目B,这个依赖关系必须在项目A的<code>mix.exs</code>文件里指定.修改文件<code>mix.exs</code>来指定这个依赖:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">A</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:a</span>,</span><br><span class="line">     <span class="symbol">deps_path:</span> <span class="string">"../../deps"</span>,</span><br><span class="line">     <span class="symbol">lockfile:</span> <span class="string">"../../mix.lock"</span>,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    [&#123; <span class="symbol">:b</span>, <span class="symbol">in_umbrella:</span> <span class="keyword">true</span> &#125;]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>注意上面的子项目中<code>deps_path</code>和<code>lockfile</code>选项.如果在你的伞形项目的所有子项中都有它们,它们将共享依赖.apps文件夹中的<code>mix new</code>将自动用这些预设的选型创建一个项目.</p>
<h2 id="环境">环境</h2><p>Mix有环境的概念,能让一个开发者去基于一个外部的设定来定制编译和其他的选项.默认下,Mix能理解项目三类环境:</p>
<ul>
<li><code>dev</code> - mix任务的默认环境;</li>
<li><code>test</code> - 用于<code>mix test</code>;</li>
<li><code>prod</code> - 在这个环境下,依赖将被载入和编译;</li>
</ul>
<p>在默认情况下,这些环境的行为没有不同,我们之前看到的所有配置都将会影响到这三个环境.针对某个环境的定制,可以通过访问<code>Mix.env</code>来实现:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">  [<span class="symbol">deps_path:</span> deps_path(<span class="constant">Mix.</span>env)]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">defp deps_path(<span class="symbol">:prod</span>), <span class="symbol">do:</span> <span class="string">"prod_deps"</span></span><br><span class="line">defp deps_path(<span class="constant">_)</span>, <span class="symbol">do:</span> <span class="string">"deps"</span></span><br></pre></td></tr></table></figure>
<p>Mix默认为<code>dev</code>环境(除了测试).可以通过修改环境变量<code>MIX_ENV</code>来改变环境.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span><span class="constant">MIX_ENV=</span>prod mix compile</span><br></pre></td></tr></table></figure>
<p>在下一章,我们将学习如何用Mix编写OTP应用和如何创建你自己的任务.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T12:23:30.000Z"><a href="/2014/11/04/elixir-umbrella-project/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-umbrella-project/">伞形项目</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>关于伞形项目, 什么是伞形项目, 定义在<a href="https://github.com/elixir-lang-china/elixir_guide_cn/blob/master/mix/Chapter1.md#15-%E4%BC%9E%E5%BD%A2%E9%A1%B9%E7%9B%AE" target="_blank" rel="external">这里</a></p>
<p>创建一个伞形项目</p>
<pre><code><span class="comment"><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/ejabberd/elixir</span><span class="comment"># mix new umbrella_project --umbrella</span></span><br><span class="line">* creating .gitignore</span><br><span class="line">* creating <span class="constant">README</span>.md</span><br><span class="line">* creating mix.exs</span><br><span class="line">* creating apps</span><br><span class="line">* creating config</span><br><span class="line">* creating config/config.exs</span><br><span class="line"><span class="constant">Your</span> umbrella project was created successfully.</span><br><span class="line"><span class="constant">Inside</span> your project, you will find an apps/ directory</span><br><span class="line">where you can create <span class="keyword">and</span> host many <span class="symbol">apps:</span></span><br><span class="line">    cd umbrella_project</span><br><span class="line">    cd apps</span><br><span class="line">    mix new my_app</span><br><span class="line"><span class="constant">Commands</span> like <span class="string">`mix compile`</span> <span class="keyword">and</span> <span class="string">`mix test`</span> <span class="keyword">when</span> executed</span><br><span class="line"><span class="keyword">in</span> the umbrella project root will automatically run</span><br><span class="line"><span class="keyword">for</span> each application <span class="keyword">in</span> the apps/ directory.</span><br></pre></td></tr></table></figure></span>
</code></pre><blockquote>
<p>在伞形项目中运行的Mix任务,会对文件夹中的每一个子项目起作用.</p>
</blockquote>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T12:17:48.000Z"><a href="/2014/11/04/elixir-building-otp-apps-with-mix/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-building-otp-apps-with-mix/">Elixir 使用Mix构建OTP应用(译)</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2_用Mix编写OPT应用"><span class="toc-number">1.</span> <span class="toc-text">2 用Mix编写OPT应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1_Stacker服务器"><span class="toc-number">2.</span> <span class="toc-text">2.1 Stacker服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1-1_深入学习回调函数"><span class="toc-number">3.</span> <span class="toc-text">2.1.1 深入学习回调函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-1-2_干掉一个服务器"><span class="toc-number">4.</span> <span class="toc-text">2.1.2 干掉一个服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-2_监控服务器"><span class="toc-number">5.</span> <span class="toc-text">2.2 监控服务器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-3_谁来监控监工？"><span class="toc-number">6.</span> <span class="toc-text">2.3 谁来监控监工？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-4_启动应用"><span class="toc-number">7.</span> <span class="toc-text">2.4 启动应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-5_配置应用"><span class="toc-number">8.</span> <span class="toc-text">2.5 配置应用</span></a></li></ol>
        </div>
        


        <h1 id="2_用Mix编写OPT应用">2 用Mix编写OPT应用</h1><p>在Elixir里，我们如何保存状态？</p>
<p>我们的软件需要在运行时系统里保存状态，配置，数据。在之前的<a href="http://elixir-lang.org/getting_started/2.html#receive" target="_blank" rel="external">章节</a>里我们已学会了如何用进程/Actor保持状态，在一个循环中如何接受以及回复消息，但这种方式似乎不够可靠。如果我们的进程被一个错误退出了怎么办？难道我们真的需要仅仅为一个配置而去创建一个新的进程？</p>
<p>在这一章，我们将用OTP的方式来回答这些问题。在实践中，我们不必使用Mix来编写这样的应用，然而借此机会正好让我们了解一些Mix提供的一些方便之处。</p>
<h1 id="2-1_Stacker服务器">2.1 Stacker服务器</h1><p>我们的应用将会是一个运行我们推进/推出的简单堆栈。我们管它叫stacker：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix <span class="built_in">new</span> stacker <span class="comment">--bare</span></span><br></pre></td></tr></table></figure>
<p>我们的应用将包含一个堆栈，允许同一时间被许多的进程访问。为此，我们将创建一个服务器来负责管理这个堆栈。客户端随时可以向服务器发送消息来从服务器推进或取出某物。</p>
<p>因为在Erlang和Elixir里，创建这样的一个服务器是常见的一个范式，在OTP里有一个被称为<strong>GenServer</strong>的行为封装了这些常见的服务器功能。让我们创建一个文件<code>lib/stacker/server.ex</code>， 这就是我们的第一个服务器：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Stacker</span>.<span class="constant">Server </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">GenServer.Behaviour</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span>(stack) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:ok</span>, stack &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_call</span>(<span class="symbol">:pop</span>, <span class="constant">_from,</span> [h|stack]) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:reply</span>, h, stack &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_cast</span>(&#123; <span class="symbol">:push</span>, new &#125;, stack) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:noreply</span>, [new|stack] &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们的服务器定义了三个函数： <code>init/1</code>，<code>handle_call/3</code>和<code>handle_cast/2</code>。我们不会直接调用这些函数，它们是当我们请求服务器的时候由OTP来使用的函数。我们很快会了解详情，现在我们无需关心更多。为此，在你的命令行里运行<code>iex -S mix</code>来开始用mix来启动iex，输入下面的指令：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let's start the server using Erlang's :gen_server module.</span></span><br><span class="line"><span class="comment"># It expects 3 arguments: the server module, the initial</span></span><br><span class="line"><span class="comment"># stack and some options (if desired):</span></span><br><span class="line">iex&gt; &#123; :ok, pid &#125; = :gen_server.start_link(Stacker.Server, [], [])</span><br><span class="line">&#123;:ok,&lt;<span class="keyword">...</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now let's push something onto the stack</span></span><br><span class="line">iex&gt; :gen_server.cast(pid, &#123; :push, <span class="number">13</span> &#125;)</span><br><span class="line">:ok</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now let's get it out from the stack</span></span><br><span class="line"><span class="comment"># Notice we are using *call* instead of *cast*</span></span><br><span class="line">iex&gt; :gen_server.call(pid, :pop)</span><br><span class="line"><span class="number">13</span></span><br></pre></td></tr></table></figure>
<p>非常好，我们的服务器工作正常！然而在幕后其实发生了很多的事情，然我们来一一探究。</p>
<p>首先，我们用OTP中的<a href="http://www.erlang.org/doc/man/gen_server.html" target="_blank" rel="external"><code>:gen_server</code></a>模块启动服务器。注意我们使用了<code>start_link</code>， 它启动了服务器并且把当前的进程与之相连。在这种情况下，如果服务器死了，它将会向我们的当前进程发送一个退出消息，使它也退出。我们将在后面看到这个行为。函数<code>start_link</code>返回的是新创建的进程的识别符（<code>pid</code>）。</p>
<p>之后，我们向服务器发送了一个<strong>cast</strong>消息。消息的内容是<code>{ :push, 13 }</code>，与我们之前定义在<code>Stacker.Server</code>中的回调函数<code>handle_cast/2</code>里的一致。无论何时我们发送一个<code>cast</code>消息，函数<code>handle_cast/2</code>会被调用来处理这个消息。</p>
<p>接着，我们最终用发送<code>call</code>消息地方时，看到了堆栈里的情况，它触发了回调<code>handle_call/3</code>。那么，<code>cast</code>和<code>call</code>到底有什么不同呢？</p>
<p><code>cast</code>消息是异步的：我们向服务器发送一个消息，然而并不期待回复。这也是为什么我们的<code>handle_cast/2</code>回调返回的是<code>{ :noreply, [new|stack] }</code>的缘故。这个元组中的第一个元素表明了无需回复，而第二个元素是包含了新物件的经过升级的堆栈。</p>
<p>相反，<code>call</code>消息是同步的。当我们发送一个<code>call</code>消息，客户端期待一个回复。在这个例子中，回调<code>handle_call/3</code>返回了<code>{ :reply, h, stack }</code>，其中第二个元素就是用来返回的内容，而第三个是我们不包含头的堆栈。因为<code>call</code>能够向客户端返还消息，所以它的也多了一个有关客户端情况的参数（<code>_from</code>）。</p>
<h1 id="2-1-1_深入学习回调函数">2.1.1 深入学习回调函数</h1><p>在GenServer的例子中，类似<code>handle_call</code>或<code>handle_cast</code>的函数可能返回8种不同的数值：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123; <span class="attribute">:reply</span>, reply, new_state &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:reply</span>, reply, new_state, timeout &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:reply</span>, reply, new_state, <span class="attribute">:hibernate</span> &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:noreply</span>, new_state &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:noreply</span>, new_state, timeout &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:noreply</span>, new_state, <span class="attribute">:hibernate</span> &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:stop</span>, reason, new_state &#125;</span></span><br><span class="line"><span class="collection">&#123; <span class="attribute">:stop</span>, reason, reply, new_state &#125;</span></span><br></pre></td></tr></table></figure>
<p>一个GenServer的实现必须实现6种不同的回调函数。模块<code>GenServer.Behaviour</code>自动定义了这些函数，但又允许我们根据需要来修改。下面是这些函数的列表：</p>
<ul>
<li><code>init(args)</code> - 当服务器启动时调用</li>
<li><code>handle_call(msg, from, state)</code> - 被调用来处理<code>call</code>消息</li>
<li><code>handle_cast(msg, state)</code> - 被调用来处理<code>cast</code>消息</li>
<li><code>handle_info(msg, state)</code> - 被调用来处理进程所收到的其他消息</li>
<li><code>terminate(reason, state)</code> - 在服务器当机之前被调用，对清理很有用</li>
<li><code>code_change(old_vsn, state, extra)</code> - 在应用代码热升级的时候被调用</li>
</ul>
<h1 id="2-1-2_干掉一个服务器">2.1.2 干掉一个服务器</h1><p>Of what use is a server if we cannot crash it?</p>
<p>实际上要使一个服务器当机并不难。我们的回调<code>handle_call/3</code>只有当堆栈不是空的时候才工作正常（想起来了吗，<code>[h|t]</code>不能匹配空列表）。让我们在堆栈为空的情况下发送一个消息看看：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start another server, but with an initial :hello item</span></span><br><span class="line">iex&gt; &#123; :ok, pid &#125; = :gen_server.start_link(Stacker.Server, [:hello], [])</span><br><span class="line">&#123;:ok,&lt;<span class="keyword">...</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's get our initial item:</span></span><br><span class="line">iex&gt; :gen_server.call(pid, :pop)</span><br><span class="line">:hello</span><br><span class="line"></span><br><span class="line"><span class="comment"># And now let's call pop again</span></span><br><span class="line">iex&gt; :gen_server.call(pid, :pop)</span><br><span class="line"></span><br><span class="line">=ERROR REPORT==== <span class="number">6</span>-Dec-<span class="number">2012</span>::<span class="number">19</span>:<span class="number">15</span>:<span class="number">33</span> ===</span><br><span class="line"><span class="keyword">...</span></span><br><span class="line">** (exit)</span><br><span class="line"><span class="keyword">...</span></span><br></pre></td></tr></table></figure>
<p>你可以看到，这里有两个错误报告。第一个因为当机由服务器产生。因为服务器是同我们的进程相连的，它也发送了一个退出的消息，<code>IEx as ** (exit) ....</code></p>
<p>因为我们的服务器总会崩溃，我们需要监控它们，这也是下面的内容。<code>GenServer.Behaviour</code>不仅仅包含我们已经学到的这些。请查看<a href="http://elixir-lang.org/docs/stable/GenServer.Behaviour.html" target="_blank" rel="external"><code>GenServer.Behaviour</code></a>的文档来发现更多。</p>
<h1 id="2-2_监控服务器">2.2 监控服务器</h1><p>当在Eralng和Elixir里编写应用，一个常用到的哲学是fail first。也许是因为资源不可得，也许是服务之间的超时，或许是其他的什么原因。这也是为什么有能力对这些崩溃作出反应并回复过来，是非常重要的。把这些牢记在心，我们为我们的服务器编写一个supervisor。</p>
<p>用下面的内容创建一个文件，<code>lib/stacker/supervisor.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Stacker</span>.<span class="constant">Supervisor </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Supervisor.Behaviour</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># A convenience to start the supervisor</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_link</span>(stack) </span><span class="keyword">do</span></span><br><span class="line">    <span class="symbol">:supervisor</span>.start_link(<span class="constant">__MODULE__,</span> stack)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The callback invoked when the supervisor starts</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span>(stack) </span><span class="keyword">do</span></span><br><span class="line">    children = [ worker(<span class="constant">Stacker.Server,</span> [stack]) ]</span><br><span class="line">    supervise children, <span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在监控中，唯一需要实现的回调函数是<code>init(args)</code>。这个回调必须返回监工的规格，在上面的例子中实际调用了帮助函数<code>supervise/2</code>。</p>
<p>我们的监工非常简单：它必须监控我们的工人<code>Stacker.Server</code>， 工人的启动需要一个参数，在这是默认的堆栈。完成定义的工人被用<code>:one_for_one</code>的策略监控，这意味着每一次工人死亡之后都会被重启。</p>
<p>由于我们的工人由<code>Stacker.Server</code>模块指定，并且需要传递<code>stack</code>作为参数，在默认下，监工将调用函数<code>Stacker.Server.start_link(stack)</code>来启动工人，所以让我们来实现它：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Stacker</span>.<span class="constant">Server </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">GenServer.Behaviour</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_link</span>(stack) </span><span class="keyword">do</span></span><br><span class="line">    <span class="symbol">:gen_server</span>.start_link(&#123; <span class="symbol">:local</span>, <span class="symbol">:stacker</span> &#125;, <span class="constant">__MODULE__,</span> stack, [])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span>(stack) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:ok</span>, stack &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_call</span>(<span class="symbol">:pop</span>, <span class="constant">_from,</span> [h|stack]) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:reply</span>, h, stack &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_cast</span>(&#123; <span class="symbol">:push</span>, new &#125;, stack) </span><span class="keyword">do</span></span><br><span class="line">    &#123; <span class="symbol">:noreply</span>, [new|stack] &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>函数<code>start_link</code>同我们之前启动服务器的方式很相似，除了在这里我们需要多传递一个参数<code>{ :local, :stacker }</code>。这个参数在本地节点上注册我们的服务器，运行用一个名字（在这里，是<code>:stacker</code>）来调用它，而无需直接使用<code>pid</code>。</p>
<p>不借助监工，让我们运行<code>iex -S mix</code>来再一次打开控制台，这也会再一次编译我们的文件：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Now we will start the supervisor with a</span></span><br><span class="line"><span class="comment"># default stack containing :hello</span></span><br><span class="line">iex&gt; Stacker.Supervisor.start_link([:hello])</span><br><span class="line">&#123;:ok,&lt;<span class="keyword">...</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># And we will access the server by name since</span></span><br><span class="line"><span class="comment"># we registered it</span></span><br><span class="line">iex&gt; :gen_server.call(:stacker, :pop)</span><br><span class="line">:hello</span><br></pre></td></tr></table></figure>
<p>注意监工自动为我们启动了服务器，现在我们可以用名字<code>:stacker</code>向服务器发送消息了。如果我们使得服务器当机，会发送甚什么？</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; :gen_server.call(:stacker, :pop)</span><br><span class="line"></span><br><span class="line">=ERROR REPORT==== <span class="number">6</span>-Dec-<span class="number">2012</span>::<span class="number">19</span>:<span class="number">15</span>:<span class="number">33</span> ===</span><br><span class="line"><span class="keyword">...</span></span><br><span class="line">** (exit)</span><br><span class="line"><span class="keyword">...</span></span><br><span class="line"></span><br><span class="line">iex&gt; :gen_server.call(:stacker, :pop)</span><br><span class="line">:hello</span><br></pre></td></tr></table></figure>
<p>它和前面一样当机了，当监工立刻用默认的堆栈重启了它，使得我们可以再一次接受到<code>:hello</code>。太棒了！</p>
<p>默认下，监工运行一个工人在5秒内最多当机5次。如果工人当机的频率超过了这个限制，监工就会放弃它，不在重启。让我们尝试接连发送一个未知的消息看看（要快！）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; :gen_server.call(:stacker, :unknown)</span><br><span class="line"><span class="keyword">...</span> <span class="number">5</span> times <span class="keyword">...</span></span><br><span class="line"></span><br><span class="line">iex&gt; :gen_server.call(:stacker, :unknown)</span><br><span class="line">** (exit) &#123;:noproc,&#123;:gen_server,:call,[:stacker,:unknown]&#125;&#125;</span><br><span class="line">    gen_server.erl:<span class="number">180</span>: :gen_server.call/<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>第六个消息不在产生错误报告，因为我们的服务器不在自动重启了。Elixir返回<code>:noproc</code>（<code>no process</code>的简写形式），意味着那里已经没有一个被称为<code>:stacker</code>的进程了。重启的次数和时间间隔，可以通过向函数<code>supervise</code>传递参数进行修改。除了上面例子中的<code>:one_for_one</code>， 监工也能选用不同的重启策略。如果向知道还有那些支持的策略，检查<code>Supervisor.Behaviour</code>的<a href="http://elixir-lang.org/docs/stable/Supervisor.Behaviour.html" target="_blank" rel="external">文档</a>。</p>
<h1 id="2-3_谁来监控监工？">2.3 谁来监控监工？</h1><p>我们已经编写了我们的监工，但有一个问题：谁来监控监工？为了回答这个问题，OTP有一个概念，应用（application）。应用可以被作为一个整体启动或关闭，当这些发生的时候，它们通常和一个监工相连。</p>
<p>在之前的章节中，我们已经看到了Mix如何用文件<code>mix.exs</code>中的<code>application</code>函数中包含的信息来自动地产生一个<code>.app</code>文件，每次编译我们的项目。</p>
<p>这个<code>.app</code>文件被称为应用规格，它必须包含我们的应用的依赖，它定义的模块，注册名和其他的许多。其中的一些信息由Mix来自动完成，但另外的一些数据需要手动添加。</p>
<p>在我们的例子里面，我们的应用有一个监工，而且它用名字<code>:stacker</code>注册了监工。也就是说，为了避免冲突，我们需要在应用规格里加入所有的注册名。如果两个应用注册了同一个名字，我们能更快地找到冲突。所以，让我们打开文件<code>`，用下面的内容编辑</code>application`函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">  [ <span class="symbol">registered:</span> [<span class="symbol">:stacker</span>],</span><br><span class="line">    <span class="symbol">mod:</span> &#123; <span class="constant">Stacker,</span> [<span class="symbol">:hello</span>] &#125; ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在<code>:registered</code>键中我们指定了我们的应用注册的所有名字。而<code>:mod</code>键的用途是，一旦应用启动，它必须去调用应用模块回调函数（appliation module callback）。在我们的例子里面，应用模块回调函数是<code>Stack</code>模块，而且它将会接受到默认的参数，堆栈<code>[:hello]</code>。这个回调函数必须返回同应用相关的监工的<code>pid</code>。</p>
<p>有了这些在心里，让我们打开文件<code>lib/stacker.ex</code>，添加以下的内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Stacker</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Application.Behaviour</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="constant">_type,</span> stack) </span><span class="keyword">do</span></span><br><span class="line">    <span class="constant">Stacker.Supervisor.</span>start_link(stack)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Application.Behaviour</code>期待两个回调，<code>start(type, args)</code>和<code>stop(state)</code>。我们需要来实现<code>start(type, args)</code>， 而<code>stop(state)</code>可以先放在一边不管。</p>
<p>在添加了上面的应用行为之后，你只需要在一次启动<code>iex -S mix</code>。我们的文件将被再一次重编译，监工（包括我们的服务器）会自动启动：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="pseudo">:gen_server</span><span class="class">.call</span>(<span class="pseudo">:stacker</span>, <span class="pseudo">:pop)</span></span><br><span class="line"><span class="pseudo">:hello</span></span><br></pre></td></tr></table></figure>
<p>太棒了，它能性！也许你已经注意到了，应用回调函数<code>start/2</code>接受了一个类型参数，虽然我们忽略了它。这个类型控制当我们的监工，自然也包括应用，崩溃的时候，虚拟机应该如何应对。你可以通过阅读<code>Application.Behaviour</code>的<a href="http://elixir-lang.org/docs/stable/Application.Behaviour.html" target="_blank" rel="external">文档</a>学到更多。</p>
<p>最后，注意<code>mix new</code>支持一个<code>--sup</code>选项，它告诉Mix产生一个包含应用模块回调的监工，自动地完成了一些上面的工作。你一定要试试！</p>
<h1 id="2-4_启动应用">2.4 启动应用</h1><p>在任何时候，我们都不必自己去启动我们定义的应用。那是因为默认下Mix会启动所有的应用，包括所依赖的应用。我们能通过调用OTP提供的<a href="http://www.erlang.org/doc/man/application.html" target="_blank" rel="external"><code>:application</code>模块</a>中的函数来手动地启动应用：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="pseudo">:application</span><span class="class">.start</span>(:stacker)</span><br><span class="line">&#123; <span class="pseudo">:error</span>, &#123; <span class="pseudo">:already_started</span>, <span class="pseudo">:stacker</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>在上面的例子中，因为应用已经事先启动了，它返回了一个错误信息。</p>
<p>Mix不仅启动你的应用，而且包括所有的你的应用的依赖。请注意你的项目的依赖（我们在前面几章中讨论过的，定义在键<code>deps</code>里的）和应用依赖是不同的。</p>
<p>项目依赖也许会包含你的测试框架或者一个编译时的依赖。应用依赖是运行时你的应用依赖的一切。一个应用依赖需要明确地被加入<code>appliation</code>函数里：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">  [ <span class="symbol">registered:</span> [<span class="symbol">:stacker</span>],</span><br><span class="line">    <span class="symbol">applications:</span> [<span class="symbol">:some_dep</span>],</span><br><span class="line">    <span class="symbol">mod:</span> &#123; <span class="constant">Stacker,</span> [<span class="symbol">:hello</span>] &#125; ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>当在Mix里运行任务，它将确保应用以及应用的依赖都会被启动。</p>
<h1 id="2-5_配置应用">2.5 配置应用</h1><p>除了我们已经看到的键<code>:registered</code>，<code>:applications</code>和<code>:mod</code>，应用也支持被读取和设置的配置数值。</p>
<p>在命令行里，尝试：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="symbol">:application</span>.get_env(<span class="symbol">:stacker</span>, <span class="symbol">:foo</span>)</span><br><span class="line"><span class="symbol">:undefined</span></span><br><span class="line">iex&gt; <span class="symbol">:application</span>.set_env(<span class="symbol">:stacker</span>, <span class="symbol">:foo</span>, <span class="symbol">:bar</span>)</span><br><span class="line"><span class="symbol">:ok</span></span><br><span class="line">iex&gt; <span class="symbol">:application</span>.get_env(<span class="symbol">:stacker</span>, <span class="symbol">:foo</span>)</span><br><span class="line">&#123; <span class="symbol">:ok</span>, <span class="symbol">:bar</span> &#125;</span><br></pre></td></tr></table></figure>
<p>这个机制非常有用，它无需创建一整个监工链就能为你的应用提供配置数值。应用的默认的配置数值可以通过如下的方式在文件<code>mix.exs</code>中定义：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">  [ <span class="symbol">registered:</span> [<span class="symbol">:stacker</span>],</span><br><span class="line">    <span class="symbol">mod:</span> &#123; <span class="constant">Stacker,</span> [<span class="symbol">:hello</span>] &#125;,</span><br><span class="line">    <span class="symbol">env:</span> [<span class="symbol">foo:</span> <span class="symbol">:bar</span>] ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>现在，从控制台里退出，然后用<code>iex -S mix</code>重启它：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="pseudo">:application</span><span class="class">.get_env</span>(:stacker, :foo)</span><br><span class="line">&#123; <span class="pseudo">:ok</span>, <span class="pseudo">:bar</span> &#125;</span><br></pre></td></tr></table></figure>
<p>例如，IEx和ExUnit是两个Elixir包含的应用，它们的<code>mix.exs</code>文件就是使用了这样的配置，文件<a href="https://github.com/elixir-lang/elixir/blob/master/lib/iex/mix.exs" target="_blank" rel="external">IEx</a>和<a href="https://github.com/elixir-lang/elixir/blob/master/lib/ex_unit/mix.exs" target="_blank" rel="external">ExUnit</a>。这样的应用于是提供了提供了<a href="https://github.com/elixir-lang/elixir/blob/d2bfd10299dc0e2df573589f1d33565177d63a7d/lib/ex_unit/lib/ex_unit.ex#L125-L155" target="_blank" rel="external">对读写这些数值的封装</a>。</p>
<p>到这里，我们结束了这一章。我们已经学习了如何创建服务器，监控它们，把它们和我们的应用整合和提供简单的配置选项。在下一章，我们将学习如何创建一个Mix中的定制任务。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-04T08:34:35.000Z"><a href="/2014/11/04/elixir-create-custom-mix-tasks/">2014-11-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/04/elixir-create-custom-mix-tasks/">创建自定义Mix任务(译)</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#常见API"><span class="toc-number">1.</span> <span class="toc-text">常见API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespaced_Tasks"><span class="toc-number">2.</span> <span class="toc-text">Namespaced Tasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选项解析"><span class="toc-number">3.</span> <span class="toc-text">选项解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分享任务"><span class="toc-number">4.</span> <span class="toc-text">分享任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作为依赖"><span class="toc-number">4.1.</span> <span class="toc-text">作为依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#把任务打包"><span class="toc-number">4.2.</span> <span class="toc-text">把任务打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIX_PATH"><span class="toc-number">4.3.</span> <span class="toc-text">MIX_PATH</span></a></li></ol></li></ol>
        </div>
        


        <p>原文: <a href="http://elixir-lang.readthedocs.org/en/latest/mix/3/" target="_blank" rel="external">http://elixir-lang.readthedocs.org/en/latest/mix/3/</a></p>
<p>在Mix中,一个任务实际上是一个具有名称空间<code>Mix.Tasks</code>并实现了<code>run/1</code>函数的模块.例如,<code>compile</code>任务是一个名称为<code>Mix.Tasks.Compile</code>的模块.</p>
<p>创建一个简单的任务:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Mix</span>.<span class="constant">Tasks.Hello </span></span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> <span class="constant">Mix.Task</span></span><br><span class="line">    <span class="variable">@shortdoc</span> <span class="string">"这是一个短文档, 看"</span></span><br><span class="line">    <span class="variable">@moduledoc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">    一个测试任务</span><br><span class="line">    "</span><span class="string">""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="constant">_)</span> </span><span class="keyword">do</span></span><br><span class="line">        <span class="constant">IO.</span>puts <span class="string">"你好,世界!"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>保存文<code>hello.ex</code>, 并编译:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>elixirc hello.ex</span><br><span class="line"><span class="variable">$ </span>mix hello</span><br><span class="line">你好,世界</span><br></pre></td></tr></table></figure>
<p>上述模块定义了一个名称为<code>hello</code>的任务. 函数<code>run/1</code>接受一个二进制字符串参数, 该参数是从命令行传递给此任务的.</p>
<p>当调用命令<code>mix hello</code>时, 该任务被执行, 并输出<code>你好,世界</code>. Mix使用其第一个参数(<code>hello</code>)查找任务模块并执行<code>run</code>函数.</p>
<p>为什么有一个<code>@moduledoc</code>和<code>@shortdoc</code>. 这两个文档标记是被<code>help</code>任务使用来显示任务的说明文档. <code>@shortdoc</code>用在执行<code>mix help</code>的时候显示任务的简短描述, <code>@moduledoc</code>用于执行<code>mix help hello</code>是显示<code>hello</code>任务的详细描述.</p>
<p>除了这两个文档标签外, 还有一个<code>@hidden</code>标签, 当其设置为<code>true</code>时,该任务不显示在<code>mix help</code>的输出中, 任何没有<code>@shortdoc</code>标签的任务也不会显示.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ModuleName</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="variable">@hidden</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="常见API">常见API</h2><p>当编写任务时, 需要访问一些常见的Mix功能, 如下:</p>
<ul>
<li><code>Mix.Project.config</code> 返回项目配置(<code>mix.exs</code>的<code>project</code>函数), 如果当前目录不存在<code>mix.exs</code>文件, 该函数返回一个空的配置. </li>
<li><code>Mix.Project.get!</code> 访问当前项目的模块, 需要访问项目中的特殊函数是非常有用. 如果项目未定义,将抛出异常.</li>
<li><code>Mix.shell</code> </li>
<li><code>Mix.Task.run(task,args)</code> 从其他Mix任务中调用另一个任务; 如果该任务已经被调用, 不做任何操作.</li>
</ul>
<h2 id="Namespaced_Tasks">Namespaced Tasks</h2><p>简单的任务可用于完成复杂的事情. 任务实际上也是Elixir代码,任何Elixir可以做的事情都可以放到任务中去做. 可以像分发其他库一样分发任务, 让任务可以在其他项目中重用.</p>
<p>要在多个项目中重用任务, 为了避免名称冲突, Mix任务支持名称空间.</p>
<p>示例:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">defmodule <span class="type">Mix</span>.<span class="type">Tasks</span>.<span class="type">Mytasks</span> do</span><br><span class="line">    <span class="annotation">@shortdoc</span> <span class="string">"任务集合模块"</span></span><br><span class="line">    <span class="annotation">@moduledoc</span> <span class="string">"""</span><br><span class="line">    用于构建和部署的任务集合</span><br><span class="line">    """</span></span><br><span class="line">    defmodule <span class="type">Build</span> do</span><br><span class="line">        use <span class="type">Mix</span>.<span class="type">Task</span></span><br><span class="line">        <span class="annotation">@shortdoc</span> <span class="string">"构建任务"</span></span><br><span class="line">        <span class="annotation">@moduledoc</span> <span class="string">"""</span><br><span class="line">        构建一个软件组件模块</span><br><span class="line">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">run</span>(</span>_) do</span><br><span class="line">            <span class="type">IO</span>.puts <span class="string">"运行子任务Build"</span></span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    defmodule <span class="type">Deploy</span> do</span><br><span class="line">        use <span class="type">Mix</span>.<span class="type">Task</span></span><br><span class="line"></span><br><span class="line">        <span class="annotation">@shortdoc</span> <span class="string">"部署一个软件组件"</span></span><br><span class="line">        <span class="annotation">@moduledoc</span> <span class="string">"""</span><br><span class="line">        把一个软件组件部署到服务器</span><br><span class="line">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">run</span>(</span>_) do</span><br><span class="line">            <span class="type">IO</span>.puts <span class="string">"运行子任务Deploy"</span></span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>任务模块写好了后, 可以像这样调用任务: <code>mix mytasks.build</code>, <code>mix mytasks.deploy</code>, 这功能很酷对吧?</p>
<p><img src="/assets/images/BAE289A3-2D50-430A-B85A-1BC3C55896F9.png" alt="任务帮助"></p>
<h2 id="选项解析">选项解析</h2><pre><code><span class="type">OptionParser</span>.parse([<span class="string">"--debug"</span>])
#=&gt; { [debug: <span class="literal">true</span>], <span class="literal">[]</span> }

<span class="type">OptionParser</span>.parse([<span class="string">"--source"</span>, <span class="string">"lib"</span>])
#=&gt; { [source: <span class="string">"lib"</span>], <span class="literal">[]</span> }

<span class="type">OptionParser</span>.parse([<span class="string">"--source"</span>, <span class="string">"lib"</span>, <span class="string">"test/enum_test.exs"</span>, <span class="string">"--verbose"</span>])
#=&gt; { [source: <span class="string">"lib"</span>, verbose: <span class="literal">true</span>], [<span class="string">"test/enum_test.exs"</span>] }
</code></pre><h2 id="分享任务">分享任务</h2><p>创建了任务后,如果需要在团队内分享给其他人, 或在其他项目中重用, 这章描述了几种不同的分享法师</p>
<h3 id="作为依赖">作为依赖</h3><p>假设创建了一个<code>my_tasks</code>项目, 其提供了众多有用的功能, 把该项目添加为其他项目的依赖, 所有在<code>my_tasks</code>项目中的任务可以被其他引用了<code>my_tasks</code>的项目使用.</p>
<h3 id="把任务打包">把任务打包</h3><p>Mix允许你安装和卸载本地归档包. 要为当前项目生成一个归档包, 运行:</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/elixir/commandlinetools</span><span class="comment"># mix do archive.build</span>
<span class="constant">Generated </span>archive commandlinetools-<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>.ez with <span class="constant">MIX_ENV=</span>dev
</code></pre><p><img src="/assets/images/71D4F33D-A3F1-4A14-A1A1-AFAE607AFFC2.png" alt="把任务打包"></p>
<p>打包的任务可以通过文件系统路径或URL安装:</p>
<pre><code>mix archive<span class="class">.install</span> http:<span class="comment">//localhost/commandlinetools-0.0.1.ez</span>
</code></pre><p><code>mix archive</code>命令的的详细说明可通过 <code>mix help archive</code> 查看</p>
<h3 id="MIX_PATH">MIX_PATH</h3><p>最有一个中方法是使用<code>MIX_PATH</code>. 设置了<code>MIX_PATH</code>环境变量之后, 所有在其中的任务对Mix都可用, 比如:</p>
<pre><code>$ <span class="built_in">export</span> MIX_PATH=<span class="string">"/elixir/ebin"</span>
</code></pre><p>这种方式可以单独维护需要在多个项目中使用的任务. </p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-02T06:59:55.000Z"><a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/">2014-11-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/">使用Mix创建命令行工具</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="注意">注意</h2><p>网上的很多文档中的说明都使用了<code>mix escriptize</code>命令用于生成命令行工具, 在最新的Elixir版本中被改为<code>mix escript.build</code>, 请注意!</p>
<h2 id="用Mix创建一个项目骨架">用Mix创建一个项目骨架</h2><p><code>mix</code>是一个Elixir自身支持的项目管理工具, 支持的功能有:</p>
<ul>
<li>创建基本项目目录结构</li>
<li>管理依赖</li>
<li>编译</li>
<li>发布</li>
</ul>
<p>下面我们使用mix来创建一个命令行工具的项目目录</p>
<pre><code>mix <span class="keyword">new</span> commandlinetools
<span class="keyword">cd</span> commandlinetools
</code></pre><p>项目创建好以后, 编辑项目目录下的<code>mix.exs</code>项目描述文件, 在<code>project</code>函数内添加<code>escript</code>配置,并添加<code>escript</code>函数,如下:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span>
  [<span class="symbol">app:</span> <span class="symbol">:commandlinetools</span>,
   <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,
   <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,
   <span class="symbol">deps:</span> deps,
   <span class="symbol">escript:</span> escript
   ]
<span class="keyword">end</span>
<span class="function"><span class="keyword">def</span> <span class="title">escript</span> </span><span class="keyword">do</span>
  [<span class="symbol">main_module:</span> <span class="constant">Commandlinetools]</span>
<span class="keyword">end</span>
</code></pre><p><code>main_module</code> 选项指定了命令行工具的入口模块, 该模块必须实现一个<code>main/1</code>函数, 打开<code>lib/commandlinetools.ex</code>, 实现<code>main/1</code>函数</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">Commandlinetools</span> </span><span class="keyword">do</span>
    <span class="function"><span class="keyword">def</span> <span class="title">main</span>(args) </span><span class="keyword">do</span>
        <span class="constant">IO.</span>puts(<span class="string">"命令行工具main函数实现"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>编译,生成可执行程序</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/ejabberd/elixir/commandlinetools</span><span class="comment"># mix escript.build</span>
lib/commandlinetools.<span class="symbol">ex:</span><span class="number">2</span><span class="symbol">:</span> <span class="symbol">warning:</span> variable args is unused
<span class="constant">Compiled </span>lib/commandlinetools.ex
<span class="constant">Generated </span>commandlinetools.app
<span class="constant">Consolidated List.Chars</span>
<span class="constant">Consolidated Range.Iterator</span>
<span class="constant">Consolidated String.Chars</span>
<span class="constant">Consolidated Enumerable</span>
<span class="constant">Consolidated Access</span>
<span class="constant">Consolidated Inspect</span>
<span class="constant">Consolidated Collectable</span>
<span class="constant">Consolidated </span>protocols written to <span class="constant">_build/</span>dev/consolidated
<span class="constant">Generated </span>escript commandlinetools with <span class="constant">MIX_ENV=</span>dev
</code></pre><p>运行</p>
<pre><code>root<span class="variable">@0b85dcd174f2</span><span class="symbol">:~/ejabberd/elixir/commandlinetools</span><span class="comment"># ./commandlinetools</span>
命令行工具main函数实现
</code></pre>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/11/02/elixir-create-command-line-utility-with-elixir-and-mix/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-01T15:28:15.000Z"><a href="/2014/11/01/elixir-deps/">2014-11-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/01/elixir-deps/">依赖管理</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/52787527-EA9C-40CA-9D9E-5950298E6EA0.png" alt="Elixir依赖管理命令"></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mix</span> deps            <span class="preprocessor"># 显示所有依赖包极其状态</span></span><br><span class="line"><span class="built_in">mix</span> deps.get        <span class="preprocessor"># 下载未安装的依赖包</span></span><br><span class="line"><span class="built_in">mix</span> deps.compile    <span class="preprocessor"># 编译依赖包</span></span><br><span class="line"><span class="built_in">mix</span> deps.update     <span class="preprocessor"># 更新依赖包</span></span><br><span class="line"><span class="built_in">mix</span> deps.clean      <span class="preprocessor"># 删除所有依赖文件</span></span><br><span class="line"><span class="built_in">mix</span> deps.unlock     <span class="preprocessor"># 解锁依赖</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-31T06:13:57.000Z"><a href="/2014/10/31/elixir-mix-and-otp-ch8-task-and-gen-tcp/">2014-10-31</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/31/elixir-mix-and-otp-ch8-task-and-gen-tcp/">Mix 和 OTP 任务以及gen_tcp</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>这章将学习如何使用Erlang的<code>:gen_tcp</code>模块处理请求. 后续章节我们会扩展服务器使之能处理命令. 还提供了一个极好的机会探索Elixir的<code>Task</code>模块</p>
<h2 id="Echo服务器">Echo服务器</h2><p>首先通过实现一个echo服务器,开始学习TCP服务器. 它只是把接收到的文本返回给客户端. 我们慢慢的改进服务器直到它能够处理多个连接.</p>
<p>一个TCP服务器, 大致会执行如下步骤:</p>
<ul>
<li>监听端口并获得套接字</li>
<li>等待客户端连接该端口,并Accept.</li>
<li>读取客户端请求并回写响应</li>
</ul>
<p>下面来实现这些步骤, 转到<code>apps/kv_server</code>应用程序, 打开<code>lib/kv_server.ex</code>,添加下面的函数:</p>
<pre><code>def accept(port) <span class="built_in">do</span>
  <span class="comment"># The options below mean:</span>
  <span class="comment">#</span>
  <span class="comment"># 1. `:binary` - receives data as binaries (instead of lists)</span>
  <span class="comment"># 2. `packet: :line` - receives data line by line</span>
  <span class="comment"># 3. `active: false` - block on `:gen_tcp.recv/2` until data is available</span>
  <span class="comment">#</span>
  {:ok, <span class="built_in">socket</span>} = :gen_tcp.listen(port,
                    [:binary, packet: :<span class="built_in">line</span>, active: <span class="constant">false</span>])
  IO.puts <span class="string">"Accepting connections on port #{port}"</span>
  loop_acceptor(<span class="built_in">socket</span>)
<span class="function"><span class="keyword">end</span></span>
defp loop_acceptor(<span class="built_in">socket</span>) <span class="built_in">do</span>
  {:ok, client} = :gen_tcp.accept(<span class="built_in">socket</span>)
  serve(client)
  loop_acceptor(<span class="built_in">socket</span>)
<span class="function"><span class="keyword">end</span></span>
defp serve(client) <span class="built_in">do</span>
  client
  |&gt; read_line()
  |&gt; write_line(client)
  serve(client)
<span class="function"><span class="keyword">end</span></span>
defp read_line(<span class="built_in">socket</span>) <span class="built_in">do</span>
  {:ok, data} = :gen_tcp.recv(<span class="built_in">socket</span>, <span class="number">0</span>)
  data
<span class="function"><span class="keyword">end</span></span>
defp write_line(<span class="built_in">line</span>, <span class="built_in">socket</span>) <span class="built_in">do</span>
  :gen_tcp.<span class="built_in">send</span>(<span class="built_in">socket</span>, <span class="built_in">line</span>)
<span class="function"><span class="keyword">end</span></span>
</code></pre><p>调用<code>KVServer.accept(4040)</code>启动服务器, <code>4040</code>为端口. 在<code>accept/1</code>中第一步是监听端口直到获得一个可用的套接字, 然后调用<code>loop_acceptor/1</code>. <code>loop_acceptor/1</code>仅仅是循环地接受客户端连接. 对于每个接受的连接, 调用<code>serve/1</code>.</p>
<p><code>serve/1</code>是另一个循环调用, 其从套接字读取一行数据并把读取到的行写回套接字. 注意函数<code>serve/1</code>使用管道操作符 <code>|&gt;</code> 来表达操作流.管道操作符对左边的表达式求值并把结果作为右侧函数的第一个参数传递. 上面的例子:</p>
<pre><code><span class="built_in">socket</span> |&gt; read_line() |&gt; write_line(<span class="built_in">socket</span>)
</code></pre><p>等同于:</p>
<pre><code><span class="function"><span class="title">write_line</span><span class="params">(read_line(socket)</span></span>, socket)
</code></pre><p>当使用 <code>|&gt;</code> 操作符时, 由于操作符优先级的问题, 给函数调用添加必要的括号是非常重要的, 特别是, 这段代码:</p>
<pre><code><span class="number">1</span>..<span class="number">10</span> |&gt; <span class="keyword">Enum</span>.filter &amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>) |&gt; <span class="keyword">Enum</span>.map &amp;(&amp;<span class="number">1</span> * <span class="number">2</span>)
</code></pre><p>实际上会转换为:</p>
<pre><code><span class="number">1</span>..<span class="number">10</span> |&gt; <span class="keyword">Enum</span>.filter(&amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>) |&gt; <span class="keyword">Enum</span>.map(&amp;(&amp;<span class="number">1</span> * <span class="number">2</span>)))
</code></pre><p>这不是我们想要的结果, 因为传递给<code>Enum.filter/2</code>的函数作为给<code>Enum.map/2</code>的第一个参数传递, 解决办法是使用括号:</p>
<pre><code><span class="preprocessor"># 译注: 虽然Elixir的函数调用通常情况下可以不使用括号,</span>
<span class="preprocessor"># 但是为了避免歧义或不必要的问题,建议所有函数调用其他语言中必须的括号风格</span>
<span class="number">1.</span><span class="number">.10</span> |&gt; Enum.filter(&amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>)) |&gt; Enum.map(&amp;(&amp;<span class="number">1</span> * <span class="number">2</span>))
</code></pre><p><code>read_line/1</code>函数实现使用<code>:gen_tcp.recv/2</code>从套接字接收数据,  <code>write_line/2</code>使用<code>:gen_tcp.send/2</code>向套接字写入数据.</p>
<p>使用命令<code>iex -S mix</code>在<code>kv_server</code>应用程序中启动一个iex会话. 在IEx中运行:</p>
<pre><code>iex&gt; KVServer.<span class="function"><span class="title">accept</span><span class="params">(<span class="number">4040</span>)</span></span>
</code></pre><p>服务器现在开始运行, 终端被阻塞. 我们使用 <code>telnet</code>客户端访问我们的服务器. 它在大多数操作系统中都有, 其命令行参数通常类似:</p>
<pre><code>$ telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="keyword">...</span>
Connected to localhost.
Escape character is <span class="string">'^]'</span>.
hello
hello
is it me
is it me
you are looking <span class="keyword">for</span>?
you are looking <span class="keyword">for</span>?
</code></pre><p>键入<code>hello</code>, 并敲击回车, 你会的到服务器的<code>hello</code>响应, 太棒了!</p>
<p>我的telnet客户端可以通过键入<code>ctrl + ]</code>, <code>quit</code>, 并敲击 <code>&lt;Enter&gt;</code>退出, 你的客户端可能有不同的步骤:</p>
<p>退出telnet客户端后, 你可能会在IEx(Elixir Shell)会话中看到如下错误:</p>
<pre><code>** (MatchError) no match of right hand side <span class="string">value:</span> {:error, :closed}
    (kv_server) lib<span class="regexp">/kv_server.ex:41: KVServer.read_line/</span><span class="number">1</span>
    (kv_server) lib<span class="regexp">/kv_server.ex:33: KVServer.serve/</span><span class="number">1</span>
    (kv_server) lib<span class="regexp">/kv_server.ex:27: KVServer.loop_acceptor/</span><span class="number">1</span>
</code></pre><p>这是因为我们期望从<code>:gen_tcp.recv/2</code>接收数据,但是客户端关闭了连接. 服务器后续的版本修订需要更好的处理这种情况.</p>
<p>现在有一个更重要的Bug要解决: 如果TCP acceptor崩溃会发生什么? 因为没有监视进程, 服务器异常退出并且不能处理更多后续的请求, 因为它没有重启. 这就是为什么必须把服务器放在监控树当中.</p>
<h2 id="Tasks">Tasks</h2><p>我们已经学习过了代理(Agents), 通用服务器(Generic Servers), 以及事件管理器(Event Managers), 它们全部是适合处理多个消息或管理状态. 但是, 当我们只需要执行一些任务时,我们使用什么?</p>
<p><a href="http://elixir-lang.org/docs/stable/elixir/Task.html" title="Task模块" target="_blank" rel="external">Task模块</a>恰好提供了这个功能. 例如, 其有一个<code>start_link/3</code>函数, 其接受一个模块, 函数和参数, 作为监控树(Supervision tree)的一部分允许我们运行一个给定的函数.</p>
<p>让我们试一下. 打开<code>lib/kv_server.ex</code>, 修改<code>start/2</code>中的监控进程为如下:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="constant">_type,</span> <span class="constant">_args)</span> </span><span class="keyword">do</span>
  import <span class="constant">Supervisor.Spec</span>
  children = [
    worker(<span class="constant">Task,</span> [<span class="constant">KVServer,</span> <span class="symbol">:accept</span>, [<span class="number">4040</span>]])
  ]
  opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">KVServer.Supervisor]</span>
  <span class="constant">Supervisor.</span>start_link(children, opts)
<span class="keyword">end</span>
</code></pre><p>With this change, we are saying that we want to run KVServer.accept(4040) as a worker.<br>We are hardcoding the port for now, but we will discuss ways in which this could be changed later.</p>
<p>现在我们向把<code>KVServer.accept(4040)</code>作为一个worker运行. 现在我们硬编码了端口号, 但我们将会讨论能在以后修改的方法.</p>
<p>现在服务器作为监控数的一部分, 当运行应用程序的时候它应该自动地启动. 在终端中键入命令<code>mix run --no-halt</code>, 再次使用<code>telnet</code>客户端验证一切仍能工作:</p>
<pre><code>$ telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="keyword">...</span>
Connected to localhost.
Escape character is <span class="string">'^]'</span>.
say you
say you
say me
say me
</code></pre><p>Yes, 仍然可以工作. 如果你杀掉客户端, 将导致整个服务器崩溃, 你会看到另一个服务器进程立即启动.</p>
<p>同时连接两个客户端, 再次测试, 你发现第二个客户端并没有echo:</p>
<pre><code>$ telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="keyword">...</span>
Connected to localhost.
Escape character is <span class="string">'^]'</span>.
hello
hello?
HELLOOOOOO?
</code></pre><p>这是因为我们在同一个进程中处理接受连接并处理请求. 一个客户端连接后, 同一时刻就不能在接受其他的客户端的连接了, 直到之前的请求处理完成.</p>
<h2 id="任务监视器(Task_supervisor)">任务监视器(Task supervisor)</h2><p>为了使服务器能处理并发连接, 需要一个进程作为acceptor, 生成(spawns)一个额外的进程来处理请求. 解决办法是修改下面的代码:</p>
<pre><code>defp loop_acceptor(<span class="built_in">socket</span>) <span class="built_in">do</span>
  {:ok, client} = :gen_tcp.accept(<span class="built_in">socket</span>)
  serve(client)
  loop_acceptor(<span class="built_in">socket</span>)
<span class="function"><span class="keyword">end</span></span>
</code></pre><p>使用 <code>Task.start_link/1</code>, 类似于 <code>Task.start_link/3</code>, 它接受一个匿名函数作为参数, 而非模块,函数,参数:</p>
<pre><code>defp loop_acceptor(<span class="built_in">socket</span>) <span class="built_in">do</span>
  {:ok, client} = :gen_tcp.accept(<span class="built_in">socket</span>)
  Task.start_link(fn -&gt; serve(client) <span class="function"><span class="keyword">end</span>)</span>
  loop_acceptor(<span class="built_in">socket</span>)
<span class="function"><span class="keyword">end</span></span>
</code></pre><p>我们已经犯了一次这样的错误. 记得么?</p>
<p>这个错误类似于当我们从registry调用<code>KV.Bucket.start_link/0</code>所犯的错误. 在任何bucket中的失败将带来整个registry当机.</p>
<p>上面的胆码有同样的瑕疵: 如果我们连接<code>serve(client)</code>任务到acceptor, 当处理一个请求的时候将导致acceptor崩溃, 结果所有其他的连接,断开(down)</p>
<blockquote>
<p>We fixed the issue for the registry by using a simple one for one supervisor. We are going to use the same tactic here,<br>except that this pattern is so common with tasks that tasks already come with a solution: a simple one for one supervisor with temporary workers that we can just use in our supervision tree!</p>
</blockquote>
<p><del>使用一个<code>simple_one_for_one</code>监视进程(supervisor)解决这个问题. 我们将使用相同的策略,except that this pattern is so common with tasks that tasks already come with a solution: 可以在监控树种使用一个<code>simple_one_for_one</code>监视器和临时的workers.</del></p>
<p>再次修改<code>start/2</code>, 添加一个监视进程到进程树:</p>
<pre><code>def start(_type, _args) <span class="keyword">do</span>
  import Supervisor.Spec

  children = [
    supervisor(Task.Supervisor, <span class="string">[[name: KVServer.TaskSupervisor]]</span>),
    worker(Task, [KVServer, :accept, [<span class="number">4040</span>]])
  ]

  opts = [strategy: :one_for_one, name: KVServer.Supervisor]
  Supervisor.start_link(children, opts)
<span class="keyword">end</span>
</code></pre><p>使用名称<code>KVServer.TaskSupervisor</code>启动一个<a href="http://elixir-lang.org/docs/stable/elixir/Task.Supervisor.html" title="Task.Supervisor" target="_blank" rel="external">Task.Supervisor</a>进程. 记住, 因为acceptor任务依赖此监视进程, 该监视检查必须首先启动.</p>
<p>现在只需要修改<code>loop_acceptor/2</code>使用<code>Task.Supervisor</code>来处理每一个请求:</p>
<pre><code>defp loop_acceptor(<span class="built_in">socket</span>) <span class="built_in">do</span>
  {:ok, client} = :gen_tcp.accept(<span class="built_in">socket</span>)
  Task.Supervisor.start_child(KVServer.TaskSupervisor, fn -&gt; serve(client) <span class="function"><span class="keyword">end</span>)</span>
  loop_acceptor(<span class="built_in">socket</span>)
<span class="function"><span class="keyword">end</span></span>
</code></pre><p>使用命令<code>mix run --no-halt</code>启动一个新的服务器, 然后可以打开多个并发的telnet客户端连接. 你还注意到退出一个客户端后并不会导致acceptor崩溃. 太棒了!</p>
<p>这里是完整的echo服务器在单个模块中的实现:</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">KVServer</span> </span><span class="keyword">do</span>
  <span class="keyword">use</span> <span class="constant">Application</span>

  <span class="variable">@doc</span> <span class="keyword">false</span>
  <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="constant">_type,</span> <span class="constant">_args)</span> </span><span class="keyword">do</span>
    import <span class="constant">Supervisor.Spec</span>

    children = [
      supervisor(<span class="constant">Task.Supervisor,</span> [[<span class="symbol">name:</span> <span class="constant">KVServer.TaskSupervisor]</span>]),
      worker(<span class="constant">Task,</span> [<span class="constant">KVServer,</span> <span class="symbol">:accept</span>, [<span class="number">4040</span>]])
    ]

    opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">KVServer.Supervisor]</span>
    <span class="constant">Supervisor.</span>start_link(children, opts)
  <span class="keyword">end</span>

  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"
  Starts accepting connections on the given `port`.
  "</span><span class="string">""</span>
  <span class="function"><span class="keyword">def</span> <span class="title">accept</span>(port) </span><span class="keyword">do</span>
    {<span class="symbol">:ok</span>, socket} = <span class="symbol">:gen_tcp</span>.listen(port,
                      [<span class="symbol">:binary</span>, <span class="symbol">packet:</span> <span class="symbol">:line</span>, <span class="symbol">active:</span> <span class="keyword">false</span>])
    <span class="constant">IO.</span>puts <span class="string">"Accepting connections on port <span class="subst">#{port}</span>"</span>
    loop_acceptor(socket)
  <span class="keyword">end</span>

  defp loop_acceptor(socket) <span class="keyword">do</span>
    {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
    <span class="constant">Task.Supervisor.</span>start_child(<span class="constant">KVServer.TaskSupervisor,</span> <span class="keyword">fn</span> -&gt; serve(client) <span class="keyword">end</span>)
    loop_acceptor(socket)
  <span class="keyword">end</span>

  defp serve(socket) <span class="keyword">do</span>
    socket
    |&gt; read_line()
    |&gt; write_line(socket)

    serve(socket)
  <span class="keyword">end</span>

  defp read_line(socket) <span class="keyword">do</span>
    {<span class="symbol">:ok</span>, data} = <span class="symbol">:gen_tcp</span>.recv(socket, <span class="number">0</span>)
    data
  <span class="keyword">end</span>

  defp write_line(line, socket) <span class="keyword">do</span>
    <span class="symbol">:gen_tcp</span>.send(socket, line)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>因为我们已经修改了supervisor规范, 我们需要问: 我们的supervision策略仍然正确么?</p>
<p>在这种情形下, 答案是yes: 如果acceptor崩溃, 并不会导致现有的连接中断.从另一方面讲, 如果任务监视器(task supervisor)崩溃, 也不会导致acceptor崩溃. 对比registry, 最初每次registry崩溃的时候也会导致supervisor崩溃, 直到使用ETS来对状态持久化.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-30T17:16:12.000Z"><a href="/2014/10/31/elixir-mix-and-otp-ch6-ets/">2014-10-31</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/31/elixir-mix-and-otp-ch6-ets/">Mix 和 OTP - ETS</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ETS"><span class="toc-number">1.</span> <span class="toc-text">ETS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作为缓存的ETS"><span class="toc-number">1.1.</span> <span class="toc-text">作为缓存的ETS</span></a></li></ol></li></ol>
        </div>
        


        <h2 id="ETS">ETS</h2><p>每次我们需要查询一个<code>bucket</code>, 我们需要发送一个消息给<code>registry</code>. 在有些应用程序中这意味着<code>registry</code>也许变成瓶颈.</p>
<p>本章中,我们将学习学习ETS(Erlang Term Storage),以及如何把它用作一个缓存机制. 稍后我们将扩展其用途,持久化从监视进程到子进程的持久化数据,即使是在崩溃的时候.</p>
<blockquote>
<p>警告! 别过早的使用ETS作为缓存! 记录并分析你的应用程序性能,识别哪部分是瓶颈. 这样你才知道是否应该使用缓存,以及应该缓存什么.一旦你决定了需求, 本章可作为一个如何使用ETS的例子.</p>
</blockquote>
<h3 id="作为缓存的ETS">作为缓存的ETS</h3><p>ETS允许我们在内存表中存储任何Erlang/Elixir项式. 通过erlang的<code>:ets</code>模块处理ETS表:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; table = <span class="symbol">:ets</span>.new(<span class="symbol">:buckets_registry</span>, [<span class="symbol">:set</span>, <span class="symbol">:protected</span>])</span><br><span class="line"><span class="number">8207</span></span><br><span class="line">iex&gt; <span class="symbol">:ets</span>.insert(table, &#123;<span class="string">"foo"</span>, <span class="keyword">self</span>&#125;)</span><br><span class="line"><span class="keyword">true</span></span><br><span class="line">iex&gt; <span class="symbol">:ets</span>.lookup(table, <span class="string">"foo"</span>)</span><br><span class="line">[&#123;<span class="string">"foo"</span>, <span class="comment">#PID&lt;0.41.0&gt;&#125;]</span></span><br></pre></td></tr></table></figure>
<p>当创建ETS表时, 要求两个必须的参数: 表的名称, 以及一组选项. 在可用的选项中,我们传递了表类型以及其访问规则. 我们选定了<code>:set</code>类型,表示其键在ETS表中是不能重复的.我们还设置了表的访问类型为<code>:protected</code>, 其含义为仅允许<code>创建该表的进程</code>可以对其进行写操作. 但允许所有其他进程对该ETS表进行读操作.</p>
<p>ETS表还可以有名称, 允许我们通过一个给定的名称来访问ETS表.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="symbol">:ets</span>.new(<span class="symbol">:buckets_registry</span>, [<span class="symbol">:named_table</span>])</span><br><span class="line"><span class="symbol">:buckets_registry</span></span><br><span class="line">iex&gt; <span class="symbol">:ets</span>.insert(<span class="symbol">:buckets_registry</span>, &#123;<span class="string">"foo"</span>, <span class="keyword">self</span>&#125;)</span><br><span class="line"><span class="keyword">true</span></span><br><span class="line">iex&gt; <span class="symbol">:ets</span>.lookup(<span class="symbol">:buckets_registry</span>, <span class="string">"foo"</span>)</span><br><span class="line">[&#123;<span class="string">"foo"</span>, <span class="comment">#PID&lt;0.41.0&gt;&#125;]</span></span><br></pre></td></tr></table></figure>
<p>让我们修改<code>KV.Registry</code>使用ETS表. 我们将使用与事件管理器, buckets supervisor相同的技术, 以及传递ETS表名称给<code>start_link</code>. 记住, 与服务器名称一样, 任何知道ETSB表名称的本地进程都可以方位该表.</p>
<p>打开<code>lib/kv/registry.ex</code>, 并修改其实现. 我们在被修改的部分添加了注释, 以标记我们所做的修改.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">KV</span>.<span class="constant">Registry </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">GenServer</span></span><br><span class="line">  <span class="comment">## 客户端 API</span></span><br><span class="line">  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">  启动注册表.</span><br><span class="line">  "</span><span class="string">""</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_link</span>(table, event_manager, buckets, opts \\ []) </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 1. 现在我们期望该表作为参数传递给服务器</span></span><br><span class="line">    <span class="constant">GenServer.</span>start_link(<span class="constant">__MODULE__,</span> &#123;table, event_manager, buckets&#125;, opts)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">  查询存储在`table`中的`name`的bucket pid.</span><br><span class="line">  Returns `&#123;:ok, pid&#125;` if a bucket exists, `:error` otherwise.</span><br><span class="line">  "</span><span class="string">""</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lookup</span>(table, name) </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 2. lookup now expects a table and looks directly into ETS.</span></span><br><span class="line">    <span class="comment">#    No request is sent to the server.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="symbol">:ets</span>.lookup(table, name) <span class="keyword">do</span></span><br><span class="line">      [&#123;^name, bucket&#125;] -&gt; &#123;<span class="symbol">:ok</span>, bucket&#125;</span><br><span class="line">      [] -&gt; <span class="symbol">:error</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">  确保在`server`中有一个与给定的`name`相关的bucket.</span><br><span class="line">  "</span><span class="string">""</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span>(server, name) </span><span class="keyword">do</span></span><br><span class="line">    <span class="constant">GenServer.</span>cast(server, &#123;<span class="symbol">:create</span>, name&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">## 服务器回调</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span>(&#123;table, events, buckets&#125;) </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 3. We have replaced the names HashDict by the ETS table</span></span><br><span class="line">    ets  = <span class="symbol">:ets</span>.new(table, [<span class="symbol">:named_table</span>, <span class="symbol">read_concurrency:</span> <span class="keyword">true</span>])</span><br><span class="line">    refs = <span class="constant">HashDict.</span>new</span><br><span class="line">    &#123;<span class="symbol">:ok</span>, %&#123;<span class="symbol">names:</span> ets, <span class="symbol">refs:</span> refs, <span class="symbol">events:</span> events, <span class="symbol">buckets:</span> buckets&#125;&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># 4. The previous handle_call callback for lookup was removed</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_cast</span>(&#123;<span class="symbol">:create</span>, name&#125;, state) </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 5. Read and write to the ETS table instead of the HashDict</span></span><br><span class="line">    <span class="keyword">case</span> lookup(state.names, name) <span class="keyword">do</span></span><br><span class="line">      &#123;<span class="symbol">:ok</span>, <span class="constant">_pid&#125;</span> -&gt;</span><br><span class="line">        &#123;<span class="symbol">:noreply</span>, state&#125;</span><br><span class="line">      <span class="symbol">:error</span> -&gt;</span><br><span class="line">        &#123;<span class="symbol">:ok</span>, pid&#125; = <span class="constant">KV.Bucket.Supervisor.</span>start_bucket(state.buckets)</span><br><span class="line">        ref = <span class="constant">Process.</span>monitor(pid)</span><br><span class="line">        refs = <span class="constant">HashDict.</span>put(state.refs, ref, name)</span><br><span class="line">        <span class="symbol">:ets</span>.insert(state.names, &#123;name, pid&#125;)</span><br><span class="line">        <span class="constant">GenEvent.</span>sync_notify(state.events, &#123;<span class="symbol">:create</span>, name, pid&#125;)</span><br><span class="line">        &#123;<span class="symbol">:noreply</span>, %&#123;state | <span class="symbol">refs:</span> refs&#125;&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_info</span>(&#123;<span class="symbol">:DOWN</span>, ref, <span class="symbol">:process</span>, pid, <span class="constant">_reason&#125;</span>, state) </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 6. Delete from the ETS table instead of the HashDict</span></span><br><span class="line">    &#123;name, refs&#125; = <span class="constant">HashDict.</span>pop(state.refs, ref)</span><br><span class="line">    <span class="symbol">:ets</span>.delete(state.names, name)</span><br><span class="line">    <span class="constant">GenEvent.</span>sync_notify(state.events, &#123;<span class="symbol">:exit</span>, name, pid&#125;)</span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, %&#123;state | <span class="symbol">refs:</span> refs&#125;&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_info</span>(<span class="constant">_msg,</span> state) </span><span class="keyword">do</span></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, state&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>注意:<br>在修改<code>KV.Registry.lookup/2</code>实现从服务器请求之前, 暂时直接从ETS表中读取, 多进程共享. 这是我们要实现的缓存机制的主要思路.</p>
<p>为了使缓存机制可以工作, 创建的ETS表需要有 <code>:protected</code>(默认), 这样所有的客户端才能够读取,并且仅有<code>KV.Registry</code>进程能够写. 当启动的时候,我们还设置了<code>read_concurrency: true</code>,以优化表在并发读操作场景下的性能.</p>
<p>The changes we have performed above have definitely broken our tests. For starters,<br>there is a new argument we need to pass to <code>KV.Registry.start_link/3</code>. Let’s start amending our tests in <code>test/kv/registry_test.exs</code> by rewriting the <code>setup</code> callback:</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-30T06:45:30.000Z"><a href="/2014/10/30/elixir-defdelegate/">2014-10-30</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/30/elixir-defdelegate/">函数委派</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="函数委派">函数委派</h2><p>可以通过在当前模块中通过<code>defdelegate</code>定义一个函数,并把对该函数的调用委派给<code>目标函数</code>, 一个有用的场景是:</p>
<ul>
<li>把特定应用需要调用的底层模块的函数,封装到一个单独的应用模块中.</li>
</ul>
<p>下图是<code>defdelegate</code>在Elixir内核中的<a href="http://elixir-lang.org/docs/stable/elixir/Kernel.html#defdelegate/2" target="_blank" rel="external">定义</a></p>
<p><img src="/assets/images/elixir-defdelegate.png" alt="`defdelegate`在Elixir内核中的定义"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-25T07:59:06.000Z"><a href="/2014/10/25/elixir-collect-user-input/">2014-10-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/25/elixir-collect-user-input/">收集用户输入</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>在控制台程序中收集用户的输入</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取用户名</span></span><br><span class="line"><span class="variable">input_username =</span> IO.gets(<span class="string">"Please input your username: "</span>)</span><br><span class="line"><span class="variable">username =</span> String.strip(input)</span><br><span class="line"><span class="variable">first =</span> String.first(username)</span><br><span class="line"><span class="comment"># 获取年龄</span></span><br><span class="line"><span class="variable">input_age =</span> IO.gets(<span class="string">"Please input your age:"</span>)</span><br><span class="line"><span class="variable">age_str =</span> String.strip(input_age)</span><br><span class="line"><span class="variable">age =</span> String.to_integer(age_str)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-24T08:47:07.000Z"><a href="/2014/10/24/ejabberd-client-disconnect-by-kill/">2014-10-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/24/ejabberd-client-disconnect-by-kill/">Ejabberd客户连接状态变化的服务器日志分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>客户端进程被杀掉的服务器连接处理日志</p>

<!--￼0-->


<p>客户端正常退出,服务器会收到一个流关闭标记<code>&lt;/stream:stream&gt;</code>(下图右侧第一行日志), 而客户端被杀死收到不到流关闭标记(左侧).<br>还未分析客户端连接超时或断开的情况.</p>
<p><img src="/assets/images/CA275FA1-0736-445C-AFA1-959C88A4EA33.png" alt="客户端正常退出和网络突然断开,服务器日志对比"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-24T02:56:12.000Z"><a href="/2014/10/24/elixir-learn-in-n-minutes/">2014-10-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/24/elixir-learn-in-n-minutes/">N分钟学习Elixir</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#注释"><span class="toc-number">1.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本类型"><span class="toc-number">2.</span> <span class="toc-text">基本类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#操作符"><span class="toc-number">3.</span> <span class="toc-text">操作符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#控制流"><span class="toc-number">4.</span> <span class="toc-text">控制流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模块和函数"><span class="toc-number">5.</span> <span class="toc-text">模块和函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结构和异常"><span class="toc-number">6.</span> <span class="toc-text">结构和异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#并发"><span class="toc-number">7.</span> <span class="toc-text">并发</span></a></li></ol>
        </div>
        


        <p>获取代码: <a href="http://learnxinyminutes.com/docs/files/learnelixir.ex" target="_blank" rel="external">learnelixir.ex</a></p>
<p>Elixir 是构建在Erlang虚拟机上的现代函数编程语言.完全和Erlang兼容,对很多标准语法进行了扩展,并提供了更多的功能.</p>
<p>翻译了一部分发现,已经有中文版了, <a href="http://learnxinyminutes.com/docs/zh-cn/elixir-cn" target="_blank" rel="external">在这里</a></p>
<h2 id="注释">注释</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 单行注释以一个#号开始.</span></span><br><span class="line"><span class="preprocessor"># 没有多行注释,但可以注释多行.</span></span><br><span class="line"><span class="preprocessor"># 要使用elixir shell使用`iex`命令.</span></span><br><span class="line"><span class="preprocessor"># 编译模块使用`elixirc`命令.</span></span><br><span class="line"><span class="preprocessor"># 如果elixir正确安装,应该都在PATH中.</span></span><br></pre></td></tr></table></figure>
<h2 id="基本类型">基本类型</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这些是数字</span></span><br><span class="line"><span class="number">3</span>    <span class="comment"># 整数</span></span><br><span class="line"><span class="number">0x1F</span> <span class="comment"># 整数</span></span><br><span class="line"><span class="number">3.0</span>  <span class="comment"># 浮点数</span></span><br><span class="line"><span class="comment"># Atoms, that are literals, a constant with name. They start with `:`.</span></span><br><span class="line"><span class="comment"># 原子,是字面的,一个命名常量. 以`:`开始.</span></span><br><span class="line"><span class="symbol">:hello</span> <span class="comment"># atom</span></span><br><span class="line"><span class="comment"># 元组在内存中是连续地存储的</span></span><br><span class="line">&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125; <span class="comment"># tuple</span></span><br><span class="line"><span class="comment"># 可以使用`elem`函数访问一个元组中的元素</span></span><br><span class="line">elem(&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;, <span class="number">0</span>) <span class="comment">#=&gt; 1</span></span><br><span class="line"><span class="comment"># Lists that are implemented as linked lists.</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment"># list</span></span><br><span class="line"><span class="comment"># We can access the head and tail of a list as follows:</span></span><br><span class="line">[head | tail] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">head <span class="comment">#=&gt; 1</span></span><br><span class="line">tail <span class="comment">#=&gt; [2,3]</span></span><br><span class="line"><span class="comment"># In elixir, just like in Erlang, the `=` denotes pattern matching and</span></span><br><span class="line"><span class="comment"># not an assignment.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This means that the left-hand side (pattern) is matched against a</span></span><br><span class="line"><span class="comment"># right-hand side.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This is how the above example of accessing the head and tail of a list works.</span></span><br><span class="line"><span class="comment"># A pattern match will error when the sides don't match, in this example</span></span><br><span class="line"><span class="comment"># the tuples have different sizes.</span></span><br><span class="line"><span class="comment"># &#123;a, b, c&#125; = &#123;1, 2&#125; #=&gt; ** (MatchError) no match of right hand side value: &#123;1,2&#125;</span></span><br><span class="line"><span class="comment"># There are also binaries</span></span><br><span class="line">&lt;&lt;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&gt;&gt; <span class="comment"># binary</span></span><br><span class="line"><span class="comment"># Strings and char lists</span></span><br><span class="line"><span class="string">"hello"</span> <span class="comment"># string</span></span><br><span class="line"><span class="string">'hello'</span> <span class="comment"># char list</span></span><br><span class="line"><span class="comment"># Multi-line strings</span></span><br><span class="line"><span class="string">""</span><span class="string">"</span><br><span class="line">I'm a multi-line</span><br><span class="line">string.</span><br><span class="line">"</span><span class="string">""</span></span><br><span class="line"><span class="comment">#=&gt; "I'm a multi-line\nstring.\n"</span></span><br><span class="line"><span class="comment"># Strings are all encoded in UTF-8:</span></span><br><span class="line"><span class="string">"héllò"</span> <span class="comment">#=&gt; "héllò"</span></span><br><span class="line"><span class="comment"># Strings are really just binaries, and char lists are just lists.</span></span><br><span class="line">&lt;&lt;?a, ?b, ?c&gt;&gt; <span class="comment">#=&gt; "abc"</span></span><br><span class="line">[?a, ?b, ?c]   <span class="comment">#=&gt; 'abc'</span></span><br><span class="line"><span class="comment"># `?a` in elixir returns the ASCII integer for the letter `a`</span></span><br><span class="line">?a <span class="comment">#=&gt; 97</span></span><br><span class="line"><span class="comment"># To concatenate lists use `++`, for binaries use `&lt;&gt;`</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] ++ [<span class="number">4</span>,<span class="number">5</span>]     <span class="comment">#=&gt; [1,2,3,4,5]</span></span><br><span class="line"><span class="string">'hello '</span> ++ <span class="string">'world'</span>  <span class="comment">#=&gt; 'hello world'</span></span><br><span class="line">&lt;&lt;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&gt;&gt; &lt;&gt; &lt;&lt;<span class="number">4</span>,<span class="number">5</span>&gt;&gt; <span class="comment">#=&gt; &lt;&lt;1,2,3,4,5&gt;&gt;</span></span><br><span class="line"><span class="string">"hello "</span> &lt;&gt; <span class="string">"world"</span>  <span class="comment">#=&gt; "hello world"</span></span><br></pre></td></tr></table></figure>
<h2 id="操作符">操作符</h2><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># <span class="type">Some</span> math</span><br><span class="line"><span class="number">1</span> + <span class="number">1</span>  #=&gt; <span class="number">2</span></span><br><span class="line"><span class="number">10</span> - <span class="number">5</span> #=&gt; <span class="number">5</span></span><br><span class="line"><span class="number">5</span> * <span class="number">2</span>  #=&gt; <span class="number">10</span></span><br><span class="line"><span class="number">10</span> / <span class="number">2</span> #=&gt; <span class="number">5.0</span></span><br><span class="line"># <span class="type">In</span> elixir the operator `/` always returns a <span class="built_in">float</span>.</span><br><span class="line"># <span class="type">To</span> <span class="keyword">do</span> integer division use `div`</span><br><span class="line">div(<span class="number">10</span>, <span class="number">2</span>) #=&gt; <span class="number">5</span></span><br><span class="line"># <span class="type">To</span> get the division remainder use `rem`</span><br><span class="line">rem(<span class="number">10</span>, <span class="number">3</span>) #=&gt; <span class="number">1</span></span><br><span class="line"># <span class="type">There</span> are also boolean operators: `<span class="keyword">or</span>`, `<span class="keyword">and</span>` <span class="keyword">and</span> `not`.</span><br><span class="line"># <span class="type">These</span> operators expect a boolean <span class="keyword">as</span> their first argument.</span><br><span class="line"><span class="literal">true</span> <span class="keyword">and</span> <span class="literal">true</span> #=&gt; <span class="literal">true</span></span><br><span class="line"><span class="literal">false</span> <span class="keyword">or</span> <span class="literal">true</span> #=&gt; <span class="literal">true</span></span><br><span class="line"># <span class="number">1</span> <span class="keyword">and</span> <span class="literal">true</span>    #=&gt; ** (<span class="type">ArgumentError</span>) argument error</span><br><span class="line"># <span class="type">Elixir</span> also provides `||`, `&amp;&amp;` <span class="keyword">and</span> `!` which accept arguments <span class="keyword">of</span> any <span class="keyword">type</span>.</span><br><span class="line"># <span class="type">All</span> values except `<span class="literal">false</span>` <span class="keyword">and</span> `nil` will evaluate <span class="keyword">to</span> <span class="literal">true</span>.</span><br><span class="line"><span class="number">1</span> || <span class="literal">true</span>  #=&gt; <span class="number">1</span></span><br><span class="line"><span class="literal">false</span> &amp;&amp; <span class="number">1</span> #=&gt; <span class="literal">false</span></span><br><span class="line">nil &amp;&amp; <span class="number">20</span>  #=&gt; nil</span><br><span class="line">!<span class="literal">true</span> #=&gt; <span class="literal">false</span></span><br><span class="line"># <span class="type">For</span> comparisons we have: `==`, `!=`, `===`, `!==`, `&lt;=`, `&gt;=`, `&lt;` <span class="keyword">and</span> `&gt;`</span><br><span class="line"><span class="number">1</span> == <span class="number">1</span> #=&gt; <span class="literal">true</span></span><br><span class="line"><span class="number">1</span> != <span class="number">1</span> #=&gt; <span class="literal">false</span></span><br><span class="line"><span class="number">1</span> &lt; <span class="number">2</span>  #=&gt; <span class="literal">true</span></span><br><span class="line"># `===` <span class="keyword">and</span> `!==` are more strict <span class="keyword">when</span> comparing integers <span class="keyword">and</span> floats:</span><br><span class="line"><span class="number">1</span> == <span class="number">1.0</span>  #=&gt; <span class="literal">true</span></span><br><span class="line"><span class="number">1</span> === <span class="number">1.0</span> #=&gt; <span class="literal">false</span></span><br><span class="line"># <span class="type">We</span> can also compare two different data types:</span><br><span class="line"><span class="number">1</span> &lt; :hello #=&gt; <span class="literal">true</span></span><br><span class="line"># <span class="type">The</span> overall sorting order is defined below:</span><br><span class="line"># number &lt; atom &lt; reference &lt; functions &lt; port &lt; pid &lt; tuple &lt; <span class="built_in">list</span> &lt; bit <span class="built_in">string</span></span><br><span class="line"># <span class="type">To</span> quote <span class="type">Joe</span> <span class="type">Armstrong</span> on this: <span class="string">"The actual order is not important,</span><br><span class="line"># but that a total ordering is well defined is important."</span></span><br></pre></td></tr></table></figure>
<h2 id="控制流">控制流</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `if` expression</span></span><br><span class="line">if <span class="keyword">false</span> <span class="keyword">do</span></span><br><span class="line">  <span class="string">"This will never be seen"</span></span><br><span class="line">else</span><br><span class="line">  <span class="string">"This will"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># There's also `unless`</span></span><br><span class="line"><span class="keyword">unless</span> <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">  <span class="string">"This will never be seen"</span></span><br><span class="line">else</span><br><span class="line">  <span class="string">"This will"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># Remember pattern matching? Many control-flow structures in elixir rely on it.</span></span><br><span class="line"><span class="comment"># `case` allows us to compare a value against many patterns:</span></span><br><span class="line"><span class="keyword">case</span> &#123;<span class="symbol">:one</span>, <span class="symbol">:two</span>&#125; <span class="keyword">do</span></span><br><span class="line">  &#123;<span class="symbol">:four</span>, <span class="symbol">:five</span>&#125; -&gt;</span><br><span class="line">    <span class="string">"This won't match"</span></span><br><span class="line">  &#123;<span class="symbol">:one</span>, x&#125; -&gt;</span><br><span class="line">    <span class="string">"This will match and bind `x` to `:two`"</span></span><br><span class="line">  <span class="constant">_ </span>-&gt;</span><br><span class="line">    <span class="string">"This will match any value"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># It's common to bind the value to `_` if we don't need it.</span></span><br><span class="line"><span class="comment"># For example, if only the head of a list matters to us:</span></span><br><span class="line">[head | <span class="constant">_]</span> = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">head <span class="comment">#=&gt; 1</span></span><br><span class="line"><span class="comment"># For better readability we can do the following:</span></span><br><span class="line">[head | <span class="constant">_tail]</span> = [<span class="symbol">:a</span>, <span class="symbol">:b</span>, <span class="symbol">:c</span>]</span><br><span class="line">head <span class="comment">#=&gt; :a</span></span><br><span class="line"><span class="comment"># `cond` lets us check for many conditions at the same time.</span></span><br><span class="line"><span class="comment"># Use `cond` instead of nesting many `if` expressions.</span></span><br><span class="line"><span class="keyword">cond</span> <span class="keyword">do</span></span><br><span class="line">  <span class="number">1</span> + <span class="number">1</span> == <span class="number">3</span> -&gt;</span><br><span class="line">    <span class="string">"I will never be seen"</span></span><br><span class="line">  <span class="number">2</span> * <span class="number">5</span> == <span class="number">12</span> -&gt;</span><br><span class="line">    <span class="string">"Me neither"</span></span><br><span class="line">  <span class="number">1</span> + <span class="number">2</span> == <span class="number">3</span> -&gt;</span><br><span class="line">    <span class="string">"But I will"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># It is common to see the last condition equal to `true`, which will always match.</span></span><br><span class="line"><span class="keyword">cond</span> <span class="keyword">do</span></span><br><span class="line">  <span class="number">1</span> + <span class="number">1</span> == <span class="number">3</span> -&gt;</span><br><span class="line">    <span class="string">"I will never be seen"</span></span><br><span class="line">  <span class="number">2</span> * <span class="number">5</span> == <span class="number">12</span> -&gt;</span><br><span class="line">    <span class="string">"Me neither"</span></span><br><span class="line">  <span class="keyword">true</span> -&gt;</span><br><span class="line">    <span class="string">"But I will (this is essentially an else)"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># `try/catch` is used to catch values that are thrown, it also supports an</span></span><br><span class="line"><span class="comment"># `after` clause that is invoked whether or not a value is caught.</span></span><br><span class="line">try <span class="keyword">do</span></span><br><span class="line">  throw(<span class="symbol">:hello</span>)</span><br><span class="line">catch</span><br><span class="line">  message -&gt; <span class="string">"Got <span class="subst">#&#123;message&#125;</span>."</span></span><br><span class="line">after</span><br><span class="line">  <span class="constant">IO.</span>puts(<span class="string">"I'm the after clause."</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">#=&gt; I'm the after clause</span></span><br><span class="line"><span class="comment"># "Got :hello"</span></span><br></pre></td></tr></table></figure>
<h2 id="模块和函数">模块和函数</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Anonymous functions (notice the dot)</span></span><br><span class="line">square = <span class="keyword">fn</span>(x) -&gt; x * x <span class="keyword">end</span></span><br><span class="line">square.(<span class="number">5</span>) <span class="comment">#=&gt; 25</span></span><br><span class="line"><span class="comment"># They also accept many clauses and guards.</span></span><br><span class="line"><span class="comment"># Guards let you fine tune pattern matching,</span></span><br><span class="line"><span class="comment"># they are indicated by the `when` keyword:</span></span><br><span class="line">f = <span class="keyword">fn</span></span><br><span class="line">  x, y <span class="keyword">when</span> x &gt; <span class="number">0</span> -&gt; x + y</span><br><span class="line">  x, y -&gt; x * y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">f.(<span class="number">1</span>, <span class="number">3</span>)  <span class="comment">#=&gt; 4</span></span><br><span class="line">f.(-<span class="number">1</span>, <span class="number">3</span>) <span class="comment">#=&gt; -3</span></span><br><span class="line"><span class="comment"># Elixir also provides many built-in functions.</span></span><br><span class="line"><span class="comment"># These are available in the current scope.</span></span><br><span class="line">is_number(<span class="number">10</span>)    <span class="comment">#=&gt; true</span></span><br><span class="line">is_list(<span class="string">"hello"</span>) <span class="comment">#=&gt; false</span></span><br><span class="line">elem(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;, <span class="number">0</span>) <span class="comment">#=&gt; 1</span></span><br><span class="line"><span class="comment"># You can group several functions into a module. Inside a module use `def`</span></span><br><span class="line"><span class="comment"># to define your functions.</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Math</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sum</span>(a, b) </span><span class="keyword">do</span></span><br><span class="line">    a + b</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">square</span>(x) </span><span class="keyword">do</span></span><br><span class="line">    x * x</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="constant">Math.</span>sum(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment">#=&gt; 3</span></span><br><span class="line"><span class="constant">Math.</span>square(<span class="number">3</span>) <span class="comment">#=&gt; 9</span></span><br><span class="line"><span class="comment"># To compile our simple Math module save it as `math.ex` and use `elixirc`</span></span><br><span class="line"><span class="comment"># in your terminal: elixirc math.ex</span></span><br><span class="line"><span class="comment"># Inside a module we can define functions with `def` and private functions with `defp`.</span></span><br><span class="line"><span class="comment"># A function defined with `def` is available to be invoked from other modules,</span></span><br><span class="line"><span class="comment"># a private function can only be invoked locally.</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">PrivateMath</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sum</span>(a, b) </span><span class="keyword">do</span></span><br><span class="line">    do_sum(a, b)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  defp do_sum(a, b) <span class="keyword">do</span></span><br><span class="line">    a + b</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="constant">PrivateMath.</span>sum(<span class="number">1</span>, <span class="number">2</span>)    <span class="comment">#=&gt; 3</span></span><br><span class="line"><span class="comment"># PrivateMath.do_sum(1, 2) #=&gt; ** (UndefinedFunctionError)</span></span><br><span class="line"><span class="comment"># Function declarations also support guards and multiple clauses:</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Geometry</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">area</span>(&#123;<span class="symbol">:rectangle</span>, w, h&#125;) </span><span class="keyword">do</span></span><br><span class="line">    w * h</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">area</span>(&#123;<span class="symbol">:circle</span>, r&#125;) <span class="keyword">when</span> is_number(r) </span><span class="keyword">do</span></span><br><span class="line">    <span class="number">3.14</span> * r * r</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="constant">Geometry.</span>area(&#123;<span class="symbol">:rectangle</span>, <span class="number">2</span>, <span class="number">3</span>&#125;) <span class="comment">#=&gt; 6</span></span><br><span class="line"><span class="constant">Geometry.</span>area(&#123;<span class="symbol">:circle</span>, <span class="number">3</span>&#125;)       <span class="comment">#=&gt; 28.25999999999999801048</span></span><br><span class="line"><span class="comment"># Geometry.area(&#123;:circle, "not_a_number"&#125;)</span></span><br><span class="line"><span class="comment">#=&gt; ** (FunctionClauseError) no function clause matching in Geometry.area/1</span></span><br><span class="line"><span class="comment"># Due to immutability, recursion is a big part of elixir</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Recursion</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sum_list</span>([head | tail], acc) </span><span class="keyword">do</span></span><br><span class="line">    sum_list(tail, acc + head)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sum_list</span>([], acc) </span><span class="keyword">do</span></span><br><span class="line">    acc</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="constant">Recursion.</span>sum_list([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="number">0</span>) <span class="comment">#=&gt; 6</span></span><br><span class="line"><span class="comment"># Elixir modules support attributes, there are built-in attributes and you</span></span><br><span class="line"><span class="comment"># may also add custom ones.</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">MyMod</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="variable">@moduledoc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">  This is a built-in attribute on a example module.</span><br><span class="line">  "</span><span class="string">""</span></span><br><span class="line">  <span class="variable">@my_data</span> <span class="number">100</span> <span class="comment"># This is a custom attribute.</span></span><br><span class="line">  <span class="constant">IO.</span>inspect(<span class="variable">@my_data</span>) <span class="comment">#=&gt; 100</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="结构和异常">结构和异常</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Structs are extensions on top of maps that bring default values,</span></span><br><span class="line"><span class="comment"># compile-time guarantees and polymorphism into Elixir.</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Person</span> </span><span class="keyword">do</span></span><br><span class="line">  defstruct <span class="symbol">name:</span> <span class="keyword">nil</span>, <span class="symbol">age:</span> <span class="number">0</span>, <span class="symbol">height:</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">joe_info = %<span class="constant">Person&#123;</span> <span class="symbol">name:</span> <span class="string">"Joe"</span>, <span class="symbol">age:</span> <span class="number">30</span>, <span class="symbol">height:</span> <span class="number">180</span> &#125;</span><br><span class="line"><span class="comment">#=&gt; %Person&#123;age: 30, height: 180, name: "Joe"&#125;</span></span><br><span class="line"><span class="comment"># Access the value of name</span></span><br><span class="line">joe_info.name <span class="comment">#=&gt; "Joe"</span></span><br><span class="line"><span class="comment"># Update the value of age</span></span><br><span class="line">older_joe_info = %&#123; joe_info | <span class="symbol">age:</span> <span class="number">31</span> &#125;</span><br><span class="line"><span class="comment">#=&gt; %Person&#123;age: 31, height: 180, name: "Joe"&#125;</span></span><br><span class="line"><span class="comment"># The `try` block with the `rescue` keyword is used to handle exceptions</span></span><br><span class="line">try <span class="keyword">do</span></span><br><span class="line">  raise <span class="string">"some error"</span></span><br><span class="line">rescue</span><br><span class="line">  <span class="constant">RuntimeError </span>-&gt; <span class="string">"rescued a runtime error"</span></span><br><span class="line">  <span class="constant">_error </span>-&gt; <span class="string">"this will rescue any error"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># All exceptions have a message</span></span><br><span class="line">try <span class="keyword">do</span></span><br><span class="line">  raise <span class="string">"some error"</span></span><br><span class="line">rescue</span><br><span class="line">  x <span class="keyword">in</span> [<span class="constant">RuntimeError]</span> -&gt;</span><br><span class="line">    x.message</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="并发">并发</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elixir relies on the actor model for concurrency. All we need to write</span></span><br><span class="line"><span class="comment"># concurrent programs in elixir are three primitives: spawning processes,</span></span><br><span class="line"><span class="comment"># sending messages and receiving messages.</span></span><br><span class="line"><span class="comment"># To start a new process we use the `spawn` function, which takes a function</span></span><br><span class="line"><span class="comment"># as argument.</span></span><br><span class="line">f = <span class="keyword">fn</span> -&gt; <span class="number">2</span> * <span class="number">2</span> <span class="keyword">end</span> <span class="comment">#=&gt; #Function&lt;erl_eval.20.80484245&gt;</span></span><br><span class="line">spawn(f) <span class="comment">#=&gt; #PID&lt;0.40.0&gt;</span></span><br><span class="line"><span class="comment"># `spawn` returns a pid (process identifier), you can use this pid to send</span></span><br><span class="line"><span class="comment"># messages to the process. To do message passing we use the `send` operator.</span></span><br><span class="line"><span class="comment"># For all of this to be useful we need to be able to receive messages. This is</span></span><br><span class="line"><span class="comment"># achieved with the `receive` mechanism:</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Geometry</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">area_loop</span> </span><span class="keyword">do</span></span><br><span class="line">    receive <span class="keyword">do</span></span><br><span class="line">      &#123;<span class="symbol">:rectangle</span>, w, h&#125; -&gt;</span><br><span class="line">        <span class="constant">IO.</span>puts(<span class="string">"Area = <span class="subst">#&#123;w * h&#125;</span>"</span>)</span><br><span class="line">        area_loop()</span><br><span class="line">      &#123;<span class="symbol">:circle</span>, r&#125; -&gt;</span><br><span class="line">        <span class="constant">IO.</span>puts(<span class="string">"Area = <span class="subst">#&#123;<span class="number">3.14</span> * r * r&#125;</span>"</span>)</span><br><span class="line">        area_loop()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># Compile the module and create a process that evaluates `area_loop` in the shell</span></span><br><span class="line">pid = spawn(<span class="keyword">fn</span> -&gt; <span class="constant">Geometry.</span>area_loop() <span class="keyword">end</span>) <span class="comment">#=&gt; #PID&lt;0.40.0&gt;</span></span><br><span class="line"><span class="comment"># Send a message to `pid` that will match a pattern in the receive statement</span></span><br><span class="line">send pid, &#123;<span class="symbol">:rectangle</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"><span class="comment">#=&gt; Area = 6</span></span><br><span class="line"><span class="comment">#   &#123;:rectangle,2,3&#125;</span></span><br><span class="line">send pid, &#123;<span class="symbol">:circle</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">#=&gt; Area = 12.56000000000000049738</span></span><br><span class="line"><span class="comment">#   &#123;:circle,2&#125;</span></span><br><span class="line"><span class="comment"># The shell is also a process, you can use `self` to get the current pid</span></span><br><span class="line"><span class="keyword">self</span>() <span class="comment">#=&gt; #PID&lt;0.27.0&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-23T09:30:27.000Z"><a href="/2014/10/23/elixir-base64/">2014-10-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/23/elixir-base64/">Base64编码</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/AA9701C5-0427-45AF-88CE-CB0DA1183FAB.png" alt="Elixir base64 和url,文件名安全的base64字母表"></p>
<p>一般性的Base64编码包含<code>+</code>,<code>/</code>两个符号,但是这两个符号在URL中有特殊的含义,因此需要一种方式来避免这两个符号的冲突. 在编码URL地址和文件名的时候分别使用<code>-</code>,<code>_</code>替换这两个符号.</p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://elixir-lang.org/docs/master/elixir/Base.html" target="_blank" rel="external">http://elixir-lang.org/docs/master/elixir/Base.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-23T08:20:32.000Z"><a href="/2014/10/23/erlang-emysql-execute-prepared-statement/">2014-10-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/23/erlang-emysql-execute-prepared-statement/">Emysql 执行预处理语句</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%% 创建一个预处理语句</span><br><span class="line">emysql:prepare(stmt_isbound, &lt;&lt;<span class="string">"SELECT COUNT(sn) FROM online_users WHERE sn = ? AND jid = ?"</span>&gt;&gt;),</span><br><span class="line">%% 执行预处理语句</span><br><span class="line">&#123;_, _, _, <span class="string">[[Rows]]</span>, _&#125; = emysql:execute(pool_gbox_messager, stmt_isbound, [Sn, Jid]),</span><br><span class="line">?INFO_MSG(<span class="string">"COUNT: ~p~n"</span>, [Rows])</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-21T07:59:04.000Z"><a href="/2014/10/21/ejabberd-reload-modified-modules-dynamically/">2014-10-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/21/ejabberd-reload-modified-modules-dynamically/">Ejabberd动态的重新加载(更新)修改的模块</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">1.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过Web更新模块代码"><span class="toc-number">2.</span> <span class="toc-text">通过Web更新模块代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bugfix"><span class="toc-number">3.</span> <span class="toc-text">Bugfix</span></a></li></ol>
        </div>
        


        <p>有时候我们不想停止ejabberd服务,同时能够更新我们的自定义模块,ejabberd已经为我们提供了这样一个功能.通过使用ejabberd的<code>ejabberd_update</code>核心模块, 我们可以在<code>运行时重新加载</code>我们的模块新代码.</p>
<p>ejabberd_update核心模块为我们提供了如下三个导出的接口函数:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-export([</span><br><span class="line">    %% <span class="operator"><span class="keyword">Update</span> <span class="keyword">all</span> the modified modules</span><br><span class="line">    <span class="keyword">update</span>/<span class="number">0</span>,</span><br><span class="line">    %% <span class="keyword">Update</span> <span class="keyword">only</span> the specified modules</span><br><span class="line">    <span class="keyword">update</span>/<span class="number">1</span>,</span><br><span class="line">    %% <span class="keyword">Get</span> information about the modified modules</span><br><span class="line">    update_info/<span class="number">0</span></span><br><span class="line">]).</span></span><br></pre></td></tr></table></figure>
<h2 id="示例">示例</h2><p>该示例假设你已经搭建好了Ejabberd的开发环境,如果还未搭建号开发环境,请完成开发环境的搭建.</p>
<ul>
<li>首先停止ejabberd</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ejabberdctl</span> stop</span><br></pre></td></tr></table></figure>
<ul>
<li>启动到<code>live</code>模式</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ejabberdctl</span> live</span><br></pre></td></tr></table></figure>
<ul>
<li>更新一个模块文件/编译/安装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure>
<ul>
<li>查看需要更新的模块列表</li>
</ul>
<p>打开一个新的终端执行,查看哪些模块代码需要更新</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@bffd81e6215e</span><span class="symbol">:~/ejabberd</span><span class="comment"># ejabberdctl update_list</span></span><br><span class="line">mod_gbox_messager</span><br></pre></td></tr></table></figure>
<p>我们看到,update_list命令列出了我们需要更新的模块<code>mod_gbox_messager</code></p>
<ul>
<li>切换到live模式的窗口执行</li>
</ul>
<p>为了清晰,下面的输出通过手工格式化</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(ejabberd<span class="annotation">@localhost</span>)<span class="number">2</span>&gt; <span class="string">ejabberd_update:</span>update().</span><br><span class="line"><span class="number">07</span>:<span class="number">57</span>:<span class="number">08.491</span> [debug] beam <span class="string">files:</span> [mod_gbox_messager]</span><br><span class="line"><span class="number">07</span>:<span class="number">57</span>:<span class="number">08.492</span> [debug] <span class="string">script:</span> [&#123;load_module,mod_gbox_messager&#125;]</span><br><span class="line"><span class="number">07</span>:<span class="number">57</span>:<span class="number">08.492</span> [debug] low level <span class="string">script:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">        load_object_code,</span><br><span class="line">        &#123;</span><br><span class="line">            ejabberd,[],[mod_gbox_messager]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    point_of_no_return,&#123;</span><br><span class="line">        load,&#123;</span><br><span class="line">            mod_gbox_messager,</span><br><span class="line">            brutal_purge,brutal_purge</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="number">07</span>:<span class="number">57</span>:<span class="number">08.492</span> [debug] <span class="string">check:</span> &#123;ok,[]&#125;</span><br><span class="line"><span class="number">07</span>:<span class="number">57</span>:<span class="number">08.497</span> [debug] <span class="string">eval:</span> &#123;ok,[]&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取更新信息</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(ejabberd<span class="annotation">@localhost</span>)<span class="number">4</span>&gt; <span class="string">ejabberd_update:</span>update_info().</span><br><span class="line"><span class="number">08</span>:<span class="number">25</span>:<span class="number">24.357</span> [debug] beam <span class="string">files:</span> [mod_gbox_messager]</span><br><span class="line"><span class="number">08</span>:<span class="number">25</span>:<span class="number">24.358</span> [debug] <span class="string">script:</span> [&#123;load_module,mod_gbox_messager&#125;]</span><br><span class="line"><span class="number">08</span>:<span class="number">25</span>:<span class="number">24.358</span> [debug] low level <span class="string">script:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">        load_object_code,</span><br><span class="line">        &#123;ejabberd,[],[mod_gbox_messager]&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    point_of_no_return,</span><br><span class="line">    &#123;load,&#123;mod_gbox_messager,brutal_purge,brutal_purge&#125;&#125;</span><br><span class="line">]</span><br><span class="line"><span class="number">08</span>:<span class="number">25</span>:<span class="number">24.358</span> [debug] <span class="string">check:</span> &#123;ok,[]&#125;</span><br><span class="line">&#123;</span><br><span class="line">    ok,</span><br><span class="line">    <span class="string">"/lib/ejabberd/ebin"</span>,</span><br><span class="line">    [mod_gbox_messager],</span><br><span class="line">    [&#123;load_module,mod_gbox_messager&#125;],</span><br><span class="line">    [</span><br><span class="line">        &#123;load_object_code,&#123;ejabberd,[],[mod_gbox_messager]&#125;&#125;,</span><br><span class="line">        point_of_no_return,</span><br><span class="line">        &#123;load,&#123;mod_gbox_messager,brutal_purge,brutal_purge&#125;&#125;</span><br><span class="line">    ],</span><br><span class="line">    ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_update:update_info()</code>返回一个元组,其中包含了beam文件的位置<code>/lib/ejabberd/ebin</code>, 要加载的模块列表<code>[{load_module,mod_gbox_messager}]</code>等, 我们可以在我们的HTTP模块代码中使用,比如:</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 打印需要更新的模块</span></span><br><span class="line"><span class="function_or_atom">print_modules</span>() <span class="arrow">-&gt;</span></span><br><span class="line">    &#123;<span class="ok">ok</span>,_<span class="variable">Ebin</span>,<span class="variable">Modules</span>,_,_,_&#125; = <span class="function_or_atom">ejabberd_update:update_info</span>,</span><br><span class="line">    <span class="constant">?INFO_MSG</span>(<span class="string">"modules to update: ~p~n"</span>, [<span class="variable">Modules</span>]).</span><br></pre></td></tr></table></figure>
<h2 id="通过Web更新模块代码">通过Web更新模块代码</h2><p>开发一个Ejabberd的HTTP模块,(如何开发Ejabberd的HTTP模块,请参考 <a href="/2014/09/18/ejabberd-http-module">开发一个Ejabberd HTTP模块</a>) 并通过RESTFul接口动态地更新模块代码</p>
<p>下面我们来定义两个RESTFul服务的端点</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="string">http:</span><span class="comment">//localhost/update-modules/all</span></span><br><span class="line">POST <span class="string">http:</span><span class="comment">//localhost/update-modules</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一个端点用于更新所有已修改的模块</li>
<li>第二个端点用于更新特定的模块列表,POST的数据格式采用JSON</li>
</ul>
<p>为了能在HTTP模块中解码JSON数据,这里用到了Jiffy模块用于处理JSON数据的encode/decode操作. 关于Jiffy的使用,可参考 <a href="/2014/09/28/ejabberd-jiffy">Ejabberd中用Jiffy输出JSON数据</a>,有了这样一个功能,我们可以开发Ejabberd的自定义的HTTP模块通过Web动态地更新我们的模块.</p>
<p>如果更新成功<code>ejabberd_update:update/0</code>会返回<code>{ok,[]}</code>,可依据此判断更新过程是否成功,并返回JSON消息通知客户端更新结果.</p>
<h2 id="Bugfix">Bugfix</h2><ul>
<li>2014-10-23</li>
</ul>
<p><code>ejabberdctl live</code>启动后是没有加载<code>ejabberd_update</code>模块的, 需要执行ejabberdctl加载一次<code>ejabberd_update</code>模块, 如果是通过程序调用更新,调用时会自动加载更新模块. 所以要先执行一个<code>ejabberdctl update_list</code>手工初始化<code>ejabberd_update</code>模块.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-20T16:46:02.000Z"><a href="/2014/10/21/programming-erlang-2nd-ch11/">2014-10-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/21/programming-erlang-2nd-ch11/">Erlang程序模型,我们是怎么思考和交互的</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>我们没有共享的记忆(memory),我有我的记忆,你有你的. 我们有两个大脑,每人一个. 它们并没有相连. 要修改你的记忆,我发送一个消息给你: 我给你说,或我挥一挥手.</p>
<p>你听着,你看着,你的记忆在改变;但我们并没有问你问题或者观察你的反应,我不知道你收到了我的消息.</p>
<p>这就是Erlang进程的工作方式. Erlang进程没有共享内存. 每一个进程有它自己的内存. 要改变其他进程的内存,你必须给它发消息,并期望它能收到并理解消息.</p>
<p>为了确认另一个进程收到了你的消息,并且改变了它的内存,你必须问它(通过发送消息给它). 这正是我们的交互方式:</p>
<p>我: 嘿,亲爱的,我的电话号码是138-1234-1234.<br>我: 你记住了么?<br>她: 记住了,你的号码是 138-1234-1234</p>
<p>这个交互模式对我们来说是众所周知的.</p>
<p>从出生开始,我们通过观察学习与这个世界交互,给这个世界发出消息,并观察其反应.</p>
<blockquote>
<p>人们作为独立的个体依靠消息通信.</p>
</blockquote>
<p>这就是Erlang进程的工作模式,这也是我们的工作模式,因此,理解一个Erlang程序就变得容易了.</p>
<p>一个Erlang程序也许由十几个,或成百上千的细小的进程组成. 所有这些进程都独立的运行,它们之间依靠收发消息通信.每一个进程都有私有的内存. 这就像在一个超大的房间内所有人在相互交谈一样.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-17T03:35:17.000Z"><a href="/2014/10/17/erlang-stdlib-lists/">2014-10-17</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/17/erlang-stdlib-lists/">Erlang标准库示例 lists</a></h1>
  

    </header>
    <div class="entry">
      


        


        <blockquote>
<h2 id="keysearch(Key,_N,_TupleList)_-&gt;_{value,_Tuple}_|_false">keysearch(Key, N, TupleList) -&gt; {value, Tuple} | false</h2></blockquote>
<p>Types:</p>
<pre><code>Key = <span class="function"><span class="title">term</span><span class="params">()</span></span>
N = <span class="function"><span class="title">integer</span><span class="params">()</span></span> &gt;= <span class="number">1</span>
<span class="number">1</span>..<span class="function"><span class="title">tuple_size</span><span class="params">(Tuple)</span></span>
TupleList = [Tuple]
Tuple = <span class="function"><span class="title">tuple</span><span class="params">()</span></span>
</code></pre><p>在一个元组列表中搜索, 列表中元组的第<code>N</code>个元素等于<code>Key</code>时返回 <code>{value, Tuple}</code>,其中<code>Tuple</code>为找到的这个元组. 如果没有找到返回<code>false</code>.</p>
<p>Note<br>    该函数的保留是为了兼容, 使用<code>lists:keyfind/3</code>(R13A引入的一个方法)更加方便.</p>
<blockquote>
<p>例子</p>
</blockquote>
<p><strong>lists:keysearch/3</strong></p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">1&gt; </span><span class="function_or_atom">lists:keysearch</span>(<span class="function_or_atom">mail</span>,<span class="number">1</span>, [&#123;<span class="function_or_atom">username</span>, <span class="string">"13012345678"</span>&#125;, &#123;<span class="function_or_atom">mail</span>, <span class="string">"13012345678@139.com"</span>&#125;, &#123;<span class="function_or_atom">tel</span>, <span class="number">13012345678</span>&#125;]).</span><br><span class="line">&#123;<span class="function_or_atom">value</span>,&#123;<span class="function_or_atom">mail</span>,<span class="string">"13012345678@139.com"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lists:keyfind/3</strong></p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">3&gt; </span><span class="function_or_atom">lists:keyfind</span>(<span class="function_or_atom">mail</span>,<span class="number">1</span>, [&#123;<span class="function_or_atom">username</span>, <span class="string">"13012345678"</span>&#125;, &#123;<span class="function_or_atom">mail</span>, <span class="string">"13012345678@139.com"</span>&#125;, &#123;<span class="function_or_atom">tel</span>, <span class="number">13012345678</span>&#125;]).</span><br><span class="line">&#123;<span class="function_or_atom">mail</span>,<span class="string">"13012345678@139.com"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>注意<code>lists:keysearch/3</code>和<code>lists:keyfind/3</code>返回值的差异.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/3/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/5/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/03/18/angular-if-else-statement-in-template/">AngularJS中的If..Else语句</a>
      </li>
    
      <li>
        <a href="/2015/03/18/continuous-deployment-of-node-js-applications/">Nodejs应用程序持续部署</a>
      </li>
    
      <li>
        <a href="/2015/03/17/erlang-pooler/">Erlang Pooler</a>
      </li>
    
      <li>
        <a href="/2015/03/17/ejabberd-easy-installer-and-structure-for-ejabberd-contributed-modules/">Ejabberd模块安装工具</a>
      </li>
    
      <li>
        <a href="/2015/03/13/ejabberd-howto-20150312/">Ejabberd Howto 20150312 &lt;TODO LIST&gt;</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-performance-turning/">Ejabberd 性能调优(草稿)</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-benchmark-with-tsung/">使用Tsung对Ejabberd进行性能测试</a>
      </li>
    
      <li>
        <a href="/2015/03/11/thrift-ex/">thrift_ex</a>
      </li>
    
      <li>
        <a href="/2015/02/26/ejabberd-joins-the-elixir-revolution/">(译) Ejabberd加入了Elixir的变革</a>
      </li>
    
      <li>
        <a href="/2015/02/25/http2-h2o-get-started/">HTTP/2 尝鲜</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>32</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>6</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a><a href="/tags/API/" style="font-size: 11px;">API</a><a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a><a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a><a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a><a href="/tags/CURL/" style="font-size: 10px;">CURL</a><a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a><a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a><a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a><a href="/tags/ETS/" style="font-size: 10px;">ETS</a><a href="/tags/Ecto/" style="font-size: 11px;">Ecto</a><a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a><a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a><a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a><a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a><a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a><a href="/tags/H2O/" style="font-size: 10px;">H2O</a><a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a><a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a><a href="/tags/Howto/" style="font-size: 10px;">Howto</a><a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a><a href="/tags/I18n/" style="font-size: 10px;">I18n</a><a href="/tags/IAB/" style="font-size: 10px;">IAB</a><a href="/tags/ID3/" style="font-size: 10px;">ID3</a><a href="/tags/IO/" style="font-size: 10px;">IO</a><a href="/tags/IOT/" style="font-size: 10px;">IOT</a><a href="/tags/IoT/" style="font-size: 10px;">IoT</a><a href="/tags/Loopback/" style="font-size: 12px;">Loopback</a><a href="/tags/MUC/" style="font-size: 10px;">MUC</a><a href="/tags/Macro/" style="font-size: 12px;">Macro</a><a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a><a href="/tags/Mix/" style="font-size: 14px;">Mix</a><a href="/tags/Modules/" style="font-size: 10px;">Modules</a><a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a><a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a><a href="/tags/OTP/" style="font-size: 12px;">OTP</a><a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a><a href="/tags/PM2/" style="font-size: 10px;">PM2</a><a href="/tags/Performance/" style="font-size: 10px;">Performance</a><a href="/tags/Phoenix/" style="font-size: 12px;">Phoenix</a><a href="/tags/Pool/" style="font-size: 10px;">Pool</a><a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a><a href="/tags/RESTFUL/" style="font-size: 11px;">RESTFUL</a><a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a><a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a><a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a><a href="/tags/Regex/" style="font-size: 10px;">Regex</a><a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a><a href="/tags/SSH/" style="font-size: 10px;">SSH</a><a href="/tags/SSL/" style="font-size: 10px;">SSL</a><a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a><a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a><a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a><a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a><a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a><a href="/tags/Task/" style="font-size: 10px;">Task</a><a href="/tags/Thrift/" style="font-size: 10px;">Thrift</a><a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a><a href="/tags/UBF/" style="font-size: 10px;">UBF</a><a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a><a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a><a href="/tags/VAST/" style="font-size: 10px;">VAST</a><a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a><a href="/tags/XEP/" style="font-size: 15px;">XEP</a><a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a><a href="/tags/XML/" style="font-size: 10px;">XML</a><a href="/tags/XMPP/" style="font-size: 18px;">XMPP</a><a href="/tags/android/" style="font-size: 10px;">android</a><a href="/tags/angular/" style="font-size: 17px;">angular</a><a href="/tags/application/" style="font-size: 10px;">application</a><a href="/tags/blockies/" style="font-size: 10px;">blockies</a><a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a><a href="/tags/bosh/" style="font-size: 12px;">bosh</a><a href="/tags/ci/" style="font-size: 10px;">ci</a><a href="/tags/container/" style="font-size: 11px;">container</a><a href="/tags/data-management/" style="font-size: 10px;">data management</a><a href="/tags/data-volume/" style="font-size: 10px;">data volume</a><a href="/tags/debugging/" style="font-size: 10px;">debugging</a><a href="/tags/devtools/" style="font-size: 10px;">devtools</a><a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a><a href="/tags/doc/" style="font-size: 10px;">doc</a><a href="/tags/docker/" style="font-size: 16px;">docker</a><a href="/tags/ejabberd/" style="font-size: 19px;">ejabberd</a><a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a><a href="/tags/emysql/" style="font-size: 11px;">emysql</a><a href="/tags/encoding/" style="font-size: 10px;">encoding</a><a href="/tags/erlang/" style="font-size: 12px;">erlang</a><a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a><a href="/tags/faq/" style="font-size: 10px;">faq</a><a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a><a href="/tags/gerrit/" style="font-size: 11px;">gerrit</a><a href="/tags/gettext/" style="font-size: 10px;">gettext</a><a href="/tags/git/" style="font-size: 12px;">git</a><a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a><a href="/tags/grunt/" style="font-size: 10px;">grunt</a><a href="/tags/hero/" style="font-size: 10px;">hero</a><a href="/tags/html/" style="font-size: 10px;">html</a><a href="/tags/html5/" style="font-size: 10px;">html5</a><a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a><a href="/tags/iq/" style="font-size: 10px;">iq</a><a href="/tags/jabber/" style="font-size: 10px;">jabber</a><a href="/tags/javascript/" style="font-size: 11px;">javascript</a><a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a><a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a><a href="/tags/library/" style="font-size: 10px;">library</a><a href="/tags/linking/" style="font-size: 10px;">linking</a><a href="/tags/lists/" style="font-size: 10px;">lists</a><a href="/tags/load-balance/" style="font-size: 10px;">load balance</a><a href="/tags/log4er/" style="font-size: 10px;">log4er</a><a href="/tags/manage-images/" style="font-size: 10px;">manage images</a><a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a><a href="/tags/muc/" style="font-size: 10px;">muc</a><a href="/tags/mysql/" style="font-size: 10px;">mysql</a><a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a><a href="/tags/node-webkit/" style="font-size: 13px;">node-webkit</a><a href="/tags/node-js/" style="font-size: 12px;">node.js</a><a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a><a href="/tags/notification/" style="font-size: 10px;">notification</a><a href="/tags/npm/" style="font-size: 11px;">npm</a><a href="/tags/performance/" style="font-size: 10px;">performance</a><a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a><a href="/tags/polymer/" style="font-size: 10px;">polymer</a><a href="/tags/port/" style="font-size: 10px;">port</a><a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a><a href="/tags/rebar/" style="font-size: 10px;">rebar</a><a href="/tags/record/" style="font-size: 10px;">record</a><a href="/tags/recursion/" style="font-size: 10px;">recursion</a><a href="/tags/regexp/" style="font-size: 10px;">regexp</a><a href="/tags/relx/" style="font-size: 10px;">relx</a><a href="/tags/screen/" style="font-size: 10px;">screen</a><a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a><a href="/tags/shell/" style="font-size: 10px;">shell</a><a href="/tags/socket/" style="font-size: 10px;">socket</a><a href="/tags/ssh/" style="font-size: 10px;">ssh</a><a href="/tags/stanza/" style="font-size: 10px;">stanza</a><a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a><a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a><a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a><a href="/tags/swagger/" style="font-size: 12px;">swagger</a><a href="/tags/testing/" style="font-size: 10px;">testing</a><a href="/tags/tls/" style="font-size: 10px;">tls</a><a href="/tags/tools/" style="font-size: 10px;">tools</a><a href="/tags/tsung/" style="font-size: 10px;">tsung</a><a href="/tags/upstart/" style="font-size: 10px;">upstart</a><a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a><a href="/tags/varnish/" style="font-size: 10px;">varnish</a><a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a><a href="/tags/vt/" style="font-size: 10px;">vt</a><a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a><a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a><a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a><a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




