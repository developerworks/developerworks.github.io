
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 5 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-15T08:33:20.000Z"><a href="/2014/10/15/ejabberd-mod-logxml/">2014-10-15</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/15/ejabberd-mod-logxml/">Ejabberd XML格式的XMPP消息日志模块</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight"><figcaption><span>mod_logxml.erl模块配置</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modules:&#10;  mod_logxml:&#10;    #stanza: [message, other]&#10;    #direction: [internal, vhosts, external]&#10;    #orientation: [send, recv]&#10;    logdir: &#34;/var/log/ejabberd/xmllogs&#34;&#10;    #timezone: universal&#10;    #rotate_days: 10&#10;    rotate_megs: 1000000&#10;    #rotate_kpackets: no&#10;    #check_rotate_kpackets: 1</span><br></pre></td></tr></table></figure>
<p>模块文件, 完整文件,请点击右侧<code>mod_logxml.erl</code>连接</p>
<figure class="highlight erlang"><figcaption><span>Ejabberd mod_logxml模块,记录stanza到XML日志文件中</span><a href="https://gist.github.com/developerworks/34bf6015f1f4890a210e" target="_blank" rel="external">mod_logxml.erl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_logxml)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-author</span><span class="params">('badlop@ono.com')</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">  start/<span class="number">2</span>,</span><br><span class="line">  init/<span class="number">7</span>,</span><br><span class="line">  stop/<span class="number">1</span>,</span><br><span class="line">  send_packet/<span class="number">3</span>,</span><br><span class="line">  receive_packet/<span class="number">4</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">PROCNAME</span>, ejabberd_mod_logxml)</span></span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">Host</span>, <span class="variable">Opts</span>)</span> -&gt;</span></span><br><span class="line">  <span class="comment">%% 日志存储目录</span></span><br><span class="line">  <span class="variable">Logdir</span> = <span class="function_name">gen_mod:get_opt</span>(logdir, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="string">"/tmp/jabberlogs/"</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Logdir: ~p"</span>, [<span class="variable">Logdir</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动天数</span></span><br><span class="line">  <span class="variable">Rd</span> = <span class="function_name">gen_mod:get_opt</span>(rotate_days, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rd: ~p"</span>, [<span class="variable">Rd</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动兆字节数,默认日志文件满10MB后创建新文件记录当前日志输出</span></span><br><span class="line">  <span class="variable">Rf</span> = <span class="keyword">case</span> <span class="function_name">gen_mod:get_opt</span>(rotate_megs, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">10</span>) <span class="keyword">of</span></span><br><span class="line">         no -&gt; no;</span><br><span class="line">         <span class="variable">Rf1</span> -&gt; <span class="variable">Rf1</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">       <span class="keyword">end</span>,</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rf: ~p"</span>, [<span class="variable">Rf</span>]),</span><br><span class="line">  <span class="comment">%% 按接收到的XMPP数据包的数量滚动</span></span><br><span class="line">  <span class="variable">Rp</span> = <span class="keyword">case</span> <span class="function_name">gen_mod:get_opt</span>(rotate_kpackets, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">10</span>) <span class="keyword">of</span></span><br><span class="line">         no -&gt; no;</span><br><span class="line">         <span class="variable">Rp1</span> -&gt; <span class="variable">Rp1</span> * <span class="number">1000</span></span><br><span class="line">       <span class="keyword">end</span>,</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rp: ~p"</span>, [<span class="variable">Rp</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动选项</span></span><br><span class="line">  <span class="variable">RotateO</span> = <span class="tuple">&#123;<span class="variable">Rd</span>, <span class="variable">Rf</span>, <span class="variable">Rp</span>&#125;</span>,</span><br><span class="line">  <span class="variable">CheckRKP</span> = <span class="function_name">gen_mod:get_opt</span>(check_rotate_kpackets, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML RotateO: ~p"</span>, [<span class="variable">RotateO</span>]),</span><br><span class="line">  <span class="comment">%% 时区配置选项</span></span><br><span class="line">  <span class="variable">Timezone</span> = <span class="function_name">gen_mod:get_opt</span>(timezone, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, local),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Timezone: ~p"</span>, [<span class="variable">Timezone</span>]),</span><br><span class="line">  <span class="comment">%% 数据流方向</span></span><br><span class="line">  <span class="variable">Orientation</span> = <span class="function_name">gen_mod:get_opt</span>(orientation, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [send, recv]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Orientation: ~p"</span>, [<span class="variable">Orientation</span>]),</span><br><span class="line">  <span class="comment">%% XMPP节</span></span><br><span class="line">  <span class="variable">Stanza</span> = <span class="function_name">gen_mod:get_opt</span>(stanza, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [iq, message, presence, other]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Stanza: ~p"</span>, [<span class="variable">Stanza</span>]),</span><br><span class="line">  <span class="comment">%% 连接方向</span></span><br><span class="line">  <span class="variable">Direction</span> = <span class="function_name">gen_mod:get_opt</span>(direction, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [internal, vhosts, external]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Direction: ~p"</span>, [<span class="variable">Direction</span>]),</span><br><span class="line">  <span class="comment">%% 过滤器选项</span></span><br><span class="line">  <span class="variable">FilterO</span> = <span class="tuple">&#123;</span><br><span class="line">    <span class="tuple">&#123;orientation, <span class="variable">Orientation</span>&#125;</span>,</span><br><span class="line">    <span class="tuple">&#123;stanza, <span class="variable">Stanza</span>&#125;</span>,</span><br><span class="line">    <span class="tuple">&#123;direction, <span class="variable">Direction</span>&#125;</span>&#125;</span>,</span><br><span class="line">  <span class="comment">%% 是否显示IP地址</span></span><br><span class="line">  <span class="variable">ShowIP</span> = <span class="function_name">gen_mod:get_opt</span>(show_ip, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, false),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML ShowIP: ~p"</span>, [<span class="variable">ShowIP</span>]),</span><br><span class="line">  <span class="comment">%% 用户收发XMPP数据包钩子</span></span><br><span class="line">  <span class="function_name">ejabberd_hooks:add</span>(user_send_packet, <span class="variable">Host</span>, ?<span class="variable">MODULE</span>, send_packet, <span class="number">90</span>),</span><br><span class="line">  <span class="function_name">ejabberd_hooks:add</span>(user_receive_packet, <span class="variable">Host</span>, ?<span class="variable">MODULE</span>, receive_packet, <span class="number">90</span>),</span><br><span class="line">  <span class="comment">%% 进程注册</span></span><br><span class="line">  <span class="function_name">register</span>(</span><br><span class="line">    <span class="comment">%% 获取模块</span></span><br><span class="line">    <span class="function_name">gen_mod:get_module_proc</span>(<span class="variable">Host</span>, ?<span class="variable">PROCNAME</span>),</span><br><span class="line">    <span class="function_name">spawn</span>(?<span class="variable">MODULE</span>, init, [<span class="variable">Host</span>, <span class="variable">Logdir</span>, <span class="variable">RotateO</span>, <span class="variable">CheckRKP</span>, <span class="variable">Timezone</span>, <span class="variable">ShowIP</span>, <span class="variable">FilterO</span>])</span><br><span class="line">  ).</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">省略</span><br></pre></td></tr></table></figure>
<h2 id="格式化输出">格式化输出</h2><figure class="highlight python"><figcaption><span>格式化XML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> tail</span><br><span class="line"><span class="keyword">import</span> xml.dom.minidom</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pretty_print</span><span class="params">(xml_string)</span>:</span></span><br><span class="line">    fragment = xml.dom.minidom.parseString(xml_string)</span><br><span class="line">    string = fragment.toprettyxml(indent=<span class="string">"  "</span>, newl=<span class="string">"\n"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    print(string)</span><br><span class="line"><span class="comment"># Create a tail instance</span></span><br><span class="line">t = tail.Tail(<span class="string">'xmpp.hezhiqiang.info.xml'</span>)</span><br><span class="line"><span class="comment"># Register a callback function to be called when a new line is found in the followed file.</span></span><br><span class="line"><span class="comment"># If no callback function is registerd, new lines would be printed to standard out.</span></span><br><span class="line">t.register_callback(pretty_print)</span><br><span class="line"><span class="comment"># Follow the file with 5 seconds as sleep time between iterations.</span></span><br><span class="line"><span class="comment"># If sleep time is not provided 1 second is used as the default time.</span></span><br><span class="line">t.follow(s=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://stackoverflow.com/questions/24012466/xmpp-traffic-logging-ejabberd-13-12" target="_blank" rel="external">http://stackoverflow.com/questions/24012466/xmpp-traffic-logging-ejabberd-13-12</a></li>
<li><a href="http://stackoverflow.com/questions/749796/pretty-printing-xml-in-python" target="_blank" rel="external">http://stackoverflow.com/questions/749796/pretty-printing-xml-in-python</a></li>
<li><a href="https://github.com/kasun/python-tail" target="_blank" rel="external">https://github.com/kasun/python-tail</a></li>
<li><a href="https://docs.python.org/2/library/xml.dom.minidom.html" target="_blank" rel="external">https://docs.python.org/2/library/xml.dom.minidom.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-14T02:21:11.000Z"><a href="/2014/10/14/elixir-doc/">2014-10-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/14/elixir-doc/">文档工具</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="内置文档生成">内置文档生成</h2><p>在Elixir中,文档是一等公民, Elixir对其有内置的支持, 不需要第三方文档生成工具. 只需要使用<code>@doc</code>标签即可</p>
<h3 id="函数文档">函数文档</h3><ul>
<li>创建一个文件<code>hello.exs</code>如下:</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elixir module</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Test</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="variable">@doc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">    一个Echo方法用于输出Hello World.</span><br><span class="line">    "</span><span class="string">""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">echo</span> </span><span class="keyword">do</span></span><br><span class="line">        <span class="constant">IO.</span>puts <span class="string">"Hello World!"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>进入交互式shell</li>
</ul>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">root</span><span class="comment"># iex</span></span><br></pre></td></tr></table></figure>
<ul>
<li>编译模块</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">1</span>)</span></span>&gt; <span class="function"><span class="title">c</span><span class="params">(<span class="string">"hello.exs"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>模块编译会在当前目录下生成一个<code>Elixir.Test.beam</code> BEAM文件.</p>
<ul>
<li>查看文档</li>
</ul>
<p><img src="/assets/images/820FF121-4358-4564-BBB9-1C5C5F7AF8BF.png" alt="在Elixir交互式Shell中查看函数文档"></p>
<h3 id="模块文档">模块文档</h3><p><code>@moduledoc</code></p>
<h2 id="函数参数和返回类型规范">函数参数和返回类型规范</h2><p>函数定义的类型规范是通过<code>@spec</code>标签定义的</p>
<h2 id="用ExDoc生成文档">用ExDoc生成文档</h2><ul>
<li><p>用<code>mix</code>创建一个新项目</p>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/ejabberd/elixir# mix new docs</span><br><span class="line"><span class="comment">* creating README.md</span></span><br><span class="line"><span class="comment">* creating .gitignore</span></span><br><span class="line"><span class="comment">* creating mix.exs</span></span><br><span class="line"><span class="comment">* creating config</span></span><br><span class="line"><span class="comment">* creating config/config.exs</span></span><br><span class="line"><span class="comment">* creating lib</span></span><br><span class="line"><span class="comment">* creating lib/docs.ex</span></span><br><span class="line"><span class="comment">* creating test</span></span><br><span class="line"><span class="comment">* creating test/test_helper.exs</span></span><br><span class="line"><span class="comment">* creating test/docs_test.exs</span></span><br><span class="line">Your mix project was created successfully.</span><br><span class="line">You can <span class="keyword">use</span> mix to compile it, <span class="keyword">test</span> it, and <span class="keyword">more</span>:</span><br><span class="line">    <span class="keyword">cd</span> docs</span><br><span class="line">    mix <span class="keyword">test</span></span><br><span class="line"><span class="keyword">Run</span> `mix <span class="keyword">help</span>` <span class="keyword">for</span> <span class="keyword">more</span> commands.</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑mix.exs,添加依赖模块</p>
  <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Docs</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:docs</span>,</span><br><span class="line">     <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">     <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># Configuration for the OTP application</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Type `mix help compile.app` for more information</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">applications:</span> [<span class="symbol">:logger</span>]]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># Dependencies can be Hex packages:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#   &#123;:mydep, "~&gt; 0.3.0"&#125;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Or git/path repositories:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#   &#123;:mydep, git: "https://github.com/elixir-lang/mydep.git", tag: "0.1.0"&#125;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Type `mix help deps` for more examples and options</span></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    [&#123;<span class="symbol">:ex_doc</span>, <span class="symbol">github:</span> <span class="string">"elixir-lang/ex_doc"</span>&#125;]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装依赖</p>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@fd4cc081e295</span><span class="symbol">:~/elixir/docs</span><span class="comment"># mix deps.get</span></span><br><span class="line">* <span class="constant">Updating</span> ex_doc (<span class="symbol">git:</span>/<span class="regexp">/github.com/elixir</span>-lang/ex_doc.git)</span><br><span class="line">==&gt; ex_doc</span><br><span class="line"><span class="constant">Could</span> <span class="keyword">not</span> find hex, which is needed to build dependency <span class="symbol">:earmark</span></span><br><span class="line"><span class="constant">Shall</span> <span class="constant">I</span> install hex? [<span class="constant">Yn</span>] <span class="constant">Y</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">13</span> 09<span class="symbol">:</span><span class="number">07</span><span class="symbol">:</span><span class="number">56</span> <span class="constant">URL</span><span class="symbol">:https</span><span class="symbol">://s3</span>.amazonaws.com/s3.hex.pm/installs/hex.ez [<span class="number">240877</span>/<span class="number">240877</span>] -&gt; <span class="string">"/root/.mix/archives/hex.ez"</span> [<span class="number">1</span>]</span><br><span class="line">* creating /root/.mix/archives/hex.ez</span><br></pre></td></tr></table></figure>
<ul>
<li>生成文档</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mix</span> docs</span><br></pre></td></tr></table></figure>
<h2 id="ExDoc中文模板">ExDoc中文模板</h2><p>下载地址:<br><a href="https://github.com/developerworks/ex_doc" target="_blank" rel="external">https://github.com/developerworks/ex_doc</a></p>
<p><img src="/assets/images/61802553-AA1E-430F-9BED-2B25BC2BAF58.png" alt="ExDoc中文模板"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-13T17:06:12.000Z"><a href="/2014/10/14/elixir-first/">2014-10-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/14/elixir-first/">第一印象</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Elixir 依赖与Erlang/OTP 17,需要首先安装Erlang, 这里不讲解如何安装Erlang, 这里说明如何编译和使用Elixir</p>
<h1 id="编译">编译</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#19979;&#36733;&#10;wget https://github.com/elixir-lang/elixir/archive/v1.0.1.tar.gz&#10;# &#35299;&#21387;&#10;tar zxf v1.0.1.tar.gz&#10;cd elixir-1.0.1&#10;make</span><br></pre></td></tr></table></figure>
<h1 id="配置路径">配置路径</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/root/elixir-<span class="number">1.0</span>.<span class="number">1</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<h1 id="交互式Shell">交互式Shell</h1><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@fd4cc081e295</span><span class="symbol">:~/elixir-</span><span class="number">1.0</span>.<span class="number">1</span>/bin<span class="comment"># iex</span></span><br><span class="line"><span class="constant">Erlang/OTP </span><span class="number">17</span> [erts-<span class="number">6.2</span>] [source] [<span class="number">64</span>-bit] [async-<span class="symbol">threads:</span><span class="number">10</span>] [kernel-<span class="symbol">poll:</span><span class="keyword">false</span>]</span><br><span class="line"><span class="constant">Interactive Elixir </span>(<span class="number">1.0</span>.<span class="number">1</span>) - press <span class="constant">Ctrl+C </span>to exit (type h() <span class="constant">ENTER </span><span class="keyword">for</span> help)</span><br><span class="line">iex(<span class="number">1</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>输入<code>h()</code>显示如下帮助</p>
<p><img src="/assets/images/94E0C021-A9FE-44CD-97C5-EA564C66BC78.png" alt="Elixir交互式Shell"></p>
<h1 id="Hell_World">Hell World</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IO<span class="class">.puts</span> <span class="string">"Hello World!</span></span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@fd4cc081e295</span><span class="symbol">:~/elixir</span><span class="comment"># elixir hello.exs</span></span><br><span class="line"><span class="constant">Hello World!</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-08T18:11:10.000Z"><a href="/2014/10/09/mysql-database-protocol-packet-analysis/">2014-10-09</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/09/mysql-database-protocol-packet-analysis/">MySQL数据库协议包分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>本文的分析角度,是从Erlang语言的emsyql客户端库作为分析案例,通过对emysql库源码的阅读来分析MySQL数据库的协议包结构.并描述了MySQL协议包的结构,如何处理查询结果,如何处理错误信息等协议层内部机制.</p>
<p>首先从最常用的协议包开始:</p>
<h2 id="结果集协议包">结果集协议包</h2><p>顾名思义, 该协议包定义了从MySQL数据库返回的结果集的包格式. 既然是结果集协议包,其中包含我们查询的字段列表.在emysql中定义的字段类型如下:</p>
<figure class="highlight erlang"><figcaption><span>MySQL类型</span><a href="https://github.com/Eonblast/Emysql/blob/master/include/emysql.hrl" target="_blank" rel="external">emysql.hrl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% MYSQL TYPES</span></span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DECIMAL</span>, <span class="number">16#00</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TINY</span>, <span class="number">16#01</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_SHORT</span>, <span class="number">16#02</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONG</span>, <span class="number">16#03</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_FLOAT</span>, <span class="number">16#04</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DOUBLE</span>, <span class="number">16#05</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NULL</span>, <span class="number">16#06</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TIMESTAMP</span>, <span class="number">16#07</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONGLONG</span>, <span class="number">16#08</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_INT24</span>, <span class="number">16#09</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DATE</span>, <span class="number">16#0a</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TIME</span>, <span class="number">16#0b</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DATETIME</span>, <span class="number">16#0c</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_YEAR</span>, <span class="number">16#0d</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NEWDATE</span>, <span class="number">16#0e</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_VARCHAR</span>, <span class="number">16#0f</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_BIT</span>, <span class="number">16#10</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NEWDECIMAL</span>, <span class="number">16#f6</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_ENUM</span>, <span class="number">16#f7</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_SET</span>, <span class="number">16#f8</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TINY_BLOB</span>, <span class="number">16#f9</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_MEDIUM_BLOB</span>, <span class="number">16#fa</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONG_BLOB</span>, <span class="number">16#fb</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_BLOB</span>, <span class="number">16#fc</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_VAR_STRING</span>, <span class="number">16#fd</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_STRING</span>, <span class="number">16#fe</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_GEOMETRY</span>, <span class="number">16#ff</span>)</span></span>.</span><br></pre></td></tr></table></figure>
<p>每一种类型,用一个16进制数字来标记. 以Erlang宏定义的方式声明了不同字段数据类型的值.</p>
<p>TODO::</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-08T03:53:17.000Z"><a href="/2014/10/08/ejabberd-integrate-with-emysql/">2014-10-08</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/08/ejabberd-integrate-with-emysql/">Ejabberd与Emysql集成</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/754522BD-38E0-40B9-9C1D-07E7988BDEC0.png" alt=""><br>开发模块需要使用到MySQL数据库,本文描述如何把<code>Emysql</code>集成到Ejabberd中.</p>
<h2 id="修改Ejabberd">修改Ejabberd</h2><p>编辑<code>$EJABBERD_SRC/rebar.config.script</code></p>
<p>配置<code>Deps</code>,增加<code>Emysql</code>依赖</p>
<figure class="highlight"><figcaption><span>配置rebar.config.script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Deps = [&#10;    ...&#10;    &#123;emysql, &#34;.*&#34;, &#123;git, &#34;git://github.com/Eonblast/Emysql.git&#34;&#125;&#125;&#10;],</span><br></pre></td></tr></table></figure>
<p>如果已经编译过了ejabberd,请删除<code>deps/.built</code>, <code>deps/.got</code>两个文件, 并执行<code>make</code></p>
<figure class="highlight"><figcaption><span>编译输出</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/ejabberd# make&#10;...&#10;==&#62; emysql (compile)&#10;Generating &#34;include/crypto_compat.hrl&#34; ...&#10;...supports cryto:hash/2&#10;...writing &#34;include/crypto_compat.hrl&#34;&#10;Compiled src/emysql.erl&#10;Compiled src/emysql_worker.erl&#10;Compiled src/emysql_conn_mgr.erl&#10;Compiled src/emysql_sup.erl&#10;Compiled src/emysql_util.erl&#10;Compiled src/emysql_conn.erl&#10;Compiled src/emysql_app.erl&#10;Compiled src/emysql_statements.erl&#10;Compiled src/emysql_auth.erl&#10;Compiled src/emysql_conv.erl&#10;Compiled src/emysql_tcp.erl&#10;==&#62; p1_mysql (compile)&#10;==&#62; p1_zlib (compile)&#10;==&#62; jiffy (compile)&#10;==&#62; goldrush (compile)&#10;==&#62; lager (compile)&#10;==&#62; p1_iconv (compile)&#10;==&#62; rel (compile)&#10;==&#62; ejabberd (compile)&#10;Compiled src/mod_gbox_messager.erl&#10;Compiled src/mod_online_users.erl&#10;Compiled src/mod_cputime.erl&#10;Compiled src/mod_system_information.erl&#10;/usr/lib/erlang/bin/escript rebar skip_deps=true compile&#10;==&#62; rel (compile)&#10;==&#62; ejabberd (compile)</span><br></pre></td></tr></table></figure>
<h2 id="下载安装samples数据库">下载安装samples数据库</h2><figure class="highlight"><figcaption><span>下载安装samples数据库</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2&#10;tar jxf employees_db-full-1.0.6.tar.bz2&#10;cd employees_db&#10;mysql -t &#60; employees.sql</span><br></pre></td></tr></table></figure>
<h2 id="修改模块">修改模块</h2><figure class="highlight erlang"><figcaption><span>获取CPU时间模块</span><a href="https://gist.github.com/developerworks/77c3954e8622550f6c71" target="_blank" rel="external">mod_cputime.erl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_cputime)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">    start/<span class="number">2</span>,</span><br><span class="line">    stop/<span class="number">1</span>,</span><br><span class="line">    process_local_iq/<span class="number">3</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">JUD_MATCHES</span>, macro_body)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">NS_CPUTIME</span>, &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;)</span></span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">Host</span>, <span class="variable">Opts</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">IQDisc</span> = <span class="function_name">gen_mod:get_opt</span>(</span><br><span class="line">        iqdisc,</span><br><span class="line">        <span class="variable">Opts</span>,</span><br><span class="line">        <span class="keyword">fun</span> gen_iq_handler:check_type/<span class="number">1</span>,</span><br><span class="line">        one_queue</span><br><span class="line">    ),</span><br><span class="line">    <span class="function_name">mod_disco:register_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:add_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>, ?<span class="variable">MODULE</span>, process_local_iq, <span class="variable">IQDisc</span>),</span><br><span class="line">    <span class="function_name">crypto:start</span>(),</span><br><span class="line">    <span class="function_name">application:start</span>(emysql),</span><br><span class="line">    <span class="variable">Server</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, server, <span class="keyword">fun</span>(<span class="variable">Server</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Server</span>) <span class="keyword">end</span>, <span class="string">"localhost"</span>),</span><br><span class="line">    <span class="variable">Port</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, port, <span class="keyword">fun</span>(<span class="variable">Port</span>) -&gt; <span class="variable">Port</span> <span class="keyword">end</span>, <span class="number">3306</span>),</span><br><span class="line">    <span class="variable">Database</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, database, <span class="keyword">fun</span>(<span class="variable">Database</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Database</span>) <span class="keyword">end</span>, <span class="string">"mysql"</span>),</span><br><span class="line">    <span class="variable">User</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, user, <span class="keyword">fun</span>(<span class="variable">User</span>) -&gt; <span class="variable">User</span> <span class="keyword">end</span>, <span class="string">"root"</span>),</span><br><span class="line">    <span class="variable">Password</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, password, <span class="keyword">fun</span>(<span class="variable">Password</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Password</span>) <span class="keyword">end</span>, <span class="string">"root"</span>),</span><br><span class="line">    <span class="variable">PoolSize</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, poolsize, <span class="keyword">fun</span>(<span class="variable">PoolSize</span>) -&gt; <span class="variable">PoolSize</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="variable">Encoding</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, encoding, <span class="keyword">fun</span>(<span class="variable">Encoding</span>) -&gt; <span class="function_name">list_to_atom</span>(<span class="function_name">binary_to_list</span>(<span class="variable">Encoding</span>)) <span class="keyword">end</span>, utf8),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Server: ~p~n"</span>, [<span class="variable">Server</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Port: ~p~n"</span>, [<span class="variable">Port</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL DB: ~p~n"</span>, [<span class="variable">Database</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL User: ~p~n"</span>, [<span class="variable">User</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Password: ~p~n"</span>, [<span class="variable">Password</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL PoolSize: ~p~n"</span>, [<span class="variable">PoolSize</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Encoding: ~p~n"</span>, [<span class="variable">Encoding</span>]),</span><br><span class="line">    <span class="function_name">emysql:add_pool</span>(pool_employees, [</span><br><span class="line">        <span class="tuple">&#123;size, <span class="variable">PoolSize</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;user, <span class="variable">User</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;password, <span class="variable">Password</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;host, <span class="variable">Server</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;port, <span class="variable">Port</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;database, <span class="variable">Database</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;encoding, <span class="variable">Encoding</span>&#125;</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="tuple">&#123;<span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">Result</span>, <span class="variable">_</span>&#125;</span> = <span class="function_name">emysql:execute</span>(pool_employees, &lt;&lt;<span class="string">"SELECT * FROM employees LIMIT 10"</span>&gt;&gt;),</span><br><span class="line"><span class="comment">%%     [</span></span><br><span class="line"><span class="comment">%%         [10001,&#123;date,&#123;1953,9,2&#125;&#125;,&lt;&lt;"Georgi"&gt;&gt;,&lt;&lt;"Facello"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,6,26&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10002,&#123;date,&#123;1964,6,2&#125;&#125;,&lt;&lt;"Bezalel"&gt;&gt;,&lt;&lt;"Simmel"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1985,11,21&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10003,&#123;date,&#123;1959,12,3&#125;&#125;,&lt;&lt;"Parto"&gt;&gt;,&lt;&lt;"Bamford"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,8,28&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10004,&#123;date,&#123;1954,5,1&#125;&#125;,&lt;&lt;"Chirstian"&gt;&gt;,&lt;&lt;"Koblick"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,12,1&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10005,&#123;date,&#123;1955,1,21&#125;&#125;,&lt;&lt;"Kyoichi"&gt;&gt;,&lt;&lt;"Maliniak"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1989,9,12&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10006,&#123;date,&#123;1953,4,20&#125;&#125;,&lt;&lt;"Anneke"&gt;&gt;,&lt;&lt;"Preusig"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,6,2&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10007,&#123;date,&#123;1957,5,23&#125;&#125;,&lt;&lt;"Tzvetan"&gt;&gt;,&lt;&lt;"Zielinski"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,2,10&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10008,&#123;date,&#123;1958,2,19&#125;&#125;,&lt;&lt;"Saniya"&gt;&gt;,&lt;&lt;"Kalloufi"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1994,9,15&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10009,&#123;date,&#123;1952,4,19&#125;&#125;,&lt;&lt;"Sumant"&gt;&gt;,&lt;&lt;"Peac"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1985,2,18&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10010,&#123;date,&#123;1963,6,1&#125;&#125;,&lt;&lt;"Duangkaew"&gt;&gt;,&lt;&lt;"Piveteau"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,8,24&#125;&#125;]</span></span><br><span class="line"><span class="comment">%%     ].</span></span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"============================~n~p~n"</span>, [<span class="variable">Result</span>]),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">stop</span>(<span class="variable">Host</span>) -&gt;</span><br><span class="line">    <span class="function_name">mod_disco:unregister_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:remove_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">process_local_iq</span>(<span class="variable">_From</span>, <span class="variable">_To</span>, <span class="record_name">#iq</span>&#123;type = <span class="variable">Type</span>, sub_el = <span class="variable">SubEl</span>&#125; = <span class="variable">IQ</span>) -&gt;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">Type</span> <span class="keyword">of</span></span><br><span class="line">        set -&gt;</span><br><span class="line">            <span class="variable">IQ</span><span class="record_name">#iq</span>&#123;type = error, sub_el = [<span class="variable">SubEl</span>, ?<span class="variable">ERR_NOT_ALLOWED</span>]&#125;;</span><br><span class="line">        get -&gt;</span><br><span class="line">            <span class="variable">CPUTime</span> = <span class="function_name">element</span>(<span class="number">1</span>, <span class="function_name">erlang:statistics</span>(runtime)) / <span class="number">1000</span>,</span><br><span class="line">            <span class="variable">SCPUTime</span> = <span class="function_name">lists:flatten</span>(<span class="function_name">io_lib:format</span>(<span class="string">"~.3f"</span>, [<span class="variable">CPUTime</span>])),</span><br><span class="line">            <span class="variable">Packet</span> = <span class="variable">IQ</span><span class="record_name">#iq</span>&#123;type = result, sub_el = [</span><br><span class="line">                <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"query"</span>&gt;&gt;, attrs = [<span class="tuple">&#123;&lt;&lt;<span class="string">"xmlns"</span>&gt;&gt;, ?<span class="variable">NS_CPUTIME</span>&#125;</span>], children = [</span><br><span class="line">                    <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"time"</span>&gt;&gt;, attrs = [], children = [<span class="tuple">&#123;xmlcdata, <span class="function_name">list_to_binary</span>(<span class="variable">SCPUTime</span>)&#125;</span>]&#125;]&#125;</span><br><span class="line">            ]&#125;,</span><br><span class="line">            <span class="variable">Packet</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>查询结果日志输出</p>
<p><img src="/assets/images/0D78C5EA-8892-437F-B6FE-1F3E19404AE6.png" alt="查询结果日志输出"></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://dev.mysql.com/doc/employee/en/employees-installation.html" target="_blank" rel="external">http://dev.mysql.com/doc/employee/en/employees-installation.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-06T11:20:27.000Z"><a href="/2014/10/06/ejabberd-code-analysis-translate-auxiliary-tool/">2014-10-06</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/06/ejabberd-code-analysis-translate-auxiliary-tool/">Ejabberd代码分析之-翻译辅助工具</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd支持国际化,在<code>&lt;iq/&gt;</code>,<code>&lt;message/&gt;</code>,<code>&lt;presence/&gt;</code>等元素上添加<code>xml:lang</code>属性,对应的英文文本会切换到指定的语言.</p>
<p>举个例子,模块<code>mod_announce.erl</code>代码内有如下对<code>translate:translate()</code>的使用:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"announce"</span>&gt;&gt;)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Announcements"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_ANNOUNCE_ALL</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Send announcement to all users"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_ANNOUNCE_ALL_ALLHOSTS</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Send announcement to all users on all hosts"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_ANNOUNCE</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Send announcement to all online users"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_ANNOUNCE_ALLHOSTS</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Send announcement to all online users on all hosts"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_SET_MOTD</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Set message of the day and send to online users"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_SET_MOTD_ALLHOSTS</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Set message of the day on all hosts and send to online users"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_EDIT_MOTD</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Update message of the day (don't send)"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_EDIT_MOTD_ALLHOSTS</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Update message of the day on all hosts (don't send)"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_DELETE_MOTD</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Delete message of the day"</span>&gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">get_title</span><span class="params">(<span class="variable">Lang</span>, ?<span class="variable">NS_ADMIN_DELETE_MOTD_ALLHOSTS</span>)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">translate:translate</span>(<span class="variable">Lang</span>, &lt;&lt;<span class="string">"Delete message of the day on all hosts"</span>&gt;&gt;).</span><br></pre></td></tr></table></figure>
<p><code>translate:translate()</code>定义在<code>translate.erl</code>模块中.</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-spec translate<span class="function"><span class="params">(binary(), binary())</span> -&gt;</span> binary().</span><br><span class="line">translate<span class="function"><span class="params">(Lang, Msg)</span> -&gt;</span></span><br><span class="line">    LLang = ascii_tolower(Lang),</span><br><span class="line">    <span class="keyword">case</span> <span class="attribute">ets</span>:lookup(translations, &#123;LLang, Msg&#125;) <span class="keyword">of</span></span><br><span class="line">      [&#123;_, Trans&#125;]<span class="function"> -&gt;</span> Trans;</span><br><span class="line">      _<span class="function"> -&gt;</span></span><br><span class="line">	  ShortLang = <span class="keyword">case</span> <span class="attribute">str</span>:tokens(LLang, &lt;&lt;<span class="string">"-"</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">			[]<span class="function"> -&gt;</span> LLang;</span><br><span class="line">			[SL | _]<span class="function"> -&gt;</span> SL</span><br><span class="line">		      end,</span><br><span class="line">	  <span class="keyword">case</span> ShortLang <span class="keyword">of</span></span><br><span class="line">	    &lt;&lt;<span class="string">"en"</span>&gt;&gt;<span class="function"> -&gt;</span> Msg;</span><br><span class="line">	    LLang<span class="function"> -&gt;</span> translate(Msg);</span><br><span class="line">	    _<span class="function"> -&gt;</span></span><br><span class="line">		<span class="keyword">case</span> <span class="attribute">ets</span>:lookup(translations, &#123;ShortLang, Msg&#125;) <span class="keyword">of</span></span><br><span class="line">		  [&#123;_, Trans&#125;]<span class="function"> -&gt;</span> Trans;</span><br><span class="line">		  _<span class="function"> -&gt;</span> translate(Msg)</span><br><span class="line">		end</span><br><span class="line">	  end</span><br><span class="line">    end.</span><br></pre></td></tr></table></figure>
<p>当你在XML节上定义了<code>xml:lang=&#39;zh&#39;</code>属性后,服务端的应答文本就变为中文了, 如下:</p>
<p><img src="/assets/images/D373E553-9009-48E3-A9C3-5FD33D7C7080.png" alt="Erlang国际化文本-服务节点列表"></p>
<h2 id="增加自定义字符串">增加自定义字符串</h2><p>搞清楚了原理后,我就可以为我的模块添加字符串了.</p>
<p>首先我在我的模块中使用英文作为默认的文本描述, 如下所示:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#xmlel&#123;</span></span><br><span class="line">    <span class="variable">name =</span> &lt;&lt;<span class="string">"item"</span>&gt;&gt;,</span><br><span class="line">    <span class="variable">attrs =</span> [</span><br><span class="line">        &#123;&lt;&lt;<span class="string">"jid"</span>&gt;&gt;, Server&#125;,</span><br><span class="line">        &#123;&lt;&lt;<span class="string">"node"</span>&gt;&gt;, &lt;&lt;<span class="string">"http://www.example.com/protocol/messager#upgrade-full"</span>&gt;&gt;&#125;,</span><br><span class="line">        &#123;&lt;&lt;<span class="string">"name"</span>&gt;&gt;, translate:translate(Lang, &lt;&lt;<span class="string">"Make a complete upgrade"</span>&gt;&gt;)&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="variable">children =</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后根据<code>$EJABBERD_SRC/contrib/extract_translations/README</code>的描述,<br>需要编译<code>$EJABBERD_SRC/contrib/extract_translations/extract_translations.erl</code>模块.</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">erlc</span> <span class="variable">$EJABBERD_SRC</span>/contrib/extract_translations/extract_translations.erl</span><br></pre></td></tr></table></figure>
<p>Ejabberd提供了一个SHELL脚本来从<code>*.po</code>文件生成Ejabberd需要的<code>*.msg</code>文件.</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">4850618</span>fe551:~/ejabberd/contrib/extract_translations<span class="comment"># ./prepare-translation.sh -h</span></span><br><span class="line"><span class="type">Options</span>:</span><br><span class="line">  -langall</span><br><span class="line">  -lang <span class="type">LANGUAGE_FILE</span></span><br><span class="line">  -srcmsg2po <span class="type">LANGUAGE</span>   <span class="type">Construct</span> .msg file <span class="keyword">using</span> source code to <span class="type">PO</span> file</span><br><span class="line">  -src2pot              <span class="type">Generate</span> <span class="keyword">template</span> <span class="type">POT</span> file <span class="keyword">from</span> source code</span><br><span class="line">  -popot2po <span class="type">LANGUAGE</span>    <span class="type">Update</span> <span class="type">PO</span> file <span class="keyword">with</span> <span class="keyword">template</span> <span class="type">POT</span> file</span><br><span class="line">  -po2msg <span class="type">LANGUAGE</span>      <span class="type">Export</span> <span class="type">PO</span> file to <span class="type">MSG</span> file</span><br><span class="line">  -updateall            <span class="type">Generate</span> <span class="type">POT</span> <span class="keyword">and</span> update all <span class="type">PO</span></span><br><span class="line"><span class="type">Example</span>:</span><br><span class="line">  ./prepare-translation.sh -lang es.msg</span><br></pre></td></tr></table></figure>
<p>首先切换到源码根目录, 执行:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@4850618fe551</span><span class="symbol">:~/ejabberd</span><span class="comment"># ./contrib/extract_translations/prepare-translation.sh -src2pot</span></span><br><span class="line">./contrib/extract_translations/prepare-translation.<span class="symbol">sh:</span> line <span class="number">183</span><span class="symbol">:</span> <span class="symbol">msguniq:</span> command <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>
<p>找不到<code>msguniq</code>命令,在Ubuntu上,<code>msguniq</code>在<code>gettext</code>包种, 下面安装需要的软件包:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aptitude <span class="keyword">install</span> -y gettext</span><br></pre></td></tr></table></figure>
<p>执行下面的命令, 更新<code>ejabberd.pot</code>文件:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@4850618fe551</span><span class="symbol">:~/ejabberd</span><span class="comment"># ./contrib/extract_translations/prepare-translation.sh -src2pot</span></span><br></pre></td></tr></table></figure>
<p>打开<code>$EJABBERD_SRC/priv/msgs/ejabberd.pot</code>, 翻译相关条目后, 复制粘贴到到<code>$EJABBERD_SRC/priv/msgs/zh.po</code>中,</p>
<p><img src="/assets/images/4BD11A32-C9E4-4348-AD5A-60061B8998A5.png" alt="$EJABBERD_SRC/priv/msgs/ejabberd.pot"></p>
<p>并执行下面的命令,更新我的<code>zh.msg</code>文件, 这个文件是在Erlang代码中直接使用的文件. 后面会看到最终的效果.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./contrib/extract_translations/<span class="operator"><span class="keyword">prepare</span>-<span class="keyword">translation</span>.sh -po2msg zh</span></span><br></pre></td></tr></table></figure>
<p>更新后的消息文件在<code>$EJABBERD_SRC/priv/msgs/zh.msg</code></p>
<p><img src="/assets/images/95BD1DE1-C5C4-47AB-BB6E-B94A3ADF2811.png" alt="$EJABBERD_SRC/priv/msgs/zh.msg"></p>
<p>生成了我最终要的<code>zh.msg</code>文件后,重新编译一次ejabberd(之前已经编译过,这一步很快)</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@4850618fe551:~/ejabberd# make</span><br><span class="line"><span class="comment">/usr/lib/erlang/bin/escript rebar skip_deps=true compile</span></span><br><span class="line">=<span class="ruby"><span class="status">=&gt;</span> rel (compile)</span><br><span class="line"></span>=<span class="ruby"><span class="status">=&gt;</span> ejabberd (compile)</span><br><span class="line"></span>Compiled src/mod_online_users.erl</span><br><span class="line">Compiled src/mod_gbox_messager.erl</span><br><span class="line">Compiled src/mod_cputime.erl</span><br><span class="line">Compiled src/mod_system_information.erl</span><br></pre></td></tr></table></figure>
<p>复制编译的新文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">cp</span> ebin/<span class="regexp">*.beam</span> /lib/ejabberd/ebin</span><br><span class="line">cp priv/<span class="regexp">*.msg</span> /lib/ejabberd/priv/msgs</span><br></pre></td></tr></table></figure>
<p>最后重启,并测试</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ejabberdctl</span> restart</span><br></pre></td></tr></table></figure>
<p>查询命令列表(注意属性<code>xml:lang=&#39;zh&#39;</code>)</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="built_in">type</span>=<span class="string">'get'</span> <span class="keyword">to</span>=<span class="string">'xmpp.myserver.info'</span> from=<span class="string">'root@xmpp.myserver.info'</span> <span class="keyword">xm</span><span class="variable">l:lang</span>=<span class="string">'zh'</span> xmlns=<span class="string">'jabber:client'</span>&gt;</span><br><span class="line">  &lt;query xmlns=<span class="string">'http://jabber.org/protocol/disco#items'</span> node=<span class="string">'http://jabber.org/protocol/commands'</span>/&gt;</span><br><span class="line">&lt;/iq&gt;</span><br></pre></td></tr></table></figure>
<p>国际化后的结果</p>
<p><img src="/assets/images/1BD77F60-BE7B-48CF-B1BE-1933F3D9D839.png" alt="自定义Ad-Hoc Commands"></p>
<h2 id="参考资料">参考资料</h2><ol>
<li>$EJABBERD_SRC/src/mod_announce.erl</li>
<li>$EJABBERD_SRC/contrib/extract_translations/README</li>
<li>$EJABBERD_SRC/src/translate.erl</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-04T16:52:52.000Z"><a href="/2014/10/05/xmpp-xep-iot-relate/">2014-10-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/05/xmpp-xep-iot-relate/">XMPP 物联网相关协议扩展</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="XMPP/IoT相关协议">XMPP/IoT相关协议</h2><ul>
<li><p>高效数据互换格式<br><a href="http://xmpp.org/extensions/xep-0322.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0322.html</a> XEP-0322: Efficient XML Interchange (EXI) Format</p>
</li>
<li><p>物联网 - 传感器数据<br><a href="http://xmpp.org/extensions/xep-0323.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0323.html</a> XEP-0323: Internet of Things - Sensor Data<br>通过XMPP网络交换传感器数据,</p>
</li>
<li><p>物联网 - <code>Provisioning</code><br><a href="http://xmpp.org/extensions/xep-0324.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0324.html</a> XEP-0324: Internet of Things - Provisioning</p>
</li>
<li><p>物联网 - 控制<br><a href="http://xmpp.org/extensions/xep-0325.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0325.html</a> XEP-0325: Internet of Things - Control</p>
</li>
<li><p>物联网 - 集中器<br><a href="http://xmpp.org/extensions/xep-0326.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0326.html</a> XEP-0326: Internet of Things - Concentrator</p>
</li>
<li><p>物联网 - 发现<br><a href="http://xmpp.org/extensions/xep-0347.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0347.html</a> XEP-0347: Internet of Things - Discovery</p>
</li>
</ul>
<p>服务开通(英语：<code>Provisioning</code>)是一个电信行业的技术词汇,它是指准备和配备(preparing and equipping)一个网络,以允许其向它的用户提供(新)业务的处理过程.在(美国)国家安全/紧急准备电子通信(NS/EP telecommunications)业务中,服务开通等同于<code>开始</code>(initiation),并且包括改变一个已存在的优先服务或功能的状态.<br>英语<code>Provisioning</code>,的原意是<code>供应</code>,<code>预备</code>,电信行业中一般将其翻译成中文<code>服务开通</code>.也有文档称其为<code>开通</code>,<code>服务提供</code>,<code>服务供应</code>等.</p>
<ul>
<li>0322: EXI</li>
<li>0323: Sensor Data</li>
<li>0324: Provisioning</li>
<li>0325: Control</li>
<li>0326: Concentrators</li>
<li>0331: Color fields</li>
<li>0332: HTTP over XMpp</li>
<li>0336: Dynamic Forms</li>
<li>0347: Discovery</li>
<li>?: Interoperability</li>
<li>?: Events</li>
<li>?: Pubsub</li>
<li>?: Multicast</li>
<li>?: Chat</li>
<li>?: Battery powered devices</li>
</ul>
<h2 id="OneM2M联盟规范文档">OneM2M联盟规范文档</h2><p><code>oneM2M</code>是7个国家的电信联盟组成的合作机构,定制物联网机器到机器(M2M)应用层通信标准.</p>
<ul>
<li>无线通讯解决方案联盟(ATIS)</li>
<li>中国通讯标准化协会(CCSA)</li>
<li>欧洲电信标准协会(ETSI)</li>
<li>韩国电信技术协会(TTA)</li>
<li>日本电信技术委员会(TTC)</li>
<li>美国电信工业协会(TIA)</li>
<li>及日本电波产业协会(ARIB)</li>
</ul>
<p><a href="http://www.onem2m.org/candidate_release/index.cfm" target="_blank" rel="external">http://www.onem2m.org/candidate_release/index.cfm</a></p>
<p><code>M2M在线</code><br><a href="http://m2m.iot-online.com/" target="_blank" rel="external">http://m2m.iot-online.com/</a></p>
<p>功能架构<br>TS-0001-oneM2M-Functional-Architecture-V-2014-08<br>需求<br>TS-0002-Requirements-V-2014-08<br>安全方案<br>TS-0003-Security<em>Solutions-V-2014-08<br>核心协议<br>TS-0004-CoreProtocol-V-2014-08<br>管理(OMA)<br>TS-0005-Management_Enablement (OMA)-V-2014-08<br>管理(BBF)<br>TS-0006-Management_Enablement</em>(BBF)-V-2014-08<br>CoAP协议绑定<br>TS-0008-CoAP_Protocol_Binding-V-2014-08<br>HTTP协议绑定<br>TS-0009-HTTP_Protocol_Binding_V-2014-08<br>定义和缩写词<br>TS-0011-Definitions and Acronyms-V-2014-08</p>
<h2 id="资料">资料</h2><ol>
<li><p>XMPP Service Discovery extensions for M2M and IoT<br><a href="http://servicelab.org/2013/02/21/xmpp-service-discovery-extensions-for-m2m-and-iot/" target="_blank" rel="external">http://servicelab.org/2013/02/21/xmpp-service-discovery-extensions-for-m2m-and-iot/</a></p>
</li>
<li><p>oneM2M 候选规范<br><a href="http://www.onem2m.org/candidate_release/index.cfm" target="_blank" rel="external">http://www.onem2m.org/candidate_release/index.cfm</a></p>
</li>
<li><p><a href="http://m2m.iot-online.com/news/2013102224849.html" target="_blank" rel="external">http://m2m.iot-online.com/news/2013102224849.html</a></p>
</li>
</ol>
<!--
字段类型
    字段表示的值类型. 比如: 瞬时值(Momentary), 状态值(Status), 标识值(Identification), 计算值(Calculated), 峰值(Peak), 历史值(Historical),等.
Historical Value
    A value stored in memory from a previous timestamp.
Identification Value
    A value that can be used for identification. (Serial numbers, meter IDs, locations, names, etc.)
    Localization information
    Optional information for a field, allowing the sensor to control how the information should be presented to human viewers.
Meter
    A device possible containing multiple sensors, used in metering applications. Examples: Electricity meter, Water Meter, Heat Meter, Cooling Meter, etc.
Momentary Value
    A momentary value represents a value measured at the time of the read-out.
Node
    Graphs contain nodes and edges between nodes. In Internet of Things, sensors, actuators, meters, devices, gateways, etc., are often depicted as nodes whereas links between sensors (friendships) are depicted as edges. In abstract terms, it's easier to talk about a Node, rather than list different possible node types (sensors, actuators, meters, devices, gateways, etc.). Each Node has a Node ID.
Node ID
    An ID uniquely identifying a node within its corresponding context. If a globally unique ID is desired, an architecture should be used using a universally accepted ID scheme.
Parameter
    Readable and/or writable property on a node/device. The XEP-0326 Internet of Things - Concentrators (XEP-0326) [6] deals with reading and writing parameters on nodes/devices. Fields are not parameters, and parameters are not fields.
Peak Value
    A maximum or minimum value during a given period.
Precision
    In physics, precision determines the number of digits of precision. In sensor networks however, this definition is not easily applicable. Instead, precision determines, for example, the number of decimals of precision, or power of precision. Example: 123.200 MWh contains 3 decimals of precision. All entities parsing and delivering field information in sensor networks should always retain the number of decimals in a message.
Sensor
    Device measuring at least one digital value (0 or 1) or analog value (value with precision and physical unit). Examples: Temperature sensor, pressure sensor, etc. Sensor values are reported as fields during read-out. Each sensor has a unique Node ID.
SN
    Sensor Network. A network consisting, but not limited to sensors, where transport and use of sensor data is of primary concern. A sensor network may contain actuators, network applications, monitors, services, etc.
Status Value
    A value displaying status information about something.
Timestamp
    Timestamp of value, when the value was sampled or recorded.
Token
    A client, device or user can get a token from a provisioning server. These tokens can be included in requests to other entities in the network, so these entities can validate access rights with the provisioning server.
Unit
    Physical unit of value. Example: MWh, l/s, etc.
Value
    A field value.
Value Status
    Status of field value. Contains important status information for Quality of Service purposes. Examples: Ok, Error, Warning, Time Shifted, Missing, Signed, etc.
Value Type
    Can be numeric, string, boolean, Date & Time, Time Span or Enumeration.
WSN
    Wireless Sensor Network, a sensor network including wireless devices.
XMPP Client
    Application connected to an XMPP network, having a JID. Note that sensors, as well as applications requesting sensor data can be XMPP clients.
-->
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-04T10:25:55.000Z"><a href="/2014/10/04/erlang-universal-binary-format/">2014-10-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/04/erlang-universal-binary-format/">Erlang通用二进制格式</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><code>UBF</code>是一个让Erlang和外部世界交互的一个框架. 文档和相应的开源库基于<code>Joe Armstrong</code>最初的<code>UBF</code>站点和代码,增加了MIT许可文件,增加了大量的增强和改进.</p>
<p><code>UBF</code>是一个跨网络转换和描述复杂数据结构的语言. 它包括三个部分:</p>
<ul>
<li>UBF(a) 是一个<code>语言中性的</code>数据描述格式, 粗略地等同于具有良好格式的XML.</li>
<li>UBF(b) 是一个描述性的编程语言, 它用于描述<code>UBF(a)</code>中的类型, 以及客户端和服务器之间的协议.</li>
<li>UBF(c) 是一个在UBF客户端和UBF服务器之间使用的低级协议(meta-level).</li>
</ul>
<p><code>UBF</code>设计用于生产级别的部署和要求<code>24x7x365</code>可靠性的电信级系统.</p>
<h2 id="什么是语言中性?">什么是语言中性?</h2><p>这是相对于<code>语言独立的</code>二进制格式而言, 它的实现是与特定的语言相关的, 支持的格式定义语言如下:</p>
<ul>
<li>thrift</li>
<li>redis</li>
<li>jsonrpc</li>
<li>eep8</li>
<li>bertrpc</li>
<li>abnf</li>
</ul>
<p>可以在<a href="https://github.com/ubf/ubf" target="_blank" rel="external">项目首页</a>看到多种格式的实现.</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Erlang Universal Binary Format? Anyone using it?<br><a href="http://stackoverflow.com/questions/4731449/erlang-universal-binary-format-anyone-using-it" target="_blank" rel="external">http://stackoverflow.com/questions/4731449/erlang-universal-binary-format-anyone-using-it</a></li>
<li>项目地址<br><a href="https://github.com/ubf/ubf" target="_blank" rel="external">https://github.com/ubf/ubf</a></li>
<li>UBF用户指南<br><a href="http://ubf.github.io/ubf/ubf-user-guide.en.html" target="_blank" rel="external">http://ubf.github.io/ubf/ubf-user-guide.en.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-03T10:12:35.000Z"><a href="/2014/10/03/strophejs-plugins-register/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/strophejs-plugins-register/">XMPP Strophe.js插件 - 带内注册</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="客户端服务器交互">客户端服务器交互</h2><p>下图,是注册过程客户端和服务器的交互过程, 绿色的输出是客户端请求的XML节, 蓝色的输出是服务器应答的XML节.</p>
<p><img src="/assets/images/D6DC8BC6-6F30-49CA-B898-F47E9AD83A43.png" alt="XMPP Stanzas"></p>
<h2 id="下载插件">下载插件</h2><p><a href="https://github.com/strophe/strophejs-plugins/tree/master/register" target="_blank" rel="external">https://github.com/strophe/strophejs-plugins/tree/master/register</a></p>
<h2 id="HTML页面代码">HTML页面代码</h2><p>创建两个表单元素<code>username</code>和<code>password</code>用于获取用户名和密码, 一个<code>Register</code>按钮触发注册操作.<br>本文所演示示例的完整代码在此: <a href="https://gist.github.com/developerworks/317ccf6eb2d3060610f8" target="_blank" rel="external">https://gist.github.com/developerworks/317ccf6eb2d3060610f8</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span> <span class="attribute">lang</span>=<span class="value">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">title</span>&gt;</span>Register a user<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--// JQuery库--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"jquery.min.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--// Strophe.js库--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"strophe.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--// Strophe.js 注册插件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"strophe.register.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--// 注册业务逻辑--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"register.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">  Username:<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">id</span>=<span class="value">"username"</span> <span class="attribute">placeholder</span>=<span class="value">"Please input username"</span>/&gt;</span></span><br><span class="line">  Password<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">id</span>=<span class="value">"password"</span> <span class="attribute">placeholder</span>=<span class="value">"Please input your password"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">br</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"register"</span>&gt;</span>Register<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="回调函数">回调函数</h2><p><strong>register.js</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调试用,XML格式化函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatXml</span><span class="params">(xml)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> formatted = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> reg = <span class="regexp">/(&gt;)(&lt;)(\/*)/g</span>;</span><br><span class="line">  xml = xml.replace(reg, <span class="string">'$1\r\n$2$3'</span>);</span><br><span class="line">  <span class="keyword">var</span> pad = <span class="number">0</span>;</span><br><span class="line">  jQuery.each(xml.split(<span class="string">'\r\n'</span>), <span class="function"><span class="keyword">function</span> <span class="params">(index, node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> indent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (node.match(<span class="regexp">/.+&lt;\/\w[^&gt;]*&gt;$/</span>)) &#123;</span><br><span class="line">      indent = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.match(<span class="regexp">/^&lt;\/\w/</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (pad != <span class="number">0</span>) &#123;</span><br><span class="line">        pad -= <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.match(<span class="regexp">/^&lt;\w[^&gt;]*[^\/]&gt;.*$/</span>)) &#123;</span><br><span class="line">      indent = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      indent = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> padding = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pad; i++) &#123;</span><br><span class="line">      padding += <span class="string">'  '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    formatted += padding + node + <span class="string">'\r\n'</span>;</span><br><span class="line">    pad += indent;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> formatted;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Websocket端点</span></span><br><span class="line"><span class="keyword">var</span> BOSH_SERVICE = <span class="string">'ws://xmpp.myserver.info:5288'</span>;</span><br><span class="line"><span class="comment">// 域名</span></span><br><span class="line"><span class="keyword">var</span> DOMAIN_NAME = <span class="string">'xmpp.myserver.info'</span>;</span><br><span class="line"><span class="comment">// XMPP连接对象</span></span><br><span class="line"><span class="keyword">var</span> connection = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 浏览器控制台日志</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(msg, sent)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sent) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"%c\n"</span> + msg, <span class="string">"color:green;"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"%c\n"</span> + msg, <span class="string">"color:blue;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rawInput</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">  log(formatXml(data), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rawOutput</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">  log(formatXml(data), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  $(<span class="string">'#register'</span>).bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建连接</span></span><br><span class="line">    connection = <span class="keyword">new</span> Strophe.Connection(BOSH_SERVICE);</span><br><span class="line">    <span class="comment">// 注册事件处理器</span></span><br><span class="line">    connection.rawInput = rawInput;</span><br><span class="line">    connection.rawOutput = rawOutput;</span><br><span class="line">    <span class="comment">// 用户注册</span></span><br><span class="line">    connection.register.connect(DOMAIN_NAME, <span class="function"><span class="keyword">function</span> <span class="params">(status)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (status === Strophe.Status.REGISTER) &#123;</span><br><span class="line">        connection.register.fields.username = $(<span class="string">"#username"</span>).val();</span><br><span class="line">        connection.register.fields.password = $(<span class="string">"#password"</span>).val();</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">"registering..."</span>);</span><br><span class="line">        connection.register.submit();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.REGISTERED) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">"Registerd!"</span>);</span><br><span class="line">        connection.disconnect();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.CONFLICT) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"Username already exists."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.NOTACCEPTABLE) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"Registration form not properly filled out."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.REGIFAIL) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"The Server does not support In-Band Registration"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.CONNECTED) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">"Connected."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.DISCONNECTING) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Disconneting..."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (status === Strophe.Status.DISCONNECTED) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Disconneted."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">60</span>, <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-02T20:07:43.000Z"><a href="/2014/10/03/xmpp-xep-0198-stream-management-2/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/xmpp-xep-0198-stream-management-2/">XMPP XEP-0198流管理 - 实例分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>客户端启用流管理<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">enable</span> <span class="attribute">xmlns</span>=<span class="value">'urn:xmpp:sm:3'</span> <span class="attribute">resume</span>=<span class="value">'true'</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>服务端启用流管理</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;enabled <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"g2gCbQAAABkyNTY2MjI4NzA1MTQxMjIwMTU0MjEwMjkzaANiAAAFhGIAAE65YgAMkl8="</span></span><br><span class="line">    <span class="variable">resume=</span><span class="string">"true"</span> <span class="variable">max=</span><span class="string">"300"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>Strophe.js代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> enable = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> stanza = <span class="variable">$build</span>(<span class="string">'enable'</span>, &#123;xmlns: <span class="string">'urn:xmpp:sm:3'</span>, resume: <span class="keyword">true</span>&#125;);</span><br><span class="line">  connection.send(stanza.tree());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>服务器日志</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2014</span>-<span class="number">09</span>-<span class="number">29</span> <span class="number">22</span>:<span class="number">12</span>:<span class="number">39.416</span> [info] &lt;<span class="number">0.14329</span><span class="number">.0</span>&gt;<span class="annotation">@ejabberd</span><span class="string">_c2s:</span><span class="string">handle_enable:</span><span class="number">2676</span></span><br><span class="line">    Stream management with resumption enabled <span class="keyword">for</span> root<span class="annotation">@xmpp</span>.myserver.info/<span class="number">2619252428141228749171506</span></span><br></pre></td></tr></table></figure>
<p>当启用流管理功能后,客户端在发送和接受每一个XML节的时候,会附带收到<code>&lt;r/&gt;</code>请求</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;r <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span> xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>/&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-02T20:07:43.000Z"><a href="/2014/10/03/xmpp-xep-0198-stream-management/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/xmpp-xep-0198-stream-management/">XMPP XEP-0198流管理 - 协议</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文包括两个部分</p>
<ul>
<li>本规范引用自如下连接并对其<strong>修订</strong>,<strong>校对</strong>,<strong>补充</strong><br><a href="http://blog.csdn.net/yuedong56/article/details/38120101">http://blog.csdn.net/yuedong56/article/details/38120101</a>.</li>
</ul>
<h2 id="介绍">介绍</h2><p><a href="http://wiki.jabbercn.org/RFC6120#.E5.85.A8.E5.B1.80.E5.9C.B0.E5.9D.80">XMPP Core</a> 用XMPP定义了流的XML技术(也就是流的建立和终止,包括认证和加密).但是核心的XMPP协议并没有为管理一个灵活的XML流提供工具.</p>
<p>流管理背后的基本概念是,初始化的实体(一个服务端或者客户端)和接收的实体(一个服务端)可以为更灵活的管理stream交换<code>命令</code>.下面两条流管理的特性被广泛的关注,因为它们可以提高网络的可靠性和终端用户的体验:</p>
<ul>
<li>Stanza确认(Stanza Acknowledgements) — 能够确认一段或者一系列Stanza是否已被某一方接收.</li>
<li>流恢复(Stream Resumption) — 能够迅速的恢复(resume)一个已经被终止的流.</li>
</ul>
<p>流管理用较的短XML元素实现了这些特性,这些XML元素是在流的标准上的.这些元素并不是XMPP意义上的<code>stanzas</code>(也就是说,不是<code>&lt;iq/&gt;</code>,<code>&lt;message/&gt;</code>,或<code>&lt;presence/&gt;</code>这样的<code>stanzas</code>,<code>stanzas</code>在<strong>RFC 6120</strong>中有定义),它们不会在流管理中被<code>counted</code>或者被<code>acked</code>,因为它们是为管理stanzas本身而存在的.</p>
<p>流管理是在XML流的标准上使用的.检查一个给定的流TCP的连通性的时候,特别推荐使用<code>whitespace keepalives</code>(见<strong>RFC 6120</strong>),<a href="http://xmpp.org/extensions/xep-0199.html">XMPP Ping (XEP-0199)</a>或者<code>TCP keepalives</code>.对比流管理,高级消息处理<a href="http://xmpp.org/extensions/xep-0079.html">Advanced Message Processing (XEP-0079)</a>和消息回执<a href="http://xmpp.org/extensions/xep-0184.html">Message Delivery Receipts (XEP-0184)</a>,定义了<code>Ack</code>,它可以通过多个流实现端对端的传输;这些特性在一些特殊情况中是有用的,但是没必要去检查在两个xmpp实体之间直接传递的流.</p>
<p>注:流管理可以用于服务端到服务端,客户端到服务端的流.但是,为了方便,本规范只讨论客户端到服务端的流.同样的原则也适用于服务器到服务器的流.(在本文档中,以<strong>C:</strong>开头的都是由客户端发送的,由<strong>S:</strong>开头的都是由服务器发送的).</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/10/03/xmpp-xep-0198-stream-management/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T19:23:39.000Z"><a href="/2014/10/02/erlang-mysql-driver/">2014-10-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/02/erlang-mysql-driver/">Erlang MySQL驱动</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="编译">编译</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone git:<span class="comment">//github.com/dizzyd/erlang-mysql-driver.git erlang-mysql-driver.git</span></span><br><span class="line"><span class="keyword">cd</span> erlang-mysql-driver</span><br><span class="line">wget -O ./build.<span class="keyword">sh</span> http:<span class="comment">//svn.process-one.net/ejabberd-modules/mysql/trunk/build.sh</span></span><br><span class="line">chmod +x ./build.<span class="keyword">sh</span></span><br><span class="line">./build.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/build-erlang-mysql-driver.png" alt="编译erlang-mysql-driver"></p>
<h2 id="Examples">Examples</h2><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">%% Author: Administrator</span><br><span class="line">%% Created: <span class="number">2011</span>-<span class="number">5</span>-<span class="number">15</span></span><br><span class="line">%% Description: TODO: Add description <span class="keyword">to</span> test</span><br><span class="line">-<span class="keyword">module</span>(test).</span><br><span class="line">%%</span><br><span class="line">%% Include files</span><br><span class="line">%%</span><br><span class="line">%%</span><br><span class="line">%% Exported Functions</span><br><span class="line">%%</span><br><span class="line">-export([start/<span class="number">0</span>]).</span><br><span class="line">%%</span><br><span class="line">%% API Functions</span><br><span class="line">%%</span><br><span class="line">%%</span><br><span class="line">%% Local Functions</span><br><span class="line">%%</span><br><span class="line">start() -&gt;</span><br><span class="line">%% Build connection</span><br><span class="line">%% 注意最后一个参数,utf8,支持中文必杀技.</span><br><span class="line">    mysql:start_link(connection,<span class="string">"localhost"</span>, <span class="number">3306</span>,<span class="string">"root"</span>, <span class="string">"root"</span>, <span class="string">"erlang"</span>, undefined, utf8),</span><br><span class="line">%% INSERT</span><br><span class="line">    _result = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"INSERT INTO test_table (id, first_name, last_name) VALUES(default, '你好', '世界')"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result1: ~p~n"</span>, [_result]),</span><br><span class="line">%% SELECT</span><br><span class="line">    _result2 = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"SELECT * FROM test_table;"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result2: ~p~n"</span>, [_result2]),</span><br><span class="line">%% UPDATE</span><br><span class="line">    _result3 = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"UPDATE test_table SET first_name = 'River' WHERE first_name = 'ZHIQIANG' AND last_name = 'HE';"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result3: ~p~n"</span>, [_result3]),</span><br><span class="line">%% SELECT</span><br><span class="line">    _result4 = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"SELECT * FROM test_table;"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result4: ~p~n"</span>, [_result4]),</span><br><span class="line">%% DELETE</span><br><span class="line">    _result5 = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"DELETE FROM test_table WHERE last_name = 'HE' AND first_name = 'River';"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result5: ~p~n"</span>, [_result5]),</span><br><span class="line">%% SELECT</span><br><span class="line">    _result6 = mysql:fetch(connection, <span class="annotation">[&lt;&lt;"SELECT * FROM test_table;"&gt;&gt;]</span>),</span><br><span class="line">    io:format(<span class="string">"Result6: ~p~n"</span>, [_result6]),</span><br><span class="line">    ok.</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T18:38:09.000Z"><a href="/2014/10/02/ejabberd-pubsub/">2014-10-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/02/ejabberd-pubsub/">Ejabberd 发布订阅实验</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="环境">环境</h2><table>
<thead>
<tr>
<th>Software</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ejabberd</td>
<td>14.07</td>
</tr>
<tr>
<td>Strophe.js</td>
<td>1.1.3</td>
</tr>
</tbody>
</table>
<h2 id="创建节点">创建节点</h2><p>Strophe.js代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createnode = <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> iq = <span class="variable">$iq</span>(&#123;</span><br><span class="line">    type: <span class="string">'set'</span>,</span><br><span class="line">    from: jid,</span><br><span class="line">    to: session.pubsub,</span><br><span class="line">    id: getId()</span><br><span class="line">  &#125;).c(<span class="string">'pubsub'</span>, &#123;xmlns: <span class="string">'http://jabber.org/protocol/pubsub'</span>&#125;)</span><br><span class="line">    .c(<span class="string">'create'</span>, &#123;node: node&#125;);</span><br><span class="line">  connection.send(iq.tree());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>XML节</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--客户端IQ-set请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'set'</span></span><br><span class="line">    <span class="attribute">from</span>=<span class="value">'root@xmpp.myserver.info'</span></span><br><span class="line">    <span class="attribute">to</span>=<span class="value">'pubsub.xmpp.myserver.info'</span></span><br><span class="line">    <span class="attribute">id</span>=<span class="value">'id-1412188942892'</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">pubsub</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/pubsub'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">create</span> <span class="attribute">node</span>=<span class="value">'/home/test2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">pubsub</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--服务端应答IQ-result--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">from</span>=<span class="value">"pubsub.xmpp.myserver.info"</span></span><br><span class="line">    <span class="attribute">to</span>=<span class="value">"root@xmpp.myserver.info/17735350171411959891145164"</span></span><br><span class="line">    <span class="attribute">id</span>=<span class="value">"id-1412188942892"</span></span><br><span class="line">    <span class="attribute">type</span>=<span class="value">"result"</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">"jabber:client"</span></span><br><span class="line">    <span class="attribute">xmlns:stream</span>=<span class="value">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">pubsub</span> <span class="attribute">xmlns</span>=<span class="value">"http://jabber.org/protocol/pubsub"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">create</span> <span class="attribute">node</span>=<span class="value">"/home/test2"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">pubsub</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="订阅">订阅</h2><p>Strophe.js代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subscribe = <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> iq = <span class="variable">$iq</span>(&#123;</span><br><span class="line">    type: <span class="string">'set'</span>,</span><br><span class="line">    from: jid,</span><br><span class="line">    to: session.pubsub,</span><br><span class="line">    id: getId()</span><br><span class="line">  &#125;).c(<span class="string">'pubsub'</span>, &#123;xmlns: <span class="string">'http://jabber.org/protocol/pubsub'</span>&#125;)</span><br><span class="line">    .c(<span class="string">'subscribe'</span>, &#123;node: node, jid: jid&#125;);</span><br><span class="line">  connection.send(iq.tree());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>XML节</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--客户端IQ-set请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'set'</span> <span class="attribute">from</span>=<span class="value">'root@xmpp.myserver.info'</span></span><br><span class="line">    <span class="attribute">to</span>=<span class="value">'pubsub.xmpp.myserver.info'</span> <span class="attribute">id</span>=<span class="value">'id-1412189193003'</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">pubsub</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/pubsub'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">subscribe</span> <span class="attribute">node</span>=<span class="value">'/home/test'</span> <span class="attribute">jid</span>=<span class="value">'root@xmpp.myserver.info'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">pubsub</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--服务端应答IQ-result--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">from</span>=<span class="value">"pubsub.xmpp.myserver.info"</span></span><br><span class="line">    <span class="attribute">to</span>=<span class="value">"root@xmpp.myserver.info/17735350171411959891145164"</span></span><br><span class="line">    <span class="attribute">id</span>=<span class="value">"id-1412189193003"</span> <span class="attribute">type</span>=<span class="value">"result"</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">"jabber:client"</span> <span class="attribute">xmlns:stream</span>=<span class="value">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">pubsub</span> <span class="attribute">xmlns</span>=<span class="value">"http://jabber.org/protocol/pubsub"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">subscription</span></span><br><span class="line">        <span class="attribute">jid</span>=<span class="value">"root@xmpp.myserver.info"</span> <span class="attribute">subscription</span>=<span class="value">"subscribed"</span> <span class="attribute">subid</span>=<span class="value">"583EAABFD09CF"</span></span><br><span class="line">        <span class="attribute">node</span>=<span class="value">"/home/test"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">pubsub</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://wiki.jabbercn.org/XEP-0060#.E5.88.9B.E5.BB.BA.E8.8A.82.E7.82.B9" target="_blank" rel="external">http://wiki.jabbercn.org/XEP-0060#.E5.88.9B.E5.BB.BA.E8.8A.82.E7.82.B9</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T14:47:12.000Z"><a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/">2014-10-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/">XMPP XEP-0184消息回执</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://xmpp.org/extensions/xep-0184.html">XEP-0184</a>, 定义如下:</p>
<p>本规范定义了一个关于<code>消息送达收条</code>的XMPP协议扩展,消息的发送者可以要求消息的接收设备在接收到消息后发送一个确认消息(收条). 比如: 发邮件给对方可以要求一个邮件回执,以确定对方收到消息. 如果没有收到回执,可以重新发送.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T13:27:52.000Z"><a href="/2014/10/01/erlang-application/">2014-10-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/01/erlang-application/">应用程序简介</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>In OTP, application denotes a component implementing some specific functionality, that can be started and stopped as a unit, and which can be re-used in other systems as well. This module interfaces the application controller, a process started at every Erlang runtime system, and contains functions for controlling applications (for example starting and stopping applications), and functions to access information about applications (for example configuration parameters).</p>
<p>An application is defined by an application specification. The specification is normally located in an application resource file called Application.app, where Application is the name of the application. Refer to app(4) for more information about the application specification.</p>
<p>This module can also be viewed as a behaviour for an application implemented according to the OTP design principles as a supervision tree. The definition of how to start and stop the tree should be located in an application callback</p>
<p>在OPT中,一个应用程序表示一个实现了特定功能的组件, 可以作为独立的单元start和stop,可以在其他系统中重用.</p>
<p><code>application</code>模块与<code>application controller</code>连接, <code>application controller</code> 是一个随erlang系统启动的进程.用于控制应用程序(启动,停止,访问应用程序信息).</p>
<ul>
<li><code>application specification</code><br>描述如何定义一个应用程序</li>
<li><code>application resource file</code>(<code>Application</code>.app)<br><code>Application</code>为应用程序的名称</li>
<li><code>erl -man app</code><br>查看应用程序资源文件的详细规范</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T17:01:37.000Z"><a href="/2014/09/30/ejabberd-modules-get-room-member-list/">2014-09-30</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/30/ejabberd-modules-get-room-member-list/">Ejabberd模块 - 获取房间成员列表</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>上一篇<a href="/2014/09/29/ejabberd-modules-pitfalls">Ejabberd 14.x版本系列模块开发过程中遇到的坑</a>,一个很坑的移植过程,没找到相关的升级文档,全靠读代码. -_-!</p>
<p>本模块用于获取一个房间内的所有成员, 代码在<a href="https://gist.github.com/developerworks/798d67182b38eda72e25" target="_blank" rel="external">这里</a>, 本模块修改自<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">获取房间的用户列表模块</a>, 兼容<code>ejabberd 14.x</code>系列版本.</p>
<h2 id="Bugfix">Bugfix</h2><ol>
<li><code>muc_room</code>表结构有变化, 下面是输出的日志,为了便于阅读,我在每个元素前附加序号作为前缀</li>
</ol>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">[<span class="collection">&#123;muc_room,</span><br><span class="line">    <span class="collection">&#123;&lt;&lt;<span class="string">"test"</span>&gt;&gt;,&lt;&lt;<span class="string">"conference.xmpp.myserver.info"</span>&gt;&gt;&#125;</span>,</span><br><span class="line">    <span class="collection">[</span><br><span class="line">        <span class="number">1</span>  <span class="collection">&#123;title,&lt;&lt;232,<span class="number">129</span>,<span class="number">138</span>,<span class="number">229</span>,<span class="number">164</span>,<span class="number">169</span>,<span class="number">229</span>,<span class="number">174</span>,<span class="number">164</span>,<span class="number">230</span>,<span class="number">160</span>,<span class="number">135</span>,<span class="number">233</span>,<span class="number">162</span>,<span class="number">152</span>&gt;&gt;&#125;</span>,</span><br><span class="line">        <span class="number">2</span>  <span class="collection">&#123;description,&lt;&lt;232,<span class="number">129</span>,<span class="number">138</span>,<span class="number">229</span>,<span class="number">164</span>,<span class="number">169</span>,<span class="number">229</span>,<span class="number">174</span>,<span class="number">164</span>,<span class="number">230</span>,<span class="number">143</span>,<span class="number">143</span>,<span class="number">232</span>,<span class="number">191</span>,<span class="number">176</span>&gt;&gt;&#125;</span>,</span><br><span class="line">        <span class="number">3</span>  <span class="collection">&#123;allow_change_subj,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">4</span>  <span class="collection">&#123;allow_query_users,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">5</span>  <span class="collection">&#123;allow_private_messages,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">6</span>  <span class="collection">&#123;allow_private_messages_from_visitors,anyone&#125;</span>,</span><br><span class="line">        <span class="number">7</span>  <span class="collection">&#123;allow_visitor_status,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">8</span>  <span class="collection">&#123;allow_visitor_nickchange,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">9</span>  <span class="collection">&#123;public,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">10</span> <span class="collection">&#123;public_list,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">11</span> <span class="collection">&#123;persistent,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">12</span> <span class="collection">&#123;moderated,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">13</span> <span class="collection">&#123;members_by_default,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">14</span> <span class="collection">&#123;members_only,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">        <span class="number">15</span> <span class="collection">&#123;allow_user_invites,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">        <span class="number">16</span> <span class="collection">&#123;password_protected,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">        <span class="number">17</span> <span class="collection">&#123;captcha_protected,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">        <span class="number">18</span> <span class="collection">&#123;password,&lt;&lt;&gt;&gt;&#125;</span>,</span><br><span class="line">        <span class="number">19</span> <span class="collection">&#123;anonymous,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">20</span> <span class="collection">&#123;logging,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">        <span class="number">21</span> <span class="collection">&#123;max_users,<span class="number">200</span>&#125;</span>,</span><br><span class="line">        <span class="number">22</span> <span class="collection">&#123;allow_voice_requests,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">        <span class="number">23</span> <span class="collection">&#123;voice_request_min_interval,<span class="number">1800</span>&#125;</span>,</span><br><span class="line">        <span class="number">24</span> <span class="collection">&#123;vcard,&lt;&lt;&gt;&gt;&#125;</span>,</span><br><span class="line">        <span class="number">25</span> <span class="collection">&#123;captcha_whitelist,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">        <span class="number">26</span> <span class="collection">&#123;affiliations,<span class="collection">[</span><br><span class="line">            <span class="collection">&#123;</span><br><span class="line">                <span class="collection">&#123;&lt;&lt;<span class="string">"hezhiqiang"</span>&gt;&gt;,&lt;&lt;<span class="string">"xmpp.myserver.info"</span>&gt;&gt;,&lt;&lt;&gt;&gt;&#125;</span>,</span><br><span class="line">                <span class="collection">&#123;owner,&lt;&lt;&gt;&gt;&#125;</span></span><br><span class="line">            &#125;</span></span><br><span class="line">        ]</span>&#125;</span>,</span><br><span class="line">        <span class="number">27</span> <span class="collection">&#123;subject,&lt;&lt;&gt;&gt;&#125;</span>,</span><br><span class="line">        <span class="number">28</span> <span class="collection">&#123;subject_author,&lt;&lt;&gt;&gt;&#125;</span></span><br><span class="line">    ]</span>&#125;</span>]</span></span><br></pre></td></tr></table></figure>
<p>其中元素<code>affiliations</code>位于房间配置列表第26个元素,和<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">原文&lt;&lt;获取房间的用户列表模块&gt;&gt;</a>不同</p>
<h2 id="补充">补充</h2><p>忘了一件事, 需要在<code>$EJABBERD/tools/xmpp_codec.spec</code>增加下列代码:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-xml(room_member_item,</span><br><span class="line">     <span class="comment">#elem&#123;name = &lt;&lt;"item"&gt;&gt;,</span></span><br><span class="line">           xmlns = &lt;&lt;<span class="string">"http://jabber.org/protocol/muc#member-list"</span>&gt;&gt;,</span><br><span class="line">           <span class="literal">result</span> = '$jid',</span><br><span class="line">           attrs = [<span class="comment">#attr&#123;name = &lt;&lt;"jid"&gt;&gt;,</span></span><br><span class="line">                          required = <span class="literal">true</span>,</span><br><span class="line">                          dec = &#123;dec_jid, []&#125;,</span><br><span class="line">                          enc = &#123;enc_jid, []&#125;&#125;]&#125;).</span><br><span class="line">-xml(room_member,</span><br><span class="line">     <span class="comment">#elem&#123;name = &lt;&lt;"query"&gt;&gt;,</span></span><br><span class="line">           xmlns = &lt;&lt;<span class="string">"http://jabber.org/protocol/muc#member-list"</span>&gt;&gt;,</span><br><span class="line">           <span class="literal">result</span> = &#123;room_member, '$items'&#125;,</span><br><span class="line">           refs = [<span class="comment">#ref&#123;name = room_member_item,</span></span><br><span class="line">                        label = '$items'&#125;]&#125;).</span><br></pre></td></tr></table></figure>
<p>并执行<code>make spec</code>更新, 然后再 <code>make &amp;&amp; make install</code>, 最后 <code>ejabberdctl restart</code></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-erlang1" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/opensource/os-erlang1</a></li>
<li>Erlang标准库函数 <code>lists:any/2</code><br><a href="http://www.erlang.org/doc/man/lists.html#any-2" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html#any-2</a></li>
<li>Erlang标准库函数 <code>lists:nth/2</code><br><a href="http://www.erlang.org/doc/man/lists.html#nth-2" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html#nth-2</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T13:18:49.000Z"><a href="/2014/09/29/ejabberd-modules-pitfalls/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-modules-pitfalls/">Ejabberd 14.x版本系列模块开发过程中遇到的坑</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>网上的资料多数都是<code>2.x</code>版本的, 从Ejabberd2.x系列迁移到14.x,路上遇到很多坑坑洼洼, 这里以一个<code>mod_cputime</code>模块为实例记录一下坑爹的过程.</p>
<h2 id="自定义新的名称空间问题">自定义新的名称空间问题</h2><p>如果你想要直接使用<code>mod_disco:register_feature/2</code>来创建一个名称空间,<em>那是不行的</em>,为什么不行, 下面我来细讲:</p>
<p>你会碰到各种<code>badxml</code>的错误. 从结果倒推,ejabberd应该是使用了<code>xmpp_codec.erl</code>来验证交互过程中传递的XML节的有效性,无效的统统抛弃,增强安全性,这样模块就不能随意增加名称空间.</p>
<p>设<code>$EJABBERD_SRC</code>为源码根目录.</p>
<ul>
<li>在<code>14.07</code>中, 首先需要在<code>$EJABBERD_SRC/tools/xmpp_codec.spec</code>增加你需要扩展的名称空间, 例如:</li>
</ul>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-xml(cpu_time,</span><br><span class="line">     <span class="comment">#elem&#123;name = &lt;&lt;"time"&gt;&gt;,</span></span><br><span class="line">           xmlns = &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;,</span><br><span class="line">           <span class="literal">result</span> = '$cdata',</span><br><span class="line">           cdata = <span class="comment">#cdata&#123;label = '$cdata', required = true &#125;&#125;).</span></span><br><span class="line">-xml(cpu,</span><br><span class="line">    <span class="comment">#elem&#123;name = &lt;&lt;"query"&gt;&gt;,</span></span><br><span class="line">          xmlns = &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;,</span><br><span class="line">          <span class="literal">result</span> = &#123;cpu, '$time'&#125;,</span><br><span class="line">          refs = [<span class="comment">#ref&#123;name = cpu_time,</span></span><br><span class="line">                       label = '$time',</span><br><span class="line">                       min = <span class="number">0</span>, max = <span class="number">1</span>&#125;]&#125;).</span><br></pre></td></tr></table></figure>
<ul>
<li><p>然后在ejabberd的源代码根目录下执行<code>make spec</code>生成新的<code>xmpp_codec.hrl</code>,<code>xmpp_codec.erl</code>两个文件.</p>
</li>
<li><p><code>make &amp;&amp; make install</code></p>
</li>
<li><p><code>ejabberdctl restart</code></p>
</li>
</ul>
<p>还有一点要注意的时, 所有<code>#xmlel</code>, <code>#jid</code>, <code>#iq</code>这些记录中对应的XML标签名称, 属性名称, 以及CDATA的数据类型必须是类似<code>&lt;&lt;&quot;iq&quot;&gt;&gt;</code>这种二进制字符串. 否则也会出现各种意想不到的错误.</p>
<p>Ejabberd的文档不多,也比较碎片化,为了避免掉进各种坑里面,还是多研究源码,多试错.</p>
<h2 id="添加新名称空间iq处理模块">添加新名称空间iq处理模块</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_cputime)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">    start/<span class="number">2</span>,</span><br><span class="line">    stop/<span class="number">1</span>,</span><br><span class="line">    process_local_iq/<span class="number">3</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">NS_CPUTIME</span>, &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;)</span></span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">Host</span>, <span class="variable">Opts</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">IQDisc</span> = <span class="function_name">gen_mod:get_opt</span>(</span><br><span class="line">        iqdisc,</span><br><span class="line">        <span class="variable">Opts</span>,</span><br><span class="line">        <span class="keyword">fun</span> gen_iq_handler:check_type/<span class="number">1</span>,</span><br><span class="line">        one_queue</span><br><span class="line">    ),</span><br><span class="line">    <span class="function_name">mod_disco:register_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:add_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>, ?<span class="variable">MODULE</span>, process_local_iq, <span class="variable">IQDisc</span>),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">stop</span>(<span class="variable">Host</span>) -&gt;</span><br><span class="line">    <span class="function_name">mod_disco:unregister_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:remove_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">process_local_iq</span>(<span class="variable">_From</span>, <span class="variable">_To</span>, <span class="record_name">#iq</span>&#123;type = <span class="variable">Type</span>, sub_el = <span class="variable">SubEl</span>&#125; = <span class="variable">IQ</span>) -&gt;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">Type</span> <span class="keyword">of</span></span><br><span class="line">        set -&gt;</span><br><span class="line">            <span class="variable">IQ</span><span class="record_name">#iq</span>&#123;type = error, sub_el = [<span class="variable">SubEl</span>, ?<span class="variable">ERR_NOT_ALLOWED</span>]&#125;;</span><br><span class="line">        get -&gt;</span><br><span class="line">            <span class="variable">CPUTime</span> = <span class="function_name">element</span>(<span class="number">1</span>, <span class="function_name">erlang:statistics</span>(runtime)) / <span class="number">1000</span>,</span><br><span class="line">            <span class="variable">SCPUTime</span> = <span class="function_name">lists:flatten</span>(<span class="function_name">io_lib:format</span>(<span class="string">"~.3f"</span>, [<span class="variable">CPUTime</span>])),</span><br><span class="line">            <span class="variable">Packet</span> = <span class="record_name">#iq</span>&#123;type = result, sub_el = [</span><br><span class="line">                <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"query"</span>&gt;&gt;, attrs = [<span class="tuple">&#123;&lt;&lt;<span class="string">"xmlns"</span>&gt;&gt;, ?<span class="variable">NS_CPUTIME</span>&#125;</span>], children = [</span><br><span class="line">                    <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"time"</span>&gt;&gt;, attrs = [], children = [<span class="tuple">&#123;xmlcdata, <span class="function_name">list_to_binary</span>(<span class="variable">SCPUTime</span>)&#125;</span>]&#125;]&#125;</span><br><span class="line">            ]&#125;,</span><br><span class="line">            <span class="variable">Packet</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>把上面的代码放到<code>$EJABBERD_SRC/src</code>下面,然后<code>make &amp;&amp; make install</code>,<br>在配置文件<code>/etc/ejabberd/ejabberd.yml</code>增加一个模块配置,如下:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">##</span></span><br><span class="line"><span class="preprocessor">## Modules enabled in all ejabberd virtual hosts.</span></span><br><span class="line"><span class="preprocessor">##</span></span><br><span class="line">modules:</span><br><span class="line">  mod_cputime: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>执行<code>ejabberdctl restart</code>重启ejabberd.</p>
<h2 id="验证">验证</h2><p>客户端发起一个<code>IQ-get</code>请求</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'get'</span> <span class="attribute">to</span>=<span class="value">'xmpp.myserver.info'</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">query</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/disco#info'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务端<code>IQ-result</code>应答</p>
<p><img src="/assets/images/2EC981C0-DFFB-415F-BBA5-F767C4EB5DA0.png" alt="自定义名称空间的Features列表"></p>
<h2 id="验证模块是否能够工作">验证模块是否能够工作</h2><p>客户端发起<code>IQ-get</code>请求一个CPU时间</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="keyword">type</span>=<span class="symbol">'get'</span> <span class="keyword">to</span>=<span class="symbol">'xmpp</span>.myserver.info' xmlns=<span class="symbol">'jabber</span>:client'&gt;</span><br><span class="line">  &lt;query xmlns=<span class="symbol">'ejabberd</span>:cputime'/&gt;</span><br><span class="line">&lt;/iq&gt;</span><br></pre></td></tr></table></figure>
<p>服务端<code>IQ-result</code>应答</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="variable">from=</span><span class="string">"xmpp.myserver.info"</span></span><br><span class="line">    <span class="variable">to=</span><span class="string">"root@xmpp.myserver.info/1507629570141186050149354"</span></span><br><span class="line">    <span class="variable">type=</span><span class="string">"result"</span></span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="variable">version=</span><span class="string">"1.0"</span>&gt;</span><br><span class="line">  &lt;query <span class="variable">xmlns=</span><span class="string">"ejabberd:cputime"</span>&gt;</span><br><span class="line">    &lt;time&gt;<span class="number">3.840</span>&lt;/time&gt;</span><br><span class="line">  &lt;/query&gt;</span><br><span class="line">&lt;/iq&gt;</span><br></pre></td></tr></table></figure>
<p>客户端代码在<a href="https://gist.github.com/developerworks/842fbc5b6092b3c5823e" target="_blank" rel="external">这里</a>,包含三个文件, <a href="/2014/09/30/ejabberd-modules-get-room-member-list">下一篇</a>把<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">获取房间的用户列表</a>模块移植到<code>ejabberd 14.07</code></p>
<h2 id="要用到二进制字符串的地方">要用到二进制字符串的地方</h2><p>这里强调一下</p>
<ul>
<li><p>定义名称空间的位置</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">define</span><span class="params">(NS_CPUTIME, &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;)</span></span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>XML元素的属性名称和属性值</p>
</li>
<li><code>jlib:jid_to_string()</code>接受一个<code>#jid</code>或一个三元组,<code>User</code>,<code>Server</code>,<code>Resource</code>为字符串类型(Erlang中的字符串就是一个字符列表). 从<code>jlib.erl</code>中的定义我们可以看到,内部使用了<code>iolist_to_binary</code>对列表进行转换. 这里类型不要传错了</li>
</ul>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">jid_to_string</span><span class="params">(<span class="record_name">#jid</span>&#123;user = <span class="variable">User</span>, server = <span class="variable">Server</span>,</span><br><span class="line">		   resource = <span class="variable">Resource</span>&#125;)</span> -&gt;</span></span><br><span class="line">    <span class="function_name">jid_to_string</span>(<span class="tuple">&#123;<span class="variable">User</span>, <span class="variable">Server</span>, <span class="variable">Resource</span>&#125;</span>);</span><br><span class="line"><span class="function"><span class="title">jid_to_string</span><span class="params">(<span class="tuple">&#123;<span class="variable">N</span>, <span class="variable">S</span>, <span class="variable">R</span>&#125;</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">Node</span> = <span class="function_name">iolist_to_binary</span>(<span class="variable">N</span>),</span><br><span class="line">    <span class="variable">Server</span> = <span class="function_name">iolist_to_binary</span>(<span class="variable">S</span>),</span><br><span class="line">    <span class="variable">Resource</span> = <span class="function_name">iolist_to_binary</span>(<span class="variable">R</span>),</span><br><span class="line">    <span class="variable">S1</span> = <span class="keyword">case</span> <span class="variable">Node</span> <span class="keyword">of</span></span><br><span class="line">	   &lt;&lt;<span class="string">""</span>&gt;&gt; -&gt; &lt;&lt;<span class="string">""</span>&gt;&gt;;</span><br><span class="line">	   <span class="variable">_</span> -&gt; &lt;&lt;<span class="variable">Node</span>/binary, <span class="string">"@"</span>&gt;&gt;</span><br><span class="line">	 <span class="keyword">end</span>,</span><br><span class="line">    <span class="variable">S2</span> = &lt;&lt;<span class="variable">S1</span>/binary, <span class="variable">Server</span>/binary&gt;&gt;,</span><br><span class="line">    <span class="variable">S3</span> = <span class="keyword">case</span> <span class="variable">Resource</span> <span class="keyword">of</span></span><br><span class="line">	   &lt;&lt;<span class="string">""</span>&gt;&gt; -&gt; <span class="variable">S2</span>;</span><br><span class="line">	   <span class="variable">_</span> -&gt; &lt;&lt;<span class="variable">S2</span>/binary, <span class="string">"/"</span>, <span class="variable">Resource</span>/binary&gt;&gt;</span><br><span class="line">	 <span class="keyword">end</span>,</span><br><span class="line">    <span class="variable">S3</span>.</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>Ejabberd Developers Guide<br><a href="http://www.girlsnn.net/ejabberd/doc/dev.html#sec15" target="_blank" rel="external">http://www.girlsnn.net/ejabberd/doc/dev.html#sec15</a></li>
<li>获取用户房间列表<br><a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist</a></li>
<li>Strophe.js API文档<br><a href="http://strophe.im/strophejs/doc/1.1.3/files/strophe-js.html" target="_blank" rel="external">http://strophe.im/strophejs/doc/1.1.3/files/strophe-js.html</a></li>
<li>Ejabberd IQ 处理程序<br><a href="https://www.process-one.net/en/wiki/ejabberd_IQ_handlers/" target="_blank" rel="external">https://www.process-one.net/en/wiki/ejabberd_IQ_handlers/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T12:30:48.000Z"><a href="/2014/09/29/ejabberd-important-records/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-important-records/">Ejabberd中几个重要的Record结构</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd中几非常重要的记录结构, 贯穿整个Ejabberd的开发, 非常基础, 如果不能很好的理解,那么几乎不能很好的扩展Ejabberd的功能.</p>
<h2 id="jid"><code>jid</code></h2><p>Jabber 标识, 最基本的一个record结构, 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中,包含6个字段</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-record(jid, <span class="keyword">&#123;</span><span class="keyword">user</span> = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              server = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              resource = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              luser = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              lserver = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              lresource = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>()<span class="keyword">&#125;</span>).</span><br></pre></td></tr></table></figure>
<h2 id="iq"><code>iq</code></h2><p>Info/Query 节, XMPP协议中三个基本的XML节之一, 并且是三个中最重要的一个, 大多数交互都是靠它来完成的. 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-record(iq, &#123;id = &lt;&lt;<span class="string">""</span>&gt;&gt;       :: binary(),</span><br><span class="line">             <span class="keyword">type</span> = get        :: get | <span class="type">set</span> | <span class="literal">result</span> | error,</span><br><span class="line">             xmlns = &lt;&lt;<span class="string">""</span>&gt;&gt;    :: binary(),</span><br><span class="line">             lang  = &lt;&lt;<span class="string">""</span>&gt;&gt;    :: binary(),</span><br><span class="line">             sub_el = <span class="comment">#xmlel&#123;&#125; :: xmlel() | [xmlel()]&#125;).</span></span><br></pre></td></tr></table></figure>
<h2 id="xmlel"><code>xmlel</code></h2><p>一个XML元素记录, 用于构造自定义XML节</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T16:10:06.000Z"><a href="/2014/09/29/ejabberd-route-table/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-route-table/">Ejabberd-路由表</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>ejabberd内部模块可以通过一个XMPP名称(<code>-define(PROCNAME, ejabberd_mod_echo).</code>),添加自身到服务器的路由表中,这些模块被称为<code>服务</code>,服务模块必须同时实现<code>gen_server</code>和<code>gen_mod</code>行为</p>
<h2 id="例子">例子</h2><p><a href="https://github.com/processone/ejabberd/blob/master/src/mod_echo.erl" target="_blank" rel="external">mod_echo.erl</a>是一个使用路由机制的例子.</p>
<h2 id="API">API</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ejabberd_router:register_route(Host)</span><br><span class="line">ejabberd_router:unregister_route(Host),</span><br><span class="line">* Host = string()</span><br></pre></td></tr></table></figure>
<h3 id="gen_server_API">gen_server API</h3><p>下面上个函数用作模块的API</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Host, Opts)</span></span> -&gt;</span><br><span class="line">    Proc = gen_mod:<span class="function"><span class="title">get_module_proc</span><span class="params">(Host, ?PROCNAME)</span></span>,</span><br><span class="line">    gen_server:<span class="function"><span class="title">start_link</span><span class="params">(&#123;local, Proc&#125;, ?MODULE, [Host, Opts], [])</span></span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function_or_atom">start</span>(<span class="variable">Host</span>, <span class="variable">Opts</span>) <span class="arrow">-&gt;</span></span><br><span class="line">    <span class="variable">Proc</span> = <span class="function_or_atom">gen_mod:get_module_proc</span>(<span class="variable">Host</span>, <span class="constant">?PROCNAME</span>),</span><br><span class="line">    <span class="variable">ChildSpec</span> = &#123;<span class="variable">Proc</span>,&#123;<span class="constant">?MODULE</span>, <span class="function_or_atom">start_link</span>, [<span class="variable">Host</span>, <span class="variable">Opts</span>]&#125;, <span class="function_or_atom">temporary</span>, <span class="number">1000</span>, <span class="function_or_atom">worker</span>, [<span class="constant">?MODULE</span>]&#125;,</span><br><span class="line">    <span class="function_or_atom">supervisor:start_child</span>(<span class="function_or_atom">ejabberd_sup</span>, <span class="variable">ChildSpec</span>).</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">stop</span><span class="params">(Host)</span></span> -&gt;</span><br><span class="line">    Proc = gen_mod:<span class="function"><span class="title">get_module_proc</span><span class="params">(Host, ?PROCNAME)</span></span>,</span><br><span class="line">    gen_server:<span class="function"><span class="title">call</span><span class="params">(Proc, stop)</span></span>,</span><br><span class="line">    supervisor:<span class="function"><span class="title">terminate_child</span><span class="params">(ejabberd_sup, Proc)</span></span>,</span><br><span class="line">    supervisor:<span class="function"><span class="title">delete_child</span><span class="params">(ejabberd_sup, Proc)</span></span>.</span><br></pre></td></tr></table></figure>
<h3 id="gen_server_回调">gen_server 回调</h3><p>下面的函数必须定义并导出.</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">init([Host, Opts]) -&gt; &#123;ok, State&#125; <span class="string">|</span></span><br><span class="line">                      &#123;ok, State, Timeout&#125; <span class="string">|</span></span><br><span class="line">                      ignore <span class="string">|</span></span><br><span class="line">                      &#123;stop, Reason&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">handle_info(Info, State) -&gt; <span class="list">&#123;noreply, State&#125;</span> |</span><br><span class="line">                            <span class="list">&#123;noreply, State, Timeout&#125;</span> |</span><br><span class="line">                            <span class="list">&#123;stop, Reason, State&#125;</span></span><br><span class="line">* Info = <span class="list">&#123;route, From, To, Packet&#125;</span></span><br><span class="line">* To = From = #jid (see jlib core module)</span><br><span class="line">* Packet = <span class="list">&#123;xmlelement, Name, Attrs, SubEl&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">terminate</span><span class="params">(Reason, State)</span></span> -&gt; <span class="function"><span class="title">void</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(stop, <span class="variable">_From</span>, <span class="variable">State</span>)</span> -&gt;</span> <span class="tuple">&#123;stop, normal, ok, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(<span class="variable">_Msg</span>, <span class="variable">State</span>)</span> -&gt;</span> <span class="tuple">&#123;noreply, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">code_change</span><span class="params">(<span class="variable">_OldVsn</span>, <span class="variable">State</span>, <span class="variable">_Extra</span>)</span> -&gt;</span> <span class="tuple">&#123;ok, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<p><code>init</code>函数用于初始化模块.<code>Host</code>为模块所在虚拟主机名称,<code>Opts</code>为在配置文件中设置的模块选项,这些选项可以通过<strong><a href="https://www.process-one.net/en/wiki/gen_mod" target="_blank" rel="external">gen_mod:get_opt/3</a></strong>函数获取.<strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:register_route/1</a></strong>函数在<code>init</code>回调中执行.</p>
<p><code>terminate/2</code>用于停止模块. <code>ejabberd_router:unregister_route</code>函数在此回调中被调用.</p>
<p><code>handle_info/2</code>用于获取发送给该模块的XMPP包. <strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:route/1</a></strong>用于对包进行重新路由.</p>
<p>All other callbacks can be written as shown above.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T15:28:55.000Z"><a href="/2014/09/28/ejabberd-iq-handlers/">2014-09-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/28/ejabberd-iq-handlers/">Ejabberd-IQ节处理程序</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd内部模块可以注册自身,并使用指定名称空间处理IQ节, 其方法类似于<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a>这种机制.</p>
<p>模块<a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">mod_last.erl</a>就使用了这种机制, 同时也使用了<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a></p>
<h2 id="API">API</h2><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gen_iq_handler:add_iq_handler(Scope, Host, <span class="keyword">Namespace</span>, <span class="keyword">Module</span>, <span class="function"><span class="keyword">Function</span>, <span class="title">IQDisc</span>)</span><br><span class="line"><span class="title">gen_iq_handler</span>:</span>remove_iq_handler(Scope, Host, <span class="keyword">Namespace</span>, <span class="keyword">Module</span>, <span class="function"><span class="keyword">Function</span>, <span class="title">IQDisc</span>)</span><br><span class="line">* <span class="title">Scope</span> = <span class="title">ejabberd_local</span> | <span class="title">ejabberd_sm</span></span><br><span class="line">* <span class="title">Namespace</span> = <span class="title">string</span><span class="params">()</span> <span class="params">(某些名称空间宏定义在jlib.hrl头文件中)</span></span><br><span class="line">* <span class="title">Host</span> = <span class="title">string</span><span class="params">()</span></span><br><span class="line">* <span class="title">Module</span> = <span class="title">atom</span><span class="params">()</span></span><br><span class="line">* <span class="title">Fonction</span> = <span class="title">atom</span><span class="params">()</span></span><br><span class="line">* <span class="title">IQDisc</span> = <span class="title">no_queue</span> | <span class="title">one_queue</span> | <span class="comment">&#123;queues, N&#125;</span> | <span class="title">parallel</span></span><br><span class="line">* <span class="title">N</span> = <span class="title">integer</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p><strong>ejabberd_local</strong>作用域用于注册发到服务器本身的<strong>IQ</strong>.<br><strong>ejabberd_sm</strong>作用域用于注册发送到一个账号的<strong>纯JID</strong>(Bare JID)的<strong>IQ</strong>,<strong>Host</strong>为与该<strong>IQ</strong>相关的虚拟主机名称.</p>
<p><strong>Module</strong>和<strong>Function</strong>描述了一个处理器函数,当收到<strong>指定名称空间的IQ节</strong>时,该函数被调用.该处理器函数必须具有如下声明:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Module</span>:<span class="keyword">Function</span>(<span class="keyword">From</span>, <span class="keyword">To</span>, IQ) -&gt; IQ</span><br><span class="line">* <span class="keyword">From</span> = <span class="keyword">To</span> = <span class="preprocessor">#jid</span></span><br><span class="line">* IQ = <span class="preprocessor">#iq</span></span><br></pre></td></tr></table></figure>
<p>处理函数返回结果IQ (IQ-result), IQDisc描述当前IQ如何处理:</p>
<p><strong>no_queue</strong>: 不创建新线程运行该处理程序<br><strong>one_queue</strong>: 创建一个专用线程运行该处理程序<br><strong>{queues, N}</strong>: 创建<strong>N</strong>个线程运行该处理程序<br><strong>parallel</strong>: 对每一个接收到的IQ创建一个线程</p>
<h2 id="IQ处理模块模板">IQ处理模块模板</h2><p>修改以适应Ejabberd <strong>14.07</strong></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">-module(mod_iqtest).</span><br><span class="line">-behaviour(gen_mod).</span><br><span class="line">-<span class="keyword">export</span>([start/<span class="number">2</span>, stop/<span class="number">1</span>,</span><br><span class="line">  process_sm_iq/<span class="number">3</span> %% I assume this <span class="keyword">is</span> needed to handle <span class="type">JID</span> to <span class="type">JID</span> communication <span class="keyword">of</span> the <span class="type">IQ</span>?</span><br><span class="line">]).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"ejabberd.hrl"</span>).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"jlib.hrl"</span>).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"logger.hrl"</span>).</span><br><span class="line">-define(<span class="type">NS_TEST</span>, <span class="string">"http://jabber.org/protocol/test"</span>).</span><br><span class="line">-define(<span class="type">NS_TEST2</span>, <span class="string">"http://jabber.org/protocol/test2"</span>).</span><br><span class="line">start(<span class="type">Host</span>, <span class="type">Opts</span>) -&gt;</span><br><span class="line">  <span class="type">IQDisc</span> = gen_mod:get_opt(</span><br><span class="line">    iqdisc,</span><br><span class="line">    <span class="type">Opts</span>,</span><br><span class="line">    fun gen_iq_handler:check_type/<span class="number">1</span>,</span><br><span class="line">    one_queue</span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:add_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST</span>, ?<span class="type">MODULE</span>, process_sm_iq, <span class="type">IQDisc</span></span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:add_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST2</span>, ?<span class="type">MODULE</span>, process_sm_iq, <span class="type">IQDisc</span></span><br><span class="line">  ),</span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Loading module 'mod_iqtest' v.01"</span>, []).</span><br><span class="line">stop(<span class="type">Host</span>) -&gt;</span><br><span class="line">  gen_iq_handler:remove_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST</span></span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:remove_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST2</span></span><br><span class="line">  ),</span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Stoping module 'mod_iqtest' "</span>, []).</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = get, xmlns = ?NS_TEST&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Get query:~n ~p"</span>, [<span class="type">IQ</span>]),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = [&#123;xmlelement, <span class="string">"value"</span>, [], [&#123;xmlcdata, <span class="string">"Hello World of Testing."</span>&#125;]&#125;]</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = get, xmlns = ?NS_TEST2&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Get query of namespace 2:~n ~p"</span>, [<span class="type">IQ</span>]),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = [&#123;xmlelement, <span class="string">"value"</span>, [], [&#123;xmlcdata, <span class="string">"Hello World of Test 2."</span>&#125;]&#125;]</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = set&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Set: it does nothing"</span>, []),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = []</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;sub_el = SubEl&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ other type: it does nothing"</span>, []),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = error, sub_el = [<span class="type">SubEl</span>, ?<span class="type">ERR_FEATURE_NOT_IMPLEMENTED</span>]</span><br><span class="line">  &#125;.</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>IQ处理程序模板<br><a href="https://www.ejabberd.im/node/5035?q=node/5035" target="_blank" rel="external">https://www.ejabberd.im/node/5035?q=node/5035</a></li>
<li>Ejabberd事件和钩子<br><a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">https://www.process-one.net/en/wiki/ejabberd_events_and_hooks</a></li>
<li>mod_last模块<br><a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">https://github.com/processone/ejabberd/blob/master/src/mod_last.erl</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/4/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/6/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/03/18/angular-if-else-statement-in-template/">AngularJS中的If..Else语句</a>
      </li>
    
      <li>
        <a href="/2015/03/18/continuous-deployment-of-node-js-applications/">Nodejs应用程序持续部署</a>
      </li>
    
      <li>
        <a href="/2015/03/17/erlang-pooler/">Erlang Pooler</a>
      </li>
    
      <li>
        <a href="/2015/03/17/ejabberd-easy-installer-and-structure-for-ejabberd-contributed-modules/">Ejabberd模块安装工具</a>
      </li>
    
      <li>
        <a href="/2015/03/13/ejabberd-howto-20150312/">Ejabberd Howto 20150312 &lt;TODO LIST&gt;</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-performance-turning/">Ejabberd 性能调优(草稿)</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-benchmark-with-tsung/">使用Tsung对Ejabberd进行性能测试</a>
      </li>
    
      <li>
        <a href="/2015/03/11/thrift-ex/">thrift_ex</a>
      </li>
    
      <li>
        <a href="/2015/02/26/ejabberd-joins-the-elixir-revolution/">(译) Ejabberd加入了Elixir的变革</a>
      </li>
    
      <li>
        <a href="/2015/02/25/http2-h2o-get-started/">HTTP/2 尝鲜</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>32</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>6</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a><a href="/tags/API/" style="font-size: 11px;">API</a><a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a><a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a><a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a><a href="/tags/CURL/" style="font-size: 10px;">CURL</a><a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a><a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a><a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a><a href="/tags/ETS/" style="font-size: 10px;">ETS</a><a href="/tags/Ecto/" style="font-size: 11px;">Ecto</a><a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a><a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a><a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a><a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a><a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a><a href="/tags/H2O/" style="font-size: 10px;">H2O</a><a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a><a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a><a href="/tags/Howto/" style="font-size: 10px;">Howto</a><a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a><a href="/tags/I18n/" style="font-size: 10px;">I18n</a><a href="/tags/IAB/" style="font-size: 10px;">IAB</a><a href="/tags/ID3/" style="font-size: 10px;">ID3</a><a href="/tags/IO/" style="font-size: 10px;">IO</a><a href="/tags/IOT/" style="font-size: 10px;">IOT</a><a href="/tags/IoT/" style="font-size: 10px;">IoT</a><a href="/tags/Loopback/" style="font-size: 12px;">Loopback</a><a href="/tags/MUC/" style="font-size: 10px;">MUC</a><a href="/tags/Macro/" style="font-size: 12px;">Macro</a><a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a><a href="/tags/Mix/" style="font-size: 14px;">Mix</a><a href="/tags/Modules/" style="font-size: 10px;">Modules</a><a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a><a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a><a href="/tags/OTP/" style="font-size: 12px;">OTP</a><a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a><a href="/tags/PM2/" style="font-size: 10px;">PM2</a><a href="/tags/Performance/" style="font-size: 10px;">Performance</a><a href="/tags/Phoenix/" style="font-size: 12px;">Phoenix</a><a href="/tags/Pool/" style="font-size: 10px;">Pool</a><a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a><a href="/tags/RESTFUL/" style="font-size: 11px;">RESTFUL</a><a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a><a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a><a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a><a href="/tags/Regex/" style="font-size: 10px;">Regex</a><a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a><a href="/tags/SSH/" style="font-size: 10px;">SSH</a><a href="/tags/SSL/" style="font-size: 10px;">SSL</a><a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a><a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a><a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a><a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a><a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a><a href="/tags/Task/" style="font-size: 10px;">Task</a><a href="/tags/Thrift/" style="font-size: 10px;">Thrift</a><a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a><a href="/tags/UBF/" style="font-size: 10px;">UBF</a><a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a><a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a><a href="/tags/VAST/" style="font-size: 10px;">VAST</a><a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a><a href="/tags/XEP/" style="font-size: 15px;">XEP</a><a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a><a href="/tags/XML/" style="font-size: 10px;">XML</a><a href="/tags/XMPP/" style="font-size: 18px;">XMPP</a><a href="/tags/android/" style="font-size: 10px;">android</a><a href="/tags/angular/" style="font-size: 17px;">angular</a><a href="/tags/application/" style="font-size: 10px;">application</a><a href="/tags/blockies/" style="font-size: 10px;">blockies</a><a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a><a href="/tags/bosh/" style="font-size: 12px;">bosh</a><a href="/tags/ci/" style="font-size: 10px;">ci</a><a href="/tags/container/" style="font-size: 11px;">container</a><a href="/tags/data-management/" style="font-size: 10px;">data management</a><a href="/tags/data-volume/" style="font-size: 10px;">data volume</a><a href="/tags/debugging/" style="font-size: 10px;">debugging</a><a href="/tags/devtools/" style="font-size: 10px;">devtools</a><a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a><a href="/tags/doc/" style="font-size: 10px;">doc</a><a href="/tags/docker/" style="font-size: 16px;">docker</a><a href="/tags/ejabberd/" style="font-size: 19px;">ejabberd</a><a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a><a href="/tags/emysql/" style="font-size: 11px;">emysql</a><a href="/tags/encoding/" style="font-size: 10px;">encoding</a><a href="/tags/erlang/" style="font-size: 12px;">erlang</a><a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a><a href="/tags/faq/" style="font-size: 10px;">faq</a><a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a><a href="/tags/gerrit/" style="font-size: 11px;">gerrit</a><a href="/tags/gettext/" style="font-size: 10px;">gettext</a><a href="/tags/git/" style="font-size: 12px;">git</a><a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a><a href="/tags/grunt/" style="font-size: 10px;">grunt</a><a href="/tags/hero/" style="font-size: 10px;">hero</a><a href="/tags/html/" style="font-size: 10px;">html</a><a href="/tags/html5/" style="font-size: 10px;">html5</a><a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a><a href="/tags/iq/" style="font-size: 10px;">iq</a><a href="/tags/jabber/" style="font-size: 10px;">jabber</a><a href="/tags/javascript/" style="font-size: 11px;">javascript</a><a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a><a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a><a href="/tags/library/" style="font-size: 10px;">library</a><a href="/tags/linking/" style="font-size: 10px;">linking</a><a href="/tags/lists/" style="font-size: 10px;">lists</a><a href="/tags/load-balance/" style="font-size: 10px;">load balance</a><a href="/tags/log4er/" style="font-size: 10px;">log4er</a><a href="/tags/manage-images/" style="font-size: 10px;">manage images</a><a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a><a href="/tags/muc/" style="font-size: 10px;">muc</a><a href="/tags/mysql/" style="font-size: 10px;">mysql</a><a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a><a href="/tags/node-webkit/" style="font-size: 13px;">node-webkit</a><a href="/tags/node-js/" style="font-size: 12px;">node.js</a><a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a><a href="/tags/notification/" style="font-size: 10px;">notification</a><a href="/tags/npm/" style="font-size: 11px;">npm</a><a href="/tags/performance/" style="font-size: 10px;">performance</a><a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a><a href="/tags/polymer/" style="font-size: 10px;">polymer</a><a href="/tags/port/" style="font-size: 10px;">port</a><a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a><a href="/tags/rebar/" style="font-size: 10px;">rebar</a><a href="/tags/record/" style="font-size: 10px;">record</a><a href="/tags/recursion/" style="font-size: 10px;">recursion</a><a href="/tags/regexp/" style="font-size: 10px;">regexp</a><a href="/tags/relx/" style="font-size: 10px;">relx</a><a href="/tags/screen/" style="font-size: 10px;">screen</a><a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a><a href="/tags/shell/" style="font-size: 10px;">shell</a><a href="/tags/socket/" style="font-size: 10px;">socket</a><a href="/tags/ssh/" style="font-size: 10px;">ssh</a><a href="/tags/stanza/" style="font-size: 10px;">stanza</a><a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a><a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a><a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a><a href="/tags/swagger/" style="font-size: 12px;">swagger</a><a href="/tags/testing/" style="font-size: 10px;">testing</a><a href="/tags/tls/" style="font-size: 10px;">tls</a><a href="/tags/tools/" style="font-size: 10px;">tools</a><a href="/tags/tsung/" style="font-size: 10px;">tsung</a><a href="/tags/upstart/" style="font-size: 10px;">upstart</a><a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a><a href="/tags/varnish/" style="font-size: 10px;">varnish</a><a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a><a href="/tags/vt/" style="font-size: 10px;">vt</a><a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a><a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a><a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a><a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




