
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 5 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-01T15:28:15.000Z"><a href="/2014/11/01/elixir-deps/">2014-11-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/01/elixir-deps/">依赖管理</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/52787527-EA9C-40CA-9D9E-5950298E6EA0.png" alt="Elixir依赖管理命令"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix deps            # &#26174;&#31034;&#25152;&#26377;&#20381;&#36182;&#21253;&#26497;&#20854;&#29366;&#24577;&#10;mix deps.get        # &#19979;&#36733;&#26410;&#23433;&#35013;&#30340;&#20381;&#36182;&#21253;&#10;mix deps.compile    # &#32534;&#35793;&#20381;&#36182;&#21253;&#10;mix deps.update     # &#26356;&#26032;&#20381;&#36182;&#21253;&#10;mix deps.clean      # &#21024;&#38500;&#25152;&#26377;&#20381;&#36182;&#25991;&#20214;&#10;mix deps.unlock     # &#35299;&#38145;&#20381;&#36182;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-31T06:13:57.000Z"><a href="/2014/10/31/elixir-mix-and-otp-ch8-task-and-gen-tcp/">2014-10-31</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/31/elixir-mix-and-otp-ch8-task-and-gen-tcp/">Mix 和 OTP 任务以及gen_tcp</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>这章将学习如何使用Erlang的<code>:gen_tcp</code>模块处理请求. 后续章节我们会扩展服务器使之能处理命令. 还提供了一个极好的机会探索Elixir的<code>Task</code>模块</p>
<h2 id="Echo服务器">Echo服务器</h2><p>首先通过实现一个echo服务器,开始学习TCP服务器. 它只是把接收到的文本返回给客户端. 我们慢慢的改进服务器直到它能够处理多个连接.</p>
<p>一个TCP服务器, 大致会执行如下步骤:</p>
<ul>
<li>监听端口并获得套接字</li>
<li>等待客户端连接该端口,并Accept.</li>
<li>读取客户端请求并回写响应</li>
</ul>
<p>下面来实现这些步骤, 转到<code>apps/kv_server</code>应用程序, 打开<code>lib/kv_server.ex</code>,添加下面的函数:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">accept</span></span>(port) <span class="keyword">do</span>
  <span class="comment"># The options below mean:</span>
  <span class="comment">#</span>
  <span class="comment"># 1. `:binary` - receives data as binaries (instead of lists)</span>
  <span class="comment"># 2. `packet: :line` - receives data line by line</span>
  <span class="comment"># 3. `active: false` - block on `:gen_tcp.recv/2` until data is available</span>
  <span class="comment">#</span>
  {<span class="symbol">:ok</span>, socket} = <span class="symbol">:gen_tcp</span>.listen(port,
                    [<span class="symbol">:binary</span>, <span class="symbol">packet:</span> <span class="symbol">:line</span>, <span class="symbol">active:</span> <span class="keyword">false</span>])
  <span class="constant">IO.</span>puts <span class="string">"Accepting connections on port <span class="subst">#{port}</span>"</span>
  loop_acceptor(socket)
<span class="keyword">end</span>
<span class="function"><span class="keyword">defp</span> <span class="title">loop_acceptor</span></span>(socket) <span class="keyword">do</span>
  {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
  serve(client)
  loop_acceptor(socket)
<span class="keyword">end</span>
<span class="function"><span class="keyword">defp</span> <span class="title">serve</span></span>(client) <span class="keyword">do</span>
  client
  |&gt; read_line()
  |&gt; write_line(client)
  serve(client)
<span class="keyword">end</span>
<span class="function"><span class="keyword">defp</span> <span class="title">read_line</span></span>(socket) <span class="keyword">do</span>
  {<span class="symbol">:ok</span>, data} = <span class="symbol">:gen_tcp</span>.recv(socket, <span class="number">0</span>)
  data
<span class="keyword">end</span>
<span class="function"><span class="keyword">defp</span> <span class="title">write_line</span></span>(line, socket) <span class="keyword">do</span>
  <span class="symbol">:gen_tcp</span>.send(socket, line)
<span class="keyword">end</span>
</code></pre><p>调用<code>KVServer.accept(4040)</code>启动服务器, <code>4040</code>为端口. 在<code>accept/1</code>中第一步是监听端口直到获得一个可用的套接字, 然后调用<code>loop_acceptor/1</code>. <code>loop_acceptor/1</code>仅仅是循环地接受客户端连接. 对于每个接受的连接, 调用<code>serve/1</code>.</p>
<p><code>serve/1</code>是另一个循环调用, 其从套接字读取一行数据并把读取到的行写回套接字. 注意函数<code>serve/1</code>使用管道操作符 <code>|&gt;</code> 来表达操作流.管道操作符对左边的表达式求值并把结果作为右侧函数的第一个参数传递. 上面的例子:</p>
<pre><code>socket |<span class="string">&gt; read_line() </span>|<span class="string">&gt; write_line(socket)</span>
</code></pre><p>等同于:</p>
<pre><code>write_line<span class="list">(<span class="keyword">read_line</span><span class="list">(<span class="keyword">socket</span>)</span>, socket)</span>
</code></pre><p>当使用 <code>|&gt;</code> 操作符时, 由于操作符优先级的问题, 给函数调用添加必要的括号是非常重要的, 特别是, 这段代码:</p>
<pre><code><span class="number">1.</span><span class="number">.10</span> |&gt; Enum.filter &amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>) |&gt; Enum.<span class="built_in">map</span> &amp;(&amp;<span class="number">1</span> * <span class="number">2</span>)
</code></pre><p>实际上会转换为:</p>
<pre><code><span class="number">1.</span><span class="number">.10</span> |&gt; Enum.filter(&amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>) |&gt; Enum.<span class="built_in">map</span>(&amp;(&amp;<span class="number">1</span> * <span class="number">2</span>)))
</code></pre><p>这不是我们想要的结果, 因为传递给<code>Enum.filter/2</code>的函数作为给<code>Enum.map/2</code>的第一个参数传递, 解决办法是使用括号:</p>
<pre><code><span class="preprocessor"># 译注: 虽然Elixir的函数调用通常情况下可以不使用括号,</span>
<span class="preprocessor"># 但是为了避免歧义或不必要的问题,建议所有函数调用其他语言中必须的括号风格</span>
<span class="number">1.</span><span class="number">.10</span> |&gt; Enum.filter(&amp;(&amp;<span class="number">1</span> &lt;= <span class="number">5</span>)) |&gt; Enum.<span class="built_in">map</span>(&amp;(&amp;<span class="number">1</span> * <span class="number">2</span>))
</code></pre><p><code>read_line/1</code>函数实现使用<code>:gen_tcp.recv/2</code>从套接字接收数据,  <code>write_line/2</code>使用<code>:gen_tcp.send/2</code>向套接字写入数据.</p>
<p>使用命令<code>iex -S mix</code>在<code>kv_server</code>应用程序中启动一个iex会话. 在IEx中运行:</p>
<pre><code>iex&gt; KVServer.<span class="function"><span class="title">accept</span><span class="params">(<span class="number">4040</span>)</span></span>
</code></pre><p>服务器现在开始运行, 终端被阻塞. 我们使用 <code>telnet</code>客户端访问我们的服务器. 它在大多数操作系统中都有, 其命令行参数通常类似:</p>
<pre><code>$ telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...
Connected <span class="keyword">to</span> localhost.
Escape <span class="property">character</span> <span class="keyword">is</span> '^]'.
hello
hello
<span class="keyword">is</span> <span class="keyword">it</span> <span class="keyword">me</span>
<span class="keyword">is</span> <span class="keyword">it</span> <span class="keyword">me</span>
you are looking <span class="keyword">for</span>?
you are looking <span class="keyword">for</span>?
</code></pre><p>键入<code>hello</code>, 并敲击回车, 你会的到服务器的<code>hello</code>响应, 太棒了!</p>
<p>我的telnet客户端可以通过键入<code>ctrl + ]</code>, <code>quit</code>, 并敲击 <code>&lt;Enter&gt;</code>退出, 你的客户端可能有不同的步骤:</p>
<p>退出telnet客户端后, 你可能会在IEx(Elixir Shell)会话中看到如下错误:</p>
<pre><code>** (<span class="constant">MatchError</span>) no match <span class="keyword">of</span> right hand side <span class="symbol">value:</span> {<span class="symbol">:error</span>, <span class="symbol">:closed</span>}
    (kv_server) <span class="class"><span class="keyword">lib</span>/<span class="title">kv_server</span>.<span class="title">ex</span>:41: <span class="title">KVServer</span>.<span class="title">read_line</span>/1</span>
    (kv_server) <span class="class"><span class="keyword">lib</span>/<span class="title">kv_server</span>.<span class="title">ex</span>:33: <span class="title">KVServer</span>.<span class="title">serve</span>/1</span>
    (kv_server) <span class="class"><span class="keyword">lib</span>/<span class="title">kv_server</span>.<span class="title">ex</span>:27: <span class="title">KVServer</span>.<span class="title">loop_acceptor</span>/1</span>
</code></pre><p>这是因为我们期望从<code>:gen_tcp.recv/2</code>接收数据,但是客户端关闭了连接. 服务器后续的版本修订需要更好的处理这种情况.</p>
<p>现在有一个更重要的Bug要解决: 如果TCP acceptor崩溃会发生什么? 因为没有监视进程, 服务器异常退出并且不能处理更多后续的请求, 因为它没有重启. 这就是为什么必须把服务器放在监控树当中.</p>
<h2 id="Tasks">Tasks</h2><p>我们已经学习过了代理(Agents), 通用服务器(Generic Servers), 以及事件管理器(Event Managers), 它们全部是适合处理多个消息或管理状态. 但是, 当我们只需要执行一些任务时,我们使用什么?</p>
<p><a href="http://elixir-lang.org/docs/stable/elixir/Task.html" title="Task模块" target="_blank" rel="external">Task模块</a>恰好提供了这个功能. 例如, 其有一个<code>start_link/3</code>函数, 其接受一个模块, 函数和参数, 作为监控树(Supervision tree)的一部分允许我们运行一个给定的函数.</p>
<p>让我们试一下. 打开<code>lib/kv_server.ex</code>, 修改<code>start/2</code>中的监控进程为如下:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">start</span></span>(_type, _args) <span class="keyword">do</span>
  import <span class="constant">Supervisor</span>.<span class="constant">Spec</span>
  children = [
    worker(<span class="constant">Task</span>, [<span class="constant">KVServer</span>, <span class="symbol">:accept</span>, [<span class="number">4040</span>]])
  ]
  opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">KVServer</span>.<span class="constant">Supervisor</span>]
  <span class="constant">Supervisor</span>.start_link(children, opts)
<span class="keyword">end</span>
</code></pre><p>With this change, we are saying that we want to run KVServer.accept(4040) as a worker.<br>We are hardcoding the port for now, but we will discuss ways in which this could be changed later.</p>
<p>现在我们向把<code>KVServer.accept(4040)</code>作为一个worker运行. 现在我们硬编码了端口号, 但我们将会讨论能在以后修改的方法.</p>
<p>现在服务器作为监控数的一部分, 当运行应用程序的时候它应该自动地启动. 在终端中键入命令<code>mix run --no-halt</code>, 再次使用<code>telnet</code>客户端验证一切仍能工作:</p>
<pre><code>$ telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...
Connected <span class="keyword">to</span> localhost.
Escape <span class="property">character</span> <span class="keyword">is</span> '^]'.
<span class="command">say</span> you
<span class="command">say</span> you
<span class="command">say</span> <span class="keyword">me</span>
<span class="command">say</span> <span class="keyword">me</span>
</code></pre><p>Yes, 仍然可以工作. 如果你杀掉客户端, 将导致整个服务器崩溃, 你会看到另一个服务器进程立即启动.</p>
<p>同时连接两个客户端, 再次测试, 你发现第二个客户端并没有echo:</p>
<pre><code>$ <span class="atom">telnet</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">4040</span>
<span class="name">Trying</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...
<span class="name">Connected</span> <span class="atom">to</span> <span class="atom">localhost</span>.
<span class="name">Escape</span> <span class="atom">character</span> <span class="atom">is</span> <span class="string">'^]'</span>.
<span class="atom">hello</span>
<span class="atom">hello</span>?
<span class="name">HELLOOOOOO</span>?
</code></pre><p>这是因为我们在同一个进程中处理接受连接并处理请求. 一个客户端连接后, 同一时刻就不能在接受其他的客户端的连接了, 直到之前的请求处理完成.</p>
<h2 id="任务监视器(Task_supervisor)">任务监视器(Task supervisor)</h2><p>为了使服务器能处理并发连接, 需要一个进程作为acceptor, 生成(spawns)一个额外的进程来处理请求. 解决办法是修改下面的代码:</p>
<pre><code><span class="function"><span class="keyword">defp</span> <span class="title">loop_acceptor</span></span>(socket) <span class="keyword">do</span>
  {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
  serve(client)
  loop_acceptor(socket)
<span class="keyword">end</span>
</code></pre><p>使用 <code>Task.start_link/1</code>, 类似于 <code>Task.start_link/3</code>, 它接受一个匿名函数作为参数, 而非模块,函数,参数:</p>
<pre><code><span class="function"><span class="keyword">defp</span> <span class="title">loop_acceptor</span></span>(socket) <span class="keyword">do</span>
  {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
  <span class="constant">Task.</span>start_link(<span class="keyword">fn</span> -&gt; serve(client) <span class="keyword">end</span>)
  loop_acceptor(socket)
<span class="keyword">end</span>
</code></pre><p>我们已经犯了一次这样的错误. 记得么?</p>
<p>这个错误类似于当我们从registry调用<code>KV.Bucket.start_link/0</code>所犯的错误. 在任何bucket中的失败将带来整个registry当机.</p>
<p>上面的胆码有同样的瑕疵: 如果我们连接<code>serve(client)</code>任务到acceptor, 当处理一个请求的时候将导致acceptor崩溃, 结果所有其他的连接,断开(down)</p>
<blockquote>
<p>We fixed the issue for the registry by using a simple one for one supervisor. We are going to use the same tactic here,<br>except that this pattern is so common with tasks that tasks already come with a solution: a simple one for one supervisor with temporary workers that we can just use in our supervision tree!</p>
</blockquote>
<p><del>使用一个<code>simple_one_for_one</code>监视进程(supervisor)解决这个问题. 我们将使用相同的策略,except that this pattern is so common with tasks that tasks already come with a solution: 可以在监控树种使用一个<code>simple_one_for_one</code>监视器和临时的workers.</del></p>
<p>再次修改<code>start/2</code>, 添加一个监视进程到进程树:</p>
<pre><code>def start(_type, _args) <span class="keyword">do</span>
  import Supervisor.Spec

  children = [
    supervisor(Task.Supervisor, <span class="string">[[name: KVServer.TaskSupervisor]]</span>),
    worker(Task, [KVServer, :accept, [<span class="number">4040</span>]])
  ]

  opts = [strategy: :one_for_one, name: KVServer.Supervisor]
  Supervisor.start_link(children, opts)
<span class="keyword">end</span>
</code></pre><p>使用名称<code>KVServer.TaskSupervisor</code>启动一个<a href="http://elixir-lang.org/docs/stable/elixir/Task.Supervisor.html" title="Task.Supervisor" target="_blank" rel="external">Task.Supervisor</a>进程. 记住, 因为acceptor任务依赖此监视进程, 该监视检查必须首先启动.</p>
<p>现在只需要修改<code>loop_acceptor/2</code>使用<code>Task.Supervisor</code>来处理每一个请求:</p>
<pre><code><span class="function"><span class="keyword">defp</span> <span class="title">loop_acceptor</span></span>(socket) <span class="keyword">do</span>
  {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
  <span class="constant">Task.Supervisor.</span>start_child(<span class="constant">KVServer.TaskSupervisor,</span> <span class="keyword">fn</span> -&gt; serve(client) <span class="keyword">end</span>)
  loop_acceptor(socket)
<span class="keyword">end</span>
</code></pre><p>使用命令<code>mix run --no-halt</code>启动一个新的服务器, 然后可以打开多个并发的telnet客户端连接. 你还注意到退出一个客户端后并不会导致acceptor崩溃. 太棒了!</p>
<p>这里是完整的echo服务器在单个模块中的实现:</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">KVServer</span></span> <span class="keyword">do</span>
  <span class="keyword">use</span> <span class="constant">Application</span>

  <span class="variable">@doc</span> <span class="keyword">false</span>
  <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>(<span class="constant">_type,</span> <span class="constant">_args)</span> <span class="keyword">do</span>
    import <span class="constant">Supervisor.Spec</span>

    children = [
      supervisor(<span class="constant">Task.Supervisor,</span> [[<span class="symbol">name:</span> <span class="constant">KVServer.TaskSupervisor]</span>]),
      worker(<span class="constant">Task,</span> [<span class="constant">KVServer,</span> <span class="symbol">:accept</span>, [<span class="number">4040</span>]])
    ]

    opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">KVServer.Supervisor]</span>
    <span class="constant">Supervisor.</span>start_link(children, opts)
  <span class="keyword">end</span>

  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"
  Starts accepting connections on the given `port`.
  "</span><span class="string">""</span>
  <span class="function"><span class="keyword">def</span> <span class="title">accept</span></span>(port) <span class="keyword">do</span>
    {<span class="symbol">:ok</span>, socket} = <span class="symbol">:gen_tcp</span>.listen(port,
                      [<span class="symbol">:binary</span>, <span class="symbol">packet:</span> <span class="symbol">:line</span>, <span class="symbol">active:</span> <span class="keyword">false</span>])
    <span class="constant">IO.</span>puts <span class="string">"Accepting connections on port <span class="subst">#{port}</span>"</span>
    loop_acceptor(socket)
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">defp</span> <span class="title">loop_acceptor</span></span>(socket) <span class="keyword">do</span>
    {<span class="symbol">:ok</span>, client} = <span class="symbol">:gen_tcp</span>.accept(socket)
    <span class="constant">Task.Supervisor.</span>start_child(<span class="constant">KVServer.TaskSupervisor,</span> <span class="keyword">fn</span> -&gt; serve(client) <span class="keyword">end</span>)
    loop_acceptor(socket)
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">defp</span> <span class="title">serve</span></span>(socket) <span class="keyword">do</span>
    socket
    |&gt; read_line()
    |&gt; write_line(socket)

    serve(socket)
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">defp</span> <span class="title">read_line</span></span>(socket) <span class="keyword">do</span>
    {<span class="symbol">:ok</span>, data} = <span class="symbol">:gen_tcp</span>.recv(socket, <span class="number">0</span>)
    data
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">defp</span> <span class="title">write_line</span></span>(line, socket) <span class="keyword">do</span>
    <span class="symbol">:gen_tcp</span>.send(socket, line)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>因为我们已经修改了supervisor规范, 我们需要问: 我们的supervision策略仍然正确么?</p>
<p>在这种情形下, 答案是yes: 如果acceptor崩溃, 并不会导致现有的连接中断.从另一方面讲, 如果任务监视器(task supervisor)崩溃, 也不会导致acceptor崩溃. 对比registry, 最初每次registry崩溃的时候也会导致supervisor崩溃, 直到使用ETS来对状态持久化.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-30T17:16:12.000Z"><a href="/2014/10/31/elixir-mix-and-otp-ch6-ets/">2014-10-31</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/31/elixir-mix-and-otp-ch6-ets/">Mix 和 OTP - ETS</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ETS"><span class="toc-number">1.</span> <span class="toc-text">ETS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作为缓存的ETS"><span class="toc-number">1.1.</span> <span class="toc-text">作为缓存的ETS</span></a></li></ol></li></ol>
        </div>
        


        <h2 id="ETS">ETS</h2><p>每次我们需要查询一个<code>bucket</code>, 我们需要发送一个消息给<code>registry</code>. 在有些应用程序中这意味着<code>registry</code>也许变成瓶颈.</p>
<p>本章中,我们将学习学习ETS(Erlang Term Storage),以及如何把它用作一个缓存机制. 稍后我们将扩展其用途,持久化从监视进程到子进程的持久化数据,即使是在崩溃的时候.</p>
<blockquote>
<p>警告! 别过早的使用ETS作为缓存! 记录并分析你的应用程序性能,识别哪部分是瓶颈. 这样你才知道是否应该使用缓存,以及应该缓存什么.一旦你决定了需求, 本章可作为一个如何使用ETS的例子.</p>
</blockquote>
<h3 id="作为缓存的ETS">作为缓存的ETS</h3><p>ETS允许我们在内存表中存储任何Erlang/Elixir项式. 通过erlang的<code>:ets</code>模块处理ETS表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; table = :ets.new(:buckets_registry, [:set, :protected])&#10;8207&#10;iex&#62; :ets.insert(table, &#123;&#34;foo&#34;, self&#125;)&#10;true&#10;iex&#62; :ets.lookup(table, &#34;foo&#34;)&#10;[&#123;&#34;foo&#34;, #PID&#60;0.41.0&#62;&#125;]</span><br></pre></td></tr></table></figure>
<p>当创建ETS表时, 要求两个必须的参数: 表的名称, 以及一组选项. 在可用的选项中,我们传递了表类型以及其访问规则. 我们选定了<code>:set</code>类型,表示其键在ETS表中是不能重复的.我们还设置了表的访问类型为<code>:protected</code>, 其含义为仅允许<code>创建该表的进程</code>可以对其进行写操作. 但允许所有其他进程对该ETS表进行读操作.</p>
<p>ETS表还可以有名称, 允许我们通过一个给定的名称来访问ETS表.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&#62; :ets.new(:buckets_registry, [:named_table])&#10;:buckets_registry&#10;iex&#62; :ets.insert(:buckets_registry, &#123;&#34;foo&#34;, self&#125;)&#10;true&#10;iex&#62; :ets.lookup(:buckets_registry, &#34;foo&#34;)&#10;[&#123;&#34;foo&#34;, #PID&#60;0.41.0&#62;&#125;]</span><br></pre></td></tr></table></figure>
<p>让我们修改<code>KV.Registry</code>使用ETS表. 我们将使用与事件管理器, buckets supervisor相同的技术, 以及传递ETS表名称给<code>start_link</code>. 记住, 与服务器名称一样, 任何知道ETSB表名称的本地进程都可以方位该表.</p>
<p>打开<code>lib/kv/registry.ex</code>, 并修改其实现. 我们在被修改的部分添加了注释, 以标记我们所做的修改.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule KV.Registry do&#10;  use GenServer&#10;  ## &#23458;&#25143;&#31471; API&#10;  @doc &#34;&#34;&#34;&#10;  &#21551;&#21160;&#27880;&#20876;&#34920;.&#10;  &#34;&#34;&#34;&#10;  def start_link(table, event_manager, buckets, opts \\ []) do&#10;    # 1. &#29616;&#22312;&#25105;&#20204;&#26399;&#26395;&#35813;&#34920;&#20316;&#20026;&#21442;&#25968;&#20256;&#36882;&#32473;&#26381;&#21153;&#22120;&#10;    GenServer.start_link(__MODULE__, &#123;table, event_manager, buckets&#125;, opts)&#10;  end&#10;  @doc &#34;&#34;&#34;&#10;  &#26597;&#35810;&#23384;&#20648;&#22312;`table`&#20013;&#30340;`name`&#30340;bucket pid.&#10;  Returns `&#123;:ok, pid&#125;` if a bucket exists, `:error` otherwise.&#10;  &#34;&#34;&#34;&#10;  def lookup(table, name) do&#10;    # 2. lookup now expects a table and looks directly into ETS.&#10;    #    No request is sent to the server.&#10;    case :ets.lookup(table, name) do&#10;      [&#123;^name, bucket&#125;] -&#62; &#123;:ok, bucket&#125;&#10;      [] -&#62; :error&#10;    end&#10;  end&#10;  @doc &#34;&#34;&#34;&#10;  &#30830;&#20445;&#22312;`server`&#20013;&#26377;&#19968;&#20010;&#19982;&#32473;&#23450;&#30340;`name`&#30456;&#20851;&#30340;bucket.&#10;  &#34;&#34;&#34;&#10;  def create(server, name) do&#10;    GenServer.cast(server, &#123;:create, name&#125;)&#10;  end&#10;  ## &#26381;&#21153;&#22120;&#22238;&#35843;&#10;  def init(&#123;table, events, buckets&#125;) do&#10;    # 3. We have replaced the names HashDict by the ETS table&#10;    ets  = :ets.new(table, [:named_table, read_concurrency: true])&#10;    refs = HashDict.new&#10;    &#123;:ok, %&#123;names: ets, refs: refs, events: events, buckets: buckets&#125;&#125;&#10;  end&#10;  # 4. The previous handle_call callback for lookup was removed&#10;  def handle_cast(&#123;:create, name&#125;, state) do&#10;    # 5. Read and write to the ETS table instead of the HashDict&#10;    case lookup(state.names, name) do&#10;      &#123;:ok, _pid&#125; -&#62;&#10;        &#123;:noreply, state&#125;&#10;      :error -&#62;&#10;        &#123;:ok, pid&#125; = KV.Bucket.Supervisor.start_bucket(state.buckets)&#10;        ref = Process.monitor(pid)&#10;        refs = HashDict.put(state.refs, ref, name)&#10;        :ets.insert(state.names, &#123;name, pid&#125;)&#10;        GenEvent.sync_notify(state.events, &#123;:create, name, pid&#125;)&#10;        &#123;:noreply, %&#123;state | refs: refs&#125;&#125;&#10;    end&#10;  end&#10;  def handle_info(&#123;:DOWN, ref, :process, pid, _reason&#125;, state) do&#10;    # 6. Delete from the ETS table instead of the HashDict&#10;    &#123;name, refs&#125; = HashDict.pop(state.refs, ref)&#10;    :ets.delete(state.names, name)&#10;    GenEvent.sync_notify(state.events, &#123;:exit, name, pid&#125;)&#10;    &#123;:noreply, %&#123;state | refs: refs&#125;&#125;&#10;  end&#10;  def handle_info(_msg, state) do&#10;    &#123;:noreply, state&#125;&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
<p>注意:<br>在修改<code>KV.Registry.lookup/2</code>实现从服务器请求之前, 暂时直接从ETS表中读取, 多进程共享. 这是我们要实现的缓存机制的主要思路.</p>
<p>为了使缓存机制可以工作, 创建的ETS表需要有 <code>:protected</code>(默认), 这样所有的客户端才能够读取,并且仅有<code>KV.Registry</code>进程能够写. 当启动的时候,我们还设置了<code>read_concurrency: true</code>,以优化表在并发读操作场景下的性能.</p>
<p>The changes we have performed above have definitely broken our tests. For starters,<br>there is a new argument we need to pass to <code>KV.Registry.start_link/3</code>. Let’s start amending our tests in <code>test/kv/registry_test.exs</code> by rewriting the <code>setup</code> callback:</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-30T06:45:30.000Z"><a href="/2014/10/30/elixir-defdelegate/">2014-10-30</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/30/elixir-defdelegate/">函数委派</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="函数委派">函数委派</h2><p>可以通过在当前模块中通过<code>defdelegate</code>定义一个函数,并把对该函数的调用委派给<code>目标函数</code>, 一个有用的场景是:</p>
<ul>
<li>把特定应用需要调用的底层模块的函数,封装到一个单独的应用模块中.</li>
</ul>
<p>下图是<code>defdelegate</code>在Elixir内核中的<a href="http://elixir-lang.org/docs/stable/elixir/Kernel.html#defdelegate/2" target="_blank" rel="external">定义</a></p>
<p><img src="/assets/images/elixir-defdelegate.png" alt="`defdelegate`在Elixir内核中的定义"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-25T07:59:06.000Z"><a href="/2014/10/25/elixir-collect-user-input/">2014-10-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/25/elixir-collect-user-input/">收集用户输入</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>在控制台程序中收集用户的输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#33719;&#21462;&#29992;&#25143;&#21517;&#10;input_username = IO.gets(&#34;Please input your username: &#34;)&#10;username = String.strip(input)&#10;first = String.first(username)&#10;# &#33719;&#21462;&#24180;&#40836;&#10;input_age = IO.gets(&#34;Please input your age:&#34;)&#10;age_str = String.strip(input_age)&#10;age = String.to_integer(age_str)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-24T08:47:07.000Z"><a href="/2014/10/24/ejabberd-client-disconnect-by-kill/">2014-10-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/24/ejabberd-client-disconnect-by-kill/">Ejabberd客户连接状态变化的服务器日志分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>客户端进程被杀掉的服务器连接处理日志</p>

<!--￼0-->


<p>客户端正常退出,服务器会收到一个流关闭标记<code>&lt;/stream:stream&gt;</code>(下图右侧第一行日志), 而客户端被杀死收到不到流关闭标记(左侧).<br>还未分析客户端连接超时或断开的情况.</p>
<p><img src="/assets/images/CA275FA1-0736-445C-AFA1-959C88A4EA33.png" alt="客户端正常退出和网络突然断开,服务器日志对比"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-24T02:56:12.000Z"><a href="/2014/10/24/elixir-learn-in-n-minutes/">2014-10-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/24/elixir-learn-in-n-minutes/">N分钟学习Elixir</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#注释"><span class="toc-number">1.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本类型"><span class="toc-number">2.</span> <span class="toc-text">基本类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#操作符"><span class="toc-number">3.</span> <span class="toc-text">操作符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#控制流"><span class="toc-number">4.</span> <span class="toc-text">控制流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模块和函数"><span class="toc-number">5.</span> <span class="toc-text">模块和函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结构和异常"><span class="toc-number">6.</span> <span class="toc-text">结构和异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#并发"><span class="toc-number">7.</span> <span class="toc-text">并发</span></a></li></ol>
        </div>
        


        <p>获取代码: <a href="http://learnxinyminutes.com/docs/files/learnelixir.ex" target="_blank" rel="external">learnelixir.ex</a></p>
<p>Elixir 是构建在Erlang虚拟机上的现代函数编程语言.完全和Erlang兼容,对很多标准语法进行了扩展,并提供了更多的功能.</p>
<p>翻译了一部分发现,已经有中文版了, <a href="http://learnxinyminutes.com/docs/zh-cn/elixir-cn" target="_blank" rel="external">在这里</a></p>
<h2 id="注释">注释</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#21333;&#34892;&#27880;&#37322;&#20197;&#19968;&#20010;#&#21495;&#24320;&#22987;.&#10;# &#27809;&#26377;&#22810;&#34892;&#27880;&#37322;,&#20294;&#21487;&#20197;&#27880;&#37322;&#22810;&#34892;.&#10;# &#35201;&#20351;&#29992;elixir shell&#20351;&#29992;`iex`&#21629;&#20196;.&#10;# &#32534;&#35793;&#27169;&#22359;&#20351;&#29992;`elixirc`&#21629;&#20196;.&#10;# &#22914;&#26524;elixir&#27491;&#30830;&#23433;&#35013;,&#24212;&#35813;&#37117;&#22312;PATH&#20013;.</span><br></pre></td></tr></table></figure>
<h2 id="基本类型">基本类型</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#36825;&#20123;&#26159;&#25968;&#23383;&#10;3    # &#25972;&#25968;&#10;0x1F # &#25972;&#25968;&#10;3.0  # &#28014;&#28857;&#25968;&#10;# Atoms, that are literals, a constant with name. They start with `:`.&#10;# &#21407;&#23376;,&#26159;&#23383;&#38754;&#30340;,&#19968;&#20010;&#21629;&#21517;&#24120;&#37327;. &#20197;`:`&#24320;&#22987;.&#10;:hello # atom&#10;# &#20803;&#32452;&#22312;&#20869;&#23384;&#20013;&#26159;&#36830;&#32493;&#22320;&#23384;&#20648;&#30340;&#10;&#123;1,2,3&#125; # tuple&#10;# &#21487;&#20197;&#20351;&#29992;`elem`&#20989;&#25968;&#35775;&#38382;&#19968;&#20010;&#20803;&#32452;&#20013;&#30340;&#20803;&#32032;&#10;elem(&#123;1, 2, 3&#125;, 0) #=&#62; 1&#10;# Lists that are implemented as linked lists.&#10;[1,2,3] # list&#10;# We can access the head and tail of a list as follows:&#10;[head | tail] = [1,2,3]&#10;head #=&#62; 1&#10;tail #=&#62; [2,3]&#10;# In elixir, just like in Erlang, the `=` denotes pattern matching and&#10;# not an assignment.&#10;#&#10;# This means that the left-hand side (pattern) is matched against a&#10;# right-hand side.&#10;#&#10;# This is how the above example of accessing the head and tail of a list works.&#10;# A pattern match will error when the sides don&#39;t match, in this example&#10;# the tuples have different sizes.&#10;# &#123;a, b, c&#125; = &#123;1, 2&#125; #=&#62; ** (MatchError) no match of right hand side value: &#123;1,2&#125;&#10;# There are also binaries&#10;&#60;&#60;1,2,3&#62;&#62; # binary&#10;# Strings and char lists&#10;&#34;hello&#34; # string&#10;&#39;hello&#39; # char list&#10;# Multi-line strings&#10;&#34;&#34;&#34;&#10;I&#39;m a multi-line&#10;string.&#10;&#34;&#34;&#34;&#10;#=&#62; &#34;I&#39;m a multi-line\nstring.\n&#34;&#10;# Strings are all encoded in UTF-8:&#10;&#34;h&#233;ll&#242;&#34; #=&#62; &#34;h&#233;ll&#242;&#34;&#10;# Strings are really just binaries, and char lists are just lists.&#10;&#60;&#60;?a, ?b, ?c&#62;&#62; #=&#62; &#34;abc&#34;&#10;[?a, ?b, ?c]   #=&#62; &#39;abc&#39;&#10;# `?a` in elixir returns the ASCII integer for the letter `a`&#10;?a #=&#62; 97&#10;# To concatenate lists use `++`, for binaries use `&#60;&#62;`&#10;[1,2,3] ++ [4,5]     #=&#62; [1,2,3,4,5]&#10;&#39;hello &#39; ++ &#39;world&#39;  #=&#62; &#39;hello world&#39;&#10;&#60;&#60;1,2,3&#62;&#62; &#60;&#62; &#60;&#60;4,5&#62;&#62; #=&#62; &#60;&#60;1,2,3,4,5&#62;&#62;&#10;&#34;hello &#34; &#60;&#62; &#34;world&#34;  #=&#62; &#34;hello world&#34;</span><br></pre></td></tr></table></figure>
<h2 id="操作符">操作符</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Some math&#10;1 + 1  #=&#62; 2&#10;10 - 5 #=&#62; 5&#10;5 * 2  #=&#62; 10&#10;10 / 2 #=&#62; 5.0&#10;# In elixir the operator `/` always returns a float.&#10;# To do integer division use `div`&#10;div(10, 2) #=&#62; 5&#10;# To get the division remainder use `rem`&#10;rem(10, 3) #=&#62; 1&#10;# There are also boolean operators: `or`, `and` and `not`.&#10;# These operators expect a boolean as their first argument.&#10;true and true #=&#62; true&#10;false or true #=&#62; true&#10;# 1 and true    #=&#62; ** (ArgumentError) argument error&#10;# Elixir also provides `||`, `&#38;&#38;` and `!` which accept arguments of any type.&#10;# All values except `false` and `nil` will evaluate to true.&#10;1 || true  #=&#62; 1&#10;false &#38;&#38; 1 #=&#62; false&#10;nil &#38;&#38; 20  #=&#62; nil&#10;!true #=&#62; false&#10;# For comparisons we have: `==`, `!=`, `===`, `!==`, `&#60;=`, `&#62;=`, `&#60;` and `&#62;`&#10;1 == 1 #=&#62; true&#10;1 != 1 #=&#62; false&#10;1 &#60; 2  #=&#62; true&#10;# `===` and `!==` are more strict when comparing integers and floats:&#10;1 == 1.0  #=&#62; true&#10;1 === 1.0 #=&#62; false&#10;# We can also compare two different data types:&#10;1 &#60; :hello #=&#62; true&#10;# The overall sorting order is defined below:&#10;# number &#60; atom &#60; reference &#60; functions &#60; port &#60; pid &#60; tuple &#60; list &#60; bit string&#10;# To quote Joe Armstrong on this: &#34;The actual order is not important,&#10;# but that a total ordering is well defined is important.&#34;</span><br></pre></td></tr></table></figure>
<h2 id="控制流">控制流</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># `if` expression&#10;if false do&#10;  &#34;This will never be seen&#34;&#10;else&#10;  &#34;This will&#34;&#10;end&#10;# There&#39;s also `unless`&#10;unless true do&#10;  &#34;This will never be seen&#34;&#10;else&#10;  &#34;This will&#34;&#10;end&#10;# Remember pattern matching? Many control-flow structures in elixir rely on it.&#10;# `case` allows us to compare a value against many patterns:&#10;case &#123;:one, :two&#125; do&#10;  &#123;:four, :five&#125; -&#62;&#10;    &#34;This won&#39;t match&#34;&#10;  &#123;:one, x&#125; -&#62;&#10;    &#34;This will match and bind `x` to `:two`&#34;&#10;  _ -&#62;&#10;    &#34;This will match any value&#34;&#10;end&#10;# It&#39;s common to bind the value to `_` if we don&#39;t need it.&#10;# For example, if only the head of a list matters to us:&#10;[head | _] = [1,2,3]&#10;head #=&#62; 1&#10;# For better readability we can do the following:&#10;[head | _tail] = [:a, :b, :c]&#10;head #=&#62; :a&#10;# `cond` lets us check for many conditions at the same time.&#10;# Use `cond` instead of nesting many `if` expressions.&#10;cond do&#10;  1 + 1 == 3 -&#62;&#10;    &#34;I will never be seen&#34;&#10;  2 * 5 == 12 -&#62;&#10;    &#34;Me neither&#34;&#10;  1 + 2 == 3 -&#62;&#10;    &#34;But I will&#34;&#10;end&#10;# It is common to see the last condition equal to `true`, which will always match.&#10;cond do&#10;  1 + 1 == 3 -&#62;&#10;    &#34;I will never be seen&#34;&#10;  2 * 5 == 12 -&#62;&#10;    &#34;Me neither&#34;&#10;  true -&#62;&#10;    &#34;But I will (this is essentially an else)&#34;&#10;end&#10;# `try/catch` is used to catch values that are thrown, it also supports an&#10;# `after` clause that is invoked whether or not a value is caught.&#10;try do&#10;  throw(:hello)&#10;catch&#10;  message -&#62; &#34;Got #&#123;message&#125;.&#34;&#10;after&#10;  IO.puts(&#34;I&#39;m the after clause.&#34;)&#10;end&#10;#=&#62; I&#39;m the after clause&#10;# &#34;Got :hello&#34;</span><br></pre></td></tr></table></figure>
<h2 id="模块和函数">模块和函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Anonymous functions (notice the dot)&#10;square = fn(x) -&#62; x * x end&#10;square.(5) #=&#62; 25&#10;# They also accept many clauses and guards.&#10;# Guards let you fine tune pattern matching,&#10;# they are indicated by the `when` keyword:&#10;f = fn&#10;  x, y when x &#62; 0 -&#62; x + y&#10;  x, y -&#62; x * y&#10;end&#10;f.(1, 3)  #=&#62; 4&#10;f.(-1, 3) #=&#62; -3&#10;# Elixir also provides many built-in functions.&#10;# These are available in the current scope.&#10;is_number(10)    #=&#62; true&#10;is_list(&#34;hello&#34;) #=&#62; false&#10;elem(&#123;1,2,3&#125;, 0) #=&#62; 1&#10;# You can group several functions into a module. Inside a module use `def`&#10;# to define your functions.&#10;defmodule Math do&#10;  def sum(a, b) do&#10;    a + b&#10;  end&#10;  def square(x) do&#10;    x * x&#10;  end&#10;end&#10;Math.sum(1, 2)  #=&#62; 3&#10;Math.square(3) #=&#62; 9&#10;# To compile our simple Math module save it as `math.ex` and use `elixirc`&#10;# in your terminal: elixirc math.ex&#10;# Inside a module we can define functions with `def` and private functions with `defp`.&#10;# A function defined with `def` is available to be invoked from other modules,&#10;# a private function can only be invoked locally.&#10;defmodule PrivateMath do&#10;  def sum(a, b) do&#10;    do_sum(a, b)&#10;  end&#10;  defp do_sum(a, b) do&#10;    a + b&#10;  end&#10;end&#10;PrivateMath.sum(1, 2)    #=&#62; 3&#10;# PrivateMath.do_sum(1, 2) #=&#62; ** (UndefinedFunctionError)&#10;# Function declarations also support guards and multiple clauses:&#10;defmodule Geometry do&#10;  def area(&#123;:rectangle, w, h&#125;) do&#10;    w * h&#10;  end&#10;  def area(&#123;:circle, r&#125;) when is_number(r) do&#10;    3.14 * r * r&#10;  end&#10;end&#10;Geometry.area(&#123;:rectangle, 2, 3&#125;) #=&#62; 6&#10;Geometry.area(&#123;:circle, 3&#125;)       #=&#62; 28.25999999999999801048&#10;# Geometry.area(&#123;:circle, &#34;not_a_number&#34;&#125;)&#10;#=&#62; ** (FunctionClauseError) no function clause matching in Geometry.area/1&#10;# Due to immutability, recursion is a big part of elixir&#10;defmodule Recursion do&#10;  def sum_list([head | tail], acc) do&#10;    sum_list(tail, acc + head)&#10;  end&#10;  def sum_list([], acc) do&#10;    acc&#10;  end&#10;end&#10;Recursion.sum_list([1,2,3], 0) #=&#62; 6&#10;# Elixir modules support attributes, there are built-in attributes and you&#10;# may also add custom ones.&#10;defmodule MyMod do&#10;  @moduledoc &#34;&#34;&#34;&#10;  This is a built-in attribute on a example module.&#10;  &#34;&#34;&#34;&#10;  @my_data 100 # This is a custom attribute.&#10;  IO.inspect(@my_data) #=&#62; 100&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="结构和异常">结构和异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Structs are extensions on top of maps that bring default values,&#10;# compile-time guarantees and polymorphism into Elixir.&#10;defmodule Person do&#10;  defstruct name: nil, age: 0, height: 0&#10;end&#10;joe_info = %Person&#123; name: &#34;Joe&#34;, age: 30, height: 180 &#125;&#10;#=&#62; %Person&#123;age: 30, height: 180, name: &#34;Joe&#34;&#125;&#10;# Access the value of name&#10;joe_info.name #=&#62; &#34;Joe&#34;&#10;# Update the value of age&#10;older_joe_info = %&#123; joe_info | age: 31 &#125;&#10;#=&#62; %Person&#123;age: 31, height: 180, name: &#34;Joe&#34;&#125;&#10;# The `try` block with the `rescue` keyword is used to handle exceptions&#10;try do&#10;  raise &#34;some error&#34;&#10;rescue&#10;  RuntimeError -&#62; &#34;rescued a runtime error&#34;&#10;  _error -&#62; &#34;this will rescue any error&#34;&#10;end&#10;# All exceptions have a message&#10;try do&#10;  raise &#34;some error&#34;&#10;rescue&#10;  x in [RuntimeError] -&#62;&#10;    x.message&#10;end</span><br></pre></td></tr></table></figure>
<h2 id="并发">并发</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Elixir relies on the actor model for concurrency. All we need to write&#10;# concurrent programs in elixir are three primitives: spawning processes,&#10;# sending messages and receiving messages.&#10;# To start a new process we use the `spawn` function, which takes a function&#10;# as argument.&#10;f = fn -&#62; 2 * 2 end #=&#62; #Function&#60;erl_eval.20.80484245&#62;&#10;spawn(f) #=&#62; #PID&#60;0.40.0&#62;&#10;# `spawn` returns a pid (process identifier), you can use this pid to send&#10;# messages to the process. To do message passing we use the `send` operator.&#10;# For all of this to be useful we need to be able to receive messages. This is&#10;# achieved with the `receive` mechanism:&#10;defmodule Geometry do&#10;  def area_loop do&#10;    receive do&#10;      &#123;:rectangle, w, h&#125; -&#62;&#10;        IO.puts(&#34;Area = #&#123;w * h&#125;&#34;)&#10;        area_loop()&#10;      &#123;:circle, r&#125; -&#62;&#10;        IO.puts(&#34;Area = #&#123;3.14 * r * r&#125;&#34;)&#10;        area_loop()&#10;    end&#10;  end&#10;end&#10;# Compile the module and create a process that evaluates `area_loop` in the shell&#10;pid = spawn(fn -&#62; Geometry.area_loop() end) #=&#62; #PID&#60;0.40.0&#62;&#10;# Send a message to `pid` that will match a pattern in the receive statement&#10;send pid, &#123;:rectangle, 2, 3&#125;&#10;#=&#62; Area = 6&#10;#   &#123;:rectangle,2,3&#125;&#10;send pid, &#123;:circle, 2&#125;&#10;#=&#62; Area = 12.56000000000000049738&#10;#   &#123;:circle,2&#125;&#10;# The shell is also a process, you can use `self` to get the current pid&#10;self() #=&#62; #PID&#60;0.27.0&#62;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-23T09:30:27.000Z"><a href="/2014/10/23/elixir-base64/">2014-10-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/23/elixir-base64/">Base64编码</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/AA9701C5-0427-45AF-88CE-CB0DA1183FAB.png" alt="Elixir base64 和url,文件名安全的base64字母表"></p>
<p>一般性的Base64编码包含<code>+</code>,<code>/</code>两个符号,但是这两个符号在URL中有特殊的含义,因此需要一种方式来避免这两个符号的冲突. 在编码URL地址和文件名的时候分别使用<code>-</code>,<code>_</code>替换这两个符号.</p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://elixir-lang.org/docs/master/elixir/Base.html" target="_blank" rel="external">http://elixir-lang.org/docs/master/elixir/Base.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-23T08:20:32.000Z"><a href="/2014/10/23/erlang-emysql-execute-prepared-statement/">2014-10-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/23/erlang-emysql-execute-prepared-statement/">Emysql 执行预处理语句</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%% &#21019;&#24314;&#19968;&#20010;&#39044;&#22788;&#29702;&#35821;&#21477;&#10;emysql:prepare(stmt_isbound, &#60;&#60;&#34;SELECT COUNT(sn) FROM online_users WHERE sn = ? AND jid = ?&#34;&#62;&#62;),&#10;%% &#25191;&#34892;&#39044;&#22788;&#29702;&#35821;&#21477;&#10;&#123;_, _, _, [[Rows]], _&#125; = emysql:execute(pool_gbox_messager, stmt_isbound, [Sn, Jid]),&#10;?INFO_MSG(&#34;COUNT: ~p~n&#34;, [Rows])</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-21T07:59:04.000Z"><a href="/2014/10/21/ejabberd-reload-modified-modules-dynamically/">2014-10-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/21/ejabberd-reload-modified-modules-dynamically/">Ejabberd动态的重新加载(更新)修改的模块</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">1.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过Web更新模块代码"><span class="toc-number">2.</span> <span class="toc-text">通过Web更新模块代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bugfix"><span class="toc-number">3.</span> <span class="toc-text">Bugfix</span></a></li></ol>
        </div>
        


        <p>有时候我们不想停止ejabberd服务,同时能够更新我们的自定义模块,ejabberd已经为我们提供了这样一个功能.通过使用ejabberd的<code>ejabberd_update</code>核心模块, 我们可以在<code>运行时重新加载</code>我们的模块新代码.</p>
<p>ejabberd_update核心模块为我们提供了如下三个导出的接口函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-export([&#10;    %% Update all the modified modules&#10;    update/0,&#10;    %% Update only the specified modules&#10;    update/1,&#10;    %% Get information about the modified modules&#10;    update_info/0&#10;]).</span><br></pre></td></tr></table></figure>
<h2 id="示例">示例</h2><p>该示例假设你已经搭建好了Ejabberd的开发环境,如果还未搭建号开发环境,请完成开发环境的搭建.</p>
<ul>
<li>首先停止ejabberd</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ejabberdctl stop</span><br></pre></td></tr></table></figure>
<ul>
<li>启动到<code>live</code>模式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ejabberdctl live</span><br></pre></td></tr></table></figure>
<ul>
<li>更新一个模块文件/编译/安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &#38;&#38; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>查看需要更新的模块列表</li>
</ul>
<p>打开一个新的终端执行,查看哪些模块代码需要更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@bffd81e6215e:~/ejabberd# ejabberdctl update_list&#10;mod_gbox_messager</span><br></pre></td></tr></table></figure>
<p>我们看到,update_list命令列出了我们需要更新的模块<code>mod_gbox_messager</code></p>
<ul>
<li>切换到live模式的窗口执行</li>
</ul>
<p>为了清晰,下面的输出通过手工格式化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(ejabberd@localhost)2&#62; ejabberd_update:update().&#10;07:57:08.491 [debug] beam files: [mod_gbox_messager]&#10;07:57:08.492 [debug] script: [&#123;load_module,mod_gbox_messager&#125;]&#10;07:57:08.492 [debug] low level script: [&#10;    &#123;&#10;        load_object_code,&#10;        &#123;&#10;            ejabberd,[],[mod_gbox_messager]&#10;        &#125;&#10;    &#125;,&#10;    point_of_no_return,&#123;&#10;        load,&#123;&#10;            mod_gbox_messager,&#10;            brutal_purge,brutal_purge&#10;        &#125;&#10;    &#125;&#10;]&#10;07:57:08.492 [debug] check: &#123;ok,[]&#125;&#10;07:57:08.497 [debug] eval: &#123;ok,[]&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取更新信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(ejabberd@localhost)4&#62; ejabberd_update:update_info().&#10;08:25:24.357 [debug] beam files: [mod_gbox_messager]&#10;08:25:24.358 [debug] script: [&#123;load_module,mod_gbox_messager&#125;]&#10;08:25:24.358 [debug] low level script: [&#10;    &#123;&#10;        load_object_code,&#10;        &#123;ejabberd,[],[mod_gbox_messager]&#125;&#10;    &#125;,&#10;    point_of_no_return,&#10;    &#123;load,&#123;mod_gbox_messager,brutal_purge,brutal_purge&#125;&#125;&#10;]&#10;08:25:24.358 [debug] check: &#123;ok,[]&#125;&#10;&#123;&#10;    ok,&#10;    &#34;/lib/ejabberd/ebin&#34;,&#10;    [mod_gbox_messager],&#10;    [&#123;load_module,mod_gbox_messager&#125;],&#10;    [&#10;        &#123;load_object_code,&#123;ejabberd,[],[mod_gbox_messager]&#125;&#125;,&#10;        point_of_no_return,&#10;        &#123;load,&#123;mod_gbox_messager,brutal_purge,brutal_purge&#125;&#125;&#10;    ],&#10;    ok&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_update:update_info()</code>返回一个元组,其中包含了beam文件的位置<code>/lib/ejabberd/ebin</code>, 要加载的模块列表<code>[{load_module,mod_gbox_messager}]</code>等, 我们可以在我们的HTTP模块代码中使用,比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%% &#25171;&#21360;&#38656;&#35201;&#26356;&#26032;&#30340;&#27169;&#22359;&#10;print_modules() -&#62;&#10;    &#123;ok,_Ebin,Modules,_,_,_&#125; = ejabberd_update:update_info,&#10;    ?INFO_MSG(&#34;modules to update: ~p~n&#34;, [Modules]).</span><br></pre></td></tr></table></figure>
<h2 id="通过Web更新模块代码">通过Web更新模块代码</h2><p>开发一个Ejabberd的HTTP模块,(如何开发Ejabberd的HTTP模块,请参考 <a href="/2014/09/18/ejabberd-http-module">开发一个Ejabberd HTTP模块</a>) 并通过RESTFul接口动态地更新模块代码</p>
<p>下面我们来定义两个RESTFul服务的端点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost/update-modules/all&#10;POST http://localhost/update-modules</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个端点用于更新所有已修改的模块</li>
<li>第二个端点用于更新特定的模块列表,POST的数据格式采用JSON</li>
</ul>
<p>为了能在HTTP模块中解码JSON数据,这里用到了Jiffy模块用于处理JSON数据的encode/decode操作. 关于Jiffy的使用,可参考 <a href="/2014/09/28/ejabberd-jiffy">Ejabberd中用Jiffy输出JSON数据</a>,有了这样一个功能,我们可以开发Ejabberd的自定义的HTTP模块通过Web动态地更新我们的模块.</p>
<p>如果更新成功<code>ejabberd_update:update/0</code>会返回<code>{ok,[]}</code>,可依据此判断更新过程是否成功,并返回JSON消息通知客户端更新结果.</p>
<h2 id="Bugfix">Bugfix</h2><ul>
<li>2014-10-23</li>
</ul>
<p><code>ejabberdctl live</code>启动后是没有加载<code>ejabberd_update</code>模块的, 需要执行ejabberdctl加载一次<code>ejabberd_update</code>模块, 如果是通过程序调用更新,调用时会自动加载更新模块. 所以要先执行一个<code>ejabberdctl update_list</code>手工初始化<code>ejabberd_update</code>模块.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-20T16:46:02.000Z"><a href="/2014/10/21/programming-erlang-2nd-ch11/">2014-10-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/21/programming-erlang-2nd-ch11/">Erlang程序模型,我们是怎么思考和交互的</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>我们没有共享的记忆(memory),我有我的记忆,你有你的. 我们有两个大脑,每人一个. 它们并没有相连. 要修改你的记忆,我发送一个消息给你: 我给你说,或我挥一挥手.</p>
<p>你听着,你看着,你的记忆在改变;但我们并没有问你问题或者观察你的反应,我不知道你收到了我的消息.</p>
<p>这就是Erlang进程的工作方式. Erlang进程没有共享内存. 每一个进程有它自己的内存. 要改变其他进程的内存,你必须给它发消息,并期望它能收到并理解消息.</p>
<p>为了确认另一个进程收到了你的消息,并且改变了它的内存,你必须问它(通过发送消息给它). 这正是我们的交互方式:</p>
<p>我: 嘿,亲爱的,我的电话号码是138-1234-1234.<br>我: 你记住了么?<br>她: 记住了,你的号码是 138-1234-1234</p>
<p>这个交互模式对我们来说是众所周知的.</p>
<p>从出生开始,我们通过观察学习与这个世界交互,给这个世界发出消息,并观察其反应.</p>
<blockquote>
<p>人们作为独立的个体依靠消息通信.</p>
</blockquote>
<p>这就是Erlang进程的工作模式,这也是我们的工作模式,因此,理解一个Erlang程序就变得容易了.</p>
<p>一个Erlang程序也许由十几个,或成百上千的细小的进程组成. 所有这些进程都独立的运行,它们之间依靠收发消息通信.每一个进程都有私有的内存. 这就像在一个超大的房间内所有人在相互交谈一样.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-17T03:35:17.000Z"><a href="/2014/10/17/erlang-stdlib-lists/">2014-10-17</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/17/erlang-stdlib-lists/">Erlang标准库示例 lists</a></h1>
  

    </header>
    <div class="entry">
      


        


        <blockquote>
<h2 id="keysearch(Key,_N,_TupleList)_-&gt;_{value,_Tuple}_|_false">keysearch(Key, N, TupleList) -&gt; {value, Tuple} | false</h2></blockquote>
<p>Types:</p>
<pre><code>Key = <span class="function"><span class="title">term</span><span class="params">()</span></span>
N = <span class="function"><span class="title">integer</span><span class="params">()</span></span> &gt;= <span class="number">1</span>
<span class="number">1</span>..<span class="function"><span class="title">tuple_size</span><span class="params">(Tuple)</span></span>
TupleList = [Tuple]
Tuple = <span class="function"><span class="title">tuple</span><span class="params">()</span></span>
</code></pre><p>在一个元组列表中搜索, 列表中元组的第<code>N</code>个元素等于<code>Key</code>时返回 <code>{value, Tuple}</code>,其中<code>Tuple</code>为找到的这个元组. 如果没有找到返回<code>false</code>.</p>
<p>Note<br>    该函数的保留是为了兼容, 使用<code>lists:keyfind/3</code>(R13A引入的一个方法)更加方便.</p>
<blockquote>
<p>例子</p>
</blockquote>
<p><strong>lists:keysearch/3</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#62; lists:keysearch(mail,1, [&#123;username, &#34;13012345678&#34;&#125;, &#123;mail, &#34;13012345678@139.com&#34;&#125;, &#123;tel, 13012345678&#125;]).&#10;&#123;value,&#123;mail,&#34;13012345678@139.com&#34;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lists:keyfind/3</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3&#62; lists:keyfind(mail,1, [&#123;username, &#34;13012345678&#34;&#125;, &#123;mail, &#34;13012345678@139.com&#34;&#125;, &#123;tel, 13012345678&#125;]).&#10;&#123;mail,&#34;13012345678@139.com&#34;&#125;</span><br></pre></td></tr></table></figure>
<p>注意<code>lists:keysearch/3</code>和<code>lists:keyfind/3</code>返回值的差异.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-15T08:33:20.000Z"><a href="/2014/10/15/ejabberd-mod-logxml/">2014-10-15</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/15/ejabberd-mod-logxml/">Ejabberd XML格式的XMPP消息日志模块</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight"><figcaption><span>mod_logxml.erl模块配置</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modules:&#10;  mod_logxml:&#10;    #stanza: [message, other]&#10;    #direction: [internal, vhosts, external]&#10;    #orientation: [send, recv]&#10;    logdir: &#34;/var/log/ejabberd/xmllogs&#34;&#10;    #timezone: universal&#10;    #rotate_days: 10&#10;    rotate_megs: 1000000&#10;    #rotate_kpackets: no&#10;    #check_rotate_kpackets: 1</span><br></pre></td></tr></table></figure>
<p>模块文件, 完整文件,请点击右侧<code>mod_logxml.erl</code>连接</p>
<figure class="highlight erlang"><figcaption><span>Ejabberd mod_logxml模块,记录stanza到XML日志文件中</span><a href="https://gist.github.com/developerworks/34bf6015f1f4890a210e" target="_blank" rel="external">mod_logxml.erl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_logxml)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-author</span><span class="params">('badlop@ono.com')</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">  start/<span class="number">2</span>,</span><br><span class="line">  init/<span class="number">7</span>,</span><br><span class="line">  stop/<span class="number">1</span>,</span><br><span class="line">  send_packet/<span class="number">3</span>,</span><br><span class="line">  receive_packet/<span class="number">4</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">PROCNAME</span>, ejabberd_mod_logxml)</span></span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">Host</span>, <span class="variable">Opts</span>)</span> -&gt;</span></span><br><span class="line">  <span class="comment">%% 日志存储目录</span></span><br><span class="line">  <span class="variable">Logdir</span> = <span class="function_name">gen_mod:get_opt</span>(logdir, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="string">"/tmp/jabberlogs/"</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Logdir: ~p"</span>, [<span class="variable">Logdir</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动天数</span></span><br><span class="line">  <span class="variable">Rd</span> = <span class="function_name">gen_mod:get_opt</span>(rotate_days, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rd: ~p"</span>, [<span class="variable">Rd</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动兆字节数,默认日志文件满10MB后创建新文件记录当前日志输出</span></span><br><span class="line">  <span class="variable">Rf</span> = <span class="keyword">case</span> <span class="function_name">gen_mod:get_opt</span>(rotate_megs, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">10</span>) <span class="keyword">of</span></span><br><span class="line">         no -&gt; no;</span><br><span class="line">         <span class="variable">Rf1</span> -&gt; <span class="variable">Rf1</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">       <span class="keyword">end</span>,</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rf: ~p"</span>, [<span class="variable">Rf</span>]),</span><br><span class="line">  <span class="comment">%% 按接收到的XMPP数据包的数量滚动</span></span><br><span class="line">  <span class="variable">Rp</span> = <span class="keyword">case</span> <span class="function_name">gen_mod:get_opt</span>(rotate_kpackets, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">10</span>) <span class="keyword">of</span></span><br><span class="line">         no -&gt; no;</span><br><span class="line">         <span class="variable">Rp1</span> -&gt; <span class="variable">Rp1</span> * <span class="number">1000</span></span><br><span class="line">       <span class="keyword">end</span>,</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Rp: ~p"</span>, [<span class="variable">Rp</span>]),</span><br><span class="line">  <span class="comment">%% 日志滚动选项</span></span><br><span class="line">  <span class="variable">RotateO</span> = <span class="tuple">&#123;<span class="variable">Rd</span>, <span class="variable">Rf</span>, <span class="variable">Rp</span>&#125;</span>,</span><br><span class="line">  <span class="variable">CheckRKP</span> = <span class="function_name">gen_mod:get_opt</span>(check_rotate_kpackets, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML RotateO: ~p"</span>, [<span class="variable">RotateO</span>]),</span><br><span class="line">  <span class="comment">%% 时区配置选项</span></span><br><span class="line">  <span class="variable">Timezone</span> = <span class="function_name">gen_mod:get_opt</span>(timezone, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, local),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Timezone: ~p"</span>, [<span class="variable">Timezone</span>]),</span><br><span class="line">  <span class="comment">%% 数据流方向</span></span><br><span class="line">  <span class="variable">Orientation</span> = <span class="function_name">gen_mod:get_opt</span>(orientation, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [send, recv]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Orientation: ~p"</span>, [<span class="variable">Orientation</span>]),</span><br><span class="line">  <span class="comment">%% XMPP节</span></span><br><span class="line">  <span class="variable">Stanza</span> = <span class="function_name">gen_mod:get_opt</span>(stanza, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [iq, message, presence, other]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Stanza: ~p"</span>, [<span class="variable">Stanza</span>]),</span><br><span class="line">  <span class="comment">%% 连接方向</span></span><br><span class="line">  <span class="variable">Direction</span> = <span class="function_name">gen_mod:get_opt</span>(direction, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, [internal, vhosts, external]),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML Direction: ~p"</span>, [<span class="variable">Direction</span>]),</span><br><span class="line">  <span class="comment">%% 过滤器选项</span></span><br><span class="line">  <span class="variable">FilterO</span> = <span class="tuple">&#123;</span><br><span class="line">    <span class="tuple">&#123;orientation, <span class="variable">Orientation</span>&#125;</span>,</span><br><span class="line">    <span class="tuple">&#123;stanza, <span class="variable">Stanza</span>&#125;</span>,</span><br><span class="line">    <span class="tuple">&#123;direction, <span class="variable">Direction</span>&#125;</span>&#125;</span>,</span><br><span class="line">  <span class="comment">%% 是否显示IP地址</span></span><br><span class="line">  <span class="variable">ShowIP</span> = <span class="function_name">gen_mod:get_opt</span>(show_ip, <span class="variable">Opts</span>, <span class="keyword">fun</span>(<span class="variable">A</span>) -&gt; <span class="variable">A</span> <span class="keyword">end</span>, false),</span><br><span class="line">  ?<span class="variable">DEBUG</span>(<span class="string">"EJABBERD_MOD_LOGXML ShowIP: ~p"</span>, [<span class="variable">ShowIP</span>]),</span><br><span class="line">  <span class="comment">%% 用户收发XMPP数据包钩子</span></span><br><span class="line">  <span class="function_name">ejabberd_hooks:add</span>(user_send_packet, <span class="variable">Host</span>, ?<span class="variable">MODULE</span>, send_packet, <span class="number">90</span>),</span><br><span class="line">  <span class="function_name">ejabberd_hooks:add</span>(user_receive_packet, <span class="variable">Host</span>, ?<span class="variable">MODULE</span>, receive_packet, <span class="number">90</span>),</span><br><span class="line">  <span class="comment">%% 进程注册</span></span><br><span class="line">  <span class="function_name">register</span>(</span><br><span class="line">    <span class="comment">%% 获取模块</span></span><br><span class="line">    <span class="function_name">gen_mod:get_module_proc</span>(<span class="variable">Host</span>, ?<span class="variable">PROCNAME</span>),</span><br><span class="line">    <span class="function_name">spawn</span>(?<span class="variable">MODULE</span>, init, [<span class="variable">Host</span>, <span class="variable">Logdir</span>, <span class="variable">RotateO</span>, <span class="variable">CheckRKP</span>, <span class="variable">Timezone</span>, <span class="variable">ShowIP</span>, <span class="variable">FilterO</span>])</span><br><span class="line">  ).</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">省略</span><br></pre></td></tr></table></figure>
<h2 id="格式化输出">格式化输出</h2><figure class="highlight python"><figcaption><span>格式化XML</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> tail</span><br><span class="line"><span class="keyword">import</span> xml.dom.minidom</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pretty_print</span><span class="params">(xml_string)</span>:</span></span><br><span class="line">    fragment = xml.dom.minidom.parseString(xml_string)</span><br><span class="line">    string = fragment.toprettyxml(indent=<span class="string">"  "</span>, newl=<span class="string">"\n"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    print(string)</span><br><span class="line"><span class="comment"># Create a tail instance</span></span><br><span class="line">t = tail.Tail(<span class="string">'xmpp.hezhiqiang.info.xml'</span>)</span><br><span class="line"><span class="comment"># Register a callback function to be called when a new line is found in the followed file.</span></span><br><span class="line"><span class="comment"># If no callback function is registerd, new lines would be printed to standard out.</span></span><br><span class="line">t.register_callback(pretty_print)</span><br><span class="line"><span class="comment"># Follow the file with 5 seconds as sleep time between iterations.</span></span><br><span class="line"><span class="comment"># If sleep time is not provided 1 second is used as the default time.</span></span><br><span class="line">t.follow(s=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://stackoverflow.com/questions/24012466/xmpp-traffic-logging-ejabberd-13-12" target="_blank" rel="external">http://stackoverflow.com/questions/24012466/xmpp-traffic-logging-ejabberd-13-12</a></li>
<li><a href="http://stackoverflow.com/questions/749796/pretty-printing-xml-in-python" target="_blank" rel="external">http://stackoverflow.com/questions/749796/pretty-printing-xml-in-python</a></li>
<li><a href="https://github.com/kasun/python-tail" target="_blank" rel="external">https://github.com/kasun/python-tail</a></li>
<li><a href="https://docs.python.org/2/library/xml.dom.minidom.html" target="_blank" rel="external">https://docs.python.org/2/library/xml.dom.minidom.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-14T02:21:11.000Z"><a href="/2014/10/14/elixir-doc/">2014-10-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/14/elixir-doc/">文档工具</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="内置文档生成">内置文档生成</h2><p>在Elixir中,文档是一等公民, Elixir对其有内置的支持, 不需要第三方文档生成工具. 只需要使用<code>@doc</code>标签即可</p>
<h3 id="函数文档">函数文档</h3><ul>
<li>创建一个文件<code>hello.exs</code>如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Elixir module&#10;defmodule Test do&#10;    @doc &#34;&#34;&#34;&#10;    &#19968;&#20010;Echo&#26041;&#27861;&#29992;&#20110;&#36755;&#20986;Hello World.&#10;    &#34;&#34;&#34;&#10;    def echo do&#10;        IO.puts &#34;Hello World!&#34;&#10;    end&#10;end</span><br></pre></td></tr></table></figure>
<ul>
<li>进入交互式shell</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# iex</span><br></pre></td></tr></table></figure>
<ul>
<li>编译模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(1)&#62; c(&#34;hello.exs&#34;)</span><br></pre></td></tr></table></figure>
<p>模块编译会在当前目录下生成一个<code>Elixir.Test.beam</code> BEAM文件.</p>
<ul>
<li>查看文档</li>
</ul>
<p><img src="/assets/images/820FF121-4358-4564-BBB9-1C5C5F7AF8BF.png" alt="在Elixir交互式Shell中查看函数文档"></p>
<h3 id="模块文档">模块文档</h3><p><code>@moduledoc</code></p>
<h2 id="函数参数和返回类型规范">函数参数和返回类型规范</h2><p>函数定义的类型规范是通过<code>@spec</code>标签定义的</p>
<h2 id="用ExDoc生成文档">用ExDoc生成文档</h2><ul>
<li><p>用<code>mix</code>创建一个新项目</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/ejabberd/elixir# mix new docs&#10;* creating README.md&#10;* creating .gitignore&#10;* creating mix.exs&#10;* creating config&#10;* creating config/config.exs&#10;* creating lib&#10;* creating lib/docs.ex&#10;* creating test&#10;* creating test/test_helper.exs&#10;* creating test/docs_test.exs&#10;Your mix project was created successfully.&#10;You can use mix to compile it, test it, and more:&#10;    cd docs&#10;    mix test&#10;Run `mix help` for more commands.</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑mix.exs,添加依赖模块</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmodule Docs.Mixfile do&#10;  use Mix.Project&#10;  def project do&#10;    [app: :docs,&#10;     version: &#34;0.0.1&#34;,&#10;     elixir: &#34;~&#62; 1.0&#34;,&#10;     deps: deps]&#10;  end&#10;  # Configuration for the OTP application&#10;  #&#10;  # Type `mix help compile.app` for more information&#10;  def application do&#10;    [applications: [:logger]]&#10;  end&#10;  # Dependencies can be Hex packages:&#10;  #&#10;  #   &#123;:mydep, &#34;~&#62; 0.3.0&#34;&#125;&#10;  #&#10;  # Or git/path repositories:&#10;  #&#10;  #   &#123;:mydep, git: &#34;https://github.com/elixir-lang/mydep.git&#34;, tag: &#34;0.1.0&#34;&#125;&#10;  #&#10;  # Type `mix help deps` for more examples and options&#10;  defp deps do&#10;    [&#123;:ex_doc, github: &#34;elixir-lang/ex_doc&#34;&#125;]&#10;  end&#10;end</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装依赖</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/elixir/docs# mix deps.get&#10;* Updating ex_doc (git://github.com/elixir-lang/ex_doc.git)&#10;==&#62; ex_doc&#10;Could not find hex, which is needed to build dependency :earmark&#10;Shall I install hex? [Yn] Y&#10;2014-10-13 09:07:56 URL:https://s3.amazonaws.com/s3.hex.pm/installs/hex.ez [240877/240877] -&#62; &#34;/root/.mix/archives/hex.ez&#34; [1]&#10;* creating /root/.mix/archives/hex.ez</span><br></pre></td></tr></table></figure>
<ul>
<li>生成文档</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix docs</span><br></pre></td></tr></table></figure>
<h2 id="ExDoc中文模板">ExDoc中文模板</h2><p>下载地址:<br><a href="https://github.com/developerworks/ex_doc" target="_blank" rel="external">https://github.com/developerworks/ex_doc</a></p>
<p><img src="/assets/images/61802553-AA1E-430F-9BED-2B25BC2BAF58.png" alt="ExDoc中文模板"></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-13T17:06:12.000Z"><a href="/2014/10/14/elixir-first/">2014-10-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/14/elixir-first/">第一印象</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Elixir 依赖与Erlang/OTP 17,需要首先安装Erlang, 这里不讲解如何安装Erlang, 这里说明如何编译和使用Elixir</p>
<h1 id="编译">编译</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#19979;&#36733;&#10;wget https://github.com/elixir-lang/elixir/archive/v1.0.1.tar.gz&#10;# &#35299;&#21387;&#10;tar zxf v1.0.1.tar.gz&#10;cd elixir-1.0.1&#10;make</span><br></pre></td></tr></table></figure>
<h1 id="配置路径">配置路径</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/root/elixir-1.0.1/bin:$PATH</span><br></pre></td></tr></table></figure>
<h1 id="交互式Shell">交互式Shell</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/elixir-1.0.1/bin# iex&#10;Erlang/OTP 17 [erts-6.2] [source] [64-bit] [async-threads:10] [kernel-poll:false]&#10;Interactive Elixir (1.0.1) - press Ctrl+C to exit (type h() ENTER for help)&#10;iex(1)&#62;</span><br></pre></td></tr></table></figure>
<p>输入<code>h()</code>显示如下帮助</p>
<p><img src="/assets/images/94E0C021-A9FE-44CD-97C5-EA564C66BC78.png" alt="Elixir交互式Shell"></p>
<h1 id="Hell_World">Hell World</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IO.puts &#34;Hello World!</span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/elixir# elixir hello.exs&#10;Hello World!</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-08T18:11:10.000Z"><a href="/2014/10/09/mysql-database-protocol-packet-analysis/">2014-10-09</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/09/mysql-database-protocol-packet-analysis/">MySQL数据库协议包分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>本文的分析角度,是从Erlang语言的emsyql客户端库作为分析案例,通过对emysql库源码的阅读来分析MySQL数据库的协议包结构.并描述了MySQL协议包的结构,如何处理查询结果,如何处理错误信息等协议层内部机制.</p>
<p>首先从最常用的协议包开始:</p>
<h2 id="结果集协议包">结果集协议包</h2><p>顾名思义, 该协议包定义了从MySQL数据库返回的结果集的包格式. 既然是结果集协议包,其中包含我们查询的字段列表.在emysql中定义的字段类型如下:</p>
<figure class="highlight erlang"><figcaption><span>MySQL类型</span><a href="https://github.com/Eonblast/Emysql/blob/master/include/emysql.hrl" target="_blank" rel="external">emysql.hrl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% MYSQL TYPES</span></span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DECIMAL</span>, <span class="number">16#00</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TINY</span>, <span class="number">16#01</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_SHORT</span>, <span class="number">16#02</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONG</span>, <span class="number">16#03</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_FLOAT</span>, <span class="number">16#04</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DOUBLE</span>, <span class="number">16#05</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NULL</span>, <span class="number">16#06</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TIMESTAMP</span>, <span class="number">16#07</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONGLONG</span>, <span class="number">16#08</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_INT24</span>, <span class="number">16#09</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DATE</span>, <span class="number">16#0a</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TIME</span>, <span class="number">16#0b</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_DATETIME</span>, <span class="number">16#0c</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_YEAR</span>, <span class="number">16#0d</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NEWDATE</span>, <span class="number">16#0e</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_VARCHAR</span>, <span class="number">16#0f</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_BIT</span>, <span class="number">16#10</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_NEWDECIMAL</span>, <span class="number">16#f6</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_ENUM</span>, <span class="number">16#f7</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_SET</span>, <span class="number">16#f8</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_TINY_BLOB</span>, <span class="number">16#f9</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_MEDIUM_BLOB</span>, <span class="number">16#fa</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_LONG_BLOB</span>, <span class="number">16#fb</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_BLOB</span>, <span class="number">16#fc</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_VAR_STRING</span>, <span class="number">16#fd</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_STRING</span>, <span class="number">16#fe</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">FIELD_TYPE_GEOMETRY</span>, <span class="number">16#ff</span>)</span></span>.</span><br></pre></td></tr></table></figure>
<p>每一种类型,用一个16进制数字来标记. 以Erlang宏定义的方式声明了不同字段数据类型的值.</p>
<p>TODO::</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-08T03:53:17.000Z"><a href="/2014/10/08/ejabberd-integrate-with-emysql/">2014-10-08</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/08/ejabberd-integrate-with-emysql/">Ejabberd与Emysql集成</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/754522BD-38E0-40B9-9C1D-07E7988BDEC0.png" alt=""><br>开发模块需要使用到MySQL数据库,本文描述如何把<code>Emysql</code>集成到Ejabberd中.</p>
<h2 id="修改Ejabberd">修改Ejabberd</h2><p>编辑<code>$EJABBERD_SRC/rebar.config.script</code></p>
<p>配置<code>Deps</code>,增加<code>Emysql</code>依赖</p>
<figure class="highlight"><figcaption><span>配置rebar.config.script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Deps = [&#10;    ...&#10;    &#123;emysql, &#34;.*&#34;, &#123;git, &#34;git://github.com/Eonblast/Emysql.git&#34;&#125;&#125;&#10;],</span><br></pre></td></tr></table></figure>
<p>如果已经编译过了ejabberd,请删除<code>deps/.built</code>, <code>deps/.got</code>两个文件, 并执行<code>make</code></p>
<figure class="highlight"><figcaption><span>编译输出</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@fd4cc081e295:~/ejabberd# make&#10;...&#10;==&#62; emysql (compile)&#10;Generating &#34;include/crypto_compat.hrl&#34; ...&#10;...supports cryto:hash/2&#10;...writing &#34;include/crypto_compat.hrl&#34;&#10;Compiled src/emysql.erl&#10;Compiled src/emysql_worker.erl&#10;Compiled src/emysql_conn_mgr.erl&#10;Compiled src/emysql_sup.erl&#10;Compiled src/emysql_util.erl&#10;Compiled src/emysql_conn.erl&#10;Compiled src/emysql_app.erl&#10;Compiled src/emysql_statements.erl&#10;Compiled src/emysql_auth.erl&#10;Compiled src/emysql_conv.erl&#10;Compiled src/emysql_tcp.erl&#10;==&#62; p1_mysql (compile)&#10;==&#62; p1_zlib (compile)&#10;==&#62; jiffy (compile)&#10;==&#62; goldrush (compile)&#10;==&#62; lager (compile)&#10;==&#62; p1_iconv (compile)&#10;==&#62; rel (compile)&#10;==&#62; ejabberd (compile)&#10;Compiled src/mod_gbox_messager.erl&#10;Compiled src/mod_online_users.erl&#10;Compiled src/mod_cputime.erl&#10;Compiled src/mod_system_information.erl&#10;/usr/lib/erlang/bin/escript rebar skip_deps=true compile&#10;==&#62; rel (compile)&#10;==&#62; ejabberd (compile)</span><br></pre></td></tr></table></figure>
<h2 id="下载安装samples数据库">下载安装samples数据库</h2><figure class="highlight"><figcaption><span>下载安装samples数据库</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2&#10;tar jxf employees_db-full-1.0.6.tar.bz2&#10;cd employees_db&#10;mysql -t &#60; employees.sql</span><br></pre></td></tr></table></figure>
<h2 id="修改模块">修改模块</h2><figure class="highlight erlang"><figcaption><span>获取CPU时间模块</span><a href="https://gist.github.com/developerworks/77c3954e8622550f6c71" target="_blank" rel="external">mod_cputime.erl</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_cputime)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">    start/<span class="number">2</span>,</span><br><span class="line">    stop/<span class="number">1</span>,</span><br><span class="line">    process_local_iq/<span class="number">3</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">JUD_MATCHES</span>, macro_body)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-define</span><span class="params">(<span class="variable">NS_CPUTIME</span>, &lt;&lt;<span class="string">"ejabberd:cputime"</span>&gt;&gt;)</span></span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">Host</span>, <span class="variable">Opts</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">IQDisc</span> = <span class="function_name">gen_mod:get_opt</span>(</span><br><span class="line">        iqdisc,</span><br><span class="line">        <span class="variable">Opts</span>,</span><br><span class="line">        <span class="keyword">fun</span> gen_iq_handler:check_type/<span class="number">1</span>,</span><br><span class="line">        one_queue</span><br><span class="line">    ),</span><br><span class="line">    <span class="function_name">mod_disco:register_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:add_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>, ?<span class="variable">MODULE</span>, process_local_iq, <span class="variable">IQDisc</span>),</span><br><span class="line">    <span class="function_name">crypto:start</span>(),</span><br><span class="line">    <span class="function_name">application:start</span>(emysql),</span><br><span class="line">    <span class="variable">Server</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, server, <span class="keyword">fun</span>(<span class="variable">Server</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Server</span>) <span class="keyword">end</span>, <span class="string">"localhost"</span>),</span><br><span class="line">    <span class="variable">Port</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, port, <span class="keyword">fun</span>(<span class="variable">Port</span>) -&gt; <span class="variable">Port</span> <span class="keyword">end</span>, <span class="number">3306</span>),</span><br><span class="line">    <span class="variable">Database</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, database, <span class="keyword">fun</span>(<span class="variable">Database</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Database</span>) <span class="keyword">end</span>, <span class="string">"mysql"</span>),</span><br><span class="line">    <span class="variable">User</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, user, <span class="keyword">fun</span>(<span class="variable">User</span>) -&gt; <span class="variable">User</span> <span class="keyword">end</span>, <span class="string">"root"</span>),</span><br><span class="line">    <span class="variable">Password</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, password, <span class="keyword">fun</span>(<span class="variable">Password</span>) -&gt; <span class="function_name">binary_to_list</span>(<span class="variable">Password</span>) <span class="keyword">end</span>, <span class="string">"root"</span>),</span><br><span class="line">    <span class="variable">PoolSize</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, poolsize, <span class="keyword">fun</span>(<span class="variable">PoolSize</span>) -&gt; <span class="variable">PoolSize</span> <span class="keyword">end</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="variable">Encoding</span> = <span class="function_name">gen_mod:get_module_opt</span>(<span class="variable">Host</span>,</span><br><span class="line">        ?<span class="variable">MODULE</span>, encoding, <span class="keyword">fun</span>(<span class="variable">Encoding</span>) -&gt; <span class="function_name">list_to_atom</span>(<span class="function_name">binary_to_list</span>(<span class="variable">Encoding</span>)) <span class="keyword">end</span>, utf8),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Server: ~p~n"</span>, [<span class="variable">Server</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Port: ~p~n"</span>, [<span class="variable">Port</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL DB: ~p~n"</span>, [<span class="variable">Database</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL User: ~p~n"</span>, [<span class="variable">User</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Password: ~p~n"</span>, [<span class="variable">Password</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL PoolSize: ~p~n"</span>, [<span class="variable">PoolSize</span>]),</span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"MySQL Encoding: ~p~n"</span>, [<span class="variable">Encoding</span>]),</span><br><span class="line">    <span class="function_name">emysql:add_pool</span>(pool_employees, [</span><br><span class="line">        <span class="tuple">&#123;size, <span class="variable">PoolSize</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;user, <span class="variable">User</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;password, <span class="variable">Password</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;host, <span class="variable">Server</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;port, <span class="variable">Port</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;database, <span class="variable">Database</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;encoding, <span class="variable">Encoding</span>&#125;</span></span><br><span class="line">    ]),</span><br><span class="line">    <span class="tuple">&#123;<span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">Result</span>, <span class="variable">_</span>&#125;</span> = <span class="function_name">emysql:execute</span>(pool_employees, &lt;&lt;<span class="string">"SELECT * FROM employees LIMIT 10"</span>&gt;&gt;),</span><br><span class="line"><span class="comment">%%     [</span></span><br><span class="line"><span class="comment">%%         [10001,&#123;date,&#123;1953,9,2&#125;&#125;,&lt;&lt;"Georgi"&gt;&gt;,&lt;&lt;"Facello"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,6,26&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10002,&#123;date,&#123;1964,6,2&#125;&#125;,&lt;&lt;"Bezalel"&gt;&gt;,&lt;&lt;"Simmel"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1985,11,21&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10003,&#123;date,&#123;1959,12,3&#125;&#125;,&lt;&lt;"Parto"&gt;&gt;,&lt;&lt;"Bamford"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,8,28&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10004,&#123;date,&#123;1954,5,1&#125;&#125;,&lt;&lt;"Chirstian"&gt;&gt;,&lt;&lt;"Koblick"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1986,12,1&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10005,&#123;date,&#123;1955,1,21&#125;&#125;,&lt;&lt;"Kyoichi"&gt;&gt;,&lt;&lt;"Maliniak"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1989,9,12&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10006,&#123;date,&#123;1953,4,20&#125;&#125;,&lt;&lt;"Anneke"&gt;&gt;,&lt;&lt;"Preusig"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,6,2&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10007,&#123;date,&#123;1957,5,23&#125;&#125;,&lt;&lt;"Tzvetan"&gt;&gt;,&lt;&lt;"Zielinski"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,2,10&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10008,&#123;date,&#123;1958,2,19&#125;&#125;,&lt;&lt;"Saniya"&gt;&gt;,&lt;&lt;"Kalloufi"&gt;&gt;,&lt;&lt;"M"&gt;&gt;,&#123;date,&#123;1994,9,15&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10009,&#123;date,&#123;1952,4,19&#125;&#125;,&lt;&lt;"Sumant"&gt;&gt;,&lt;&lt;"Peac"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1985,2,18&#125;&#125;],</span></span><br><span class="line"><span class="comment">%%         [10010,&#123;date,&#123;1963,6,1&#125;&#125;,&lt;&lt;"Duangkaew"&gt;&gt;,&lt;&lt;"Piveteau"&gt;&gt;,&lt;&lt;"F"&gt;&gt;,&#123;date,&#123;1989,8,24&#125;&#125;]</span></span><br><span class="line"><span class="comment">%%     ].</span></span><br><span class="line">    ?<span class="variable">DEBUG</span>(<span class="string">"============================~n~p~n"</span>, [<span class="variable">Result</span>]),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">stop</span>(<span class="variable">Host</span>) -&gt;</span><br><span class="line">    <span class="function_name">mod_disco:unregister_feature</span>(<span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    <span class="function_name">gen_iq_handler:remove_iq_handler</span>(ejabberd_local, <span class="variable">Host</span>, ?<span class="variable">NS_CPUTIME</span>),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function_name">process_local_iq</span>(<span class="variable">_From</span>, <span class="variable">_To</span>, <span class="record_name">#iq</span>&#123;type = <span class="variable">Type</span>, sub_el = <span class="variable">SubEl</span>&#125; = <span class="variable">IQ</span>) -&gt;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">Type</span> <span class="keyword">of</span></span><br><span class="line">        set -&gt;</span><br><span class="line">            <span class="variable">IQ</span><span class="record_name">#iq</span>&#123;type = error, sub_el = [<span class="variable">SubEl</span>, ?<span class="variable">ERR_NOT_ALLOWED</span>]&#125;;</span><br><span class="line">        get -&gt;</span><br><span class="line">            <span class="variable">CPUTime</span> = <span class="function_name">element</span>(<span class="number">1</span>, <span class="function_name">erlang:statistics</span>(runtime)) / <span class="number">1000</span>,</span><br><span class="line">            <span class="variable">SCPUTime</span> = <span class="function_name">lists:flatten</span>(<span class="function_name">io_lib:format</span>(<span class="string">"~.3f"</span>, [<span class="variable">CPUTime</span>])),</span><br><span class="line">            <span class="variable">Packet</span> = <span class="variable">IQ</span><span class="record_name">#iq</span>&#123;type = result, sub_el = [</span><br><span class="line">                <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"query"</span>&gt;&gt;, attrs = [<span class="tuple">&#123;&lt;&lt;<span class="string">"xmlns"</span>&gt;&gt;, ?<span class="variable">NS_CPUTIME</span>&#125;</span>], children = [</span><br><span class="line">                    <span class="record_name">#xmlel</span>&#123;name = &lt;&lt;<span class="string">"time"</span>&gt;&gt;, attrs = [], children = [<span class="tuple">&#123;xmlcdata, <span class="function_name">list_to_binary</span>(<span class="variable">SCPUTime</span>)&#125;</span>]&#125;]&#125;</span><br><span class="line">            ]&#125;,</span><br><span class="line">            <span class="variable">Packet</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>查询结果日志输出</p>
<p><img src="/assets/images/0D78C5EA-8892-437F-B6FE-1F3E19404AE6.png" alt="查询结果日志输出"></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://dev.mysql.com/doc/employee/en/employees-installation.html" target="_blank" rel="external">http://dev.mysql.com/doc/employee/en/employees-installation.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-06T11:20:27.000Z"><a href="/2014/10/06/ejabberd-code-analysis-translate-auxiliary-tool/">2014-10-06</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/06/ejabberd-code-analysis-translate-auxiliary-tool/">Ejabberd代码分析之-翻译辅助工具</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd支持国际化,在<code>&lt;iq/&gt;</code>,<code>&lt;message/&gt;</code>,<code>&lt;presence/&gt;</code>等元素上添加<code>xml:lang</code>属性,对应的英文文本会切换到指定的语言.</p>
<p>举个例子,模块<code>mod_announce.erl</code>代码内有如下对<code>translate:translate()</code>的使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_title(Lang, &#60;&#60;&#34;announce&#34;&#62;&#62;) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Announcements&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_ANNOUNCE_ALL) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Send announcement to all users&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_ANNOUNCE_ALL_ALLHOSTS) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Send announcement to all users on all hosts&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_ANNOUNCE) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Send announcement to all online users&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_ANNOUNCE_ALLHOSTS) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Send announcement to all online users on all hosts&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_SET_MOTD) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Set message of the day and send to online users&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_SET_MOTD_ALLHOSTS) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Set message of the day on all hosts and send to online users&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_EDIT_MOTD) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Update message of the day (don&#39;t send)&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_EDIT_MOTD_ALLHOSTS) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Update message of the day on all hosts (don&#39;t send)&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_DELETE_MOTD) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Delete message of the day&#34;&#62;&#62;);&#10;get_title(Lang, ?NS_ADMIN_DELETE_MOTD_ALLHOSTS) -&#62;&#10;    translate:translate(Lang, &#60;&#60;&#34;Delete message of the day on all hosts&#34;&#62;&#62;).</span><br></pre></td></tr></table></figure>
<p><code>translate:translate()</code>定义在<code>translate.erl</code>模块中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-spec translate(binary(), binary()) -&#62; binary().&#10;translate(Lang, Msg) -&#62;&#10;    LLang = ascii_tolower(Lang),&#10;    case ets:lookup(translations, &#123;LLang, Msg&#125;) of&#10;      [&#123;_, Trans&#125;] -&#62; Trans;&#10;      _ -&#62;&#10;&#9;  ShortLang = case str:tokens(LLang, &#60;&#60;&#34;-&#34;&#62;&#62;) of&#10;&#9;&#9;&#9;[] -&#62; LLang;&#10;&#9;&#9;&#9;[SL | _] -&#62; SL&#10;&#9;&#9;      end,&#10;&#9;  case ShortLang of&#10;&#9;    &#60;&#60;&#34;en&#34;&#62;&#62; -&#62; Msg;&#10;&#9;    LLang -&#62; translate(Msg);&#10;&#9;    _ -&#62;&#10;&#9;&#9;case ets:lookup(translations, &#123;ShortLang, Msg&#125;) of&#10;&#9;&#9;  [&#123;_, Trans&#125;] -&#62; Trans;&#10;&#9;&#9;  _ -&#62; translate(Msg)&#10;&#9;&#9;end&#10;&#9;  end&#10;    end.</span><br></pre></td></tr></table></figure>
<p>当你在XML节上定义了<code>xml:lang=&#39;zh&#39;</code>属性后,服务端的应答文本就变为中文了, 如下:</p>
<p><img src="/assets/images/D373E553-9009-48E3-A9C3-5FD33D7C7080.png" alt="Erlang国际化文本-服务节点列表"></p>
<h2 id="增加自定义字符串">增加自定义字符串</h2><p>搞清楚了原理后,我就可以为我的模块添加字符串了.</p>
<p>首先我在我的模块中使用英文作为默认的文本描述, 如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#xmlel&#123;&#10;    name = &#60;&#60;&#34;item&#34;&#62;&#62;,&#10;    attrs = [&#10;        &#123;&#60;&#60;&#34;jid&#34;&#62;&#62;, Server&#125;,&#10;        &#123;&#60;&#60;&#34;node&#34;&#62;&#62;, &#60;&#60;&#34;http://www.example.com/protocol/messager#upgrade-full&#34;&#62;&#62;&#125;,&#10;        &#123;&#60;&#60;&#34;name&#34;&#62;&#62;, translate:translate(Lang, &#60;&#60;&#34;Make a complete upgrade&#34;&#62;&#62;)&#125;&#10;    ],&#10;    children = []&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>然后根据<code>$EJABBERD_SRC/contrib/extract_translations/README</code>的描述,<br>需要编译<code>$EJABBERD_SRC/contrib/extract_translations/extract_translations.erl</code>模块.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlc $EJABBERD_SRC/contrib/extract_translations/extract_translations.erl</span><br></pre></td></tr></table></figure>
<p>Ejabberd提供了一个SHELL脚本来从<code>*.po</code>文件生成Ejabberd需要的<code>*.msg</code>文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@4850618fe551:~/ejabberd/contrib/extract_translations# ./prepare-translation.sh -h&#10;Options:&#10;  -langall&#10;  -lang LANGUAGE_FILE&#10;  -srcmsg2po LANGUAGE   Construct .msg file using source code to PO file&#10;  -src2pot              Generate template POT file from source code&#10;  -popot2po LANGUAGE    Update PO file with template POT file&#10;  -po2msg LANGUAGE      Export PO file to MSG file&#10;  -updateall            Generate POT and update all PO&#10;Example:&#10;  ./prepare-translation.sh -lang es.msg</span><br></pre></td></tr></table></figure>
<p>首先切换到源码根目录, 执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@4850618fe551:~/ejabberd# ./contrib/extract_translations/prepare-translation.sh -src2pot&#10;./contrib/extract_translations/prepare-translation.sh: line 183: msguniq: command not found</span><br></pre></td></tr></table></figure>
<p>找不到<code>msguniq</code>命令,在Ubuntu上,<code>msguniq</code>在<code>gettext</code>包种, 下面安装需要的软件包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aptitude install -y gettext</span><br></pre></td></tr></table></figure>
<p>执行下面的命令, 更新<code>ejabberd.pot</code>文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@4850618fe551:~/ejabberd# ./contrib/extract_translations/prepare-translation.sh -src2pot</span><br></pre></td></tr></table></figure>
<p>打开<code>$EJABBERD_SRC/priv/msgs/ejabberd.pot</code>, 翻译相关条目后, 复制粘贴到到<code>$EJABBERD_SRC/priv/msgs/zh.po</code>中,</p>
<p><img src="/assets/images/4BD11A32-C9E4-4348-AD5A-60061B8998A5.png" alt="$EJABBERD_SRC/priv/msgs/ejabberd.pot"></p>
<p>并执行下面的命令,更新我的<code>zh.msg</code>文件, 这个文件是在Erlang代码中直接使用的文件. 后面会看到最终的效果.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./contrib/extract_translations/prepare-translation.sh -po2msg zh</span><br></pre></td></tr></table></figure>
<p>更新后的消息文件在<code>$EJABBERD_SRC/priv/msgs/zh.msg</code></p>
<p><img src="/assets/images/95BD1DE1-C5C4-47AB-BB6E-B94A3ADF2811.png" alt="$EJABBERD_SRC/priv/msgs/zh.msg"></p>
<p>生成了我最终要的<code>zh.msg</code>文件后,重新编译一次ejabberd(之前已经编译过,这一步很快)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@4850618fe551:~/ejabberd# make&#10;/usr/lib/erlang/bin/escript rebar skip_deps=true compile&#10;==&#62; rel (compile)&#10;==&#62; ejabberd (compile)&#10;Compiled src/mod_online_users.erl&#10;Compiled src/mod_gbox_messager.erl&#10;Compiled src/mod_cputime.erl&#10;Compiled src/mod_system_information.erl</span><br></pre></td></tr></table></figure>
<p>复制编译的新文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ebin/*.beam /lib/ejabberd/ebin&#10;cp priv/*.msg /lib/ejabberd/priv/msgs</span><br></pre></td></tr></table></figure>
<p>最后重启,并测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ejabberdctl restart</span><br></pre></td></tr></table></figure>
<p>查询命令列表(注意属性<code>xml:lang=&#39;zh&#39;</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;get&#39; to=&#39;xmpp.myserver.info&#39; from=&#39;root@xmpp.myserver.info&#39; xml:lang=&#39;zh&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;query xmlns=&#39;http://jabber.org/protocol/disco#items&#39; node=&#39;http://jabber.org/protocol/commands&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>国际化后的结果</p>
<p><img src="/assets/images/1BD77F60-BE7B-48CF-B1BE-1933F3D9D839.png" alt="自定义Ad-Hoc Commands"></p>
<h2 id="参考资料">参考资料</h2><ol>
<li>$EJABBERD_SRC/src/mod_announce.erl</li>
<li>$EJABBERD_SRC/contrib/extract_translations/README</li>
<li>$EJABBERD_SRC/src/translate.erl</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-04T16:52:52.000Z"><a href="/2014/10/05/xmpp-xep-iot-relate/">2014-10-05</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/05/xmpp-xep-iot-relate/">XMPP 物联网相关协议扩展</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="XMPP/IoT相关协议">XMPP/IoT相关协议</h2><ul>
<li><p>高效数据互换格式<br><a href="http://xmpp.org/extensions/xep-0322.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0322.html</a> XEP-0322: Efficient XML Interchange (EXI) Format</p>
</li>
<li><p>物联网 - 传感器数据<br><a href="http://xmpp.org/extensions/xep-0323.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0323.html</a> XEP-0323: Internet of Things - Sensor Data<br>通过XMPP网络交换传感器数据,</p>
</li>
<li><p>物联网 - <code>Provisioning</code><br><a href="http://xmpp.org/extensions/xep-0324.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0324.html</a> XEP-0324: Internet of Things - Provisioning</p>
</li>
<li><p>物联网 - 控制<br><a href="http://xmpp.org/extensions/xep-0325.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0325.html</a> XEP-0325: Internet of Things - Control</p>
</li>
<li><p>物联网 - 集中器<br><a href="http://xmpp.org/extensions/xep-0326.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0326.html</a> XEP-0326: Internet of Things - Concentrator</p>
</li>
<li><p>物联网 - 发现<br><a href="http://xmpp.org/extensions/xep-0347.html" target="_blank" rel="external">http://xmpp.org/extensions/xep-0347.html</a> XEP-0347: Internet of Things - Discovery</p>
</li>
</ul>
<p>服务开通(英语：<code>Provisioning</code>)是一个电信行业的技术词汇,它是指准备和配备(preparing and equipping)一个网络,以允许其向它的用户提供(新)业务的处理过程.在(美国)国家安全/紧急准备电子通信(NS/EP telecommunications)业务中,服务开通等同于<code>开始</code>(initiation),并且包括改变一个已存在的优先服务或功能的状态.<br>英语<code>Provisioning</code>,的原意是<code>供应</code>,<code>预备</code>,电信行业中一般将其翻译成中文<code>服务开通</code>.也有文档称其为<code>开通</code>,<code>服务提供</code>,<code>服务供应</code>等.</p>
<ul>
<li>0322: EXI</li>
<li>0323: Sensor Data</li>
<li>0324: Provisioning</li>
<li>0325: Control</li>
<li>0326: Concentrators</li>
<li>0331: Color fields</li>
<li>0332: HTTP over XMpp</li>
<li>0336: Dynamic Forms</li>
<li>0347: Discovery</li>
<li>?: Interoperability</li>
<li>?: Events</li>
<li>?: Pubsub</li>
<li>?: Multicast</li>
<li>?: Chat</li>
<li>?: Battery powered devices</li>
</ul>
<h2 id="OneM2M联盟规范文档">OneM2M联盟规范文档</h2><p><code>oneM2M</code>是7个国家的电信联盟组成的合作机构,定制物联网机器到机器(M2M)应用层通信标准.</p>
<ul>
<li>无线通讯解决方案联盟(ATIS)</li>
<li>中国通讯标准化协会(CCSA)</li>
<li>欧洲电信标准协会(ETSI)</li>
<li>韩国电信技术协会(TTA)</li>
<li>日本电信技术委员会(TTC)</li>
<li>美国电信工业协会(TIA)</li>
<li>及日本电波产业协会(ARIB)</li>
</ul>
<p><a href="http://www.onem2m.org/candidate_release/index.cfm" target="_blank" rel="external">http://www.onem2m.org/candidate_release/index.cfm</a></p>
<p><code>M2M在线</code><br><a href="http://m2m.iot-online.com/" target="_blank" rel="external">http://m2m.iot-online.com/</a></p>
<p>功能架构<br>TS-0001-oneM2M-Functional-Architecture-V-2014-08<br>需求<br>TS-0002-Requirements-V-2014-08<br>安全方案<br>TS-0003-Security_Solutions-V-2014-08<br>核心协议<br>TS-0004-CoreProtocol-V-2014-08<br>管理(OMA)<br>TS-0005-Management_Enablement (OMA)-V-2014-08<br>管理(BBF)<br>TS-0006-Management<em>Enablement</em>(BBF)-V-2014-08<br>CoAP协议绑定<br>TS-0008-CoAP_Protocol_Binding-V-2014-08<br>HTTP协议绑定<br>TS-0009-HTTP_Protocol_Binding_V-2014-08<br>定义和缩写词<br>TS-0011-Definitions and Acronyms-V-2014-08</p>
<h2 id="资料">资料</h2><ol>
<li><p>XMPP Service Discovery extensions for M2M and IoT<br><a href="http://servicelab.org/2013/02/21/xmpp-service-discovery-extensions-for-m2m-and-iot/" target="_blank" rel="external">http://servicelab.org/2013/02/21/xmpp-service-discovery-extensions-for-m2m-and-iot/</a></p>
</li>
<li><p>oneM2M 候选规范<br><a href="http://www.onem2m.org/candidate_release/index.cfm" target="_blank" rel="external">http://www.onem2m.org/candidate_release/index.cfm</a></p>
</li>
<li><p><a href="http://m2m.iot-online.com/news/2013102224849.html" target="_blank" rel="external">http://m2m.iot-online.com/news/2013102224849.html</a></p>
</li>
</ol>
<!--
字段类型
    字段表示的值类型. 比如: 瞬时值(Momentary), 状态值(Status), 标识值(Identification), 计算值(Calculated), 峰值(Peak), 历史值(Historical),等.
Historical Value
    A value stored in memory from a previous timestamp.
Identification Value
    A value that can be used for identification. (Serial numbers, meter IDs, locations, names, etc.)
    Localization information
    Optional information for a field, allowing the sensor to control how the information should be presented to human viewers.
Meter
    A device possible containing multiple sensors, used in metering applications. Examples: Electricity meter, Water Meter, Heat Meter, Cooling Meter, etc.
Momentary Value
    A momentary value represents a value measured at the time of the read-out.
Node
    Graphs contain nodes and edges between nodes. In Internet of Things, sensors, actuators, meters, devices, gateways, etc., are often depicted as nodes whereas links between sensors (friendships) are depicted as edges. In abstract terms, it's easier to talk about a Node, rather than list different possible node types (sensors, actuators, meters, devices, gateways, etc.). Each Node has a Node ID.
Node ID
    An ID uniquely identifying a node within its corresponding context. If a globally unique ID is desired, an architecture should be used using a universally accepted ID scheme.
Parameter
    Readable and/or writable property on a node/device. The XEP-0326 Internet of Things - Concentrators (XEP-0326) [6] deals with reading and writing parameters on nodes/devices. Fields are not parameters, and parameters are not fields.
Peak Value
    A maximum or minimum value during a given period.
Precision
    In physics, precision determines the number of digits of precision. In sensor networks however, this definition is not easily applicable. Instead, precision determines, for example, the number of decimals of precision, or power of precision. Example: 123.200 MWh contains 3 decimals of precision. All entities parsing and delivering field information in sensor networks should always retain the number of decimals in a message.
Sensor
    Device measuring at least one digital value (0 or 1) or analog value (value with precision and physical unit). Examples: Temperature sensor, pressure sensor, etc. Sensor values are reported as fields during read-out. Each sensor has a unique Node ID.
SN
    Sensor Network. A network consisting, but not limited to sensors, where transport and use of sensor data is of primary concern. A sensor network may contain actuators, network applications, monitors, services, etc.
Status Value
    A value displaying status information about something.
Timestamp
    Timestamp of value, when the value was sampled or recorded.
Token
    A client, device or user can get a token from a provisioning server. These tokens can be included in requests to other entities in the network, so these entities can validate access rights with the provisioning server.
Unit
    Physical unit of value. Example: MWh, l/s, etc.
Value
    A field value.
Value Status
    Status of field value. Contains important status information for Quality of Service purposes. Examples: Ok, Error, Warning, Time Shifted, Missing, Signed, etc.
Value Type
    Can be numeric, string, boolean, Date & Time, Time Span or Enumeration.
WSN
    Wireless Sensor Network, a sensor network including wireless devices.
XMPP Client
    Application connected to an XMPP network, having a JID. Note that sensors, as well as applications requesting sensor data can be XMPP clients.
-->
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-04T10:25:55.000Z"><a href="/2014/10/04/erlang-universal-binary-format/">2014-10-04</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/04/erlang-universal-binary-format/">Erlang通用二进制格式</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><code>UBF</code>是一个让Erlang和外部世界交互的一个框架. 文档和相应的开源库基于<code>Joe Armstrong</code>最初的<code>UBF</code>站点和代码,增加了MIT许可文件,增加了大量的增强和改进.</p>
<p><code>UBF</code>是一个跨网络转换和描述复杂数据结构的语言. 它包括三个部分:</p>
<ul>
<li>UBF(a) 是一个<code>语言中性的</code>数据描述格式, 粗略地等同于具有良好格式的XML.</li>
<li>UBF(b) 是一个描述性的编程语言, 它用于描述<code>UBF(a)</code>中的类型, 以及客户端和服务器之间的协议.</li>
<li>UBF(c) 是一个在UBF客户端和UBF服务器之间使用的低级协议(meta-level).</li>
</ul>
<p><code>UBF</code>设计用于生产级别的部署和要求<code>24x7x365</code>可靠性的电信级系统.</p>
<h2 id="什么是语言中性?">什么是语言中性?</h2><p>这是相对于<code>语言独立的</code>二进制格式而言, 它的实现是与特定的语言相关的, 支持的格式定义语言如下:</p>
<ul>
<li>thrift</li>
<li>redis</li>
<li>jsonrpc</li>
<li>eep8</li>
<li>bertrpc</li>
<li>abnf</li>
</ul>
<p>可以在<a href="https://github.com/ubf/ubf" target="_blank" rel="external">项目首页</a>看到多种格式的实现.</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Erlang Universal Binary Format? Anyone using it?<br><a href="http://stackoverflow.com/questions/4731449/erlang-universal-binary-format-anyone-using-it" target="_blank" rel="external">http://stackoverflow.com/questions/4731449/erlang-universal-binary-format-anyone-using-it</a></li>
<li>项目地址<br><a href="https://github.com/ubf/ubf" target="_blank" rel="external">https://github.com/ubf/ubf</a></li>
<li>UBF用户指南<br><a href="http://ubf.github.io/ubf/ubf-user-guide.en.html" target="_blank" rel="external">http://ubf.github.io/ubf/ubf-user-guide.en.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/4/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/6/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/09/17/ejabberd-with-elixir-mix/">用Elixir Mix构建Ejabberd发行包</a>
      </li>
    
      <li>
        <a href="/2015/06/05/uftp/">UFTP - 基于UDP的加密文件多播传输协议</a>
      </li>
    
      <li>
        <a href="/2015/06/04/html5-web-cryptography-api-hashing/">Web加密API - 散列(Hashing)</a>
      </li>
    
      <li>
        <a href="/2015/06/04/the-3-modes-of-http-protocol/">HTTP协议的三种模式</a>
      </li>
    
      <li>
        <a href="/2015/05/21/ejabberd-with-elixir-packet-filters/">Ejabberd 用Elixir开发一个包过滤模块</a>
      </li>
    
      <li>
        <a href="/2015/05/18/chrome-dev-get-started/">Chrome 开发入门</a>
      </li>
    
      <li>
        <a href="/2015/05/18/html5-web-cryptography-api-tutorial/">Web加密API指南</a>
      </li>
    
      <li>
        <a href="/2015/05/17/html5-battery-status/">HTML5获取电池状态</a>
      </li>
    
      <li>
        <a href="/2015/05/10/ejabberd-mam-module-how-to-use/">如何使用Ejabberd消息归档模块</a>
      </li>
    
      <li>
        <a href="/2015/05/07/xmpp-xep-0279-server-ip-check/">服务器IP检查</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Chrome/">Chrome</a><small>1</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>36</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTML5/">HTML5</a><small>3</small></li>
  
    <li><a href="/categories/HTTP/">HTTP</a><small>1</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>4</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Thrift/">Thrift</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>7</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/API/" style="font-size: 11.11px;">API</a> <a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a> <a href="/tags/Battery-Status/" style="font-size: 10px;">Battery Status</a> <a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a> <a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a> <a href="/tags/CURL/" style="font-size: 10px;">CURL</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a> <a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a> <a href="/tags/ETS/" style="font-size: 10px;">ETS</a> <a href="/tags/Ecto/" style="font-size: 11.11px;">Ecto</a> <a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a> <a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a> <a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a> <a href="/tags/H2O/" style="font-size: 10px;">H2O</a> <a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a> <a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a> <a href="/tags/Howto/" style="font-size: 10px;">Howto</a> <a href="/tags/Http-modes/" style="font-size: 10px;">Http modes</a> <a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a> <a href="/tags/I18n/" style="font-size: 10px;">I18n</a> <a href="/tags/IAB/" style="font-size: 10px;">IAB</a> <a href="/tags/ID3/" style="font-size: 10px;">ID3</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/IOT/" style="font-size: 10px;">IOT</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/Loopback/" style="font-size: 12.22px;">Loopback</a> <a href="/tags/MUC/" style="font-size: 10px;">MUC</a> <a href="/tags/Macro/" style="font-size: 12.22px;">Macro</a> <a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a> <a href="/tags/Mix/" style="font-size: 14.44px;">Mix</a> <a href="/tags/Modules/" style="font-size: 10px;">Modules</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a> <a href="/tags/OTP/" style="font-size: 12.22px;">OTP</a> <a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/PM2/" style="font-size: 10px;">PM2</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Phoenix/" style="font-size: 12.22px;">Phoenix</a> <a href="/tags/Pool/" style="font-size: 10px;">Pool</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/RESTFUL/" style="font-size: 11.11px;">RESTFUL</a> <a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a> <a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a> <a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a> <a href="/tags/Regex/" style="font-size: 10px;">Regex</a> <a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a> <a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a> <a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a> <a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a> <a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a> <a href="/tags/Task/" style="font-size: 10px;">Task</a> <a href="/tags/Thrift/" style="font-size: 11.11px;">Thrift</a> <a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a> <a href="/tags/UBF/" style="font-size: 10px;">UBF</a> <a href="/tags/UFTP/" style="font-size: 10px;">UFTP</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a> <a href="/tags/VAST/" style="font-size: 10px;">VAST</a> <a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a> <a href="/tags/Web-Cryptography-API/" style="font-size: 11.11px;">Web Cryptography API</a> <a href="/tags/XEP/" style="font-size: 16.67px;">XEP</a> <a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XMPP/" style="font-size: 17.78px;">XMPP</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/angular/" style="font-size: 16.67px;">angular</a> <a href="/tags/application/" style="font-size: 10px;">application</a> <a href="/tags/blockies/" style="font-size: 10px;">blockies</a> <a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a> <a href="/tags/bosh/" style="font-size: 12.22px;">bosh</a> <a href="/tags/ci/" style="font-size: 10px;">ci</a> <a href="/tags/container/" style="font-size: 11.11px;">container</a> <a href="/tags/data-management/" style="font-size: 10px;">data management</a> <a href="/tags/data-volume/" style="font-size: 10px;">data volume</a> <a href="/tags/debugging/" style="font-size: 10px;">debugging</a> <a href="/tags/devtools/" style="font-size: 10px;">devtools</a> <a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a> <a href="/tags/doc/" style="font-size: 10px;">doc</a> <a href="/tags/docker/" style="font-size: 15.56px;">docker</a> <a href="/tags/ejabberd/" style="font-size: 18.89px;">ejabberd</a> <a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a> <a href="/tags/emysql/" style="font-size: 11.11px;">emysql</a> <a href="/tags/encoding/" style="font-size: 10px;">encoding</a> <a href="/tags/erlang/" style="font-size: 12.22px;">erlang</a> <a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a> <a href="/tags/faq/" style="font-size: 10px;">faq</a> <a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a> <a href="/tags/gerrit/" style="font-size: 11.11px;">gerrit</a> <a href="/tags/gettext/" style="font-size: 10px;">gettext</a> <a href="/tags/git/" style="font-size: 12.22px;">git</a> <a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hero/" style="font-size: 10px;">hero</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/html5/" style="font-size: 10px;">html5</a> <a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a> <a href="/tags/iq/" style="font-size: 10px;">iq</a> <a href="/tags/jabber/" style="font-size: 10px;">jabber</a> <a href="/tags/javascript/" style="font-size: 11.11px;">javascript</a> <a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a> <a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a> <a href="/tags/library/" style="font-size: 10px;">library</a> <a href="/tags/linking/" style="font-size: 10px;">linking</a> <a href="/tags/lists/" style="font-size: 10px;">lists</a> <a href="/tags/load-balance/" style="font-size: 10px;">load balance</a> <a href="/tags/log4er/" style="font-size: 10px;">log4er</a> <a href="/tags/manage-images/" style="font-size: 10px;">manage images</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/muc/" style="font-size: 10px;">muc</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a> <a href="/tags/node-webkit/" style="font-size: 13.33px;">node-webkit</a> <a href="/tags/node-js/" style="font-size: 12.22px;">node.js</a> <a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a> <a href="/tags/notification/" style="font-size: 10px;">notification</a> <a href="/tags/npm/" style="font-size: 11.11px;">npm</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a> <a href="/tags/polymer/" style="font-size: 10px;">polymer</a> <a href="/tags/port/" style="font-size: 10px;">port</a> <a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a> <a href="/tags/rebar/" style="font-size: 10px;">rebar</a> <a href="/tags/record/" style="font-size: 10px;">record</a> <a href="/tags/recursion/" style="font-size: 10px;">recursion</a> <a href="/tags/regexp/" style="font-size: 10px;">regexp</a> <a href="/tags/relx/" style="font-size: 10px;">relx</a> <a href="/tags/screen/" style="font-size: 10px;">screen</a> <a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/stanza/" style="font-size: 10px;">stanza</a> <a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a> <a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a> <a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a> <a href="/tags/swagger/" style="font-size: 12.22px;">swagger</a> <a href="/tags/testing/" style="font-size: 10px;">testing</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/tsung/" style="font-size: 10px;">tsung</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a> <a href="/tags/varnish/" style="font-size: 10px;">varnish</a> <a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a> <a href="/tags/vt/" style="font-size: 10px;">vt</a> <a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a> <a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a> <a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a> <a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




