
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 6 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-03T10:12:35.000Z"><a href="/2014/10/03/strophejs-plugins-register/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/strophejs-plugins-register/">XMPP Strophe.js插件 - 带内注册</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="客户端服务器交互">客户端服务器交互</h2><p>下图,是注册过程客户端和服务器的交互过程, 绿色的输出是客户端请求的XML节, 蓝色的输出是服务器应答的XML节.</p>
<p><img src="/assets/images/D6DC8BC6-6F30-49CA-B898-F47E9AD83A43.png" alt="XMPP Stanzas"></p>
<h2 id="下载插件">下载插件</h2><p><a href="https://github.com/strophe/strophejs-plugins/tree/master/register" target="_blank" rel="external">https://github.com/strophe/strophejs-plugins/tree/master/register</a></p>
<h2 id="HTML页面代码">HTML页面代码</h2><p>创建两个表单元素<code>username</code>和<code>password</code>用于获取用户名和密码, 一个<code>Register</code>按钮触发注册操作.<br>本文所演示示例的完整代码在此: <a href="https://gist.github.com/developerworks/317ccf6eb2d3060610f8" target="_blank" rel="external">https://gist.github.com/developerworks/317ccf6eb2d3060610f8</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!doctype html&#62;&#10;&#60;html lang=&#34;en&#34;&#62;&#10;&#60;head&#62;&#10;  &#60;meta charset=&#34;UTF-8&#34;&#62;&#10;  &#60;title&#62;Register a user&#60;/title&#62;&#10;  &#60;!--// JQuery&#24211;--&#62;&#10;  &#60;script type=&#34;text/javascript&#34; src=&#34;jquery.min.js&#34;&#62;&#60;/script&#62;&#10;  &#60;!--// Strophe.js&#24211;--&#62;&#10;  &#60;script type=&#34;text/javascript&#34; src=&#34;strophe.js&#34;&#62;&#60;/script&#62;&#10;  &#60;!--// Strophe.js &#27880;&#20876;&#25554;&#20214;--&#62;&#10;  &#60;script type=&#34;text/javascript&#34; src=&#34;strophe.register.js&#34;&#62;&#60;/script&#62;&#10;  &#60;!--// &#27880;&#20876;&#19994;&#21153;&#36923;&#36753;--&#62;&#10;  &#60;script type=&#34;text/javascript&#34; src=&#34;register.js&#34;&#62;&#60;/script&#62;&#10;&#60;/head&#62;&#10;&#60;body&#62;&#10;  Username:&#60;input type=&#34;text&#34; id=&#34;username&#34; placeholder=&#34;Please input username&#34;/&#62;&#10;  Password&#60;input type=&#34;text&#34; id=&#34;password&#34; placeholder=&#34;Please input your password&#34;/&#62;&#10;  &#60;br/&#62;&#10;  &#60;button id=&#34;register&#34;&#62;Register&#60;/button&#62;&#10;&#60;/form&#62;&#10;&#60;/body&#62;&#10;&#60;/html&#62;</span><br></pre></td></tr></table></figure></p>
<h2 id="回调函数">回调函数</h2><p><strong>register.js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#35843;&#35797;&#29992;,XML&#26684;&#24335;&#21270;&#20989;&#25968;&#10;function formatXml(xml) &#123;&#10;  var formatted = &#39;&#39;;&#10;  var reg = /(&#62;)(&#60;)(\/*)/g;&#10;  xml = xml.replace(reg, &#39;$1\r\n$2$3&#39;);&#10;  var pad = 0;&#10;  jQuery.each(xml.split(&#39;\r\n&#39;), function (index, node) &#123;&#10;    var indent = 0;&#10;    if (node.match(/.+&#60;\/\w[^&#62;]*&#62;$/)) &#123;&#10;      indent = 0;&#10;    &#125; else if (node.match(/^&#60;\/\w/)) &#123;&#10;      if (pad != 0) &#123;&#10;        pad -= 1;&#10;      &#125;&#10;    &#125; else if (node.match(/^&#60;\w[^&#62;]*[^\/]&#62;.*$/)) &#123;&#10;      indent = 1;&#10;    &#125; else &#123;&#10;      indent = 0;&#10;    &#125;&#10;    var padding = &#39;&#39;;&#10;    for (var i = 0; i &#60; pad; i++) &#123;&#10;      padding += &#39;  &#39;;&#10;    &#125;&#10;    formatted += padding + node + &#39;\r\n&#39;;&#10;    pad += indent;&#10;  &#125;);&#10;  return formatted;&#10;&#125;&#10;// Websocket&#31471;&#28857;&#10;var BOSH_SERVICE = &#39;ws://xmpp.myserver.info:5288&#39;;&#10;// &#22495;&#21517;&#10;var DOMAIN_NAME = &#39;xmpp.myserver.info&#39;;&#10;// XMPP&#36830;&#25509;&#23545;&#35937;&#10;var connection = null;&#10;// &#27983;&#35272;&#22120;&#25511;&#21046;&#21488;&#26085;&#24535;&#10;function log(msg, sent) &#123;&#10;  if (sent) &#123;&#10;    console.log(&#34;%c\n&#34; + msg, &#34;color:green;&#34;);&#10;  &#125; else &#123;&#10;    console.log(&#34;%c\n&#34; + msg, &#34;color:blue;&#34;);&#10;  &#125;&#10;&#125;&#10;function rawInput(data) &#123;&#10;  log(formatXml(data), false);&#10;&#125;&#10;function rawOutput(data) &#123;&#10;  log(formatXml(data), true);&#10;&#125;&#10;$(document).ready(function () &#123;&#10;  $(&#39;#register&#39;).bind(&#39;click&#39;, function () &#123;&#10;    // &#21019;&#24314;&#36830;&#25509;&#10;    connection = new Strophe.Connection(BOSH_SERVICE);&#10;    // &#27880;&#20876;&#20107;&#20214;&#22788;&#29702;&#22120;&#10;    connection.rawInput = rawInput;&#10;    connection.rawOutput = rawOutput;&#10;    // &#29992;&#25143;&#27880;&#20876;&#10;    connection.register.connect(DOMAIN_NAME, function (status) &#123;&#10;      if (status === Strophe.Status.REGISTER) &#123;&#10;        connection.register.fields.username = $(&#34;#username&#34;).val();&#10;        connection.register.fields.password = $(&#34;#password&#34;).val();&#10;        console.info(&#34;registering...&#34;);&#10;        connection.register.submit();&#10;      &#125;&#10;      else if (status === Strophe.Status.REGISTERED) &#123;&#10;        console.info(&#34;Registerd!&#34;);&#10;        connection.disconnect();&#10;      &#125;&#10;      else if (status === Strophe.Status.CONFLICT) &#123;&#10;        console.error(&#34;Username already exists.&#34;)&#10;      &#125;&#10;      else if (status === Strophe.Status.NOTACCEPTABLE) &#123;&#10;        console.error(&#34;Registration form not properly filled out.&#34;)&#10;      &#125;&#10;      else if (status === Strophe.Status.REGIFAIL) &#123;&#10;        console.log(&#34;The Server does not support In-Band Registration&#34;)&#10;      &#125;&#10;      else if (status === Strophe.Status.CONNECTED) &#123;&#10;        console.info(&#34;Connected.&#34;)&#10;      &#125;&#10;      else if (status === Strophe.Status.DISCONNECTING) &#123;&#10;        console.log(&#34;Disconneting...&#34;);&#10;      &#125;&#10;      else if (status === Strophe.Status.DISCONNECTED) &#123;&#10;        console.log(&#34;Disconneted.&#34;)&#10;      &#125;&#10;      else &#123;&#10;      &#125;&#10;    &#125;, 60, 1);&#10;  &#125;);&#10;&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-02T20:07:43.000Z"><a href="/2014/10/03/xmpp-xep-0198-stream-management/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/xmpp-xep-0198-stream-management/">XMPP XEP-0198流管理 - 协议</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文包括两个部分</p>
<ul>
<li>本规范引用自如下连接并对其<strong>修订</strong>,<strong>校对</strong>,<strong>补充</strong><br><a href="http://blog.csdn.net/yuedong56/article/details/38120101">http://blog.csdn.net/yuedong56/article/details/38120101</a>.</li>
</ul>
<h2 id="介绍">介绍</h2><p><a href="http://wiki.jabbercn.org/RFC6120#.E5.85.A8.E5.B1.80.E5.9C.B0.E5.9D.80">XMPP Core</a> 用XMPP定义了流的XML技术(也就是流的建立和终止,包括认证和加密).但是核心的XMPP协议并没有为管理一个灵活的XML流提供工具.</p>
<p>流管理背后的基本概念是,初始化的实体(一个服务端或者客户端)和接收的实体(一个服务端)可以为更灵活的管理stream交换<code>命令</code>.下面两条流管理的特性被广泛的关注,因为它们可以提高网络的可靠性和终端用户的体验:</p>
<ul>
<li>Stanza确认(Stanza Acknowledgements) – 能够确认一段或者一系列Stanza是否已被某一方接收.</li>
<li>流恢复(Stream Resumption) – 能够迅速的恢复(resume)一个已经被终止的流.</li>
</ul>
<p>流管理用较的短XML元素实现了这些特性,这些XML元素是在流的标准上的.这些元素并不是XMPP意义上的<code>stanzas</code>(也就是说,不是<code>&lt;iq/&gt;</code>,<code>&lt;message/&gt;</code>,或<code>&lt;presence/&gt;</code>这样的<code>stanzas</code>,<code>stanzas</code>在<strong>RFC 6120</strong>中有定义),它们不会在流管理中被<code>counted</code>或者被<code>acked</code>,因为它们是为管理stanzas本身而存在的.</p>
<p>流管理是在XML流的标准上使用的.检查一个给定的流TCP的连通性的时候,特别推荐使用<code>whitespace keepalives</code>(见<strong>RFC 6120</strong>),<a href="http://xmpp.org/extensions/xep-0199.html">XMPP Ping (XEP-0199)</a>或者<code>TCP keepalives</code>.对比流管理,高级消息处理<a href="http://xmpp.org/extensions/xep-0079.html">Advanced Message Processing (XEP-0079)</a>和消息回执<a href="http://xmpp.org/extensions/xep-0184.html">Message Delivery Receipts (XEP-0184)</a>,定义了<code>Ack</code>,它可以通过多个流实现端对端的传输;这些特性在一些特殊情况中是有用的,但是没必要去检查在两个xmpp实体之间直接传递的流.</p>
<p>注:流管理可以用于服务端到服务端,客户端到服务端的流.但是,为了方便,本规范只讨论客户端到服务端的流.同样的原则也适用于服务器到服务器的流.(在本文档中,以<strong>C:</strong>开头的都是由客户端发送的,由<strong>S:</strong>开头的都是由服务器发送的).</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/10/03/xmpp-xep-0198-stream-management/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-02T20:07:43.000Z"><a href="/2014/10/03/xmpp-xep-0198-stream-management-2/">2014-10-03</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/03/xmpp-xep-0198-stream-management-2/">XMPP XEP-0198流管理 - 实例分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>客户端启用流管理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;enable xmlns=&#39;urn:xmpp:sm:3&#39; resume=&#39;true&#39;/&#62;</span><br></pre></td></tr></table></figure></p>
<p>服务端启用流管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;enabled xmlns=&#34;urn:xmpp:sm:3&#34;&#10;    id=&#34;g2gCbQAAABkyNTY2MjI4NzA1MTQxMjIwMTU0MjEwMjkzaANiAAAFhGIAAE65YgAMkl8=&#34;&#10;    resume=&#34;true&#34; max=&#34;300&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; version=&#34;1.0&#34;/&#62;</span><br></pre></td></tr></table></figure>
<p>Strophe.js代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var enable = function () &#123;&#10;  var stanza = $build(&#39;enable&#39;, &#123;xmlns: &#39;urn:xmpp:sm:3&#39;, resume: true&#125;);&#10;  connection.send(stanza.tree());&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>服务器日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2014-09-29 22:12:39.416 [info] &#60;0.14329.0&#62;@ejabberd_c2s:handle_enable:2676&#10;    Stream management with resumption enabled for root@xmpp.myserver.info/2619252428141228749171506</span><br></pre></td></tr></table></figure>
<p>当启用流管理功能后,客户端在发送和接受每一个XML节的时候,会附带收到<code>&lt;r/&gt;</code>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;r xmlns=&#34;urn:xmpp:sm:3&#34; xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; version=&#34;1.0&#34;/&#62;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T19:23:39.000Z"><a href="/2014/10/02/erlang-mysql-driver/">2014-10-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/02/erlang-mysql-driver/">Erlang MySQL驱动</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="编译">编译</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/dizzyd/erlang-mysql-driver.git erlang-mysql-driver.git&#10;cd erlang-mysql-driver&#10;wget -O ./build.sh http://svn.process-one.net/ejabberd-modules/mysql/trunk/build.sh&#10;chmod +x ./build.sh&#10;./build.sh</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/build-erlang-mysql-driver.png" alt="编译erlang-mysql-driver"></p>
<h2 id="Examples">Examples</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%% Author: Administrator&#10;%% Created: 2011-5-15&#10;%% Description: TODO: Add description to test&#10;-module(test).&#10;%%&#10;%% Include files&#10;%%&#10;%%&#10;%% Exported Functions&#10;%%&#10;-export([start/0]).&#10;%%&#10;%% API Functions&#10;%%&#10;%%&#10;%% Local Functions&#10;%%&#10;start() -&#62;&#10;%% Build connection&#10;%% &#27880;&#24847;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;,utf8,&#25903;&#25345;&#20013;&#25991;&#24517;&#26432;&#25216;.&#10;    mysql:start_link(connection,&#34;localhost&#34;, 3306,&#34;root&#34;, &#34;root&#34;, &#34;erlang&#34;, undefined, utf8),&#10;%% INSERT&#10;    _result = mysql:fetch(connection, [&#60;&#60;&#34;INSERT INTO test_table (id, first_name, last_name) VALUES(default, &#39;&#20320;&#22909;&#39;, &#39;&#19990;&#30028;&#39;)&#34;&#62;&#62;]),&#10;    io:format(&#34;Result1: ~p~n&#34;, [_result]),&#10;%% SELECT&#10;    _result2 = mysql:fetch(connection, [&#60;&#60;&#34;SELECT * FROM test_table;&#34;&#62;&#62;]),&#10;    io:format(&#34;Result2: ~p~n&#34;, [_result2]),&#10;%% UPDATE&#10;    _result3 = mysql:fetch(connection, [&#60;&#60;&#34;UPDATE test_table SET first_name = &#39;River&#39; WHERE first_name = &#39;ZHIQIANG&#39; AND last_name = &#39;HE&#39;;&#34;&#62;&#62;]),&#10;    io:format(&#34;Result3: ~p~n&#34;, [_result3]),&#10;%% SELECT&#10;    _result4 = mysql:fetch(connection, [&#60;&#60;&#34;SELECT * FROM test_table;&#34;&#62;&#62;]),&#10;    io:format(&#34;Result4: ~p~n&#34;, [_result4]),&#10;%% DELETE&#10;    _result5 = mysql:fetch(connection, [&#60;&#60;&#34;DELETE FROM test_table WHERE last_name = &#39;HE&#39; AND first_name = &#39;River&#39;;&#34;&#62;&#62;]),&#10;    io:format(&#34;Result5: ~p~n&#34;, [_result5]),&#10;%% SELECT&#10;    _result6 = mysql:fetch(connection, [&#60;&#60;&#34;SELECT * FROM test_table;&#34;&#62;&#62;]),&#10;    io:format(&#34;Result6: ~p~n&#34;, [_result6]),&#10;    ok.</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T18:38:09.000Z"><a href="/2014/10/02/ejabberd-pubsub/">2014-10-02</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/02/ejabberd-pubsub/">Ejabberd 发布订阅实验</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="环境">环境</h2><table>
<thead>
<tr>
<th>Software</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ejabberd</td>
<td>14.07</td>
</tr>
<tr>
<td>Strophe.js</td>
<td>1.1.3</td>
</tr>
</tbody>
</table>
<h2 id="创建节点">创建节点</h2><p>Strophe.js代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var createnode = function (node) &#123;&#10;  var iq = $iq(&#123;&#10;    type: &#39;set&#39;,&#10;    from: jid,&#10;    to: session.pubsub,&#10;    id: getId()&#10;  &#125;).c(&#39;pubsub&#39;, &#123;xmlns: &#39;http://jabber.org/protocol/pubsub&#39;&#125;)&#10;    .c(&#39;create&#39;, &#123;node: node&#125;);&#10;  connection.send(iq.tree());&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>XML节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!--&#23458;&#25143;&#31471;IQ-set&#35831;&#27714;--&#62;&#10;&#60;iq type=&#39;set&#39;&#10;    from=&#39;root@xmpp.myserver.info&#39;&#10;    to=&#39;pubsub.xmpp.myserver.info&#39;&#10;    id=&#39;id-1412188942892&#39;&#10;    xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;pubsub xmlns=&#39;http://jabber.org/protocol/pubsub&#39;&#62;&#10;    &#60;create node=&#39;/home/test2&#39;/&#62;&#10;  &#60;/pubsub&#62;&#10;&#60;/iq&#62;&#10;&#60;!--&#26381;&#21153;&#31471;&#24212;&#31572;IQ-result--&#62;&#10;&#60;iq from=&#34;pubsub.xmpp.myserver.info&#34;&#10;    to=&#34;root@xmpp.myserver.info/17735350171411959891145164&#34;&#10;    id=&#34;id-1412188942892&#34;&#10;    type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;&#10;  &#60;pubsub xmlns=&#34;http://jabber.org/protocol/pubsub&#34;&#62;&#10;    &#60;create node=&#34;/home/test2&#34;/&#62;&#10;  &#60;/pubsub&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<h2 id="订阅">订阅</h2><p>Strophe.js代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var subscribe = function (node) &#123;&#10;  var iq = $iq(&#123;&#10;    type: &#39;set&#39;,&#10;    from: jid,&#10;    to: session.pubsub,&#10;    id: getId()&#10;  &#125;).c(&#39;pubsub&#39;, &#123;xmlns: &#39;http://jabber.org/protocol/pubsub&#39;&#125;)&#10;    .c(&#39;subscribe&#39;, &#123;node: node, jid: jid&#125;);&#10;  connection.send(iq.tree());&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>XML节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!--&#23458;&#25143;&#31471;IQ-set&#35831;&#27714;--&#62;&#10;&#60;iq type=&#39;set&#39; from=&#39;root@xmpp.myserver.info&#39;&#10;    to=&#39;pubsub.xmpp.myserver.info&#39; id=&#39;id-1412189193003&#39;&#10;    xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;pubsub xmlns=&#39;http://jabber.org/protocol/pubsub&#39;&#62;&#10;    &#60;subscribe node=&#39;/home/test&#39; jid=&#39;root@xmpp.myserver.info&#39;/&#62;&#10;  &#60;/pubsub&#62;&#10;&#60;/iq&#62;&#10;&#60;!--&#26381;&#21153;&#31471;&#24212;&#31572;IQ-result--&#62;&#10;&#60;iq from=&#34;pubsub.xmpp.myserver.info&#34;&#10;    to=&#34;root@xmpp.myserver.info/17735350171411959891145164&#34;&#10;    id=&#34;id-1412189193003&#34; type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34; xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;&#10;  &#60;pubsub xmlns=&#34;http://jabber.org/protocol/pubsub&#34;&#62;&#10;    &#60;subscription&#10;        jid=&#34;root@xmpp.myserver.info&#34; subscription=&#34;subscribed&#34; subid=&#34;583EAABFD09CF&#34;&#10;        node=&#34;/home/test&#34;/&#62;&#10;  &#60;/pubsub&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://wiki.jabbercn.org/XEP-0060#.E5.88.9B.E5.BB.BA.E8.8A.82.E7.82.B9" target="_blank" rel="external">http://wiki.jabbercn.org/XEP-0060#.E5.88.9B.E5.BB.BA.E8.8A.82.E7.82.B9</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T14:47:12.000Z"><a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/">2014-10-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/">XMPP XEP-0184消息回执</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://xmpp.org/extensions/xep-0184.html">XEP-0184</a>, 定义如下:</p>
<p>本规范定义了一个关于<code>消息送达收条</code>的XMPP协议扩展,消息的发送者可以要求消息的接收设备在接收到消息后发送一个确认消息(收条). 比如: 发邮件给对方可以要求一个邮件回执,以确定对方收到消息. 如果没有收到回执,可以重新发送.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/10/01/xmpp-xep-0184-message-delivery-receipts/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-10-01T13:27:52.000Z"><a href="/2014/10/01/erlang-application/">2014-10-01</a></time>
      
      
  
    <h1 class="title"><a href="/2014/10/01/erlang-application/">应用程序简介</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>In OTP, application denotes a component implementing some specific functionality, that can be started and stopped as a unit, and which can be re-used in other systems as well. This module interfaces the application controller, a process started at every Erlang runtime system, and contains functions for controlling applications (for example starting and stopping applications), and functions to access information about applications (for example configuration parameters).</p>
<p>An application is defined by an application specification. The specification is normally located in an application resource file called Application.app, where Application is the name of the application. Refer to app(4) for more information about the application specification.</p>
<p>This module can also be viewed as a behaviour for an application implemented according to the OTP design principles as a supervision tree. The definition of how to start and stop the tree should be located in an application callback</p>
<p>在OPT中,一个应用程序表示一个实现了特定功能的组件, 可以作为独立的单元start和stop,可以在其他系统中重用.</p>
<p><code>application</code>模块与<code>application controller</code>连接, <code>application controller</code> 是一个随erlang系统启动的进程.用于控制应用程序(启动,停止,访问应用程序信息).</p>
<ul>
<li><code>application specification</code><br>描述如何定义一个应用程序</li>
<li><code>application resource file</code>(<code>Application</code>.app)<br><code>Application</code>为应用程序的名称</li>
<li><code>erl -man app</code><br>查看应用程序资源文件的详细规范</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T17:01:37.000Z"><a href="/2014/09/30/ejabberd-modules-get-room-member-list/">2014-09-30</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/30/ejabberd-modules-get-room-member-list/">Ejabberd模块 - 获取房间成员列表</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>上一篇<a href="/2014/09/29/ejabberd-modules-pitfalls">Ejabberd 14.x版本系列模块开发过程中遇到的坑</a>,一个很坑的移植过程,没找到相关的升级文档,全靠读代码. -_-!</p>
<p>本模块用于获取一个房间内的所有成员, 代码在<a href="https://gist.github.com/developerworks/798d67182b38eda72e25" target="_blank" rel="external">这里</a>, 本模块修改自<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">获取房间的用户列表模块</a>, 兼容<code>ejabberd 14.x</code>系列版本.</p>
<h2 id="Bugfix">Bugfix</h2><ol>
<li><code>muc_room</code>表结构有变化, 下面是输出的日志,为了便于阅读,我在每个元素前附加序号作为前缀</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;muc_room,&#10;    &#123;&#60;&#60;&#34;test&#34;&#62;&#62;,&#60;&#60;&#34;conference.xmpp.myserver.info&#34;&#62;&#62;&#125;,&#10;    [&#10;        1  &#123;title,&#60;&#60;232,129,138,229,164,169,229,174,164,230,160,135,233,162,152&#62;&#62;&#125;,&#10;        2  &#123;description,&#60;&#60;232,129,138,229,164,169,229,174,164,230,143,143,232,191,176&#62;&#62;&#125;,&#10;        3  &#123;allow_change_subj,true&#125;,&#10;        4  &#123;allow_query_users,true&#125;,&#10;        5  &#123;allow_private_messages,true&#125;,&#10;        6  &#123;allow_private_messages_from_visitors,anyone&#125;,&#10;        7  &#123;allow_visitor_status,true&#125;,&#10;        8  &#123;allow_visitor_nickchange,true&#125;,&#10;        9  &#123;public,true&#125;,&#10;        10 &#123;public_list,true&#125;,&#10;        11 &#123;persistent,true&#125;,&#10;        12 &#123;moderated,true&#125;,&#10;        13 &#123;members_by_default,true&#125;,&#10;        14 &#123;members_only,false&#125;,&#10;        15 &#123;allow_user_invites,false&#125;,&#10;        16 &#123;password_protected,false&#125;,&#10;        17 &#123;captcha_protected,false&#125;,&#10;        18 &#123;password,&#60;&#60;&#62;&#62;&#125;,&#10;        19 &#123;anonymous,true&#125;,&#10;        20 &#123;logging,false&#125;,&#10;        21 &#123;max_users,200&#125;,&#10;        22 &#123;allow_voice_requests,true&#125;,&#10;        23 &#123;voice_request_min_interval,1800&#125;,&#10;        24 &#123;vcard,&#60;&#60;&#62;&#62;&#125;,&#10;        25 &#123;captcha_whitelist,[]&#125;,&#10;        26 &#123;affiliations,[&#10;            &#123;&#10;                &#123;&#60;&#60;&#34;hezhiqiang&#34;&#62;&#62;,&#60;&#60;&#34;xmpp.myserver.info&#34;&#62;&#62;,&#60;&#60;&#62;&#62;&#125;,&#10;                &#123;owner,&#60;&#60;&#62;&#62;&#125;&#10;            &#125;&#10;        ]&#125;,&#10;        27 &#123;subject,&#60;&#60;&#62;&#62;&#125;,&#10;        28 &#123;subject_author,&#60;&#60;&#62;&#62;&#125;&#10;    ]&#125;]</span><br></pre></td></tr></table></figure>
<p>其中元素<code>affiliations</code>位于房间配置列表第26个元素,和<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">原文&lt;&lt;获取房间的用户列表模块&gt;&gt;</a>不同</p>
<h2 id="补充">补充</h2><p>忘了一件事, 需要在<code>$EJABBERD/tools/xmpp_codec.spec</code>增加下列代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-xml(room_member_item,&#10;     #elem&#123;name = &#60;&#60;&#34;item&#34;&#62;&#62;,&#10;           xmlns = &#60;&#60;&#34;http://jabber.org/protocol/muc#member-list&#34;&#62;&#62;,&#10;           result = &#39;$jid&#39;,&#10;           attrs = [#attr&#123;name = &#60;&#60;&#34;jid&#34;&#62;&#62;,&#10;                          required = true,&#10;                          dec = &#123;dec_jid, []&#125;,&#10;                          enc = &#123;enc_jid, []&#125;&#125;]&#125;).&#10;-xml(room_member,&#10;     #elem&#123;name = &#60;&#60;&#34;query&#34;&#62;&#62;,&#10;           xmlns = &#60;&#60;&#34;http://jabber.org/protocol/muc#member-list&#34;&#62;&#62;,&#10;           result = &#123;room_member, &#39;$items&#39;&#125;,&#10;           refs = [#ref&#123;name = room_member_item,&#10;                        label = &#39;$items&#39;&#125;]&#125;).</span><br></pre></td></tr></table></figure>
<p>并执行<code>make spec</code>更新, 然后再 <code>make &amp;&amp; make install</code>, 最后 <code>ejabberdctl restart</code></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-erlang1" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/opensource/os-erlang1</a></li>
<li>Erlang标准库函数 <code>lists:any/2</code><br><a href="http://www.erlang.org/doc/man/lists.html#any-2" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html#any-2</a></li>
<li>Erlang标准库函数 <code>lists:nth/2</code><br><a href="http://www.erlang.org/doc/man/lists.html#nth-2" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html#nth-2</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T13:18:49.000Z"><a href="/2014/09/29/ejabberd-modules-pitfalls/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-modules-pitfalls/">Ejabberd 14.x版本系列模块开发过程中遇到的坑</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>网上的资料多数都是<code>2.x</code>版本的, 从Ejabberd2.x系列迁移到14.x,路上遇到很多坑坑洼洼, 这里以一个<code>mod_cputime</code>模块为实例记录一下坑爹的过程.</p>
<h2 id="自定义新的名称空间问题">自定义新的名称空间问题</h2><p>如果你想要直接使用<code>mod_disco:register_feature/2</code>来创建一个名称空间,<em>那是不行的</em>,为什么不行, 下面我来细讲:</p>
<p>你会碰到各种<code>badxml</code>的错误. 从结果倒推,ejabberd应该是使用了<code>xmpp_codec.erl</code>来验证交互过程中传递的XML节的有效性,无效的统统抛弃,增强安全性,这样模块就不能随意增加名称空间.</p>
<p>设<code>$EJABBERD_SRC</code>为源码根目录.</p>
<ul>
<li>在<code>14.07</code>中, 首先需要在<code>$EJABBERD_SRC/tools/xmpp_codec.spec</code>增加你需要扩展的名称空间, 例如:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-xml(cpu_time,&#10;     #elem&#123;name = &#60;&#60;&#34;time&#34;&#62;&#62;,&#10;           xmlns = &#60;&#60;&#34;ejabberd:cputime&#34;&#62;&#62;,&#10;           result = &#39;$cdata&#39;,&#10;           cdata = #cdata&#123;label = &#39;$cdata&#39;, required = true &#125;&#125;).&#10;-xml(cpu,&#10;    #elem&#123;name = &#60;&#60;&#34;query&#34;&#62;&#62;,&#10;          xmlns = &#60;&#60;&#34;ejabberd:cputime&#34;&#62;&#62;,&#10;          result = &#123;cpu, &#39;$time&#39;&#125;,&#10;          refs = [#ref&#123;name = cpu_time,&#10;                       label = &#39;$time&#39;,&#10;                       min = 0, max = 1&#125;]&#125;).</span><br></pre></td></tr></table></figure>
<ul>
<li><p>然后在ejabberd的源代码根目录下执行<code>make spec</code>生成新的<code>xmpp_codec.hrl</code>,<code>xmpp_codec.erl</code>两个文件.</p>
</li>
<li><p><code>make &amp;&amp; make install</code></p>
</li>
<li><p><code>ejabberdctl restart</code></p>
</li>
</ul>
<p>还有一点要注意的时, 所有<code>#xmlel</code>, <code>#jid</code>, <code>#iq</code>这些记录中对应的XML标签名称, 属性名称, 以及CDATA的数据类型必须是类似<code>&lt;&lt;&quot;iq&quot;&gt;&gt;</code>这种二进制字符串. 否则也会出现各种意想不到的错误.</p>
<p>Ejabberd的文档不多,也比较碎片化,为了避免掉进各种坑里面,还是多研究源码,多试错.</p>
<h2 id="添加新名称空间iq处理模块">添加新名称空间iq处理模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-module(mod_cputime).&#10;-behaviour(gen_mod).&#10;-export([&#10;    start/2,&#10;    stop/1,&#10;    process_local_iq/3&#10;]).&#10;-include(&#34;ejabberd.hrl&#34;).&#10;-include(&#34;jlib.hrl&#34;).&#10;-include(&#34;logger.hrl&#34;).&#10;-define(NS_CPUTIME, &#60;&#60;&#34;ejabberd:cputime&#34;&#62;&#62;).&#10;start(Host, Opts) -&#62;&#10;    IQDisc = gen_mod:get_opt(&#10;        iqdisc,&#10;        Opts,&#10;        fun gen_iq_handler:check_type/1,&#10;        one_queue&#10;    ),&#10;    mod_disco:register_feature(Host, ?NS_CPUTIME),&#10;    gen_iq_handler:add_iq_handler(ejabberd_local, Host, ?NS_CPUTIME, ?MODULE, process_local_iq, IQDisc),&#10;    ok.&#10;stop(Host) -&#62;&#10;    mod_disco:unregister_feature(Host, ?NS_CPUTIME),&#10;    gen_iq_handler:remove_iq_handler(ejabberd_local, Host, ?NS_CPUTIME),&#10;    ok.&#10;process_local_iq(_From, _To, #iq&#123;type = Type, sub_el = SubEl&#125; = IQ) -&#62;&#10;    case Type of&#10;        set -&#62;&#10;            IQ#iq&#123;type = error, sub_el = [SubEl, ?ERR_NOT_ALLOWED]&#125;;&#10;        get -&#62;&#10;            CPUTime = element(1, erlang:statistics(runtime)) / 1000,&#10;            SCPUTime = lists:flatten(io_lib:format(&#34;~.3f&#34;, [CPUTime])),&#10;            Packet = #iq&#123;type = result, sub_el = [&#10;                #xmlel&#123;name = &#60;&#60;&#34;query&#34;&#62;&#62;, attrs = [&#123;&#60;&#60;&#34;xmlns&#34;&#62;&#62;, ?NS_CPUTIME&#125;], children = [&#10;                    #xmlel&#123;name = &#60;&#60;&#34;time&#34;&#62;&#62;, attrs = [], children = [&#123;xmlcdata, list_to_binary(SCPUTime)&#125;]&#125;]&#125;&#10;            ]&#125;,&#10;            Packet&#10;    end.</span><br></pre></td></tr></table></figure>
<p>把上面的代码放到<code>$EJABBERD_SRC/src</code>下面,然后<code>make &amp;&amp; make install</code>,<br>在配置文件<code>/etc/ejabberd/ejabberd.yml</code>增加一个模块配置,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">##&#10;## Modules enabled in all ejabberd virtual hosts.&#10;##&#10;modules:&#10;  mod_cputime: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>执行<code>ejabberdctl restart</code>重启ejabberd.</p>
<h2 id="验证">验证</h2><p>客户端发起一个<code>IQ-get</code>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;get&#39; to=&#39;xmpp.myserver.info&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;query xmlns=&#39;http://jabber.org/protocol/disco#info&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>服务端<code>IQ-result</code>应答</p>
<p><img src="/assets/images/2EC981C0-DFFB-415F-BBA5-F767C4EB5DA0.png" alt="自定义名称空间的Features列表"></p>
<h2 id="验证模块是否能够工作">验证模块是否能够工作</h2><p>客户端发起<code>IQ-get</code>请求一个CPU时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;get&#39; to=&#39;xmpp.myserver.info&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;query xmlns=&#39;ejabberd:cputime&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>服务端<code>IQ-result</code>应答</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq from=&#34;xmpp.myserver.info&#34;&#10;    to=&#34;root@xmpp.myserver.info/1507629570141186050149354&#34;&#10;    type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;&#10;  &#60;query xmlns=&#34;ejabberd:cputime&#34;&#62;&#10;    &#60;time&#62;3.840&#60;/time&#62;&#10;  &#60;/query&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>客户端代码在<a href="https://gist.github.com/developerworks/842fbc5b6092b3c5823e" target="_blank" rel="external">这里</a>,包含三个文件, <a href="/2014/09/30/ejabberd-modules-get-room-member-list">下一篇</a>把<a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">获取房间的用户列表</a>模块移植到<code>ejabberd 14.07</code></p>
<h2 id="要用到二进制字符串的地方">要用到二进制字符串的地方</h2><p>这里强调一下</p>
<ul>
<li><p>定义名称空间的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(NS_CPUTIME, &#60;&#60;&#34;ejabberd:cputime&#34;&#62;&#62;).</span><br></pre></td></tr></table></figure>
</li>
<li><p>XML元素的属性名称和属性值</p>
</li>
<li><code>jlib:jid_to_string()</code>接受一个<code>#jid</code>或一个三元组,<code>User</code>,<code>Server</code>,<code>Resource</code>为字符串类型(Erlang中的字符串就是一个字符列表). 从<code>jlib.erl</code>中的定义我们可以看到,内部使用了<code>iolist_to_binary</code>对列表进行转换. 这里类型不要传错了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jid_to_string(#jid&#123;user = User, server = Server,&#10;&#9;&#9;   resource = Resource&#125;) -&#62;&#10;    jid_to_string(&#123;User, Server, Resource&#125;);&#10;jid_to_string(&#123;N, S, R&#125;) -&#62;&#10;    Node = iolist_to_binary(N),&#10;    Server = iolist_to_binary(S),&#10;    Resource = iolist_to_binary(R),&#10;    S1 = case Node of&#10;&#9;   &#60;&#60;&#34;&#34;&#62;&#62; -&#62; &#60;&#60;&#34;&#34;&#62;&#62;;&#10;&#9;   _ -&#62; &#60;&#60;Node/binary, &#34;@&#34;&#62;&#62;&#10;&#9; end,&#10;    S2 = &#60;&#60;S1/binary, Server/binary&#62;&#62;,&#10;    S3 = case Resource of&#10;&#9;   &#60;&#60;&#34;&#34;&#62;&#62; -&#62; S2;&#10;&#9;   _ -&#62; &#60;&#60;S2/binary, &#34;/&#34;, Resource/binary&#62;&#62;&#10;&#9; end,&#10;    S3.</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>Ejabberd Developers Guide<br><a href="http://www.girlsnn.net/ejabberd/doc/dev.html#sec15" target="_blank" rel="external">http://www.girlsnn.net/ejabberd/doc/dev.html#sec15</a></li>
<li>获取用户房间列表<br><a href="http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist" target="_blank" rel="external">http://blog.zlxstar.me/blog/2013/07/21/dicorvery-user-muclist</a></li>
<li>Strophe.js API文档<br><a href="http://strophe.im/strophejs/doc/1.1.3/files/strophe-js.html" target="_blank" rel="external">http://strophe.im/strophejs/doc/1.1.3/files/strophe-js.html</a></li>
<li>Ejabberd IQ 处理程序<br><a href="https://www.process-one.net/en/wiki/ejabberd_IQ_handlers/" target="_blank" rel="external">https://www.process-one.net/en/wiki/ejabberd_IQ_handlers/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T12:30:48.000Z"><a href="/2014/09/29/ejabberd-important-records/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-important-records/">Ejabberd中几个重要的Record结构</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd中几非常重要的记录结构, 贯穿整个Ejabberd的开发, 非常基础, 如果不能很好的理解,那么几乎不能很好的扩展Ejabberd的功能.</p>
<h2 id="jid"><code>jid</code></h2><p>Jabber 标识, 最基本的一个record结构, 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中,包含6个字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-record(jid, &#123;user = &#60;&#60;&#34;&#34;&#62;&#62; :: binary(),&#10;              server = &#60;&#60;&#34;&#34;&#62;&#62; :: binary(),&#10;              resource = &#60;&#60;&#34;&#34;&#62;&#62; :: binary(),&#10;              luser = &#60;&#60;&#34;&#34;&#62;&#62; :: binary(),&#10;              lserver = &#60;&#60;&#34;&#34;&#62;&#62; :: binary(),&#10;              lresource = &#60;&#60;&#34;&#34;&#62;&#62; :: binary()&#125;).</span><br></pre></td></tr></table></figure>
<h2 id="iq"><code>iq</code></h2><p>Info/Query 节, XMPP协议中三个基本的XML节之一, 并且是三个中最重要的一个, 大多数交互都是靠它来完成的. 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-record(iq, &#123;id = &#60;&#60;&#34;&#34;&#62;&#62;       :: binary(),&#10;             type = get        :: get | set | result | error,&#10;             xmlns = &#60;&#60;&#34;&#34;&#62;&#62;    :: binary(),&#10;             lang  = &#60;&#60;&#34;&#34;&#62;&#62;    :: binary(),&#10;             sub_el = #xmlel&#123;&#125; :: xmlel() | [xmlel()]&#125;).</span><br></pre></td></tr></table></figure>
<h2 id="xmlel"><code>xmlel</code></h2><p>一个XML元素记录, 用于构造自定义XML节</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T16:10:06.000Z"><a href="/2014/09/29/ejabberd-route-table/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-route-table/">Ejabberd-路由表</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>ejabberd内部模块可以通过一个XMPP名称(<code>-define(PROCNAME, ejabberd_mod_echo).</code>),添加自身到服务器的路由表中,这些模块被称为<code>服务</code>,服务模块必须同时实现<code>gen_server</code>和<code>gen_mod</code>行为</p>
<h2 id="例子">例子</h2><p><a href="https://github.com/processone/ejabberd/blob/master/src/mod_echo.erl" target="_blank" rel="external">mod_echo.erl</a>是一个使用路由机制的例子.</p>
<h2 id="API">API</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ejabberd_router:register_route(Host)&#10;ejabberd_router:unregister_route(Host),&#10;* Host = string()</span><br></pre></td></tr></table></figure>
<h3 id="gen_server_API">gen_server API</h3><p>下面上个函数用作模块的API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start_link(Host, Opts) -&#62;&#10;    Proc = gen_mod:get_module_proc(Host, ?PROCNAME),&#10;    gen_server:start_link(&#123;local, Proc&#125;, ?MODULE, [Host, Opts], []).</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start(Host, Opts) -&#62;&#10;    Proc = gen_mod:get_module_proc(Host, ?PROCNAME),&#10;    ChildSpec = &#123;Proc,&#123;?MODULE, start_link, [Host, Opts]&#125;, temporary, 1000, worker, [?MODULE]&#125;,&#10;    supervisor:start_child(ejabberd_sup, ChildSpec).</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop(Host) -&#62;&#10;    Proc = gen_mod:get_module_proc(Host, ?PROCNAME),&#10;    gen_server:call(Proc, stop),&#10;    supervisor:terminate_child(ejabberd_sup, Proc),&#10;    supervisor:delete_child(ejabberd_sup, Proc).</span><br></pre></td></tr></table></figure>
<h3 id="gen_server_回调">gen_server 回调</h3><p>下面的函数必须定义并导出.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init([Host, Opts]) -&#62; &#123;ok, State&#125; |&#10;                      &#123;ok, State, Timeout&#125; |&#10;                      ignore |&#10;                      &#123;stop, Reason&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handle_info(Info, State) -&#62; &#123;noreply, State&#125; |&#10;                            &#123;noreply, State, Timeout&#125; |&#10;                            &#123;stop, Reason, State&#125;&#10;* Info = &#123;route, From, To, Packet&#125;&#10;* To = From = #jid (see jlib core module)&#10;* Packet = &#123;xmlelement, Name, Attrs, SubEl&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terminate(Reason, State) -&#62; void()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handle_call(stop, _From, State) -&#62; &#123;stop, normal, ok, State&#125;.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handle_cast(_Msg, State) -&#62; &#123;noreply, State&#125;.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code_change(_OldVsn, State, _Extra) -&#62; &#123;ok, State&#125;.</span><br></pre></td></tr></table></figure>
<p><code>init</code>函数用于初始化模块.<code>Host</code>为模块所在虚拟主机名称,<code>Opts</code>为在配置文件中设置的模块选项,这些选项可以通过<strong><a href="https://www.process-one.net/en/wiki/gen_mod" target="_blank" rel="external">gen_mod:get_opt/3</a></strong>函数获取.<strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:register_route/1</a></strong>函数在<code>init</code>回调中执行.</p>
<p><code>terminate/2</code>用于停止模块. <code>ejabberd_router:unregister_route</code>函数在此回调中被调用.</p>
<p><code>handle_info/2</code>用于获取发送给该模块的XMPP包. <strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:route/1</a></strong>用于对包进行重新路由.</p>
<p>All other callbacks can be written as shown above.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T15:28:55.000Z"><a href="/2014/09/28/ejabberd-iq-handlers/">2014-09-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/28/ejabberd-iq-handlers/">Ejabberd-IQ节处理程序</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd内部模块可以注册自身,并使用指定名称空间处理IQ节, 其方法类似于<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a>这种机制.</p>
<p>模块<a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">mod_last.erl</a>就使用了这种机制, 同时也使用了<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a></p>
<h2 id="API">API</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gen_iq_handler:add_iq_handler(Scope, Host, Namespace, Module, Function, IQDisc)&#10;gen_iq_handler:remove_iq_handler(Scope, Host, Namespace, Module, Function, IQDisc)&#10;* Scope = ejabberd_local | ejabberd_sm&#10;* Namespace = string() (&#26576;&#20123;&#21517;&#31216;&#31354;&#38388;&#23439;&#23450;&#20041;&#22312;jlib.hrl&#22836;&#25991;&#20214;&#20013;)&#10;* Host = string()&#10;* Module = atom()&#10;* Fonction = atom()&#10;* IQDisc = no_queue | one_queue | &#123;queues, N&#125; | parallel&#10;* N = integer()</span><br></pre></td></tr></table></figure>
<p><strong>ejabberd_local</strong>作用域用于注册发到服务器本身的<strong>IQ</strong>.<br><strong>ejabberd_sm</strong>作用域用于注册发送到一个账号的<strong>纯JID</strong>(Bare JID)的<strong>IQ</strong>,<strong>Host</strong>为与该<strong>IQ</strong>相关的虚拟主机名称.</p>
<p><strong>Module</strong>和<strong>Function</strong>描述了一个处理器函数,当收到<strong>指定名称空间的IQ节</strong>时,该函数被调用.该处理器函数必须具有如下声明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Module:Function(From, To, IQ) -&#62; IQ&#10;* From = To = #jid&#10;* IQ = #iq</span><br></pre></td></tr></table></figure>
<p>处理函数返回结果IQ (IQ-result), IQDisc描述当前IQ如何处理:</p>
<p><strong>no_queue</strong>: 不创建新线程运行该处理程序<br><strong>one_queue</strong>: 创建一个专用线程运行该处理程序<br><strong>{queues, N}</strong>: 创建<strong>N</strong>个线程运行该处理程序<br><strong>parallel</strong>: 对每一个接收到的IQ创建一个线程</p>
<h2 id="IQ处理模块模板">IQ处理模块模板</h2><p>修改以适应Ejabberd <strong>14.07</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-module(mod_iqtest).&#10;-behaviour(gen_mod).&#10;-export([start/2, stop/1,&#10;  process_sm_iq/3 %% I assume this is needed to handle JID to JID communication of the IQ?&#10;]).&#10;-include(&#34;ejabberd.hrl&#34;).&#10;-include(&#34;jlib.hrl&#34;).&#10;-include(&#34;logger.hrl&#34;).&#10;-define(NS_TEST, &#34;http://jabber.org/protocol/test&#34;).&#10;-define(NS_TEST2, &#34;http://jabber.org/protocol/test2&#34;).&#10;start(Host, Opts) -&#62;&#10;  IQDisc = gen_mod:get_opt(&#10;    iqdisc,&#10;    Opts,&#10;    fun gen_iq_handler:check_type/1,&#10;    one_queue&#10;  ),&#10;  gen_iq_handler:add_iq_handler(&#10;    ejabberd_sm, Host, ?NS_TEST, ?MODULE, process_sm_iq, IQDisc&#10;  ),&#10;  gen_iq_handler:add_iq_handler(&#10;    ejabberd_sm, Host, ?NS_TEST2, ?MODULE, process_sm_iq, IQDisc&#10;  ),&#10;  ?INFO_MSG(&#34;Loading module &#39;mod_iqtest&#39; v.01&#34;, []).&#10;stop(Host) -&#62;&#10;  gen_iq_handler:remove_iq_handler(&#10;    ejabberd_sm, Host, ?NS_TEST&#10;  ),&#10;  gen_iq_handler:remove_iq_handler(&#10;    ejabberd_sm, Host, ?NS_TEST2&#10;  ),&#10;  ?INFO_MSG(&#34;Stoping module &#39;mod_iqtest&#39; &#34;, []).&#10;process_sm_iq(_From, _To, #iq&#123;type = get, xmlns = ?NS_TEST&#125; = IQ) -&#62;&#10;  ?INFO_MSG(&#34;Processing IQ Get query:~n ~p&#34;, [IQ]),&#10;  IQ#iq&#123;&#10;    type = result, sub_el = [&#123;xmlelement, &#34;value&#34;, [], [&#123;xmlcdata, &#34;Hello World of Testing.&#34;&#125;]&#125;]&#10;  &#125;;&#10;process_sm_iq(_From, _To, #iq&#123;type = get, xmlns = ?NS_TEST2&#125; = IQ) -&#62;&#10;  ?INFO_MSG(&#34;Processing IQ Get query of namespace 2:~n ~p&#34;, [IQ]),&#10;  IQ#iq&#123;&#10;    type = result, sub_el = [&#123;xmlelement, &#34;value&#34;, [], [&#123;xmlcdata, &#34;Hello World of Test 2.&#34;&#125;]&#125;]&#10;  &#125;;&#10;process_sm_iq(_From, _To, #iq&#123;type = set&#125; = IQ) -&#62;&#10;  ?INFO_MSG(&#34;Processing IQ Set: it does nothing&#34;, []),&#10;  IQ#iq&#123;&#10;    type = result, sub_el = []&#10;  &#125;;&#10;process_sm_iq(_From, _To, #iq&#123;sub_el = SubEl&#125; = IQ) -&#62;&#10;  ?INFO_MSG(&#34;Processing IQ other type: it does nothing&#34;, []),&#10;  IQ#iq&#123;&#10;    type = error, sub_el = [SubEl, ?ERR_FEATURE_NOT_IMPLEMENTED]&#10;  &#125;.</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>IQ处理程序模板<br><a href="https://www.ejabberd.im/node/5035?q=node/5035" target="_blank" rel="external">https://www.ejabberd.im/node/5035?q=node/5035</a></li>
<li>Ejabberd事件和钩子<br><a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">https://www.process-one.net/en/wiki/ejabberd_events_and_hooks</a></li>
<li>mod_last模块<br><a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">https://github.com/processone/ejabberd/blob/master/src/mod_last.erl</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T05:05:43.000Z"><a href="/2014/09/28/ejabberd-jiffy/">2014-09-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/28/ejabberd-jiffy/">Ejabberd中用Jiffy输出JSON数据</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">1.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一个例子"><span class="toc-number">2.</span> <span class="toc-text">一个例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造复杂JSON对象"><span class="toc-number">3.</span> <span class="toc-text">构造复杂JSON对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Erlang和JSON格式对照表"><span class="toc-number">3.1.</span> <span class="toc-text">Erlang和JSON格式对照表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#示例代码"><span class="toc-number">3.2.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出"><span class="toc-number">3.3.</span> <span class="toc-text">输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#变更"><span class="toc-number">4.</span> <span class="toc-text">变更</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2014-10-04"><span class="toc-number">4.1.</span> <span class="toc-text">2014-10-04</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>警告! 使用Jiffy需要特别注意,其实现为NIF,可能导致Erlang VM崩溃.</p>
<h2 id="编译">编译</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp&#10;git clone https://github.com/processone/ejabberd.git&#10;cd ejabberd&#10;chmod +x autogen.sh&#10;./autogen.sh&#10;./configure --enable-json --enable-mysql&#10;make&#10;make install</span><br></pre></td></tr></table></figure>
<p><code>jiffy.so</code>路径有个Bug,写作本文时,该BUG暂未解决. 请参考:<br><a href="https://github.com/processone/ejabberd/issues/309" target="_blank" rel="external">https://github.com/processone/ejabberd/issues/309</a>,<br>要解决此问题, 执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /lib/ejabberd/priv/lib/jiffy.so /lib/ejabberd/priv/jiffy.so</span><br></pre></td></tr></table></figure>
<h2 id="一个例子">一个例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-module(mod_online_users).&#10;-author(&#39;hezhiqiang&#39;).&#10;-behaviour(gen_mod).&#10;-export([&#10;    start/2,&#10;    stop/1,&#10;    process/2&#10;]).&#10;-include(&#34;ejabberd.hrl&#34;).&#10;-include(&#34;jlib.hrl&#34;).&#10;-include(&#34;ejabberd_http.hrl&#34;).&#10;-include(&#34;logger.hrl&#34;).&#10;%% &#22788;&#29702;&#20989;&#25968;,&#30452;&#25509;&#36820;&#22238;&#35201;&#36755;&#20986;&#21040;&#27983;&#35272;&#22120;&#30340;&#20869;&#23481;&#10;process(_LocalPath, _Request) -&#62;&#10;    Users = mnesia:table_info(session, size),&#10;    OnlineUsers = jiffy:encode(&#123;[&#123;&#60;&#60;&#34;onlineusers&#34;&#62;&#62;, Users&#125;]&#125;),&#10;    &#123;200, [], OnlineUsers&#125;.&#10;start(_Host, _Opts) -&#62;&#10;    ?INFO_MSG(&#34;===Starting module mod_online_users===&#34;, []),&#10;    ok.&#10;stop(_Host) -&#62;&#10;    ?INFO_MSG(&#34;===Stopping module mod_online_users===&#34;, []),&#10;    ok.</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/ejabberd/ejabberd.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&#10;  port: 5280&#10;  module: ejabberd_http&#10;  request_handlers:&#10;    &#34;/pub/archive&#34;: mod_http_fileserver&#10;    &#34;/http-bind/&#34;: mod_http_bind&#10;    &#34;admin&#34;: ejabberd_web_admin&#10;    &#34;online&#34;: mod_online_users&#10;  web_admin: true&#10;  http_poll: true&#10;  http_bind: true&#10;  captcha: true</span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ejabberdctl restart</span><br></pre></td></tr></table></figure>
<p>访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.8.132:5280/online/</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/9058AA0F-5ECA-4FCD-84BB-9CFAD161991F.png" alt="在线用户数模块"></p>
<h2 id="构造复杂JSON对象">构造复杂JSON对象</h2><h3 id="Erlang和JSON格式对照表">Erlang和JSON格式对照表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Erlang                          JSON            Erlang&#10;==========================================================================&#10;null                       -&#62; null           -&#62; null&#10;true                       -&#62; true           -&#62; true&#10;false                      -&#62; false          -&#62; false&#10;&#34;hi&#34;                       -&#62; [104, 105]     -&#62; [104, 105]&#10;&#60;&#60;&#34;hi&#34;&#62;&#62;                   -&#62; &#34;hi&#34;           -&#62; &#60;&#60;&#34;hi&#34;&#62;&#62;&#10;hi                         -&#62; &#34;hi&#34;           -&#62; &#60;&#60;&#34;hi&#34;&#62;&#62;&#10;1                          -&#62; 1              -&#62; 1&#10;1.25                       -&#62; 1.25           -&#62; 1.25&#10;[]                         -&#62; []             -&#62; []&#10;[true, 1.0]                -&#62; [true, 1.0]    -&#62; [true, 1.0]&#10;&#123;[]&#125;                       -&#62; &#123;&#125;             -&#62; &#123;[]&#125;&#10;&#123;[&#123;foo, bar&#125;]&#125;             -&#62; &#123;&#34;foo&#34;: &#34;bar&#34;&#125; -&#62; &#123;[&#123;&#60;&#60;&#34;foo&#34;&#62;&#62;, &#60;&#60;&#34;bar&#34;&#62;&#62;&#125;]&#125;&#10;&#123;[&#123;&#60;&#60;&#34;foo&#34;&#62;&#62;, &#60;&#60;&#34;bar&#34;&#62;&#62;&#125;]&#125; -&#62; &#123;&#34;foo&#34;: &#34;bar&#34;&#125; -&#62; &#123;[&#123;&#60;&#60;&#34;foo&#34;&#62;&#62;, &#60;&#60;&#34;bar&#34;&#62;&#62;&#125;]&#125;&#10;#&#123;&#60;&#60;&#34;foo&#34;&#62;&#62; =&#62; &#60;&#60;&#34;bar&#34;&#62;&#62;&#125;  -&#62; &#123;&#34;foo&#34;: &#34;bar&#34;&#125; -&#62; #&#123;&#60;&#60;&#34;foo&#34;&#62;&#62; -&#62; &#60;&#60;&#34;bar&#34;&#62;&#62;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例代码">示例代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process(_LocalPath, _Request) -&#62;&#10;    ConnectedUsersNumber = ejabberd_sm:connected_users_number(),&#10;    %% &#33719;&#21462;&#22312;&#32447;&#29992;&#25143;&#21015;&#34920;&#10;    AllSessionList = ejabberd_sm:dirty_get_sessions_list(),&#10;    %% &#26500;&#36896;JSON&#23545;&#35937;&#25968;&#32452;&#10;    AllSessions = lists:map(fun(&#123;User, Server, Resource&#125;) -&#62;&#10;        &#123;[&#123;user, User&#125;, &#123;server, Server&#125;, &#123;resource, Resource&#125;]&#125;&#10;    end, AllSessionList),&#10;    %% &#32534;&#30721;JSON&#26684;&#24335;&#10;    Json = jiffy:encode(&#123;[&#10;        &#123;connected_users_number, ConnectedUsersNumber&#125;,&#10;        &#123;sessions, AllSessions&#125;&#10;    ]&#125;),&#10;    &#123;200, [], Json&#125;.</span><br></pre></td></tr></table></figure>
<h3 id="输出">输出</h3><p>把上面的代码和下面的输出对照理解.</p>
<p><img src="/assets/images/BB5D080B-5B6B-43EE-A8DF-0E7DEBE7BAF4.png" alt="JSON输出"></p>
<h2 id="变更">变更</h2><h3 id="2014-10-04">2014-10-04</h3><p>调用<code>mnesia:system_info(all).</code>获取Mnesia数据库信息, 下面是返回的<code>Term</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#10;    &#123;access_module,mnesia&#125;,&#10;    &#123;auto_repair,true&#125;,&#10;    &#123;backup_module,mnesia_backup&#125;,&#10;    &#123;checkpoints,[]&#125;,&#10;    &#123;db_nodes,[ejabberd@localhost]&#125;,&#10;    &#123;debug,none&#125;,&#10;    &#123;directory,&#34;/var/lib/ejabberd&#34;&#125;,&#10;    &#123;dump_log_load_regulation,false&#125;,&#10;    &#123;dump_log_time_threshold,180000&#125;,&#10;    &#123;dump_log_update_in_place,true&#125;,&#10;    &#123;dump_log_write_threshold,1000&#125;,&#10;    &#123;event_module,mnesia_event&#125;,&#10;    &#123;extra_db_nodes,[]&#125;,&#10;    &#123;fallback_activated,false&#125;,&#10;    &#123;held_locks,[]&#125;,&#10;    &#123;ignore_fallback_at_startup,false&#125;,&#10;    &#123;fallback_error_function,&#123;mnesia,lkill&#125;&#125;,&#10;    &#123;is_running,yes&#125;,&#10;    &#123;local_tables,[&#10;        shaper,&#10;        mod_register_ip,local_config,caps_features,acl,&#10;        access,carboncopy,http_bind,reg_users_counter,pubsub_subscription,bytestream,&#10;        privacy,passwd,irc_custom,roster,last_activity,sr_user,roster_version,&#10;        pubsub_last_item,offline_msg,route,motd,s2s,vcard,pubsub_index,sr_group,&#10;        session_counter,vcard_search,motd_users,schema,session,private_storage,&#10;        pubsub_item,muc_room,pubsub_state,iq_response,temporarily_blocked,&#10;        muc_registered,muc_online_room,pubsub_node&#10;    ]&#125;,&#10;    &#123;lock_queue,[]&#125;,&#10;    &#123;log_version,&#34;4.3&#34;&#125;,&#10;    &#123;master_node_tables,[]&#125;,&#10;    &#123;max_wait_for_decision,infinity&#125;,&#10;    &#123;protocol_version,&#123;8,1&#125;&#125;,&#10;    &#123;running_db_nodes,[ejabberd@localhost]&#125;,&#10;    &#123;schema_location,opt_disc&#125;,&#10;    &#123;schema_version,&#123;2,0&#125;&#125;,&#10;    &#123;subscribers,[&#60;0.15778.0&#62;,&#60;0.16018.0&#62;,&#60;0.15961.0&#62;,&#60;0.15954.0&#62;]&#125;,&#10;    &#123;tables,[&#10;        carboncopy,http_bind,reg_users_counter,pubsub_subscription,bytestream,&#10;        privacy,local_config,passwd,irc_custom,shaper,roster,last_activity,&#10;        sr_user,roster_version,pubsub_last_item,offline_msg,route,motd,&#10;        access,acl,s2s,vcard,pubsub_index,caps_features,sr_group,session_counter,&#10;        mod_register_ip,vcard_search,motd_users,schema,session,private_storage,&#10;        pubsub_item,muc_room,pubsub_state,iq_response,temporarily_blocked,&#10;        muc_registered,muc_online_room,pubsub_node&#10;    ]&#125;,&#10;    &#123;transaction_commits,56&#125;,&#10;    &#123;transaction_failures,81&#125;,&#10;    &#123;transaction_log_writes,0&#125;,&#10;    &#123;transaction_restarts,0&#125;,&#10;    &#123;transactions,[]&#125;,&#10;    &#123;use_dir,true&#125;,&#10;    &#123;core_dir,false&#125;,&#10;    &#123;no_table_loaders,2&#125;,&#10;    &#123;dc_dump_limit,4&#125;,&#10;    &#123;send_compressed,0&#125;,&#10;    &#123;version,&#34;4.12.3&#34;&#125;&#10;]</span><br></pre></td></tr></table></figure>
<p><code>process/2</code>函数修改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process(_LocalPath, _Request) -&#62;&#10;    ConnectedUsersNumber = ejabberd_sm:connected_users_number(),&#10;    %% &#29992;&#25143;&#21015;&#34920;&#10;    AllSessionList = ejabberd_sm:dirty_get_sessions_list(),&#10;    ?DEBUG(&#34;All sessions ~p~n&#34;, [AllSessionList]),&#10;    %% Mnesia &#34920;&#20449;&#24687;&#10;    MnesiaSystemInfo = mnesia:system_info(all),&#10;    ?DEBUG(&#34;Mnesia Information ~p~n&#34;, [MnesiaSystemInfo]),&#10;    %% [&#123;&#60;&#60;&#34;root&#34;&#62;&#62;,&#60;&#60;&#34;xmpp.myserver.info&#34;&#62;&#62;,&#60;&#60;&#34;3439698832141213525690305&#34;&#62;&#62;&#125;]&#10;    %% &#26500;&#36896;&#19968;&#20010;JSON&#23545;&#35937;&#25968;&#32452;&#10;    %% &#23545;&#35937;: &#123;[]&#125;&#10;    %% &#25968;&#32452;: []&#10;    AllSessions = lists:map(fun(&#123;User, Server, Resource&#125;) -&#62;&#10;        &#123;[&#123;user, User&#125;, &#123;server, Server&#125;, &#123;resource, Resource&#125;]&#125;&#10;    end, AllSessionList),&#10;    RemoveElements = [subscribers, fallback_error_function],&#10;    MnesiaSystemInfoJiffy = lists:filtermap(fun(&#123;Key, Value&#125;) -&#62;&#10;        case lists:any(fun(E2) -&#62; E2 =:= Key end, RemoveElements) of&#10;            true -&#62;&#10;                false;&#10;            false -&#62;&#10;                case Key of&#10;                    directory -&#62;&#10;                        &#123;true, &#123;Key, list_to_bitstring(Value)&#125;&#125;;&#10;                    version -&#62;&#10;                        &#123;true, &#123;Key, list_to_bitstring(Value)&#125;&#125;;&#10;                    log_version -&#62;&#10;                        &#123;true, &#123;Key, list_to_bitstring(Value)&#125;&#125;;&#10;                    schema_version -&#62;&#10;                        &#123;V1, V2&#125; = Value,&#10;                        &#123;true, &#123;Key, list_to_bitstring([integer_to_list(V1), &#34;.&#34;, integer_to_list(V2)])&#125;&#125;;&#10;                    protocol_version -&#62;&#10;                        &#123;V1, V2&#125; = Value,&#10;                        &#123;true, &#123;Key, list_to_bitstring([integer_to_list(V1), &#34;.&#34;, integer_to_list(V2)])&#125;&#125;;&#10;                    _ -&#62;&#10;                        &#123;true, &#123;Key, Value&#125;&#125;&#10;                end&#10;        end&#10;    end, MnesiaSystemInfo),&#10;    Json = jiffy:encode(&#123;[&#10;        &#123;connected_users_number, ConnectedUsersNumber&#125;,&#10;        &#123;sessions, AllSessions&#125;,&#10;        &#123;mnesia, &#123;MnesiaSystemInfoJiffy&#125;&#125;&#10;    ]&#125;),&#10;    &#123;200, [], Json&#125;.</span><br></pre></td></tr></table></figure>
<p>JSON输出由JSON View Formater格式化<br><a href="https://chrome.google.com/webstore/detail/hdmbdioamgdkppmocchpkjhbpfmpjiei" target="_blank" rel="external">https://chrome.google.com/webstore/detail/hdmbdioamgdkppmocchpkjhbpfmpjiei</a></p>
<p><img src="/assets/images/3C50996B-E5DA-4574-83E7-C9B237DD9587.png" alt="Mnesia系统信息JSON数据"></p>
<p>注意<code>lists:filtermap</code>返回的是元组列表, 列表中的每个元素是一个元组, 每个元组包含两个项, <code>lists:filtermap</code>函数是<code>lists:filter</code>(过滤)和<code>lists:map</code>(映射)两个函数功能上的合并:<code>过滤并映射</code></p>
<p>这里例子中有部分值为空<code>[]</code>, 比如<code>checkpoints</code>, 当包含值的时候<code>可能</code>需要按照Jiffy方式转换类型.</p>
<p>完整代码如下:<br><a href="https://gist.github.com/553129e3015995b56028" target="_blank" rel="external">https://gist.github.com/553129e3015995b56028</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://github.com/davisp/jiffy" target="_blank" rel="external">https://github.com/davisp/jiffy</a></li>
<li><a href="http://www.erlang.org/doc/man/lists.html" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html</a></li>
<li><a href="http://www.erlang.org/doc/man/mnesia.html" target="_blank" rel="external">http://www.erlang.org/doc/man/mnesia.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T17:30:40.000Z"><a href="/2014/09/27/ejabberd-c2s-basic/">2014-09-27</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/27/ejabberd-c2s-basic/">Ejabberd  C2S模块状态分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd的<code>ejabberd_c2s</code>核心模块,是处理XMPP协议的核心处理模块,本文通过客户端和服务器的交互过程来分析其原理.</p>
<h2 id="建立TCP连接">建立TCP连接</h2><p>客户端建立TCP连接<code>ejabberd_listener</code>接受TCP连接,服务器日志输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ejabberd_listener &#25509;&#25910;&#21040;&#23458;&#25143;&#31471;&#30340;TCP&#36830;&#25509;&#35831;&#27714;&#10;2014-09-26 05:22:31.527 [info] &#60;0.673.0&#62;@ejabberd_listener:accept:313 (#Port&#60;0.5846&#62;) Accepted connection 172.17.42.1:53457 -&#62; 172.17.0.27:5222</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>进程初始状态为<code>wait_for_stream</code>,等待接收<code>{xmlstreamstart, _Name, Attrs}</code>消息</p>
<h2 id="客户端打开流">客户端打开流</h2><p>客户端发送打开流Stanza</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;stream:stream to=&#39;xmpp.myserver.info&#39; xmlns=&#39;jabber:client&#39; xmlns:stream=&#39;http://etherx.jabber.org/streams&#39; version=&#39;1.0&#39;&#62;</span><br></pre></td></tr></table></figure>
<p>服务器日志输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ejabberd_receiver &#25509;&#25910;&#21040;&#23458;&#25143;&#31471;&#30340;&#27969;&#25171;&#24320;&#35831;&#27714;&#10;2014-09-26 05:22:31.527 [debug] &#60;0.849.0&#62;@ejabberd_receiver:process_data:343 Received XML on stream = &#60;&#60;&#34;&#60;stream:stream xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; xmlns=&#34;jabber:client&#34; to=&#34;xmpp.myserver.info&#34; version=&#34;1.0&#34;&#62;&#34;&#62;&#62;&#10;# &#26381;&#21153;&#22120;&#30830;&#35748;&#23458;&#25143;&#30340;&#27969;&#25171;&#24320;&#35831;&#27714;,&#36820;&#22238;&#19968;&#20010;&#21709;&#24212;&#10;2014-09-26 05:22:31.528 [debug] &#60;0.850.0&#62;@ejabberd_c2s:send_text:1869 Send XML on stream = &#60;&#60;&#34;&#60;?xml version=&#39;1.0&#39;?&#62;&#60;stream:stream xmlns=&#39;jabber:client&#39; xmlns:stream=&#39;http://etherx.jabber.org/streams&#39; id=&#39;3177127870&#39; from=&#39;xmpp.myserver.info&#39; version=&#39;1.0&#39; xml:lang=&#39;en&#39;&#62;&#34;&#62;&#62;&#10;# &#26381;&#21153;&#22120;&#36820;&#22238;&#21151;&#33021;&#30456;&#24212;&#10;2014-09-26 05:22:31.529 [debug] &#60;0.850.0&#62;@ejabberd_c2s:send_text:1869 Send XML on stream = &#60;&#60;&#34;&#60;stream:features&#62;&#60;mechanisms xmlns=&#39;urn:ietf:params:xml:ns:xmpp-sasl&#39;&#62;&#60;mechanism&#62;DIGEST-MD5&#60;/mechanism&#62;&#60;mechanism&#62;SCRAM-SHA-1&#60;/mechanism&#62;&#60;mechanism&#62;PLAIN&#60;/mechanism&#62;&#60;/mechanisms&#62;&#60;c xmlns=&#39;http://jabber.org/protocol/caps&#39; hash=&#39;sha-1&#39; node=&#39;http://www.process-one.net/en/ejabberd/&#39; ver=&#39;aIT+/ulfcbHXDKPkCA+iw9x5mU8=&#39;/&#62;&#60;register xmlns=&#39;http://jabber.org/features/iq-register&#39;/&#62;&#60;/stream:features&#62;&#34;&#62;&#62;</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>状态更新为<code>wait_for_feature_request</code>,等待接收<code>{xmlstreamstart, _Name, Attrs}</code>消息</p>
<h2 id="客户端认证">客户端认证</h2><p>客户端发送一个<code>&lt;auth&gt;</code>请求认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># auth&#20869;&#30340;&#25991;&#26412;&#20540;&#26080;&#25442;&#34892;&#21644;&#31354;&#26684;,&#36825;&#37324;&#20026;&#20102;&#21487;&#35835;&#24615;&#32780;&#26684;&#24335;&#21270;&#10;&#60;auth xmlns=&#39;urn:ietf:params:xml:ns:xmpp-sasl&#39; mechanism=&#39;SCRAM-SHA-1&#39;&#62;&#10;    biwsbj1yb290LHI9ZDQxZDhjZDk4ZjAwYjIwNGU5ODAwOTk4ZWNmODQyN2U=&#10;&#60;/auth&#62;</span><br></pre></td></tr></table></figure>
<p>服务器收到认证请求 并更新内部状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#23458;&#25143;&#31471;&#35831;&#27714;&#35748;&#35777;&#10;2014-09-26 05:22:31.543 [debug] &#60;0.849.0&#62;@ejabberd_receiver:process_data:343 Received XML on stream = &#60;&#60;&#34;&#60;auth xmlns=&#34;urn:ietf:params:xml:ns:xmpp-sasl&#34; mechanism=&#34;SCRAM-SHA-1&#34;&#62;biwsbj1yb290LHI9ZDQxZDhjZDk4ZjAwYjIwNGU5ODAwOTk4ZWNmODQyN2U=&#60;/auth&#62;&#34;&#62;&#62;&#10;# &#26356;&#26032;&#20869;&#37096;&#29366;&#24577;&#10;2014-09-26 05:22:31.543 [debug] &#60;0.849.0&#62;@shaper:update:117 State: &#123;maxrate,1000,0.0,1411708951528734&#125;, Size=138</span><br></pre></td></tr></table></figure>
<p>此时, <code>ejabberd_c2s</code>状态更新为<code>wait_for_sasl_response</code>, 同时返回<code>&lt;challenge&gt;</code>响应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># challenge&#20869;&#30340;&#25991;&#26412;&#20540;&#26080;&#25442;&#34892;&#21644;&#31354;&#26684;,&#36825;&#37324;&#20026;&#20102;&#21487;&#35835;&#24615;&#32780;&#26684;&#24335;&#21270;&#10;&#60;challenge&#10;    xmlns=&#34;urn:ietf:params:xml:ns:xmpp-sasl&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; version=&#34;1.0&#34;&#62;&#10;    cj1kNDFkOGNkOThmMDBiMjA0ZTk4MDA5...&#30465;&#30053;&#60;/challenge&#62;</span><br></pre></td></tr></table></figure>
<p>客户端响应<code>&lt;challenge&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;response&#10;    xmlns=&#39;urn:ietf:params:xml:ns:xmpp-sasl&#39;&#62;&#10;    Yz1iaXdzLHI9ZDQxZDhjZDk4ZjAw...&#30465;&#30053;&#60;/response&#62;</span><br></pre></td></tr></table></figure>
<p>服务器返回<code>&lt;success&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;success&#10;    xmlns=&#34;urn:ietf:params:xml:ns:xmpp-sasl&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;dj1saHU0SHBCZVVsc2Fla2dhUFN2cXlxZ3Jxdlk9&#60;/success&#62;</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>状态重新回到<code>wait_for_stream</code>,内部状态<code>StateData#state.authenticated</code>为非<code>false</code></p>
<h2 id="绑定资源">绑定资源</h2><p>客户端重新发送<code>&lt;stream&gt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;stream:stream&#10;    to=&#39;xmpp.myserver.info&#39;&#10;    xmlns=&#39;jabber:client&#39;&#10;    xmlns:stream=&#39;http://etherx.jabber.org/streams&#39;&#10;    version=&#39;1.0&#39;&#62;</span><br></pre></td></tr></table></figure>
<p>服务器确认,并发送功能节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;stream:stream xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    id=&#34;111324954&#34;&#10;    from=&#34;xmpp.myserver.info&#34;&#10;    version=&#34;1.0&#34;&#10;    xml:lang=&#34;en&#34;&#62;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;stream:features xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34; version=&#34;1.0&#34;&#62;&#10;  &#60;bind xmlns=&#34;urn:ietf:params:xml:ns:xmpp-bind&#34;/&#62;&#10;  &#60;session xmlns=&#34;urn:ietf:params:xml:ns:xmpp-session&#34;/&#62;&#10;  &#60;sm xmlns=&#34;urn:xmpp:sm:2&#34;/&#62;&#10;  &#60;sm xmlns=&#34;urn:xmpp:sm:3&#34;/&#62;&#10;  &#60;csi xmlns=&#34;urn:xmpp:csi:0&#34;/&#62;&#10;  &#60;c xmlns=&#34;http://jabber.org/protocol/caps&#34;&#10;    hash=&#34;sha-1&#34;&#10;    node=&#34;http://www.process-one.net/en/ejabberd/&#34;&#10;    ver=&#34;aIT+/ulfcbHXDKPkCA+iw9x5mU8=&#34;/&#62;&#10;  &#60;register xmlns=&#34;http://jabber.org/features/iq-register&#34;/&#62;&#10;&#60;/stream:features&#62;</span><br></pre></td></tr></table></figure>
<p>客户端选择绑定资源(资源由服务器生成)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;set&#39; id=&#39;_bind_auth_2&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;bind xmlns=&#39;urn:ietf:params:xml:ns:xmpp-bind&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>服务器应答</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq id=&#34;_bind_auth_2&#34;&#10;    type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;&#62;&#10;  &#60;bind xmlns=&#34;urn:ietf:params:xml:ns:xmpp-bind&#34;&#62;&#10;    &#60;jid&#62;root@xmpp.myserver.info/39189873701411708951913434&#60;/jid&#62;&#10;  &#60;/bind&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>客户端请求初始化会话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#39;set&#39; id=&#39;_session_auth_2&#39; xmlns=&#39;jabber:client&#39;&#62;&#10;  &#60;session xmlns=&#39;urn:ietf:params:xml:ns:xmpp-session&#39;/&#62;&#10;&#60;/iq&#62;</span><br></pre></td></tr></table></figure>
<p>服务器应答</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;iq type=&#34;result&#34;&#10;    xmlns=&#34;jabber:client&#34;&#10;    id=&#34;_session_auth_2&#34;&#10;    xmlns:stream=&#34;http://etherx.jabber.org/streams&#34;&#10;    version=&#34;1.0&#34;/&#62;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>发现一篇类似的分析博客<br><a href="http://my.oschina.net/hncscwc/blog/159826" target="_blank" rel="external">http://my.oschina.net/hncscwc/blog/159826</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T03:30:18.000Z"><a href="/2014/09/26/ejabberd-modules-development-deep/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/ejabberd-modules-development-deep/">Ejabberd模块开发, 简介</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd的内部模块以<code>插件</code>的方式工作. 每个模块是模块名称以<code>mod_</code>开头的<code>erlang模块</code>.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/26/ejabberd-modules-development-deep/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T01:15:57.000Z"><a href="/2014/09/26/ejabberd-modules-quickstart/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/ejabberd-modules-quickstart/">Ejabberd模块快速入门</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd是一个以Elang编程语言开发的开源XMPP服务器.过去很长时间,XMPP以构建即时通信应用程序闻名, 很多人用它来构建实时应用程序. 依赖预Erlang平台的并发特性,在选择XMPP服务器的时候,Ejabberd天生的就适合与处理大规模并发连接的应用环境.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/26/ejabberd-modules-quickstart/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-25T16:32:22.000Z"><a href="/2014/09/26/erlang-tail-recursion/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/erlang-tail-recursion/">Erlang 尾递归</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/erlang-php-for.png" alt="Elrang尾递归和PHP的for循环"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for(0)-&#62;&#10;        ok;&#10;for(N)-&#62;&#10;    io:format(&#34;running time: ~p ms ~n&#34;,&#10;        [merle:getkey(&#34;test&#34;)]),&#10;    for(N-1).</span><br></pre></td></tr></table></figure>
<p>另一种方式,采用列表,通过模式匹配<code>[Head|Tail]</code>的形式</p>

<!--￼1-->



      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T17:45:29.000Z"><a href="/2014/09/25/ejabberd-compile-issues/">2014-09-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/25/ejabberd-compile-issues/">编译Ejabberd遇到的问题</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="问题:_缺少libyaml库">问题: 缺少<code>libyaml</code>库</h2><p>办法: 安装需要的库</p>
<p>Ejabberd 从 13.10 开始配置文件的格式从Erlang Term转换到使用YAML格式, 需要用到libyaml来解析yaml文件.</p>
<p>浏览器打开: <a href="http://pyyaml.org/download/libyaml/" target="_blank" rel="external">http://pyyaml.org/download/libyaml/</a>, 找到最新版本的<code>libyaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://pyyaml.org/download/libyaml/yaml-0.1.6.tar.gz&#10;tar zxf yaml-0.1.6.tar.gz&#10;./configure&#10;make&#10;sudo make install</span><br></pre></td></tr></table></figure>
<h2 id="问题:_网络中断导致下载了不完整的deps/包,_比如deps/p1_yaml">问题: 网络中断导致下载了不完整的<code>deps/</code>包, 比如<code>deps/p1_yaml</code></h2><p>办法: 删除不完整的包,重新<code>make</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf deps/p1_yaml&#10;make</span><br></pre></td></tr></table></figure>
<h2 id="问题:_编译ejabberd模块找不到头文件的问题">问题: 编译ejabberd模块找不到头文件的问题</h2><p>办法: 网上很多介绍编译模块的方法是使用erlc编译模块, 使用<code>erlc</code>编译模块需要指明头文件,依赖库的路径,容易出错,编译自定义的ejabberd并没有这么麻烦,只要把写好了的ejabberd模块文件放到<code>$(EJABBERD)/src</code>目录下, 然后运行<code>make</code>, 生成的<code>.beam</code>文件会自动生成到<code>`$(EJABBERD)/ebin</code>目录下.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T16:51:59.000Z"><a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/">2014-09-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/">Ejabberd 编写一个简单的Echo服务模块</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文继续讨论Ejabberd的套接字架构,为了简化理解过程,一个一个Echo服务模块作为示例,它从客户端接收任何包,并把该包原封不动地回传给客户端.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T15:20:04.000Z"><a href="/2014/09/24/ejabberd-socket-infrastructure/">2014-09-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/24/ejabberd-socket-infrastructure/">Ejabberd 套接字基础架构</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd 是一个网络服务器, 那么套接字必然是通信的基础. 通过本文我们要搞清楚下面几个问题:</p>
<ol>
<li>Ejabberd 是如何工作的</li>
<li>如何Hack它获取自定义的特性</li>
</ol>
<p>本文分析的源码版本基于Ejabberd 2.1.10</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/24/ejabberd-socket-infrastructure/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/5/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/7/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/11/02/elixir-failover-and-takeover/">故障转移和接管</a>
      </li>
    
      <li>
        <a href="/2015/09/17/ejabberd-with-elixir-mix/">用Elixir Mix构建Ejabberd发行包</a>
      </li>
    
      <li>
        <a href="/2015/06/05/uftp/">UFTP - 基于UDP的加密文件多播传输协议</a>
      </li>
    
      <li>
        <a href="/2015/06/04/html5-web-cryptography-api-hashing/">Web加密API - 散列(Hashing)</a>
      </li>
    
      <li>
        <a href="/2015/06/04/the-3-modes-of-http-protocol/">HTTP协议的三种模式</a>
      </li>
    
      <li>
        <a href="/2015/05/21/ejabberd-with-elixir-packet-filters/">Ejabberd 用Elixir开发一个包过滤模块</a>
      </li>
    
      <li>
        <a href="/2015/05/18/chrome-dev-get-started/">Chrome 开发入门</a>
      </li>
    
      <li>
        <a href="/2015/05/18/html5-web-cryptography-api-tutorial/">Web加密API指南</a>
      </li>
    
      <li>
        <a href="/2015/05/17/html5-battery-status/">HTML5获取电池状态</a>
      </li>
    
      <li>
        <a href="/2015/05/10/ejabberd-mam-module-how-to-use/">如何使用Ejabberd消息归档模块</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Chrome/">Chrome</a><small>1</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>36</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTML5/">HTML5</a><small>3</small></li>
  
    <li><a href="/categories/HTTP/">HTTP</a><small>1</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>4</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Thrift/">Thrift</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>7</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/API/" style="font-size: 11.11px;">API</a> <a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a> <a href="/tags/Battery-Status/" style="font-size: 10px;">Battery Status</a> <a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a> <a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a> <a href="/tags/CURL/" style="font-size: 10px;">CURL</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a> <a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a> <a href="/tags/ETS/" style="font-size: 10px;">ETS</a> <a href="/tags/Ecto/" style="font-size: 11.11px;">Ecto</a> <a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a> <a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a> <a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a> <a href="/tags/H2O/" style="font-size: 10px;">H2O</a> <a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a> <a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a> <a href="/tags/Howto/" style="font-size: 10px;">Howto</a> <a href="/tags/Http-modes/" style="font-size: 10px;">Http modes</a> <a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a> <a href="/tags/I18n/" style="font-size: 10px;">I18n</a> <a href="/tags/IAB/" style="font-size: 10px;">IAB</a> <a href="/tags/ID3/" style="font-size: 10px;">ID3</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/IOT/" style="font-size: 10px;">IOT</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/Loopback/" style="font-size: 12.22px;">Loopback</a> <a href="/tags/MUC/" style="font-size: 10px;">MUC</a> <a href="/tags/Macro/" style="font-size: 12.22px;">Macro</a> <a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a> <a href="/tags/Mix/" style="font-size: 14.44px;">Mix</a> <a href="/tags/Modules/" style="font-size: 10px;">Modules</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a> <a href="/tags/OTP/" style="font-size: 12.22px;">OTP</a> <a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/PM2/" style="font-size: 10px;">PM2</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Phoenix/" style="font-size: 12.22px;">Phoenix</a> <a href="/tags/Pool/" style="font-size: 10px;">Pool</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/RESTFUL/" style="font-size: 11.11px;">RESTFUL</a> <a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a> <a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a> <a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a> <a href="/tags/Regex/" style="font-size: 10px;">Regex</a> <a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a> <a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a> <a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a> <a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a> <a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a> <a href="/tags/Task/" style="font-size: 10px;">Task</a> <a href="/tags/Thrift/" style="font-size: 11.11px;">Thrift</a> <a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a> <a href="/tags/UBF/" style="font-size: 10px;">UBF</a> <a href="/tags/UFTP/" style="font-size: 10px;">UFTP</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a> <a href="/tags/VAST/" style="font-size: 10px;">VAST</a> <a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a> <a href="/tags/Web-Cryptography-API/" style="font-size: 11.11px;">Web Cryptography API</a> <a href="/tags/XEP/" style="font-size: 16.67px;">XEP</a> <a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XMPP/" style="font-size: 17.78px;">XMPP</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/angular/" style="font-size: 16.67px;">angular</a> <a href="/tags/application/" style="font-size: 10px;">application</a> <a href="/tags/blockies/" style="font-size: 10px;">blockies</a> <a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a> <a href="/tags/bosh/" style="font-size: 12.22px;">bosh</a> <a href="/tags/ci/" style="font-size: 10px;">ci</a> <a href="/tags/container/" style="font-size: 11.11px;">container</a> <a href="/tags/data-management/" style="font-size: 10px;">data management</a> <a href="/tags/data-volume/" style="font-size: 10px;">data volume</a> <a href="/tags/debugging/" style="font-size: 10px;">debugging</a> <a href="/tags/devtools/" style="font-size: 10px;">devtools</a> <a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a> <a href="/tags/doc/" style="font-size: 10px;">doc</a> <a href="/tags/docker/" style="font-size: 15.56px;">docker</a> <a href="/tags/ejabberd/" style="font-size: 18.89px;">ejabberd</a> <a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a> <a href="/tags/emysql/" style="font-size: 11.11px;">emysql</a> <a href="/tags/encoding/" style="font-size: 10px;">encoding</a> <a href="/tags/erlang/" style="font-size: 12.22px;">erlang</a> <a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a> <a href="/tags/faq/" style="font-size: 10px;">faq</a> <a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a> <a href="/tags/gerrit/" style="font-size: 11.11px;">gerrit</a> <a href="/tags/gettext/" style="font-size: 10px;">gettext</a> <a href="/tags/git/" style="font-size: 12.22px;">git</a> <a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hero/" style="font-size: 10px;">hero</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/html5/" style="font-size: 10px;">html5</a> <a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a> <a href="/tags/iq/" style="font-size: 10px;">iq</a> <a href="/tags/jabber/" style="font-size: 10px;">jabber</a> <a href="/tags/javascript/" style="font-size: 11.11px;">javascript</a> <a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a> <a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a> <a href="/tags/library/" style="font-size: 10px;">library</a> <a href="/tags/linking/" style="font-size: 10px;">linking</a> <a href="/tags/lists/" style="font-size: 10px;">lists</a> <a href="/tags/load-balance/" style="font-size: 10px;">load balance</a> <a href="/tags/log4er/" style="font-size: 10px;">log4er</a> <a href="/tags/manage-images/" style="font-size: 10px;">manage images</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/muc/" style="font-size: 10px;">muc</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a> <a href="/tags/node-webkit/" style="font-size: 13.33px;">node-webkit</a> <a href="/tags/node-js/" style="font-size: 12.22px;">node.js</a> <a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a> <a href="/tags/notification/" style="font-size: 10px;">notification</a> <a href="/tags/npm/" style="font-size: 11.11px;">npm</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a> <a href="/tags/polymer/" style="font-size: 10px;">polymer</a> <a href="/tags/port/" style="font-size: 10px;">port</a> <a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a> <a href="/tags/rebar/" style="font-size: 10px;">rebar</a> <a href="/tags/record/" style="font-size: 10px;">record</a> <a href="/tags/recursion/" style="font-size: 10px;">recursion</a> <a href="/tags/regexp/" style="font-size: 10px;">regexp</a> <a href="/tags/relx/" style="font-size: 10px;">relx</a> <a href="/tags/screen/" style="font-size: 10px;">screen</a> <a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/stanza/" style="font-size: 10px;">stanza</a> <a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a> <a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a> <a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a> <a href="/tags/swagger/" style="font-size: 12.22px;">swagger</a> <a href="/tags/testing/" style="font-size: 10px;">testing</a> <a href="/tags/tls/" style="font-size: 10px;">tls</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/tsung/" style="font-size: 10px;">tsung</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a> <a href="/tags/varnish/" style="font-size: 10px;">varnish</a> <a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a> <a href="/tags/vt/" style="font-size: 10px;">vt</a> <a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a> <a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a> <a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a> <a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




