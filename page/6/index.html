
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 6 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-29T12:30:48.000Z"><a href="/2014/09/29/ejabberd-important-records/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-important-records/">Ejabberd中几个重要的Record结构</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd中几非常重要的记录结构, 贯穿整个Ejabberd的开发, 非常基础, 如果不能很好的理解,那么几乎不能很好的扩展Ejabberd的功能.</p>
<h2 id="jid"><code>jid</code></h2><p>Jabber 标识, 最基本的一个record结构, 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中,包含6个字段</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-record(jid, <span class="keyword">&#123;</span><span class="keyword">user</span> = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              server = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              resource = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              luser = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              lserver = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>(),</span><br><span class="line">              lresource = &lt;&lt;<span class="string">""</span>&gt;&gt; :: <span class="literal">binary</span>()<span class="keyword">&#125;</span>).</span><br></pre></td></tr></table></figure>
<h2 id="iq"><code>iq</code></h2><p>Info/Query 节, XMPP协议中三个基本的XML节之一, 并且是三个中最重要的一个, 大多数交互都是靠它来完成的. 定义在文件<code>$EJABBERD_SRC/include/jlib.hrl</code>中</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-record(iq, &#123;id = &lt;&lt;<span class="string">""</span>&gt;&gt;       :: binary(),</span><br><span class="line">             <span class="keyword">type</span> = get        :: get | <span class="type">set</span> | <span class="literal">result</span> | error,</span><br><span class="line">             xmlns = &lt;&lt;<span class="string">""</span>&gt;&gt;    :: binary(),</span><br><span class="line">             lang  = &lt;&lt;<span class="string">""</span>&gt;&gt;    :: binary(),</span><br><span class="line">             sub_el = <span class="comment">#xmlel&#123;&#125; :: xmlel() | [xmlel()]&#125;).</span></span><br></pre></td></tr></table></figure>
<h2 id="xmlel"><code>xmlel</code></h2><p>一个XML元素记录, 用于构造自定义XML节</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T16:10:06.000Z"><a href="/2014/09/29/ejabberd-route-table/">2014-09-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/29/ejabberd-route-table/">Ejabberd-路由表</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>ejabberd内部模块可以通过一个XMPP名称(<code>-define(PROCNAME, ejabberd_mod_echo).</code>),添加自身到服务器的路由表中,这些模块被称为<code>服务</code>,服务模块必须同时实现<code>gen_server</code>和<code>gen_mod</code>行为</p>
<h2 id="例子">例子</h2><p><a href="https://github.com/processone/ejabberd/blob/master/src/mod_echo.erl" target="_blank" rel="external">mod_echo.erl</a>是一个使用路由机制的例子.</p>
<h2 id="API">API</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="rule"><span class="attribute">ejabberd_router</span>:<span class="value"><span class="function">register_route</span>(Host)</span><br><span class="line">ejabberd_router:<span class="function">unregister_route</span>(Host),</span><br><span class="line">* Host = <span class="function">string</span>()</span></span></span><br></pre></td></tr></table></figure>
<h3 id="gen_server_API">gen_server API</h3><p>下面上个函数用作模块的API</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Host, Opts)</span></span> -&gt;</span><br><span class="line">    Proc = gen_mod:<span class="function"><span class="title">get_module_proc</span><span class="params">(Host, ?PROCNAME)</span></span>,</span><br><span class="line">    gen_server:<span class="function"><span class="title">start_link</span><span class="params">(&#123;local, Proc&#125;, ?MODULE, [Host, Opts], [])</span></span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function_or_atom">start</span>(<span class="variable">Host</span>, <span class="variable">Opts</span>) <span class="arrow">-&gt;</span></span><br><span class="line">    <span class="variable">Proc</span> = <span class="function_or_atom">gen_mod:get_module_proc</span>(<span class="variable">Host</span>, <span class="constant">?PROCNAME</span>),</span><br><span class="line">    <span class="variable">ChildSpec</span> = &#123;<span class="variable">Proc</span>,&#123;<span class="constant">?MODULE</span>, <span class="function_or_atom">start_link</span>, [<span class="variable">Host</span>, <span class="variable">Opts</span>]&#125;, <span class="function_or_atom">temporary</span>, <span class="number">1000</span>, <span class="function_or_atom">worker</span>, [<span class="constant">?MODULE</span>]&#125;,</span><br><span class="line">    <span class="function_or_atom">supervisor:start_child</span>(<span class="function_or_atom">ejabberd_sup</span>, <span class="variable">ChildSpec</span>).</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">stop</span><span class="params">(Host)</span></span> -&gt;</span><br><span class="line">    Proc = gen_mod:<span class="function"><span class="title">get_module_proc</span><span class="params">(Host, ?PROCNAME)</span></span>,</span><br><span class="line">    gen_server:<span class="function"><span class="title">call</span><span class="params">(Proc, stop)</span></span>,</span><br><span class="line">    supervisor:<span class="function"><span class="title">terminate_child</span><span class="params">(ejabberd_sup, Proc)</span></span>,</span><br><span class="line">    supervisor:<span class="function"><span class="title">delete_child</span><span class="params">(ejabberd_sup, Proc)</span></span>.</span><br></pre></td></tr></table></figure>
<h3 id="gen_server_回调">gen_server 回调</h3><p>下面的函数必须定义并导出.</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">init([Host, Opts]) -&gt; &#123;ok, State&#125; <span class="string">|</span></span><br><span class="line">                      &#123;ok, State, Timeout&#125; <span class="string">|</span></span><br><span class="line">                      ignore <span class="string">|</span></span><br><span class="line">                      &#123;stop, Reason&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">handle_info(Info, State) -&gt; <span class="list">&#123;noreply, State&#125;</span> |</span><br><span class="line">                            <span class="list">&#123;noreply, State, Timeout&#125;</span> |</span><br><span class="line">                            <span class="list">&#123;stop, Reason, State&#125;</span></span><br><span class="line">* Info = <span class="list">&#123;route, From, To, Packet&#125;</span></span><br><span class="line">* To = From = #jid (see jlib core module)</span><br><span class="line">* Packet = <span class="list">&#123;xmlelement, Name, Attrs, SubEl&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">terminate</span><span class="params">(Reason, State)</span></span> -&gt; <span class="function"><span class="title">void</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(stop, <span class="variable">_From</span>, <span class="variable">State</span>)</span> -&gt;</span> <span class="tuple">&#123;stop, normal, ok, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(<span class="variable">_Msg</span>, <span class="variable">State</span>)</span> -&gt;</span> <span class="tuple">&#123;noreply, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">code_change</span><span class="params">(<span class="variable">_OldVsn</span>, <span class="variable">State</span>, <span class="variable">_Extra</span>)</span> -&gt;</span> <span class="tuple">&#123;ok, <span class="variable">State</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<p><code>init</code>函数用于初始化模块.<code>Host</code>为模块所在虚拟主机名称,<code>Opts</code>为在配置文件中设置的模块选项,这些选项可以通过<strong><a href="https://www.process-one.net/en/wiki/gen_mod" target="_blank" rel="external">gen_mod:get_opt/3</a></strong>函数获取.<strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:register_route/1</a></strong>函数在<code>init</code>回调中执行.</p>
<p><code>terminate/2</code>用于停止模块. <code>ejabberd_router:unregister_route</code>函数在此回调中被调用.</p>
<p><code>handle_info/2</code>用于获取发送给该模块的XMPP包. <strong><a href="https://www.process-one.net/en/wiki/ejabberd_router" target="_blank" rel="external">ejabberd_router:route/1</a></strong>用于对包进行重新路由.</p>
<p>All other callbacks can be written as shown above.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T15:28:55.000Z"><a href="/2014/09/28/ejabberd-iq-handlers/">2014-09-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/28/ejabberd-iq-handlers/">Ejabberd-IQ节处理程序</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd内部模块可以注册自身,并使用指定名称空间处理IQ节, 其方法类似于<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a>这种机制.</p>
<p>模块<a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">mod_last.erl</a>就使用了这种机制, 同时也使用了<a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">事件和钩子</a></p>
<h2 id="API">API</h2><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gen_iq_handler:add_iq_handler(Scope, Host, <span class="keyword">Namespace</span>, <span class="keyword">Module</span>, <span class="function"><span class="keyword">Function</span>, <span class="title">IQDisc</span>)</span><br><span class="line"><span class="title">gen_iq_handler</span>:</span>remove_iq_handler(Scope, Host, <span class="keyword">Namespace</span>, <span class="keyword">Module</span>, <span class="function"><span class="keyword">Function</span>, <span class="title">IQDisc</span>)</span><br><span class="line">* <span class="title">Scope</span> = <span class="title">ejabberd_local</span> | <span class="title">ejabberd_sm</span></span><br><span class="line">* <span class="title">Namespace</span> = <span class="title">string</span><span class="params">()</span> <span class="params">(某些名称空间宏定义在jlib.hrl头文件中)</span></span><br><span class="line">* <span class="title">Host</span> = <span class="title">string</span><span class="params">()</span></span><br><span class="line">* <span class="title">Module</span> = <span class="title">atom</span><span class="params">()</span></span><br><span class="line">* <span class="title">Fonction</span> = <span class="title">atom</span><span class="params">()</span></span><br><span class="line">* <span class="title">IQDisc</span> = <span class="title">no_queue</span> | <span class="title">one_queue</span> | <span class="comment">&#123;queues, N&#125;</span> | <span class="title">parallel</span></span><br><span class="line">* <span class="title">N</span> = <span class="title">integer</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p><strong>ejabberd_local</strong>作用域用于注册发到服务器本身的<strong>IQ</strong>.<br><strong>ejabberd_sm</strong>作用域用于注册发送到一个账号的<strong>纯JID</strong>(Bare JID)的<strong>IQ</strong>,<strong>Host</strong>为与该<strong>IQ</strong>相关的虚拟主机名称.</p>
<p><strong>Module</strong>和<strong>Function</strong>描述了一个处理器函数,当收到<strong>指定名称空间的IQ节</strong>时,该函数被调用.该处理器函数必须具有如下声明:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Module</span>:<span class="keyword">Function</span>(<span class="keyword">From</span>, <span class="keyword">To</span>, IQ) -&gt; IQ</span><br><span class="line">* <span class="keyword">From</span> = <span class="keyword">To</span> = <span class="preprocessor">#jid</span></span><br><span class="line">* IQ = <span class="preprocessor">#iq</span></span><br></pre></td></tr></table></figure>
<p>处理函数返回结果IQ (IQ-result), IQDisc描述当前IQ如何处理:</p>
<p><strong>no_queue</strong>: 不创建新线程运行该处理程序<br><strong>one_queue</strong>: 创建一个专用线程运行该处理程序<br><strong>{queues, N}</strong>: 创建<strong>N</strong>个线程运行该处理程序<br><strong>parallel</strong>: 对每一个接收到的IQ创建一个线程</p>
<h2 id="IQ处理模块模板">IQ处理模块模板</h2><p>修改以适应Ejabberd <strong>14.07</strong></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">-module(mod_iqtest).</span><br><span class="line">-behaviour(gen_mod).</span><br><span class="line">-<span class="keyword">export</span>([start/<span class="number">2</span>, stop/<span class="number">1</span>,</span><br><span class="line">  process_sm_iq/<span class="number">3</span> %% I assume this <span class="keyword">is</span> needed to handle <span class="type">JID</span> to <span class="type">JID</span> communication <span class="keyword">of</span> the <span class="type">IQ</span>?</span><br><span class="line">]).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"ejabberd.hrl"</span>).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"jlib.hrl"</span>).</span><br><span class="line">-<span class="keyword">include</span>(<span class="string">"logger.hrl"</span>).</span><br><span class="line">-define(<span class="type">NS_TEST</span>, <span class="string">"http://jabber.org/protocol/test"</span>).</span><br><span class="line">-define(<span class="type">NS_TEST2</span>, <span class="string">"http://jabber.org/protocol/test2"</span>).</span><br><span class="line">start(<span class="type">Host</span>, <span class="type">Opts</span>) -&gt;</span><br><span class="line">  <span class="type">IQDisc</span> = gen_mod:get_opt(</span><br><span class="line">    iqdisc,</span><br><span class="line">    <span class="type">Opts</span>,</span><br><span class="line">    fun gen_iq_handler:check_type/<span class="number">1</span>,</span><br><span class="line">    one_queue</span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:add_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST</span>, ?<span class="type">MODULE</span>, process_sm_iq, <span class="type">IQDisc</span></span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:add_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST2</span>, ?<span class="type">MODULE</span>, process_sm_iq, <span class="type">IQDisc</span></span><br><span class="line">  ),</span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Loading module 'mod_iqtest' v.01"</span>, []).</span><br><span class="line">stop(<span class="type">Host</span>) -&gt;</span><br><span class="line">  gen_iq_handler:remove_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST</span></span><br><span class="line">  ),</span><br><span class="line">  gen_iq_handler:remove_iq_handler(</span><br><span class="line">    ejabberd_sm, <span class="type">Host</span>, ?<span class="type">NS_TEST2</span></span><br><span class="line">  ),</span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Stoping module 'mod_iqtest' "</span>, []).</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = get, xmlns = ?NS_TEST&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Get query:~n ~p"</span>, [<span class="type">IQ</span>]),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = [&#123;xmlelement, <span class="string">"value"</span>, [], [&#123;xmlcdata, <span class="string">"Hello World of Testing."</span>&#125;]&#125;]</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = get, xmlns = ?NS_TEST2&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Get query of namespace 2:~n ~p"</span>, [<span class="type">IQ</span>]),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = [&#123;xmlelement, <span class="string">"value"</span>, [], [&#123;xmlcdata, <span class="string">"Hello World of Test 2."</span>&#125;]&#125;]</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;type = set&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ Set: it does nothing"</span>, []),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = <span class="literal">result</span>, sub_el = []</span><br><span class="line">  &#125;;</span><br><span class="line">process_sm_iq(_From, _To, <span class="comment">#iq&#123;sub_el = SubEl&#125; = IQ) -&gt;</span></span><br><span class="line">  ?<span class="type">INFO_MSG</span>(<span class="string">"Processing IQ other type: it does nothing"</span>, []),</span><br><span class="line">  <span class="type">IQ</span><span class="comment">#iq&#123;</span></span><br><span class="line">    <span class="keyword">type</span> = error, sub_el = [<span class="type">SubEl</span>, ?<span class="type">ERR_FEATURE_NOT_IMPLEMENTED</span>]</span><br><span class="line">  &#125;.</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>IQ处理程序模板<br><a href="https://www.ejabberd.im/node/5035?q=node/5035" target="_blank" rel="external">https://www.ejabberd.im/node/5035?q=node/5035</a></li>
<li>Ejabberd事件和钩子<br><a href="https://www.process-one.net/en/wiki/ejabberd_events_and_hooks" target="_blank" rel="external">https://www.process-one.net/en/wiki/ejabberd_events_and_hooks</a></li>
<li>mod_last模块<br><a href="https://github.com/processone/ejabberd/blob/master/src/mod_last.erl" target="_blank" rel="external">https://github.com/processone/ejabberd/blob/master/src/mod_last.erl</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-28T05:05:43.000Z"><a href="/2014/09/28/ejabberd-jiffy/">2014-09-28</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/28/ejabberd-jiffy/">Ejabberd中用Jiffy输出JSON数据</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">1.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一个例子"><span class="toc-number">2.</span> <span class="toc-text">一个例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造复杂JSON对象"><span class="toc-number">3.</span> <span class="toc-text">构造复杂JSON对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Erlang和JSON格式对照表"><span class="toc-number">3.1.</span> <span class="toc-text">Erlang和JSON格式对照表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#示例代码"><span class="toc-number">3.2.</span> <span class="toc-text">示例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出"><span class="toc-number">3.3.</span> <span class="toc-text">输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#变更"><span class="toc-number">4.</span> <span class="toc-text">变更</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2014-10-04"><span class="toc-number">4.1.</span> <span class="toc-text">2014-10-04</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>警告! 使用Jiffy需要特别注意,其实现为NIF,可能导致Erlang VM崩溃.</p>
<h2 id="编译">编译</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /tmp</span><br><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/processone/ejabberd.git</span><br><span class="line"><span class="keyword">cd</span> ejabberd</span><br><span class="line">chmod +<span class="keyword">x</span> autogen.<span class="keyword">sh</span></span><br><span class="line">./autogen.<span class="keyword">sh</span></span><br><span class="line">./configure --enable-json --enable-mysql</span><br><span class="line"><span class="keyword">make</span></span><br><span class="line"><span class="keyword">make</span> install</span><br></pre></td></tr></table></figure>
<p><code>jiffy.so</code>路径有个Bug,写作本文时,该BUG暂未解决. 请参考:<br><a href="https://github.com/processone/ejabberd/issues/309" target="_blank" rel="external">https://github.com/processone/ejabberd/issues/309</a>,<br>要解决此问题, 执行:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="regexp">/lib/</span>ejabberd<span class="regexp">/priv/</span>lib<span class="regexp">/jiffy.so /</span>lib<span class="regexp">/ejabberd/</span>priv<span class="regexp">/jiffy.so</span></span><br></pre></td></tr></table></figure>
<h2 id="一个例子">一个例子</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(mod_online_users)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-author</span><span class="params">('hezhiqiang')</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-behaviour</span><span class="params">(gen_mod)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-export</span><span class="params">([</span><br><span class="line">    start/<span class="number">2</span>,</span><br><span class="line">    stop/<span class="number">1</span>,</span><br><span class="line">    process/<span class="number">2</span></span><br><span class="line">])</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"jlib.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"ejabberd_http.hrl"</span>)</span></span>.</span><br><span class="line"><span class="pp"><span class="keyword">-include</span><span class="params">(<span class="string">"logger.hrl"</span>)</span></span>.</span><br><span class="line"><span class="comment">%% 处理函数,直接返回要输出到浏览器的内容</span></span><br><span class="line"><span class="function"><span class="title">process</span><span class="params">(<span class="variable">_LocalPath</span>, <span class="variable">_Request</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">Users</span> = <span class="function_name">mnesia:table_info</span>(session, size),</span><br><span class="line">    <span class="variable">OnlineUsers</span> = <span class="function_name">jiffy:encode</span>(<span class="tuple">&#123;[<span class="tuple">&#123;&lt;&lt;<span class="string">"onlineusers"</span>&gt;&gt;, <span class="variable">Users</span>&#125;</span>]&#125;</span>),</span><br><span class="line">    <span class="tuple">&#123;<span class="number">200</span>, [], <span class="variable">OnlineUsers</span>&#125;</span>.</span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(<span class="variable">_Host</span>, <span class="variable">_Opts</span>)</span> -&gt;</span></span><br><span class="line">    ?<span class="variable">INFO_MSG</span>(<span class="string">"===Starting module mod_online_users==="</span>, []),</span><br><span class="line">    ok.</span><br><span class="line"><span class="function"><span class="title">stop</span><span class="params">(<span class="variable">_Host</span>)</span> -&gt;</span></span><br><span class="line">    ?<span class="variable">INFO_MSG</span>(<span class="string">"===Stopping module mod_online_users==="</span>, []),</span><br><span class="line">    ok.</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/ejabberd/ejabberd.yml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">  port: <span class="number">5280</span></span><br><span class="line">  module: ejabberd_http</span><br><span class="line">  request_handlers:</span><br><span class="line">    <span class="string">"/pub/archive"</span>: mod_http_fileserver</span><br><span class="line">    <span class="string">"/http-bind/"</span>: mod_http_<span class="built_in">bind</span></span><br><span class="line">    <span class="string">"admin"</span>: ejabberd_web_admin</span><br><span class="line">    <span class="string">"online"</span>: mod_online_users</span><br><span class="line">  web_admin: <span class="literal">true</span></span><br><span class="line">  http_poll: <span class="literal">true</span></span><br><span class="line">  http_<span class="built_in">bind</span>: <span class="literal">true</span></span><br><span class="line">  captcha: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ejabberdctl</span> restart</span><br></pre></td></tr></table></figure>
<p>访问</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http:</span><span class="comment">//192.168.8.132:5280/online/</span></span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/9058AA0F-5ECA-4FCD-84BB-9CFAD161991F.png" alt="在线用户数模块"></p>
<h2 id="构造复杂JSON对象">构造复杂JSON对象</h2><h3 id="Erlang和JSON格式对照表">Erlang和JSON格式对照表</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Erlang                          JSON            Erlang</span><br><span class="line">==========================================================================</span><br><span class="line">null                       -&gt; null           -&gt; null</span><br><span class="line"><span class="keyword">true</span>                       -&gt; <span class="keyword">true</span>           -&gt; <span class="keyword">true</span></span><br><span class="line"><span class="keyword">false</span>                      -&gt; <span class="keyword">false</span>          -&gt; <span class="keyword">false</span></span><br><span class="line"><span class="string">"hi"</span>                       -&gt; [<span class="number">104</span>, <span class="number">105</span>]     -&gt; [<span class="number">104</span>, <span class="number">105</span>]</span><br><span class="line">&lt;&lt;<span class="string">"hi"</span>&gt;&gt;                   -&gt; <span class="string">"hi"</span>           -&gt; &lt;&lt;<span class="string">"hi"</span>&gt;&gt;</span><br><span class="line">hi                         -&gt; <span class="string">"hi"</span>           -&gt; &lt;&lt;<span class="string">"hi"</span>&gt;&gt;</span><br><span class="line"><span class="number">1</span>                          -&gt; <span class="number">1</span>              -&gt; <span class="number">1</span></span><br><span class="line"><span class="number">1.25</span>                       -&gt; <span class="number">1.25</span>           -&gt; <span class="number">1.25</span></span><br><span class="line">[]                         -&gt; []             -&gt; []</span><br><span class="line">[<span class="keyword">true</span>, <span class="number">1.0</span>]                -&gt; [<span class="keyword">true</span>, <span class="number">1.0</span>]    -&gt; [<span class="keyword">true</span>, <span class="number">1.0</span>]</span><br><span class="line">&#123;[]&#125;                       -&gt; &#123;&#125;             -&gt; &#123;[]&#125;</span><br><span class="line">&#123;[&#123;foo, bar&#125;]&#125;             -&gt; &#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125; -&gt; &#123;[&#123;&lt;&lt;<span class="string">"foo"</span>&gt;&gt;, &lt;&lt;<span class="string">"bar"</span>&gt;&gt;&#125;]&#125;</span><br><span class="line">&#123;[&#123;&lt;&lt;<span class="string">"foo"</span>&gt;&gt;, &lt;&lt;<span class="string">"bar"</span>&gt;&gt;&#125;]&#125; -&gt; &#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125; -&gt; &#123;[&#123;&lt;&lt;<span class="string">"foo"</span>&gt;&gt;, &lt;&lt;<span class="string">"bar"</span>&gt;&gt;&#125;]&#125;</span><br><span class="line">#&#123;&lt;&lt;<span class="string">"foo"</span>&gt;&gt; =&gt; &lt;&lt;<span class="string">"bar"</span>&gt;&gt;&#125;  -&gt; &#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125; -&gt; #&#123;&lt;&lt;<span class="string">"foo"</span>&gt;&gt; -&gt; &lt;&lt;<span class="string">"bar"</span>&gt;&gt;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例代码">示例代码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">process</span><span class="params">(<span class="variable">_LocalPath</span>, <span class="variable">_Request</span>)</span> -&gt;</span></span><br><span class="line">    <span class="variable">ConnectedUsersNumber</span> = <span class="function_name">ejabberd_sm:connected_users_number</span>(),</span><br><span class="line">    <span class="comment">%% 获取在线用户列表</span></span><br><span class="line">    <span class="variable">AllSessionList</span> = <span class="function_name">ejabberd_sm:dirty_get_sessions_list</span>(),</span><br><span class="line">    <span class="comment">%% 构造JSON对象数组</span></span><br><span class="line">    <span class="variable">AllSessions</span> = <span class="function_name">lists:map</span>(<span class="keyword">fun</span>(<span class="tuple">&#123;<span class="variable">User</span>, <span class="variable">Server</span>, <span class="variable">Resource</span>&#125;</span>) -&gt;</span><br><span class="line">        <span class="tuple">&#123;[<span class="tuple">&#123;user, <span class="variable">User</span>&#125;</span>, <span class="tuple">&#123;server, <span class="variable">Server</span>&#125;</span>, <span class="tuple">&#123;resource, <span class="variable">Resource</span>&#125;</span>]&#125;</span></span><br><span class="line">    <span class="keyword">end</span>, <span class="variable">AllSessionList</span>),</span><br><span class="line">    <span class="comment">%% 编码JSON格式</span></span><br><span class="line">    <span class="variable">Json</span> = <span class="function_name">jiffy:encode</span>(<span class="tuple">&#123;[</span><br><span class="line">        <span class="tuple">&#123;connected_users_number, <span class="variable">ConnectedUsersNumber</span>&#125;</span>,</span><br><span class="line">        <span class="tuple">&#123;sessions, <span class="variable">AllSessions</span>&#125;</span></span><br><span class="line">    ]&#125;</span>),</span><br><span class="line">    <span class="tuple">&#123;<span class="number">200</span>, [], <span class="variable">Json</span>&#125;</span>.</span><br></pre></td></tr></table></figure>
<h3 id="输出">输出</h3><p>把上面的代码和下面的输出对照理解.</p>
<p><img src="/assets/images/BB5D080B-5B6B-43EE-A8DF-0E7DEBE7BAF4.png" alt="JSON输出"></p>
<h2 id="变更">变更</h2><h3 id="2014-10-04">2014-10-04</h3><p>调用<code>mnesia:system_info(all).</code>获取Mnesia数据库信息, 下面是返回的<code>Term</code>:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">[</span><br><span class="line">    <span class="collection">&#123;access_module,mnesia&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;auto_repair,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;backup_module,mnesia_backup&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;checkpoints,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;db_nodes,<span class="collection">[ejabberd@localhost]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;debug,none&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;directory,<span class="string">"/var/lib/ejabberd"</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;dump_log_load_regulation,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;dump_log_time_threshold,<span class="number">180000</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;dump_log_update_in_place,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;dump_log_write_threshold,<span class="number">1000</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;event_module,mnesia_event&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;extra_db_nodes,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;fallback_activated,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;held_locks,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;ignore_fallback_at_startup,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;fallback_error_function,<span class="collection">&#123;mnesia,lkill&#125;</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;is_running,yes&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;local_tables,<span class="collection">[</span><br><span class="line">        shaper,</span><br><span class="line">        mod_register_ip,local_config,caps_features,acl,</span><br><span class="line">        access,carboncopy,http_bind,reg_users_counter,pubsub_subscription,bytestream,</span><br><span class="line">        privacy,passwd,irc_custom,roster,last_activity,sr_user,roster_version,</span><br><span class="line">        pubsub_last_item,offline_msg,route,motd,s2s,vcard,pubsub_index,sr_group,</span><br><span class="line">        session_counter,vcard_search,motd_users,schema,session,private_storage,</span><br><span class="line">        pubsub_item,muc_room,pubsub_state,iq_response,temporarily_blocked,</span><br><span class="line">        muc_registered,muc_online_room,pubsub_node</span><br><span class="line">    ]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;lock_queue,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;log_version,<span class="string">"4.3"</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;master_node_tables,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;max_wait_for_decision,infinity&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;protocol_version,<span class="collection">&#123;<span class="number">8</span>,<span class="number">1</span>&#125;</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;running_db_nodes,<span class="collection">[ejabberd@localhost]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;schema_location,opt_disc&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;schema_version,<span class="collection">&#123;<span class="number">2</span>,<span class="number">0</span>&#125;</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;subscribers,<span class="collection">[&lt;0.15778.0&gt;,&lt;0.16018.0&gt;,&lt;0.15961.0&gt;,&lt;0.15954.0&gt;]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;tables,<span class="collection">[</span><br><span class="line">        carboncopy,http_bind,reg_users_counter,pubsub_subscription,bytestream,</span><br><span class="line">        privacy,local_config,passwd,irc_custom,shaper,roster,last_activity,</span><br><span class="line">        sr_user,roster_version,pubsub_last_item,offline_msg,route,motd,</span><br><span class="line">        access,acl,s2s,vcard,pubsub_index,caps_features,sr_group,session_counter,</span><br><span class="line">        mod_register_ip,vcard_search,motd_users,schema,session,private_storage,</span><br><span class="line">        pubsub_item,muc_room,pubsub_state,iq_response,temporarily_blocked,</span><br><span class="line">        muc_registered,muc_online_room,pubsub_node</span><br><span class="line">    ]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;transaction_commits,<span class="number">56</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;transaction_failures,<span class="number">81</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;transaction_log_writes,<span class="number">0</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;transaction_restarts,<span class="number">0</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;transactions,<span class="collection">[]</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;use_dir,<span class="literal">true</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;core_dir,<span class="literal">false</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;no_table_loaders,<span class="number">2</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;dc_dump_limit,<span class="number">4</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;send_compressed,<span class="number">0</span>&#125;</span>,</span><br><span class="line">    <span class="collection">&#123;version,<span class="string">"4.12.3"</span>&#125;</span></span><br><span class="line">]</span></span><br></pre></td></tr></table></figure>
<p><code>process/2</code>函数修改为:</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">process<span class="function"><span class="params">(_LocalPath, _Request)</span> -&gt;</span></span><br><span class="line">    ConnectedUsersNumber = <span class="attribute">ejabberd_sm</span>:connected_users_number(),</span><br><span class="line">    %% 用户列表</span><br><span class="line">    AllSessionList = <span class="attribute">ejabberd_sm</span>:dirty_get_sessions_list(),</span><br><span class="line">    ?DEBUG(<span class="string">"All sessions ~p~n"</span>, [AllSessionList]),</span><br><span class="line">    %% Mnesia 表信息</span><br><span class="line">    MnesiaSystemInfo = <span class="attribute">mnesia</span>:system_info(all),</span><br><span class="line">    ?DEBUG(<span class="string">"Mnesia Information ~p~n"</span>, [MnesiaSystemInfo]),</span><br><span class="line">    %% [&#123;&lt;&lt;<span class="string">"root"</span>&gt;&gt;,&lt;&lt;<span class="string">"xmpp.myserver.info"</span>&gt;&gt;,&lt;&lt;<span class="string">"3439698832141213525690305"</span>&gt;&gt;&#125;]</span><br><span class="line">    %% 构造一个JSON对象数组</span><br><span class="line">    %% 对象: &#123;[]&#125;</span><br><span class="line">    %% 数组: []</span><br><span class="line">    AllSessions = <span class="attribute">lists</span>:map<span class="function"><span class="params">(fun(&#123;User, Server, Resource&#125;) -&gt;</span><br><span class="line">        &#123;[&#123;user, User&#125;, &#123;server, Server&#125;, &#123;resource, Resource&#125;]&#125;</span><br><span class="line">    end, AllSessionList)</span>,</span><br><span class="line">    <span class="title">RemoveElements</span> = [<span class="title">subscribers</span>, <span class="title">fallback_error_function</span>],</span><br><span class="line">    <span class="title">MnesiaSystemInfoJiffy</span> = <span class="title">lists</span>:<span class="title">filtermap</span><span class="params">(fun(&#123;Key, Value&#125;) -&gt;</span><br><span class="line">        <span class="keyword">case</span> lists:any(fun(E2) -&gt; E2 =:= Key end, RemoveElements) <span class="keyword">of</span></span><br><span class="line">            <span class="literal">true</span> -&gt;</span><br><span class="line">                <span class="literal">false</span>;</span><br><span class="line">            <span class="literal">false</span> -&gt;</span><br><span class="line">                <span class="keyword">case</span> Key <span class="keyword">of</span></span><br><span class="line">                    directory -&gt;</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, list_to_bitstring(Value)&#125;&#125;;</span><br><span class="line">                    version -&gt;</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, list_to_bitstring(Value)&#125;&#125;;</span><br><span class="line">                    log_version -&gt;</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, list_to_bitstring(Value)&#125;&#125;;</span><br><span class="line">                    schema_version -&gt;</span><br><span class="line">                        &#123;V1, V2&#125; = Value,</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, list_to_bitstring([integer_to_list(V1), <span class="string">"."</span>, integer_to_list(V2)])&#125;&#125;;</span><br><span class="line">                    protocol_version -&gt;</span><br><span class="line">                        &#123;V1, V2&#125; = Value,</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, list_to_bitstring([integer_to_list(V1), <span class="string">"."</span>, integer_to_list(V2)])&#125;&#125;;</span><br><span class="line">                    _ -&gt;</span><br><span class="line">                        &#123;<span class="literal">true</span>, &#123;Key, Value&#125;&#125;</span><br><span class="line">                end</span><br><span class="line">        end</span><br><span class="line">    end, MnesiaSystemInfo)</span>,</span><br><span class="line">    <span class="title">Json</span> = <span class="title">jiffy</span>:<span class="title">encode</span><span class="params">(&#123;[</span><br><span class="line">        &#123;connected_users_number, ConnectedUsersNumber&#125;,</span><br><span class="line">        &#123;sessions, AllSessions&#125;,</span><br><span class="line">        &#123;mnesia, &#123;MnesiaSystemInfoJiffy&#125;&#125;</span><br><span class="line">    ]&#125;)</span>,</span><br><span class="line">    &#123;200, [], <span class="title">Json</span>&#125;.</span></span><br></pre></td></tr></table></figure>
<p>JSON输出由JSON View Formater格式化<br><a href="https://chrome.google.com/webstore/detail/hdmbdioamgdkppmocchpkjhbpfmpjiei" target="_blank" rel="external">https://chrome.google.com/webstore/detail/hdmbdioamgdkppmocchpkjhbpfmpjiei</a></p>
<p><img src="/assets/images/3C50996B-E5DA-4574-83E7-C9B237DD9587.png" alt="Mnesia系统信息JSON数据"></p>
<p>注意<code>lists:filtermap</code>返回的是元组列表, 列表中的每个元素是一个元组, 每个元组包含两个项, <code>lists:filtermap</code>函数是<code>lists:filter</code>(过滤)和<code>lists:map</code>(映射)两个函数功能上的合并:<code>过滤并映射</code></p>
<p>这里例子中有部分值为空<code>[]</code>, 比如<code>checkpoints</code>, 当包含值的时候<code>可能</code>需要按照Jiffy方式转换类型.</p>
<p>完整代码如下:<br><a href="https://gist.github.com/553129e3015995b56028" target="_blank" rel="external">https://gist.github.com/553129e3015995b56028</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://github.com/davisp/jiffy" target="_blank" rel="external">https://github.com/davisp/jiffy</a></li>
<li><a href="http://www.erlang.org/doc/man/lists.html" target="_blank" rel="external">http://www.erlang.org/doc/man/lists.html</a></li>
<li><a href="http://www.erlang.org/doc/man/mnesia.html" target="_blank" rel="external">http://www.erlang.org/doc/man/mnesia.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T17:30:40.000Z"><a href="/2014/09/27/ejabberd-c2s-basic/">2014-09-27</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/27/ejabberd-c2s-basic/">Ejabberd  C2S模块状态分析</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Ejabberd的<code>ejabberd_c2s</code>核心模块,是处理XMPP协议的核心处理模块,本文通过客户端和服务器的交互过程来分析其原理.</p>
<h2 id="建立TCP连接">建立TCP连接</h2><p>客户端建立TCP连接<code>ejabberd_listener</code>接受TCP连接,服务器日志输出</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="tag">ejabberd_listener</span> 接收到客户端的<span class="tag">TCP</span>连接请求</span><br><span class="line">2014<span class="tag">-09-26</span> 05<span class="pseudo">:22</span><span class="pseudo">:31</span><span class="class">.527</span> <span class="attr_selector">[info]</span> &lt;0<span class="class">.673</span><span class="class">.0</span>&gt;<span class="at_rule">@<span class="keyword">ejabberd_listener:accept:313</span> (#Port&lt;<span class="number">0.5846</span>&gt;) Accepted connection <span class="number">172.17</span>.<span class="number">42.1</span>:<span class="number">53457</span> -&gt; <span class="number">172.17</span>.<span class="number">0.27</span>:<span class="number">5222</span></span></span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>进程初始状态为<code>wait_for_stream</code>,等待接收<code>{xmlstreamstart, _Name, Attrs}</code>消息</p>
<h2 id="客户端打开流">客户端打开流</h2><p>客户端发送打开流Stanza</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">stream:</span>stream to=<span class="string">'xmpp.myserver.info'</span> xmlns=<span class="string">'jabber:client'</span> <span class="string">xmlns:</span>stream=<span class="string">'http://etherx.jabber.org/streams'</span> version=<span class="string">'1.0'</span>&gt;</span><br></pre></td></tr></table></figure>
<p>服务器日志输出为</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"># ejabberd_receiver 接收到客户端的流打开请求</span><br><span class="line">2014-09-26 05:22:31.527 [debug] <span class="tag">&lt;<span class="title">0.849.0</span>&gt;</span>@ejabberd_receiver:process_data:343 Received XML on stream = <span class="tag">&lt;&lt;"&lt;<span class="attribute">stream:stream</span> <span class="attribute">xmlns:stream</span>=<span class="value">"http://etherx.jabber.org/streams"</span> <span class="attribute">xmlns</span>=<span class="value">"jabber:client"</span> <span class="attribute">to</span>=<span class="value">"xmpp.myserver.info"</span> <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span>"&gt;&gt;</span><br><span class="line"># 服务器确认客户的流打开请求,返回一个响应</span><br><span class="line">2014-09-26 05:22:31.528 [debug] <span class="tag">&lt;<span class="title">0.850.0</span>&gt;</span>@ejabberd_c2s:send_text:1869 Send XML on stream = <span class="tag">&lt;&lt;"&lt;?<span class="attribute">xml</span> <span class="attribute">version</span>=<span class="value">'1.0'</span><span class="value">?</span>&gt;</span><span class="tag">&lt;<span class="title">stream:stream</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span> <span class="attribute">xmlns:stream</span>=<span class="value">'http://etherx.jabber.org/streams'</span> <span class="attribute">id</span>=<span class="value">'3177127870'</span> <span class="attribute">from</span>=<span class="value">'xmpp.myserver.info'</span> <span class="attribute">version</span>=<span class="value">'1.0'</span> <span class="attribute">xml:lang</span>=<span class="value">'en'</span>&gt;</span>"&gt;&gt;</span><br><span class="line"># 服务器返回功能相应</span><br><span class="line">2014-09-26 05:22:31.529 [debug] <span class="tag">&lt;<span class="title">0.850.0</span>&gt;</span>@ejabberd_c2s:send_text:1869 Send XML on stream = <span class="tag">&lt;&lt;"&lt;<span class="attribute">stream:features</span>&gt;</span><span class="tag">&lt;<span class="title">mechanisms</span> <span class="attribute">xmlns</span>=<span class="value">'urn:ietf:params:xml:ns:xmpp-sasl'</span>&gt;</span><span class="tag">&lt;<span class="title">mechanism</span>&gt;</span>DIGEST-MD5<span class="tag">&lt;/<span class="title">mechanism</span>&gt;</span><span class="tag">&lt;<span class="title">mechanism</span>&gt;</span>SCRAM-SHA-1<span class="tag">&lt;/<span class="title">mechanism</span>&gt;</span><span class="tag">&lt;<span class="title">mechanism</span>&gt;</span>PLAIN<span class="tag">&lt;/<span class="title">mechanism</span>&gt;</span><span class="tag">&lt;/<span class="title">mechanisms</span>&gt;</span><span class="tag">&lt;<span class="title">c</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/protocol/caps'</span> <span class="attribute">hash</span>=<span class="value">'sha-1'</span> <span class="attribute">node</span>=<span class="value">'http://www.process-one.net/en/ejabberd/'</span> <span class="attribute">ver</span>=<span class="value">'aIT+/ulfcbHXDKPkCA+iw9x5mU8='</span>/&gt;</span><span class="tag">&lt;<span class="title">register</span> <span class="attribute">xmlns</span>=<span class="value">'http://jabber.org/features/iq-register'</span>/&gt;</span><span class="tag">&lt;/<span class="title">stream:features</span>&gt;</span>"&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>状态更新为<code>wait_for_feature_request</code>,等待接收<code>{xmlstreamstart, _Name, Attrs}</code>消息</p>
<h2 id="客户端认证">客户端认证</h2><p>客户端发送一个<code>&lt;auth&gt;</code>请求认证</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># auth内的文本值无换行和空格,这里为了可读性而格式化</span><br><span class="line"><span class="tag">&lt;<span class="title">auth</span> <span class="attribute">xmlns</span>=<span class="value">'urn:ietf:params:xml:ns:xmpp-sasl'</span> <span class="attribute">mechanism</span>=<span class="value">'SCRAM-SHA-1'</span>&gt;</span></span><br><span class="line">    biwsbj1yb290LHI9ZDQxZDhjZDk4ZjAwYjIwNGU5ODAwOTk4ZWNmODQyN2U=</span><br><span class="line"><span class="tag">&lt;/<span class="title">auth</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务器收到认证请求 并更新内部状态</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 客户端请求认证</span><br><span class="line"><span class="number">2014</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">05</span>:<span class="number">22</span>:<span class="number">31.543</span> [debug] &lt;<span class="number">0.849</span>.0&gt;<span class="annotation">@ejabberd</span><span class="string">_receiver:</span><span class="string">process_data:</span><span class="number">343</span> Received XML on stream = &lt;&lt;<span class="string">"&lt;auth xmlns="</span><span class="string">urn:</span><span class="string">ietf:</span><span class="string">params:</span><span class="string">xml:</span><span class="string">ns:</span>xmpp-sasl<span class="string">" mechanism="</span>SCRAM-SHA-<span class="number">1</span><span class="string">"&gt;biwsbj1yb290LHI9ZDQxZDhjZDk4ZjAwYjIwNGU5ODAwOTk4ZWNmODQyN2U=&lt;/auth&gt;"</span>&gt;&gt;</span><br><span class="line"># 更新内部状态</span><br><span class="line"><span class="number">2014</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">05</span>:<span class="number">22</span>:<span class="number">31.543</span> [debug] &lt;<span class="number">0.849</span>.0&gt;<span class="annotation">@shaper</span>:<span class="string">update:</span><span class="number">117</span> <span class="string">State:</span> &#123;maxrate,<span class="number">1000</span>,<span class="number">0.0</span>,<span class="number">1411708951528734</span>&#125;, Size=<span class="number">138</span></span><br></pre></td></tr></table></figure>
<p>此时, <code>ejabberd_c2s</code>状态更新为<code>wait_for_sasl_response</code>, 同时返回<code>&lt;challenge&gt;</code>响应</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># challenge内的文本值无换行和空格,这里为了可读性而格式化</span></span><br><span class="line">&lt;challenge</span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-sasl"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>&gt;</span><br><span class="line">    cj1kNDFkOGNkOThmMDBiMjA0ZTk4MDA5...省略&lt;/challenge&gt;</span><br></pre></td></tr></table></figure>
<p>客户端响应<code>&lt;challenge&gt;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">response</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">'urn:ietf:params:xml:ns:xmpp-sasl'</span>&gt;</span></span><br><span class="line">    Yz1iaXdzLHI9ZDQxZDhjZDk4ZjAw...省略<span class="tag">&lt;/<span class="title">response</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务器返回<code>&lt;success&gt;</code></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;success</span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-sasl"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="variable">version=</span><span class="string">"1.0"</span>&gt;dj1saHU0SHBCZVVsc2Fla2dhUFN2cXlxZ3Jxdlk9&lt;/success&gt;</span><br></pre></td></tr></table></figure>
<p><code>ejabberd_c2s</code>状态重新回到<code>wait_for_stream</code>,内部状态<code>StateData#state.authenticated</code>为非<code>false</code></p>
<h2 id="绑定资源">绑定资源</h2><p>客户端重新发送<code>&lt;stream&gt;</code></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;stream:stream</span><br><span class="line">    <span class="built_in">to</span>=<span class="string">'xmpp.myserver.info'</span></span><br><span class="line">    xmlns=<span class="string">'jabber:client'</span></span><br><span class="line">    xmlns:stream=<span class="string">'http://etherx.jabber.org/streams'</span></span><br><span class="line">    <span class="built_in">version</span>=<span class="string">'1.0'</span>&gt;</span><br></pre></td></tr></table></figure>
<p>服务器确认,并发送功能节</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;stream:stream <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"111324954"</span></span><br><span class="line">    <span class="variable">from=</span><span class="string">"xmpp.myserver.info"</span></span><br><span class="line">    <span class="variable">version=</span><span class="string">"1.0"</span></span><br><span class="line">    xml:<span class="variable">lang=</span><span class="string">"en"</span>&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;stream:features <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>&gt;</span><br><span class="line">  &lt;bind <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-bind"</span>/&gt;</span><br><span class="line">  &lt;session <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-session"</span>/&gt;</span><br><span class="line">  &lt;sm <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:2"</span>/&gt;</span><br><span class="line">  &lt;sm <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span>/&gt;</span><br><span class="line">  &lt;csi <span class="variable">xmlns=</span><span class="string">"urn:xmpp:csi:0"</span>/&gt;</span><br><span class="line">  &lt;c <span class="variable">xmlns=</span><span class="string">"http://jabber.org/protocol/caps"</span></span><br><span class="line">    <span class="variable">hash=</span><span class="string">"sha-1"</span></span><br><span class="line">    <span class="variable">node=</span><span class="string">"http://www.process-one.net/en/ejabberd/"</span></span><br><span class="line">    <span class="variable">ver=</span><span class="string">"aIT+/ulfcbHXDKPkCA+iw9x5mU8="</span>/&gt;</span><br><span class="line">  &lt;register <span class="variable">xmlns=</span><span class="string">"http://jabber.org/features/iq-register"</span>/&gt;</span><br><span class="line">&lt;/stream:features&gt;</span><br></pre></td></tr></table></figure>
<p>客户端选择绑定资源(资源由服务器生成)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'set'</span> <span class="attribute">id</span>=<span class="value">'_bind_auth_2'</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">bind</span> <span class="attribute">xmlns</span>=<span class="value">'urn:ietf:params:xml:ns:xmpp-bind'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务器应答</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">id</span>=<span class="value">"_bind_auth_2"</span></span><br><span class="line">    <span class="attribute">type</span>=<span class="value">"result"</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">"jabber:client"</span></span><br><span class="line">    <span class="attribute">xmlns:stream</span>=<span class="value">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">bind</span> <span class="attribute">xmlns</span>=<span class="value">"urn:ietf:params:xml:ns:xmpp-bind"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">jid</span>&gt;</span>root@xmpp.myserver.info/39189873701411708951913434<span class="tag">&lt;/<span class="title">jid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">bind</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>客户端请求初始化会话</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iq</span> <span class="attribute">type</span>=<span class="value">'set'</span> <span class="attribute">id</span>=<span class="value">'_session_auth_2'</span> <span class="attribute">xmlns</span>=<span class="value">'jabber:client'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">session</span> <span class="attribute">xmlns</span>=<span class="value">'urn:ietf:params:xml:ns:xmpp-session'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">iq</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务器应答</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;iq <span class="variable">type=</span><span class="string">"result"</span></span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"_session_auth_2"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="variable">version=</span><span class="string">"1.0"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>发现一篇类似的分析博客<br><a href="http://my.oschina.net/hncscwc/blog/159826" target="_blank" rel="external">http://my.oschina.net/hncscwc/blog/159826</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T03:30:18.000Z"><a href="/2014/09/26/ejabberd-modules-development-deep/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/ejabberd-modules-development-deep/">Ejabberd模块开发, 简介</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd的内部模块以<code>插件</code>的方式工作. 每个模块是模块名称以<code>mod_</code>开头的<code>erlang模块</code>.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/26/ejabberd-modules-development-deep/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-26T01:15:57.000Z"><a href="/2014/09/26/ejabberd-modules-quickstart/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/ejabberd-modules-quickstart/">Ejabberd模块快速入门</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd是一个以Elang编程语言开发的开源XMPP服务器.过去很长时间,XMPP以构建即时通信应用程序闻名, 很多人用它来构建实时应用程序. 依赖预Erlang平台的并发特性,在选择XMPP服务器的时候,Ejabberd天生的就适合与处理大规模并发连接的应用环境.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/26/ejabberd-modules-quickstart/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-25T16:32:22.000Z"><a href="/2014/09/26/erlang-tail-recursion/">2014-09-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/26/erlang-tail-recursion/">Erlang 尾递归</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/images/erlang-php-for.png" alt="Elrang尾递归和PHP的for循环"></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="function"><span class="params">(<span class="number">0</span>)</span>-&gt;</span></span><br><span class="line">        ok;</span><br><span class="line"><span class="keyword">for</span><span class="function"><span class="params">(N)</span>-&gt;</span></span><br><span class="line">    <span class="attribute">io</span>:format(<span class="string">"running time: ~p ms ~n"</span>,</span><br><span class="line">        [<span class="attribute">merle</span>:getkey(<span class="string">"test"</span>)]),</span><br><span class="line">    <span class="keyword">for</span>(N-<span class="number">1</span>).</span><br></pre></td></tr></table></figure>
<p>另一种方式,采用列表,通过模式匹配<code>[Head|Tail]</code>的形式</p>

<!--￼1-->



      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T17:45:29.000Z"><a href="/2014/09/25/ejabberd-compile-issues/">2014-09-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/25/ejabberd-compile-issues/">编译Ejabberd遇到的问题</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="问题:_缺少libyaml库">问题: 缺少<code>libyaml</code>库</h2><p>办法: 安装需要的库</p>
<p>Ejabberd 从 13.10 开始配置文件的格式从Erlang Term转换到使用YAML格式, 需要用到libyaml来解析yaml文件.</p>
<p>浏览器打开: <a href="http://pyyaml.org/download/libyaml/" target="_blank" rel="external">http://pyyaml.org/download/libyaml/</a>, 找到最新版本的<code>libyaml</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//pyyaml.org/download/libyaml/yaml-0.1.6.tar.gz</span></span><br><span class="line">tar zxf yaml-<span class="number">0.1</span>.<span class="number">6</span><span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h2 id="问题:_网络中断导致下载了不完整的deps/包,_比如deps/p1_yaml">问题: 网络中断导致下载了不完整的<code>deps/</code>包, 比如<code>deps/p1_yaml</code></h2><p>办法: 删除不完整的包,重新<code>make</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf deps/p1_yaml</span><br><span class="line"><span class="built_in">make</span></span><br></pre></td></tr></table></figure>
<h2 id="问题:_编译ejabberd模块找不到头文件的问题">问题: 编译ejabberd模块找不到头文件的问题</h2><p>办法: 网上很多介绍编译模块的方法是使用erlc编译模块, 使用<code>erlc</code>编译模块需要指明头文件,依赖库的路径,容易出错,编译自定义的ejabberd并没有这么麻烦,只要把写好了的ejabberd模块文件放到<code>$(EJABBERD)/src</code>目录下, 然后运行<code>make</code>, 生成的<code>.beam</code>文件会自动生成到<code>`$(EJABBERD)/ebin</code>目录下.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T16:51:59.000Z"><a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/">2014-09-25</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/">Ejabberd 编写一个简单的Echo服务模块</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文继续讨论Ejabberd的套接字架构,为了简化理解过程,一个一个Echo服务模块作为示例,它从客户端接收任何包,并把该包原封不动地回传给客户端.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/25/ejabberd-modules-a-simple-echo-service/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-24T15:20:04.000Z"><a href="/2014/09/24/ejabberd-socket-infrastructure/">2014-09-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/24/ejabberd-socket-infrastructure/">Ejabberd 套接字基础架构</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Ejabberd 是一个网络服务器, 那么套接字必然是通信的基础. 通过本文我们要搞清楚下面几个问题:</p>
<ol>
<li>Ejabberd 是如何工作的</li>
<li>如何Hack它获取自定义的特性</li>
</ol>
<p>本文分析的源码版本基于Ejabberd 2.1.10</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/24/ejabberd-socket-infrastructure/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-23T17:29:35.000Z"><a href="/2014/09/24/xmpp-xep-0096-si-file-transfer/">2014-09-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/24/xmpp-xep-0096-si-file-transfer/">XMPP XEP-0096 流初始化文件传输</a></h1>
  

    </header>
    <div class="entry">
      


        


        
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-23T17:28:37.000Z"><a href="/2014/09/24/xmpp-xep-0095-stream-initiation/">2014-09-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/24/xmpp-xep-0095-stream-initiation/">XMPP XEP-0095 流初始化协商过程</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本规范定义了一个XMPP扩展,用于在两个XMPP实体间初始化数据流, 其用途包括:</p>
<ol>
<li>文件传输</li>
<li>音频聊天</li>
<li>视频会议</li>
</ol>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/24/xmpp-xep-0095-stream-initiation/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-23T04:07:18.000Z"><a href="/2014/09/23/ejabberd-debugging/">2014-09-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/23/ejabberd-debugging/">Ejabberd 调试</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文通过分析Ejabberd服务器和客户端之间的通信,帮助你理解XMPP协议.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/23/ejabberd-debugging/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-23T02:36:08.000Z"><a href="/2014/09/23/ejabberd-clustering/">2014-09-23</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/23/ejabberd-clustering/">Ejabberd 集群</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="更新">更新</h2><ul>
<li>2015-03-22 Ejabberd 15.03 新特性<ul>
<li><code>ejabberdctl</code>新增<code>join_cluster</code>命令添加一个节点到集群中<br><a href="http://docs.ejabberd.im/admin/guide/#adding-a-node-in-a-cluster" target="_blank" rel="external">http://docs.ejabberd.im/admin/guide/#adding-a-node-in-a-cluster</a></li>
<li>新增Websocket支持<br><a href="http://docs.ejabberd.im/admin/guide/#websocket-support" target="_blank" rel="external">http://docs.ejabberd.im/admin/guide/#websocket-support</a></li>
</ul>
</li>
</ul>
<h2 id="安装Erlang_17-3_(Ubuntu_14-04)">安装Erlang 17.3 (Ubuntu 14.04)</h2><h2 id="配置工作流概要">配置工作流概要</h2><ul>
<li>修改两个服务器的HOSTNAME</li>
<li>修改两个服务器的<code>/etc/hosts</code>(内网)或DNS(外网)</li>
<li>修改<code>/etc/ejabberd/ejabberd.yml</code>的<code>hosts</code><ul>
<li>设置虚拟主机名称</li>
</ul>
</li>
<li>修改<code>/etc/ejabberd/ejabberdctl.cfg</code><ul>
<li>修改<code>ERLANG_NODE</code>(节点名)</li>
<li>修改<code>INET_DIST_INTERFACE</code>(节点地址)</li>
</ul>
</li>
<li><p>下载和编译<code>easy_cluster</code></p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//github.com/chadillac/ejabberd-easy_cluster/raw/master/easy_cluster.erl</span></span><br><span class="line">mv easy_cluster.erl <span class="regexp">/lib/</span>ejabberd/ebin</span><br><span class="line">cd <span class="regexp">/lib/</span>ejabberd/ebin</span><br><span class="line">erlc easy_cluster.erl</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>easy_cluster</code></p>
</li>
</ul>
<p>启动ejabberd到live模式</p>
<pre><code><span class="comment"><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ejabberdctl</span> live</span><br></pre></td></tr></table></figure></span>
</code></pre><p>执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">easy_cluster:<span class="function"><span class="title">test_node</span><span class="params">(<span class="string">'name@node'</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>如何验证集群成功了<br>  在<code>ejabberdctl live</code>模式下执行</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mnesia:<span class="function"><span class="title">info</span><span class="params">()</span></span>.</span><br></pre></td></tr></table></figure>
<p>  查看<code>running db nodes</code>, 如果包含两个集群的节点列表. 那么集群就运行起来了.</p>
</li>
</ul>
<h2 id="配置示例">配置示例</h2><p>将设有两台服务器</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master<span class="class">.chat-server</span><span class="class">.info</span></span><br><span class="line">slave<span class="class">.chat-server</span><span class="class">.info</span></span><br></pre></td></tr></table></figure>
<h2 id="使用MySQL替代Mnesia">使用MySQL替代Mnesia</h2><p>登陆MySQL</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql -uroot -proot <span class="comment">--host=192.168.8.33</span></span><br></pre></td></tr></table></figure>
<p>创建数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">database</span> ejabberd <span class="keyword">charset</span> = utf8</span></span><br></pre></td></tr></table></figure>
<p>导入表结构</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/root/</span>ejabberd<span class="regexp">/sql/my</span>sql.sql</span><br></pre></td></tr></table></figure>
<p>Ejabberd的部分模块支持在MySQL存储数据, 比如<code>mod_roster</code>, 需要在模块配置中设置<code>db_type: odbc</code>并创建数据库表结构, 例如:</p>
<p>编辑<code>/etc/ejabberd/ejabber.yml</code>,设置<code>mod_roster</code>模块的<code>db_type: odbc</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mod_roster</span>:</span><br><span class="line">  <span class="attribute">db_type</span>: odbc</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改<code>/etc/hosts</code>, 在两台服务器上分别增加如下记录:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">8.100</span>   ejabberd@master<span class="class">.chat-server</span><span class="class">.info</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">8.200</span>   ejabberd@slave<span class="class">.chat-server</span><span class="class">.info</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>两台服务器上分别设置HOSTNAME为<code>master.chat-server.info</code>, 和<code>slave.chat-server.info</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/<span class="built_in">hostname</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>两台服务器分别配置<code>/etc/ejabberd/ejabberdctl.cfg</code>:</p>
<ul>
<li><p>修改节点名称<code>ERLANG_NODE</code></p>
<pre><code><span class="comment"><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># master</span></span><br><span class="line">ERLANG_NODE=ejabberd@master.chat-<span class="keyword">server</span>.info</span><br><span class="line"><span class="preprocessor"># slave</span></span><br><span class="line">ERLANG_NODE=ejabberd@slave.chat-<span class="keyword">server</span>.info</span><br></pre></td></tr></table></figure></span>
</code></pre></li>
<li><p>分别设置<code>/etc/ejabberd/ejabberd.yml</code>中的hosts</p>
<pre><code><span class="comment"><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># master</span></span><br><span class="line"><span class="label">hosts:</span></span><br><span class="line">  - <span class="string">"master.chat-server.info"</span></span><br><span class="line"><span class="preprocessor"># slave</span></span><br><span class="line"><span class="label">hosts:</span></span><br><span class="line">  - <span class="string">"slave.chat-server.info"</span></span><br></pre></td></tr></table></figure></span>
</code></pre></li>
</ul>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://chad.ill.ac/post/35967173942/easy-ejabberd-clustering-guide-mnesia-mysql" target="_blank" rel="external">http://chad.ill.ac/post/35967173942/easy-ejabberd-clustering-guide-mnesia-mysql</a></li>
<li><a href="https://raymii.org/s/tutorials/Set_up_a_federated_XMPP_Chat_Network_with_ejabberd.html" target="_blank" rel="external">https://raymii.org/s/tutorials/Set_up_a_federated_XMPP_Chat_Network_with_ejabberd.html</a></li>
<li><a href="https://www.ejabberd.im/node/5669?q=node/5669" target="_blank" rel="external">https://www.ejabberd.im/node/5669?q=node/5669</a></li>
<li><a href="http://cqwjfck.blog.chinaunix.net/uid-22312037-id-3509097.html" target="_blank" rel="external">http://cqwjfck.blog.chinaunix.net/uid-22312037-id-3509097.html</a></li>
<li><a href="http://chad.ill.ac/post/55193155663/easy-ejabberd-clustering-multi-master-fault-tolerant" target="_blank" rel="external">http://chad.ill.ac/post/55193155663/easy-ejabberd-clustering-multi-master-fault-tolerant</a></li>
<li><a href="http://tdewolf.blogspot.com/2009/07/clustering-ejabberd-nodes-using-mnesia.html" target="_blank" rel="external">http://tdewolf.blogspot.com/2009/07/clustering-ejabberd-nodes-using-mnesia.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-22T14:49:24.000Z"><a href="/2014/09/22/xmpp-xep-0065-socks5-bytestreams/">2014-09-22</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/22/xmpp-xep-0065-socks5-bytestreams/">XMPP XEP-0065 SOCKS5 字节流</a></h1>
  

    </header>
    <div class="entry">
      
        <p>带外发送二进制数据/文件的两种方式</p>
<ol>
<li>实体间的端到端(P2P)连接</li>
<li>代理/中继服务器</li>
</ol>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/22/xmpp-xep-0065-socks5-bytestreams/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-22T14:03:27.000Z"><a href="/2014/09/22/xmpp-xep-0047-in-bind-bytestreams/">2014-09-22</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/22/xmpp-xep-0047-in-bind-bytestreams/">XMPP XEP-0047 带内字节流</a></h1>
  

    </header>
    <div class="entry">
      
        <p>该协议扩展有一个比较经典的应用场景. 通常XMPP服务器为了性能上的考虑,限制了<code>Stanza</code>(XML节)的大小不能超过指定的字节数.</p>
<p>当我在野外探险的时候,我发现了一个仙境,但是我通过XMPP客户端给我的兄弟伙说的时候,他既然不相信,怎么能让他相信我呢,我带了手机,我首先想到的时给他发送一张我拍的照片. 但是我的XMPP服务器限制了最大不能发送超过64KB大小的<code>节</code>. 所以我不得不把照片数据切分为多个小于64KB的<code>块</code>, 然后把这些块连续的发给我的兄弟,让他收完后在组装起来.</p>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/22/xmpp-xep-0047-in-bind-bytestreams/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-22T09:36:13.000Z"><a href="/2014/09/22/svg-sprite/">2014-09-22</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/22/svg-sprite/">SVG 精灵图片</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="把font-awesome图标转换为Svg精灵(Sprite)">把<a href="http://fontawesome.io" target="_blank" rel="external">font-awesome</a>图标转换为Svg精灵(Sprite)</h2><p><a href="http://ohdoylerules.com/web/font-awesome-svg-icons" target="_blank" rel="external">这篇文章</a> 说明了如何把font-awesome的png图片转换为svg精灵图片</p>
<h2 id="参考资料">参考资料</h2><ol>
<li><p>未来必热：SVG Sprite技术介绍<br><a href="http://www.zhangxinxu.com/wordpress/2014/07/introduce-svg-sprite-technology/" target="_blank" rel="external">http://www.zhangxinxu.com/wordpress/2014/07/introduce-svg-sprite-technology/</a></p>
</li>
<li><p>Icon System with SVG Sprites<br><a href="http://css-tricks.com/svg-sprites-use-better-icon-fonts/" target="_blank" rel="external">http://css-tricks.com/svg-sprites-use-better-icon-fonts/</a></p>
</li>
<li><p>UNLEASH THE POWER OF SVG SPRITES<br><a href="http://dev.webonomic.nl/unleash-the-power-of-svg-sprites" target="_blank" rel="external">http://dev.webonomic.nl/unleash-the-power-of-svg-sprites</a></p>
</li>
<li><p>How to Use SVG Image Sprites<br><a href="http://www.sitepoint.com/use-svg-image-sprites/" target="_blank" rel="external">http://www.sitepoint.com/use-svg-image-sprites/</a></p>
</li>
<li><p>Ten reasons we switched from an icon font to SVG<br><a href="http://ianfeather.co.uk/ten-reasons-we-switched-from-an-icon-font-to-svg/" target="_blank" rel="external">http://ianfeather.co.uk/ten-reasons-we-switched-from-an-icon-font-to-svg/</a></p>
</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-21T08:00:48.000Z"><a href="/2014/09/21/xmpp-xep-0133-service-administration/">2014-09-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/21/xmpp-xep-0133-service-administration/">XMPP XEP-0133 服务管理</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文说明了如何使用Javascript Strophe.js 实现XEP-0133扩展协议定义的XMPP服务器管理功能,</p>
<ol>
<li>添加用户</li>
<li>删除用户</li>
<li>禁用一个用户
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/21/xmpp-xep-0133-service-administration/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-09-20T05:53:27.000Z"><a href="/2014/09/20/xmpp-xep-0085-chat-status/">2014-09-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/09/20/xmpp-xep-0085-chat-status/">XMPP XEP-0085 聊天状态通知</a></h1>
  

    </header>
    <div class="entry">
      
        <p>该扩展协议比较容易理解, 在我们最常用的多数IM即时聊天工具都能看到对方是否正在输入. 可以让我们知道对方对此次会话的关注情况. 该扩展协议解决了即时聊天中记的几个问题:</p>
<ol>
<li>这个参与者是否已经停止了输入？</li>
<li>这个参与者是否注意这次聊天？</li>
<li>这个参与者是否暂时没有激活这个会话(换言之，此时没有注意这次聊天)？</li>
<li>这个参与者是否已离开(也就是说不再参与这次聊天了)？</li>
</ol>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/09/20/xmpp-xep-0085-chat-status/#more" class="more-link">阅读全文</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/5/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/7/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/05/07/xmpp-xep-0279-server-ip-check/">服务器IP检查</a>
      </li>
    
      <li>
        <a href="/2015/03/23/thrift-messing-guide/">Thrift: The Missing Guide</a>
      </li>
    
      <li>
        <a href="/2015/03/18/ejabberd-os-optimizations/">针对Ejabberd的操作系统C1000K优化</a>
      </li>
    
      <li>
        <a href="/2015/03/18/angular-if-else-statement-in-template/">AngularJS中的If..Else语句</a>
      </li>
    
      <li>
        <a href="/2015/03/18/continuous-deployment-of-node-js-applications/">Nodejs应用程序持续部署</a>
      </li>
    
      <li>
        <a href="/2015/03/17/erlang-pooler/">Erlang Pooler</a>
      </li>
    
      <li>
        <a href="/2015/03/17/ejabberd-easy-installer-and-structure-for-ejabberd-contributed-modules/">Ejabberd模块安装工具</a>
      </li>
    
      <li>
        <a href="/2015/03/13/ejabberd-howto-20150312/">Ejabberd Howto 20150312 &lt;TODO LIST&gt;</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-performance-turning/">Ejabberd 性能调优(草稿)</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-benchmark-with-tsung/">使用Tsung对Ejabberd进行性能测试</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>33</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Thrift/">Thrift</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>7</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a><a href="/tags/API/" style="font-size: 11.11px;">API</a><a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a><a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a><a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a><a href="/tags/CURL/" style="font-size: 10px;">CURL</a><a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a><a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a><a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a><a href="/tags/ETS/" style="font-size: 10px;">ETS</a><a href="/tags/Ecto/" style="font-size: 11.11px;">Ecto</a><a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a><a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a><a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a><a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a><a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a><a href="/tags/H2O/" style="font-size: 10px;">H2O</a><a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a><a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a><a href="/tags/Howto/" style="font-size: 10px;">Howto</a><a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a><a href="/tags/I18n/" style="font-size: 10px;">I18n</a><a href="/tags/IAB/" style="font-size: 10px;">IAB</a><a href="/tags/ID3/" style="font-size: 10px;">ID3</a><a href="/tags/IO/" style="font-size: 10px;">IO</a><a href="/tags/IOT/" style="font-size: 10px;">IOT</a><a href="/tags/IoT/" style="font-size: 10px;">IoT</a><a href="/tags/Loopback/" style="font-size: 12.22px;">Loopback</a><a href="/tags/MUC/" style="font-size: 10px;">MUC</a><a href="/tags/Macro/" style="font-size: 12.22px;">Macro</a><a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a><a href="/tags/Mix/" style="font-size: 14.44px;">Mix</a><a href="/tags/Modules/" style="font-size: 10px;">Modules</a><a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a><a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a><a href="/tags/OTP/" style="font-size: 12.22px;">OTP</a><a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a><a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a><a href="/tags/PM2/" style="font-size: 10px;">PM2</a><a href="/tags/Performance/" style="font-size: 10px;">Performance</a><a href="/tags/Phoenix/" style="font-size: 12.22px;">Phoenix</a><a href="/tags/Pool/" style="font-size: 10px;">Pool</a><a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a><a href="/tags/RESTFUL/" style="font-size: 11.11px;">RESTFUL</a><a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a><a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a><a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a><a href="/tags/Regex/" style="font-size: 10px;">Regex</a><a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a><a href="/tags/SSH/" style="font-size: 10px;">SSH</a><a href="/tags/SSL/" style="font-size: 10px;">SSL</a><a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a><a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a><a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a><a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a><a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a><a href="/tags/Task/" style="font-size: 10px;">Task</a><a href="/tags/Thrift/" style="font-size: 11.11px;">Thrift</a><a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a><a href="/tags/UBF/" style="font-size: 10px;">UBF</a><a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a><a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a><a href="/tags/VAST/" style="font-size: 10px;">VAST</a><a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a><a href="/tags/XEP/" style="font-size: 15.56px;">XEP</a><a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a><a href="/tags/XML/" style="font-size: 10px;">XML</a><a href="/tags/XMPP/" style="font-size: 17.78px;">XMPP</a><a href="/tags/android/" style="font-size: 10px;">android</a><a href="/tags/angular/" style="font-size: 16.67px;">angular</a><a href="/tags/application/" style="font-size: 10px;">application</a><a href="/tags/blockies/" style="font-size: 10px;">blockies</a><a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a><a href="/tags/bosh/" style="font-size: 12.22px;">bosh</a><a href="/tags/ci/" style="font-size: 10px;">ci</a><a href="/tags/container/" style="font-size: 11.11px;">container</a><a href="/tags/data-management/" style="font-size: 10px;">data management</a><a href="/tags/data-volume/" style="font-size: 10px;">data volume</a><a href="/tags/debugging/" style="font-size: 10px;">debugging</a><a href="/tags/devtools/" style="font-size: 10px;">devtools</a><a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a><a href="/tags/doc/" style="font-size: 10px;">doc</a><a href="/tags/docker/" style="font-size: 15.56px;">docker</a><a href="/tags/ejabberd/" style="font-size: 18.89px;">ejabberd</a><a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a><a href="/tags/emysql/" style="font-size: 11.11px;">emysql</a><a href="/tags/encoding/" style="font-size: 10px;">encoding</a><a href="/tags/erlang/" style="font-size: 12.22px;">erlang</a><a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a><a href="/tags/faq/" style="font-size: 10px;">faq</a><a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a><a href="/tags/gerrit/" style="font-size: 11.11px;">gerrit</a><a href="/tags/gettext/" style="font-size: 10px;">gettext</a><a href="/tags/git/" style="font-size: 12.22px;">git</a><a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a><a href="/tags/grunt/" style="font-size: 10px;">grunt</a><a href="/tags/hero/" style="font-size: 10px;">hero</a><a href="/tags/html/" style="font-size: 10px;">html</a><a href="/tags/html5/" style="font-size: 10px;">html5</a><a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a><a href="/tags/iq/" style="font-size: 10px;">iq</a><a href="/tags/jabber/" style="font-size: 10px;">jabber</a><a href="/tags/javascript/" style="font-size: 11.11px;">javascript</a><a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a><a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a><a href="/tags/library/" style="font-size: 10px;">library</a><a href="/tags/linking/" style="font-size: 10px;">linking</a><a href="/tags/lists/" style="font-size: 10px;">lists</a><a href="/tags/load-balance/" style="font-size: 10px;">load balance</a><a href="/tags/log4er/" style="font-size: 10px;">log4er</a><a href="/tags/manage-images/" style="font-size: 10px;">manage images</a><a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a><a href="/tags/muc/" style="font-size: 10px;">muc</a><a href="/tags/mysql/" style="font-size: 10px;">mysql</a><a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a><a href="/tags/node-webkit/" style="font-size: 13.33px;">node-webkit</a><a href="/tags/node-js/" style="font-size: 12.22px;">node.js</a><a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a><a href="/tags/notification/" style="font-size: 10px;">notification</a><a href="/tags/npm/" style="font-size: 11.11px;">npm</a><a href="/tags/performance/" style="font-size: 10px;">performance</a><a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a><a href="/tags/polymer/" style="font-size: 10px;">polymer</a><a href="/tags/port/" style="font-size: 10px;">port</a><a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a><a href="/tags/rebar/" style="font-size: 10px;">rebar</a><a href="/tags/record/" style="font-size: 10px;">record</a><a href="/tags/recursion/" style="font-size: 10px;">recursion</a><a href="/tags/regexp/" style="font-size: 10px;">regexp</a><a href="/tags/relx/" style="font-size: 10px;">relx</a><a href="/tags/screen/" style="font-size: 10px;">screen</a><a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a><a href="/tags/shell/" style="font-size: 10px;">shell</a><a href="/tags/socket/" style="font-size: 10px;">socket</a><a href="/tags/ssh/" style="font-size: 10px;">ssh</a><a href="/tags/stanza/" style="font-size: 10px;">stanza</a><a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a><a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a><a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a><a href="/tags/swagger/" style="font-size: 12.22px;">swagger</a><a href="/tags/testing/" style="font-size: 10px;">testing</a><a href="/tags/tls/" style="font-size: 10px;">tls</a><a href="/tags/tools/" style="font-size: 10px;">tools</a><a href="/tags/tsung/" style="font-size: 10px;">tsung</a><a href="/tags/upstart/" style="font-size: 10px;">upstart</a><a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a><a href="/tags/varnish/" style="font-size: 10px;">varnish</a><a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a><a href="/tags/vt/" style="font-size: 10px;">vt</a><a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a><a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a><a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a><a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




