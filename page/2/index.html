
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-05T13:49:11.000Z"><a href="/2015/01/05/erlang-hipe-help-options/">2015-01-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/05/erlang-hipe-help-options/">Erlang HiPE选项</a></h1>
  

    </header>
    <div class="entry">
      


        


        <ul>
<li><p>在编译期间输出内部调试信息</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">4&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">debug</span>).</span><br><span class="line"><span class="function_or_atom">debug</span> - <span class="variable">Outputs</span> <span class="function_or_atom">internal</span> <span class="function_or_atom">debugging</span> <span class="function_or_atom">information</span> <span class="function_or_atom">during</span> <span class="function_or_atom">compilation</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自动加载产生的原生代码到内存中</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">5&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">load</span>).</span><br><span class="line"><span class="function_or_atom">load</span> - <span class="variable">Automatically</span> <span class="function_or_atom">load</span> <span class="function_or_atom">the</span> <span class="function_or_atom">produced</span> <span class="function_or_atom">native</span> <span class="function_or_atom">code</span> <span class="function_or_atom">into</span> <span class="function_or_atom">memory</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Displays assembly listing with addresses and bytecode</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">6&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">pp_asm</span>).</span><br><span class="line"><span class="function_or_atom">pp_asm</span> - <span class="variable">Displays</span> <span class="function_or_atom">assembly</span> <span class="function_or_atom">listing</span> <span class="function_or_atom">with</span> <span class="function_or_atom">addresses</span> <span class="function_or_atom">and</span> <span class="function_or_atom">bytecode</span></span><br><span class="line"><span class="variable">Currently</span> <span class="function_or_atom">available</span> <span class="function_or_atom">for</span> <span class="function_or_atom">x86</span> <span class="function_or_atom">only</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示输入BEAM代码</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">7&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">pp_beam</span>).</span><br><span class="line"><span class="function_or_atom">pp_beam</span> - <span class="variable">Display</span> <span class="function_or_atom">the</span> <span class="function_or_atom">input</span> <span class="variable">BEAM</span> <span class="function_or_atom">code</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示中间HiPE-ICode代码</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">8&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">pp_icode</span>).</span><br><span class="line"><span class="function_or_atom">pp_icode</span> - <span class="variable">Display</span> <span class="function_or_atom">the</span> <span class="function_or_atom">intermediate</span> <span class="variable">HiPE</span>-<span class="variable">ICode</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示生成的(后端相关)原生代码</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">9&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">pp_native</span>).</span><br><span class="line"><span class="function_or_atom">pp_native</span> - <span class="variable">Display</span> <span class="function_or_atom">the</span> <span class="function_or_atom">generated</span> (<span class="function_or_atom">back</span>-<span class="function_or_atom">end</span> <span class="function_or_atom">specific</span>) <span class="function_or_atom">native</span> <span class="function_or_atom">code</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示中间HiPE-RTL代码</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">10&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">pp_rtl</span>).</span><br><span class="line"><span class="function_or_atom">pp_rtl</span> - <span class="variable">Display</span> <span class="function_or_atom">the</span> <span class="function_or_atom">intermediate</span> <span class="variable">HiPE</span>-<span class="variable">RTL</span> <span class="function_or_atom">code</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>报告编译器不同阶段的编译时间</p>
  <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>&gt; hipe:help_option(<span class="built_in">time</span>).</span><br><span class="line"><span class="built_in">time</span> - Reports <span class="operator">the</span> compilation times <span class="keyword">for</span> <span class="operator">the</span> different stages</span><br><span class="line"><span class="operator">of</span> <span class="operator">the</span> compiler.</span><br><span class="line">    &#123;<span class="built_in">time</span>, Module&#125;       reports timings <span class="keyword">for</span> <span class="operator">the</span> module Module.</span><br><span class="line">    特定模块</span><br><span class="line">    &#123;<span class="built_in">time</span>, [M1, M2, M3]&#125; reports timings <span class="keyword">for</span> <span class="operator">the</span> specified modules.</span><br><span class="line">    指定模块列表</span><br><span class="line">    &#123;<span class="built_in">time</span>, all&#125;          reports timings all modules.</span><br><span class="line">    所有模块</span><br><span class="line">    <span class="built_in">time</span>                 reports timings <span class="keyword">for</span> <span class="operator">the</span> main module.</span><br><span class="line">    主模块</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定编译时间限制,单位毫秒, 必须为非负整数, 或原子’infinity’, 当前默认限制为15分钟(900000毫秒)</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">13&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">timeout</span>).</span><br><span class="line"><span class="function_or_atom">timeout</span> - <span class="variable">Specify</span> <span class="function_or_atom">compilation</span> <span class="function_or_atom">time</span> <span class="function_or_atom">limit</span> <span class="function_or_atom">in</span> <span class="function_or_atom">ms</span>. <span class="variable">Used</span> <span class="function_or_atom">as</span> &#123;<span class="function_or_atom">timeout</span>, <span class="variable">LIMIT</span>&#125;.</span><br><span class="line">    <span class="variable">The</span> <span class="function_or_atom">limit</span> <span class="function_or_atom">must</span> <span class="function_or_atom">be</span> <span class="function_or_atom">a</span> <span class="function_or_atom">non</span>-<span class="function_or_atom">negative</span> <span class="function_or_atom">integer</span> <span class="function_or_atom">or</span> <span class="function_or_atom">the</span> <span class="function_or_atom">atom</span> <span class="string">'infinity'</span>.</span><br><span class="line">    <span class="variable">The</span> <span class="function_or_atom">current</span> <span class="function_or_atom">default</span> <span class="function_or_atom">limit</span> <span class="function_or_atom">is</span> <span class="number">15</span> <span class="function_or_atom">minutes</span> (<span class="number">900000</span> <span class="function_or_atom">ms</span>).</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出完成了什么</p>
  <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">14&gt; </span><span class="function_or_atom">hipe:help_option</span>(<span class="function_or_atom">verbose</span>).</span><br><span class="line"><span class="function_or_atom">verbose</span> - <span class="variable">Output</span> <span class="function_or_atom">information</span> <span class="function_or_atom">about</span> <span class="function_or_atom">what</span> <span class="function_or_atom">is</span> <span class="function_or_atom">being</span> <span class="function_or_atom">done</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-04T18:21:41.000Z"><a href="/2015/01/05/elixir-converting-erlang-code-to-elixir/">2015-01-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/05/elixir-converting-erlang-code-to-elixir/">Elixir 把Erlang代码转换为Elixir</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>项目地址:</p>
<p><a href="https://github.com/developerworks/ws_cowboy" target="_blank" rel="external">https://github.com/developerworks/ws_cowboy</a></p>
<h2 id="项目描述文件mix-exs">项目描述文件<code>mix.exs</code></h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">WsCowboy</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:ws_cowboy</span>,</span><br><span class="line">     <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">     <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">    [</span><br><span class="line">      <span class="symbol">applications:</span> [<span class="symbol">:logger</span>, <span class="symbol">:cowboy</span>],</span><br><span class="line">      <span class="symbol">mod:</span> &#123;<span class="constant">WsCowboy,</span> []&#125;</span><br><span class="line">    ]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    [&#123;<span class="symbol">:cowboy</span>,<span class="string">"~&gt; 1.0.0"</span>&#125;]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="Application">Application</h2><p><img src="/assets/elixir/F12C0B50-7202-4D66-9F6D-90653C9F1BAC.png" alt="Application"></p>
<h2 id="Supervisor">Supervisor</h2><p><img src="/assets/elixir/A80E3448-29CE-421F-882F-D1E6FBBBCAB1.png" alt="Supervisor"></p>
<h2 id="Websocket_Handler">Websocket Handler</h2><p><img src="/assets/elixir/1A369D10-7585-4B51-805D-C289B1F8C8AD.png" alt="Websocket Handler"></p>
<h2 id="运行结果">运行结果</h2><p><img src="/assets/elixir/4CB26FF2-B581-4125-9A90-82AAC005C4D5.png" alt="运行结果"></p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Converting Erlang code into Elixir<br><a href="http://blog.plataformatec.com.br/2014/11/converting-erlang-code-into-elixir/" target="_blank" rel="external">http://blog.plataformatec.com.br/2014/11/converting-erlang-code-into-elixir/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-04T18:12:56.000Z"><a href="/2015/01/05/elixir-tips-001/">2015-01-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/05/elixir-tips-001/">Elixir提示 001</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="模块">模块</h2><ul>
<li>Elixir代码可以组织到模块中</li>
<li>模块是函数的集合</li>
<li>模块是最小编译单元: 每个模块经过编译会生成一个<code>.beam</code>文件</li>
<li>通常在一个Elixir源文件中只定义一个模块,但也可以在一个源文件中定义多个模块,不管在源文件中有多少个模块,反正每个模块都会生成一个<code>.beam</code>文件,这种情况是一个编译输入文件产生多个编译输出文件</li>
</ul>
<h2 id="unless语句">unless语句</h2><p>unless语句为if语句的<code>反义</code></p>
<p>举例</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">defmodule Test1 <span class="built_in">do</span></span><br><span class="line">    def run <span class="built_in">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="constant">true</span> <span class="built_in">do</span></span><br><span class="line">            IO.puts <span class="string">"true"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            IO.puts <span class="string">"false"</span></span><br><span class="line">        <span class="function"><span class="keyword">end</span></span></span><br><span class="line">    <span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>当表达式1+1==2为真时, 执行if…end之间的代码</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Test2</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span> </span><span class="keyword">do</span></span><br><span class="line">        <span class="keyword">unless</span> <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"true"</span></span><br><span class="line">        else</span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"false"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>请把Test1和Test2模块代码复制粘贴到IEx中观察却别</p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://stackoverflow.com/questions/25414347/how-do-i-run-a-beam-file-compiled-by-elixir-or-erlang" target="_blank" rel="external">http://stackoverflow.com/questions/25414347/how-do-i-run-a-beam-file-compiled-by-elixir-or-erlang</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-04T17:23:31.000Z"><a href="/2015/01/05/erlang-build-release-with-erlang-mk-and-relx/">2015-01-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/05/erlang-build-release-with-erlang-mk-and-relx/">Erlang 用erlang.mk和relx发布Erlang应用程序(译)</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>发布OTP应用程序一直是个困难的任务. 像<code>reltool</code>,<code>rebar</code>这类工具虽然简化了这类问题,但并没有解决所有问题.本文展示了一个候选方案,希望是一个更简化的方案.</p>
<p>发布OTP应用程序需要两个步骤.</p>
<ul>
<li>首先需要构建各种需要包含在发布包中的各种OTP应用程序.</li>
<li>构建完成后, 把<code>Erlang运行时系统</code>,<code>节点启动脚本</code>,<code>应用程序</code>和<code>配置文件</code>打包为一个可发布的软件包.</li>
</ul>
<p><a href="https://github.com/extend/erlang.mk" target="_blank" rel="external">erlang.mk</a>解决了第一个步骤的问题.它是一个<code>GNU Make</code>包含文件. 只需要把它包含在Makefile文件中即可构建项目,获取和构建依赖,构建文档,执行静态分析等任务.</p>
<p><a href="https://github.com/erlware/relx" target="_blank" rel="external">relx</a> 解决了第二个步骤的问题.它是一个发布创建工具, 用于把应用程序打包为单个可执行程序. 它并不要求配置文件, 如果你需要,那也是很小的一个配置文件.</p>
<p>来看一个最简单的使用erlang.mk的Makefile文件. 其只需要做一件事: 定义项目名称.</p>
<pre><code><span class="keyword">PROJECT</span> = my_peojct

<span class="keyword">include</span> erlang.mk
</code></pre><p>只需要这么定义就可以让你使用<code>make</code>命令来构建项目, 以及使用<code>make tests</code>运行测试. 如果使用<code>ErlyDTL</code>,它还可以构建<code>templates</code>目录中的<code>*.dtl</code>模板.</p>
<pre><code>PROJECT <span class="keyword">=</span> ninenines

DEPS <span class="keyword">=</span> cowboy erlydtl
dep_cowboy <span class="keyword">=</span> https<span class="keyword">:</span><span class="comment">//github.com/extend/cowboy.git 0.8.5</span>
dep_erlydtl <span class="keyword">=</span> https<span class="keyword">:</span><span class="comment">//github.com/evanmiller/erlydtl.git 4d0dc8fb</span>

<span class="typename">.PHONY</span><span class="keyword">:</span> <span class="keyword">release</span> clean<span class="keyword">-</span><span class="keyword">release</span>

<span class="keyword">release</span><span class="keyword">:</span> clean<span class="keyword">-</span><span class="keyword">release</span> all projects
    relx <span class="keyword">-</span>o rel<span class="keyword">/</span>$(PROJECT)

clean<span class="keyword">-</span><span class="keyword">release</span><span class="keyword">:</span> clean<span class="keyword">-</span>projects
    rm <span class="keyword">-</span>rf rel<span class="keyword">/</span>$(PROJECT)

include erlang<span class="typename">.mk</span>
</code></pre><p>其中我们看到了如何定义依赖<code>DEPS = cowboy erlydtl</code>:</p>
<ul>
<li>首先,列举所有的依赖名称</li>
<li>其次,单独定义每一个依赖的URL,提交号,标记或分支</li>
<li>随后,定义了两个目标, <code>release</code>为默认目标, 因为它是最先定义的. 你可以覆盖默认目标<code>all</code>,其作用是构建应用程序与其依赖.</li>
<li><code>release</code>目标使用<code>relx</code>在<code>rel/ninenines/</code>目录构建发布.</li>
</ul>
<p>下面来看一下构建此发布的配置文件.</p>
<pre><code>{release, {ninenines, <span class="string">"1"</span>}, [ninenines]}.

{extended_start_script, <span class="literal">true</span>}.
{sys_config, <span class="string">"rel/sys.config"</span>}.

{overlay, [
    {mkdir, <span class="string">"log"</span>},
    {copy, <span class="string">"rel/vm.args"</span>,
        <span class="string">"releases/\{\{release_name\}\}-\{\{release_version\}\}/vm.args"</span>}
]}.
</code></pre><p>第一行定义了一个名为<code>ninenines</code>的发布,其又一个版本号<code>1</code>, 包含一个应用程序,名称也为<code>ninenines</code>.</p>
<p>We then use the extended_start_script option to tell relx that we would like to have a start script that allows us to<br>not only start the release, but do so with the node in the background, or also to allow us to connect to a running node, and so on.<br>This start script has the same features as the one tools like rebar generates.</p>
<p>然后使用<code>extended_start_script</code>告知<code>relx</code>我们想要有一个启动脚本用于启动应用程序, …..<br>该启动脚本和<code>rebar</code>工具生成的作用是一样的.</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Build Erlang releases with erlang.mk and relx<br><a href="http://ninenines.eu/articles/erlang.mk-and-relx/" target="_blank" rel="external">http://ninenines.eu/articles/erlang.mk-and-relx/</a></li>
<li>erlang.mk Github项目<br><a href="https://github.com/ninenines/erlang.mk" target="_blank" rel="external">https://github.com/ninenines/erlang.mk</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-04T17:08:21.000Z"><a href="/2015/01/05/elixir-release-manager/">2015-01-05</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/05/elixir-release-manager/">Elixir发布管理器 Exrm</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Elixir发布管理器(Elixir Release Manager)是一个Elixir任务模块,用于把一个完整Elixir项目打包为一个<code>.tar.gz</code>文件用于发布和部署.</p>
<p>首先, 需要在<code>mix.exs</code>文件中添加如下依赖:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defp deps <span class="keyword">do</span></span><br><span class="line">    [&#123;<span class="symbol">:exrm</span>, <span class="string">"~&gt; 0.14.16"</span>&#125;]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>下载依赖,并编译</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mix</span> deps.get</span><br><span class="line"><span class="built_in">mix</span> deps.compile</span><br></pre></td></tr></table></figure>
<p>发布项目</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mix</span> release</span><br></pre></td></tr></table></figure>
<pre><code>Build a <span class="operator"><span class="keyword">release</span> <span class="keyword">for</span> the <span class="keyword">current</span> mix application.

Examples

┃ # Build a <span class="keyword">release</span> <span class="keyword">using</span> defaults
┃ mix <span class="keyword">release</span>
┃
┃ # Pass args <span class="keyword">to</span> erlexec <span class="keyword">when</span> running the <span class="keyword">release</span>
┃ mix <span class="keyword">release</span> <span class="comment">--erl="-env TZ UTC"</span>
┃
┃ # Enable dev <span class="keyword">mode</span>. Make changes, compile <span class="keyword">using</span> MIX_ENV=prod
┃ # <span class="keyword">and</span> <span class="keyword">execute</span> your <span class="keyword">release</span> again <span class="keyword">to</span> pick up the changes
┃ mix <span class="keyword">release</span> <span class="comment">--dev</span>
┃
┃ # <span class="keyword">Set</span> the verbosity <span class="keyword">level</span>
┃ mix <span class="keyword">release</span> <span class="comment">--verbosity=[silent|quiet|normal|verbose]</span>

You may pass <span class="keyword">any</span> <span class="built_in">number</span> <span class="keyword">of</span> arguments <span class="keyword">as</span> needed. Make sure you pass arguments
<span class="keyword">using</span> <span class="comment">--key=value, not --key value, as the args may be interpreted incorrectly</span>
otherwise.</span>
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2015-01-02T09:29:03.000Z"><a href="/2015/01/02/elixir-regex/">2015-01-02</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/02/elixir-regex/">Elixir 正则表达式</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#定义正则表达式"><span class="toc-number">1.</span> <span class="toc-text">定义正则表达式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证手机号码"><span class="toc-number">2.</span> <span class="toc-text">验证手机号码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证电子邮件地址"><span class="toc-number">3.</span> <span class="toc-text">验证电子邮件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证身份证号码"><span class="toc-number">4.</span> <span class="toc-text">验证身份证号码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <h2 id="定义正则表达式">定义正则表达式</h2><ul>
<li>在Elixir中定义正则表达式需要使用到一个特殊的前缀<code>~r</code></li>
<li>匹配操作需要使用操作符<code>=~</code></li>
</ul>
<h2 id="验证手机号码">验证手机号码</h2><p>比如我们定义一个验证11为手机号码的正则表达式,启动Elixir Shell, 定义一个手机号码的正则表达式:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">1</span>)&gt; regex_cellphone = ~<span class="string">r"^[0-9]&#123;11,11&#125;$"</span></span><br><span class="line">~r/^[<span class="number">0</span>-<span class="number">9</span>]&#123;<span class="number">11</span>,<span class="number">11</span>&#125;$/</span><br></pre></td></tr></table></figure>
<p>匹配:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">2</span>)</span></span>&gt; <span class="string">"13912345678"</span> =~ regex_cellphone</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<p>在判断条件中使用</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">7</span>)&gt; cond do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">7</span>)&gt;   <span class="string">"13912345678"</span> =~ regex_cellphone == true -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">7</span>)&gt;     IO.puts <span class="string">"Cellphone number 13912345678 is a valid cell phone number"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">7</span>)&gt;   true -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">7</span>)&gt;     false</span><br><span class="line"><span class="keyword">...</span>(<span class="number">7</span>)&gt; end</span><br><span class="line">Cellphone number <span class="number">13912345678</span> is a valid cell phone number</span><br><span class="line">:ok</span><br></pre></td></tr></table></figure>
<p>在关键业务中, 还需要通过短信验证手机号的有效性, 上述验证并不能保证该号码是一个<code>可用</code>的手机号码.</p>
<h2 id="验证电子邮件地址">验证电子邮件地址</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">13</span>)&gt; str_email = <span class="string">"riza@elixirdose.com"</span></span><br><span class="line"><span class="string">"riza@elixirdose.com"</span></span><br><span class="line">iex(<span class="number">14</span>)&gt; Regex.match?(~r/(\w+)@([\w.]+)/, str_email)</span><br><span class="line">true</span><br><span class="line">iex(<span class="number">15</span>)&gt; cond do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">15</span>)&gt;   Regex.match?(~r/(\w+)@([\w.]+)/, str_email) == true -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">15</span>)&gt;    IO.puts <span class="string">"Your email is a valid email"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">15</span>)&gt;   true -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">15</span>)&gt;    IO.puts <span class="string">"Your email address is invalid"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">15</span>)&gt; end</span><br><span class="line">Your email is a valid email</span><br><span class="line">:ok</span><br></pre></td></tr></table></figure>
<p>编译版本, 正则表达式有几个变化</p>
<ul>
<li><code>Regex.compile</code>编译正则表达式字符串不需要使用<code>~r</code>前缀</li>
<li><code>\</code>符号需要使用<code>\\</code>替代(转义)<br>上面在Elixir Shell中的正则表达式<code>~r/(\w+)@([\w.]+)/</code>需要改成字符串<code>(\\w+)@([\\w.]+)</code>, 对应的编译语句为<code>{:ok, regex} = Regex.compile(&quot;(\\w+)@([\\w.]+)&quot;)</code></li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">RegExpTest</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(email_address) </span><span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="constant">Regex.</span>compile(<span class="string">"(\\w+)@([\\w.]+)"</span>) <span class="keyword">do</span></span><br><span class="line">            &#123;<span class="symbol">:ok</span>, regex&#125; -&gt;</span><br><span class="line">                if <span class="constant">Regex.</span>match?(regex, email_address) == <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">                    <span class="constant">IO.</span>puts <span class="string">"Your email is a valid email"</span></span><br><span class="line">                else</span><br><span class="line">                    <span class="constant">IO.</span>puts <span class="string">"Your email address is invalid"</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="constant">_ </span>-&gt;</span><br><span class="line">                <span class="constant">IO.</span>puts <span class="string">"Invalid regex definition"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在Elixir Shell中执行:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">4</span>)&gt; defmodule RegExpTest do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;     def run(email_address) do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;         case Regex.compile(<span class="string">"(\\w+)@([\\w.]+)"</span>) do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;             &#123;:ok, regex&#125; -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                 <span class="keyword">if</span> Regex.match?(regex, email_address) == true do</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                     IO.puts <span class="string">"Your email is a valid email"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                 <span class="keyword">else</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                     IO.puts <span class="string">"Your email address is invalid"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                 end</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;             _ -&gt;</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;                 IO.puts <span class="string">"Invalid regex definition"</span></span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;         end</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt;     end</span><br><span class="line"><span class="keyword">...</span>(<span class="number">4</span>)&gt; end</span><br><span class="line">iex:<span class="number">4</span>: <span class="keyword">warning</span>: redefining module RegExpTest</span><br><span class="line">&#123;:module, RegExpTest,</span><br><span class="line"> &lt;&lt;<span class="number">70</span>, <span class="number">79</span>, <span class="number">82</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">160</span>, <span class="number">66</span>, <span class="number">69</span>, <span class="number">65</span>, <span class="number">77</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">68</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">122</span>, <span class="number">131</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">105</span>, <span class="number">114</span>, <span class="number">95</span>, <span class="number">100</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">118</span>, <span class="number">49</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">104</span>, <span class="number">2</span>, <span class="keyword">...</span>&gt;&gt;,</span><br><span class="line"> &#123;:run, <span class="number">1</span>&#125;&#125;</span><br><span class="line">iex(<span class="number">5</span>)&gt; RegExpTest.run(<span class="string">"riza@elixirdose.com"</span>)</span><br><span class="line">Your email is a valid email</span><br><span class="line">:ok</span><br></pre></td></tr></table></figure>
<h2 id="验证身份证号码">验证身份证号码</h2><p>规则:</p>
<ul>
<li>身份证号码必须是18为字符长度,有17为数字本体码和1位校验码构成</li>
<li>本体码包含3个部分, 分别是<ul>
<li>地址(地区)码</li>
<li>出生日期</li>
<li>顺序码(男性奇数, 女性偶数)<br>在特定应用下,比如需要用户输入身份证号码的应用场景, 我们可以通过顺序吗识别用户的性别,减少用户输入.</li>
</ul>
</li>
</ul>
<p>TODO:: 实现</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>验证邮件地址示例<br><a href="https://gist.github.com/rizafahmi/b1711f7f10aaf7a7ced9" target="_blank" rel="external">https://gist.github.com/rizafahmi/b1711f7f10aaf7a7ced9</a></li>
<li>身份证验证规则<br><a href="http://wenku.baidu.com/link?url=lSfaWKLcnVJTF7LYXOG5qdEhY_Ns5mBWyPu372WcskB7aII2UTzQ5UakYCIBENBy2LKTz0HftEr7boaFnFZcjjbHec_8Py708uqq9nfMmEW" target="_blank" rel="external">http://wenku.baidu.com/link?url=lSfaWKLcnVJTF7LYXOG5qdEhY_Ns5mBWyPu372WcskB7aII2UTzQ5UakYCIBENBy2LKTz0HftEr7boaFnFZcjjbHec_8Py708uqq9nfMmEW</a></li>
<li>常用语法,控制流语句<br><a href="http://learnxinyminutes.com/docs/zh-cn/elixir-cn/" target="_blank" rel="external">http://learnxinyminutes.com/docs/zh-cn/elixir-cn/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-31T19:04:01.000Z"><a href="/2015/01/01/elixir-how-to-parsing-xml/">2015-01-01</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/01/elixir-how-to-parsing-xml/">Elixir 解析XML的几个坑</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>在Elixir 1.0.2中解析XML文档的时候,最开始是参考的<a href="http://elixirsips.com/episodes/028_parsing_xml.html" target="_blank" rel="external">这个视频</a>, 总之在Google的搜索结果中掉进了无数多个坑后,终于爬出来了.</p>
<p>创建一个项目, 本文所述所有内容都是在文件<code>test/xml_parsing_test.exs</code>文件中完成, 并通过<code>mix test</code>执行测试用例:</p>
<pre><code>root@c87c9967219c:~# mix new xml_parsing
<span class="comment">* creating README.md</span>
<span class="comment">* creating .gitignore</span>
<span class="comment">* creating mix.exs</span>
<span class="comment">* creating config</span>
<span class="comment">* creating config/config.exs</span>
<span class="comment">* creating lib</span>
<span class="comment">* creating lib/xml_parsing.ex</span>
<span class="comment">* creating test</span>
<span class="comment">* creating test/test_helper.exs</span>
<span class="comment">* creating test/xml_parsing_test.exs</span>

Your mix project was created successfully.
You can <span class="keyword">use</span> mix to compile it, <span class="keyword">test</span> it, and <span class="keyword">more</span>:

    <span class="keyword">cd</span> xml_parsing
    mix <span class="keyword">test</span>

<span class="keyword">Run</span> `mix <span class="keyword">help</span>` <span class="keyword">for</span> <span class="keyword">more</span> commands.
</code></pre><p>把我拉出来的是下面这篇<a href="http://erlangcentral.org/wiki/index.php?title=Elixir_and_XML" target="_blank" rel="external">Wiki</a>, 视频中的代码有几个问题:</p>
<ul>
<li><code>defrecord</code>关键字废弃了,必须用<code>Record.defrecord</code></li>
<li><p><code>Record.defrecord</code>不能定义在模块的外面了,必须定义在模块内部, 比如:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">XmlParsingTest</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> <span class="constant">ExUnit.Case</span></span><br><span class="line">    require <span class="constant">Record</span></span><br><span class="line">    <span class="constant">Record.</span><span class="class"><span class="keyword">defrecord</span> :<span class="title">xmlElement</span>, <span class="constant">Record.</span>extract(<span class="symbol">:xmlElement</span>, <span class="symbol">from_lib:</span> <span class="string">"xmerl/include/xmerl.hrl"</span>)</span></span><br><span class="line">    <span class="constant">Record.</span><span class="class"><span class="keyword">defrecord</span> :<span class="title">xmlText</span>, <span class="constant">Record.</span>extract(<span class="symbol">:xmlText</span>, <span class="symbol">from_lib:</span> <span class="string">"xmerl/include/xmerl.hrl"</span>)</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取节点值的方式变了</p>
</li>
</ul>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">test <span class="string">"Test parsing xml document OLD"</span> <span class="keyword">do</span></span><br><span class="line">    &#123;xml, _rest&#125;        = :xmerl_scan.<span class="built_in">string</span>(:binary.bin_to_list(sample_xml))</span><br><span class="line">    [ title_element ]   = <span class="type">Enum</span>.first(:xmerl_xpath.<span class="built_in">string</span>(<span class="char">'/blog/title'</span>, xml)).<span class="keyword">value</span></span><br><span class="line">    [ title_text ]      = title_element.content</span><br><span class="line">    title               = title_text.<span class="keyword">value</span></span><br><span class="line">    <span class="keyword">assert</span> title == <span class="symbol">'Using</span> xmerl <span class="keyword">module</span> <span class="keyword">to</span> parse xml document <span class="keyword">in</span> elixir'</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"># 对比上下两个测试方法的区别</span><br><span class="line">test <span class="string">"Test parsing xml document NEW"</span> <span class="keyword">do</span></span><br><span class="line">    &#123;document, _&#125; = :xmerl_scan.<span class="built_in">string</span>(<span class="type">String</span>.to_char_list(sample_xml))</span><br><span class="line">    [element] = :xmerl_xpath.<span class="built_in">string</span>(<span class="char">'/blog/title/text()'</span>, document)</span><br><span class="line">    <span class="keyword">assert</span> xmlText(element, :<span class="keyword">value</span>)  == <span class="symbol">'Using</span> xmerl <span class="keyword">module</span> <span class="keyword">to</span> parse xml document <span class="keyword">in</span> elixir'</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>对比上面的代码, 我们通过<code>Record.defrecord</code>定义记录, 该记录是从Erlang的xmerl库中提取的(调用<code>Record.extract</code>), 该记录将作为测试模块的一个函数,我们可以通过下面的方法验证:</p>
<p>运行<code>iex</code>进入Elixir Shell, 并声明模块:</p>
<p><img src="http://developerworks.github.io/assets/elixir/671C1BC4-418A-4B67-9A35-5B0DDCA3E293.png" alt="导入xmerl模块的记录为Elixir模块函数"></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test <span class="string">"Test parsing xml document"</span> <span class="built_in">do</span></span><br><span class="line">    <span class="comment"># 解析XML文档</span></span><br><span class="line">    &#123;document, _&#125; = :xmerl_scan.<span class="keyword">string</span>(String.to_char_list(sample_xml))</span><br><span class="line">    <span class="comment"># XPATH查询</span></span><br><span class="line">    [<span class="keyword">element</span>] = :xmerl_xpath.<span class="keyword">string</span>(<span class="string">'/blog/title/text()'</span>, document)</span><br><span class="line">    <span class="comment"># 断言</span></span><br><span class="line">    assert xmlText(<span class="keyword">element</span>, :<span class="built_in">value</span>)  == <span class="string">'Using xmerl module to parse xml document in elixir'</span></span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<h2 id="完整的代码">完整的代码</h2><p><a href="https://gist.github.com/94ce9976fc52e04e572a" target="_blank" rel="external">https://gist.github.com/94ce9976fc52e04e572a</a></p>
<h2 id="完整的项目代码">完整的项目代码</h2><p><a href="https://github.com/developerworks/xml_parsing" target="_blank" rel="external">https://github.com/developerworks/xml_parsing</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li>ELIXIR AND XML<br><a href="http://erlangcentral.org/wiki/index.php?title=Elixir_and_XML" target="_blank" rel="external">http://erlangcentral.org/wiki/index.php?title=Elixir_and_XML</a></li>
<li>028: Parsing XML<br><a href="http://elixirsips.com/episodes/028_parsing_xml.html" target="_blank" rel="external">http://elixirsips.com/episodes/028_parsing_xml.html</a></li>
<li>常用的XML文档解析模块<br><a href="https://github.com/h4cc/awesome-elixir#xml" target="_blank" rel="external">https://github.com/h4cc/awesome-elixir#xml</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-29T12:15:28.000Z"><a href="/2014/12/29/ejabberd-using-mix-to-compile-ejabberd-module/">2014-12-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/29/ejabberd-using-mix-to-compile-ejabberd-module/">使用Elixir Mix编译Ejabberd模块</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>本文是基于Github上的一个项目的实践, 该项目包含了Ejabberd 14.07的头文件, 直接把开发好的模块放在<code>src</code>目录下,并执行:</p>
<p>克隆项目:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/scrogson/ejabberd_dev.git</span></span><br><span class="line">Cloning into <span class="string">'ejabberd_dev'</span><span class="keyword">...</span></span><br><span class="line">remote: Counting objects: <span class="number">39</span>, done.</span><br><span class="line">remote: Total <span class="number">39</span> (delta <span class="number">0</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</span><br><span class="line">Unpacking objects: <span class="number">100</span>% (<span class="number">39</span>/<span class="number">39</span>), done.</span><br><span class="line">Checking connectivity... done.</span><br></pre></td></tr></table></figure>
<p>进入项目目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ejabberd_dev</span><br></pre></td></tr></table></figure>
<p>编译:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix <span class="keyword">do</span> deps.<span class="keyword">get</span>, compile</span><br></pre></td></tr></table></figure>
<p>即可编译模块, 编译的Beam文件生成到<code>_build</code>目录中.</p>
<h2 id="TODO:">TODO:</h2><ul>
<li>开发一个Elixir Mix任务,把编译好的Beam文件复制到Ejabberd的部署目录</li>
<li>开发一个Elixir Mix任务, 用于更新Ejabberd新版本的头文件到<code>ejabberd_dev</code>项目目录</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-29T07:19:37.000Z"><a href="/2014/12/29/sequelize-create-index-in-v2/">2014-12-29</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/29/sequelize-create-index-in-v2/">Sequelize 定义索引</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Node的ORM框架Sequelize 2.0版本支持在模型定义文件中定义索引的创建, 2.0之前的版本, 需要通过Migration的方式创建.</p>
<h2 id="V1-7版本的创建方式">V1.7版本的创建方式</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migration.<span class="function"><span class="title">addIndex</span><span class="params">(<span class="string">'partner'</span>, [<span class="string">'name'</span>, <span class="string">'cellphone'</span>])</span></span></span><br></pre></td></tr></table></figure>
<h2 id="V2版本的创建方式">V2版本的创建方式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="params">(sequelize, DataTypes)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> partner = sequelize.define(<span class="string">'partner'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER,</span><br><span class="line">      primaryKey: <span class="literal">true</span>,</span><br><span class="line">      autoIncrement: <span class="literal">true</span>,</span><br><span class="line">      comment: <span class="string">'合作伙伴ID'</span>,</span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">32</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      comment: <span class="string">'合作伙伴名称,可以是个人也可以使组织机构'</span>,</span><br><span class="line">      description: <span class="string">'合作伙伴名称,可以是个人也可以使组织机构'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    concat: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">16</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      comment: <span class="string">'联系人姓名'</span>,</span><br><span class="line">      description: <span class="string">'联系人姓名'</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    cellphone: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">11</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      comment: <span class="string">'联系人手机号码'</span>,</span><br><span class="line">      description: <span class="string">'联系人手机号码'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    email: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">64</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span>,</span><br><span class="line">      comment: <span class="string">'联系人电子邮件地址'</span>,</span><br><span class="line">      description: <span class="string">'联系人电子邮件地址'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    status: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">16</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      defaultValue: <span class="string">'PENDING'</span>, <span class="comment">// 'APPROVED, REJECTED',</span></span><br><span class="line">      comment: <span class="string">'合作伙伴状态,PENDING:等待审核,APPROVED:已经核准,REJECTED:已拒绝'</span>,</span><br><span class="line">      description: <span class="string">'合作伙伴状态,PENDING:等待审核,APPROVED:已经核准,REJECTED:已拒绝'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    comment: <span class="string">'合作伙伴信息表'</span>,</span><br><span class="line">    classMethods: &#123;</span><br><span class="line">      associate: <span class="function"><span class="keyword">function</span> <span class="params">(models)</span> </span>&#123;</span><br><span class="line">        partner.hasMany(models.map);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    getterMethods: &#123;</span><br><span class="line">      created_at: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> moment(<span class="keyword">this</span>.getDataValue(<span class="string">'created_at'</span>)).format(<span class="string">'YYYY-MM-DD'</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      updated_at: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> moment(<span class="keyword">this</span>.getDataValue(<span class="string">'updated_at'</span>)).format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      deleted_at: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> moment(<span class="keyword">this</span>.getDataValue(<span class="string">'deleted_at'</span>)).format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    indexes: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">'partner_unique_index_name'</span>,</span><br><span class="line">        unique: <span class="literal">true</span>,</span><br><span class="line">        method: <span class="string">'BTREE'</span>,</span><br><span class="line">        fields: [<span class="string">'name'</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">'partner_unique_index_cellphone'</span>,</span><br><span class="line">        unique: <span class="literal">true</span>,</span><br><span class="line">        method: <span class="string">'BTREE'</span>,</span><br><span class="line">        fields: [<span class="string">'cellphone'</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;);</span><br><span class="line">  partner._status = &#123;</span><br><span class="line">    PENDING: <span class="string">'PENDING'</span>,</span><br><span class="line">    APPROVED: <span class="string">'APPROVED'</span>,</span><br><span class="line">    REJECTED: <span class="string">'REJECTED'</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> partner;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-23T19:13:52.000Z"><a href="/2014/12/24/javascript-osm-building/">2014-12-24</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/24/javascript-osm-building/">OSM building</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>OSM Buildings 是一个OpenStreetMaps建筑几何体的可视化库.</p>
<p><img src="http://developerworks.github.io/assets/leafletjs/412EEDB9-268F-4D6A-9243-845A632F9A80.png" alt="龙湖北城天街OSM Buildings"></p>
<ul>
<li><p>从 <code>0.2.2</code> 开始如下方法名称被重命名</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">loadData</span><span class="params">()</span></span> -&gt; <span class="function"><span class="title">load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">setData</span><span class="params">()</span></span> -&gt; <span class="function"><span class="title">set</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">setStyle</span><span class="params">()</span></span> -&gt; <span class="function"><span class="title">style</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">setDate</span><span class="params">()</span></span> -&gt; <span class="function"><span class="title">date</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>与Leaflet集成</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"OSMBuildings-Leaflet.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化地图引擎并添加地图Tile层</p>
  <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 瓦片模板</span></span><br><span class="line"><span class="tag">new</span> <span class="tag">L</span><span class="class">.TileLayer</span>(</span><br><span class="line"><span class="string">'http://&#123;s&#125;.tiles.mapbox.com/v3/osmbuildings.kbpalbpk/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png'</span>,</span><br><span class="line">&#123; <span class="attribute">attribution</span>: <span class="string">'Map tiles &amp;copy; &lt;a href="http://mapbox.com"&gt;MapBox&lt;/a&gt;'</span>, <span class="attribute">maxNativeZoom</span>: <span class="number">19</span>, <span class="attribute">maxZoom</span>: <span class="number">21</span> &#125;</span><br><span class="line">)<span class="class">.addTo</span>(map);</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置GeoJSON数据</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==========</span></span><br><span class="line"><span class="comment">// GeoJSON层</span></span><br><span class="line"><span class="comment">// ==========</span></span><br><span class="line"><span class="keyword">var</span> geojsonLayer = L.geoJson([longforGeojsonFeature], &#123;</span><br><span class="line">  style: <span class="function"><span class="keyword">function</span> <span class="params">(feature)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> feature.properties &amp;&amp; feature.properties.style;</span><br><span class="line">  &#125;,</span><br><span class="line">  onEachFeature: <span class="function"><span class="keyword">function</span> <span class="params">(feature, layer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(feature);</span><br><span class="line">    layer.bindPopup(feature.properties.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).addTo(map);</span><br></pre></td></tr></table></figure>
</li>
<li><p>集成OSM Buildings显示3D建筑物:</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============================</span></span><br><span class="line"><span class="comment">// 集成OSM Buildings显示3D建筑物</span></span><br><span class="line"><span class="comment">// ============================</span></span><br><span class="line"><span class="comment">// 加载数据</span></span><br><span class="line"><span class="keyword">var</span> osmb = <span class="keyword">new</span> OSMBuildings(map)</span><br><span class="line">  .date(<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2014</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">0</span>))</span><br><span class="line">  .load()</span><br><span class="line">  .click(<span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'feature clicked:'</span>, e);</span><br><span class="line">    osmb.getDetails(e.feature, <span class="function"><span class="keyword">function</span> <span class="params">(json)</span> </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(json.features[<span class="number">0</span>].properties.tags);</span><br><span class="line">      <span class="keyword">var</span> popup = L.popup()</span><br><span class="line">        .setLatLng([<span class="number">29.58170544840436</span>, <span class="number">106.53061509132385</span>])</span><br><span class="line">        .setContent(</span><br><span class="line">            <span class="string">'&lt;h3 style="margin: 5px 0"&gt;'</span> +</span><br><span class="line">            json.features[<span class="number">0</span>].properties.tags.name + <span class="string">'&lt;/h3&gt;'</span> + <span class="string">'&lt;br/&gt;'</span> +</span><br><span class="line">            json.features[<span class="number">0</span>].properties.tags.description</span><br><span class="line">        )</span><br><span class="line">        .openOn(map);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">// 加载层切换器</span></span><br><span class="line">L.control.layers(&#123;&#125;, &#123; Buildings: osmb &#125;).addTo(map);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="完整项目代码">完整项目代码</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/developerworks/leaflet-longfor.git</span></span><br><span class="line">cd leaflet-longfor</span><br><span class="line">bower install</span><br><span class="line">npm install</span><br><span class="line"><span class="preprocessor"># 启动Web服务器</span></span><br><span class="line">python -m SimpleHTTPServer <span class="number">8888</span> <span class="preprocessor"># Python 2.7</span></span><br><span class="line">python -m http.<span class="keyword">server</span> <span class="number">8888</span>      <span class="preprocessor"># Python 3</span></span><br><span class="line"><span class="preprocessor"># 浏览器地址栏</span></span><br><span class="line">http:<span class="comment">//localhost:8888/examples</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><p>Leafletjs API参考手册<br><a href="http://leafletjs.com/reference.html" target="_blank" rel="external">http://leafletjs.com/reference.html</a></p>
</li>
<li><p>OSM Buidling Github项目地址<br><a href="https://github.com/kekscom/osmbuildings" target="_blank" rel="external">https://github.com/kekscom/osmbuildings</a></p>
</li>
<li><p>Leaflet 集成 OSM Buildings 显示 3D 建筑物<br><a href="http://www.cuitu.net/content/leaflet-ji-cheng-osm-buildings-xian-shi-3d-jian-zhu-wu" target="_blank" rel="external">http://www.cuitu.net/content/leaflet-ji-cheng-osm-buildings-xian-shi-3d-jian-zhu-wu</a></p>
</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-20T14:33:00.000Z"><a href="/2014/12/20/semantic-ui-get-started/">2014-12-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/20/semantic-ui-get-started/">Semantic UI 入门</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><img src="/assets/semantic-ui/logo.png" alt="Semantic UI"></p>
<h2 id="基本用法">基本用法</h2><p>在<code>&lt;head&gt;</code>内引入<code>dist/semantic.min.css</code>和<code>/dist/semantic.min.js</code>两个文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">type</span>=<span class="value">"text/css"</span> <span class="attribute">href</span>=<span class="value">"/dist/semantic.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/dist/semantic.min.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以使用单独的某个组件</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link <span class="variable">rel=</span><span class="string">"stylesheet"</span> <span class="variable">type=</span><span class="string">"text/css"</span> <span class="variable">href=</span><span class="string">"/dist/components/icon.css"</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="推荐用法">推荐用法</h2><p><img src="/assets/semantic-ui/gulp-install.gif" alt="gulp install"></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/Semantic-Org/Semantic-UI.git</span><br><span class="line"><span class="keyword">cd</span> Semantic-UI</span><br><span class="line">npm install</span><br><span class="line">gulp</span><br></pre></td></tr></table></figure>
<p>运行 <code>gulp</code> 进入交互式设置, 会问你一些问题, 仔细看, 仔细答.</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gulp            <span class="comment">// 安装后监视修改</span></span><br><span class="line">gulp build      <span class="comment">// 从源代码构建所有文件</span></span><br><span class="line">gulp clean      <span class="comment">// 清除dist目录</span></span><br><span class="line">gulp watch      <span class="comment">// 监视文件</span></span><br><span class="line">gulp install    <span class="comment">// 重新运行安装</span></span><br><span class="line">gulp <span class="keyword">help</span>       <span class="comment">// 列举所有命令</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-18T11:45:31.000Z"><a href="/2014/12/18/ejabberd-stream-management-for-mobile-3g-network/">2014-12-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/18/ejabberd-stream-management-for-mobile-3g-network/">移动3G网络下的流管理</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>这篇文章的起因是因为朋友开发的移动社交APP使用Ejabberd的时候遇到了3G网络频繁断开连接的问题.<br>由于3G网络的特性,在3G网络内的客户端IP可能是频繁变化的,你手持移动设备在不停的移动,遇到建筑物,<br>进入电梯等都可能导致3G网络突然中断.等你再次连接上服务器的时候,之前的状态就已经丢失了.</p>
<p>为了解决这类问题, XMPP基金会发布了一个XMPP扩展协议<a href="http://demo.netfoucs.com/yuedong56/article/details/38120101" target="_blank" rel="external">XEP-198 Stream Management</a> 类支持XMPP会话的恢复.</p>
<p>Ejabberd在14.05之后内置了对流管理的支持, 所以要使服务器支持流管理, 必须升级到至少14.05, Ejabberd的默认配置是打开了流管理功能的.</p>
<p>下面是服务器需要支持的配置选项:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">listen:</span><br><span class="line">  -</span><br><span class="line">    port: <span class="number">5222</span></span><br><span class="line">    module: ejabberd_c2s</span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## If TLS is compiled in and you installed a SSL</span></span><br><span class="line">    <span class="comment">## certificate, specify the full path to the</span></span><br><span class="line">    <span class="comment">## file and uncomment these lines:</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## certfile: "/path/to/ssl.pem"</span></span><br><span class="line">    <span class="comment">## starttls: true</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## To enforce TLS encryption for client connections,</span></span><br><span class="line">    <span class="comment">## use this instead of the "starttls" option:</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## starttls_required: true</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## Custom OpenSSL options</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## protocol_options:</span></span><br><span class="line">    <span class="comment">##   - "no_sslv3"</span></span><br><span class="line">    <span class="comment">##   - "no_tlsv1"</span></span><br><span class="line">    max_stanza_size: <span class="number">65536</span></span><br><span class="line">    shaper: c2s_shaper</span><br><span class="line">    access: c2s</span><br><span class="line">    zlib: <span class="constant">true</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## 打开(true)或关闭(false)Ejabberd的流管理(XEP 198)功能, 默认为true</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    stream_management: <span class="constant">true</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## 消息确认队列, 用于存储客户端未确认的消息队列, 用于重传, 当超过此限制时,</span></span><br><span class="line">    <span class="comment">## 客户端会话自动被Ejabberd终止, 有效值为正整数和`infinity`, 默认值为500</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    max_ack_queue: <span class="number">500</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## 会话超时是重传</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## 未被客户端确认的消息将在会话超时的时候重传(retransimission),</span></span><br><span class="line">    <span class="comment">## 该行为通常是我们所期望的, 但是在某些环境下可能导致不期望的结果, 比如:</span></span><br><span class="line">    <span class="comment">## 当一个消息同时发送给两个资源时, 如果一个资源超时, 那么另一个资源将收到服务器重传的消息,</span></span><br><span class="line">    <span class="comment">## 这不是我们所期望的结果. 因此Ejabberd默认对此选项的设置为false, 含义为当会话超时后,</span></span><br><span class="line">    <span class="comment">## 返回一个错误, 而不是重传消息</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## 为了避免上述两个资源其中一个超时的副作用,可以:</span></span><br><span class="line">    <span class="comment">## 1. 如果一个JID 只允许有一个 Resource同时在线, 那么我们可以把该选项设置为true</span></span><br><span class="line">    <span class="comment">## 2. 如果一个JID 允许不止一个 Resource同时在线, 建议把该选项设置为false</span></span><br><span class="line">    resend_on_timeout: <span class="constant">false</span></span><br></pre></td></tr></table></figure>
<p>要启用XMPP扩展协议XEP 198所描述的流恢复功能, 还需要客户端主动打开流恢复功能. 客户端要判断服务器是否支持流管理特性, 在流初始化阶段服务器会返回如下信息:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;stream:features <span class="variable">xmlns=</span><span class="string">"jabber:client"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>&gt;</span><br><span class="line">  &lt;bind <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-bind"</span>/&gt;</span><br><span class="line">  &lt;session <span class="variable">xmlns=</span><span class="string">"urn:ietf:params:xml:ns:xmpp-session"</span>/&gt;</span><br><span class="line">  &lt;sm <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:2"</span>/&gt;</span><br><span class="line">  &lt;sm <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span>/&gt;</span><br><span class="line">  &lt;csi <span class="variable">xmlns=</span><span class="string">"urn:xmpp:csi:0"</span>/&gt;</span><br><span class="line">  &lt;c <span class="variable">xmlns=</span><span class="string">"http://jabber.org/protocol/caps"</span></span><br><span class="line">    <span class="variable">hash=</span><span class="string">"sha-1"</span></span><br><span class="line">    <span class="variable">node=</span><span class="string">"http://www.process-one.net/en/ejabberd/"</span></span><br><span class="line">    <span class="variable">ver=</span><span class="string">"aIT+/ulfcbHXDKPkCA+iw9x5mU8="</span>/&gt;</span><br><span class="line">  &lt;register <span class="variable">xmlns=</span><span class="string">"http://jabber.org/features/iq-register"</span>/&gt;</span><br><span class="line">&lt;/stream:features&gt;</span><br></pre></td></tr></table></figure>
<p>如果包含:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">...</span></span><br><span class="line">&lt;sm xmlns=<span class="string">"urn:xmpp:sm:2"</span>/&gt;</span><br><span class="line">&lt;sm xmlns=<span class="string">"urn:xmpp:sm:3"</span>/&gt;</span><br><span class="line"><span class="keyword">...</span></span><br></pre></td></tr></table></figure>
<p>那么说明服务器是支持流管理特性的. 这个时候我们可以让客户端发送一个<code>&lt;enable&gt;</code>XML片段通知服务器端打开流管理.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">enable</span> <span class="attribute">xmlns</span>=<span class="value">'urn:xmpp:sm:3'</span> <span class="attribute">resume</span>=<span class="value">'true'</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时服务响应一个<code>&lt;enabled&gt;</code>标签,表示服务器的流管理已经打开.</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;enabled <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"g2gCbQAAABk5NDIyMTUxMzkxNDE4OTA0NzEwMjA1OTUxaANiAAAFimIADc4EYgAO508="</span></span><br><span class="line">    <span class="variable">resume=</span><span class="string">"true"</span></span><br><span class="line">    <span class="variable">max=</span><span class="string">"300"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span></span><br><span class="line">    <span class="variable">version=</span><span class="string">"1.0"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;enabled&gt;</code>标签上有几个重要的属性:</p>
<ul>
<li><code>id</code> 流管理的会话ID</li>
<li><code>resume</code> 是否支持流恢复</li>
<li><code>max</code> 会话超时时间</li>
</ul>
<p>上述的流管理会话的建立过程必须是在通过了身份认证之和资源绑定之后, 如果未<code>通过身份认证</code>和<code>资源绑定</code>尝试建立一个流管理会话将会得到一个<code>&lt;fail/&gt;</code>.</p>
<h2 id="流的恢复">流的恢复</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">resume</span></span><br><span class="line">    <span class="attribute">xmlns</span>=<span class="value">'urn:xmpp:sm:3'</span></span><br><span class="line">    <span class="attribute">h</span>=<span class="value">'some-sequence-number'</span></span><br><span class="line">    <span class="attribute">previd</span>=<span class="value">'g2gCbQAAABk5NDIyMTUxMzkxNDE4OTA0NzEwMjA1OTUxaANiAAAFimIADc4EYgAO508='</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><resume>必须带上<code>xmlns=&#39;urn:xmpp:sm:3&#39;</code>属性</resume></li>
<li><code>h</code> 表示断开连接之前最后一次从服务器收到的XML节的序列号</li>
<li><code>previd</code> 上一次流会话的ID</li>
</ul>
<p>客户端发送流恢复请求之后, 服务端会重新生成一个<code>id</code></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;enabled</span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"urn:xmpp:sm:3"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"g2gCbQAAABozNDY3MjMxMTkyMTQxODkwNjE4MDM1NjIwM2gDYgAABYpiAA3Tw2IAAlr+"</span></span><br><span class="line">    <span class="variable">resume=</span><span class="string">"true"</span></span><br><span class="line">    <span class="variable">max=</span><span class="string">"300"</span></span><br><span class="line">    xmlns:<span class="variable">stream=</span><span class="string">"http://etherx.jabber.org/streams"</span> <span class="variable">version=</span><span class="string">"1.0"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>我们看到服务器响应了一个<code>&lt;enabled&gt;</code>标签, 其属性<code>id</code>的值和之前是不同的.</p>
<p>客户端需要记录这个值, 以备下一次连接中断后的流恢复.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-18T07:47:48.000Z"><a href="/2014/12/18/elixir-understanding-macro-part-3/">2014-12-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/18/elixir-understanding-macro-part-3/">(译)理解Elixir宏第3部分</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>继续我们对宏的探索. 上一篇我概括了一些基本原理, 今天我们来讨论关于Elixir AST的一些细节.</p>
<h2 id="追踪函数调用">追踪函数调用</h2><h2 id="发现AST结构">发现AST结构</h2><h2 id="编写断言宏">编写断言宏</h2><h2 id="序列化代码">序列化代码</h2>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-18T07:45:38.000Z"><a href="/2014/12/18/elixir-understanding-macro-part-2/">2014-12-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/18/elixir-understanding-macro-part-2/">(译)理解Elixir宏第2部分</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>这是理解Elixir宏系列文章的第二篇. <a href="/2014/12/18/elixir-understanding-macro-part-1/">上一篇</a>讨论了<code>编译阶段</code>和<code>Elixir宏</code></p>
<h2 id="调用宏">调用宏</h2><p>要知道在编译过程的展开阶段最重要的事情是: 编译器调用各种宏(以及其他代码生成构造), 并产生最终的AST.</p>
<p>例如, 一个经典的对<code>trace</code>宏的使用示例如下:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义了我们的应用模块</span></span><br><span class="line">defmodule MyModule do</span><br><span class="line">  <span class="comment"># 包含了我们需要用到的代码调试和追踪模块</span></span><br><span class="line">  <span class="keyword">require</span> Tracer</span><br><span class="line">  <span class="keyword">...</span></span><br><span class="line">  def some_fun(<span class="keyword">...</span>) do</span><br><span class="line">    <span class="comment"># 调用具体的追踪模块调试代码</span></span><br><span class="line">    Tracer.trace(<span class="keyword">...</span>)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="Hygiene">Hygiene</h2><p>上一章提到过, 宏默认是<code>hygienic</code>的. 其含义是: 宏引入的变量有其自己的私有作用域, 不会影响代码的其他部分. 这就是为什么我们能安全地在<code>trace</code>宏中引入<code>result</code>变量.</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quote <span class="keyword">do</span></span><br><span class="line">    <span class="literal">result</span> = unquote(expression_ast) <span class="comment"># result 变量是宏的私有变量</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>该变量不会干扰调用这个宏的代码. 在调用宏的地方, 可以随意的声明你自己的<code>result</code>变量, 它不会被<code>tracer</code>宏中的<code>result</code>变量隐藏.</p>
<p>大多数时候<code>hygiene</code>是我们想要的效果, 但是也有例外. 有时候, 可能需要创建在调用者作用域内可用的变量. 下面我们通过Plug库的一个用例来演示, 我们如何使用Plug来制定路由:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">get <span class="string">"/resource1"</span> do</span><br><span class="line">    send_resp(conn, <span class="number">200</span>, <span class="keyword">...</span>)</span><br><span class="line">end</span><br><span class="line">post <span class="string">"/resource2"</span> do</span><br><span class="line">    send_resp(conn, <span class="number">200</span>, <span class="keyword">...</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>注意,上面这两个宏如何使用并不存在的<code>conn</code>变量. 这是因为, <code>get</code>宏在生成的代码中绑定了该变量. 可以想象一下, 产生的代码如下:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defp do_match(<span class="string">"GET"</span>, <span class="string">"/resource1"</span>, conn) do</span><br><span class="line">    <span class="keyword">...</span></span><br><span class="line">end</span><br><span class="line">defp do_match(<span class="string">"POST"</span>, <span class="string">"/resource2"</span>, conn) do</span><br><span class="line">    <span class="keyword">...</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>注意: Plug产生的真实代码是不同的, 这里为了演示对其进行了简化.</p>
<p>这是一个例子, 宏引入了一个变量, 必须不是<code>hygienic</code>. 变量<code>conn</code>由<code>get</code>宏引入, 必须对调用者可见.</p>
<h2 id="宏参数">宏参数</h2><h2 id="揉到一起">揉到一起</h2><h2 id="使用模块">使用模块</h2><p>查看上面的代码, 函数<code>match/2</code>是在客户端模块中实现. 这确实是太不完美了, 因为每个客户端模块都必须提供该函数的正确实现,并知道<code>do_match</code>函数如何调用.</p>
<p>如果<code>Plug.Router</code>能够提供<code>match/2</code>的实现是不是更好. 对此我们可以采用<code>use</code>宏, 它初略地等同于其他语言中的Mixin.</p>
<p>普遍的思想是:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端模块部分</span></span><br><span class="line">defmodule ClientCode do</span><br><span class="line">  <span class="comment"># invokes the mixin</span></span><br><span class="line">  use GenericCode, option_1: value_1, option_2: value_2, <span class="keyword">...</span></span><br><span class="line">end</span><br><span class="line"><span class="comment"># 通用代码部分</span></span><br><span class="line">defmodule GenericCode do</span><br><span class="line">  <span class="comment"># called when the module is used</span></span><br><span class="line">  defmacro __using__(options) do</span><br><span class="line">    <span class="comment"># generates an AST that will be inserted in place of the use</span></span><br><span class="line">    quote do</span><br><span class="line">      <span class="keyword">...</span></span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><code>use</code>机制允许我们在调用者的上下文种注入代码, 这类似于如下这种替代形式:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defmodule ClientCode do</span><br><span class="line">    <span class="comment"># 加载通用模块</span></span><br><span class="line">    <span class="keyword">require</span> GenericCode</span><br><span class="line">    <span class="comment"># 调用通用模块中的公共函数</span></span><br><span class="line">    GenericCode.__using__(<span class="keyword">...</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其可以通过<code>use</code>宏的<a href="https://github.com/elixir-lang/elixir/blob/v0.14.0/lib/elixir/lib/kernel.ex#L3531-L3532" target="_blank" rel="external">Elixir实现源代码</a>得到证明. 同时还证明了另一点 - 增量展开.</p>
<p><code>use</code>宏生成了调用其他宏的代码. 说的更明白一点, <code>use</code>生成了用于生成代码的代码(use生成了代码,生成的代码又用于生成其他的代码), 早前我们曾说过, 编译器会递归地展开它所发现的所有宏定义, 直到没有可展开的宏为止.</p>
<p>拥有了这方面的知识, 现在可以转移到<code>Plug.Router</code>通用模块的<code>match</code>函数的实现.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Plug</span>.<span class="constant">Router </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span>(<span class="constant">_options)</span> </span><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 译注:</span></span><br><span class="line">    <span class="comment"># 在调用者use本模块的时候返回一个AST结构,并插入到use被使用的位置</span></span><br><span class="line">    <span class="comment"># 如果你有Web的开发经验, 类似于在DOM树中插入一个子树或子节点,用于改变整个DOM树的结构,</span></span><br><span class="line">    <span class="comment"># 类似的__using__宏返回一个AST片段, 并插入到调用代码的位置, 也就是在客户端模块中`use`宏使用的位置</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># 导入自身, 以便在客户端代码中不必以`Plug.Router.get`的形式使用,而是直接使用`get`</span></span><br><span class="line">      import <span class="constant">Plug.Router</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">match</span>(type, route) </span><span class="keyword">do</span></span><br><span class="line">        do_match(type, route, <span class="symbol">:dummy_connection</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">get</span>(route, body) </span><span class="keyword">do</span></span><br><span class="line">    ... <span class="comment"># 这里的代码保持原样</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这样, 我们就可以把客户端模块的代码保持的非常苗条:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyRouter <span class="built_in">do</span></span><br><span class="line">  <span class="comment"># 使用Plug.Router模块,同时在编译阶段(具体实际上是展开阶段),运行该模块中的`__using__`宏,</span></span><br><span class="line">  <span class="comment"># 并把`__using__`返回的AST片段插入到当前位置</span></span><br><span class="line">  use Plug.Router</span><br><span class="line">  <span class="built_in">get</span> <span class="string">"/hello"</span>, <span class="built_in">do</span>: &#123;conn, <span class="string">"Hi!"</span>&#125;</span><br><span class="line">  <span class="built_in">get</span> <span class="string">"/goodbye"</span>, <span class="built_in">do</span>: &#123;conn, <span class="string">"Bye!"</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>前面曾提到, 由<code>__using__</code>宏生成的AST片段只是简单地插入到<code>use Plug.Router</code>调用的位置. 特别注意的是, 在<code>__use___</code>宏定义中的<code>import Plug.Router</code>, 严格意义上并不需要这行代码, 它只是使客户端代码变得更加简洁一些, 你可以使用<code>get</code>, 而不必输入其全称<code>Plug.Router.get</code>.</p>
<p>下面这段就不译了, 一堆废话, 看得懂的看, 看不懂的可以忽略.</p>
<p>So what have we gained? The various boilerplate is now confined to the single place (<code>Plug.Router</code>).<br>Not only does this simplify the client code, it also keeps the abstraction properly closed.<br>The module <code>Plug.Router</code> ensures that whatever is generated by get macros fits properly with the generic code of <code>match</code>.<br>As clients, we simply use the module and call into the provided macros to assemble our router.</p>
<p>This concludes today’s session. Many details are not covered,<br>but hopefully you have a better understanding of how macros integrate with the Elixir compiler.<br>In the next part I’ll dive deeper and start exploring how we can tear apart the input AST.</p>
<h2 id="译注">译注</h2><p>对于<code>use</code>的使用我们可以理解为:</p>
<ul>
<li>PHP中的<code>require &#39;database.php&#39;</code>和<code>include &#39;database.php&#39;</code></li>
<li>Java中的<code>import com.mysql.jdbc.Driver;</code></li>
<li>Python中的<code>import amqp</code></li>
<li>C中的<code>include &lt;stdlib.h&gt;</code></li>
</ul>
<p>它是在编译过程中的展开阶段对代码(AST)进行修改和装饰, 并把修改过的代码(AST)插入到使用的位置.</p>
<h2 id="原文">原文</h2><p><a href="http://www.theerlangelist.com/2014/06/understanding-elixir-macros-part-2.html" target="_blank" rel="external">http://www.theerlangelist.com/2014/06/understanding-elixir-macros-part-2.html</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-17T16:02:39.000Z"><a href="/2014/12/18/elixir-understanding-macro-part-1/">2014-12-18</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/18/elixir-understanding-macro-part-1/">(译)理解Elixir宏第1部分</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>本文中的某些概念, 你最好事先了解过编译原理, 以及抽象语法树的(AST)概念, 否则本文中所描述的东西可能对你来说是看不懂的天书.</p>
<h2 id="编译过程">编译过程</h2><p><img src="/assets/elixir/compile-process.png" alt="Elixir源码编译过程图示"></p>
<p>通过上图的Elixir编译器的编译过程我们看到:</p>
<ol>
<li>Elixir源码通过第一步解析过程生成了一个AST 1的中间形式(以Elixir嵌套Term的形式来表示抽象语法树)</li>
<li>AST 1通过(展开<code>expansion</code>)转换为Expanded AST(已展开的抽象语法树)</li>
<li>展开的AST被转换成字节码</li>
</ol>
<p>这只是一个近似的过程, 实际上Elixir编译器会生成Erlang AST, 并依赖于底层的Erlang函数把它转换成字节码.</p>
<h2 id="创建AST片段">创建AST片段</h2><p>什么是Elixir AST ? 它是一个Elixir Term, 一个深度嵌套的层次结构, 用于表述一个语法正确的Elixir代码. 为了说得更明白一些, 举个例子. 要生成某段代码的AST, 可以使用<code>quote</code>:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">1</span>)&gt; quoted = <span class="keyword">quote</span> <span class="keyword">do</span> <span class="number">1</span> + <span class="number">2</span> dn</span><br><span class="line">&#123;<span class="symbol">:+</span>, [<span class="symbol">context:</span> <span class="constant">Elixir,</span> <span class="symbol">import:</span> <span class="constant">Kernel]</span>, [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>Quote 以任意复杂的Elixir表达式作为输入,并返回相应的描述该输入代码的AST.</p>
<p>此例中, 生成的AST片段描述一个简单的求和操作(1+2). 通常称为<code>quoted expression</code>. 大多数时候不需要理解quoted结构的具体细节, 来看一个简单的例子. 在这种情况下, AST片段是一个包含如下元素的三元组(triplet)</p>
<ul>
<li>一个操作符原子</li>
<li>表达式上下文(比如, import和aliases).大多数时候不需要理解该数据</li>
<li>操作参数(operands)</li>
</ul>
<p>要点: <code>quoted expression</code>是一个描述代码的Elixir term. 编译器会使用它生成最终的字节码.</p>
<p>虽然不常见, 对一个quoted expression求值也是可以的.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">2</span>)</span>&gt; C<span class="title">ode</span>.<span class="title">eval_quoted</span><span class="params">(quoted)</span></span><br><span class="line">&#123;3, []&#125;</span></span><br></pre></td></tr></table></figure>
<p>求值结果为一个元组, 包含表达式的求值结果, 以及构成该表达式的变量.</p>
<p>但是, 在AST被求值前(通常由编译器完成), quoted expression 并没有通过语义上的验证. 例如, 当我们书写如下表达式时:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">3</span>)&gt; <span class="operator">a</span> + b</span><br><span class="line">** (RuntimeError) undefined <span class="function"><span class="keyword">function</span>: <span class="title">a</span>/<span class="title">0</span></span></span><br></pre></td></tr></table></figure>
<p>得到了一个错误, 因为这里还不存在一个名为<code>a</code>的变量或函数.</p>
<p>相比而言, 如果quote一个表达式:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="number">4</span>)&gt; <span class="tag">quote</span> <span class="tag">do</span> <span class="tag">a</span> + <span class="tag">b</span> <span class="tag">end</span></span><br><span class="line">&#123;:+, <span class="attr_selector">[context: Elixir, import: Kernel]</span>, <span class="attr_selector">[&#123;:a, []</span>, <span class="tag">Elixir</span>&#125;, &#123;<span class="pseudo">:b</span>, <span class="attr_selector">[]</span>, <span class="tag">Elixir</span>&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>而没有发生错误, 我们有了一个表达式 <code>a+b</code>的quoted表示. 其意思是, 生成了一个描述表达式<code>a+b</code>的term, 不管表达式中的变量是否存在. 最终的代码并没有生成, 所以这里不会有错误.</p>
<p>如果把该表述插入到某些a和b是有效标识符的AST中, 刚才发生错误的代码<code>a+b</code>,才是正确的. 下面来试一下, 首先quote一个求和(sum)表达式:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">5</span>)&gt; sum_expr = <span class="constant">quote</span> <span class="built_in">do</span> <span class="operator">a</span> + b <span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>然后创建一个quoted变量绑定表达式:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">6</span>) bind_expr = <span class="constant">quote</span> <span class="built_in">do</span></span><br><span class="line">         <span class="operator">a</span> = <span class="number">1</span></span><br><span class="line">         b = <span class="number">2</span></span><br><span class="line">       <span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>再说一遍, 记住这仅仅是quoted的表达式, 他们只是描述代码的简单数据, 并没有执行任何求值. 特别是, 变量 <code>a</code> 和 <code>b</code> 在当前的Elixir shell会话中并不存在.</p>
<p>要使这些片段能够一起工作, 必须把它们连接起来:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">7</span>) final_expr = <span class="constant">quote</span> <span class="built_in">do</span></span><br><span class="line">         unquote(bind_expr)</span><br><span class="line">         unquote(sum_expr)</span><br><span class="line">       <span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>这里,我们生成了一个新的quoted表达式<code>final_expr</code>, 由<code>bind_expr</code>表达式和<code>sum_expr</code>表达式构成.</p>
<p>下面可以对最终的AST求值:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">iex(8)&gt; Code.eval_quoted(final_expr)</span><br><span class="line">&#123;3, [</span><span class="expression">&#123;&#123;:<span class="variable">a</span>, <span class="variable">Elixir</span>&#125;, 1&#125;, &#123;&#123;:<span class="variable">b</span>, <span class="variable">Elixir</span>&#125;, 2&#125;]&#125;</span></span><br></pre></td></tr></table></figure>
<p>求值结果由一个<code>表达式</code>, 一个<code>变量绑定列表</code>构成. 形如:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;expression, [&#123;&#123;:variable,Elixir&#125;, value&#125;,<span class="keyword">...</span>]&#125;</span><br><span class="line">===========      ========          ======</span><br><span class="line">  |                 |                 |</span><br><span class="line">表达式            变量名称           变量的值</span><br></pre></td></tr></table></figure>
<p>从这个绑定列表中我们可以看出, 该表达式绑定了两个变量<code>a</code>和<code>b</code>, 对应的值分别为<code>1</code>和<code>2</code></p>
<p>这就是在Elixir中元编程方法的核心. 当我们进行元编程的时候, 我们基本上是把各种AST片段组合起来生成新的AST. 我们通常对输入AST的内容和结构不感兴趣, 相反, 我们使用<code>quote</code>生成和组合输入片段,并生成经过修饰的代码.</p>
<h2 id="Unquoting">Unquoting</h2><p><code>unquote</code>上场了. 注意不管<code>quote</code>块里面包含什么, 它只是把<code>quote ... end</code>块里面的达式转换成AST片段. 这意味着我们不能以常规方式注入存在于quote外部的变量的内容. 看看上面这个例子, 它是不可能工作的:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">quote</span> <span class="built_in">do</span></span><br><span class="line">  bind_expr</span><br><span class="line">  sum_expr</span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>在这个例子中, quote仅仅是简单的生成对<code>bind_expr</code>和<code>sum_expr</code>的变量引用, 但这不是我想要的结果. 我需要的效果是有一种方式能够直接注入<code>bind_expr</code>和<code>sum_expr</code>的内容到生成的AST的对应的位置.</p>
<p>这就是<code>unquote(...)</code>的用途 - 括号内的表达式被立即进行求值, 并就地插入到<code>unquote</code>调用的位置. 这意味着 <code>unquote</code> 的结果也必须是一个有效的AST片段.</p>
<p>理解<code>unquote</code>的另一种方式是, 可以把它看做是字符串插值 (<code>#{}</code>). 对于字符串你可以这样写:</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"....<span class="subst">#&#123;some_expression&#125;</span>...."</span></span><br></pre></td></tr></table></figure>
<p>类似的, 对于quote可以这样写:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">quote do</span><br><span class="line">    <span class="keyword">...</span></span><br><span class="line">    unquote(some_expression)</span><br><span class="line">    <span class="keyword">...</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>对此两种情况, 求值的表达式必须在当前上下文中是有效的, 并注入该结果到你构建的表达式中.(要么是符串, 或者是一个AST片段)</p>
<p>重要的时理解其含义, unquote并不是quote的反向过程. 如果需要把一个quoted expression转换为字符串, 可以使用<code>Macro.to_string/1</code></p>
<h2 id="例子:_追踪表达式">例子: 追踪表达式</h2><p>让我们把这些理论组合到一个简单的例子中. 我们会编写一个宏来帮助我们调试代码. 下面是这个宏的使用方式:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">1</span>)</span></span>&gt; Tracer.<span class="function"><span class="title">trace</span><span class="params">(<span class="number">1</span> + <span class="number">2</span>)</span></span></span><br><span class="line">Result of <span class="number">1</span> + <span class="number">2</span>: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p><code>Tracer.trace</code>以一个给定的表达式并打印其结果到屏幕上. 然后返回表达式结果.</p>
<p>重要的是,意识到这是一个宏, 其输入表达式<code>(1 + 2)</code>会被转换为一个更加复杂的形式 - 一段打印结果并返回该结果的代码.该转换发生在宏展开的时候, 产生的字节码为输入代码经过修饰的版本.</p>
<p>在查看实现之前, 想象一下最终结果. 当我们调用<code>Tracer.trace(1+2)</code>时, 对应产生的字节码类似于这样:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mangled_result = <span class="number">1</span> + <span class="number">2</span></span><br><span class="line">Tracer.<span class="function"><span class="title">print</span><span class="params">(<span class="string">"1+2"</span>, mangled_result)</span></span></span><br><span class="line">mangled_result</span><br></pre></td></tr></table></figure>
<h2 id="展开AST">展开AST</h2><p>在Shell观察其是如何连接起来是很容易的. 启动<code>iex</code> Shell, 复制粘贴上面定义的<code>Tracer</code>模块:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">1</span>)&gt; defmodule Tracer do</span><br><span class="line">          <span class="keyword">...</span></span><br><span class="line">        end</span><br></pre></td></tr></table></figure>
<p>然后, 必须<code>require Tracer</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">2</span>)</span></span>&gt; require Tracer</span><br></pre></td></tr></table></figure>
<p>接下来, 对<code>trace</code>的宏调用进行quote操作</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">iex(3)&gt; quoted = quote do Tracer.trace(1+2) end</span><br><span class="line"></span><span class="expression">&#123;&#123;:<span class="variable">.</span>, [], [&#123;:__<span class="variable">aliases</span>__, [<span class="variable">alias</span>: <span class="variable">false</span>], [:<span class="variable">Tracer</span>]&#125;, :<span class="variable">trace</span>]&#125;, [],</span><br><span class="line"> [&#123;:+, [<span class="variable">context</span>: <span class="variable">Elixir</span>, <span class="variable">import</span>: <span class="variable">Kernel</span>], [1, 2]&#125;]&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在, 输出看起来有点可怕, 通常你不必需要理解它. 但是如果你仔细看, 在这个结构中你可以看到<code>Tracer</code>和<code>trace</code>, 这证明了AST片段是何源代码相对应的, 但还未展开.</p>
<h2 id="参考资料">参考资料</h2><h2 id="概念补充">概念补充</h2><ul>
<li><p>Hygiene</p>
<p>  用不冲突的名称替换引入的变量名，这种方法称为健康的(<code>hygiene</code>);产生的宏称为健康的宏(<code>hygienic macros</code>).健康的宏可以安全地在任何地方使用，不必担心与现有的变量名冲突。对于许多元编程任务，这个特性使宏更可预测并容易使用。</p>
<p>  Hygiene 宏的引入是为了解决<code>宏定义上下文</code>和<code>宏调用上下文</code>变量名称冲突的问题.</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-15T08:51:37.000Z"><a href="/2014/12/15/nodejs-npm-disable-spinner-and-show-http-log/">2014-12-15</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/15/nodejs-npm-disable-spinner-and-show-http-log/">在新版本的npm恢复老版本的下载状态风格</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>新版本的npm在安装或更新包的时候, 显示的一个spinner一直在旋转, 特别是在网络速度不好的情况下体验感非常差.</p>
<p>老版本的npm安装包的时候显示的过程是这样的:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm http GET <span class="string">https:</span><span class="comment">//registry.npmjs.org/repeating/-/repeating-1.1.0.tgz</span></span><br><span class="line">npm http <span class="number">304</span> <span class="string">https:</span><span class="comment">//registry.npmjs.org/graceful-fs</span></span><br></pre></td></tr></table></figure>
<p>新版本显示的却是这样的:</p>
<p><img src="/assets/images/a5ff54aa-e577-11e3-8baa-43e1a81fba84.gif" alt="NPM新版本进度指示器"></p>
<p>恢复到老版本的进度显示风格可以使用下面的命令完成:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> spin=<span class="constant">false</span></span><br><span class="line">npm config <span class="built_in">set</span> loglevel=<span class="keyword">http</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://github.com/npm/npm/issues/5340" target="_blank" rel="external">https://github.com/npm/npm/issues/5340</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-13T19:32:08.000Z"><a href="/2014/12/14/songs-wangfei-fleet-of-time/">2014-12-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/14/songs-wangfei-fleet-of-time/">Fleet of time &lt;&lt;匆匆那年&gt; 王菲</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>&lt;&lt;匆匆那年&gt;&gt; 王菲</p>
<pre><code>匆匆那年我们究竟说了几遍 再见之后再拖延
可惜谁有没有爱过不是一场 七情上面的雄辩

匆匆那年我们一时匆忙撂下难以承受的诺言
只有等别人兑现

不 怪那 吻痕 还 没积累成茧
拥 抱着冬眠 也 没能羽化再成仙

不 怪这一段情 没空反复再排练
是 岁月宽容恩赐 反悔的时间...

<span class="attr_selector">[REPEAT 1]</span> 如果再见不能红着眼 是否还能红着脸
<span class="attr_selector">[REPEAT 1]</span> 就像那年 匆促刻下 永远一起 那样美丽的谣言
<span class="attr_selector">[REPEAT 1]</span> 如果过去还值得眷恋 别太快冰释前嫌
<span class="attr_selector">[REPEAT 1]</span> 谁 甘心 就这样 彼此无挂也无牵

我 们要互相 亏欠 要 不然 凭何怀缅

....

匆匆那年我们见过太少世面 只爱看同一张脸
那么莫名其妙 那么讨人欢喜 闹起来又太讨厌

相爱那年活该 匆匆因为我们不懂顽固的诺言
只 是分手的前言

不 怪哪天太冷 泪 滴水成冰
春 风也一样没 吹进凝固的照片

不 怪每一个人 没能完整爱一遍
是 岁月善意落下 残缺的悬念

<span class="attr_selector">[REPEAT 2]</span> 如果再见不能红着眼 是否还能红着脸
<span class="attr_selector">[REPEAT 2]</span> 就像那年 匆促刻下 永远一起 那样美丽的谣言
<span class="attr_selector">[REPEAT 2]</span> 如果过去还值得眷恋 别太快冰释前嫌
<span class="attr_selector">[REPEAT 2]</span> 谁 甘心 就这样 彼此无挂也无牵

<span class="attr_selector">[REPEAT 3]</span> 如果再见不能红着眼 是否还能红着脸
<span class="attr_selector">[REPEAT 3]</span> 就像那年 匆促刻下 永远一起 那样美丽的谣言
<span class="attr_selector">[REPEAT 3]</span> 如果过去还值得眷恋 别太快冰释前嫌
<span class="attr_selector">[REPEAT 3]</span> 谁 甘心 就这样 彼此无挂也无牵

我们要互相亏欠 我们要藕断丝连
</code></pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-13T14:29:53.000Z"><a href="/2014/12/13/elixir-httpclient-httpotion/">2014-12-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/13/elixir-httpclient-httpotion/">HTTP客户端Httpotion</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="步骤">步骤</h2><p>本文描述如何使用Elixir的httpotion模块调用豆瓣图书API获取图书信息.</p>
<pre><code>root@7bf32c349b69:~# mix new douban_book_api_v2
<span class="comment">* creating README.md</span>
<span class="comment">* creating .gitignore</span>
<span class="comment">* creating mix.exs</span>
<span class="comment">* creating config</span>
<span class="comment">* creating config/config.exs</span>
<span class="comment">* creating lib</span>
<span class="comment">* creating lib/douban_book_api_v2.ex</span>
<span class="comment">* creating test</span>
<span class="comment">* creating test/test_helper.exs</span>
<span class="comment">* creating test/douban_book_api_v2_test.exs</span>

Your mix project was created successfully.
You can <span class="keyword">use</span> mix to compile it, <span class="keyword">test</span> it, and <span class="keyword">more</span>:

    <span class="keyword">cd</span> douban_book_api_v2
    mix <span class="keyword">test</span>

<span class="keyword">Run</span> `mix <span class="keyword">help</span>` <span class="keyword">for</span> <span class="keyword">more</span> commands.
</code></pre><p>进入刚刚创建的目录<code>douban_book_api_v2</code>,编辑<code>mix.exs</code>,增加依赖模块:</p>
<p>修改函数<code>deps</code>为:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">defp deps <span class="keyword">do</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="symbol">:ibrowse</span>, <span class="symbol">github:</span> <span class="string">"cmullaparthi/ibrowse"</span>, <span class="symbol">tag:</span> <span class="string">"v4.1.0"</span>&#125;,</span><br><span class="line">        &#123;<span class="symbol">:jiffy</span>, <span class="symbol">github:</span> <span class="string">"davisp/jiffy"</span>&#125;,</span><br><span class="line">        &#123;<span class="symbol">:httpotion</span>, <span class="string">"~&gt; 0.2.0"</span>&#125;</span><br><span class="line">    ]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>然后执行如下命令,下载依赖模块:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd douban_book_api_v2</span></span><br><span class="line"><span class="preprocessor"># mix deps.get</span></span><br></pre></td></tr></table></figure>
<p>注意很多依赖模块托管在Amazon S3上,可能被墙, 可使用如下命令穿墙:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> HTTP_PROXY=http:<span class="comment">//192.168.8.188:8580</span></span><br><span class="line"><span class="keyword">export</span> HTTPS_PROXY=https:<span class="comment">//192.168.8.188:8580</span></span><br></pre></td></tr></table></figure>
<p>然后编译:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># mix compile</span></span><br></pre></td></tr></table></figure>
<p>接着进入<code>iex</code>(Elixir交互式SHELL):</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># iex -S mix</span></span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/F228B9AD-80CE-4875-AFCB-49BF5446A67D.png" alt="获取图书信息"></p>
<h2 id="示例代码">示例代码</h2><p><a href="https://github.com/developerworks/douban_book_api_v2" target="_blank" rel="external">https://github.com/developerworks/douban_book_api_v2</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://github.com/myfreeweb/httpotion" target="_blank" rel="external">https://github.com/myfreeweb/httpotion</a></li>
<li><a href="http://developers.douban.com/wiki/?title=book_v2#get_book" target="_blank" rel="external">http://developers.douban.com/wiki/?title=book_v2#get_book</a></li>
<li><a href="https://api.douban.com/v2/book/1041007" target="_blank" rel="external">https://api.douban.com/v2/book/1041007</a></li>
<li><a href="http://learnxinyminutes.com/docs/zh-cn/elixir-cn/" target="_blank" rel="external">http://learnxinyminutes.com/docs/zh-cn/elixir-cn/</a></li>
</ol>
<h2 id="修订记录">修订记录</h2><ul>
<li>2014-12-14 13:30<br>使用<a href="https://github.com/seth/ej" target="_blank" rel="external">ej</a>模块获取由<a href="https://github.com/davisp/jiffy" target="_blank" rel="external">jiffy</a>, <a href="https://github.com/mochi/mochiweb" target="_blank" rel="external">mochijson2</a>, 或 <a href="https://github.com/benoitc/ejson" target="_blank" rel="external">ejson</a> 返回的Erlang terms</li>
</ul>
<p><img src="/assets/images/C2B21544-3DDE-48FF-A83E-229C5463790A.png" alt="Javascript的访问方法和ej的访问方法对比"></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 把响应体解码为Erlang term</span></span><br><span class="line">json = :jiffy.decode response.body</span><br><span class="line"><span class="preprocessor"># 通过ej模块访问Erlang term</span></span><br><span class="line">:ej.<span class="keyword">get</span>(&#123;<span class="string">"author"</span>&#125;, josn)</span><br></pre></td></tr></table></figure>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">21</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"small"</span>&#125;, json</span><br><span class="line"><span class="string">"http://img3.douban.com/spic/s1990480.jpg"</span></span><br><span class="line">iex(<span class="number">22</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"large"</span>&#125;, json</span><br><span class="line"><span class="string">"http://img3.douban.com/lpic/s1990480.jpg"</span></span><br><span class="line">iex(<span class="number">23</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"medium"</span>&#125;, json</span><br><span class="line"><span class="string">"http://img3.douban.com/mpic/s1990480.jpg"</span></span><br><span class="line">iex(<span class="number">24</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"medium"</span>&#125;, json</span><br><span class="line"><span class="string">"http://img3.douban.com/mpic/s1990480.jpg"</span></span><br><span class="line">iex(<span class="number">25</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"tags"</span>, <span class="number">1</span>&#125;, json</span><br><span class="line">:undefined</span><br><span class="line">iex(<span class="number">26</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"images"</span>, <span class="string">"tags"</span>&#125;, json</span><br><span class="line">:undefined</span><br><span class="line">iex(<span class="number">27</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>&#125;, json</span><br><span class="line">[&#123;[&#123;<span class="string">"count"</span>, <span class="number">13368</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"哈利波特"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"哈利波特"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">10741</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"J.K.罗琳"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"J.K.罗琳"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">8892</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"魔幻"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"魔幻"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">7741</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"小说"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"小说"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">6536</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"英国"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"英国"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">4591</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"外国文学"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"外国文学"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">3871</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"哈利·波特"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"哈利·波特"</span>&#125;]&#125;,</span><br><span class="line"> &#123;[&#123;<span class="string">"count"</span>, <span class="number">3871</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"哈利・波特"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"哈利・波特"</span>&#125;]&#125;]</span><br><span class="line">iex(<span class="number">28</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">1</span>&#125;, json</span><br><span class="line">&#123;[&#123;<span class="string">"count"</span>, <span class="number">13368</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"哈利波特"</span>&#125;, &#123;<span class="string">"title"</span>, <span class="string">"哈利波特"</span>&#125;]&#125;</span><br><span class="line">iex(<span class="number">29</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">1</span>, <span class="string">"count"</span>&#125;, json</span><br><span class="line"><span class="number">13368</span></span><br><span class="line">iex(<span class="number">30</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">1</span>, <span class="string">"name"</span>&#125;, json</span><br><span class="line"><span class="string">"哈利波特"</span></span><br><span class="line">iex(<span class="number">31</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">1</span>, <span class="string">"title"</span>&#125;, json</span><br><span class="line"><span class="string">"哈利波特"</span></span><br><span class="line">iex(<span class="number">32</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">2</span>, <span class="string">"title"</span>&#125;, json</span><br><span class="line"><span class="string">"J.K.罗琳"</span></span><br><span class="line">iex(<span class="number">33</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">3</span>, <span class="string">"title"</span>&#125;, json</span><br><span class="line"><span class="string">"魔幻"</span></span><br><span class="line">iex(<span class="number">34</span>)&gt; :<span class="built_in">ej</span>.<span class="built_in">get</span> &#123;<span class="string">"tags"</span>, <span class="number">3</span>, <span class="string">"count"</span>&#125;, json</span><br><span class="line"><span class="number">8892</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-13T07:53:40.000Z"><a href="/2014/12/13/elixir-build-an-irc-logger/">2014-12-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/13/elixir-build-an-irc-logger/">构建一个IRC记录程序</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>IRC日志记录程序主要解决时区的问题, 如果你的IRC客户端不是一直连接到IRC服务器, 那么可能错过很多精彩的讨论. 即使你一直开着你的IRC客户端,也可能由于网络的不问题导致IRC客户端断开.下面用Elixir开发的一个IRC日志程序用于记录IRC服务器各个频道的聊天记录, 可以通过日期查看所有订阅频道的聊天信息.</p>
<h1 id="#">#</h1><p><img src="/assets/images/c429860617d7d0f4f5794903355570421decac1f_687474703a2f2f692e696d6775722e636f6d2f454471574562682e706e67.png" alt="IRC日志记录器用户界面"></p>
<h2 id="先决条件">先决条件</h2><ol>
<li>需要安装Erlang OTP/17</li>
<li>需要安装Elixir 1.0.1以上版本</li>
</ol>
<h2 id="创建项目">创建项目</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>mix new exile</span><br><span class="line">* creating <span class="constant">README.</span>md</span><br><span class="line">* creating .gitignore</span><br><span class="line">* creating mix.exs</span><br><span class="line">* creating config</span><br><span class="line">* creating config/config.exs</span><br><span class="line">* creating lib</span><br><span class="line">* creating lib/exile.ex</span><br><span class="line">* creating test</span><br><span class="line">* creating test/test_helper.exs</span><br><span class="line">* creating test/exile_test.exs</span><br></pre></td></tr></table></figure>
<p>编译, (直接执行<code>make test</code>可以自动编译并测试)</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cd exile</span><br><span class="line">mix test</span><br></pre></td></tr></table></figure>
<h2 id="添加第三方库">添加第三方库</h2><p>在<code>deps</code>函数添加第三方库<code>:socket</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Exile</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:exile</span>,</span><br><span class="line">     <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">     <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">applications:</span> [<span class="symbol">:logger</span>]]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    [</span><br><span class="line">      &#123;<span class="symbol">:socket</span>, <span class="string">"~&gt; 0.2.8"</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>下载第三方依赖库文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mix deps.get&#10;Running dependency resolution&#10;Unlocked:   timex, socket&#10;Dependency resolution completed successfully&#10;  socket: v0.2.8&#10;* Getting socket (Hex package)&#10;Checking package (https://s3.amazonaws.com/s3.hex.pm/tarballs/socket-0.2.8.tar)&#10;Using locally cached package&#10;Unpacked package tarball (/Users/benjamintan/.hex/packages/socket-0.2.8.tar)</span><br></pre></td></tr></table></figure>
<h2 id="构建机器人程序">构建机器人程序</h2><p>该机器人程序主要用于连接到IRC服务器,并箭筒IRC服务器的频道聊天信息, 并记录到数据库中.</p>
<h3 id="创建bot-ex">创建bot.ex</h3><p><code>Exile.Bot</code>模块使用了<code>GenServer</code>行为, 用于构建通用服务器程序, 使用GenServer的优点是, 它可以被添加到Supervisor进程树中,对其状态进行监控.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Exile</span>.<span class="constant">Bot </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">GenServer</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="实现需要的回调函数">实现需要的回调函数</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Exile</span>.<span class="constant">Bot </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">GenServer</span></span><br><span class="line">  <span class="variable">@doc</span> <span class="string">""</span><span class="string">"</span><br><span class="line">  调用start_link初始化,传递一个状态state, state是一个Map, 比如:</span><br><span class="line">  %&#123;</span><br><span class="line">    host: "</span>irc.freenode.net<span class="string">",</span><br><span class="line">    port: 6667,</span><br><span class="line">    chan: "</span><span class="comment">#elixir-lang",</span></span><br><span class="line">    <span class="symbol">nick:</span> <span class="string">"elixir-bot"</span>,</span><br><span class="line">    <span class="symbol">sock:</span> socket</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">""</span><span class="string">"</span><br><span class="line">  def start_link(state) do</span><br><span class="line">    GenServer.start_link(__MODULE__, state)</span><br><span class="line">  end</span><br><span class="line">  @doc "</span><span class="string">""</span></span><br><span class="line">  创建一个到<span class="constant">IRC服</span>务器的套接字连接</span><br><span class="line">  <span class="string">""</span><span class="string">"</span><br><span class="line">  def init(state) do</span><br><span class="line">    &#123;:ok, sock&#125; = Socket.TCP.connect(state.host, state.port, packet: :line)</span><br><span class="line">    # 第三个参数0标识超时, 0为立即超时,并发生一个:timeout消息</span><br><span class="line">    &#123;:ok, %&#123;state | sock: sock&#125;, 0&#125;</span><br><span class="line">  end</span><br><span class="line">  @doc "</span><span class="string">""</span></span><br><span class="line">  超时处理回调函数</span><br><span class="line">  <span class="string">""</span><span class="string">"</span><br><span class="line">  def handle_info(:timeout, state) do</span><br><span class="line">    IO.puts "</span><span class="constant">TIMEOUT HANDLED"</span></span><br><span class="line">    &#123; <span class="symbol">:noreply</span>, state &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="连接到IRC服务器">连接到IRC服务器</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_info</span>(<span class="symbol">:timeout</span>, state) </span><span class="keyword">do</span></span><br><span class="line">  state |&gt; do_join_channel |&gt; do_listen</span><br><span class="line">  &#123; <span class="symbol">:noreply</span>, state &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="进入一个频道">进入一个频道</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defp do_join_channel(%&#123;<span class="symbol">sock:</span> sock&#125; = state) <span class="keyword">do</span></span><br><span class="line">  sock |&gt; <span class="constant">Socket.Stream.</span>send!(<span class="string">"NICK <span class="subst">#&#123;state.nick&#125;</span>\r\n"</span>)</span><br><span class="line">  sock |&gt; <span class="constant">Socket.Stream.</span>send!(<span class="string">"USER <span class="subst">#&#123;state.nick&#125;</span> <span class="subst">#&#123;state.host&#125;</span> <span class="subst">#&#123;state.nick&#125;</span> <span class="subst">#&#123;state.nick&#125;</span>\r\n"</span>)</span><br><span class="line">  sock |&gt; <span class="constant">Socket.Stream.</span>send!(<span class="string">"JOIN <span class="subst">#&#123;state.chan&#125;</span>\r\n"</span>)</span><br><span class="line">  state</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="监听回复信息">监听回复信息</h2><p>进入频道后就可以通过下面的回调获取聊天信息</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">defp do_listen(%&#123;<span class="symbol">sock:</span> sock&#125; = state) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> state.sock |&gt; <span class="constant">Socket.Stream.</span>recv! <span class="keyword">do</span></span><br><span class="line">    data <span class="keyword">when</span> is_binary(data)-&gt;</span><br><span class="line">      <span class="keyword">case</span> parse_message(data, sock) <span class="keyword">do</span></span><br><span class="line">        message -&gt;</span><br><span class="line">          message</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      do_listen(state)</span><br><span class="line">    <span class="keyword">nil</span> -&gt;</span><br><span class="line">      <span class="symbol">:ok</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="保持连接">保持连接</h2><h2 id="处理其他消息">处理其他消息</h2><h2 id="参考资料">参考资料</h2><ol>
<li>Building an IRC Logger in Elixir<br><a href="http://www.neo.com/2014/12/01/building-an-irc-logger-in-elixir" target="_blank" rel="external">http://www.neo.com/2014/12/01/building-an-irc-logger-in-elixir</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-13T06:11:19.000Z"><a href="/2014/12/13/erlang-100-questions/">2014-12-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/13/erlang-100-questions/">Erlang 100问</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="Supervisor_的_simple_one_for_one_有什么关键性特点?">Supervisor 的 simple_one_for_one 有什么关键性特点?</h2><ol>
<li>Supervisor本身启动时不会启动子进程, 子进程的启动必须调用<code>supervisor:start_child(Sup, Args)</code>来启动.</li>
<li>只能有一种子进程定义(规范)</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/3/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/03/18/angular-if-else-statement-in-template/">AngularJS中的If..Else语句</a>
      </li>
    
      <li>
        <a href="/2015/03/18/continuous-deployment-of-node-js-applications/">Nodejs应用程序持续部署</a>
      </li>
    
      <li>
        <a href="/2015/03/17/erlang-pooler/">Erlang Pooler</a>
      </li>
    
      <li>
        <a href="/2015/03/17/ejabberd-easy-installer-and-structure-for-ejabberd-contributed-modules/">Ejabberd模块安装工具</a>
      </li>
    
      <li>
        <a href="/2015/03/13/ejabberd-howto-20150312/">Ejabberd Howto 20150312 &lt;TODO LIST&gt;</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-performance-turning/">Ejabberd 性能调优(草稿)</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-benchmark-with-tsung/">使用Tsung对Ejabberd进行性能测试</a>
      </li>
    
      <li>
        <a href="/2015/03/11/thrift-ex/">thrift_ex</a>
      </li>
    
      <li>
        <a href="/2015/02/26/ejabberd-joins-the-elixir-revolution/">(译) Ejabberd加入了Elixir的变革</a>
      </li>
    
      <li>
        <a href="/2015/02/25/http2-h2o-get-started/">HTTP/2 尝鲜</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>32</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>6</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a><a href="/tags/API/" style="font-size: 11px;">API</a><a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a><a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a><a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a><a href="/tags/CURL/" style="font-size: 10px;">CURL</a><a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a><a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a><a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a><a href="/tags/ETS/" style="font-size: 10px;">ETS</a><a href="/tags/Ecto/" style="font-size: 11px;">Ecto</a><a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a><a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a><a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a><a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a><a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a><a href="/tags/H2O/" style="font-size: 10px;">H2O</a><a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a><a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a><a href="/tags/Howto/" style="font-size: 10px;">Howto</a><a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a><a href="/tags/I18n/" style="font-size: 10px;">I18n</a><a href="/tags/IAB/" style="font-size: 10px;">IAB</a><a href="/tags/ID3/" style="font-size: 10px;">ID3</a><a href="/tags/IO/" style="font-size: 10px;">IO</a><a href="/tags/IOT/" style="font-size: 10px;">IOT</a><a href="/tags/IoT/" style="font-size: 10px;">IoT</a><a href="/tags/Loopback/" style="font-size: 12px;">Loopback</a><a href="/tags/MUC/" style="font-size: 10px;">MUC</a><a href="/tags/Macro/" style="font-size: 12px;">Macro</a><a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a><a href="/tags/Mix/" style="font-size: 14px;">Mix</a><a href="/tags/Modules/" style="font-size: 10px;">Modules</a><a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a><a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a><a href="/tags/OTP/" style="font-size: 12px;">OTP</a><a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a><a href="/tags/PM2/" style="font-size: 10px;">PM2</a><a href="/tags/Performance/" style="font-size: 10px;">Performance</a><a href="/tags/Phoenix/" style="font-size: 12px;">Phoenix</a><a href="/tags/Pool/" style="font-size: 10px;">Pool</a><a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a><a href="/tags/RESTFUL/" style="font-size: 11px;">RESTFUL</a><a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a><a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a><a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a><a href="/tags/Regex/" style="font-size: 10px;">Regex</a><a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a><a href="/tags/SSH/" style="font-size: 10px;">SSH</a><a href="/tags/SSL/" style="font-size: 10px;">SSL</a><a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a><a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a><a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a><a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a><a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a><a href="/tags/Task/" style="font-size: 10px;">Task</a><a href="/tags/Thrift/" style="font-size: 10px;">Thrift</a><a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a><a href="/tags/UBF/" style="font-size: 10px;">UBF</a><a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a><a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a><a href="/tags/VAST/" style="font-size: 10px;">VAST</a><a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a><a href="/tags/XEP/" style="font-size: 15px;">XEP</a><a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a><a href="/tags/XML/" style="font-size: 10px;">XML</a><a href="/tags/XMPP/" style="font-size: 18px;">XMPP</a><a href="/tags/android/" style="font-size: 10px;">android</a><a href="/tags/angular/" style="font-size: 17px;">angular</a><a href="/tags/application/" style="font-size: 10px;">application</a><a href="/tags/blockies/" style="font-size: 10px;">blockies</a><a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a><a href="/tags/bosh/" style="font-size: 12px;">bosh</a><a href="/tags/ci/" style="font-size: 10px;">ci</a><a href="/tags/container/" style="font-size: 11px;">container</a><a href="/tags/data-management/" style="font-size: 10px;">data management</a><a href="/tags/data-volume/" style="font-size: 10px;">data volume</a><a href="/tags/debugging/" style="font-size: 10px;">debugging</a><a href="/tags/devtools/" style="font-size: 10px;">devtools</a><a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a><a href="/tags/doc/" style="font-size: 10px;">doc</a><a href="/tags/docker/" style="font-size: 16px;">docker</a><a href="/tags/ejabberd/" style="font-size: 19px;">ejabberd</a><a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a><a href="/tags/emysql/" style="font-size: 11px;">emysql</a><a href="/tags/encoding/" style="font-size: 10px;">encoding</a><a href="/tags/erlang/" style="font-size: 12px;">erlang</a><a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a><a href="/tags/faq/" style="font-size: 10px;">faq</a><a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a><a href="/tags/gerrit/" style="font-size: 11px;">gerrit</a><a href="/tags/gettext/" style="font-size: 10px;">gettext</a><a href="/tags/git/" style="font-size: 12px;">git</a><a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a><a href="/tags/grunt/" style="font-size: 10px;">grunt</a><a href="/tags/hero/" style="font-size: 10px;">hero</a><a href="/tags/html/" style="font-size: 10px;">html</a><a href="/tags/html5/" style="font-size: 10px;">html5</a><a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a><a href="/tags/iq/" style="font-size: 10px;">iq</a><a href="/tags/jabber/" style="font-size: 10px;">jabber</a><a href="/tags/javascript/" style="font-size: 11px;">javascript</a><a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a><a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a><a href="/tags/library/" style="font-size: 10px;">library</a><a href="/tags/linking/" style="font-size: 10px;">linking</a><a href="/tags/lists/" style="font-size: 10px;">lists</a><a href="/tags/load-balance/" style="font-size: 10px;">load balance</a><a href="/tags/log4er/" style="font-size: 10px;">log4er</a><a href="/tags/manage-images/" style="font-size: 10px;">manage images</a><a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a><a href="/tags/muc/" style="font-size: 10px;">muc</a><a href="/tags/mysql/" style="font-size: 10px;">mysql</a><a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a><a href="/tags/node-webkit/" style="font-size: 13px;">node-webkit</a><a href="/tags/node-js/" style="font-size: 12px;">node.js</a><a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a><a href="/tags/notification/" style="font-size: 10px;">notification</a><a href="/tags/npm/" style="font-size: 11px;">npm</a><a href="/tags/performance/" style="font-size: 10px;">performance</a><a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a><a href="/tags/polymer/" style="font-size: 10px;">polymer</a><a href="/tags/port/" style="font-size: 10px;">port</a><a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a><a href="/tags/rebar/" style="font-size: 10px;">rebar</a><a href="/tags/record/" style="font-size: 10px;">record</a><a href="/tags/recursion/" style="font-size: 10px;">recursion</a><a href="/tags/regexp/" style="font-size: 10px;">regexp</a><a href="/tags/relx/" style="font-size: 10px;">relx</a><a href="/tags/screen/" style="font-size: 10px;">screen</a><a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a><a href="/tags/shell/" style="font-size: 10px;">shell</a><a href="/tags/socket/" style="font-size: 10px;">socket</a><a href="/tags/ssh/" style="font-size: 10px;">ssh</a><a href="/tags/stanza/" style="font-size: 10px;">stanza</a><a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a><a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a><a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a><a href="/tags/swagger/" style="font-size: 12px;">swagger</a><a href="/tags/testing/" style="font-size: 10px;">testing</a><a href="/tags/tls/" style="font-size: 10px;">tls</a><a href="/tags/tools/" style="font-size: 10px;">tools</a><a href="/tags/tsung/" style="font-size: 10px;">tsung</a><a href="/tags/upstart/" style="font-size: 10px;">upstart</a><a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a><a href="/tags/varnish/" style="font-size: 10px;">varnish</a><a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a><a href="/tags/vt/" style="font-size: 10px;">vt</a><a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a><a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a><a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a><a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




