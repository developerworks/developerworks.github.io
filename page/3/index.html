
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 3 页 | 元气糯米团子的Coding Blog</title>
  <meta name="author" content="zhiqiang he">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="元气糯米团子的Coding Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="元气糯米团子的Coding Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/assets/css/toc.css"/>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>-->
  <script type="text/javascript" src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.8.3.min.js"></script>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-touch-icon-76x76.png" />
  <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <!--
  <SCRIPT type=text/javascript src="/js/scrolltop.js"></SCRIPT>
   -->
  <!--howiefh calendar begin-->
  <SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>
  <!--howiefh calendar end-->
  
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</head>


<body>
<header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">元气糯米团子的Coding Blog</a></h1>
  <h2><a href="/">Tansform information as knowledges, extract and purify as thoughts</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">树根</a></li>
    
      <li><a href="/archives">泡菜坛子</a></li>
    
      <li><a href="/links">连接</a></li>
    
      <li><a href="/atom.xml">粽子</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>

<div id="content" class="inner">
    <div id="main-col" class="alignleft">
        <div id="wrapper">
  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-08T02:20:31.000Z"><a href="/2014/12/08/nodejs-loopback-model-relations/">2014-12-08</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/08/nodejs-loopback-model-relations/">Loopback 模型关系</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>TODO::</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-12-07T16:26:35.000Z"><a href="/2014/12/08/nodejs-loopback-database-connector-example/">2014-12-08</a></time>
      
      
  
    <h1 class="title"><a href="/2014/12/08/nodejs-loopback-database-connector-example/">Loopback 数据库连接器示例</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>创建一个Loopback 应用程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slc loopback <span class="comment"># 创建项目longfor</span></span><br><span class="line"><span class="built_in">cd</span> longfor</span><br></pre></td></tr></table></figure>
<p>项目创建好了之后, 在项目目录longfor下执行 <code>npm install --save loopback-connector-mysql</code> 安装MySQL数据库连接器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> $ npm install --save loopback-connector-mysql&#10;npm http GET https://registry.npmjs.org/loopback-connector-mysql&#10;...&#10;...&#10;...&#10;loopback-connector-mysql@1.4.9 node_modules/loopback-connector-mysql&#10;&#9500;&#9472;&#9472; sl-blip@1.0.0&#10;&#9500;&#9472;&#9472; loopback-connector@1.2.0&#10;&#9500;&#9472;&#9472; async@0.9.0&#10;&#9500;&#9472;&#9472; debug@2.0.0 (ms@0.6.2)&#10;&#9492;&#9472;&#9472; mysql@2.5.3 (require-all@0.0.8, bignumber.js@1.4.1, readable-stream@1.1.13)</span><br></pre></td></tr></table></figure>
<p>添加数据源</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">slc</span> <span class="tag">loopback</span><span class="pseudo">:datasource</span> <span class="tag">longfordb</span></span><br></pre></td></tr></table></figure>
<p>编辑数据源配置文件,添加数据库连接信息</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "db": &#123;</span><br><span class="line">    "name": "db",</span><br><span class="line">    "connector": "memory"</span><br><span class="line">  &#125;,</span><br><span class="line">  "longfordb": &#123;</span><br><span class="line">    "name": "longfordb",</span><br><span class="line">    "connector": "mysql",</span><br><span class="line">    "host": "localhost",        # Added</span><br><span class="line">    "port": 3306,               # Added</span><br><span class="line">    "database": "longfor",      # Added</span><br><span class="line">    "username": "root",         # Added</span><br><span class="line">    "password": "root"          # Added</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加模型<code>account</code>,并创建模型<code>account</code>的三个属性: email, created, modified</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">slc loopback:model account</span><br><span class="line">Enter an empty property name when done.</span><br><span class="line">? Property name: email</span><br><span class="line">  <span class="instruction"> invoke </span>  loopback:property</span><br><span class="line">? Property type: string</span><br><span class="line">? Required? Yes</span><br><span class="line"></span><br><span class="line">Let's<span class="instruction"> add </span>another account property.</span><br><span class="line">Enter an empty property name when done.</span><br><span class="line">? Property name: created</span><br><span class="line">  <span class="instruction"> invoke </span>  loopback:property</span><br><span class="line">? Property type: date</span><br><span class="line">? Required? Yes</span><br><span class="line"></span><br><span class="line">Let's<span class="instruction"> add </span>another account property.</span><br><span class="line">Enter an empty property name when done.</span><br><span class="line">? Property name: modified</span><br><span class="line">  <span class="instruction"> invoke </span>  loopback:property</span><br><span class="line">? Property type: date</span><br><span class="line">? Required? Yes</span><br></pre></td></tr></table></figure>
<p>创建表并添加测试数据, 下载<a href="https://raw.githubusercontent.com/strongloop/loopback-example-database/master/server/create-test-data.js" target="_blank" rel="external">create-test-data.js</a>脚本, 修改数据源名称为longfordb:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 修改</span></span><br><span class="line"><span class="keyword">var</span> dataSource = server.dataSources.accountDB;</span><br><span class="line"><span class="preprocessor"># 为</span></span><br><span class="line"><span class="keyword">var</span> dataSource = server.dataSources.longfordb;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="tag">cd</span> <span class="tag">server</span></span><br><span class="line">$ <span class="tag">node</span> <span class="tag">create-test-data</span><span class="class">.js</span></span><br><span class="line"><span class="tag">Record</span> <span class="tag">created</span>: <span class="rules">&#123; <span class="rule"><span class="attribute">email</span>:<span class="value"> <span class="string">'foo@bar.com'</span>,</span><br><span class="line">  created: Mon Dec <span class="number">08</span> <span class="number">2014</span> <span class="number">00</span>:<span class="number">43</span>:<span class="number">16</span> GMT+<span class="number">0800</span> (CST),</span><br><span class="line">  modified: Mon Dec <span class="number">08</span> <span class="number">2014</span> <span class="number">00</span>:<span class="number">43</span>:<span class="number">16</span> GMT+<span class="number">0800</span> (CST),</span><br><span class="line">  id: <span class="number">1</span> </span></span></span>&#125;</span><br><span class="line"><span class="tag">Record</span> <span class="tag">created</span>: <span class="rules">&#123; <span class="rule"><span class="attribute">email</span>:<span class="value"> <span class="string">'bar@bar.com'</span>,</span><br><span class="line">  created: Mon Dec <span class="number">08</span> <span class="number">2014</span> <span class="number">00</span>:<span class="number">43</span>:<span class="number">16</span> GMT+<span class="number">0800</span> (CST),</span><br><span class="line">  modified: Mon Dec <span class="number">08</span> <span class="number">2014</span> <span class="number">00</span>:<span class="number">43</span>:<span class="number">16</span> GMT+<span class="number">0800</span> (CST),</span><br><span class="line">  id: <span class="number">2</span> </span></span></span>&#125;</span><br><span class="line"><span class="tag">done</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>loopback-example-database<br><a href="https://github.com/strongloop/loopback-example-database/blob/master/README.md" target="_blank" rel="external">https://github.com/strongloop/loopback-example-database/blob/master/README.md</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-29T18:30:13.000Z"><a href="/2014/11/30/opencart-memcache-vqmod/">2014-11-30</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/30/opencart-memcache-vqmod/">Opencart 通过vQmod方式用Memcache替换默认的Cache</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="前提条件">前提条件</h2><p>用Memcache替换默认的Cache之前,需要满足如下前提条件:</p>
<ul>
<li>PHP需要Memcache扩展, 可以通过如下方式安装, 并在<code>php.ini</code>配置文件中添加<code>extension=memcache.so</code></li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pecl <span class="keyword">install</span> memcache</span><br></pre></td></tr></table></figure>
<ul>
<li>需要安装配置好Opencart</li>
<li>需要安装vQmod</li>
</ul>
<h2 id="vQmod模块代码">vQmod模块代码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">modification</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">id</span>&gt;</span>Replace opencart default cache with Memcache<span class="tag">&lt;/<span class="title">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">vqmver</span>&gt;</span>2.5.1<span class="tag">&lt;/<span class="title">vqmver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">author</span>&gt;</span>hezhiqiang<span class="tag">&lt;/<span class="title">author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">file</span> <span class="attribute">name</span>=<span class="value">"system/library/cache.php"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">operation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">search</span> <span class="attribute">position</span>=<span class="value">"replace"</span> <span class="attribute">offset</span>=<span class="value">"50"</span>&gt;</span><span class="cdata">&lt;![CDATA[</span><br><span class="line">			&lt;?php</span><br><span class="line">			]]&gt;</span><span class="tag">&lt;/<span class="title">search</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">add</span>&gt;</span><span class="cdata">&lt;![CDATA[&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * OpenCart Ukrainian Community</span><br><span class="line"> *</span><br><span class="line"> * LICENSE</span><br><span class="line"> *</span><br><span class="line"> * This source file is subject to the GNU General Public License, Version 3</span><br><span class="line"> * It is also available through the world-wide-web at this URL:</span><br><span class="line"> * http://www.gnu.org/copyleft/gpl.html</span><br><span class="line"> * If you did not receive a copy of the license and are unable to</span><br><span class="line"> * obtain it through the world-wide-web, please send an email</span><br><span class="line"> *</span><br><span class="line"> * @category   OpenCart</span><br><span class="line"> * @package    OCU Memcached</span><br><span class="line"> * @copyright  Copyright (c) 2011 created by UncleAndy, maintained by Eugene Lifescale for</span><br><span class="line">               OpenCart Ukrainian Community (http://opencart-ukraine.tumblr.com)</span><br><span class="line"> * @license    http://www.gnu.org/copyleft/gpl.html</span><br><span class="line">               GNU General Public License, Version 3</span><br><span class="line"> */</span><br><span class="line">final class Cache</span><br><span class="line">&#123;</span><br><span class="line">    private $expire;</span><br><span class="line">    private $memcache;</span><br><span class="line">    private $ismemcache = false;</span><br><span class="line">    public function __construct($exp = 3600)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;expire = $exp;</span><br><span class="line">        if (CACHE_DRIVER == 'memcached') &#123;</span><br><span class="line">            $mc = new Memcache;</span><br><span class="line">            if ($mc-&gt;pconnect(MEMCACHE_HOSTNAME, MEMCACHE_PORT)) &#123;</span><br><span class="line">                $this-&gt;memcache = $mc;</span><br><span class="line">                $this-&gt;ismemcache = true;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        $files = glob(DIR_CACHE . 'cache.*');</span><br><span class="line">        if ($files) &#123;</span><br><span class="line">            foreach ($files as $file) &#123;</span><br><span class="line">                $time = substr(strrchr($file, '.'), 1);</span><br><span class="line">                if ($time &lt; time()) &#123;</span><br><span class="line">                    if (file_exists($file)) &#123;</span><br><span class="line">                        @unlink($file);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function get($key)</span><br><span class="line">    &#123;</span><br><span class="line">        if ((CACHE_DRIVER == 'memcached') &amp;&amp; $this-&gt;ismemcache) &#123;</span><br><span class="line">            return ($this-&gt;memcache-&gt;get(MEMCACHE_NAMESPACE . $key, 0));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $files = glob(DIR_CACHE . 'cache.' . $key . '.*');</span><br><span class="line">            if ($files) &#123;</span><br><span class="line">                foreach ($files as $file) &#123;</span><br><span class="line">                    $cache = '';</span><br><span class="line">                    $handle = fopen($file, 'r');</span><br><span class="line">                    if ($handle) &#123;</span><br><span class="line">                        $cache = fread($handle, filesize($file));</span><br><span class="line">                        fclose($handle);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return unserialize($cache);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function set($key, $value)</span><br><span class="line">    &#123;</span><br><span class="line">        if ((CACHE_DRIVER == 'memcached') &amp;&amp; $this-&gt;ismemcache) &#123;</span><br><span class="line">            $this-&gt;memcache-&gt;set(MEMCACHE_NAMESPACE . $key, $value, MEMCACHE_COMPRESSED, $this-&gt;expire);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;delete($key);</span><br><span class="line">            $file = DIR_CACHE . 'cache.' . $key . '.' . (time() + $this-&gt;expire);</span><br><span class="line">            $handle = fopen($file, 'w');</span><br><span class="line">            fwrite($handle, serialize($value));</span><br><span class="line">            fclose($handle);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function delete($key)</span><br><span class="line">    &#123;</span><br><span class="line">        if ((CACHE_DRIVER == 'memcached') &amp;&amp; $this-&gt;ismemcache) &#123;</span><br><span class="line">            $this-&gt;memcache-&gt;delete(MEMCACHE_NAMESPACE . $key, 0);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $files = glob(DIR_CACHE . 'cache.' . $key . '.*');</span><br><span class="line">            if ($files) &#123;</span><br><span class="line">                foreach ($files as $file) &#123;</span><br><span class="line">                    if (file_exists($file)) &#123;</span><br><span class="line">                        @unlink($file);</span><br><span class="line">                        clearstatcache();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">			]]&gt;</span><span class="tag">&lt;/<span class="title">add</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">operation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">modification</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-26T09:23:04.000Z"><a href="/2014/11/26/opencart-vqmod/">2014-11-26</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/26/opencart-vqmod/">Opencart vqmod 虚拟文件修改系统</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="简介">简介</h2><p>vQmod™ - Virtual File Modification System<br><a href="http://vqmod.com" target="_blank" rel="external">http://vqmod.com</a></p>
<p>假设Opencart的安装目录为<code>$OPENCART</code></p>
<p><img src="/assets/opencart/66988307-85C2-4148-AC43-9C0857325704.png" alt="vQmod安装前后$OPENCART/index.php的差异"></p>
<h2 id="分类导入导出工具">分类导入导出工具</h2>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-22T13:44:48.000Z"><a href="/2014/11/22/nodejs-loopback-getstarted/">2014-11-22</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/22/nodejs-loopback-getstarted/">Loopback框架入门</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="安装strongloop框架">安装strongloop框架</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g strongloop</span><br></pre></td></tr></table></figure>
<h2 id="创建项目">创建项目</h2><p>运行 <code>slc loopback</code>, 提示输入项目信息, 包括项目名称, 目录名称等.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ slc loopback&#10;[?] Enter a directory name where to create the project: longfor&#10;[?] What&#39;s the name of your application? longfor</span><br></pre></td></tr></table></figure>
<p>上述过程创建了一个名为longfor的项目, 目录名称也为longfor.</p>
<h2 id="创建模型">创建模型</h2><p>进入 longfor 目录执行 <code>slc loopback:model</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cd longfor&#10;$ slc loopback:model&#10;[?] Enter the model name: user&#10;[?] Select the data-source to attach person to: db (memory)&#10;[?] Expose person via the REST API? Yes&#10;[?] Custom plural form (used to build REST URL): people&#10;Let&#39;s add some person properties now.</span><br></pre></td></tr></table></figure>
<h2 id="安装数据库连接器">安装数据库连接器</h2><p>这里的例子, 我们以MySQL作为例子:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save loopback-connector-mysql</span><br></pre></td></tr></table></figure>
<h2 id="添加数据源">添加数据源</h2><p>数据库连接器安装好了之后, 我们需要为我们的应用添加数据源, 通过下面的命令给应用程序longfor添加数据源, 数据源的名称为longfordb, MySQL作为连接器:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ slc loopback:datasource longfordb&#10;? Enter the data-source name: longfordb&#10;? Select the connector for longfordb: (Use arrow keys)&#10;&#10095; In-memory db (supported by StrongLoop)&#10;  Email (supported by StrongLoop)&#10;  MySQL (supported by StrongLoop)&#10;  PostgreSQL (supported by StrongLoop)&#10;  Oracle (supported by StrongLoop)&#10;  Microsoft SQL (supported by StrongLoop)&#10;  MongoDB (supported by StrongLoop)</span><br></pre></td></tr></table></figure>
<p>数据源创建好了, 接下来就是配置数据源, 让代码可以通过我们刚才创建的这个数据源名称去和后端数据库建立连接:</p>
<h2 id="配置数据源">配置数据源</h2><p>数据源的配置文件在目录<code>$PROJECT/server/datasources.json</code>, 修改内容为:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#10;  ...&#10;  &#34;longfordb&#34;: &#123;&#10;    &#34;name&#34;: &#34;longfordb&#34;,&#10;    &#34;connector&#34;: &#34;mysql&#34;,&#10;    &#34;host&#34;: &#34;localhost&#34;,&#10;    &#34;port&#34;: 3306,&#10;    &#34;database&#34;: &#34;longfordb&#34;,&#10;    &#34;username&#34;: &#34;root&#34;,&#10;    &#34;password&#34;: &#34;root&#34;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于模型">关于模型</h2><p>关于模型Loopback有几个内置的模型类</p>
<ul>
<li><code>PersistedModel</code><br>该模型类继承自<code>Model</code>类,额外支持基本查询功能和CRUD操作.</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-21T09:34:44.000Z"><a href="/2014/11/21/semver-libraries/">2014-11-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/21/semver-libraries/">Node.js语义版本解析库</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>安装语义版本解析库</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> -g semver</span><br></pre></td></tr></table></figure>
<p>Node Shell示例</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="reserved">var</span> semver = <span class="built_in">require</span>(<span class="string">'semver'</span>);</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line">&gt; <span class="reserved">var</span> version_info = semver.parse(<span class="string">'1.2.3'</span>);</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line">&gt; version_info.major</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; version_info.minor</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt; version_info.patch</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>验证一个版本号是否是语义化版本, 如果是一个语义化版本返回<code>true</code>, 否则返回<code>false</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semver.<span class="function"><span class="title">valid</span><span class="params">(<span class="string">'1.2.3'</span>)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="其他语言版本">其他语言版本</h2><ul>
<li><code>Erlang</code><br><a href="https://github.com/nebularis/semver" target="_blank" rel="external">https://github.com/nebularis/semver</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-21T03:41:09.000Z"><a href="/2014/11/21/elixir-tasks/">2014-11-21</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/21/elixir-tasks/">任务</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="什么是任务?">什么是任务?</h2><p>任务是进程, 是用于执行特定动作的进程, 通常较少或不与其他进程通信. 任务最常用的情况是异步地计算一个值.</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">task = <span class="type">Task</span>.async(<span class="keyword">fn</span> -&gt; do_some_work<span class="literal">()</span> <span class="keyword">end</span>)</span><br><span class="line">res  = do_some_other_work<span class="literal">()</span></span><br><span class="line">res + <span class="type">Task</span>.await(task)</span><br></pre></td></tr></table></figure>
<p>任务通常不返回值, 但是有时候我们需要让任务计算一个值,随后读取其计算结果.</p>
<p><code>async/await</code> 提供了一个非常简单的机制并发地计算.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)2&gt;</span> task = Task.<span class="function">async</span>(fn -&gt; :math.<span class="function">pow</span>(<span class="number">7</span>,<span class="number">2</span>) + :math.<span class="function">pow</span>(<span class="number">8</span>,<span class="number">2</span>) end)</span><br><span class="line">%Task</span>&#123;<span class="tag">pid</span>: <span class="id">#PID</span>&lt;0<span class="class">.97</span><span class="class">.0</span>&gt;, <span class="tag">ref</span>: <span class="id">#Reference</span>&lt;0<span class="class">.0</span><span class="class">.0</span><span class="class">.238</span>&gt;&#125;</span><br><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)3&gt;</span> Task.<span class="function">await</span>(task)</span><br><span class="line"><span class="number">113.0</span></span></span><br></pre></td></tr></table></figure>
<p>首先来说明异步, <code>Task.async/1</code>创建一个任务,并执行传递给它的函数, 如上述代码第2行所示, <code>Task.async/1</code>调用返回一个对任务的引用.</p>
<p>这行输出很好地阐述了文章开头这么一句话<code>任务是进程</code>.该输出实际上是一个<code>%Task</code> Map, 包含两个元素 进程的Pid, 以及一个引用对象.</p>
<p>随后可以通过调用<code>Task.await/1</code>获取其计算结果. 调用<code>Task.async/1</code>会创建一个新的进程,该进程连接到调用者进程. 任务结果以消息的形式返回给调用者进程.<br><code>Task.await/2</code>用于读取由任务发送的消息.</p>
<p>创建任务<code>task1</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)4&gt;</span> task1 = Task.<span class="function">async</span>(fn -&gt; :math.<span class="function">pow</span>(<span class="number">7</span>,<span class="number">2</span>) + :math.<span class="function">pow</span>(<span class="number">8</span>,<span class="number">2</span>) end)</span><br><span class="line">%Task</span>&#123;<span class="tag">pid</span>: <span class="id">#PID</span>&lt;0<span class="class">.100</span><span class="class">.0</span>&gt;, <span class="tag">ref</span>: <span class="id">#Reference</span>&lt;0<span class="class">.0</span><span class="class">.0</span><span class="class">.245</span>&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>创建任务<code>task2</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)6&gt;</span> task2 = Task.<span class="function">async</span>(fn -&gt; <span class="number">2</span>+<span class="number">2</span> end)</span><br><span class="line">%Task</span>&#123;<span class="tag">pid</span>: <span class="id">#PID</span>&lt;0<span class="class">.103</span><span class="class">.0</span>&gt;, <span class="tag">ref</span>: <span class="id">#Reference</span>&lt;0<span class="class">.0</span><span class="class">.0</span><span class="class">.252</span>&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>分别获取两个任务的计算结果 <code>v1</code>, <code>v2</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v1 = Task.<span class="function"><span class="title">await</span><span class="params">(task1)</span></span></span><br><span class="line">v2 = Task.<span class="function"><span class="title">await</span><span class="params">(task2)</span></span></span><br></pre></td></tr></table></figure>
<p>再通过第三个任务<code>task3</code>合并计算两个任务的结果</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)15&gt;</span> task3 = Task.<span class="function">async</span>(fn -&gt; v1 + v2 end)</span><br><span class="line">%Task</span>&#123;<span class="tag">pid</span>: <span class="id">#PID</span>&lt;0<span class="class">.117</span><span class="class">.0</span>&gt;, <span class="tag">ref</span>: <span class="id">#Reference</span>&lt;0<span class="class">.0</span><span class="class">.0</span><span class="class">.288</span>&gt;&#125;</span><br><span class="line"><span class="tag">iex</span>(<span class="tag">foo</span><span class="at_rule">@<span class="keyword">44adb2a6d305)16&gt;</span> Task.<span class="function">await</span>(task3)</span><br><span class="line"><span class="number">117.0</span></span></span><br></pre></td></tr></table></figure>
<p>还可以通过<code>start_link/1</code>和<code>start_link/3</code>创建任务并挂在到Supervition树中.</p>
<p>和<code>Task.async/1</code>不同,<code>Task.start_link/1</code>返回的是一个<code>{:ok,pid}</code>而不是一个任务引用,因此我无法通过<code>Task.await/2</code>获取其计算结果.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(foo<span class="variable">@44adb2a6d305</span>)<span class="number">21</span>&gt; <span class="constant">Task.</span>start_link(<span class="keyword">fn</span> -&gt; <span class="number">1</span> + <span class="number">1</span> <span class="keyword">end</span>)</span><br><span class="line">&#123;<span class="symbol">:ok</span>, <span class="comment">#PID&lt;0.128.0&gt;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样的任务可以挂在到supervision树, 下面的代码片段显示了如何挂载一个任务到一个supervision树中:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import Supervisor<span class="class">.Spec</span></span><br><span class="line">children = [</span><br><span class="line">    <span class="function"><span class="title">worker</span><span class="params">(Task, [fn -&gt; IO.puts <span class="string">"ok"</span> end])</span></span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过上述几个步骤,我们实现了并发处理. 下面阐述如何把任务分布到集群中的多个节点从而实现分布式.</p>
</blockquote>
<h2 id="Supervision_树">Supervision 树</h2><p><code>Task.Supervisor</code>模块允许开发者创建可动态第添加任务的监控进程(Supervisors):</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">&#123;</span><span class="keyword">:</span>ok, pid<span class="keyword">&#125;</span> <span class="keyword">=</span> <span class="keyword">Task</span><span class="typename">.Supervisor</span><span class="typename">.start_link</span>()</span><br><span class="line"><span class="keyword">Task</span><span class="typename">.Supervisor</span><span class="typename">.async</span>(pid, <span class="keyword">Module</span>, <span class="keyword">:</span><span class="keyword">function</span>, [arg1, arg2, arg3])</span><br></pre></td></tr></table></figure>
<p><code>Task.Supervisor</code>还可以在远程节点上创建任务, 只要该监控进程在本地或全局注册过:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在远程节点</span></span><br><span class="line"><span class="constant">Task.Supervisor.</span>start_link(<span class="symbol">name:</span> <span class="symbol">:tasks_sup</span>)</span><br><span class="line"><span class="comment"># 在客户端</span></span><br><span class="line"><span class="constant">Task.Supervisor.</span>async(&#123;<span class="symbol">:tasks_sup</span>, <span class="symbol">:<span class="string">'bar@192.168.8.8'</span></span>&#125;, <span class="constant">Module,</span> <span class="symbol">:function</span>, [arg1, arg2, arg3])</span><br></pre></td></tr></table></figure>
<p><code>Task.Supervisor</code>通常在监控树中以下列方式启动</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import Supervisor<span class="class">.Spec</span></span><br><span class="line">children = [</span><br><span class="line">    supervisor(Task<span class="class">.Supervisor</span>, [[name: :tasks_sup]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>需要注意的是, 当处理分布式任务时, 应该使用<code>async/3</code>, 分别传递模块,函数,参数列表, 而不是以一个匿名函数作为参数的<code>async/1</code>.</p>
<h2 id="分布_(Distrbuted)">分布 (Distrbuted)</h2><p>TODO::</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-20T09:46:57.000Z"><a href="/2014/11/20/elixir-distributed-tasks-and-configuration/">2014-11-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/20/elixir-distributed-tasks-and-configuration/">分布式任务和配置</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>启动节点A, 并定义一个模块</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@c87c9967219c:~<span class="comment"># iex --sname A</span></span><br><span class="line">iex(foo@c87c9967219c)<span class="number">1</span>&gt; defmodule Hell do</span><br><span class="line"><span class="keyword">...</span>(foo@c87c9967219c)<span class="number">1</span>&gt;   def world, do: IO.puts <span class="string">"hello world"</span></span><br><span class="line"><span class="keyword">...</span>(foo@c87c9967219c)<span class="number">1</span>&gt; end</span><br></pre></td></tr></table></figure>
<p>启动节点C,并在节点C上Spawn一个在节点A上运行的进程, 并放回消息到C节点的终端</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@c87c9967219c</span><span class="symbol">:~</span><span class="comment"># iex --sname C</span></span><br><span class="line">iex(bar<span class="variable">@c87c9967219c</span>)<span class="number">1</span>&gt; <span class="constant">Node.</span>spawn_link <span class="symbol">:<span class="string">"foo@c87c9967219c"</span></span>, <span class="keyword">fn</span> -&gt; <span class="constant">Hello.</span>world <span class="keyword">end</span></span><br><span class="line">hello world</span><br><span class="line"><span class="comment">#PID&lt;9010.79.0&gt;</span></span><br></pre></td></tr></table></figure>
<p>在节点C上定义要执行的代码, 并在A上运行, 然后把运行结果返回给C</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="constant">Node.</span>spawn_link <span class="symbol">:<span class="string">"A@c87c9967219c"</span></span>, <span class="keyword">fn</span> -&gt; <span class="constant">Hello.</span>world <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>收发消息:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iex(B@c87c9967219c)<span class="number">1</span>&gt; pid = Node.spawn_link :<span class="string">"A@c87c9967219c"</span>, fn -&gt;</span><br><span class="line"><span class="keyword">...</span>(B@c87c9967219c)<span class="number">1</span>&gt;   receive do</span><br><span class="line"><span class="keyword">...</span>(B@c87c9967219c)<span class="number">1</span>&gt;     &#123;:ping, client&#125; -&gt;</span><br><span class="line"><span class="keyword">...</span>(B@c87c9967219c)<span class="number">1</span>&gt;       send client, :pong</span><br><span class="line"><span class="keyword">...</span>(B@c87c9967219c)<span class="number">1</span>&gt;   end</span><br><span class="line"><span class="keyword">...</span>(B@c87c9967219c)<span class="number">1</span>&gt; end</span><br><span class="line"><span class="comment">#PID&lt;8005.65.0&gt;</span></span><br><span class="line">iex(B@c87c9967219c)<span class="number">2</span>&gt; send pid, &#123;:ping, self&#125;</span><br><span class="line">&#123;:ping, <span class="comment">#PID&lt;0.60.0&gt;&#125;</span></span><br><span class="line">iex(B@c87c9967219c)<span class="number">3</span>&gt; flush</span><br><span class="line">:pong</span><br><span class="line">:ok</span><br></pre></td></tr></table></figure>
<p>每次我们想要执行分布式计算的时候, 我们可以通过<code>Node.spawn_link/2</code>在其他节点上<code>spawn</code>一个进程, 但是我们应该避免在 supervision 树的外部去spawn子进程.</p>
<p>对于<code>Node.spawn_link2</code>, 有更好的替代</p>
<ul>
<li><p>可以使用<code>:rpc</code>模块执行远程节点上的函数, 比如:</p>
  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在A@c87c9967219c节点上, 执行Hello模块的:world函数, 没有参数</span><br><span class="line"><span class="attribute">:rpc.call(:"A@c87c9967219c",</span> Hello, :world, [])</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过<a href="http://elixir-lang.org/docs/master/elixir/GenServer.html#call/3" target="_blank" rel="external">GenServer API</a>请求运行在其他节点上的服务器, 比如:</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GenServer.<span class="function"><span class="title">call</span><span class="params">(&#123;name, node&#125;, arg)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用任务,任务可以在本地或远程节点上Spawn进程</p>
</li>
</ul>
<h2 id="参考资料">参考资料</h2><ol>
<li>Distributed tasks and configuration<br><a href="http://elixir-lang.org/getting_started/mix_otp/10.html" target="_blank" rel="external">http://elixir-lang.org/getting_started/mix_otp/10.html</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-19T18:10:29.000Z"><a href="/2014/11/20/elixir-failover-and-takeover/">2014-11-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/20/elixir-failover-and-takeover/">故障转移和接管</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>Elixir 可以运行在主/从, 故障转移/接管模式下. 要使Elixir应用程序能够执行故障转移/接管, Elixir应用程序必须是一个OTP应用程序.</p>
<p>下面来创建一个包含Supervisor的Elixir项目</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix <span class="built_in">new</span> distro <span class="comment">--sup</span></span><br></pre></td></tr></table></figure>
<p>修改<code>distro.ex</code>添加<code>logger</code>模块. 以记录当触发故障转移/接管操作时的日志记录.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">defmodule <span class="constant">Distro</span> <span class="keyword">do</span></span><br><span class="line">  use <span class="constant">Application</span></span><br><span class="line">  <span class="keyword">require</span> <span class="constant">Logger</span></span><br><span class="line">  <span class="comment">#See http://elixir-lang.org/docs/stable/elixir/Application.html</span></span><br><span class="line">  <span class="comment">#for more information on OTP Applications</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>start(_type, _args) <span class="keyword">do</span></span><br><span class="line">    import <span class="constant">Supervisor</span>.<span class="constant">Spec</span>, <span class="symbol">warn:</span> <span class="keyword">false</span></span><br><span class="line">    <span class="constant">Logger</span>.info(<span class="string">"Distro application in <span class="subst">#&#123;inspect _type&#125;</span> mode"</span>)</span><br><span class="line">    children = [</span><br><span class="line">      <span class="comment">#Define workers and child supervisors to be supervised</span></span><br><span class="line">      worker(<span class="constant">Distro</span>.<span class="constant">DistroCal</span>, [])</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">#See http://elixir-lang.org/docs/stable/elixir/Supervisor.html</span></span><br><span class="line">    <span class="comment">#for other strategies and supported options</span></span><br><span class="line">    opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">Distro</span>.<span class="constant">Supervisor</span>]</span><br><span class="line">    <span class="constant">Supervisor</span>.start_link(children, opts)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>DistroCal</code>位于<code>distro</code>子目录</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>mkdir lib/distro</span><br><span class="line"><span class="variable">$ </span>touch lib/distro/distro_cal.ex</span><br></pre></td></tr></table></figure>
<p><code>DistroCal</code>是一个<code>GenServer</code>: 它使用全局名称注册, 假设其运行在集群中的一个节点上, 全局注册让我们不用考虑其实际的运行位置, 只需要提供注册名称就可以访问.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Distro</span>.<span class="constant">DistroCal </span></span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">use</span> <span class="constant">GenServer</span></span><br><span class="line">    require <span class="constant">Logger</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_link</span> </span><span class="keyword">do</span></span><br><span class="line">        <span class="constant">GenServer.</span>start_link(<span class="constant">__MODULE__,</span> [], <span class="symbol">name:</span> &#123;<span class="symbol">:global</span>, <span class="constant">__MODULE__&#125;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span>(x,y) </span><span class="keyword">do</span></span><br><span class="line">        <span class="constant">GenServer.</span>call(&#123;<span class="symbol">:global</span>, <span class="constant">__MODULE__&#125;</span>, &#123;<span class="symbol">:cal</span>, x, y&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_call</span>(&#123;<span class="symbol">:cal</span>, x, y&#125;, <span class="constant">_from,</span> state) </span><span class="keyword">do</span></span><br><span class="line">        &#123;<span class="symbol">:reply</span>, x + y, state&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>编译和运行</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>mix compile</span><br><span class="line"><span class="variable">$ </span>iex --sname -pa <span class="constant">_build/</span>dev/lib/distro/ebin/ --app distro</span><br><span class="line">iex(abc<span class="variable">@44adb2a6d305</span>)<span class="number">1</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="应用程序分布">应用程序分布</h2><p>本节阐述了如何把一个应用程序分布到多个节点上</p>
<p>假设应用程序运行在3个节点上, 名称分别为<code>a</code>, <code>b</code>, <code>c</code>. 创建三个配置文件如下:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch config/<span class="tag">a</span><span class="class">.config</span></span><br><span class="line">touch config/<span class="tag">b</span><span class="class">.config</span></span><br><span class="line">touch config/c.config</span><br></pre></td></tr></table></figure>
<p>配置文件中有3个重要的键值对.</p>
<p><code>sync_nodes_timeout</code> -<br><code>sync_nodes_mandatory</code> -<br><code>distributed</code> -</p>
<p>a.config</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[&#123;kernel,</span><br><span class="line">	[</span><br><span class="line">	    &#123;</span><br><span class="line">	        distributed,</span><br><span class="line">	        [&#123;</span><br><span class="line">	            <span class="symbol">'distro'</span>, <span class="number">5000</span>, [</span><br><span class="line">	                <span class="symbol">'abc</span>@tom-thumbs-mbp',</span><br><span class="line">	                &#123;<span class="symbol">'bcd</span>@tom-thumbs-mbp', <span class="symbol">'def</span>@tom-thumbs-mbp'&#125;</span><br><span class="line">	            ]</span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;sync_nodes_mandatory, [<span class="symbol">'bcd</span>@tom-thumbs-mbp', <span class="symbol">'def</span>@tom-thumbs-mbp']&#125;,</span><br><span class="line">        &#123;sync_nodes_timeout, <span class="number">30000</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;].</span><br></pre></td></tr></table></figure>
<p>b.config</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[&#123;kernel,</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        distributed,</span><br><span class="line">        [</span><br><span class="line">            &#123;distro,<span class="number">5000</span>, [</span><br><span class="line">                <span class="symbol">'abc</span>@tom-thumbs-mbp',</span><br><span class="line">                &#123;<span class="symbol">'bcd</span>@tom-thumbs-mbp', <span class="symbol">'def</span>@tom-thumbs-mbp'&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;sync_nodes_mandatory, [<span class="symbol">'abc</span>@tom-thumbs-mbp', <span class="symbol">'def</span>@tom-thumbs-mbp']&#125;,</span><br><span class="line">    &#123;sync_nodes_timeout, <span class="number">30000</span>&#125;</span><br><span class="line">]&#125;].</span><br></pre></td></tr></table></figure>
<p>c.config</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[&#123;kernel,</span><br><span class="line">	[</span><br><span class="line">	    &#123;</span><br><span class="line">	        distributed, [</span><br><span class="line">	        &#123;</span><br><span class="line">	            distro,<span class="number">5000</span>, [</span><br><span class="line">	                <span class="symbol">'abc</span>@tom-thumbs-mbp',</span><br><span class="line">	                &#123;<span class="symbol">'bcd</span>@tom-thumbs-mbp', <span class="symbol">'def</span>@tom-thumbs-mbp'&#125;</span><br><span class="line">	            ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]&#125;,</span><br><span class="line">        &#123;sync_nodes_mandatory, [<span class="symbol">'abc</span>@tom-thumbs-mbp', <span class="symbol">'bcd</span>@tom-thumbs-mbp']&#125;,</span><br><span class="line">        &#123;sync_nodes_timeout, <span class="number">30000</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;].</span><br></pre></td></tr></table></figure>
<p>在不同的终端自动全部3个节点</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ iex –sname <span class="tag">a</span> -pa _build/dev/lib/distro/ebin/ –app distro –erl <span class="string">"-config config/a"</span></span><br><span class="line">$ iex –sname <span class="tag">b</span> -pa _build/dev/lib/distro/ebin/ –app distro –erl <span class="string">"-config config/b"</span></span><br><span class="line">$ iex –sname c -pa _build/dev/lib/distro/ebin/ –app distro –erl <span class="string">"-config config/c"</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>Elixir Application Failover/Takeover<br><a href="https://erlangcentral.org/topic/elixir-application-failovertakeover/" target="_blank" rel="external">https://erlangcentral.org/topic/elixir-application-failovertakeover/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-19T17:28:22.000Z"><a href="/2014/11/20/elixir-connect-nodes-on-the-same-lan/">2014-11-20</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/20/elixir-connect-nodes-on-the-same-lan/">连接同一个局域网的Elixir节点</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#本机两个终端连接两个节点"><span class="toc-number">1.</span> <span class="toc-text">本机两个终端连接两个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在同一个局域网中连接两个节点"><span class="toc-number">2.</span> <span class="toc-text">在同一个局域网中连接两个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <h2 id="本机两个终端连接两个节点">本机两个终端连接两个节点</h2><p>要点: 使用 <code>--sname</code> 启动选项</p>
<p>终端A:</p>
<pre><code>iex <span class="comment">--sname A</span>
</code></pre><p>终端C:</p>
<pre><code>iex <span class="comment">--sname C</span>
</code></pre><p>在终端A中运行</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iex(A<span class="variable">@localhost</span>)<span class="number">1</span>&gt; Node.<span class="keyword">connect</span> :<span class="string">'C@localhost'</span> <span class="variable">%%</span> 连接C节点</span><br><span class="line">true</span><br><span class="line">iex(A<span class="variable">@localhost</span>)<span class="number">2</span>&gt; node <span class="variable">%%</span> 显示当前节点名称</span><br><span class="line">:<span class="string">"A<span class="variable">@localhost</span>"</span></span><br><span class="line">iex(A<span class="variable">@localhost</span>)<span class="number">3</span>&gt; Node.list <span class="variable">%%</span> 列出连接到当前节点的其他节点</span><br><span class="line">[:<span class="string">"C<span class="variable">@localhost</span>"</span>]</span><br><span class="line">iex(A<span class="variable">@localhost</span>)<span class="number">4</span>&gt; [node | Node.list] <span class="variable">%%</span> 列出当前节点和连接节点</span><br><span class="line">[:<span class="string">"A<span class="variable">@localhost</span>"</span>, :<span class="string">"C<span class="variable">@localhost</span>"</span>]</span><br><span class="line">iex(A<span class="variable">@localhost</span>)<span class="number">5</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="在同一个局域网中连接两个节点">在同一个局域网中连接两个节点</h2><p>要点: 使用 <code>--name</code> 启动选项</p>
<p>启动<code>A</code>(192.168.8.100)节点</p>
<pre><code><span class="title">iex</span> --name A@<span class="number">192.168.8.100</span>
</code></pre><p>启动<code>C</code>(192.168.8.200)节点</p>
<pre><code><span class="title">iex</span> --name C@<span class="number">192.168.8.200</span>
</code></pre><p>从<code>192.168.8.100</code>连接到<code>192.168.8.200</code>, 在<code>192.168.8.100</code>(A)的终端执行:</p>
<pre><code><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">1</span>&gt; Node<span class="class">.connect</span> :<span class="string">'C@192.168.8.200'</span>
</code></pre><p>验证连接的节点</p>
<pre><code><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">2</span>&gt; Node.list
</code></pre><p>连接到多个节点原理相同, 如果增加D(192.168.8.201),E(192.168.8.202),F(192.168.8.203)节点到集群中, 在A节点上(192.168.8.100)依次再执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">1</span>&gt; Node<span class="class">.connect</span> :<span class="string">'D@192.168.8.201'</span></span><br><span class="line"><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">2</span>&gt; Node<span class="class">.connect</span> :<span class="string">'E@192.168.8.202'</span></span><br><span class="line"><span class="function"><span class="title">iex</span><span class="params">(A@<span class="number">192.168</span>.<span class="number">8.100</span>)</span></span><span class="number">3</span>&gt; Node<span class="class">.connect</span> :<span class="string">'F@192.168.8.203'</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>Connecting Elixir Nodes on the Same LAN<br><a href="http://benjamintanweihao.github.io/blog/2014/05/25/connecting-elixir-nodes-on-the-same-lan/" target="_blank" rel="external">http://benjamintanweihao.github.io/blog/2014/05/25/connecting-elixir-nodes-on-the-same-lan/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-19T02:49:04.000Z"><a href="/2014/11/19/elixir-bit-syntax-and-id3/">2014-11-19</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/19/elixir-bit-syntax-and-id3/">从ID3中解析Mp3元数据</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p>TODO:: 判断MP3文件是否包含<code>TAG</code>标签</p>
<h2 id="MP3和ID3">MP3和ID3</h2><p>ID3是一种在MP3中使用的描述MP3音频文件的元数据结构, 如下图所示:</p>
<p><img src="/assets/images/vlc_metadata.png" alt="ID3元数据"></p>
<h2 id="ID3v1_字段结构">ID3v1 字段结构</h2><p><img src="/assets/images/id3v1_blocks.gif" alt="字段结构"></p>
<p><img src="/assets/images/id3v1.png" alt="ID3v1 布局"></p>
<h2 id="读取Mp3文件">读取Mp3文件</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Mp3</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get</span>(filename) </span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="constant">File.</span>read(filename) <span class="keyword">do</span></span><br><span class="line">        &#123;<span class="symbol">:ok</span>, binary&#125; -&gt;</span><br><span class="line">            binary</span><br><span class="line">        <span class="constant">_ </span>-&gt;</span><br><span class="line">        <span class="constant">IO.</span>puts <span class="string">"Can't not open <span class="subst">#&#123;filename&#125;</span>"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="提取ID3v1_标记">提取ID3v1 标记</h2><p>ID3标记是MP3文件的最后128字节, 因此我们可以计算出ID3 Tag的起始偏移量</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mp3_byte_size = (<span class="function"><span class="title">byte_size</span><span class="params">(binary)</span></span> - <span class="number">128</span>)</span><br></pre></td></tr></table></figure>
<p>然后通过Bit Syntax类匹配出我们需要的ID3 Tag部分的Bit字符串.</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; _ :: <span class="built_in">binary</span>-<span class="built_in">size</span>(mp3_byte_size), id3_tag :: <span class="built_in">binary</span> &gt;&gt; = <span class="built_in">binary</span></span><br></pre></td></tr></table></figure>
<h2 id="完整代码">完整代码</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Mp3</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(filename) </span><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="constant">File.</span>read(filename) <span class="keyword">do</span></span><br><span class="line">      &#123;<span class="symbol">:ok</span>, binary&#125; -&gt;</span><br><span class="line">        <span class="constant">IO.</span>puts byte_size(binary)</span><br><span class="line">        <span class="comment"># 获取Mp3音频数据的大小,用于计算ID3的起始偏移量</span></span><br><span class="line">        mp3_byte_size = (byte_size(binary) - <span class="number">128</span>) * <span class="number">8</span></span><br><span class="line">        <span class="comment"># 把我们需要的部分解析出来</span></span><br><span class="line">        &lt;&lt; <span class="constant">_ </span><span class="symbol">:</span><span class="symbol">:</span> size(mp3_byte_size), id3_tag <span class="symbol">:</span><span class="symbol">:</span> binary &gt;&gt; = binary</span><br><span class="line">        <span class="keyword">case</span> id3_tag <span class="keyword">do</span></span><br><span class="line">          &lt;&lt;<span class="string">"TAG"</span>,<span class="symbol">tags:</span><span class="symbol">:binary&gt;&gt;</span> -&gt;</span><br><span class="line">            <span class="comment"># 从id3_tag中匹配出标题,艺术家名称,专辑名称,发行年份, 评论, 等</span></span><br><span class="line">            &lt;&lt; tag     <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">3</span>),</span><br><span class="line">               title   <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">30</span>),</span><br><span class="line">               artist  <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">30</span>),</span><br><span class="line">               album   <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">30</span>),</span><br><span class="line">               year    <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">4</span>),</span><br><span class="line">               comment <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">30</span>),</span><br><span class="line">               genre   <span class="symbol">:</span><span class="symbol">:</span> binary-size(<span class="number">1</span>)</span><br><span class="line">            &gt;&gt;  = id3_tag</span><br><span class="line">            <span class="comment"># 输出</span></span><br><span class="line">            <span class="constant">IO.</span>puts tags</span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"TAG: <span class="subst">#&#123;tag&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"标题名: <span class="subst">#&#123;title&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"艺术家: <span class="subst">#&#123;artist&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"专辑名: <span class="subst">#&#123;album&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"年份: <span class="subst">#&#123;year&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"评论: <span class="subst">#&#123;comment&#125;</span>"</span></span><br><span class="line">            <span class="constant">IO.</span>puts <span class="string">"流派: <span class="subst">#&#123;genre&#125;</span>"</span></span><br><span class="line">          <span class="constant">_ </span>-&gt;</span><br><span class="line">            <span class="symbol">:NO_TAG_INFORMATION</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="constant">_ </span>-&gt;</span><br><span class="line">        <span class="constant">IO.</span>puts <span class="string">"Can't not open <span class="subst">#&#123;filename&#125;</span>"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li>本文原文<br><a href="http://benjamintanweihao.github.io/blog/2014/06/10/elixir-bit-syntax-and-id3/" target="_blank" rel="external">http://benjamintanweihao.github.io/blog/2014/06/10/elixir-bit-syntax-and-id3/</a></li>
<li>ID3v1 结构说明<br><a href="http://id3.org/ID3v1" target="_blank" rel="external">http://id3.org/ID3v1</a></li>
<li>Erlang 比特语法和ID3<br><a href="http://www.citizen428.net/blog/2010/09/04/erlang-bit-syntax-and-id3" target="_blank" rel="external">http://www.citizen428.net/blog/2010/09/04/erlang-bit-syntax-and-id3</a></li>
<li>Erlang 比特语法<br><a href="http://www.erlang.org/doc/programming_examples/bit_syntax.html" target="_blank" rel="external">http://www.erlang.org/doc/programming_examples/bit_syntax.html</a></li>
<li>Erlang Programming - Francesco Cesarini and Simon Thompson 电子版PDF, 206页</li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-14T10:15:11.000Z"><a href="/2014/11/14/erlang-design-your-own-behaviour/">2014-11-14</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/14/erlang-design-your-own-behaviour/">自定义行为</a></h1>
  

    </header>
    <div class="entry">
      


        


        <figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pp"><span class="keyword">-module</span><span class="params">(some_behaviour)</span></span>.</span><br><span class="line"><span class="pp">-callback init<span class="params">(<span class="variable">Args</span> :: <span class="function_name">list</span>(<span class="function_name">term</span>()))</span> -&gt; 'ok'|tuple<span class="params">('error', <span class="variable">Reason</span> :: <span class="function_name">string</span>())</span></span>.</span><br><span class="line"><span class="pp">-callback handle<span class="params">(<span class="variable">Event</span> :: <span class="function_name">atom</span>())</span> -&gt; NextEvent :: atom<span class="params">()</span></span>.</span><br><span class="line"><span class="pp">-callback sync<span class="params">(<span class="variable">Node</span> :: <span class="function_name">node</span>(), <span class="variable">Timeout</span> :: <span class="function_name">non_neg_integer</span>())</span> -&gt; 'ok'|tuple<span class="params">('error', <span class="variable">Reason</span> :: <span class="function_name">string</span>())</span></span>.</span><br></pre></td></tr></table></figure>
<p>该行为要求在回调模块中定义 <code>init/1</code>, <code>handle/1</code> 和 <code>sync/2</code>三个函数, 如下:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-<span class="function"><span class="title">module</span><span class="params">(usage)</span></span>.</span><br><span class="line">-<span class="function"><span class="title">behaviour</span><span class="params">(some_behaviour)</span></span>.</span><br><span class="line">-<span class="function"><span class="title">export</span><span class="params">([init/<span class="number">1</span>, handle/<span class="number">1</span>, sync/<span class="number">2</span>, foo/<span class="number">0</span>])</span></span>.</span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(Config)</span></span> -&gt;</span><br><span class="line">    Config.</span><br><span class="line"><span class="function"><span class="title">sync</span><span class="params">(_Entry, Config)</span></span> -&gt;</span><br><span class="line">    Config.</span><br><span class="line"><span class="function"><span class="title">handle</span><span class="params">(Message)</span></span> -&gt;</span><br><span class="line">    Message.</span><br><span class="line"><span class="function"><span class="title">foo</span><span class="params">()</span></span> -&gt;</span><br><span class="line">    foo_atom_returned.</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-13T08:55:44.000Z"><a href="/2014/11/13/erlang-resource-pool/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/erlang-resource-pool/">资源池</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计"><span class="toc-number">2.</span> <span class="toc-text">设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#操作"><span class="toc-number">3.</span> <span class="toc-text">操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#borrow"><span class="toc-number">3.1.</span> <span class="toc-text">borrow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return"><span class="toc-number">3.2.</span> <span class="toc-text">return</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add"><span class="toc-number">3.3.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invalidate"><span class="toc-number">3.4.</span> <span class="toc-text">invalidate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#典型用例"><span class="toc-number">3.5.</span> <span class="toc-text">典型用例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大小限制"><span class="toc-number">4.</span> <span class="toc-text">大小限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#max_active"><span class="toc-number">4.1.</span> <span class="toc-text">max_active</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max_idle"><span class="toc-number">4.2.</span> <span class="toc-text">max_idle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#min_idle"><span class="toc-number">4.3.</span> <span class="toc-text">min_idle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行为选项"><span class="toc-number">5.</span> <span class="toc-text">行为选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#资源池耗尽时的borrow行为"><span class="toc-number">5.1.</span> <span class="toc-text">资源池耗尽时的borrow行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源检查"><span class="toc-number">5.2.</span> <span class="toc-text">资源检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源在Idle列表中的顺序"><span class="toc-number">5.3.</span> <span class="toc-text">资源在Idle列表中的顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计时"><span class="toc-number">5.4.</span> <span class="toc-text">计时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源池实例的维护"><span class="toc-number">6.</span> <span class="toc-text">资源池实例的维护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#new"><span class="toc-number">6.1.</span> <span class="toc-text">new</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clear"><span class="toc-number">6.2.</span> <span class="toc-text">clear</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#close"><span class="toc-number">6.3.</span> <span class="toc-text">close</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源池统计"><span class="toc-number">6.4.</span> <span class="toc-text">资源池统计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源工厂"><span class="toc-number">7.</span> <span class="toc-text">资源工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">8.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL_Driver连接池"><span class="toc-number">8.1.</span> <span class="toc-text">MySQL Driver连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rabbit_MQ_连接通道池"><span class="toc-number">8.2.</span> <span class="toc-text">Rabbit MQ 连接通道池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>资源池是解决并发问题的一种常见模式</p>
<p>Versions:</p>
<ul>
<li><code>2014-11-13</code> <code>Version 0.1</code></li>
</ul>
<h2 id="简介">简介</h2><p>软件资源的创建需要消耗大量的时间和内存, 如果能重用, 将极大地改善应用程序的性能. 资源池是一个在不同的平台和语言中广泛的使用的方法.本文所述<a href="http://sourceforge.net/projects/erlpool/" target="_blank" rel="external">Erlang资源池</a>的设计灵感来源于Apache的Common Pool库. API和主要的功能是从其借用的, 但内部实现完全不同, 并使用了Erlang OTP设计原则, 以及Erlang并发模型.</p>
<h2 id="设计">设计</h2><p>资源池由两个列表组成: <code>Active</code>(活动列表)和<code>Idle</code>(空闲列表). <code>Active</code>列表包含活跃的资源. <code>Idle</code>列表包含不活跃的资源</p>
<pre><code>图-1: 资源池为空的状态,活动列表和空闲列表都为空

<span class="code">+-Pool-----------{0,0}-+</span>
|                      |
| Active--<span class="code">+  Idle----+</span> |
| |       |  |       | |
| |       |  |       | |
| |       |  |       | |
<span class="header">| +-------+  +-------+ |
+----------------------+</span>
</code></pre><h2 id="操作">操作</h2><h3 id="borrow">borrow</h3><p>要从资源池中获得一个资源,需要调用函数<code>borrow</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">Resource</span> = resource_pool:borrow(test_pool)</span><br></pre></td></tr></table></figure>
<p>如果资源池的<code>Idle</code>列表为空(在没有资源可用的情况下),资源池会直接在<code>Active</code>列表中创建一个资源并授予调用进程.</p>
<pre><code><span class="comment">图</span><span class="literal">-</span><span class="comment">2:</span> <span class="comment">创建一个新的资源</span><span class="string">,</span><span class="comment">并把该资源放到</span> <span class="comment">Active</span> <span class="comment">资源列表</span>

<span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">0}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">0}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><p>如果在资源池的<code>Idle</code>列表中存在可用的资源. 将从<code>Idle</code>列表中取出一个资源,并转移到<code>Active</code>列表,然后授予调用者进程.</p>
<pre><code><span class="comment">图</span><span class="literal">-</span><span class="comment">3:</span> <span class="comment">从空闲资源列表中得到一个资源</span><span class="string">,</span><span class="comment">并把它转移到活动列表</span>

<span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">2}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><h3 id="return">return</h3><p>一旦进程完成了对资源的使用,它必须把资源返回到资源池中</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:return(test_pool,<span class="variable">Resource</span>)</span><br></pre></td></tr></table></figure>
<p>换句话说,就是该资源从<code>Active</code>列表移动到<code>Idle</code>列表(图-4). 以让其他进程能够从资源池中获取可用的资源.</p>
<pre><code><span class="comment">图</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">进程把资源返还给资源池</span>

<span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">2}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><h3 id="add">add</h3><p>有时候我们需要添加新的资源</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:add(test_pool)</span><br></pre></td></tr></table></figure>
<p>函数<code>add</code>创建一个新的资源,并添加到<code>Idle</code>列表中</p>
<pre><code><span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">2}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">4</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><h3 id="invalidate">invalidate</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:invalidate(test_pool,<span class="variable">Resource</span>)</span><br></pre></td></tr></table></figure>
<p><code>invalidate</code> 函数把一个失败的资源标记为不可用,资源池然后会销毁这个资源.</p>
<pre><code><span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><h3 id="典型用例">典型用例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> resource_pool:borrow(test_pool) <span class="keyword">of</span></span><br><span class="line">  <span class="tuple">&#123;error, <span class="variable">E</span>&#125;</span> -&gt; io:format(<span class="string">"Error while borrow from pool, reason: ~p"</span>, [<span class="variable">E</span>]);</span><br><span class="line">  <span class="variable">Resource</span> -&gt;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">      resource:operation(<span class="variable">Resource</span>),</span><br><span class="line">      resource_pool:return(test_pool, <span class="variable">Resource</span>)</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">      <span class="variable">_</span>:<span class="variable">_</span> -&gt; resource_pool:invalidate(test_pool, <span class="variable">Resource</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="大小限制">大小限制</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,resource_factory,resource_metadata,options</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">max_active,</span><br><span class="line">max_idle,</span><br><span class="line">min_idle</span><br></pre></td></tr></table></figure>
<pre><code>            +-Pool-----------{<span class="number">0</span>,<span class="number">0</span>}-+
            <span class="string">|                      |</span>
            <span class="string">| Active--+  Idle----+ |</span>
            <span class="string">| |       |  |_______|_|__ max_idle</span>
max_active__<span class="string">|_|_______|  |       | |</span>
            <span class="string">| |       |  |       | |</span>
            <span class="string">| |       |  |_______|_|__ min_idle</span>
            <span class="string">| |       |  |       | |</span>
            <span class="string">| +-------+  +-------+ |</span>
            +----------------------+
</code></pre><h3 id="max_active">max_active</h3><p><code>Active</code>列表默认最大值为8. 如果达到限制<code>borrow</code>操作将会阻塞或失败.  值 -1 (或任何负值) 表示<code>Active</code>列表没有大小限制.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> =</span><br><span class="line">    resource_pool:new(test_pool,resource_factory,[],[<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>])</span><br></pre></td></tr></table></figure>
<h3 id="max_idle">max_idle</h3><p><code>Idle</code>列表的最大大小,默认和<code>max_active</code>相同. 如果达到限制,后续<code>return</code>的资源会被销毁,值 -1 (或任何负值) 表示<code>Idle</code>列表没有大小限制.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                          <span class="comment">%% 资源池实例标识</span></span><br><span class="line">    resource_factory,                   <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                 <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;max_idle,<span class="number">10</span>&#125;</span>]     <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="min_idle">min_idle</h3><p><code>Idle</code>列表默认的最小大小为0.</p>
<p>If it reaches the limit then following borrow operation will successfully supplies a resource to invoker and then pool will additionally create new resource in Idle container to provide min_idle condition.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                                      <span class="comment">%% 资源池标识</span></span><br><span class="line">    resource_factory,                               <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                             <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;max_idle,<span class="number">10</span>&#125;</span>,<span class="tuple">&#123;min_idle,<span class="number">3</span>&#125;</span>]    <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>关于空闲资源的最大和最小值应该根据实际需求控制在一个合理的区间. 太小会导致频繁的创建资源,太大又会消耗过多的内存.</p>
<h2 id="行为选项">行为选项</h2><h3 id="资源池耗尽时的borrow行为">资源池耗尽时的borrow行为</h3><ul>
<li><p><code>{when_exhausted_action,fail}</code><br>在耗尽的资源池上调用<code>borrow</code>将返回<code>{error,pool_exhausted}</code></p>
</li>
<li><p><code>{when_exhausted_action,block}</code><br>在耗尽的资源池上调用<code>borrow</code>将阻塞,知道有空闲的资源可用,等待的最大时间可以通过选项<code>max_wait</code>控制</p>
</li>
<li><p><code>{when_exhausted_action,grow}</code><br>在耗尽的资源池上调用<code>borrow</code>将创建新资源,并增大<code>Active</code>列表的大小,此时<code>max_Idle</code>选项被忽略.</p>
</li>
</ul>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok,<span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    test_pool,                                     <span class="comment">%% 资源池实例标识</span></span><br><span class="line">    resource_factory,                              <span class="comment">%% 资源工厂</span></span><br><span class="line">    [],                                            <span class="comment">%% 资源元数据</span></span><br><span class="line">    [<span class="tuple">&#123;max_active,<span class="number">20</span>&#125;</span>,<span class="tuple">&#123;when_exhausted_action,fail&#125;</span>] <span class="comment">%% 资源池选项</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="资源检查">资源检查</h3><p>Resource pool can check status of managed resources. Options <code>test_on_borrow</code> and <code>test_on_return</code> control how pool tests resources: before providing resource to invoker <code>{test_on_borrow, true}</code> and after a resource was returned to pool <code>{test_on_return, true}</code>. If pool finds that the resource is not alive during test then the resource will be destroyed.</p>
<h3 id="资源在Idle列表中的顺序">资源在Idle列表中的顺序</h3><p>Option <code>fifo</code> (first-input-first-output) controls order of extracting a resources from <code>Idle</code> list. Diagrams below illustrate this. Suppose we fill out <code>Idle</code> list in order: <r.1> was first, <r.2> is next, then <r.3>. Resource <r.4> is active in given moment. If <code>{fifo, true}</code> is set the <code>borrow</code> operation leads to situation below: resource <r.1> was came first and it becames active now (first input).</r.1></r.4></r.3></r.2></r.1></p>
<pre><code><span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">2}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">4</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">4</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><p>If <code>{fifo, false}</code> is set it means that order will be last-input-first-output. <code>borrow</code> operation makes active resource <r.3> (last input).</r.3></p>
<pre><code><span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{1</span><span class="string">,</span><span class="comment">2}</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="comment">Pool</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">{2</span><span class="string">,</span><span class="comment">1}</span><span class="literal">-</span><span class="literal">+</span>
<span class="comment">|</span>                      <span class="comment">|</span>          <span class="comment">|</span>                      <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">Active</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="comment">Idle</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span>       <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span>       <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>    <span class="comment">=</span>&gt;    <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">3</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">2</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">4</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">4</span>&gt; <span class="comment">|</span>  <span class="comment">|</span> &lt;<span class="comment">R</span><span class="string">.</span><span class="comment">1</span>&gt; <span class="comment">|</span> <span class="comment">|</span>
<span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>  <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span> <span class="comment">|</span>
<span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</code></pre><p>Default value for <code>fifo</code> is <code>false</code>.</p>
<h3 id="计时">计时</h3><p><code>max_wait</code>选项定义了一个时间, 当在资源池耗尽时调用<code>borrow</code>函数,并且 <code>when_exhausted_action</code> 设置为<code>block</code>时所等待的最大时间.</p>
<p><code>max_idle_time</code> ,用来配置资源的最大空闲时间. 如果一个资源空闲的超过这个时间, 就会被销毁. 但至少要在资源池中保留<code>min_idle</code>个资源. 如果<code>max_idle_time</code>设置为<code>infinity</code>, 不会销毁任何空闲的资源.</p>
<h2 id="资源池实例的维护">资源池实例的维护</h2><p><code>pool_name</code>是一个原子, 多个进程可以使用该名字来访问资源池. <code>resource_factory</code>是一个负责创建和维护资源的模块名称. <code>resource_metadata</code>是一个包含资源初始化信息的对象. 该对象作为参数传递给<code>resource_factory</code>的每个函数来帮助维护一个资源.</p>
<h3 id="new">new</h3><p>创建资源池</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tuple">&#123;ok, <span class="variable">Pid</span>&#125;</span> = resource_pool:new(</span><br><span class="line">    pool_name,          <span class="comment">%% 资源池名称</span></span><br><span class="line">    resource_factory,   <span class="comment">%% 资源工厂</span></span><br><span class="line">    resource_metadata   <span class="comment">%% 资源元数据</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="clear">clear</h3><p>清空资源池</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resource_pool:clear(pool_name)</span><br></pre></td></tr></table></figure>
<h3 id="close">close</h3><p>关闭资源池, 该函数终止资源池进程, 并销毁池中的所有资源</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok = resource_pool:close(pool_name)</span><br></pre></td></tr></table></figure>
<h3 id="资源池统计">资源池统计</h3><p>get_num_active,get_num_idle,get_number</p>
<h2 id="资源工厂">资源工厂</h2><h2 id="示例">示例</h2><h3 id="MySQL_Driver连接池">MySQL Driver连接池</h3><p><a href="http://sourceforge.net/projects/erlmysql/" target="_blank" rel="external">http://sourceforge.net/projects/erlmysql/</a></p>
<h3 id="Rabbit_MQ_连接通道池">Rabbit MQ 连接通道池</h3><p><a href="http://sourceforge.net/projects/erlpool/files/1.0.x/erl.resource.pool.example.zip/download" target="_blank" rel="external">http://sourceforge.net/projects/erlpool/files/1.0.x/erl.resource.pool.example.zip/download</a></p>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="https://erlangcentral.org/wiki/index.php?title=Resource_Pool" target="_blank" rel="external">https://erlangcentral.org/wiki/index.php?title=Resource_Pool</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:43:21.000Z"><a href="/2014/11/13/elixir-deploy-phoenix-application-to-a-ubuntu-server/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-deploy-phoenix-application-to-a-ubuntu-server/">部署Phoenix应用程序到Ubuntu服务器</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="安装部署工具">安装部署工具</h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="keyword">get</span> install -y capistrano</span><br></pre></td></tr></table></figure>
<h2 id="部署">部署</h2><h2 id="步骤1:_安装_capistrano_和_capify">步骤1: 安装 capistrano 和 capify</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="operator"><span class="keyword">install</span> capistrano <span class="comment">--version=2.15.5</span></span><br><span class="line">capify .</span><br><span class="line">mkdir config/deploy</span></span><br></pre></td></tr></table></figure>
<h2 id="步骤2:_添加_exrm_依赖">步骤2: 添加 exrm 依赖</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defp deps do</span><br><span class="line">  [</span><br><span class="line">    <span class="keyword">...</span></span><br><span class="line">    &#123;:exrm, <span class="string">"~&gt; 0.14.11"</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix deps.<span class="keyword">get</span></span><br></pre></td></tr></table></figure>
<h2 id="步骤3:_改变应用程序的启动方式">步骤3: 改变应用程序的启动方式</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Application</span></span><br><span class="line">  <span class="comment"># See http://elixir-lang.org/docs/stable/elixir/Application.html</span></span><br><span class="line">  <span class="comment"># for more information on OTP Applications</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="constant">_type,</span> <span class="constant">_args)</span> </span><span class="keyword">do</span></span><br><span class="line">    import <span class="constant">Supervisor.Spec,</span> <span class="symbol">warn:</span> <span class="keyword">false</span></span><br><span class="line">    children = [</span><br><span class="line">      <span class="comment"># Define workers and child supervisors to be supervised</span></span><br><span class="line">      <span class="comment"># worker(BookStore.Worker, [arg1, arg2, arg3])</span></span><br><span class="line">      worker(<span class="constant">BookStore.Repo,</span> [])</span><br><span class="line">    ]</span><br><span class="line">    <span class="constant">BookStore.Router.</span>start</span><br><span class="line">    <span class="comment"># See http://elixir-lang.org/docs/stable/elixir/Supervisor.html</span></span><br><span class="line">    <span class="comment"># for other strategies and supported options</span></span><br><span class="line">    opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">BookStore.Supervisor]</span></span><br><span class="line">    <span class="constant">Supervisor.</span>start_link(children, opts)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>第12行, 添加了<code>BookStore.Router.start</code></p>
<p>在开发模式中,应用程序不再能够以正常的方式启动. <code>mix phoenix.start</code>会立即崩溃, 并显示如下错误:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Running MyAwesomeApp.Router with Cowboy on port <span class="number">4000</span></span><br><span class="line">** (CaseClauseError) no <span class="keyword">case</span> clause <span class="string">matching:</span> &#123;:error, &#123;:already_started, #PID&lt;<span class="number">0.149</span><span class="number">.0</span>&gt;&#125;&#125;</span><br><span class="line">    (phoenix) lib<span class="regexp">/phoenix/</span>router.<span class="string">ex:</span><span class="number">78</span>: Phoenix.Router.start_adapter/<span class="number">2</span></span><br><span class="line">    (phoenix) lib<span class="regexp">/mix/</span>tasks<span class="regexp">/phoenix/</span>start.<span class="string">ex:</span><span class="number">12</span>: Mix.Tasks.Phoenix.Start.run/<span class="number">1</span></span><br><span class="line">    (mix) lib<span class="regexp">/mix/</span>cli.<span class="string">ex:</span><span class="number">55</span>: Mix.CLI.run_task/<span class="number">2</span></span><br><span class="line">    (elixir) src<span class="regexp">/elixir_lexical.erl:17: :elixir_lexical.run/</span><span class="number">3</span></span><br><span class="line">    (elixir) lib<span class="regexp">/code.ex:316: Code.require_file/</span><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>在开发模式中, 你需要使用下面的方式启动服务器</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex -S mix phoenix.<span class="built_in">start</span></span><br></pre></td></tr></table></figure>
<h2 id="步骤4:_把代码Push到Git仓库">步骤4: 把代码Push到Git仓库</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin git<span class="annotation">@github</span>.<span class="string">com:</span>developerworks/book_store.git</span><br></pre></td></tr></table></figure>
<p>提交代码到远程仓库</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">add</span> . &amp;&amp; git commit -am <span class="string">"initial commit"</span></span><br><span class="line">git <span class="keyword">push</span> origin master</span><br></pre></td></tr></table></figure>
<h2 id="步骤5:_在Ubuntu服务器上安装Erlang和Elixir">步骤5: 在Ubuntu服务器上安装Erlang和Elixir</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>wget <span class="symbol">http:</span>/<span class="regexp">/packages.erlang-solutions.com/erlang</span>-solutions_1.<span class="number">0_</span>all.deb</span><br><span class="line"><span class="variable">$ </span>sudo dpkg -i erlang-solutions_1.<span class="number">0_</span>all.deb</span><br><span class="line"><span class="variable">$ </span>sudo apt-get update</span><br><span class="line"><span class="variable">$ </span>sudo apt-get install erlang</span><br></pre></td></tr></table></figure>
<p>由于Phoenix依赖Elixir 1.0.1, 需要手动安装合适的Elixir版本.</p>
<p>下载,解压,编译</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /root</span><br><span class="line">wget http<span class="variable">s:</span>//github.<span class="keyword">com</span>/elixir-lang/elixir/archive/v1.<span class="number">0.2</span>.zip</span><br><span class="line">unzip v1.<span class="number">0.2</span>.zip</span><br><span class="line"><span class="keyword">cd</span> elixir-<span class="number">1.0</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">make</span></span><br></pre></td></tr></table></figure>
<p>把程序路径添加到PATH中</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'export PATH=/root/elixir-1.0.2/bin:$PATH'</span> &gt;&gt; ~/.<span class="keyword">profile</span></span><br><span class="line"><span class="keyword">source</span> ~/.<span class="keyword">profile</span></span><br></pre></td></tr></table></figure>
<p>检查版本</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elixir --version</span></span><br><span class="line"><span class="title">Elixir</span> <span class="number">1</span>.<span class="number">0</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="步骤6:_调整Locale">步骤6: 调整Locale</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export LANGUAGE=en_US<span class="class">.UTF-8</span></span><br><span class="line">export LANG=en_US<span class="class">.UTF-8</span></span><br><span class="line">export LC_ALL=en_US<span class="class">.UTF-8</span></span><br><span class="line">locale-gen en_US<span class="class">.UTF-8</span></span><br><span class="line">sudo apt-get install locales</span><br><span class="line">sudo dpkg-reconfigure locales</span><br></pre></td></tr></table></figure>
<p>在<code>~/.profile</code>中添加下面的配置</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export LANGUAGE=en_US<span class="class">.UTF-8</span></span><br><span class="line">export LANG=en_US<span class="class">.UTF-8</span></span><br><span class="line">export LC_ALL=en_US.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>在<code>/etc/environment</code>添加如下配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="setting">LC_ALL=<span class="value">en_US.UTF-<span class="number">8</span></span></span></span><br><span class="line"><span class="setting">LANG=<span class="value">en_US.UTF-<span class="number">8</span></span></span></span><br></pre></td></tr></table></figure>
<h2 id="步骤6:_编辑config/deploy-rb">步骤6: 编辑config/deploy.rb</h2><p>粘贴下面的代码</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">require <span class="string">'capistrano/ext/multistage'</span></span><br><span class="line">set <span class="symbol">:stages</span>, [<span class="string">"staging"</span>, <span class="string">"production"</span>]</span><br><span class="line">set <span class="symbol">:default_stage</span>, <span class="string">"production"</span></span><br><span class="line">set <span class="symbol">:keep_releases</span>, <span class="number">5</span></span><br><span class="line">set <span class="symbol">:application</span>, <span class="string">"My Awesome App"</span></span><br><span class="line">set <span class="symbol">:repository</span>,  <span class="string">"git@github.com:learnelixir/my-awesome-app.git"</span></span><br><span class="line">set <span class="symbol">:scm</span>, <span class="symbol">:git</span></span><br><span class="line">set <span class="symbol">:branch</span>, <span class="symbol">:master</span></span><br><span class="line">set <span class="symbol">:use_sudo</span>, <span class="keyword">false</span></span><br><span class="line">set <span class="symbol">:normalize_asset_timestamps</span>, <span class="keyword">false</span></span><br><span class="line">set <span class="symbol">:deploy_via</span>, <span class="symbol">:remote_cache</span></span><br><span class="line">after <span class="string">"deploy:update"</span>, <span class="string">"deploy:cleanup"</span></span><br><span class="line">after <span class="string">"deploy:update"</span>, <span class="string">"deploy:build"</span>, <span class="string">"deploy:cleanup"</span></span><br><span class="line">namespace <span class="symbol">:assets</span> <span class="keyword">do</span></span><br><span class="line">  task <span class="symbol">:precompile</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_application_running?</span>(current_path)  pid = capture(%<span class="constant">Q&#123;</span>ps ax -o pid= -o command=|</span><br><span class="line">      grep <span class="string">"/home/app/www/book_store/current/rel/book_store/.*/[b]eam"</span>|awk <span class="string">'&#123;print $1&#125;'</span>&#125;)  <span class="keyword">return</span> pid != <span class="string">""</span>endnamespace <span class="symbol">:deploy</span> </span><span class="keyword">do</span></span><br><span class="line">  task <span class="symbol">:is_running</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    is_running = is_application_running?(current_path)</span><br><span class="line">    if is_running</span><br><span class="line">      puts <span class="string">"Application is running"</span></span><br><span class="line">    else</span><br><span class="line">      puts <span class="string">"Application is NOT running"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  task <span class="symbol">:build</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    run <span class="string">"cd <span class="subst">#&#123;current_path&#125;</span> &amp;&amp; mix deps.get &amp;&amp; MIX_ENV=<span class="subst">#&#123;mix_env&#125;</span> mix release"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  task <span class="symbol">:restart</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    if is_application_running?(current_path)</span><br><span class="line">      run <span class="string">"cd <span class="subst">#&#123;current_path&#125;</span>/rel/book_store/bin &amp;&amp; ./book_store stop"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    run <span class="string">"cd <span class="subst">#&#123;current_path&#125;</span>/rel/book_store/bin &amp;&amp; ./book_store start"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  task <span class="symbol">:start</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    run <span class="string">"cd <span class="subst">#&#123;current_path&#125;</span>/rel/book_store/bin &amp;&amp; ./book_store start"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  task <span class="symbol">:stop</span>, <span class="symbol">roles:</span> <span class="symbol">:web</span> <span class="keyword">do</span></span><br><span class="line">    run <span class="string">"cd <span class="subst">#&#123;current_path&#125;</span>/rel/book_store/bin &amp;&amp; ./book_store stop"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="步骤7:_创建production-rb">步骤7: 创建<code>production.rb</code></h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim config<span class="regexp">/deploy/</span>production.rb</span><br></pre></td></tr></table></figure>
<p>内容如下</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server <span class="string">"xx.xx.xx.xx"</span>, <span class="symbol">:app</span>, <span class="symbol">:web</span>, <span class="symbol">:db</span>, <span class="symbol">:primary</span> =&gt; <span class="keyword">true</span></span><br><span class="line">set <span class="symbol">:user</span>, <span class="string">'&lt;user&gt;'</span></span><br><span class="line">set <span class="symbol">:branch</span>, <span class="symbol">:master</span></span><br><span class="line">set <span class="symbol">:mix_env</span>, <span class="symbol">:prod</span></span><br><span class="line">set <span class="symbol">:deploy_to</span>, <span class="string">"/home/&lt;user&gt;/www/book_store"</span></span><br><span class="line">set <span class="symbol">:default_environment</span>, &#123;</span><br><span class="line">  <span class="string">'PATH'</span> =&gt; <span class="string">"$PATH:/home/app/src/elixir/bin"</span> <span class="comment"># --&gt; replace by path to your elixir bin folder</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>xx.xx.xx.xx</code>为服务器IP地址,  <code>&lt;user&gt;</code>为用户目录, 可以用同样的方法创建<code>staging.rb</code>文件用于<code>staging</code>环境.</p>
<h2 id="步骤8:_运行setup和deploy">步骤8: 运行setup和deploy</h2><p>为部署初始化目录结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cap</span> deploy:setup</span><br></pre></td></tr></table></figure>
<p>执行实际部署, 如果是第一次部署, 需要下载和安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cap</span> deploy</span><br></pre></td></tr></table></figure>
<h2 id="步骤9:_把Nginx作为反向代理">步骤9: 把Nginx作为反向代理</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Phoenix服务器地址和短裤</span></span><br><span class="line">upstream book_store &#123;</span><br><span class="line">  server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  <span class="keyword">listen</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">80</span>;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  try_files <span class="variable">$uri</span>/<span class="keyword">index</span>.html <span class="variable">$uri</span> <span class="variable">@book_store</span>;</span><br><span class="line">  location <span class="variable">@book_store</span> &#123;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="keyword">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">      proxy_pass http:<span class="regexp">//book</span>_store;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  error_page <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /<span class="number">500</span>.html;</span><br><span class="line">  access_log  /var/<span class="keyword">log</span>/nginx/book_store.<span class="keyword">log</span>;</span><br><span class="line">  error_log  /var/<span class="keyword">log</span>/nginx/book_store.<span class="keyword">log</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Phoenix的运行端口可以在配置文件<code>config/prod.exs</code>中修改</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:25:18.000Z"><a href="/2014/11/13/elixir-using-model-in-phoenix-console/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-using-model-in-phoenix-console/">在Phoenix控制台中使用模型</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="启动Phoenix控制台">启动Phoenix控制台</h2><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex -S <span class="built_in">mix</span></span><br></pre></td></tr></table></figure>
<h2 id="查询">查询</h2><p>查询Id为1的图书</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>(<span class="number">16</span>)&gt; <span class="tag">BookStore</span><span class="class">.Repo</span><span class="class">.get</span>(BookStore.Books, <span class="number">1</span>)</span><br><span class="line">%<span class="tag">BookStore</span><span class="class">.Books</span>&#123;<span class="attribute">author</span>: <span class="string">"Dave Thomas"</span>,</span><br><span class="line"> <span class="attribute">description</span>: <span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span>,</span><br><span class="line"> <span class="attribute">id</span>: <span class="number">1</span>, <span class="attribute">publisher</span>: <span class="string">"The Pragmatic Bookshelf"</span>, <span class="attribute">title</span>: <span class="string">"Programming Elixir"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>查询所有图书, 返回的是一个数组</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">17</span>)&gt; BookStore.Repo.all(BookStore.Books)</span><br><span class="line">[%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Dave Thomas"</span>,</span><br><span class="line"><span class="label">  description:</span> <span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span>,</span><br><span class="line"><span class="label">  id:</span> <span class="number">1</span>, <span class="string">publisher:</span> <span class="string">"The Pragmatic Bookshelf"</span>, <span class="string">title:</span> <span class="string">"Programming Elixir"</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>定义别名:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">alias</span> BookStore.Repo, <span class="keyword">as</span>: Repo</span><br><span class="line"><span class="type">alias</span> BookStore.Books, <span class="keyword">as</span>: Books</span><br></pre></td></tr></table></figure>
<p>如果没有<code>as:</code>部分, alias将使用模型名称的最后一部分作为别名</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">alias</span> BookStore.Repo</span><br><span class="line"><span class="type">alias</span> BookStore.Books</span><br></pre></td></tr></table></figure>
<p>使用别名查询</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; Repo.all(Books)</span><br><span class="line">[%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Dave Thomas"</span>,</span><br><span class="line"><span class="label"> description:</span> <span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span>,</span><br><span class="line"><span class="label">  id:</span> <span class="number">1</span>, <span class="string">publisher:</span> <span class="string">"The Pragmatic Bookshelf"</span>, <span class="string">title:</span> <span class="string">"Programming Elixir"</span>&#125;]</span><br><span class="line">iex&gt; Repo.get(Books, <span class="number">1</span>)</span><br><span class="line">%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Dave Thomas"</span>,</span><br><span class="line"><span class="label"> description:</span> <span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span>,</span><br><span class="line"><span class="label">  id:</span> <span class="number">1</span>, <span class="string">publisher:</span> <span class="string">"The Pragmatic Bookshelf"</span>, <span class="string">title:</span> <span class="string">"Programming Elixir"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>赋值给一个变量和访问模型字段</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">10</span>)&gt; book = Repo.get(Books, <span class="number">1</span>)</span><br><span class="line">%BookStore.Books&#123;author: <span class="string">"Dave Thomas"</span>,</span><br><span class="line"> description: <span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span>,</span><br><span class="line"> id: 1, publisher: <span class="string">"The Pragmatic Bookshelf"</span>, title: <span class="string">"Programming Elixir"</span>&#125;</span><br><span class="line">iex(11)&gt; book.author</span><br><span class="line"><span class="string">"Dave Thomas"</span></span><br><span class="line">iex(12)&gt; book.description</span><br><span class="line"><span class="string">"Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun"</span></span><br><span class="line">iex(13)&gt; book.id</span><br><span class="line">1</span><br><span class="line">iex(14)&gt; book.publisher</span><br><span class="line"><span class="string">"The Pragmatic Bookshelf"</span></span><br><span class="line">iex(15)&gt; book.title</span><br><span class="line"><span class="string">"Programming Elixir"</span></span><br></pre></td></tr></table></figure>
<h2 id="更新">更新</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iex&gt;  book = %&#123;book | <span class="string">description:</span> <span class="string">"Programming Elixir: a lot more fun"</span>, \</span><br><span class="line"><span class="label">                      title:</span> <span class="string">"Programming Elixir with fun"</span>&#125;</span><br><span class="line">%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Dave Thomas"</span>,</span><br><span class="line"><span class="label"> description:</span> <span class="string">"Programming Elixir: a lot more fun"</span>, <span class="string">id:</span> <span class="number">1</span>,</span><br><span class="line"><span class="label">  publisher:</span> <span class="string">"The Pragmatic Bookshelf"</span>, <span class="string">title:</span> <span class="string">"Programming Elixir with fun"</span>&#125;</span><br><span class="line">iex&gt; Repo.update(book)</span><br><span class="line">:ok</span><br><span class="line">iex&gt; Repo.get(Books, <span class="number">1</span>)</span><br><span class="line">%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Dave Thomas"</span>,</span><br><span class="line"><span class="label"> description:</span> <span class="string">"Programming Elixir: a lot more fun"</span>, <span class="string">id:</span> <span class="number">1</span>,</span><br><span class="line"><span class="label">  publisher:</span> <span class="string">"The Pragmatic Bookshelf"</span>, <span class="string">title:</span> <span class="string">"Programming Elixir with fun"</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="插入">插入</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="tag">Repo</span><span class="class">.insert</span>(%<span class="tag">Books</span><span class="rules">&#123;<span class="rule"><span class="attribute">author</span>:<span class="value"> <span class="string">"Simon St. Laurent, J. David Eisenberg"</span>, \</span><br><span class="line">                        description: <span class="string">"Elixir is an excellent language if you want to \</span><br><span class="line">                                      learn about functional programming, and with this hands-on \</span><br><span class="line">                                      introduction"</span>,</span><br><span class="line">                        publisher: <span class="string">"O'Reilly"</span>, title: <span class="string">"Introducing Elixir"</span></span></span></span>&#125;)</span><br><span class="line">%<span class="tag">BookStore</span><span class="class">.Books</span><span class="rules">&#123;<span class="rule"><span class="attribute">author</span>:<span class="value"> <span class="string">"Simon St. Laurent, J. David Eisenberg"</span>,</span><br><span class="line">                 description: <span class="string">"Elixir is an excellent language if you want to learn about \</span><br><span class="line">                               functional programming, and with this hands-on introduction"</span>, \</span><br><span class="line">                 id: <span class="number">18</span>, publisher: <span class="string">"O'Reilly"</span>, title: <span class="string">"Introducing Elixir"</span></span></span></span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="删除">删除</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; introducing_elixir_book = Repo.get(Books, <span class="number">2</span>)</span><br><span class="line">%BookStore.Books&#123;<span class="string">author:</span> <span class="string">"Simon St. Laurent, J. David Eisenberg"</span>,</span><br><span class="line"><span class="label"> description:</span> <span class="string">"Elixir is an excellent language if you want to learn \</span><br><span class="line">               about functional programming, and with this hands-on introduction"</span>,</span><br><span class="line"><span class="label">  id:</span> <span class="number">2</span>, <span class="string">publisher:</span> <span class="string">"O'Reilly"</span>, <span class="string">title:</span> <span class="string">"Introducing Elixir"</span>&#125;</span><br><span class="line">iex&gt; Repo.delete(introducing_elixir_book)</span><br><span class="line">:ok</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ol>
<li><a href="http://learnelixir.com/blog/2014/10/08/playing-with-model-in-elixir-phoenix-console/" target="_blank" rel="external">http://learnelixir.com/blog/2014/10/08/playing-with-model-in-elixir-phoenix-console/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T18:10:12.000Z"><a href="/2014/11/13/elixir-encoding/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-encoding/">编码问题</a></h1>
  

    </header>
    <div class="entry">
      


        


        <p><code>iex</code>进入Elixir Shell时出现提示</p>
<p><img src="/assets/images/CE4492B6-CDE2-4497-BBDD-B70D557E6DE7.png" alt="Elixir默认编码问题"></p>
<p>临时有效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=en_US.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>永久有效</p>
<figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">update-locale LANG</span>=<span class="string">en_US.UTF-8</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T17:19:52.000Z"><a href="/2014/11/13/elixir-book-listing-app-with-phoenix-postgresql-and-ecto/">2014-11-13</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/13/elixir-book-listing-app-with-phoenix-postgresql-and-ecto/">用Phoenix,Postgresql和Ecto创建一个书单应用</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#修订"><span class="toc-number">1.</span> <span class="toc-text">修订</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Phoenix"><span class="toc-number">2.</span> <span class="toc-text">安装Phoenix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建书单项目"><span class="toc-number">3.</span> <span class="toc-text">创建书单项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加依赖库"><span class="toc-number">4.</span> <span class="toc-text">添加依赖库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个仓库(Repo)"><span class="toc-number">5.</span> <span class="toc-text">创建一个仓库(Repo)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建模型"><span class="toc-number">6.</span> <span class="toc-text">创建模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建数据库移植脚本"><span class="toc-number">7.</span> <span class="toc-text">创建数据库移植脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建查询"><span class="toc-number">8.</span> <span class="toc-text">创建查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置路由"><span class="toc-number">9.</span> <span class="toc-text">配置路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建控制器"><span class="toc-number">10.</span> <span class="toc-text">创建控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建书单视图"><span class="toc-number">11.</span> <span class="toc-text">创建书单视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">12.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
        


        <p>本文通过一个书单应用简要介绍使用Phoenix框架创建一个Web应用程序的基本步骤. 从这些基本步骤我们来逐步学习如何使用phoenix框架开发一个Web应用程序的基本过程.</p>
<h2 id="修订">修订</h2><ul>
<li>2014-12-17<ul>
<li>Phoenix 从0.8.0开始 phoenix任务<code>phoenix.start</code>重命名为<code>phoenix.server</code></li>
<li>修改项目文件<code>mix.exs</code>的依赖版本号,更新依赖库<ul>
<li>ecto          0.2.0 -&gt; 0.2.8</li>
<li>postgrex      0.5.0 -&gt; 0.6.0</li>
<li>phoenix       0.5.0 -&gt; master</li>
</ul>
</li>
<li>增加命令注释说明</li>
</ul>
</li>
</ul>
<h2 id="安装Phoenix">安装Phoenix</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/phoenixframework/phoenix.git</span><br><span class="line"><span class="keyword">cd</span> phoenix</span><br><span class="line">mix <span class="keyword">do</span> deps.<span class="built_in">get</span>, compile</span><br></pre></td></tr></table></figure>
<h2 id="创建书单项目">创建书单项目</h2><p>在<code>phoenix</code>源代码目录中运行如下命令创建一个<code>phoenix</code>项目目录结构</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mix phoenix.new book<span class="emphasis">_store ../book_</span>store</span><br><span class="line"><span class="header">=== =========== ========== =============</span></span><br><span class="line">|         |            |              |</span><br><span class="line">命令     任务        项目名称    新创建的项目保存位置</span><br></pre></td></tr></table></figure>
<p>目录<code>../book_store</code>不必事先存在, <code>phoenix</code>会自动创建.</p>
<h2 id="添加依赖库">添加依赖库</h2><p>编辑<code>mix.exs</code>文件, 修改后如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">Mixfile </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Mix.Project</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">project</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">app:</span> <span class="symbol">:book_store</span>,</span><br><span class="line">     <span class="symbol">version:</span> <span class="string">"0.0.1"</span>,</span><br><span class="line">     <span class="symbol">elixir:</span> <span class="string">"~&gt; 1.0"</span>,</span><br><span class="line">     <span class="symbol">elixirc_paths:</span> [<span class="string">"lib"</span>, <span class="string">"web"</span>],</span><br><span class="line">     <span class="symbol">compilers:</span> [<span class="symbol">:phoenix</span>] ++ <span class="constant">Mix.</span>compilers,</span><br><span class="line">     <span class="symbol">deps:</span> deps]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># Configuration for the OTP application</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Type `mix help compile.app` for more information</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span> </span><span class="keyword">do</span></span><br><span class="line">    [<span class="symbol">mod:</span> &#123;<span class="constant">BookStore,</span> []&#125;,</span><br><span class="line">     <span class="symbol">applications:</span> [<span class="symbol">:phoenix</span>, <span class="symbol">:cowboy</span>, <span class="symbol">:logger</span>, <span class="symbol">:postgrex</span>, <span class="symbol">:ecto</span>]]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># Specifies your project dependencies</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Type `mix help deps` for examples and options</span></span><br><span class="line">  defp deps <span class="keyword">do</span></span><br><span class="line">    [ &#123;<span class="symbol">:phoenix</span>, <span class="symbol">github:</span> <span class="string">"phoenixframework/phoenix"</span>&#125;,</span><br><span class="line">      &#123;<span class="symbol">:cowboy</span>, <span class="string">"~&gt; 1.0"</span>&#125;,</span><br><span class="line">      &#123;<span class="symbol">:postgrex</span>, <span class="string">"~&gt; 0.6.0"</span>&#125;,</span><br><span class="line">      &#123;<span class="symbol">:ecto</span>, <span class="string">"~&gt; 0.2.8"</span>&#125; ]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>和修改之前的<code>mix.exs</code>文件相比有两个变更处:</p>
<ul>
<li>在<code>application</code>函数中增加了两个依赖的应用程序 <code>:postgres</code> 和 <code>:ecto</code> (16行)</li>
<li>在<code>deps</code>函数增加两个依赖库<code>{:postgrex, &quot;~&gt; 0.6.0&quot;}</code>和<code>{:ecto, &quot;~&gt; 0.2.8&quot;}</code>(24,25行)</li>
</ul>
<p>运行</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix <span class="keyword">do</span> deps.<span class="keyword">get</span>, compile</span><br></pre></td></tr></table></figure>
<h2 id="创建一个仓库(Repo)">创建一个仓库(Repo)</h2><p>创建文件<code>web/models/repo.ex</code>,内容如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">Repo </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Ecto.Repo,</span> <span class="symbol">adapter:</span> <span class="constant">Ecto.Adapters.Postgres</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">conf</span> </span><span class="keyword">do</span></span><br><span class="line">    parse_url <span class="string">"ecto://postgres:postgres@localhost/book_store"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">priv</span> </span><span class="keyword">do</span></span><br><span class="line">    app_dir(<span class="symbol">:book_store</span>, <span class="string">"priv/repo"</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>创建数据库:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createdb book_store -U postgres --encoding='utf-<span class="number">8</span>' --locale=en_US.<span class="type">UTF</span>-<span class="number">8</span> --<span class="keyword">template</span>=template0</span><br></pre></td></tr></table></figure>
<p>修改<code>lib/book_store.ex</code>为, 如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span> </span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Application</span></span><br><span class="line">  <span class="comment"># See http://elixir-lang.org/docs/stable/elixir/Application.html</span></span><br><span class="line">  <span class="comment"># for more information on OTP Applications</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="constant">_type,</span> <span class="constant">_args)</span> </span><span class="keyword">do</span></span><br><span class="line">    import <span class="constant">Supervisor.Spec,</span> <span class="symbol">warn:</span> <span class="keyword">false</span></span><br><span class="line">    children = [</span><br><span class="line">      <span class="comment"># Define workers and child supervisors to be supervised</span></span><br><span class="line">      worker(<span class="constant">BookStore.Repo,</span> [])</span><br><span class="line">    ]</span><br><span class="line">    opts = [<span class="symbol">strategy:</span> <span class="symbol">:one_for_one</span>, <span class="symbol">name:</span> <span class="constant">BookStore.Supervisor]</span></span><br><span class="line">    <span class="constant">Supervisor.</span>start_link(children, opts)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mix</span> compile</span><br></pre></td></tr></table></figure>
<h2 id="创建模型">创建模型</h2><p>创建文件<code>web/models/books.ex</code>, 内容如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">Books </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Ecto.Model</span></span><br><span class="line">  schema <span class="string">"books"</span> <span class="keyword">do</span></span><br><span class="line">    field <span class="symbol">:title</span>, <span class="symbol">:string</span></span><br><span class="line">    field <span class="symbol">:description</span>, <span class="symbol">:string</span></span><br><span class="line">    field <span class="symbol">:author</span>, <span class="symbol">:string</span></span><br><span class="line">    field <span class="symbol">:publisher</span>, <span class="symbol">:string</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="创建数据库移植脚本">创建数据库移植脚本</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mix ecto.<span class="keyword">gen</span>.migration Bookstore.Repo create_book</span><br><span class="line">Compiled web/models/books.<span class="keyword">ex</span></span><br><span class="line">Generated bookstore.<span class="keyword">app</span></span><br><span class="line"><span class="comment">* creating priv/repo/migrations</span></span><br><span class="line"><span class="comment">* creating priv/repo/migrations/20141112170140_create_book.exs</span></span><br></pre></td></tr></table></figure>
<p>编辑生成的<code>priv/repo/migrations/20141112170140_create_book.exs</code>脚本, 内容如下:</p>
<pre><code><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">Repo.Migrations.CreateBook </span></span><span class="keyword">do</span>
  <span class="keyword">use</span> <span class="constant">Ecto.Migration</span>

  <span class="function"><span class="keyword">def</span> <span class="title">up</span> </span><span class="keyword">do</span>
    [<span class="string">"CREATE TABLE books(\
        id serial primary key, \
        title varchar(125), \
        description text, \
        author varchar(255), \
        publisher varchar(255))"</span>,\

     <span class="string">"INSERT INTO books(title, description, author, publisher) \
             VALUES ( \
                'Programming Elixir', \
                'Programming Elixir: Functional |&gt; Concurrent |&gt; Pragmatic |&gt; Fun', \
                'Dave Thomas', \
                'The Pragmatic Bookshelf')"</span>
    ]
  <span class="keyword">end</span>
  <span class="function"><span class="keyword">def</span> <span class="title">down</span> </span><span class="keyword">do</span>
    <span class="string">"DROP TABLE books"</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre><p>运行移植脚本</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix ecto<span class="class">.migrate</span> BookStore.Repo</span><br></pre></td></tr></table></figure>
<h2 id="创建查询">创建查询</h2><p>创建文件<code>web/models/queries.ex</code>, 内容如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Queries <span class="operator"><span class="keyword">do</span></span><br><span class="line">  import Ecto.<span class="keyword">Query</span></span><br><span class="line">  def books_query <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">query</span> = <span class="keyword">from</span> book <span class="keyword">in</span> BookStore.Books,</span><br><span class="line">            <span class="keyword">select</span>: book</span><br><span class="line">    BookStore.Repo.<span class="keyword">all</span>(<span class="keyword">query</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<h2 id="配置路由">配置路由</h2><p>打开文件<code>web/router.ex</code>, 修改为如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defmodule BookStore.Router <span class="operator"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> Phoenix.Router</span><br><span class="line">  scope <span class="string">"/"</span> <span class="keyword">do</span></span><br><span class="line">    # <span class="keyword">Use</span> the <span class="keyword">default</span> browser stack.</span><br><span class="line">    pipe_through :browser</span><br><span class="line">    #<span class="keyword">get</span> <span class="string">"/"</span>, BookStore.PageController, :<span class="keyword">index</span>, <span class="keyword">as</span>: :pages</span><br><span class="line">    <span class="keyword">get</span> <span class="string">"/"</span>, BookStore.BookController, :<span class="keyword">index</span>, <span class="keyword">as</span>: :books</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  # Other scopes may <span class="keyword">use</span> custom stacks.</span><br><span class="line">  # scope <span class="string">"/api"</span> <span class="keyword">do</span></span><br><span class="line">  #   pipe_through :api</span><br><span class="line">  # <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<h2 id="创建控制器">创建控制器</h2><p>创建文件<code>web/controllers/book_controller.ex</code>, 内容如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">BookController </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">Phoenix.Controller</span></span><br><span class="line">  plug <span class="symbol">:action</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index</span>(conn, <span class="constant">_params)</span> </span><span class="keyword">do</span></span><br><span class="line">    books = <span class="constant">BookStore.Queries.</span>books_query</span><br><span class="line">    render conn, <span class="string">"index"</span>, <span class="symbol">books:</span> books</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="创建书单视图">创建书单视图</h2><p>创建文件<code>web/views/book_view.ex</code>, 内容如下:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">BookStore</span>.<span class="constant">BookView </span></span><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="constant">BookStore.Views</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>创建目录</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> web/templates/book</span><br></pre></td></tr></table></figure>
<p>并添加文件<code>web/templates/book/index.html.eex</code>, 内容如下:</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>我的图书<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">table</span> <span class="attribute">class</span>=<span class="value">'table table-bodered table-striped'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">th</span>&gt;</span>#<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">th</span>&gt;</span>标题<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">th</span>&gt;</span>描述<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">th</span>&gt;</span>作者<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">th</span>&gt;</span>出版社<span class="tag">&lt;/<span class="title">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">thead</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">tbody</span>&gt;</span></span><br><span class="line">    </span>&lt;%=<span class="ruby"> <span class="keyword">for</span> book &lt;- <span class="variable">@books</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line">      <span class="tag">&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">td</span>&gt;</span></span>&lt;%=<span class="ruby"> book.id </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">td</span>&gt;</span></span>&lt;%=<span class="ruby"> book.title </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">td</span>&gt;</span></span>&lt;%=<span class="ruby"> book.description </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">td</span>&gt;</span></span>&lt;%=<span class="ruby"> book.author </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">td</span>&gt;</span></span>&lt;%=<span class="ruby"> book.publisher </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line">    </span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>启动应用,并刷新页面</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phoenix.<span class="built_in">start</span></span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/FF5CA944-C022-42A0-8F33-7FF6F01EBD38.png" alt="我的书单应用"></p>
<p>完成!</p>
<h2 id="参考资料">参考资料</h2><ol>
<li>Book Listing App With Elixir, Phoenix, Postgres and Ecto<br><a href="http://learnelixir.com/blog/2014/10/05/build-web-app-with-elixir/" target="_blank" rel="external">http://learnelixir.com/blog/2014/10/05/build-web-app-with-elixir/</a></li>
</ol>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-12T02:46:12.000Z"><a href="/2014/11/12/postgresql-install-configuration/">2014-11-12</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/12/postgresql-install-configuration/">PostgreSQL Ubuntu上的安装和配置</a></h1>
  

    </header>
    <div class="entry">
      


        
        <div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-number">2.</span> <span class="toc-text">配置</span></a></li></ol>
        </div>
        


        <h2 id="安装">安装</h2><p>执行如下命令安装PostgreSQL Server</p>
<pre><code><span class="comment"><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="keyword">get</span> install -y postgresql</span><br></pre></td></tr></table></figure></span>
</code></pre><h2 id="配置">配置</h2><ul>
<li><p>让其他计算机可以连接到Postgresql Server</p>
<p>  编辑文件 <code>vi /etc/postgresql/9.3/main/postgresql.conf</code>, 定位到<code>#listen_addresses = &#39;localhost&#39;</code>, 去掉注释,并修改为:</p>
  <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">listen_addresses</span> = <span class="string">'*'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务器</p>
<pre><code><span class="regexp">/etc/i</span>nit.d<span class="regexp">/postgresql restart</span>
</code></pre></li>
<li><p>登录服务器并修改密码</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 登录</span><br><span class="line">sudo -u postgres psql template1</span><br><span class="line"># 修改密码</span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres <span class="keyword">with</span> encrypted <span class="keyword">password</span> <span class="string">'postgres'</span>;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改登录认证</p>
<p>  编辑<code>vi /etc/postgresql/9.3/main/pg_hba.conf</code>, 添加如下行:</p>
  <figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span>   <span class="literal">all</span>         postgres                          md5</span><br></pre></td></tr></table></figure>
<p>  再次重启:</p>
  <figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service</span> postgresql <span class="literal">restart</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装命令行客户端和登录验证</p>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install postgresql-client</span><br><span class="line">psql -<span class="keyword">h</span> localhost -<span class="keyword">U</span> postgres -<span class="literal">W</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-10T14:39:17.000Z"><a href="/2014/11/10/elixir-quote-and-unquote/">2014-11-10</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/10/elixir-quote-and-unquote/">元编程Quote和Unquote</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="概念介绍">概念介绍</h2><ul>
<li>Elixir中的AST是什么?<ul>
<li>是一个Elixir Term</li>
<li>是深度嵌套的一种表示Elixir代码结构的方法</li>
</ul>
</li>
<li><p>如何理解?</p>
  <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">1</span>)&gt; quoted = <span class="keyword">quote</span> <span class="keyword">do</span> <span class="number">1</span> + <span class="number">2</span> <span class="keyword">end</span></span><br><span class="line">&#123;<span class="symbol">:+</span>, [<span class="symbol">context:</span> <span class="constant">Elixir,</span> <span class="symbol">import:</span> <span class="constant">Kernel]</span>, [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>  quote用于把一个Elixir表达式转换为Elixir的AST片段</p>
</li>
<li>抽象语法树片段(AST Fragment)</li>
</ul>
<p>才接触Quote和Unquote的时候会让人迷惑. 当你很好的理解了它后, 却是非常好用的.</p>
<!--
一个典型的应用场景就是自动化的生成代码, 用于处理系统中高度重复性的工作
- 数据库模型对象的生成
依据数据库的定义可以自动化的生成模型对象
-->
<h2 id="Quote">Quote</h2><p>Quote是一个Elixir函数,用于把一个Elixir表达式转换为AST(抽象语法树). AST是一种编译器的内部表示,用于对表达式进行求值, 比如:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="tag">quote</span> <span class="tag">do</span>: <span class="tag">1</span> + <span class="tag">2</span></span><br><span class="line">&#123;:+, <span class="attr_selector">[context: Elixir, import: Kernel]</span>, <span class="attr_selector">[1, 2]</span>&#125;</span><br></pre></td></tr></table></figure>
<p>表达式<code>1 + 2</code>在Elixir编译器中被表示为一个有三个元素的元组:</p>
<ul>
<li>操作符 (<code>:+</code>)</li>
<li>关键字列表元数据(<code>[context: Elixir, import: Kernel]</code>)</li>
<li>参数列表 (<code>[1, 2]</code>)</li>
</ul>
<p>如果不考虑关键字列表元数据, 其可以表示为一棵抽象语法树, 以操作符为根节点, 2个参数为树叶</p>
<p><img src="/assets/images/ast1.png" alt="表达式1 + 2的抽象语法树"></p>
<p>再如, 一个稍微复杂一点的表达式<code>1 + 2 * 3</code>, 将生成一个更加复杂的抽象语法树</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; quote <span class="string">do:</span> <span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span></span><br><span class="line">&#123;:+, [<span class="string">context:</span> Elixir, <span class="string">import:</span> Kernel],[<span class="number">1</span>, &#123;:*, [<span class="string">context:</span> Elixir, <span class="string">import:</span> Kernel], [<span class="number">2</span>, <span class="number">3</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/ast2.png" alt="表达式1 + 2 * 3的抽象语法树"></p>
<p>当对表达式求值的时候, Elixir编译器将会从最左边的叶子节点开始遍历. 例如,该AST会求值为: <code>1 + (2 * 3)</code></p>
<p>为了对Quote表达式求值, 需要使用<code>Code.eval_quoted</code>函数, 例如:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; Code.eval_quoted(<span class="constant">quote</span> <span class="built_in">do</span>: <span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span>)</span><br><span class="line">&#123;<span class="number">7</span>, []&#125;</span><br></pre></td></tr></table></figure>
<p><code>Code.eval_quoted</code>函数调用返回一个最终求得的值和一个从求值表达式产生的所有变量列表. 上述求得的值为7, 因为没有变量绑定, 所以返回一个空的列表.</p>
<p>Quote还可以用于函数调用, 比如:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">iex</span>&gt; <span class="tag">quote</span> <span class="tag">do</span>: <span class="tag">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&#123;<span class="pseudo">:sum</span>, <span class="attr_selector">[]</span>, <span class="attr_selector">[1, 2, 3]</span>&#125;</span><br></pre></td></tr></table></figure>
<p>Quote function is like a function which is used to put an expression between a quote so that it can be used later on.</p>
<p>Next let’s try to define some variables and use those in quote body:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="operator">a</span> = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">iex&gt; b = <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">iex&gt; Code.eval_quoted(<span class="constant">quote</span> <span class="built_in">do</span>: <span class="operator">a</span> + b)</span><br><span class="line">** (CompileError) nofile:<span class="number">1</span>: undefined <span class="function"><span class="keyword">function</span> <span class="title">a</span>/<span class="title">0</span></span></span><br></pre></td></tr></table></figure>
<p>The <code>eval_quoted</code> function call will give you an error on undefined function a. This happens because when<br><code>Code.eval_quoted</code> is called, it does not know any <code>a</code> value, because the a here is not the same variable<br>that we defined outside ealier. In order to refer a variable defined outside quote, unquote function needs to be used</p>
<h2 id="Unquote">Unquote</h2><p>So here, how it should be written if a variable is referred to outside of the scope of quote:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="operator">a</span> = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">iex&gt; b = <span class="number">2</span></span><br><span class="line">b</span><br><span class="line">iex&gt; <span class="constant">quote</span> <span class="built_in">do</span>: unquote(<span class="operator">a</span>) + unquote(b)</span><br><span class="line">&#123;:+, [context: Elixir, import: Kernel], [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, the value of a and b are now evaluated correctly before Elixir construct the abstract syntax tree and<br>these values are actually computed at compiled time and not runtime. Now, let say, we define a function:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; <span class="operator">a</span> = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">iex&gt; b = <span class="number">2</span></span><br><span class="line">b</span><br><span class="line">iex&gt; fun = fn -&gt; <span class="constant">quote</span> <span class="built_in">do</span></span><br><span class="line">   unquote(<span class="operator">a</span>) + unquote(b)</span><br><span class="line">  <span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br><span class="line">&#123;:+, [context: Elixir, import: Kernel], [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>Now we try to change a value and call the function again to see if the presentation will change with the new a value:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; a = <span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line">iex&gt; fun.<span class="keyword">call</span>()</span><br><span class="line">&#123;:+, [context: Elixir, <span class="keyword">import</span>: Kernel], [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, although a’s value is change but the funtioncal representing <code>a + b</code> is still reflecting the original<br>value of a and b. The way that we use quote and unquote in Elixir can be very creative and dynamic, for instance, we<br>can define like following to play with the real function definition at runtime.</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; num1 = <span class="number">5</span></span><br><span class="line">iex&gt; num2 = <span class="number">2</span></span><br><span class="line">iex&gt; perform = <span class="keyword">fn</span> <span class="keyword">fun</span> -&gt; <span class="type">Code</span>.eval_quoted(quote <span class="keyword">do</span>: unquote(<span class="keyword">fun</span>)(unquote(num1), unquote(num2))) <span class="keyword">end</span></span><br><span class="line">iex&gt; perform.(:rem) # calculate remaining <span class="keyword">of</span> <span class="number">5</span> <span class="keyword">and</span> <span class="number">2</span></span><br><span class="line">&#123;<span class="number">1</span>, <span class="literal">[]</span>&#125;</span><br><span class="line">iex&gt; perform.(:div) # calculate division result <span class="keyword">of</span> <span class="number">5</span> <span class="keyword">and</span> <span class="number">2</span></span><br><span class="line">&#123;<span class="number">2</span>, <span class="literal">[]</span>&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <!--<div class="icon"></div>-->
        <time datetime="2014-11-10T11:56:02.000Z"><a href="/2014/11/10/elixir-anonymous-function/">2014-11-10</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/10/elixir-anonymous-function/">匿名函数</a></h1>
  

    </header>
    <div class="entry">
      


        


        <h2 id="快速定义">快速定义</h2><p>进入Elixir Shell输入:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">1</span>)&gt; <span class="built_in">sum</span> = fn <span class="operator">a</span>, b -&gt; <span class="operator">a</span> + b <span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="comment">#Function&lt;12.90072148/2 in :erl_eval.expr/5&gt;</span></span><br></pre></td></tr></table></figure>
<p>匿名函数的定义以关键字<code>fn</code>开始, 然后紧跟参数列表, 再接符号<code>-&gt;</code>, 其后为函数体, 并以关键字<code>end</code>结束匿名函数的定义</p>
<p>要调用匿名函数,需要使用<code>dot</code>(点)语法.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">iex</span><span class="params">(<span class="number">2</span>)</span></span>&gt; sum.(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="匿名函数作为参数">匿名函数作为参数</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">defmodule MyList <span class="built_in">do</span></span><br><span class="line">    def <span class="built_in">filter</span>([], <span class="title">_func</span>) <span class="built_in">do</span></span><br><span class="line">        []</span><br><span class="line">    <span class="function"><span class="keyword">end</span></span></span><br><span class="line">    def <span class="built_in">filter</span>([head|tail], func) <span class="built_in">do</span></span><br><span class="line">        <span class="keyword">if</span> func.(head) <span class="built_in">do</span></span><br><span class="line">            [head | <span class="built_in">filter</span>(tail, func)]</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">filter</span>(tail, func)</span><br><span class="line">        <span class="function"><span class="keyword">end</span></span></span><br><span class="line">    <span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="comment">## 奇数</span></span><br><span class="line">MyList.<span class="built_in">filter</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], fn <span class="built_in">num</span> -&gt; rem(<span class="built_in">num</span>,<span class="number">2</span>) == <span class="number">1</span> <span class="function"><span class="keyword">end</span>)</span></span><br></pre></td></tr></table></figure>
<p>控制台输出:</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">5</span>)&gt; MyList.filter([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], fn num -&gt; <span class="comment">rem(num,2) == 1 end)</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<h2 id="匿名函数简写">匿名函数简写</h2><p>我们可以把匿名函数<code>fn n -&gt; rem(n, 2) == 1 end</code>简写为<code>&amp;(rem(&amp;1, 2) == 1)</code></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span> = fn <span class="operator">a</span>, b -&gt; <span class="operator">a</span> + b <span class="function"><span class="keyword">end</span></span></span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line"><span class="built_in">sum</span> = &amp;(&amp;<span class="number">1</span> + &amp;<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>其中第一个<code>&amp;</code>表示匿名函数本身<code>&amp;1</code>表示匿名函数的第一个参数, <code>&amp;2</code>表示匿名函数的第二个参数, 以此类推. 小括号内为函数体表达式.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
    <a href="/page/2/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/4/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div>
    </div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/03/18/angular-if-else-statement-in-template/">AngularJS中的If..Else语句</a>
      </li>
    
      <li>
        <a href="/2015/03/18/continuous-deployment-of-node-js-applications/">Nodejs应用程序持续部署</a>
      </li>
    
      <li>
        <a href="/2015/03/17/erlang-pooler/">Erlang Pooler</a>
      </li>
    
      <li>
        <a href="/2015/03/17/ejabberd-easy-installer-and-structure-for-ejabberd-contributed-modules/">Ejabberd模块安装工具</a>
      </li>
    
      <li>
        <a href="/2015/03/13/ejabberd-howto-20150312/">Ejabberd Howto 20150312 &lt;TODO LIST&gt;</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-performance-turning/">Ejabberd 性能调优(草稿)</a>
      </li>
    
      <li>
        <a href="/2015/03/12/ejabberd-benchmark-with-tsung/">使用Tsung对Ejabberd进行性能测试</a>
      </li>
    
      <li>
        <a href="/2015/03/11/thrift-ex/">thrift_ex</a>
      </li>
    
      <li>
        <a href="/2015/02/26/ejabberd-joins-the-elixir-revolution/">(译) Ejabberd加入了Elixir的变革</a>
      </li>
    
      <li>
        <a href="/2015/02/25/http2-h2o-get-started/">HTTP/2 尝鲜</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/AD/">AD</a><small>2</small></li>
  
    <li><a href="/categories/API/">API</a><small>3</small></li>
  
    <li><a href="/categories/Continuous-Deployment/">Continuous Deployment</a><small>1</small></li>
  
    <li><a href="/categories/Database/">Database</a><small>1</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>9</small></li>
  
    <li><a href="/categories/Ejabberd/">Ejabberd</a><small>32</small></li>
  
    <li><a href="/categories/Elixir/">Elixir</a><small>42</small></li>
  
    <li><a href="/categories/Erlang/">Erlang</a><small>20</small></li>
  
    <li><a href="/categories/HTTP2/">HTTP2</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>14</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/Node-js/">Node.js</a><small>17</small></li>
  
    <li><a href="/categories/Opencart/">Opencart</a><small>2</small></li>
  
    <li><a href="/categories/QA/">QA</a><small>2</small></li>
  
    <li><a href="/categories/RESTFul/">RESTFul</a><small>1</small></li>
  
    <li><a href="/categories/SCM/">SCM</a><small>5</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Tools/">Tools</a><small>4</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>6</small></li>
  
    <li><a href="/categories/XEP/">XEP</a><small>5</small></li>
  
    <li><a href="/categories/XMPP/">XMPP</a><small>6</small></li>
  
    <li><a href="/categories/english/">english</a><small>1</small></li>
  
    <li><a href="/categories/杂类/">杂类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget duoshuo_recent_comments">
    <h3 class="title">最新评论</h3>
    <ul class="entry ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-title="1" data-show-time="1"></ul>
</div>
<!--多说js加载开始，一个页面只需要加载一次 -->
<script type="text/javascript">
    var duoshuoQuery = {short_name: "developerworks"};
    (function () {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!--多说js加载结束，一个页面只需要加载一次 -->


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/AD/" style="font-size: 10px;">AD</a><a href="/tags/API/" style="font-size: 11px;">API</a><a href="/tags/Analysis/" style="font-size: 10px;">Analysis</a><a href="/tags/Behaviour/" style="font-size: 10px;">Behaviour</a><a href="/tags/CUPS/" style="font-size: 10px;">CUPS</a><a href="/tags/CURL/" style="font-size: 10px;">CURL</a><a href="/tags/Clustering/" style="font-size: 10px;">Clustering</a><a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a><a href="/tags/Distributed-Application/" style="font-size: 10px;">Distributed Application</a><a href="/tags/ETS/" style="font-size: 10px;">ETS</a><a href="/tags/Ecto/" style="font-size: 11px;">Ecto</a><a href="/tags/Elixir/" style="font-size: 20px;">Elixir</a><a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a><a href="/tags/Escalus/" style="font-size: 10px;">Escalus</a><a href="/tags/ExUnit/" style="font-size: 10px;">ExUnit</a><a href="/tags/Exrm/" style="font-size: 10px;">Exrm</a><a href="/tags/H2O/" style="font-size: 10px;">H2O</a><a href="/tags/Hex-pm/" style="font-size: 10px;">Hex.pm</a><a href="/tags/HiPE/" style="font-size: 10px;">HiPE</a><a href="/tags/Howto/" style="font-size: 10px;">Howto</a><a href="/tags/Httpotion/" style="font-size: 10px;">Httpotion</a><a href="/tags/I18n/" style="font-size: 10px;">I18n</a><a href="/tags/IAB/" style="font-size: 10px;">IAB</a><a href="/tags/ID3/" style="font-size: 10px;">ID3</a><a href="/tags/IO/" style="font-size: 10px;">IO</a><a href="/tags/IOT/" style="font-size: 10px;">IOT</a><a href="/tags/IoT/" style="font-size: 10px;">IoT</a><a href="/tags/Loopback/" style="font-size: 12px;">Loopback</a><a href="/tags/MUC/" style="font-size: 10px;">MUC</a><a href="/tags/Macro/" style="font-size: 12px;">Macro</a><a href="/tags/Memcache/" style="font-size: 10px;">Memcache</a><a href="/tags/Mix/" style="font-size: 14px;">Mix</a><a href="/tags/Modules/" style="font-size: 10px;">Modules</a><a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a><a href="/tags/OSM-Building/" style="font-size: 10px;">OSM Building</a><a href="/tags/OTP/" style="font-size: 12px;">OTP</a><a href="/tags/OpenStreetMap/" style="font-size: 10px;">OpenStreetMap</a><a href="/tags/PM2/" style="font-size: 10px;">PM2</a><a href="/tags/Performance/" style="font-size: 10px;">Performance</a><a href="/tags/Phoenix/" style="font-size: 12px;">Phoenix</a><a href="/tags/Pool/" style="font-size: 10px;">Pool</a><a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a><a href="/tags/RESTFUL/" style="font-size: 11px;">RESTFUL</a><a href="/tags/RMAL/" style="font-size: 10px;">RMAL</a><a href="/tags/Ranch/" style="font-size: 10px;">Ranch</a><a href="/tags/RefactorErl/" style="font-size: 10px;">RefactorErl</a><a href="/tags/Regex/" style="font-size: 10px;">Regex</a><a href="/tags/Resource-Pool/" style="font-size: 10px;">Resource Pool</a><a href="/tags/SSH/" style="font-size: 10px;">SSH</a><a href="/tags/SSL/" style="font-size: 10px;">SSL</a><a href="/tags/SemVer/" style="font-size: 10px;">SemVer</a><a href="/tags/Semantic-UI/" style="font-size: 10px;">Semantic UI</a><a href="/tags/Sequelize/" style="font-size: 10px;">Sequelize</a><a href="/tags/Stream-Management/" style="font-size: 10px;">Stream Management</a><a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a><a href="/tags/Task/" style="font-size: 10px;">Task</a><a href="/tags/Thrift/" style="font-size: 10px;">Thrift</a><a href="/tags/Tsung/" style="font-size: 10px;">Tsung</a><a href="/tags/UBF/" style="font-size: 10px;">UBF</a><a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a><a href="/tags/Umbrella/" style="font-size: 10px;">Umbrella</a><a href="/tags/VAST/" style="font-size: 10px;">VAST</a><a href="/tags/VPAID/" style="font-size: 10px;">VPAID</a><a href="/tags/XEP/" style="font-size: 15px;">XEP</a><a href="/tags/XEP-198/" style="font-size: 10px;">XEP-198</a><a href="/tags/XML/" style="font-size: 10px;">XML</a><a href="/tags/XMPP/" style="font-size: 18px;">XMPP</a><a href="/tags/android/" style="font-size: 10px;">android</a><a href="/tags/angular/" style="font-size: 17px;">angular</a><a href="/tags/application/" style="font-size: 10px;">application</a><a href="/tags/blockies/" style="font-size: 10px;">blockies</a><a href="/tags/bootstrap3/" style="font-size: 10px;">bootstrap3</a><a href="/tags/bosh/" style="font-size: 12px;">bosh</a><a href="/tags/ci/" style="font-size: 10px;">ci</a><a href="/tags/container/" style="font-size: 11px;">container</a><a href="/tags/data-management/" style="font-size: 10px;">data management</a><a href="/tags/data-volume/" style="font-size: 10px;">data volume</a><a href="/tags/debugging/" style="font-size: 10px;">debugging</a><a href="/tags/devtools/" style="font-size: 10px;">devtools</a><a href="/tags/devtools-terminal/" style="font-size: 10px;">devtools-terminal</a><a href="/tags/doc/" style="font-size: 10px;">doc</a><a href="/tags/docker/" style="font-size: 16px;">docker</a><a href="/tags/ejabberd/" style="font-size: 19px;">ejabberd</a><a href="/tags/ejabberd-c2s/" style="font-size: 10px;">ejabberd_c2s</a><a href="/tags/emysql/" style="font-size: 11px;">emysql</a><a href="/tags/encoding/" style="font-size: 10px;">encoding</a><a href="/tags/erlang/" style="font-size: 12px;">erlang</a><a href="/tags/erlang-mk/" style="font-size: 10px;">erlang.mk</a><a href="/tags/faq/" style="font-size: 10px;">faq</a><a href="/tags/gen-tcp/" style="font-size: 10px;">gen_tcp</a><a href="/tags/gerrit/" style="font-size: 11px;">gerrit</a><a href="/tags/gettext/" style="font-size: 10px;">gettext</a><a href="/tags/git/" style="font-size: 12px;">git</a><a href="/tags/graphviz/" style="font-size: 10px;">graphviz</a><a href="/tags/grunt/" style="font-size: 10px;">grunt</a><a href="/tags/hero/" style="font-size: 10px;">hero</a><a href="/tags/html/" style="font-size: 10px;">html</a><a href="/tags/html5/" style="font-size: 10px;">html5</a><a href="/tags/iconutil/" style="font-size: 10px;">iconutil</a><a href="/tags/iq/" style="font-size: 10px;">iq</a><a href="/tags/jabber/" style="font-size: 10px;">jabber</a><a href="/tags/javascript/" style="font-size: 11px;">javascript</a><a href="/tags/jiffy/" style="font-size: 10px;">jiffy</a><a href="/tags/json-schema/" style="font-size: 10px;">json-schema</a><a href="/tags/library/" style="font-size: 10px;">library</a><a href="/tags/linking/" style="font-size: 10px;">linking</a><a href="/tags/lists/" style="font-size: 10px;">lists</a><a href="/tags/load-balance/" style="font-size: 10px;">load balance</a><a href="/tags/log4er/" style="font-size: 10px;">log4er</a><a href="/tags/manage-images/" style="font-size: 10px;">manage images</a><a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a><a href="/tags/muc/" style="font-size: 10px;">muc</a><a href="/tags/mysql/" style="font-size: 10px;">mysql</a><a href="/tags/node-reggie/" style="font-size: 10px;">node-reggie</a><a href="/tags/node-webkit/" style="font-size: 13px;">node-webkit</a><a href="/tags/node-js/" style="font-size: 12px;">node.js</a><a href="/tags/nodemailer/" style="font-size: 10px;">nodemailer</a><a href="/tags/notification/" style="font-size: 10px;">notification</a><a href="/tags/npm/" style="font-size: 11px;">npm</a><a href="/tags/performance/" style="font-size: 10px;">performance</a><a href="/tags/ploymer/" style="font-size: 10px;">ploymer</a><a href="/tags/polymer/" style="font-size: 10px;">polymer</a><a href="/tags/port/" style="font-size: 10px;">port</a><a href="/tags/pubsub/" style="font-size: 10px;">pubsub</a><a href="/tags/rebar/" style="font-size: 10px;">rebar</a><a href="/tags/record/" style="font-size: 10px;">record</a><a href="/tags/recursion/" style="font-size: 10px;">recursion</a><a href="/tags/regexp/" style="font-size: 10px;">regexp</a><a href="/tags/relx/" style="font-size: 10px;">relx</a><a href="/tags/screen/" style="font-size: 10px;">screen</a><a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a><a href="/tags/shell/" style="font-size: 10px;">shell</a><a href="/tags/socket/" style="font-size: 10px;">socket</a><a href="/tags/ssh/" style="font-size: 10px;">ssh</a><a href="/tags/stanza/" style="font-size: 10px;">stanza</a><a href="/tags/strophe-js/" style="font-size: 10px;">strophe.js</a><a href="/tags/strophejs/" style="font-size: 10px;">strophejs</a><a href="/tags/svg-sprite/" style="font-size: 10px;">svg-sprite</a><a href="/tags/swagger/" style="font-size: 12px;">swagger</a><a href="/tags/testing/" style="font-size: 10px;">testing</a><a href="/tags/tls/" style="font-size: 10px;">tls</a><a href="/tags/tools/" style="font-size: 10px;">tools</a><a href="/tags/tsung/" style="font-size: 10px;">tsung</a><a href="/tags/upstart/" style="font-size: 10px;">upstart</a><a href="/tags/vQmod/" style="font-size: 10px;">vQmod</a><a href="/tags/varnish/" style="font-size: 10px;">varnish</a><a href="/tags/vqmod/" style="font-size: 10px;">vqmod</a><a href="/tags/vt/" style="font-size: 10px;">vt</a><a href="/tags/win32reg/" style="font-size: 10px;">win32reg</a><a href="/tags/xml-schema/" style="font-size: 10px;">xml schema</a><a href="/tags/匆匆那年/" style="font-size: 10px;">匆匆那年</a><a href="/tags/协议包/" style="font-size: 10px;">协议包</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
</div>
<footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 zhiqiang he
  
</div>
<div class="clearfix"></div></footer>

<!--<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>-->
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<!--<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-53429135-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>




